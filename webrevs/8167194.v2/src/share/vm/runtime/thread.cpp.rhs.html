<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre></pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaClasses.hpp"
  28 #include "classfile/moduleEntry.hpp"
  29 #include "classfile/systemDictionary.hpp"
  30 #include "classfile/vmSymbols.hpp"
  31 #include "code/codeCache.hpp"
  32 #include "code/codeCacheExtensions.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/gcId.hpp"
  37 #include "gc/shared/gcLocker.inline.hpp"
  38 #include "gc/shared/workgroup.hpp"
  39 #include "interpreter/interpreter.hpp"
  40 #include "interpreter/linkResolver.hpp"
  41 #include "interpreter/oopMapCache.hpp"
  42 #include "jvmtifiles/jvmtiEnv.hpp"
  43 #include "logging/log.hpp"
  44 #include "logging/logConfiguration.hpp"
  45 #include "memory/metaspaceShared.hpp"
  46 #include "memory/oopFactory.hpp"
  47 #include "memory/resourceArea.hpp"
  48 #include "memory/universe.inline.hpp"
  49 #include "oops/instanceKlass.hpp"
  50 #include "oops/objArrayOop.hpp"
  51 #include "oops/oop.inline.hpp"
  52 #include "oops/symbol.hpp"
  53 #include "oops/verifyOopClosure.hpp"
  54 #include "prims/jvm_misc.hpp"
  55 #include "prims/jvmtiExport.hpp"
  56 #include "prims/jvmtiThreadState.hpp"
  57 #include "prims/privilegedStack.hpp"
  58 #include "runtime/arguments.hpp"
  59 #include "runtime/atomic.hpp"
  60 #include "runtime/biasedLocking.hpp"
  61 #include "runtime/commandLineFlagConstraintList.hpp"
  62 #include "runtime/commandLineFlagWriteableList.hpp"
  63 #include "runtime/commandLineFlagRangeList.hpp"
  64 #include "runtime/deoptimization.hpp"
  65 #include "runtime/fprofiler.hpp"
  66 #include "runtime/frame.inline.hpp"
  67 #include "runtime/globals.hpp"
  68 #include "runtime/init.hpp"
  69 #include "runtime/interfaceSupport.hpp"
  70 #include "runtime/java.hpp"
  71 #include "runtime/javaCalls.hpp"
  72 #include "runtime/jniPeriodicChecker.hpp"
  73 #include "runtime/timerTrace.hpp"
  74 #include "runtime/memprofiler.hpp"
  75 #include "runtime/mutexLocker.hpp"
  76 #include "runtime/objectMonitor.hpp"
  77 #include "runtime/orderAccess.inline.hpp"
  78 #include "runtime/osThread.hpp"
  79 #include "runtime/safepoint.hpp"
  80 #include "runtime/sharedRuntime.hpp"
  81 #include "runtime/statSampler.hpp"
  82 #include "runtime/stubRoutines.hpp"
  83 #include "runtime/sweeper.hpp"
  84 #include "runtime/task.hpp"
  85 #include "runtime/thread.inline.hpp"
  86 #include "runtime/threadCritical.hpp"
  87 #include "runtime/vframe.hpp"
  88 #include "runtime/vframeArray.hpp"
  89 #include "runtime/vframe_hp.hpp"
  90 #include "runtime/vmThread.hpp"
  91 #include "runtime/vm_operations.hpp"
  92 #include "runtime/vm_version.hpp"
  93 #include "services/attachListener.hpp"
  94 #include "services/management.hpp"
  95 #include "services/memTracker.hpp"
  96 #include "services/threadService.hpp"
  97 #include "trace/traceMacros.hpp"
  98 #include "trace/tracing.hpp"
  99 #include "utilities/defaultStream.hpp"
 100 #include "utilities/dtrace.hpp"
 101 #include "utilities/events.hpp"
 102 #include "utilities/macros.hpp"
 103 #include "utilities/preserveException.hpp"
 104 #if INCLUDE_ALL_GCS
 105 #include "gc/cms/concurrentMarkSweepThread.hpp"
 106 #include "gc/g1/concurrentMarkThread.inline.hpp"
 107 #include "gc/parallel/pcTasks.hpp"
 108 #endif // INCLUDE_ALL_GCS
 109 #if INCLUDE_JVMCI
 110 #include "jvmci/jvmciCompiler.hpp"
 111 #include "jvmci/jvmciRuntime.hpp"
 112 #endif
 113 #ifdef COMPILER1
 114 #include "c1/c1_Compiler.hpp"
 115 #endif
 116 #ifdef COMPILER2
 117 #include "opto/c2compiler.hpp"
 118 #include "opto/idealGraphPrinter.hpp"
 119 #endif
 120 #if INCLUDE_RTM_OPT
 121 #include "runtime/rtmLocking.hpp"
 122 #endif
 123 
 124 // Initialization after module runtime initialization
 125 void universe_post_module_init();  // must happen after call_initPhase2
 126 
 127 #ifdef DTRACE_ENABLED
 128 
 129 // Only bother with this argument setup if dtrace is available
 130 
 131   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 132   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 133 
 134   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 135     {                                                                      \
 136       ResourceMark rm(this);                                               \
 137       int len = 0;                                                         \
 138       const char* name = (javathread)-&gt;get_thread_name();                  \
 139       len = strlen(name);                                                  \
 140       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 141         (char *) name, len,                                                \
 142         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 143         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 144         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 145     }
 146 
 147 #else //  ndef DTRACE_ENABLED
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)
 150 
 151 #endif // ndef DTRACE_ENABLED
 152 
 153 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 154 // Current thread is maintained as a thread-local variable
 155 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 156 #endif
 157 // Class hierarchy
 158 // - Thread
 159 //   - VMThread
 160 //   - WatcherThread
 161 //   - ConcurrentMarkSweepThread
 162 //   - JavaThread
 163 //     - CompilerThread
 164 
 165 // ======= Thread ========
 166 // Support for forcing alignment of thread objects for biased locking
 167 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 168   if (UseBiasedLocking) {
 169     const int alignment = markOopDesc::biased_lock_alignment;
 170     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 171     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 172                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 173                                                          AllocFailStrategy::RETURN_NULL);
 174     void* aligned_addr     = (void*) align_size_up((intptr_t) real_malloc_addr, alignment);
 175     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 176            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 177            "JavaThread alignment code overflowed allocated storage");
 178     if (aligned_addr != real_malloc_addr) {
 179       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 180                               p2i(real_malloc_addr),
 181                               p2i(aligned_addr));
 182     }
 183     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 184     return aligned_addr;
 185   } else {
 186     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 187                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 188   }
 189 }
 190 
 191 void Thread::operator delete(void* p) {
 192   if (UseBiasedLocking) {
 193     void* real_malloc_addr = ((Thread*) p)-&gt;_real_malloc_address;
 194     FreeHeap(real_malloc_addr);
 195   } else {
 196     FreeHeap(p);
 197   }
 198 }
 199 
 200 
 201 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 202 // JavaThread
 203 
 204 
 205 Thread::Thread() {
 206   // stack and get_thread
 207   set_stack_base(NULL);
 208   set_stack_size(0);
 209   set_self_raw_id(0);
 210   set_lgrp_id(-1);
 211   DEBUG_ONLY(clear_suspendible_thread();)
 212 
 213   // allocated data structures
 214   set_osthread(NULL);
 215   set_resource_area(new (mtThread)ResourceArea());
 216   DEBUG_ONLY(_current_resource_mark = NULL;)
 217   set_handle_area(new (mtThread) HandleArea(NULL));
 218   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 219   set_active_handles(NULL);
 220   set_free_handle_block(NULL);
 221   set_last_handle_mark(NULL);
 222 
 223   // This initial value ==&gt; never claimed.
 224   _oops_do_parity = 0;
 225 
 226   // the handle mark links itself to last_handle_mark
 227   new HandleMark(this);
 228 
 229   // plain initialization
 230   debug_only(_owned_locks = NULL;)
 231   debug_only(_allow_allocation_count = 0;)
 232   NOT_PRODUCT(_allow_safepoint_count = 0;)
 233   NOT_PRODUCT(_skip_gcalot = false;)
 234   _jvmti_env_iteration_count = 0;
 235   set_allocated_bytes(0);
 236   _vm_operation_started_count = 0;
 237   _vm_operation_completed_count = 0;
 238   _current_pending_monitor = NULL;
 239   _current_pending_monitor_is_from_java = true;
 240   _current_waiting_monitor = NULL;
 241   _num_nested_signal = 0;
 242   omFreeList = NULL;
 243   omFreeCount = 0;
 244   omFreeProvision = 32;
 245   omInUseList = NULL;
 246   omInUseCount = 0;
 247 
 248 #ifdef ASSERT
 249   _visited_for_critical_count = false;
 250 #endif
 251 
 252   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 253                          Monitor::_safepoint_check_sometimes);
 254   _suspend_flags = 0;
 255 
 256   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 257   _hashStateX = os::random();
 258   _hashStateY = 842502087;
 259   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 260   _hashStateW = 273326509;
 261 
 262   _OnTrap   = 0;
 263   _schedctl = NULL;
 264   _Stalled  = 0;
 265   _TypeTag  = 0x2BAD;
 266 
 267   // Many of the following fields are effectively final - immutable
 268   // Note that nascent threads can't use the Native Monitor-Mutex
 269   // construct until the _MutexEvent is initialized ...
 270   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 271   // we might instead use a stack of ParkEvents that we could provision on-demand.
 272   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 273   // and ::Release()
 274   _ParkEvent   = ParkEvent::Allocate(this);
 275   _SleepEvent  = ParkEvent::Allocate(this);
 276   _MutexEvent  = ParkEvent::Allocate(this);
 277   _MuxEvent    = ParkEvent::Allocate(this);
 278 
 279 #ifdef CHECK_UNHANDLED_OOPS
 280   if (CheckUnhandledOops) {
 281     _unhandled_oops = new UnhandledOops(this);
 282   }
 283 #endif // CHECK_UNHANDLED_OOPS
 284 #ifdef ASSERT
 285   if (UseBiasedLocking) {
 286     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 287     assert(this == _real_malloc_address ||
 288            this == (void*) align_size_up((intptr_t) _real_malloc_address, markOopDesc::biased_lock_alignment),
 289            "bug in forced alignment of thread objects");
 290   }
 291 #endif // ASSERT
 292 }
 293 
 294 void Thread::initialize_thread_current() {
 295 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 296   assert(_thr_current == NULL, "Thread::current already initialized");
 297   _thr_current = this;
 298 #endif
 299   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 300   ThreadLocalStorage::set_thread(this);
 301   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 302 }
 303 
 304 void Thread::clear_thread_current() {
 305   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 306 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 307   _thr_current = NULL;
 308 #endif
 309   ThreadLocalStorage::set_thread(NULL);
 310 }
 311 
 312 void Thread::record_stack_base_and_size() {
 313   set_stack_base(os::current_stack_base());
 314   set_stack_size(os::current_stack_size());
 315   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 316   // in initialize_thread(). Without the adjustment, stack size is
 317   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 318   // So far, only Solaris has real implementation of initialize_thread().
 319   //
 320   // set up any platform-specific state.
 321   os::initialize_thread(this);
 322 
 323   // Set stack limits after thread is initialized.
 324   if (is_Java_thread()) {
 325     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 326     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 327   }
 328 #if INCLUDE_NMT
 329   // record thread's native stack, stack grows downward
 330   MemTracker::record_thread_stack(stack_end(), stack_size());
 331 #endif // INCLUDE_NMT
 332   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 333     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 334     os::current_thread_id(), p2i(stack_base() - stack_size()),
 335     p2i(stack_base()), stack_size()/1024);
 336 }
 337 
 338 
 339 Thread::~Thread() {
 340   // Reclaim the objectmonitors from the omFreeList of the moribund thread.
 341   ObjectSynchronizer::omFlush(this);
 342 
 343   EVENT_THREAD_DESTRUCT(this);
 344 
 345   // stack_base can be NULL if the thread is never started or exited before
 346   // record_stack_base_and_size called. Although, we would like to ensure
 347   // that all started threads do call record_stack_base_and_size(), there is
 348   // not proper way to enforce that.
 349 #if INCLUDE_NMT
 350   if (_stack_base != NULL) {
 351     MemTracker::release_thread_stack(stack_end(), stack_size());
 352 #ifdef ASSERT
 353     set_stack_base(NULL);
 354 #endif
 355   }
 356 #endif // INCLUDE_NMT
 357 
 358   // deallocate data structures
 359   delete resource_area();
 360   // since the handle marks are using the handle area, we have to deallocated the root
 361   // handle mark before deallocating the thread's handle area,
 362   assert(last_handle_mark() != NULL, "check we have an element");
 363   delete last_handle_mark();
 364   assert(last_handle_mark() == NULL, "check we have reached the end");
 365 
 366   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 367   // We NULL out the fields for good hygiene.
 368   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 369   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 370   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 371   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 372 
 373   delete handle_area();
 374   delete metadata_handles();
 375 
 376   // SR_handler uses this as a termination indicator -
 377   // needs to happen before os::free_thread()
 378   delete _SR_lock;
 379   _SR_lock = NULL;
 380 
 381   // osthread() can be NULL, if creation of thread failed.
 382   if (osthread() != NULL) os::free_thread(osthread());
 383 
 384   // clear Thread::current if thread is deleting itself.
 385   // Needed to ensure JNI correctly detects non-attached threads.
 386   if (this == Thread::current()) {
 387     clear_thread_current();
 388   }
 389 
 390   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 391 }
 392 
 393 // NOTE: dummy function for assertion purpose.
 394 void Thread::run() {
 395   ShouldNotReachHere();
 396 }
 397 
 398 #ifdef ASSERT
 399 // Private method to check for dangling thread pointer
 400 void check_for_dangling_thread_pointer(Thread *thread) {
 401   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread || Threads_lock-&gt;owned_by_self(),
 402          "possibility of dangling Thread pointer");
 403 }
 404 #endif
 405 
 406 ThreadPriority Thread::get_priority(const Thread* const thread) {
 407   ThreadPriority priority;
 408   // Can return an error!
 409   (void)os::get_priority(thread, priority);
 410   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 411   return priority;
 412 }
 413 
 414 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 415   debug_only(check_for_dangling_thread_pointer(thread);)
 416   // Can return an error!
 417   (void)os::set_priority(thread, priority);
 418 }
 419 
 420 
 421 void Thread::start(Thread* thread) {
 422   // Start is different from resume in that its safety is guaranteed by context or
 423   // being called from a Java method synchronized on the Thread object.
 424   if (!DisableStartThread) {
 425     if (thread-&gt;is_Java_thread()) {
 426       // Initialize the thread state to RUNNABLE before starting this thread.
 427       // Can not set it after the thread started because we do not know the
 428       // exact thread state at that time. It could be in MONITOR_WAIT or
 429       // in SLEEPING or some other state.
 430       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 431                                           java_lang_Thread::RUNNABLE);
 432     }
 433     os::start_thread(thread);
 434   }
 435 }
 436 
 437 // Enqueue a VM_Operation to do the job for us - sometime later
 438 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 439   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 440   VMThread::execute(vm_stop);
 441 }
 442 
 443 
 444 // Check if an external suspend request has completed (or has been
 445 // cancelled). Returns true if the thread is externally suspended and
 446 // false otherwise.
 447 //
 448 // The bits parameter returns information about the code path through
 449 // the routine. Useful for debugging:
 450 //
 451 // set in is_ext_suspend_completed():
 452 // 0x00000001 - routine was entered
 453 // 0x00000010 - routine return false at end
 454 // 0x00000100 - thread exited (return false)
 455 // 0x00000200 - suspend request cancelled (return false)
 456 // 0x00000400 - thread suspended (return true)
 457 // 0x00001000 - thread is in a suspend equivalent state (return true)
 458 // 0x00002000 - thread is native and walkable (return true)
 459 // 0x00004000 - thread is native_trans and walkable (needed retry)
 460 //
 461 // set in wait_for_ext_suspend_completion():
 462 // 0x00010000 - routine was entered
 463 // 0x00020000 - suspend request cancelled before loop (return false)
 464 // 0x00040000 - thread suspended before loop (return true)
 465 // 0x00080000 - suspend request cancelled in loop (return false)
 466 // 0x00100000 - thread suspended in loop (return true)
 467 // 0x00200000 - suspend not completed during retry loop (return false)
 468 
 469 // Helper class for tracing suspend wait debug bits.
 470 //
 471 // 0x00000100 indicates that the target thread exited before it could
 472 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 473 // 0x00080000 each indicate a cancelled suspend request so they don't
 474 // count as wait failures either.
 475 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 476 
 477 class TraceSuspendDebugBits : public StackObj {
 478  private:
 479   JavaThread * jt;
 480   bool         is_wait;
 481   bool         called_by_wait;  // meaningful when !is_wait
 482   uint32_t *   bits;
 483 
 484  public:
 485   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 486                         uint32_t *_bits) {
 487     jt             = _jt;
 488     is_wait        = _is_wait;
 489     called_by_wait = _called_by_wait;
 490     bits           = _bits;
 491   }
 492 
 493   ~TraceSuspendDebugBits() {
 494     if (!is_wait) {
 495 #if 1
 496       // By default, don't trace bits for is_ext_suspend_completed() calls.
 497       // That trace is very chatty.
 498       return;
 499 #else
 500       if (!called_by_wait) {
 501         // If tracing for is_ext_suspend_completed() is enabled, then only
 502         // trace calls to it from wait_for_ext_suspend_completion()
 503         return;
 504       }
 505 #endif
 506     }
 507 
 508     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 509       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 510         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 511         ResourceMark rm;
 512 
 513         tty-&gt;print_cr(
 514                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 515                       jt-&gt;get_thread_name(), *bits);
 516 
 517         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 518       }
 519     }
 520   }
 521 };
 522 #undef DEBUG_FALSE_BITS
 523 
 524 
 525 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 526                                           uint32_t *bits) {
 527   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 528 
 529   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 530   bool do_trans_retry;           // flag to force the retry
 531 
 532   *bits |= 0x00000001;
 533 
 534   do {
 535     do_trans_retry = false;
 536 
 537     if (is_exiting()) {
 538       // Thread is in the process of exiting. This is always checked
 539       // first to reduce the risk of dereferencing a freed JavaThread.
 540       *bits |= 0x00000100;
 541       return false;
 542     }
 543 
 544     if (!is_external_suspend()) {
 545       // Suspend request is cancelled. This is always checked before
 546       // is_ext_suspended() to reduce the risk of a rogue resume
 547       // confusing the thread that made the suspend request.
 548       *bits |= 0x00000200;
 549       return false;
 550     }
 551 
 552     if (is_ext_suspended()) {
 553       // thread is suspended
 554       *bits |= 0x00000400;
 555       return true;
 556     }
 557 
 558     // Now that we no longer do hard suspends of threads running
 559     // native code, the target thread can be changing thread state
 560     // while we are in this routine:
 561     //
 562     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 563     //
 564     // We save a copy of the thread state as observed at this moment
 565     // and make our decision about suspend completeness based on the
 566     // copy. This closes the race where the thread state is seen as
 567     // _thread_in_native_trans in the if-thread_blocked check, but is
 568     // seen as _thread_blocked in if-thread_in_native_trans check.
 569     JavaThreadState save_state = thread_state();
 570 
 571     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 572       // If the thread's state is _thread_blocked and this blocking
 573       // condition is known to be equivalent to a suspend, then we can
 574       // consider the thread to be externally suspended. This means that
 575       // the code that sets _thread_blocked has been modified to do
 576       // self-suspension if the blocking condition releases. We also
 577       // used to check for CONDVAR_WAIT here, but that is now covered by
 578       // the _thread_blocked with self-suspension check.
 579       //
 580       // Return true since we wouldn't be here unless there was still an
 581       // external suspend request.
 582       *bits |= 0x00001000;
 583       return true;
 584     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 585       // Threads running native code will self-suspend on native==&gt;VM/Java
 586       // transitions. If its stack is walkable (should always be the case
 587       // unless this function is called before the actual java_suspend()
 588       // call), then the wait is done.
 589       *bits |= 0x00002000;
 590       return true;
 591     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 592                save_state == _thread_in_native_trans &amp;&amp;
 593                frame_anchor()-&gt;walkable()) {
 594       // The thread is transitioning from thread_in_native to another
 595       // thread state. check_safepoint_and_suspend_for_native_trans()
 596       // will force the thread to self-suspend. If it hasn't gotten
 597       // there yet we may have caught the thread in-between the native
 598       // code check above and the self-suspend. Lucky us. If we were
 599       // called by wait_for_ext_suspend_completion(), then it
 600       // will be doing the retries so we don't have to.
 601       //
 602       // Since we use the saved thread state in the if-statement above,
 603       // there is a chance that the thread has already transitioned to
 604       // _thread_blocked by the time we get here. In that case, we will
 605       // make a single unnecessary pass through the logic below. This
 606       // doesn't hurt anything since we still do the trans retry.
 607 
 608       *bits |= 0x00004000;
 609 
 610       // Once the thread leaves thread_in_native_trans for another
 611       // thread state, we break out of this retry loop. We shouldn't
 612       // need this flag to prevent us from getting back here, but
 613       // sometimes paranoia is good.
 614       did_trans_retry = true;
 615 
 616       // We wait for the thread to transition to a more usable state.
 617       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 618         // We used to do an "os::yield_all(i)" call here with the intention
 619         // that yielding would increase on each retry. However, the parameter
 620         // is ignored on Linux which means the yield didn't scale up. Waiting
 621         // on the SR_lock below provides a much more predictable scale up for
 622         // the delay. It also provides a simple/direct point to check for any
 623         // safepoint requests from the VMThread
 624 
 625         // temporarily drops SR_lock while doing wait with safepoint check
 626         // (if we're a JavaThread - the WatcherThread can also call this)
 627         // and increase delay with each retry
 628         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 629 
 630         // check the actual thread state instead of what we saved above
 631         if (thread_state() != _thread_in_native_trans) {
 632           // the thread has transitioned to another thread state so
 633           // try all the checks (except this one) one more time.
 634           do_trans_retry = true;
 635           break;
 636         }
 637       } // end retry loop
 638 
 639 
 640     }
 641   } while (do_trans_retry);
 642 
 643   *bits |= 0x00000010;
 644   return false;
 645 }
 646 
 647 // Wait for an external suspend request to complete (or be cancelled).
 648 // Returns true if the thread is externally suspended and false otherwise.
 649 //
 650 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 651                                                  uint32_t *bits) {
 652   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 653                              false /* !called_by_wait */, bits);
 654 
 655   // local flag copies to minimize SR_lock hold time
 656   bool is_suspended;
 657   bool pending;
 658   uint32_t reset_bits;
 659 
 660   // set a marker so is_ext_suspend_completed() knows we are the caller
 661   *bits |= 0x00010000;
 662 
 663   // We use reset_bits to reinitialize the bits value at the top of
 664   // each retry loop. This allows the caller to make use of any
 665   // unused bits for their own marking purposes.
 666   reset_bits = *bits;
 667 
 668   {
 669     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 670     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 671                                             delay, bits);
 672     pending = is_external_suspend();
 673   }
 674   // must release SR_lock to allow suspension to complete
 675 
 676   if (!pending) {
 677     // A cancelled suspend request is the only false return from
 678     // is_ext_suspend_completed() that keeps us from entering the
 679     // retry loop.
 680     *bits |= 0x00020000;
 681     return false;
 682   }
 683 
 684   if (is_suspended) {
 685     *bits |= 0x00040000;
 686     return true;
 687   }
 688 
 689   for (int i = 1; i &lt;= retries; i++) {
 690     *bits = reset_bits;  // reinit to only track last retry
 691 
 692     // We used to do an "os::yield_all(i)" call here with the intention
 693     // that yielding would increase on each retry. However, the parameter
 694     // is ignored on Linux which means the yield didn't scale up. Waiting
 695     // on the SR_lock below provides a much more predictable scale up for
 696     // the delay. It also provides a simple/direct point to check for any
 697     // safepoint requests from the VMThread
 698 
 699     {
 700       MutexLocker ml(SR_lock());
 701       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 702       // can also call this)  and increase delay with each retry
 703       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 704 
 705       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 706                                               delay, bits);
 707 
 708       // It is possible for the external suspend request to be cancelled
 709       // (by a resume) before the actual suspend operation is completed.
 710       // Refresh our local copy to see if we still need to wait.
 711       pending = is_external_suspend();
 712     }
 713 
 714     if (!pending) {
 715       // A cancelled suspend request is the only false return from
 716       // is_ext_suspend_completed() that keeps us from staying in the
 717       // retry loop.
 718       *bits |= 0x00080000;
 719       return false;
 720     }
 721 
 722     if (is_suspended) {
 723       *bits |= 0x00100000;
 724       return true;
 725     }
 726   } // end retry loop
 727 
 728   // thread did not suspend after all our retries
 729   *bits |= 0x00200000;
 730   return false;
 731 }
 732 
 733 #ifndef PRODUCT
 734 void JavaThread::record_jump(address target, address instr, const char* file,
 735                              int line) {
 736 
 737   // This should not need to be atomic as the only way for simultaneous
 738   // updates is via interrupts. Even then this should be rare or non-existent
 739   // and we don't care that much anyway.
 740 
 741   int index = _jmp_ring_index;
 742   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 743   _jmp_ring[index]._target = (intptr_t) target;
 744   _jmp_ring[index]._instruction = (intptr_t) instr;
 745   _jmp_ring[index]._file = file;
 746   _jmp_ring[index]._line = line;
 747 }
 748 #endif // PRODUCT
 749 
 750 // Called by flat profiler
 751 // Callers have already called wait_for_ext_suspend_completion
 752 // The assertion for that is currently too complex to put here:
 753 bool JavaThread::profile_last_Java_frame(frame* _fr) {
 754   bool gotframe = false;
 755   // self suspension saves needed state.
 756   if (has_last_Java_frame() &amp;&amp; _anchor.walkable()) {
 757     *_fr = pd_last_frame();
 758     gotframe = true;
 759   }
 760   return gotframe;
 761 }
 762 
 763 void Thread::interrupt(Thread* thread) {
 764   debug_only(check_for_dangling_thread_pointer(thread);)
 765   os::interrupt(thread);
 766 }
 767 
 768 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 769   debug_only(check_for_dangling_thread_pointer(thread);)
 770   // Note:  If clear_interrupted==false, this simply fetches and
 771   // returns the value of the field osthread()-&gt;interrupted().
 772   return os::is_interrupted(thread, clear_interrupted);
 773 }
 774 
 775 
 776 // GC Support
 777 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 778   jint thread_parity = _oops_do_parity;
 779   if (thread_parity != strong_roots_parity) {
 780     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 781     if (res == thread_parity) {
 782       return true;
 783     } else {
 784       guarantee(res == strong_roots_parity, "Or else what?");
 785       return false;
 786     }
 787   }
 788   return false;
 789 }
 790 
 791 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 792   active_handles()-&gt;oops_do(f);
 793   // Do oop for ThreadShadow
 794   f-&gt;do_oop((oop*)&amp;_pending_exception);
 795   handle_area()-&gt;oops_do(f);
 796 }
 797 
 798 void Thread::metadata_handles_do(void f(Metadata*)) {
 799   // Only walk the Handles in Thread.
 800   if (metadata_handles() != NULL) {
 801     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 802       f(metadata_handles()-&gt;at(i));
 803     }
 804   }
 805 }
 806 
 807 void Thread::print_on(outputStream* st) const {
 808   // get_priority assumes osthread initialized
 809   if (osthread() != NULL) {
 810     int os_prio;
 811     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 812       st-&gt;print("os_prio=%d ", os_prio);
 813     }
 814     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 815     ext().print_on(st);
 816     osthread()-&gt;print_on(st);
 817   }
 818   debug_only(if (WizardMode) print_owned_locks_on(st);)
 819 }
 820 
 821 // Thread::print_on_error() is called by fatal error handler. Don't use
 822 // any lock or allocate memory.
 823 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 824   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 825 
 826   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 827   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 828   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 829   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 830   else                                { st-&gt;print("Thread"); }
 831 
 832   if (is_Named_thread()) {
 833     st-&gt;print(" \"%s\"", name());
 834   }
 835 
 836   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 837             p2i(stack_end()), p2i(stack_base()));
 838 
 839   if (osthread()) {
 840     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 841   }
 842 }
 843 
 844 #ifdef ASSERT
 845 void Thread::print_owned_locks_on(outputStream* st) const {
 846   Monitor *cur = _owned_locks;
 847   if (cur == NULL) {
 848     st-&gt;print(" (no locks) ");
 849   } else {
 850     st-&gt;print_cr(" Locks owned:");
 851     while (cur) {
 852       cur-&gt;print_on(st);
 853       cur = cur-&gt;next();
 854     }
 855   }
 856 }
 857 
 858 static int ref_use_count  = 0;
 859 
 860 bool Thread::owns_locks_but_compiled_lock() const {
 861   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 862     if (cur != Compile_lock) return true;
 863   }
 864   return false;
 865 }
 866 
 867 
 868 #endif
 869 
 870 #ifndef PRODUCT
 871 
 872 // The flag: potential_vm_operation notifies if this particular safepoint state could potential
 873 // invoke the vm-thread (i.e., and oop allocation). In that case, we also have to make sure that
 874 // no threads which allow_vm_block's are held
 875 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 876   // Check if current thread is allowed to block at a safepoint
 877   if (!(_allow_safepoint_count == 0)) {
 878     fatal("Possible safepoint reached by thread that does not allow it");
 879   }
 880   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 881     fatal("LEAF method calling lock?");
 882   }
 883 
 884 #ifdef ASSERT
 885   if (potential_vm_operation &amp;&amp; is_Java_thread()
 886       &amp;&amp; !Universe::is_bootstrapping()) {
 887     // Make sure we do not hold any locks that the VM thread also uses.
 888     // This could potentially lead to deadlocks
 889     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 890       // Threads_lock is special, since the safepoint synchronization will not start before this is
 891       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 892       // since it is used to transfer control between JavaThreads and the VMThread
 893       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 894       if ((cur-&gt;allow_vm_block() &amp;&amp;
 895            cur != Threads_lock &amp;&amp;
 896            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 897            cur != VMOperationRequest_lock &amp;&amp;
 898            cur != VMOperationQueue_lock) ||
 899            cur-&gt;rank() == Mutex::special) {
 900         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 901       }
 902     }
 903   }
 904 
 905   if (GCALotAtAllSafepoints) {
 906     // We could enter a safepoint here and thus have a gc
 907     InterfaceSupport::check_gc_alot();
 908   }
 909 #endif
 910 }
 911 #endif
 912 
 913 bool Thread::is_in_stack(address adr) const {
 914   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
 915   address end = os::current_stack_pointer();
 916   // Allow non Java threads to call this without stack_base
 917   if (_stack_base == NULL) return true;
 918   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
 919 
 920   return false;
 921 }
 922 
 923 bool Thread::is_in_usable_stack(address adr) const {
 924   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
 925   size_t usable_stack_size = _stack_size - stack_guard_size;
 926 
 927   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
 928 }
 929 
 930 
 931 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
 932 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
 933 // used for compilation in the future. If that change is made, the need for these methods
 934 // should be revisited, and they should be removed if possible.
 935 
 936 bool Thread::is_lock_owned(address adr) const {
 937   return on_local_stack(adr);
 938 }
 939 
 940 bool Thread::set_as_starting_thread() {
 941   // NOTE: this must be called inside the main thread.
 942   return os::create_main_thread((JavaThread*)this);
 943 }
 944 
 945 static void initialize_class(Symbol* class_name, TRAPS) {
 946   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
 947   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
 948 }
 949 
 950 
 951 // Creates the initial ThreadGroup
 952 static Handle create_initial_thread_group(TRAPS) {
 953   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_ThreadGroup(), true, CHECK_NH);
 954   instanceKlassHandle klass (THREAD, k);
 955 
 956   Handle system_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 957   {
 958     JavaValue result(T_VOID);
 959     JavaCalls::call_special(&amp;result,
 960                             system_instance,
 961                             klass,
 962                             vmSymbols::object_initializer_name(),
 963                             vmSymbols::void_method_signature(),
 964                             CHECK_NH);
 965   }
 966   Universe::set_system_thread_group(system_instance());
 967 
 968   Handle main_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 969   {
 970     JavaValue result(T_VOID);
 971     Handle string = java_lang_String::create_from_str("main", CHECK_NH);
 972     JavaCalls::call_special(&amp;result,
 973                             main_instance,
 974                             klass,
 975                             vmSymbols::object_initializer_name(),
 976                             vmSymbols::threadgroup_string_void_signature(),
 977                             system_instance,
 978                             string,
 979                             CHECK_NH);
 980   }
 981   return main_instance;
 982 }
 983 
 984 // Creates the initial Thread
 985 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
 986                                  TRAPS) {
 987   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_NULL);
 988   instanceKlassHandle klass (THREAD, k);
 989   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_NULL);
 990 
 991   java_lang_Thread::set_thread(thread_oop(), thread);
 992   java_lang_Thread::set_priority(thread_oop(), NormPriority);
 993   thread-&gt;set_threadObj(thread_oop());
 994 
 995   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
 996 
 997   JavaValue result(T_VOID);
 998   JavaCalls::call_special(&amp;result, thread_oop,
 999                           klass,
1000                           vmSymbols::object_initializer_name(),
1001                           vmSymbols::threadgroup_string_void_signature(),
1002                           thread_group,
1003                           string,
1004                           CHECK_NULL);
1005   return thread_oop();
1006 }
1007 
1008 char java_runtime_name[128] = "";
1009 char java_runtime_version[128] = "";
1010 
1011 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1012 static const char* get_java_runtime_name(TRAPS) {
1013   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1014                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1015   fieldDescriptor fd;
1016   bool found = k != NULL &amp;&amp;
1017                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1018                                                         vmSymbols::string_signature(), &amp;fd);
1019   if (found) {
1020     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1021     if (name_oop == NULL) {
1022       return NULL;
1023     }
1024     const char* name = java_lang_String::as_utf8_string(name_oop,
1025                                                         java_runtime_name,
1026                                                         sizeof(java_runtime_name));
1027     return name;
1028   } else {
1029     return NULL;
1030   }
1031 }
1032 
1033 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1034 static const char* get_java_runtime_version(TRAPS) {
1035   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1036                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1037   fieldDescriptor fd;
1038   bool found = k != NULL &amp;&amp;
1039                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1040                                                         vmSymbols::string_signature(), &amp;fd);
1041   if (found) {
1042     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1043     if (name_oop == NULL) {
1044       return NULL;
1045     }
1046     const char* name = java_lang_String::as_utf8_string(name_oop,
1047                                                         java_runtime_version,
1048                                                         sizeof(java_runtime_version));
1049     return name;
1050   } else {
1051     return NULL;
1052   }
1053 }
1054 
1055 // General purpose hook into Java code, run once when the VM is initialized.
1056 // The Java library method itself may be changed independently from the VM.
1057 static void call_postVMInitHook(TRAPS) {
1058   Klass* k = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1059   instanceKlassHandle klass (THREAD, k);
1060   if (klass.not_null()) {
1061     JavaValue result(T_VOID);
1062     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1063                            vmSymbols::void_method_signature(),
1064                            CHECK);
1065   }
1066 }
1067 
1068 static void reset_vm_info_property(TRAPS) {
1069   // the vm info string
1070   ResourceMark rm(THREAD);
1071   const char *vm_info = VM_Version::vm_info_string();
1072 
1073   // java.lang.System class
1074   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
1075   instanceKlassHandle klass (THREAD, k);
1076 
1077   // setProperty arguments
1078   Handle key_str    = java_lang_String::create_from_str("java.vm.info", CHECK);
1079   Handle value_str  = java_lang_String::create_from_str(vm_info, CHECK);
1080 
1081   // return value
1082   JavaValue r(T_OBJECT);
1083 
1084   // public static String setProperty(String key, String value);
1085   JavaCalls::call_static(&amp;r,
1086                          klass,
1087                          vmSymbols::setProperty_name(),
1088                          vmSymbols::string_string_string_signature(),
1089                          key_str,
1090                          value_str,
1091                          CHECK);
1092 }
1093 
1094 
1095 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1096                                     bool daemon, TRAPS) {
1097   assert(thread_group.not_null(), "thread group should be specified");
1098   assert(threadObj() == NULL, "should only create Java thread object once");
1099 
1100   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK);
1101   instanceKlassHandle klass (THREAD, k);
1102   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK);
1103 
1104   java_lang_Thread::set_thread(thread_oop(), this);
1105   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1106   set_threadObj(thread_oop());
1107 
1108   JavaValue result(T_VOID);
1109   if (thread_name != NULL) {
1110     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1111     // Thread gets assigned specified name and null target
1112     JavaCalls::call_special(&amp;result,
1113                             thread_oop,
1114                             klass,
1115                             vmSymbols::object_initializer_name(),
1116                             vmSymbols::threadgroup_string_void_signature(),
1117                             thread_group, // Argument 1
1118                             name,         // Argument 2
1119                             THREAD);
1120   } else {
1121     // Thread gets assigned name "Thread-nnn" and null target
1122     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1123     JavaCalls::call_special(&amp;result,
1124                             thread_oop,
1125                             klass,
1126                             vmSymbols::object_initializer_name(),
1127                             vmSymbols::threadgroup_runnable_void_signature(),
1128                             thread_group, // Argument 1
1129                             Handle(),     // Argument 2
1130                             THREAD);
1131   }
1132 
1133 
1134   if (daemon) {
1135     java_lang_Thread::set_daemon(thread_oop());
1136   }
1137 
1138   if (HAS_PENDING_EXCEPTION) {
1139     return;
1140   }
1141 
1142   KlassHandle group(THREAD, SystemDictionary::ThreadGroup_klass());
1143   Handle threadObj(THREAD, this-&gt;threadObj());
1144 
1145   JavaCalls::call_special(&amp;result,
1146                           thread_group,
1147                           group,
1148                           vmSymbols::add_method_name(),
1149                           vmSymbols::thread_void_signature(),
1150                           threadObj,          // Arg 1
1151                           THREAD);
1152 }
1153 
1154 // NamedThread --  non-JavaThread subclasses with multiple
1155 // uniquely named instances should derive from this.
1156 NamedThread::NamedThread() : Thread() {
1157   _name = NULL;
1158   _processed_thread = NULL;
1159   _gc_id = GCId::undefined();
1160 }
1161 
1162 NamedThread::~NamedThread() {
1163   if (_name != NULL) {
1164     FREE_C_HEAP_ARRAY(char, _name);
1165     _name = NULL;
1166   }
1167 }
1168 
1169 void NamedThread::set_name(const char* format, ...) {
1170   guarantee(_name == NULL, "Only get to set name once.");
1171   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1172   guarantee(_name != NULL, "alloc failure");
1173   va_list ap;
1174   va_start(ap, format);
1175   jio_vsnprintf(_name, max_name_len, format, ap);
1176   va_end(ap);
1177 }
1178 
1179 void NamedThread::initialize_named_thread() {
1180   set_native_thread_name(name());
1181 }
1182 
1183 void NamedThread::print_on(outputStream* st) const {
1184   st-&gt;print("\"%s\" ", name());
1185   Thread::print_on(st);
1186   st-&gt;cr();
1187 }
1188 
1189 
1190 // ======= WatcherThread ========
1191 
1192 // The watcher thread exists to simulate timer interrupts.  It should
1193 // be replaced by an abstraction over whatever native support for
1194 // timer interrupts exists on the platform.
1195 
1196 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1197 bool WatcherThread::_startable = false;
1198 volatile bool  WatcherThread::_should_terminate = false;
1199 
1200 WatcherThread::WatcherThread() : Thread(), _crash_protection(NULL) {
1201   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1202   if (os::create_thread(this, os::watcher_thread)) {
1203     _watcher_thread = this;
1204 
1205     // Set the watcher thread to the highest OS priority which should not be
1206     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1207     // is created. The only normal thread using this priority is the reference
1208     // handler thread, which runs for very short intervals only.
1209     // If the VMThread's priority is not lower than the WatcherThread profiling
1210     // will be inaccurate.
1211     os::set_priority(this, MaxPriority);
1212     if (!DisableStartThread) {
1213       os::start_thread(this);
1214     }
1215   }
1216 }
1217 
1218 int WatcherThread::sleep() const {
1219   // The WatcherThread does not participate in the safepoint protocol
1220   // for the PeriodicTask_lock because it is not a JavaThread.
1221   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1222 
1223   if (_should_terminate) {
1224     // check for termination before we do any housekeeping or wait
1225     return 0;  // we did not sleep.
1226   }
1227 
1228   // remaining will be zero if there are no tasks,
1229   // causing the WatcherThread to sleep until a task is
1230   // enrolled
1231   int remaining = PeriodicTask::time_to_wait();
1232   int time_slept = 0;
1233 
1234   // we expect this to timeout - we only ever get unparked when
1235   // we should terminate or when a new task has been enrolled
1236   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1237 
1238   jlong time_before_loop = os::javaTimeNanos();
1239 
1240   while (true) {
1241     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1242                                             remaining);
1243     jlong now = os::javaTimeNanos();
1244 
1245     if (remaining == 0) {
1246       // if we didn't have any tasks we could have waited for a long time
1247       // consider the time_slept zero and reset time_before_loop
1248       time_slept = 0;
1249       time_before_loop = now;
1250     } else {
1251       // need to recalculate since we might have new tasks in _tasks
1252       time_slept = (int) ((now - time_before_loop) / 1000000);
1253     }
1254 
1255     // Change to task list or spurious wakeup of some kind
1256     if (timedout || _should_terminate) {
1257       break;
1258     }
1259 
1260     remaining = PeriodicTask::time_to_wait();
1261     if (remaining == 0) {
1262       // Last task was just disenrolled so loop around and wait until
1263       // another task gets enrolled
1264       continue;
1265     }
1266 
1267     remaining -= time_slept;
1268     if (remaining &lt;= 0) {
1269       break;
1270     }
1271   }
1272 
1273   return time_slept;
1274 }
1275 
1276 void WatcherThread::run() {
1277   assert(this == watcher_thread(), "just checking");
1278 
1279   this-&gt;record_stack_base_and_size();
1280   this-&gt;set_native_thread_name(this-&gt;name());
1281   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1282   while (true) {
1283     assert(watcher_thread() == Thread::current(), "thread consistency check");
1284     assert(watcher_thread() == this, "thread consistency check");
1285 
1286     // Calculate how long it'll be until the next PeriodicTask work
1287     // should be done, and sleep that amount of time.
1288     int time_waited = sleep();
1289 
1290     if (is_error_reported()) {
1291       // A fatal error has happened, the error handler(VMError::report_and_die)
1292       // should abort JVM after creating an error log file. However in some
1293       // rare cases, the error handler itself might deadlock. Here we try to
1294       // kill JVM if the fatal error handler fails to abort in 2 minutes.
1295       //
1296       // This code is in WatcherThread because WatcherThread wakes up
1297       // periodically so the fatal error handler doesn't need to do anything;
1298       // also because the WatcherThread is less likely to crash than other
1299       // threads.
1300 
1301       for (;;) {
1302         if (!ShowMessageBoxOnError
1303             &amp;&amp; (OnError == NULL || OnError[0] == '\0')
1304             &amp;&amp; Arguments::abort_hook() == NULL) {
1305           os::sleep(this, (jlong)ErrorLogTimeout * 1000, false); // in seconds
1306           fdStream err(defaultStream::output_fd());
1307           err.print_raw_cr("# [ timer expired, abort... ]");
1308           // skip atexit/vm_exit/vm_abort hooks
1309           os::die();
1310         }
1311 
1312         // Wake up 5 seconds later, the fatal handler may reset OnError or
1313         // ShowMessageBoxOnError when it is ready to abort.
1314         os::sleep(this, 5 * 1000, false);
1315       }
1316     }
1317 
1318     if (_should_terminate) {
1319       // check for termination before posting the next tick
1320       break;
1321     }
1322 
1323     PeriodicTask::real_time_tick(time_waited);
1324   }
1325 
1326   // Signal that it is terminated
1327   {
1328     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1329     _watcher_thread = NULL;
1330     Terminator_lock-&gt;notify();
1331   }
1332 }
1333 
1334 void WatcherThread::start() {
1335   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1336 
1337   if (watcher_thread() == NULL &amp;&amp; _startable) {
1338     _should_terminate = false;
1339     // Create the single instance of WatcherThread
1340     new WatcherThread();
1341   }
1342 }
1343 
1344 void WatcherThread::make_startable() {
1345   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1346   _startable = true;
1347 }
1348 
1349 void WatcherThread::stop() {
1350   {
1351     // Follow normal safepoint aware lock enter protocol since the
1352     // WatcherThread is stopped by another JavaThread.
1353     MutexLocker ml(PeriodicTask_lock);
1354     _should_terminate = true;
1355 
1356     WatcherThread* watcher = watcher_thread();
1357     if (watcher != NULL) {
1358       // unpark the WatcherThread so it can see that it should terminate
1359       watcher-&gt;unpark();
1360     }
1361   }
1362 
1363   MutexLocker mu(Terminator_lock);
1364 
1365   while (watcher_thread() != NULL) {
1366     // This wait should make safepoint checks, wait without a timeout,
1367     // and wait as a suspend-equivalent condition.
1368     //
1369     // Note: If the FlatProfiler is running, then this thread is waiting
1370     // for the WatcherThread to terminate and the WatcherThread, via the
1371     // FlatProfiler task, is waiting for the external suspend request on
1372     // this thread to complete. wait_for_ext_suspend_completion() will
1373     // eventually timeout, but that takes time. Making this wait a
1374     // suspend-equivalent condition solves that timeout problem.
1375     //
1376     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1377                           Mutex::_as_suspend_equivalent_flag);
1378   }
1379 }
1380 
1381 void WatcherThread::unpark() {
1382   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1383   PeriodicTask_lock-&gt;notify();
1384 }
1385 
1386 void WatcherThread::print_on(outputStream* st) const {
1387   st-&gt;print("\"%s\" ", name());
1388   Thread::print_on(st);
1389   st-&gt;cr();
1390 }
1391 
1392 // ======= JavaThread ========
1393 
1394 #if INCLUDE_JVMCI
1395 
1396 jlong* JavaThread::_jvmci_old_thread_counters;
1397 
1398 bool jvmci_counters_include(JavaThread* thread) {
1399   oop threadObj = thread-&gt;threadObj();
1400   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1401 }
1402 
1403 void JavaThread::collect_counters(typeArrayOop array) {
1404   if (JVMCICounterSize &gt; 0) {
1405     MutexLocker tl(Threads_lock);
1406     for (int i = 0; i &lt; array-&gt;length(); i++) {
1407       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1408     }
1409     for (JavaThread* tp = Threads::first(); tp != NULL; tp = tp-&gt;next()) {
1410       if (jvmci_counters_include(tp)) {
1411         for (int i = 0; i &lt; array-&gt;length(); i++) {
1412           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1413         }
1414       }
1415     }
1416   }
1417 }
1418 
1419 #endif // INCLUDE_JVMCI
1420 
1421 // A JavaThread is a normal Java thread
1422 
1423 void JavaThread::initialize() {
1424   // Initialize fields
1425 
1426   set_saved_exception_pc(NULL);
1427   set_threadObj(NULL);
1428   _anchor.clear();
1429   set_entry_point(NULL);
1430   set_jni_functions(jni_functions());
1431   set_callee_target(NULL);
1432   set_vm_result(NULL);
1433   set_vm_result_2(NULL);
1434   set_vframe_array_head(NULL);
1435   set_vframe_array_last(NULL);
1436   set_deferred_locals(NULL);
1437   set_deopt_mark(NULL);
1438   set_deopt_compiled_method(NULL);
1439   clear_must_deopt_id();
1440   set_monitor_chunks(NULL);
1441   set_next(NULL);
1442   set_thread_state(_thread_new);
1443   _terminated = _not_terminated;
1444   _privileged_stack_top = NULL;
1445   _array_for_gc = NULL;
1446   _suspend_equivalent = false;
1447   _in_deopt_handler = 0;
1448   _doing_unsafe_access = false;
1449   _stack_guard_state = stack_guard_unused;
1450 #if INCLUDE_JVMCI
1451   _pending_monitorenter = false;
1452   _pending_deoptimization = -1;
1453   _pending_failed_speculation = NULL;
1454   _pending_transfer_to_interpreter = false;
1455   _adjusting_comp_level = false;
1456   _jvmci._alternate_call_target = NULL;
1457   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1458   if (JVMCICounterSize &gt; 0) {
1459     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1460     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1461   } else {
1462     _jvmci_counters = NULL;
1463   }
1464 #endif // INCLUDE_JVMCI
1465   _reserved_stack_activation = NULL;  // stack base not known yet
1466   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1467   _exception_pc  = 0;
1468   _exception_handler_pc = 0;
1469   _is_method_handle_return = 0;
1470   _jvmti_thread_state= NULL;
1471   _should_post_on_exceptions_flag = JNI_FALSE;
1472   _jvmti_get_loaded_classes_closure = NULL;
1473   _interp_only_mode    = 0;
1474   _special_runtime_exit_condition = _no_async_condition;
1475   _pending_async_exception = NULL;
1476   _thread_stat = NULL;
1477   _thread_stat = new ThreadStatistics();
1478   _blocked_on_compilation = false;
1479   _jni_active_critical = 0;
1480   _pending_jni_exception_check_fn = NULL;
1481   _do_not_unlock_if_synchronized = false;
1482   _cached_monitor_info = NULL;
1483   _parker = Parker::Allocate(this);
1484 
1485 #ifndef PRODUCT
1486   _jmp_ring_index = 0;
1487   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1488     record_jump(NULL, NULL, NULL, 0);
1489   }
1490 #endif // PRODUCT
1491 
1492   set_thread_profiler(NULL);
1493   if (FlatProfiler::is_active()) {
1494     // This is where we would decide to either give each thread it's own profiler
1495     // or use one global one from FlatProfiler,
1496     // or up to some count of the number of profiled threads, etc.
1497     ThreadProfiler* pp = new ThreadProfiler();
1498     pp-&gt;engage();
1499     set_thread_profiler(pp);
1500   }
1501 
1502   // Setup safepoint state info for this thread
1503   ThreadSafepointState::create(this);
1504 
1505   debug_only(_java_call_counter = 0);
1506 
1507   // JVMTI PopFrame support
1508   _popframe_condition = popframe_inactive;
1509   _popframe_preserved_args = NULL;
1510   _popframe_preserved_args_size = 0;
1511   _frames_to_pop_failed_realloc = 0;
1512 
1513   pd_initialize();
1514 }
1515 
1516 #if INCLUDE_ALL_GCS
1517 SATBMarkQueueSet JavaThread::_satb_mark_queue_set;
1518 DirtyCardQueueSet JavaThread::_dirty_card_queue_set;
1519 #endif // INCLUDE_ALL_GCS
1520 
1521 JavaThread::JavaThread(bool is_attaching_via_jni) :
1522                        Thread()
1523 #if INCLUDE_ALL_GCS
1524                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1525                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1526 #endif // INCLUDE_ALL_GCS
1527 {
1528   initialize();
1529   if (is_attaching_via_jni) {
1530     _jni_attach_state = _attaching_via_jni;
1531   } else {
1532     _jni_attach_state = _not_attaching_via_jni;
1533   }
1534   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1535 }
1536 
1537 bool JavaThread::reguard_stack(address cur_sp) {
1538   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1539       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1540     return true; // Stack already guarded or guard pages not needed.
1541   }
1542 
1543   if (register_stack_overflow()) {
1544     // For those architectures which have separate register and
1545     // memory stacks, we must check the register stack to see if
1546     // it has overflowed.
1547     return false;
1548   }
1549 
1550   // Java code never executes within the yellow zone: the latter is only
1551   // there to provoke an exception during stack banging.  If java code
1552   // is executing there, either StackShadowPages should be larger, or
1553   // some exception code in c1, c2 or the interpreter isn't unwinding
1554   // when it should.
1555   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1556             "not enough space to reguard - increase StackShadowPages");
1557   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1558     enable_stack_yellow_reserved_zone();
1559     if (reserved_stack_activation() != stack_base()) {
1560       set_reserved_stack_activation(stack_base());
1561     }
1562   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1563     set_reserved_stack_activation(stack_base());
1564     enable_stack_reserved_zone();
1565   }
1566   return true;
1567 }
1568 
1569 bool JavaThread::reguard_stack(void) {
1570   return reguard_stack(os::current_stack_pointer());
1571 }
1572 
1573 
1574 void JavaThread::block_if_vm_exited() {
1575   if (_terminated == _vm_exited) {
1576     // _vm_exited is set at safepoint, and Threads_lock is never released
1577     // we will block here forever
1578     Threads_lock-&gt;lock_without_safepoint_check();
1579     ShouldNotReachHere();
1580   }
1581 }
1582 
1583 
1584 // Remove this ifdef when C1 is ported to the compiler interface.
1585 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1586 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1587 
1588 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1589                        Thread()
1590 #if INCLUDE_ALL_GCS
1591                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1592                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1593 #endif // INCLUDE_ALL_GCS
1594 {
1595   initialize();
1596   _jni_attach_state = _not_attaching_via_jni;
1597   set_entry_point(entry_point);
1598   // Create the native thread itself.
1599   // %note runtime_23
1600   os::ThreadType thr_type = os::java_thread;
1601   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1602                                                      os::java_thread;
1603   os::create_thread(this, thr_type, stack_sz);
1604   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1605   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1606   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1607   // the exception consists of creating the exception object &amp; initializing it, initialization
1608   // will leave the VM via a JavaCall and then all locks must be unlocked).
1609   //
1610   // The thread is still suspended when we reach here. Thread must be explicit started
1611   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1612   // by calling Threads:add. The reason why this is not done here, is because the thread
1613   // object must be fully initialized (take a look at JVM_Start)
1614 }
1615 
1616 JavaThread::~JavaThread() {
1617 
1618   // JSR166 -- return the parker to the free list
1619   Parker::Release(_parker);
1620   _parker = NULL;
1621 
1622   // Free any remaining  previous UnrollBlock
1623   vframeArray* old_array = vframe_array_last();
1624 
1625   if (old_array != NULL) {
1626     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1627     old_array-&gt;set_unroll_block(NULL);
1628     delete old_info;
1629     delete old_array;
1630   }
1631 
1632   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1633   if (deferred != NULL) {
1634     // This can only happen if thread is destroyed before deoptimization occurs.
1635     assert(deferred-&gt;length() != 0, "empty array!");
1636     do {
1637       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1638       deferred-&gt;remove_at(0);
1639       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1640       delete dlv;
1641     } while (deferred-&gt;length() != 0);
1642     delete deferred;
1643   }
1644 
1645   // All Java related clean up happens in exit
1646   ThreadSafepointState::destroy(this);
1647   if (_thread_profiler != NULL) delete _thread_profiler;
1648   if (_thread_stat != NULL) delete _thread_stat;
1649 
1650 #if INCLUDE_JVMCI
1651   if (JVMCICounterSize &gt; 0) {
1652     if (jvmci_counters_include(this)) {
1653       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1654         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1655       }
1656     }
1657     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1658   }
1659 #endif // INCLUDE_JVMCI
1660 }
1661 
1662 
1663 // The first routine called by a new Java thread
1664 void JavaThread::run() {
1665   // initialize thread-local alloc buffer related fields
1666   this-&gt;initialize_tlab();
1667 
1668   // used to test validity of stack trace backs
1669   this-&gt;record_base_of_stack_pointer();
1670 
1671   // Record real stack base and size.
1672   this-&gt;record_stack_base_and_size();
1673 
1674   this-&gt;create_stack_guard_pages();
1675 
1676   this-&gt;cache_global_variables();
1677 
1678   // Thread is now sufficient initialized to be handled by the safepoint code as being
1679   // in the VM. Change thread state from _thread_new to _thread_in_vm
1680   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1681 
1682   assert(JavaThread::current() == this, "sanity check");
1683   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1684 
1685   DTRACE_THREAD_PROBE(start, this);
1686 
1687   // This operation might block. We call that after all safepoint checks for a new thread has
1688   // been completed.
1689   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1690 
1691   if (JvmtiExport::should_post_thread_life()) {
1692     JvmtiExport::post_thread_start(this);
1693   }
1694 
1695   EventThreadStart event;
1696   if (event.should_commit()) {
1697     event.set_thread(THREAD_TRACE_ID(this));
1698     event.commit();
1699   }
1700 
1701   // We call another function to do the rest so we are sure that the stack addresses used
1702   // from there will be lower than the stack base just computed
1703   thread_main_inner();
1704 
1705   // Note, thread is no longer valid at this point!
1706 }
1707 
1708 
1709 void JavaThread::thread_main_inner() {
1710   assert(JavaThread::current() == this, "sanity check");
1711   assert(this-&gt;threadObj() != NULL, "just checking");
1712 
1713   // Execute thread entry point unless this thread has a pending exception
1714   // or has been stopped before starting.
1715   // Note: Due to JVM_StopThread we can have pending exceptions already!
1716   if (!this-&gt;has_pending_exception() &amp;&amp;
1717       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1718     {
1719       ResourceMark rm(this);
1720       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1721     }
1722     HandleMark hm(this);
1723     this-&gt;entry_point()(this, this);
1724   }
1725 
1726   DTRACE_THREAD_PROBE(stop, this);
1727 
1728   this-&gt;exit(false);
1729   delete this;
1730 }
1731 
1732 
1733 static void ensure_join(JavaThread* thread) {
1734   // We do not need to grap the Threads_lock, since we are operating on ourself.
1735   Handle threadObj(thread, thread-&gt;threadObj());
1736   assert(threadObj.not_null(), "java thread object must exist");
1737   ObjectLocker lock(threadObj, thread);
1738   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1739   thread-&gt;clear_pending_exception();
1740   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1741   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1742   // Clear the native thread instance - this makes isAlive return false and allows the join()
1743   // to complete once we've done the notify_all below
1744   java_lang_Thread::set_thread(threadObj(), NULL);
1745   lock.notify_all(thread);
1746   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1747   thread-&gt;clear_pending_exception();
1748 }
1749 
1750 
1751 // For any new cleanup additions, please check to see if they need to be applied to
1752 // cleanup_failed_attach_current_thread as well.
1753 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1754   assert(this == JavaThread::current(), "thread consistency check");
1755 
1756   HandleMark hm(this);
1757   Handle uncaught_exception(this, this-&gt;pending_exception());
1758   this-&gt;clear_pending_exception();
1759   Handle threadObj(this, this-&gt;threadObj());
1760   assert(threadObj.not_null(), "Java thread object should be created");
1761 
1762   if (get_thread_profiler() != NULL) {
1763     get_thread_profiler()-&gt;disengage();
1764     ResourceMark rm;
1765     get_thread_profiler()-&gt;print(get_thread_name());
1766   }
1767 
1768 
1769   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1770   {
1771     EXCEPTION_MARK;
1772 
1773     CLEAR_PENDING_EXCEPTION;
1774   }
1775   if (!destroy_vm) {
1776     if (uncaught_exception.not_null()) {
1777       EXCEPTION_MARK;
1778       // Call method Thread.dispatchUncaughtException().
1779       KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1780       JavaValue result(T_VOID);
1781       JavaCalls::call_virtual(&amp;result,
1782                               threadObj, thread_klass,
1783                               vmSymbols::dispatchUncaughtException_name(),
1784                               vmSymbols::throwable_void_signature(),
1785                               uncaught_exception,
1786                               THREAD);
1787       if (HAS_PENDING_EXCEPTION) {
1788         ResourceMark rm(this);
1789         jio_fprintf(defaultStream::error_stream(),
1790                     "\nException: %s thrown from the UncaughtExceptionHandler"
1791                     " in thread \"%s\"\n",
1792                     pending_exception()-&gt;klass()-&gt;external_name(),
1793                     get_thread_name());
1794         CLEAR_PENDING_EXCEPTION;
1795       }
1796     }
1797 
1798     // Called before the java thread exit since we want to read info
1799     // from java_lang_Thread object
1800     EventThreadEnd event;
1801     if (event.should_commit()) {
1802       event.set_thread(THREAD_TRACE_ID(this));
1803       event.commit();
1804     }
1805 
1806     // Call after last event on thread
1807     EVENT_THREAD_EXIT(this);
1808 
1809     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1810     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1811     // is deprecated anyhow.
1812     if (!is_Compiler_thread()) {
1813       int count = 3;
1814       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1815         EXCEPTION_MARK;
1816         JavaValue result(T_VOID);
1817         KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1818         JavaCalls::call_virtual(&amp;result,
1819                                 threadObj, thread_klass,
1820                                 vmSymbols::exit_method_name(),
1821                                 vmSymbols::void_method_signature(),
1822                                 THREAD);
1823         CLEAR_PENDING_EXCEPTION;
1824       }
1825     }
1826     // notify JVMTI
1827     if (JvmtiExport::should_post_thread_life()) {
1828       JvmtiExport::post_thread_end(this);
1829     }
1830 
1831     // We have notified the agents that we are exiting, before we go on,
1832     // we must check for a pending external suspend request and honor it
1833     // in order to not surprise the thread that made the suspend request.
1834     while (true) {
1835       {
1836         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1837         if (!is_external_suspend()) {
1838           set_terminated(_thread_exiting);
1839           ThreadService::current_thread_exiting(this);
1840           break;
1841         }
1842         // Implied else:
1843         // Things get a little tricky here. We have a pending external
1844         // suspend request, but we are holding the SR_lock so we
1845         // can't just self-suspend. So we temporarily drop the lock
1846         // and then self-suspend.
1847       }
1848 
1849       ThreadBlockInVM tbivm(this);
1850       java_suspend_self();
1851 
1852       // We're done with this suspend request, but we have to loop around
1853       // and check again. Eventually we will get SR_lock without a pending
1854       // external suspend request and will be able to mark ourselves as
1855       // exiting.
1856     }
1857     // no more external suspends are allowed at this point
1858   } else {
1859     // before_exit() has already posted JVMTI THREAD_END events
1860   }
1861 
1862   // Notify waiters on thread object. This has to be done after exit() is called
1863   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1864   // group should have the destroyed bit set before waiters are notified).
1865   ensure_join(this);
1866   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1867 
1868   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1869   // held by this thread must be released. The spec does not distinguish
1870   // between JNI-acquired and regular Java monitors. We can only see
1871   // regular Java monitors here if monitor enter-exit matching is broken.
1872   //
1873   // Optionally release any monitors for regular JavaThread exits. This
1874   // is provided as a work around for any bugs in monitor enter-exit
1875   // matching. This can be expensive so it is not enabled by default.
1876   //
1877   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1878   // ObjectSynchronizer::release_monitors_owned_by_thread().
1879   if (exit_type == jni_detach || ObjectMonitor::Knob_ExitRelease) {
1880     // Sanity check even though JNI DetachCurrentThread() would have
1881     // returned JNI_ERR if there was a Java frame. JavaThread exit
1882     // should be done executing Java code by the time we get here.
1883     assert(!this-&gt;has_last_Java_frame(),
1884            "should not have a Java frame when detaching or exiting");
1885     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1886     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1887   }
1888 
1889   // These things needs to be done while we are still a Java Thread. Make sure that thread
1890   // is in a consistent state, in case GC happens
1891   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1892 
1893   if (active_handles() != NULL) {
1894     JNIHandleBlock* block = active_handles();
1895     set_active_handles(NULL);
1896     JNIHandleBlock::release_block(block);
1897   }
1898 
1899   if (free_handle_block() != NULL) {
1900     JNIHandleBlock* block = free_handle_block();
1901     set_free_handle_block(NULL);
1902     JNIHandleBlock::release_block(block);
1903   }
1904 
1905   // These have to be removed while this is still a valid thread.
1906   remove_stack_guard_pages();
1907 
1908   if (UseTLAB) {
1909     tlab().make_parsable(true);  // retire TLAB
1910   }
1911 
1912   if (JvmtiEnv::environments_might_exist()) {
1913     JvmtiExport::cleanup_thread(this);
1914   }
1915 
1916   // We must flush any deferred card marks before removing a thread from
1917   // the list of active threads.
1918   Universe::heap()-&gt;flush_deferred_store_barrier(this);
1919   assert(deferred_card_mark().is_empty(), "Should have been flushed");
1920 
1921 #if INCLUDE_ALL_GCS
1922   // We must flush the G1-related buffers before removing a thread
1923   // from the list of active threads. We must do this after any deferred
1924   // card marks have been flushed (above) so that any entries that are
1925   // added to the thread's dirty card queue as a result are not lost.
1926   if (UseG1GC) {
1927     flush_barrier_queues();
1928   }
1929 #endif // INCLUDE_ALL_GCS
1930 
1931   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
1932     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
1933     os::current_thread_id());
1934 
1935   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
1936   Threads::remove(this);
1937 }
1938 
1939 #if INCLUDE_ALL_GCS
1940 // Flush G1-related queues.
1941 void JavaThread::flush_barrier_queues() {
1942   satb_mark_queue().flush();
1943   dirty_card_queue().flush();
1944 }
1945 
1946 void JavaThread::initialize_queues() {
1947   assert(!SafepointSynchronize::is_at_safepoint(),
1948          "we should not be at a safepoint");
1949 
1950   SATBMarkQueue&amp; satb_queue = satb_mark_queue();
1951   SATBMarkQueueSet&amp; satb_queue_set = satb_mark_queue_set();
1952   // The SATB queue should have been constructed with its active
1953   // field set to false.
1954   assert(!satb_queue.is_active(), "SATB queue should not be active");
1955   assert(satb_queue.is_empty(), "SATB queue should be empty");
1956   // If we are creating the thread during a marking cycle, we should
1957   // set the active field of the SATB queue to true.
1958   if (satb_queue_set.is_active()) {
1959     satb_queue.set_active(true);
1960   }
1961 
1962   DirtyCardQueue&amp; dirty_queue = dirty_card_queue();
1963   // The dirty card queue should have been constructed with its
1964   // active field set to true.
1965   assert(dirty_queue.is_active(), "dirty card queue should be active");
1966 }
1967 #endif // INCLUDE_ALL_GCS
1968 
1969 void JavaThread::cleanup_failed_attach_current_thread() {
1970   if (get_thread_profiler() != NULL) {
1971     get_thread_profiler()-&gt;disengage();
1972     ResourceMark rm;
1973     get_thread_profiler()-&gt;print(get_thread_name());
1974   }
1975 
1976   if (active_handles() != NULL) {
1977     JNIHandleBlock* block = active_handles();
1978     set_active_handles(NULL);
1979     JNIHandleBlock::release_block(block);
1980   }
1981 
1982   if (free_handle_block() != NULL) {
1983     JNIHandleBlock* block = free_handle_block();
1984     set_free_handle_block(NULL);
1985     JNIHandleBlock::release_block(block);
1986   }
1987 
1988   // These have to be removed while this is still a valid thread.
1989   remove_stack_guard_pages();
1990 
1991   if (UseTLAB) {
1992     tlab().make_parsable(true);  // retire TLAB, if any
1993   }
1994 
1995 #if INCLUDE_ALL_GCS
1996   if (UseG1GC) {
1997     flush_barrier_queues();
1998   }
1999 #endif // INCLUDE_ALL_GCS
2000 
2001   Threads::remove(this);
2002   delete this;
2003 }
2004 
2005 
2006 
2007 
2008 JavaThread* JavaThread::active() {
2009   Thread* thread = Thread::current();
2010   if (thread-&gt;is_Java_thread()) {
2011     return (JavaThread*) thread;
2012   } else {
2013     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2014     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2015     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2016     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2017     return ret;
2018   }
2019 }
2020 
2021 bool JavaThread::is_lock_owned(address adr) const {
2022   if (Thread::is_lock_owned(adr)) return true;
2023 
2024   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2025     if (chunk-&gt;contains(adr)) return true;
2026   }
2027 
2028   return false;
2029 }
2030 
2031 
2032 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2033   chunk-&gt;set_next(monitor_chunks());
2034   set_monitor_chunks(chunk);
2035 }
2036 
2037 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2038   guarantee(monitor_chunks() != NULL, "must be non empty");
2039   if (monitor_chunks() == chunk) {
2040     set_monitor_chunks(chunk-&gt;next());
2041   } else {
2042     MonitorChunk* prev = monitor_chunks();
2043     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2044     prev-&gt;set_next(chunk-&gt;next());
2045   }
2046 }
2047 
2048 // JVM support.
2049 
2050 // Note: this function shouldn't block if it's called in
2051 // _thread_in_native_trans state (such as from
2052 // check_special_condition_for_native_trans()).
2053 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2054 
2055   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2056     // If we are at a polling page safepoint (not a poll return)
2057     // then we must defer async exception because live registers
2058     // will be clobbered by the exception path. Poll return is
2059     // ok because the call we a returning from already collides
2060     // with exception handling registers and so there is no issue.
2061     // (The exception handling path kills call result registers but
2062     //  this is ok since the exception kills the result anyway).
2063 
2064     if (is_at_poll_safepoint()) {
2065       // if the code we are returning to has deoptimized we must defer
2066       // the exception otherwise live registers get clobbered on the
2067       // exception path before deoptimization is able to retrieve them.
2068       //
2069       RegisterMap map(this, false);
2070       frame caller_fr = last_frame().sender(&amp;map);
2071       assert(caller_fr.is_compiled_frame(), "what?");
2072       if (caller_fr.is_deoptimized_frame()) {
2073         log_info(exceptions)("deferred async exception at compiled safepoint");
2074         return;
2075       }
2076     }
2077   }
2078 
2079   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2080   if (condition == _no_async_condition) {
2081     // Conditions have changed since has_special_runtime_exit_condition()
2082     // was called:
2083     // - if we were here only because of an external suspend request,
2084     //   then that was taken care of above (or cancelled) so we are done
2085     // - if we were here because of another async request, then it has
2086     //   been cleared between the has_special_runtime_exit_condition()
2087     //   and now so again we are done
2088     return;
2089   }
2090 
2091   // Check for pending async. exception
2092   if (_pending_async_exception != NULL) {
2093     // Only overwrite an already pending exception, if it is not a threadDeath.
2094     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2095 
2096       // We cannot call Exceptions::_throw(...) here because we cannot block
2097       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2098 
2099       if (log_is_enabled(Info, exceptions)) {
2100         ResourceMark rm;
2101         outputStream* logstream = Log(exceptions)::info_stream();
2102         logstream-&gt;print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2103           if (has_last_Java_frame()) {
2104             frame f = last_frame();
2105            logstream-&gt;print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2106           }
2107         logstream-&gt;print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2108       }
2109       _pending_async_exception = NULL;
2110       clear_has_async_exception();
2111     }
2112   }
2113 
2114   if (check_unsafe_error &amp;&amp;
2115       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2116     condition = _no_async_condition;  // done
2117     switch (thread_state()) {
2118     case _thread_in_vm: {
2119       JavaThread* THREAD = this;
2120       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2121     }
2122     case _thread_in_native: {
2123       ThreadInVMfromNative tiv(this);
2124       JavaThread* THREAD = this;
2125       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2126     }
2127     case _thread_in_Java: {
2128       ThreadInVMfromJava tiv(this);
2129       JavaThread* THREAD = this;
2130       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2131     }
2132     default:
2133       ShouldNotReachHere();
2134     }
2135   }
2136 
2137   assert(condition == _no_async_condition || has_pending_exception() ||
2138          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2139          "must have handled the async condition, if no exception");
2140 }
2141 
2142 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2143   //
2144   // Check for pending external suspend. Internal suspend requests do
2145   // not use handle_special_runtime_exit_condition().
2146   // If JNIEnv proxies are allowed, don't self-suspend if the target
2147   // thread is not the current thread. In older versions of jdbx, jdbx
2148   // threads could call into the VM with another thread's JNIEnv so we
2149   // can be here operating on behalf of a suspended thread (4432884).
2150   bool do_self_suspend = is_external_suspend_with_lock();
2151   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2152     //
2153     // Because thread is external suspended the safepoint code will count
2154     // thread as at a safepoint. This can be odd because we can be here
2155     // as _thread_in_Java which would normally transition to _thread_blocked
2156     // at a safepoint. We would like to mark the thread as _thread_blocked
2157     // before calling java_suspend_self like all other callers of it but
2158     // we must then observe proper safepoint protocol. (We can't leave
2159     // _thread_blocked with a safepoint in progress). However we can be
2160     // here as _thread_in_native_trans so we can't use a normal transition
2161     // constructor/destructor pair because they assert on that type of
2162     // transition. We could do something like:
2163     //
2164     // JavaThreadState state = thread_state();
2165     // set_thread_state(_thread_in_vm);
2166     // {
2167     //   ThreadBlockInVM tbivm(this);
2168     //   java_suspend_self()
2169     // }
2170     // set_thread_state(_thread_in_vm_trans);
2171     // if (safepoint) block;
2172     // set_thread_state(state);
2173     //
2174     // but that is pretty messy. Instead we just go with the way the
2175     // code has worked before and note that this is the only path to
2176     // java_suspend_self that doesn't put the thread in _thread_blocked
2177     // mode.
2178 
2179     frame_anchor()-&gt;make_walkable(this);
2180     java_suspend_self();
2181 
2182     // We might be here for reasons in addition to the self-suspend request
2183     // so check for other async requests.
2184   }
2185 
2186   if (check_asyncs) {
2187     check_and_handle_async_exceptions();
2188   }
2189 }
2190 
2191 void JavaThread::send_thread_stop(oop java_throwable)  {
2192   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2193   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2194   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2195 
2196   // Do not throw asynchronous exceptions against the compiler thread
2197   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2198   if (!can_call_java()) return;
2199 
2200   {
2201     // Actually throw the Throwable against the target Thread - however
2202     // only if there is no thread death exception installed already.
2203     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2204       // If the topmost frame is a runtime stub, then we are calling into
2205       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2206       // must deoptimize the caller before continuing, as the compiled  exception handler table
2207       // may not be valid
2208       if (has_last_Java_frame()) {
2209         frame f = last_frame();
2210         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2211           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2212           RegisterMap reg_map(this, UseBiasedLocking);
2213           frame compiled_frame = f.sender(&amp;reg_map);
2214           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2215             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2216           }
2217         }
2218       }
2219 
2220       // Set async. pending exception in thread.
2221       set_pending_async_exception(java_throwable);
2222 
2223       if (log_is_enabled(Info, exceptions)) {
2224          ResourceMark rm;
2225         log_info(exceptions)("Pending Async. exception installed of type: %s",
2226                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2227       }
2228       // for AbortVMOnException flag
2229       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2230     }
2231   }
2232 
2233 
2234   // Interrupt thread so it will wake up from a potential wait()
2235   Thread::interrupt(this);
2236 }
2237 
2238 // External suspension mechanism.
2239 //
2240 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2241 // to any VM_locks and it is at a transition
2242 // Self-suspension will happen on the transition out of the vm.
2243 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2244 //
2245 // Guarantees on return:
2246 //   + Target thread will not execute any new bytecode (that's why we need to
2247 //     force a safepoint)
2248 //   + Target thread will not enter any new monitors
2249 //
2250 void JavaThread::java_suspend() {
2251   { MutexLocker mu(Threads_lock);
2252     if (!Threads::includes(this) || is_exiting() || this-&gt;threadObj() == NULL) {
2253       return;
2254     }
2255   }
2256 
2257   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2258     if (!is_external_suspend()) {
2259       // a racing resume has cancelled us; bail out now
2260       return;
2261     }
2262 
2263     // suspend is done
2264     uint32_t debug_bits = 0;
2265     // Warning: is_ext_suspend_completed() may temporarily drop the
2266     // SR_lock to allow the thread to reach a stable thread state if
2267     // it is currently in a transient thread state.
2268     if (is_ext_suspend_completed(false /* !called_by_wait */,
2269                                  SuspendRetryDelay, &amp;debug_bits)) {
2270       return;
2271     }
2272   }
2273 
2274   VM_ForceSafepoint vm_suspend;
2275   VMThread::execute(&amp;vm_suspend);
2276 }
2277 
2278 // Part II of external suspension.
2279 // A JavaThread self suspends when it detects a pending external suspend
2280 // request. This is usually on transitions. It is also done in places
2281 // where continuing to the next transition would surprise the caller,
2282 // e.g., monitor entry.
2283 //
2284 // Returns the number of times that the thread self-suspended.
2285 //
2286 // Note: DO NOT call java_suspend_self() when you just want to block current
2287 //       thread. java_suspend_self() is the second stage of cooperative
2288 //       suspension for external suspend requests and should only be used
2289 //       to complete an external suspend request.
2290 //
2291 int JavaThread::java_suspend_self() {
2292   int ret = 0;
2293 
2294   // we are in the process of exiting so don't suspend
2295   if (is_exiting()) {
2296     clear_external_suspend();
2297     return ret;
2298   }
2299 
2300   assert(_anchor.walkable() ||
2301          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2302          "must have walkable stack");
2303 
2304   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2305 
2306   assert(!this-&gt;is_ext_suspended(),
2307          "a thread trying to self-suspend should not already be suspended");
2308 
2309   if (this-&gt;is_suspend_equivalent()) {
2310     // If we are self-suspending as a result of the lifting of a
2311     // suspend equivalent condition, then the suspend_equivalent
2312     // flag is not cleared until we set the ext_suspended flag so
2313     // that wait_for_ext_suspend_completion() returns consistent
2314     // results.
2315     this-&gt;clear_suspend_equivalent();
2316   }
2317 
2318   // A racing resume may have cancelled us before we grabbed SR_lock
2319   // above. Or another external suspend request could be waiting for us
2320   // by the time we return from SR_lock()-&gt;wait(). The thread
2321   // that requested the suspension may already be trying to walk our
2322   // stack and if we return now, we can change the stack out from under
2323   // it. This would be a "bad thing (TM)" and cause the stack walker
2324   // to crash. We stay self-suspended until there are no more pending
2325   // external suspend requests.
2326   while (is_external_suspend()) {
2327     ret++;
2328     this-&gt;set_ext_suspended();
2329 
2330     // _ext_suspended flag is cleared by java_resume()
2331     while (is_ext_suspended()) {
2332       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2333     }
2334   }
2335 
2336   return ret;
2337 }
2338 
2339 #ifdef ASSERT
2340 // verify the JavaThread has not yet been published in the Threads::list, and
2341 // hence doesn't need protection from concurrent access at this stage
2342 void JavaThread::verify_not_published() {
2343   if (!Threads_lock-&gt;owned_by_self()) {
2344     MutexLockerEx ml(Threads_lock,  Mutex::_no_safepoint_check_flag);
2345     assert(!Threads::includes(this),
2346            "java thread shouldn't have been published yet!");
2347   } else {
2348     assert(!Threads::includes(this),
2349            "java thread shouldn't have been published yet!");
2350   }
2351 }
2352 #endif
2353 
2354 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2355 // progress or when _suspend_flags is non-zero.
2356 // Current thread needs to self-suspend if there is a suspend request and/or
2357 // block if a safepoint is in progress.
2358 // Async exception ISN'T checked.
2359 // Note only the ThreadInVMfromNative transition can call this function
2360 // directly and when thread state is _thread_in_native_trans
2361 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2362   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2363 
2364   JavaThread *curJT = JavaThread::current();
2365   bool do_self_suspend = thread-&gt;is_external_suspend();
2366 
2367   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2368 
2369   // If JNIEnv proxies are allowed, don't self-suspend if the target
2370   // thread is not the current thread. In older versions of jdbx, jdbx
2371   // threads could call into the VM with another thread's JNIEnv so we
2372   // can be here operating on behalf of a suspended thread (4432884).
2373   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2374     JavaThreadState state = thread-&gt;thread_state();
2375 
2376     // We mark this thread_blocked state as a suspend-equivalent so
2377     // that a caller to is_ext_suspend_completed() won't be confused.
2378     // The suspend-equivalent state is cleared by java_suspend_self().
2379     thread-&gt;set_suspend_equivalent();
2380 
2381     // If the safepoint code sees the _thread_in_native_trans state, it will
2382     // wait until the thread changes to other thread state. There is no
2383     // guarantee on how soon we can obtain the SR_lock and complete the
2384     // self-suspend request. It would be a bad idea to let safepoint wait for
2385     // too long. Temporarily change the state to _thread_blocked to
2386     // let the VM thread know that this thread is ready for GC. The problem
2387     // of changing thread state is that safepoint could happen just after
2388     // java_suspend_self() returns after being resumed, and VM thread will
2389     // see the _thread_blocked state. We must check for safepoint
2390     // after restoring the state and make sure we won't leave while a safepoint
2391     // is in progress.
2392     thread-&gt;set_thread_state(_thread_blocked);
2393     thread-&gt;java_suspend_self();
2394     thread-&gt;set_thread_state(state);
2395     // Make sure new state is seen by VM thread
2396     if (os::is_MP()) {
2397       if (UseMembar) {
2398         // Force a fence between the write above and read below
2399         OrderAccess::fence();
2400       } else {
2401         // Must use this rather than serialization page in particular on Windows
2402         InterfaceSupport::serialize_memory(thread);
2403       }
2404     }
2405   }
2406 
2407   if (SafepointSynchronize::do_call_back()) {
2408     // If we are safepointing, then block the caller which may not be
2409     // the same as the target thread (see above).
2410     SafepointSynchronize::block(curJT);
2411   }
2412 
2413   if (thread-&gt;is_deopt_suspend()) {
2414     thread-&gt;clear_deopt_suspend();
2415     RegisterMap map(thread, false);
2416     frame f = thread-&gt;last_frame();
2417     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2418       f = f.sender(&amp;map);
2419     }
2420     if (f.id() == thread-&gt;must_deopt_id()) {
2421       thread-&gt;clear_must_deopt_id();
2422       f.deoptimize(thread);
2423     } else {
2424       fatal("missed deoptimization!");
2425     }
2426   }
2427 }
2428 
2429 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2430 // progress or when _suspend_flags is non-zero.
2431 // Current thread needs to self-suspend if there is a suspend request and/or
2432 // block if a safepoint is in progress.
2433 // Also check for pending async exception (not including unsafe access error).
2434 // Note only the native==&gt;VM/Java barriers can call this function and when
2435 // thread state is _thread_in_native_trans.
2436 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2437   check_safepoint_and_suspend_for_native_trans(thread);
2438 
2439   if (thread-&gt;has_async_exception()) {
2440     // We are in _thread_in_native_trans state, don't handle unsafe
2441     // access error since that may block.
2442     thread-&gt;check_and_handle_async_exceptions(false);
2443   }
2444 }
2445 
2446 // This is a variant of the normal
2447 // check_special_condition_for_native_trans with slightly different
2448 // semantics for use by critical native wrappers.  It does all the
2449 // normal checks but also performs the transition back into
2450 // thread_in_Java state.  This is required so that critical natives
2451 // can potentially block and perform a GC if they are the last thread
2452 // exiting the GCLocker.
2453 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2454   check_special_condition_for_native_trans(thread);
2455 
2456   // Finish the transition
2457   thread-&gt;set_thread_state(_thread_in_Java);
2458 
2459   if (thread-&gt;do_critical_native_unlock()) {
2460     ThreadInVMfromJavaNoAsyncException tiv(thread);
2461     GCLocker::unlock_critical(thread);
2462     thread-&gt;clear_critical_native_unlock();
2463   }
2464 }
2465 
2466 // We need to guarantee the Threads_lock here, since resumes are not
2467 // allowed during safepoint synchronization
2468 // Can only resume from an external suspension
2469 void JavaThread::java_resume() {
2470   assert_locked_or_safepoint(Threads_lock);
2471 
2472   // Sanity check: thread is gone, has started exiting or the thread
2473   // was not externally suspended.
2474   if (!Threads::includes(this) || is_exiting() || !is_external_suspend()) {
2475     return;
2476   }
2477 
2478   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2479 
2480   clear_external_suspend();
2481 
2482   if (is_ext_suspended()) {
2483     clear_ext_suspended();
2484     SR_lock()-&gt;notify_all();
2485   }
2486 }
2487 
2488 size_t JavaThread::_stack_red_zone_size = 0;
2489 size_t JavaThread::_stack_yellow_zone_size = 0;
2490 size_t JavaThread::_stack_reserved_zone_size = 0;
2491 size_t JavaThread::_stack_shadow_zone_size = 0;
2492 
2493 void JavaThread::create_stack_guard_pages() {
2494   if (!os::uses_stack_guard_pages() || _stack_guard_state != stack_guard_unused) { return; }
2495   address low_addr = stack_end();
2496   size_t len = stack_guard_zone_size();
2497 
2498   int must_commit = os::must_commit_stack_guard_pages();
2499   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2500 
2501   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2502     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2503     return;
2504   }
2505 
2506   if (os::guard_memory((char *) low_addr, len)) {
2507     _stack_guard_state = stack_guard_enabled;
2508   } else {
2509     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2510       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2511     if (os::uncommit_memory((char *) low_addr, len)) {
2512       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2513     }
2514     return;
2515   }
2516 
2517   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2518     PTR_FORMAT "-" PTR_FORMAT ".",
2519     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2520 }
2521 
2522 void JavaThread::remove_stack_guard_pages() {
2523   assert(Thread::current() == this, "from different thread");
2524   if (_stack_guard_state == stack_guard_unused) return;
2525   address low_addr = stack_end();
2526   size_t len = stack_guard_zone_size();
2527 
2528   if (os::must_commit_stack_guard_pages()) {
2529     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2530       _stack_guard_state = stack_guard_unused;
2531     } else {
2532       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2533         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2534       return;
2535     }
2536   } else {
2537     if (_stack_guard_state == stack_guard_unused) return;
2538     if (os::unguard_memory((char *) low_addr, len)) {
2539       _stack_guard_state = stack_guard_unused;
2540     } else {
2541       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2542         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2543       return;
2544     }
2545   }
2546 
2547   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2548     PTR_FORMAT "-" PTR_FORMAT ".",
2549     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2550 }
2551 
2552 void JavaThread::enable_stack_reserved_zone() {
2553   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2554   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2555 
2556   // The base notation is from the stack's point of view, growing downward.
2557   // We need to adjust it to work correctly with guard_memory()
2558   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2559 
2560   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2561   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2562 
2563   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2564     _stack_guard_state = stack_guard_enabled;
2565   } else {
2566     warning("Attempt to guard stack reserved zone failed.");
2567   }
2568   enable_register_stack_guard();
2569 }
2570 
2571 void JavaThread::disable_stack_reserved_zone() {
2572   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2573   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2574 
2575   // Simply return if called for a thread that does not use guard pages.
2576   if (_stack_guard_state == stack_guard_unused) return;
2577 
2578   // The base notation is from the stack's point of view, growing downward.
2579   // We need to adjust it to work correctly with guard_memory()
2580   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2581 
2582   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2583     _stack_guard_state = stack_guard_reserved_disabled;
2584   } else {
2585     warning("Attempt to unguard stack reserved zone failed.");
2586   }
2587   disable_register_stack_guard();
2588 }
2589 
2590 void JavaThread::enable_stack_yellow_reserved_zone() {
2591   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2592   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2593 
2594   // The base notation is from the stacks point of view, growing downward.
2595   // We need to adjust it to work correctly with guard_memory()
2596   address base = stack_red_zone_base();
2597 
2598   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2599   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2600 
2601   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2602     _stack_guard_state = stack_guard_enabled;
2603   } else {
2604     warning("Attempt to guard stack yellow zone failed.");
2605   }
2606   enable_register_stack_guard();
2607 }
2608 
2609 void JavaThread::disable_stack_yellow_reserved_zone() {
2610   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2611   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2612 
2613   // Simply return if called for a thread that does not use guard pages.
2614   if (_stack_guard_state == stack_guard_unused) return;
2615 
2616   // The base notation is from the stacks point of view, growing downward.
2617   // We need to adjust it to work correctly with guard_memory()
2618   address base = stack_red_zone_base();
2619 
2620   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2621     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2622   } else {
2623     warning("Attempt to unguard stack yellow zone failed.");
2624   }
2625   disable_register_stack_guard();
2626 }
2627 
2628 void JavaThread::enable_stack_red_zone() {
2629   // The base notation is from the stacks point of view, growing downward.
2630   // We need to adjust it to work correctly with guard_memory()
2631   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2632   address base = stack_red_zone_base() - stack_red_zone_size();
2633 
2634   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2635   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2636 
2637   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2638     warning("Attempt to guard stack red zone failed.");
2639   }
2640 }
2641 
2642 void JavaThread::disable_stack_red_zone() {
2643   // The base notation is from the stacks point of view, growing downward.
2644   // We need to adjust it to work correctly with guard_memory()
2645   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2646   address base = stack_red_zone_base() - stack_red_zone_size();
2647   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2648     warning("Attempt to unguard stack red zone failed.");
2649   }
2650 }
2651 
2652 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2653   // ignore is there is no stack
2654   if (!has_last_Java_frame()) return;
2655   // traverse the stack frames. Starts from top frame.
2656   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2657     frame* fr = fst.current();
2658     f(fr, fst.register_map());
2659   }
2660 }
2661 
2662 
2663 #ifndef PRODUCT
2664 // Deoptimization
2665 // Function for testing deoptimization
2666 void JavaThread::deoptimize() {
2667   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2668   StackFrameStream fst(this, UseBiasedLocking);
2669   bool deopt = false;           // Dump stack only if a deopt actually happens.
2670   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2671   // Iterate over all frames in the thread and deoptimize
2672   for (; !fst.is_done(); fst.next()) {
2673     if (fst.current()-&gt;can_be_deoptimized()) {
2674 
2675       if (only_at) {
2676         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2677         // consists of comma or carriage return separated numbers so
2678         // search for the current bci in that string.
2679         address pc = fst.current()-&gt;pc();
2680         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2681         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2682         char buffer[8];
2683         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2684         size_t len = strlen(buffer);
2685         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2686         while (found != NULL) {
2687           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2688               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2689             // Check that the bci found is bracketed by terminators.
2690             break;
2691           }
2692           found = strstr(found + 1, buffer);
2693         }
2694         if (!found) {
2695           continue;
2696         }
2697       }
2698 
2699       if (DebugDeoptimization &amp;&amp; !deopt) {
2700         deopt = true; // One-time only print before deopt
2701         tty-&gt;print_cr("[BEFORE Deoptimization]");
2702         trace_frames();
2703         trace_stack();
2704       }
2705       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2706     }
2707   }
2708 
2709   if (DebugDeoptimization &amp;&amp; deopt) {
2710     tty-&gt;print_cr("[AFTER Deoptimization]");
2711     trace_frames();
2712   }
2713 }
2714 
2715 
2716 // Make zombies
2717 void JavaThread::make_zombies() {
2718   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2719     if (fst.current()-&gt;can_be_deoptimized()) {
2720       // it is a Java nmethod
2721       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2722       nm-&gt;make_not_entrant();
2723     }
2724   }
2725 }
2726 #endif // PRODUCT
2727 
2728 
2729 void JavaThread::deoptimized_wrt_marked_nmethods() {
2730   if (!has_last_Java_frame()) return;
2731   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2732   StackFrameStream fst(this, UseBiasedLocking);
2733   for (; !fst.is_done(); fst.next()) {
2734     if (fst.current()-&gt;should_be_deoptimized()) {
2735       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2736     }
2737   }
2738 }
2739 
2740 
2741 // If the caller is a NamedThread, then remember, in the current scope,
2742 // the given JavaThread in its _processed_thread field.
2743 class RememberProcessedThread: public StackObj {
2744   NamedThread* _cur_thr;
2745  public:
2746   RememberProcessedThread(JavaThread* jthr) {
2747     Thread* thread = Thread::current();
2748     if (thread-&gt;is_Named_thread()) {
2749       _cur_thr = (NamedThread *)thread;
2750       _cur_thr-&gt;set_processed_thread(jthr);
2751     } else {
2752       _cur_thr = NULL;
2753     }
2754   }
2755 
2756   ~RememberProcessedThread() {
2757     if (_cur_thr) {
2758       _cur_thr-&gt;set_processed_thread(NULL);
2759     }
2760   }
2761 };
2762 
2763 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2764   // Verify that the deferred card marks have been flushed.
2765   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2766 
2767   // The ThreadProfiler oops_do is done from FlatProfiler::oops_do
2768   // since there may be more than one thread using each ThreadProfiler.
2769 
2770   // Traverse the GCHandles
2771   Thread::oops_do(f, cf);
2772 
2773   JVMCI_ONLY(f-&gt;do_oop((oop*)&amp;_pending_failed_speculation);)
2774 
2775   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2776          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2777 
2778   if (has_last_Java_frame()) {
2779     // Record JavaThread to GC thread
2780     RememberProcessedThread rpt(this);
2781 
2782     // Traverse the privileged stack
2783     if (_privileged_stack_top != NULL) {
2784       _privileged_stack_top-&gt;oops_do(f);
2785     }
2786 
2787     // traverse the registered growable array
2788     if (_array_for_gc != NULL) {
2789       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2790         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2791       }
2792     }
2793 
2794     // Traverse the monitor chunks
2795     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2796       chunk-&gt;oops_do(f);
2797     }
2798 
2799     // Traverse the execution stack
2800     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2801       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2802     }
2803   }
2804 
2805   // callee_target is never live across a gc point so NULL it here should
2806   // it still contain a methdOop.
2807 
2808   set_callee_target(NULL);
2809 
2810   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2811   // If we have deferred set_locals there might be oops waiting to be
2812   // written
2813   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2814   if (list != NULL) {
2815     for (int i = 0; i &lt; list-&gt;length(); i++) {
2816       list-&gt;at(i)-&gt;oops_do(f);
2817     }
2818   }
2819 
2820   // Traverse instance variables at the end since the GC may be moving things
2821   // around using this function
2822   f-&gt;do_oop((oop*) &amp;_threadObj);
2823   f-&gt;do_oop((oop*) &amp;_vm_result);
2824   f-&gt;do_oop((oop*) &amp;_exception_oop);
2825   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2826 
2827   if (jvmti_thread_state() != NULL) {
2828     jvmti_thread_state()-&gt;oops_do(f);
2829   }
2830 }
2831 
2832 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2833   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2834          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2835 
2836   if (has_last_Java_frame()) {
2837     // Traverse the execution stack
2838     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2839       fst.current()-&gt;nmethods_do(cf);
2840     }
2841   }
2842 }
2843 
2844 void JavaThread::metadata_do(void f(Metadata*)) {
2845   if (has_last_Java_frame()) {
2846     // Traverse the execution stack to call f() on the methods in the stack
2847     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2848       fst.current()-&gt;metadata_do(f);
2849     }
2850   } else if (is_Compiler_thread()) {
2851     // need to walk ciMetadata in current compile tasks to keep alive.
2852     CompilerThread* ct = (CompilerThread*)this;
2853     if (ct-&gt;env() != NULL) {
2854       ct-&gt;env()-&gt;metadata_do(f);
2855     }
2856     if (ct-&gt;task() != NULL) {
2857       ct-&gt;task()-&gt;metadata_do(f);
2858     }
2859   }
2860 }
2861 
2862 // Printing
2863 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2864   switch (_thread_state) {
2865   case _thread_uninitialized:     return "_thread_uninitialized";
2866   case _thread_new:               return "_thread_new";
2867   case _thread_new_trans:         return "_thread_new_trans";
2868   case _thread_in_native:         return "_thread_in_native";
2869   case _thread_in_native_trans:   return "_thread_in_native_trans";
2870   case _thread_in_vm:             return "_thread_in_vm";
2871   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2872   case _thread_in_Java:           return "_thread_in_Java";
2873   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2874   case _thread_blocked:           return "_thread_blocked";
2875   case _thread_blocked_trans:     return "_thread_blocked_trans";
2876   default:                        return "unknown thread state";
2877   }
2878 }
2879 
2880 #ifndef PRODUCT
2881 void JavaThread::print_thread_state_on(outputStream *st) const {
2882   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2883 };
2884 void JavaThread::print_thread_state() const {
2885   print_thread_state_on(tty);
2886 }
2887 #endif // PRODUCT
2888 
2889 // Called by Threads::print() for VM_PrintThreads operation
2890 void JavaThread::print_on(outputStream *st) const {
2891   st-&gt;print_raw("\"");
2892   st-&gt;print_raw(get_thread_name());
2893   st-&gt;print_raw("\" ");
2894   oop thread_oop = threadObj();
2895   if (thread_oop != NULL) {
2896     st-&gt;print("#" INT64_FORMAT " ", java_lang_Thread::thread_id(thread_oop));
2897     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2898     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2899   }
2900   Thread::print_on(st);
2901   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2902   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2903   if (thread_oop != NULL) {
2904     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2905   }
2906 #ifndef PRODUCT
2907   print_thread_state_on(st);
2908   _safepoint_state-&gt;print_on(st);
2909 #endif // PRODUCT
2910   if (is_Compiler_thread()) {
2911     CompilerThread* ct = (CompilerThread*)this;
2912     if (ct-&gt;task() != NULL) {
2913       st-&gt;print("   Compiling: ");
2914       ct-&gt;task()-&gt;print(st, NULL, true, false);
2915     } else {
2916       st-&gt;print("   No compile task");
2917     }
2918     st-&gt;cr();
2919   }
2920 }
2921 
2922 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2923   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2924 }
2925 
2926 // Called by fatal error handler. The difference between this and
2927 // JavaThread::print() is that we can't grab lock or allocate memory.
2928 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2929   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2930   oop thread_obj = threadObj();
2931   if (thread_obj != NULL) {
2932     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2933   }
2934   st-&gt;print(" [");
2935   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2936   if (osthread()) {
2937     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2938   }
2939   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2940             p2i(stack_end()), p2i(stack_base()));
2941   st-&gt;print("]");
2942   return;
2943 }
2944 
2945 // Verification
2946 
2947 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2948 
2949 void JavaThread::verify() {
2950   // Verify oops in the thread.
2951   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2952 
2953   // Verify the stack frames.
2954   frames_do(frame_verify);
2955 }
2956 
2957 // CR 6300358 (sub-CR 2137150)
2958 // Most callers of this method assume that it can't return NULL but a
2959 // thread may not have a name whilst it is in the process of attaching to
2960 // the VM - see CR 6412693, and there are places where a JavaThread can be
2961 // seen prior to having it's threadObj set (eg JNI attaching threads and
2962 // if vm exit occurs during initialization). These cases can all be accounted
2963 // for such that this method never returns NULL.
2964 const char* JavaThread::get_thread_name() const {
2965 #ifdef ASSERT
2966   // early safepoints can hit while current thread does not yet have TLS
2967   if (!SafepointSynchronize::is_at_safepoint()) {
2968     Thread *cur = Thread::current();
2969     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
2970       // Current JavaThreads are allowed to get their own name without
2971       // the Threads_lock.
2972       assert_locked_or_safepoint(Threads_lock);
2973     }
2974   }
2975 #endif // ASSERT
2976   return get_thread_name_string();
2977 }
2978 
2979 // Returns a non-NULL representation of this thread's name, or a suitable
2980 // descriptive string if there is no set name
2981 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
2982   const char* name_str;
2983   oop thread_obj = threadObj();
2984   if (thread_obj != NULL) {
2985     oop name = java_lang_Thread::name(thread_obj);
2986     if (name != NULL) {
2987       if (buf == NULL) {
2988         name_str = java_lang_String::as_utf8_string(name);
2989       } else {
2990         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
2991       }
2992     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
2993       name_str = "&lt;no-name - thread is attaching&gt;";
2994     } else {
2995       name_str = Thread::name();
2996     }
2997   } else {
2998     name_str = Thread::name();
2999   }
3000   assert(name_str != NULL, "unexpected NULL thread name");
3001   return name_str;
3002 }
3003 
3004 
3005 const char* JavaThread::get_threadgroup_name() const {
3006   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3007   oop thread_obj = threadObj();
3008   if (thread_obj != NULL) {
3009     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3010     if (thread_group != NULL) {
3011       // ThreadGroup.name can be null
3012       return java_lang_ThreadGroup::name(thread_group);
3013     }
3014   }
3015   return NULL;
3016 }
3017 
3018 const char* JavaThread::get_parent_name() const {
3019   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3020   oop thread_obj = threadObj();
3021   if (thread_obj != NULL) {
3022     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3023     if (thread_group != NULL) {
3024       oop parent = java_lang_ThreadGroup::parent(thread_group);
3025       if (parent != NULL) {
3026         // ThreadGroup.name can be null
3027         return java_lang_ThreadGroup::name(parent);
3028       }
3029     }
3030   }
3031   return NULL;
3032 }
3033 
3034 ThreadPriority JavaThread::java_priority() const {
3035   oop thr_oop = threadObj();
3036   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3037   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3038   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3039   return priority;
3040 }
3041 
3042 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3043 
3044   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3045   // Link Java Thread object &lt;-&gt; C++ Thread
3046 
3047   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3048   // and put it into a new Handle.  The Handle "thread_oop" can then
3049   // be used to pass the C++ thread object to other methods.
3050 
3051   // Set the Java level thread object (jthread) field of the
3052   // new thread (a JavaThread *) to C++ thread object using the
3053   // "thread_oop" handle.
3054 
3055   // Set the thread field (a JavaThread *) of the
3056   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3057 
3058   Handle thread_oop(Thread::current(),
3059                     JNIHandles::resolve_non_null(jni_thread));
3060   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3061          "must be initialized");
3062   set_threadObj(thread_oop());
3063   java_lang_Thread::set_thread(thread_oop(), this);
3064 
3065   if (prio == NoPriority) {
3066     prio = java_lang_Thread::priority(thread_oop());
3067     assert(prio != NoPriority, "A valid priority should be present");
3068   }
3069 
3070   // Push the Java priority down to the native thread; needs Threads_lock
3071   Thread::set_priority(this, prio);
3072 
3073   prepare_ext();
3074 
3075   // Add the new thread to the Threads list and set it in motion.
3076   // We must have threads lock in order to call Threads::add.
3077   // It is crucial that we do not block before the thread is
3078   // added to the Threads list for if a GC happens, then the java_thread oop
3079   // will not be visited by GC.
3080   Threads::add(this);
3081 }
3082 
3083 oop JavaThread::current_park_blocker() {
3084   // Support for JSR-166 locks
3085   oop thread_oop = threadObj();
3086   if (thread_oop != NULL &amp;&amp;
3087       JDK_Version::current().supports_thread_park_blocker()) {
3088     return java_lang_Thread::park_blocker(thread_oop);
3089   }
3090   return NULL;
3091 }
3092 
3093 
3094 void JavaThread::print_stack_on(outputStream* st) {
3095   if (!has_last_Java_frame()) return;
3096   ResourceMark rm;
3097   HandleMark   hm;
3098 
3099   RegisterMap reg_map(this);
3100   vframe* start_vf = last_java_vframe(&amp;reg_map);
3101   int count = 0;
3102   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3103     if (f-&gt;is_java_frame()) {
3104       javaVFrame* jvf = javaVFrame::cast(f);
3105       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3106 
3107       // Print out lock information
3108       if (JavaMonitorsInStackTrace) {
3109         jvf-&gt;print_lock_info_on(st, count);
3110       }
3111     } else {
3112       // Ignore non-Java frames
3113     }
3114 
3115     // Bail-out case for too deep stacks
3116     count++;
3117     if (MaxJavaStackTraceDepth == count) return;
3118   }
3119 }
3120 
3121 
3122 // JVMTI PopFrame support
3123 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3124   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3125   if (in_bytes(size_in_bytes) != 0) {
3126     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3127     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3128     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3129   }
3130 }
3131 
3132 void* JavaThread::popframe_preserved_args() {
3133   return _popframe_preserved_args;
3134 }
3135 
3136 ByteSize JavaThread::popframe_preserved_args_size() {
3137   return in_ByteSize(_popframe_preserved_args_size);
3138 }
3139 
3140 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3141   int sz = in_bytes(popframe_preserved_args_size());
3142   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3143   return in_WordSize(sz / wordSize);
3144 }
3145 
3146 void JavaThread::popframe_free_preserved_args() {
3147   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3148   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3149   _popframe_preserved_args = NULL;
3150   _popframe_preserved_args_size = 0;
3151 }
3152 
3153 #ifndef PRODUCT
3154 
3155 void JavaThread::trace_frames() {
3156   tty-&gt;print_cr("[Describe stack]");
3157   int frame_no = 1;
3158   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3159     tty-&gt;print("  %d. ", frame_no++);
3160     fst.current()-&gt;print_value_on(tty, this);
3161     tty-&gt;cr();
3162   }
3163 }
3164 
3165 class PrintAndVerifyOopClosure: public OopClosure {
3166  protected:
3167   template &lt;class T&gt; inline void do_oop_work(T* p) {
3168     oop obj = oopDesc::load_decode_heap_oop(p);
3169     if (obj == NULL) return;
3170     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3171     if (obj-&gt;is_oop_or_null()) {
3172       if (obj-&gt;is_objArray()) {
3173         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3174       } else {
3175         obj-&gt;print();
3176       }
3177     } else {
3178       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3179     }
3180     tty-&gt;cr();
3181   }
3182  public:
3183   virtual void do_oop(oop* p) { do_oop_work(p); }
3184   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3185 };
3186 
3187 
3188 static void oops_print(frame* f, const RegisterMap *map) {
3189   PrintAndVerifyOopClosure print;
3190   f-&gt;print_value();
3191   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3192 }
3193 
3194 // Print our all the locations that contain oops and whether they are
3195 // valid or not.  This useful when trying to find the oldest frame
3196 // where an oop has gone bad since the frame walk is from youngest to
3197 // oldest.
3198 void JavaThread::trace_oops() {
3199   tty-&gt;print_cr("[Trace oops]");
3200   frames_do(oops_print);
3201 }
3202 
3203 
3204 #ifdef ASSERT
3205 // Print or validate the layout of stack frames
3206 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3207   ResourceMark rm;
3208   PRESERVE_EXCEPTION_MARK;
3209   FrameValues values;
3210   int frame_no = 0;
3211   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3212     fst.current()-&gt;describe(values, ++frame_no);
3213     if (depth == frame_no) break;
3214   }
3215   if (validate_only) {
3216     values.validate();
3217   } else {
3218     tty-&gt;print_cr("[Describe stack layout]");
3219     values.print(this);
3220   }
3221 }
3222 #endif
3223 
3224 void JavaThread::trace_stack_from(vframe* start_vf) {
3225   ResourceMark rm;
3226   int vframe_no = 1;
3227   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3228     if (f-&gt;is_java_frame()) {
3229       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3230     } else {
3231       f-&gt;print();
3232     }
3233     if (vframe_no &gt; StackPrintLimit) {
3234       tty-&gt;print_cr("...&lt;more frames&gt;...");
3235       return;
3236     }
3237   }
3238 }
3239 
3240 
3241 void JavaThread::trace_stack() {
3242   if (!has_last_Java_frame()) return;
3243   ResourceMark rm;
3244   HandleMark   hm;
3245   RegisterMap reg_map(this);
3246   trace_stack_from(last_java_vframe(&amp;reg_map));
3247 }
3248 
3249 
3250 #endif // PRODUCT
3251 
3252 
3253 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3254   assert(reg_map != NULL, "a map must be given");
3255   frame f = last_frame();
3256   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3257     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3258   }
3259   return NULL;
3260 }
3261 
3262 
3263 Klass* JavaThread::security_get_caller_class(int depth) {
3264   vframeStream vfst(this);
3265   vfst.security_get_caller_frame(depth);
3266   if (!vfst.at_end()) {
3267     return vfst.method()-&gt;method_holder();
3268   }
3269   return NULL;
3270 }
3271 
3272 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3273   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3274   CompileBroker::compiler_thread_loop();
3275 }
3276 
3277 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3278   NMethodSweeper::sweeper_loop();
3279 }
3280 
3281 // Create a CompilerThread
3282 CompilerThread::CompilerThread(CompileQueue* queue,
3283                                CompilerCounters* counters)
3284                                : JavaThread(&amp;compiler_thread_entry) {
3285   _env   = NULL;
3286   _log   = NULL;
3287   _task  = NULL;
3288   _queue = queue;
3289   _counters = counters;
3290   _buffer_blob = NULL;
3291   _compiler = NULL;
3292 
3293 #ifndef PRODUCT
3294   _ideal_graph_printer = NULL;
3295 #endif
3296 }
3297 
3298 bool CompilerThread::can_call_java() const {
3299   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3300 }
3301 
3302 // Create sweeper thread
3303 CodeCacheSweeperThread::CodeCacheSweeperThread()
3304 : JavaThread(&amp;sweeper_thread_entry) {
3305   _scanned_compiled_method = NULL;
3306 }
3307 
3308 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3309   JavaThread::oops_do(f, cf);
3310   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3311     // Safepoints can occur when the sweeper is scanning an nmethod so
3312     // process it here to make sure it isn't unloaded in the middle of
3313     // a scan.
3314     cf-&gt;do_code_blob(_scanned_compiled_method);
3315   }
3316 }
3317 
3318 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3319   JavaThread::nmethods_do(cf);
3320   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3321     // Safepoints can occur when the sweeper is scanning an nmethod so
3322     // process it here to make sure it isn't unloaded in the middle of
3323     // a scan.
3324     cf-&gt;do_code_blob(_scanned_compiled_method);
3325   }
3326 }
3327 
3328 
3329 // ======= Threads ========
3330 
3331 // The Threads class links together all active threads, and provides
3332 // operations over all threads.  It is protected by its own Mutex
3333 // lock, which is also used in other contexts to protect thread
3334 // operations from having the thread being operated on from exiting
3335 // and going away unexpectedly (e.g., safepoint synchronization)
3336 
3337 JavaThread* Threads::_thread_list = NULL;
3338 int         Threads::_number_of_threads = 0;
3339 int         Threads::_number_of_non_daemon_threads = 0;
3340 int         Threads::_return_code = 0;
3341 int         Threads::_thread_claim_parity = 0;
3342 size_t      JavaThread::_stack_size_at_create = 0;
3343 #ifdef ASSERT
3344 bool        Threads::_vm_complete = false;
3345 #endif
3346 
3347 // All JavaThreads
3348 #define ALL_JAVA_THREADS(X) for (JavaThread* X = _thread_list; X; X = X-&gt;next())
3349 
3350 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system)
3351 void Threads::threads_do(ThreadClosure* tc) {
3352   assert_locked_or_safepoint(Threads_lock);
3353   // ALL_JAVA_THREADS iterates through all JavaThreads
3354   ALL_JAVA_THREADS(p) {
3355     tc-&gt;do_thread(p);
3356   }
3357   // Someday we could have a table or list of all non-JavaThreads.
3358   // For now, just manually iterate through them.
3359   tc-&gt;do_thread(VMThread::vm_thread());
3360   Universe::heap()-&gt;gc_threads_do(tc);
3361   WatcherThread *wt = WatcherThread::watcher_thread();
3362   // Strictly speaking, the following NULL check isn't sufficient to make sure
3363   // the data for WatcherThread is still valid upon being examined. However,
3364   // considering that WatchThread terminates when the VM is on the way to
3365   // exit at safepoint, the chance of the above is extremely small. The right
3366   // way to prevent termination of WatcherThread would be to acquire
3367   // Terminator_lock, but we can't do that without violating the lock rank
3368   // checking in some cases.
3369   if (wt != NULL) {
3370     tc-&gt;do_thread(wt);
3371   }
3372 
3373   // If CompilerThreads ever become non-JavaThreads, add them here
3374 }
3375 
3376 // The system initialization in the library has three phases.
3377 //
3378 // Phase 1: java.lang.System class initialization
3379 //     java.lang.System is a primordial class loaded and initialized
3380 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3381 //     only does registerNatives and keeps the rest of the class
3382 //     initialization work later until thread initialization completes.
3383 //
3384 //     System.initPhase1 initializes the system properties, the static
3385 //     fields in, out, and err. Set up java signal handlers, OS-specific
3386 //     system settings, and thread group of the main thread.
3387 static void call_initPhase1(TRAPS) {
3388   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3389   instanceKlassHandle klass (THREAD, k);
3390 
3391   JavaValue result(T_VOID);
3392   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3393                                          vmSymbols::void_method_signature(), CHECK);
3394 }
3395 
3396 // Phase 2. Module system initialization
3397 //     This will initialize the module system.  Only java.base classes
3398 //     can be loaded until phase 2 completes.
3399 //
3400 //     Call System.initPhase2 after the compiler initialization and jsr292
3401 //     classes get initialized because module initialization runs a lot of java
3402 //     code, that for performance reasons, should be compiled.  Also, this will
3403 //     enable the startup code to use lambda and other language features in this
3404 //     phase and onward.
3405 //
3406 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3407 static void call_initPhase2(TRAPS) {
3408   TraceTime timer("Phase2 initialization", TRACETIME_LOG(Info, modules, startuptime));
3409 
3410   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3411   instanceKlassHandle klass (THREAD, k);
3412 
3413   JavaValue result(T_VOID);
3414   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3415                                          vmSymbols::void_method_signature(), CHECK);
3416   universe_post_module_init();
3417 }
3418 
3419 // Phase 3. final setup - set security manager, system class loader and TCCL
3420 //
3421 //     This will instantiate and set the security manager, set the system class
3422 //     loader as well as the thread context class loader.  The security manager
3423 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3424 //     other modules or the application's classpath.
3425 static void call_initPhase3(TRAPS) {
3426   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3427   instanceKlassHandle klass (THREAD, k);
3428 
3429   JavaValue result(T_VOID);
3430   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3431                                          vmSymbols::void_method_signature(), CHECK);
3432 }
3433 
3434 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3435   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3436 
3437   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3438     create_vm_init_libraries();
3439   }
3440 
3441   initialize_class(vmSymbols::java_lang_String(), CHECK);
3442 
3443   // Inject CompactStrings value after the static initializers for String ran.
3444   java_lang_String::set_compact_strings(CompactStrings);
3445 
3446   // Initialize java_lang.System (needed before creating the thread)
3447   initialize_class(vmSymbols::java_lang_System(), CHECK);
3448   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3449   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3450   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3451   Handle thread_group = create_initial_thread_group(CHECK);
3452   Universe::set_main_thread_group(thread_group());
3453   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3454   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3455   main_thread-&gt;set_threadObj(thread_object);
3456   // Set thread status to running since main thread has
3457   // been started and running.
3458   java_lang_Thread::set_thread_status(thread_object,
3459                                       java_lang_Thread::RUNNABLE);
3460 
3461   // The VM creates objects of this class.
3462   initialize_class(vmSymbols::java_lang_reflect_Module(), CHECK);
3463 
3464   // The VM preresolves methods to these classes. Make sure that they get initialized
3465   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3466   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3467 
3468   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3469   call_initPhase1(CHECK);
3470 
3471   // get the Java runtime name after java.lang.System is initialized
3472   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3473   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3474 
3475   // an instance of OutOfMemory exception has been allocated earlier
3476   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3477   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3478   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3479   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3480   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3481   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3482   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3483   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3484 }
3485 
3486 void Threads::initialize_jsr292_core_classes(TRAPS) {
3487   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3488 
3489   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3490   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3491   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3492 }
3493 
3494 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3495   extern void JDK_Version_init();
3496 
3497   // Preinitialize version info.
3498   VM_Version::early_initialize();
3499 
3500   // Check version
3501   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3502 
3503   // Initialize library-based TLS
3504   ThreadLocalStorage::init();
3505 
3506   // Initialize the output stream module
3507   ostream_init();
3508 
3509   // Process java launcher properties.
3510   Arguments::process_sun_java_launcher_properties(args);
3511 
3512   // Initialize the os module
3513   os::init();
3514 
3515   // Record VM creation timing statistics
3516   TraceVmCreationTime create_vm_timer;
3517   create_vm_timer.start();
3518 
3519   // Initialize system properties.
3520   Arguments::init_system_properties();
3521 
3522   // So that JDK version can be used as a discriminator when parsing arguments
3523   JDK_Version_init();
3524 
3525   // Update/Initialize System properties after JDK version number is known
3526   Arguments::init_version_specific_system_properties();
3527 
3528   // Make sure to initialize log configuration *before* parsing arguments
3529   LogConfiguration::initialize(create_vm_timer.begin_time());
3530 
3531   // Parse arguments
3532   jint parse_result = Arguments::parse(args);
3533   if (parse_result != JNI_OK) return parse_result;
3534 
3535   os::init_before_ergo();
3536 
3537   jint ergo_result = Arguments::apply_ergo();
3538   if (ergo_result != JNI_OK) return ergo_result;
3539 
3540   // Final check of all ranges after ergonomics which may change values.
3541   if (!CommandLineFlagRangeList::check_ranges()) {
3542     return JNI_EINVAL;
3543   }
3544 
3545   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3546   bool constraint_result = CommandLineFlagConstraintList::check_constraints(CommandLineFlagConstraint::AfterErgo);
3547   if (!constraint_result) {
3548     return JNI_EINVAL;
3549   }
3550 
3551   CommandLineFlagWriteableList::mark_startup();
3552 
3553   if (PauseAtStartup) {
3554     os::pause();
3555   }
3556 
3557   HOTSPOT_VM_INIT_BEGIN();
3558 
3559   // Timing (must come after argument parsing)
3560   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3561 
3562   // Initialize the os module after parsing the args
3563   jint os_init_2_result = os::init_2();
3564   if (os_init_2_result != JNI_OK) return os_init_2_result;
3565 
3566   jint adjust_after_os_result = Arguments::adjust_after_os();
3567   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3568 
3569   // Initialize output stream logging
3570   ostream_init_log();
3571 
3572   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3573   // Must be before create_vm_init_agents()
3574   if (Arguments::init_libraries_at_startup()) {
3575     convert_vm_init_libraries_to_agents();
3576   }
3577 
3578   // Launch -agentlib/-agentpath and converted -Xrun agents
3579   if (Arguments::init_agents_at_startup()) {
3580     create_vm_init_agents();
3581   }
3582 
3583   // Initialize Threads state
3584   _thread_list = NULL;
3585   _number_of_threads = 0;
3586   _number_of_non_daemon_threads = 0;
3587 
3588   // Initialize global data structures and create system classes in heap
3589   vm_init_globals();
3590 
3591 #if INCLUDE_JVMCI
3592   if (JVMCICounterSize &gt; 0) {
3593     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3594     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3595   } else {
3596     JavaThread::_jvmci_old_thread_counters = NULL;
3597   }
3598 #endif // INCLUDE_JVMCI
3599 
3600   // Attach the main thread to this os thread
3601   JavaThread* main_thread = new JavaThread();
3602   main_thread-&gt;set_thread_state(_thread_in_vm);
3603   main_thread-&gt;initialize_thread_current();
3604   // must do this before set_active_handles
3605   main_thread-&gt;record_stack_base_and_size();
3606   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3607 
3608   if (!main_thread-&gt;set_as_starting_thread()) {
3609     vm_shutdown_during_initialization(
3610                                       "Failed necessary internal allocation. Out of swap space");
3611     delete main_thread;
3612     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3613     return JNI_ENOMEM;
3614   }
3615 
3616   // Enable guard page *after* os::create_main_thread(), otherwise it would
3617   // crash Linux VM, see notes in os_linux.cpp.
3618   main_thread-&gt;create_stack_guard_pages();
3619 
3620   // Initialize Java-Level synchronization subsystem
3621   ObjectMonitor::Initialize();
3622 
3623   // Initialize global modules
3624   jint status = init_globals();
3625   if (status != JNI_OK) {
3626     delete main_thread;
3627     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3628     return status;
3629   }
3630 
3631   if (TRACE_INITIALIZE() != JNI_OK) {
3632     vm_exit_during_initialization("Failed to initialize tracing backend");
3633   }
3634 
3635   // Should be done after the heap is fully created
3636   main_thread-&gt;cache_global_variables();
3637 
3638   HandleMark hm;
3639 
3640   { MutexLocker mu(Threads_lock);
3641     Threads::add(main_thread);
3642   }
3643 
3644   // Any JVMTI raw monitors entered in onload will transition into
3645   // real raw monitor. VM is setup enough here for raw monitor enter.
3646   JvmtiExport::transition_pending_onload_raw_monitors();
3647 
3648   // Create the VMThread
3649   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3650 
3651   VMThread::create();
3652     Thread* vmthread = VMThread::vm_thread();
3653 
3654     if (!os::create_thread(vmthread, os::vm_thread)) {
3655       vm_exit_during_initialization("Cannot create VM thread. "
3656                                     "Out of system resources.");
3657     }
3658 
3659     // Wait for the VM thread to become ready, and VMThread::run to initialize
3660     // Monitors can have spurious returns, must always check another state flag
3661     {
3662       MutexLocker ml(Notify_lock);
3663       os::start_thread(vmthread);
3664       while (vmthread-&gt;active_handles() == NULL) {
3665         Notify_lock-&gt;wait();
3666       }
3667     }
3668   }
3669 
3670   assert(Universe::is_fully_initialized(), "not initialized");
3671   if (VerifyDuringStartup) {
3672     // Make sure we're starting with a clean slate.
3673     VM_Verify verify_op;
3674     VMThread::execute(&amp;verify_op);
3675   }
3676 
3677   Thread* THREAD = Thread::current();
3678 
3679   // At this point, the Universe is initialized, but we have not executed
3680   // any byte code.  Now is a good time (the only time) to dump out the
3681   // internal state of the JVM for sharing.
3682   if (DumpSharedSpaces) {
3683     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3684     ShouldNotReachHere();
3685   }
3686 
3687   // Always call even when there are not JVMTI environments yet, since environments
3688   // may be attached late and JVMTI must track phases of VM execution
3689   JvmtiExport::enter_early_start_phase();
3690 
3691   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3692   JvmtiExport::post_early_vm_start();
3693 
3694   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3695 
3696   // We need this for ClassDataSharing - the initial vm.info property is set
3697   // with the default value of CDS "sharing" which may be reset through
3698   // command line options.
3699   reset_vm_info_property(CHECK_JNI_ERR);
3700 
3701   quicken_jni_functions();
3702 
3703   // No more stub generation allowed after that point.
3704   StubCodeDesc::freeze();
3705 
3706   // Set flag that basic initialization has completed. Used by exceptions and various
3707   // debug stuff, that does not work until all basic classes have been initialized.
3708   set_init_completed();
3709 
3710   LogConfiguration::post_initialize();
3711   Metaspace::post_initialize();
3712 
3713   HOTSPOT_VM_INIT_END();
3714 
3715   // record VM initialization completion time
3716 #if INCLUDE_MANAGEMENT
3717   Management::record_vm_init_completed();
3718 #endif // INCLUDE_MANAGEMENT
3719 
3720   // Signal Dispatcher needs to be started before VMInit event is posted
3721   os::signal_init();
3722 
3723   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3724   if (!DisableAttachMechanism) {
3725     AttachListener::vm_start();
3726     if (StartAttachListener || AttachListener::init_at_startup()) {
3727       AttachListener::init();
3728     }
3729   }
3730 
3731   // Launch -Xrun agents
3732   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3733   // back-end can launch with -Xdebug -Xrunjdwp.
3734   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3735     create_vm_init_libraries();
3736   }
3737 
3738   if (CleanChunkPoolAsync) {
3739     Chunk::start_chunk_pool_cleaner_task();
3740   }
3741 
3742   // initialize compiler(s)
3743 #if defined(COMPILER1) || defined(COMPILER2) || defined(SHARK) || INCLUDE_JVMCI
3744   CompileBroker::compilation_init(CHECK_JNI_ERR);
3745 #endif
3746 
3747   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3748   // It is done after compilers are initialized, because otherwise compilations of
3749   // signature polymorphic MH intrinsics can be missed
3750   // (see SystemDictionary::find_method_handle_intrinsic).
3751   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3752 
3753   // This will initialize the module system.  Only java.base classes can be
3754   // loaded until phase 2 completes
3755   call_initPhase2(CHECK_JNI_ERR);
3756 
3757   // Always call even when there are not JVMTI environments yet, since environments
3758   // may be attached late and JVMTI must track phases of VM execution
3759   JvmtiExport::enter_start_phase();
3760 
3761   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3762   JvmtiExport::post_vm_start();
3763 
3764   // Final system initialization including security manager and system class loader
3765   call_initPhase3(CHECK_JNI_ERR);
3766 
3767   // cache the system class loader
3768   SystemDictionary::compute_java_system_loader(CHECK_(JNI_ERR));
3769 
3770 #if INCLUDE_JVMCI
<a name="1" id="anc1"></a><span class="changed">3771   if (EnableJVMCI) {</span>
<span class="changed">3772     // Initialize JVMCI eagerly if JVMCIPrintProperties is enabled.</span>
<span class="changed">3773     // The JVMCI Java initialization code will read this flag and</span>
<span class="changed">3774     // do the printing if it's set.</span>
<span class="changed">3775     bool init = JVMCIPrintProperties;</span>
<span class="changed">3776 </span>
<span class="changed">3777     if (!init) {</span>
3778       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3779       // compilations via JVMCI will not actually block until JVMCI is initialized.
<a name="2" id="anc2"></a><span class="new">3780       init = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);</span>
<span class="new">3781     }</span>
<span class="new">3782 </span>
<span class="new">3783     if (init) {</span>
3784       JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3785     }
<a name="3" id="anc3"></a><span class="new">3786   }</span>
3787 #endif
3788 
3789   // Always call even when there are not JVMTI environments yet, since environments
3790   // may be attached late and JVMTI must track phases of VM execution
3791   JvmtiExport::enter_live_phase();
3792 
3793   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3794   JvmtiExport::post_vm_initialized();
3795 
3796   if (TRACE_START() != JNI_OK) {
3797     vm_exit_during_initialization("Failed to start tracing backend.");
3798   }
3799 
3800 #if INCLUDE_MANAGEMENT
3801   Management::initialize(THREAD);
3802 
3803   if (HAS_PENDING_EXCEPTION) {
3804     // management agent fails to start possibly due to
3805     // configuration problem and is responsible for printing
3806     // stack trace if appropriate. Simply exit VM.
3807     vm_exit(1);
3808   }
3809 #endif // INCLUDE_MANAGEMENT
3810 
3811   if (Arguments::has_profile())       FlatProfiler::engage(main_thread, true);
3812   if (MemProfiling)                   MemProfiler::engage();
3813   StatSampler::engage();
3814   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3815 
3816   BiasedLocking::init();
3817 
3818 #if INCLUDE_RTM_OPT
3819   RTMLockingCounters::init();
3820 #endif
3821 
3822   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3823     call_postVMInitHook(THREAD);
3824     // The Java side of PostVMInitHook.run must deal with all
3825     // exceptions and provide means of diagnosis.
3826     if (HAS_PENDING_EXCEPTION) {
3827       CLEAR_PENDING_EXCEPTION;
3828     }
3829   }
3830 
3831   {
3832     MutexLocker ml(PeriodicTask_lock);
3833     // Make sure the WatcherThread can be started by WatcherThread::start()
3834     // or by dynamic enrollment.
3835     WatcherThread::make_startable();
3836     // Start up the WatcherThread if there are any periodic tasks
3837     // NOTE:  All PeriodicTasks should be registered by now. If they
3838     //   aren't, late joiners might appear to start slowly (we might
3839     //   take a while to process their first tick).
3840     if (PeriodicTask::num_tasks() &gt; 0) {
3841       WatcherThread::start();
3842     }
3843   }
3844 
3845   CodeCacheExtensions::complete_step(CodeCacheExtensionsSteps::CreateVM);
3846 
3847   create_vm_timer.end();
3848 #ifdef ASSERT
3849   _vm_complete = true;
3850 #endif
3851   return JNI_OK;
3852 }
3853 
3854 // type for the Agent_OnLoad and JVM_OnLoad entry points
3855 extern "C" {
3856   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3857 }
3858 // Find a command line agent library and return its entry point for
3859 //         -agentlib:  -agentpath:   -Xrun
3860 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3861 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3862                                     const char *on_load_symbols[],
3863                                     size_t num_symbol_entries) {
3864   OnLoadEntry_t on_load_entry = NULL;
3865   void *library = NULL;
3866 
3867   if (!agent-&gt;valid()) {
3868     char buffer[JVM_MAXPATHLEN];
3869     char ebuf[1024] = "";
3870     const char *name = agent-&gt;name();
3871     const char *msg = "Could not find agent library ";
3872 
3873     // First check to see if agent is statically linked into executable
3874     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3875       library = agent-&gt;os_lib();
3876     } else if (agent-&gt;is_absolute_path()) {
3877       library = os::dll_load(name, ebuf, sizeof ebuf);
3878       if (library == NULL) {
3879         const char *sub_msg = " in absolute path, with error: ";
3880         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3881         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3882         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3883         // If we can't find the agent, exit.
3884         vm_exit_during_initialization(buf, NULL);
3885         FREE_C_HEAP_ARRAY(char, buf);
3886       }
3887     } else {
3888       // Try to load the agent from the standard dll directory
3889       if (os::dll_build_name(buffer, sizeof(buffer), Arguments::get_dll_dir(),
3890                              name)) {
3891         library = os::dll_load(buffer, ebuf, sizeof ebuf);
3892       }
3893       if (library == NULL) { // Try the local directory
3894         char ns[1] = {0};
3895         if (os::dll_build_name(buffer, sizeof(buffer), ns, name)) {
3896           library = os::dll_load(buffer, ebuf, sizeof ebuf);
3897         }
3898         if (library == NULL) {
3899           const char *sub_msg = " on the library path, with error: ";
3900           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3901           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3902           jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3903           // If we can't find the agent, exit.
3904           vm_exit_during_initialization(buf, NULL);
3905           FREE_C_HEAP_ARRAY(char, buf);
3906         }
3907       }
3908     }
3909     agent-&gt;set_os_lib(library);
3910     agent-&gt;set_valid();
3911   }
3912 
3913   // Find the OnLoad function.
3914   on_load_entry =
3915     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
3916                                                           false,
3917                                                           on_load_symbols,
3918                                                           num_symbol_entries));
3919   return on_load_entry;
3920 }
3921 
3922 // Find the JVM_OnLoad entry point
3923 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
3924   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
3925   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3926 }
3927 
3928 // Find the Agent_OnLoad entry point
3929 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
3930   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
3931   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3932 }
3933 
3934 // For backwards compatibility with -Xrun
3935 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
3936 // treated like -agentpath:
3937 // Must be called before agent libraries are created
3938 void Threads::convert_vm_init_libraries_to_agents() {
3939   AgentLibrary* agent;
3940   AgentLibrary* next;
3941 
3942   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
3943     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
3944     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
3945 
3946     // If there is an JVM_OnLoad function it will get called later,
3947     // otherwise see if there is an Agent_OnLoad
3948     if (on_load_entry == NULL) {
3949       on_load_entry = lookup_agent_on_load(agent);
3950       if (on_load_entry != NULL) {
3951         // switch it to the agent list -- so that Agent_OnLoad will be called,
3952         // JVM_OnLoad won't be attempted and Agent_OnUnload will
3953         Arguments::convert_library_to_agent(agent);
3954       } else {
3955         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
3956       }
3957     }
3958   }
3959 }
3960 
3961 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
3962 // Invokes Agent_OnLoad
3963 // Called very early -- before JavaThreads exist
3964 void Threads::create_vm_init_agents() {
3965   extern struct JavaVM_ main_vm;
3966   AgentLibrary* agent;
3967 
3968   JvmtiExport::enter_onload_phase();
3969 
3970   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3971     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
3972 
3973     if (on_load_entry != NULL) {
3974       // Invoke the Agent_OnLoad function
3975       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
3976       if (err != JNI_OK) {
3977         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
3978       }
3979     } else {
3980       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
3981     }
3982   }
3983   JvmtiExport::enter_primordial_phase();
3984 }
3985 
3986 extern "C" {
3987   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
3988 }
3989 
3990 void Threads::shutdown_vm_agents() {
3991   // Send any Agent_OnUnload notifications
3992   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
3993   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
3994   extern struct JavaVM_ main_vm;
3995   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3996 
3997     // Find the Agent_OnUnload function.
3998     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
3999                                                    os::find_agent_function(agent,
4000                                                    false,
4001                                                    on_unload_symbols,
4002                                                    num_symbol_entries));
4003 
4004     // Invoke the Agent_OnUnload function
4005     if (unload_entry != NULL) {
4006       JavaThread* thread = JavaThread::current();
4007       ThreadToNativeFromVM ttn(thread);
4008       HandleMark hm(thread);
4009       (*unload_entry)(&amp;main_vm);
4010     }
4011   }
4012 }
4013 
4014 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4015 // Invokes JVM_OnLoad
4016 void Threads::create_vm_init_libraries() {
4017   extern struct JavaVM_ main_vm;
4018   AgentLibrary* agent;
4019 
4020   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4021     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4022 
4023     if (on_load_entry != NULL) {
4024       // Invoke the JVM_OnLoad function
4025       JavaThread* thread = JavaThread::current();
4026       ThreadToNativeFromVM ttn(thread);
4027       HandleMark hm(thread);
4028       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4029       if (err != JNI_OK) {
4030         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4031       }
4032     } else {
4033       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4034     }
4035   }
4036 }
4037 
4038 JavaThread* Threads::find_java_thread_from_java_tid(jlong java_tid) {
4039   assert(Threads_lock-&gt;owned_by_self(), "Must hold Threads_lock");
4040 
4041   JavaThread* java_thread = NULL;
4042   // Sequential search for now.  Need to do better optimization later.
4043   for (JavaThread* thread = Threads::first(); thread != NULL; thread = thread-&gt;next()) {
4044     oop tobj = thread-&gt;threadObj();
4045     if (!thread-&gt;is_exiting() &amp;&amp;
4046         tobj != NULL &amp;&amp;
4047         java_tid == java_lang_Thread::thread_id(tobj)) {
4048       java_thread = thread;
4049       break;
4050     }
4051   }
4052   return java_thread;
4053 }
4054 
4055 
4056 // Last thread running calls java.lang.Shutdown.shutdown()
4057 void JavaThread::invoke_shutdown_hooks() {
4058   HandleMark hm(this);
4059 
4060   // We could get here with a pending exception, if so clear it now.
4061   if (this-&gt;has_pending_exception()) {
4062     this-&gt;clear_pending_exception();
4063   }
4064 
4065   EXCEPTION_MARK;
4066   Klass* k =
4067     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4068                                       THREAD);
4069   if (k != NULL) {
4070     // SystemDictionary::resolve_or_null will return null if there was
4071     // an exception.  If we cannot load the Shutdown class, just don't
4072     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4073     // and finalizers (if runFinalizersOnExit is set) won't be run.
4074     // Note that if a shutdown hook was registered or runFinalizersOnExit
4075     // was called, the Shutdown class would have already been loaded
4076     // (Runtime.addShutdownHook and runFinalizersOnExit will load it).
4077     instanceKlassHandle shutdown_klass (THREAD, k);
4078     JavaValue result(T_VOID);
4079     JavaCalls::call_static(&amp;result,
4080                            shutdown_klass,
4081                            vmSymbols::shutdown_method_name(),
4082                            vmSymbols::void_method_signature(),
4083                            THREAD);
4084   }
4085   CLEAR_PENDING_EXCEPTION;
4086 }
4087 
4088 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4089 // the program falls off the end of main(). Another VM exit path is through
4090 // vm_exit() when the program calls System.exit() to return a value or when
4091 // there is a serious error in VM. The two shutdown paths are not exactly
4092 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4093 // and VM_Exit op at VM level.
4094 //
4095 // Shutdown sequence:
4096 //   + Shutdown native memory tracking if it is on
4097 //   + Wait until we are the last non-daemon thread to execute
4098 //     &lt;-- every thing is still working at this moment --&gt;
4099 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4100 //        shutdown hooks, run finalizers if finalization-on-exit
4101 //   + Call before_exit(), prepare for VM exit
4102 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4103 //        currently the only user of this mechanism is File.deleteOnExit())
4104 //      &gt; stop flat profiler, StatSampler, watcher thread, CMS threads,
4105 //        post thread end and vm death events to JVMTI,
4106 //        stop signal thread
4107 //   + Call JavaThread::exit(), it will:
4108 //      &gt; release JNI handle blocks, remove stack guard pages
4109 //      &gt; remove this thread from Threads list
4110 //     &lt;-- no more Java code from this thread after this point --&gt;
4111 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4112 //     the compiler threads at safepoint
4113 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4114 //   + Disable tracing at JNI/JVM barriers
4115 //   + Set _vm_exited flag for threads that are still running native code
4116 //   + Delete this thread
4117 //   + Call exit_globals()
4118 //      &gt; deletes tty
4119 //      &gt; deletes PerfMemory resources
4120 //   + Return to caller
4121 
4122 bool Threads::destroy_vm() {
4123   JavaThread* thread = JavaThread::current();
4124 
4125 #ifdef ASSERT
4126   _vm_complete = false;
4127 #endif
4128   // Wait until we are the last non-daemon thread to execute
4129   { MutexLocker nu(Threads_lock);
4130     while (Threads::number_of_non_daemon_threads() &gt; 1)
4131       // This wait should make safepoint checks, wait without a timeout,
4132       // and wait as a suspend-equivalent condition.
4133       //
4134       // Note: If the FlatProfiler is running and this thread is waiting
4135       // for another non-daemon thread to finish, then the FlatProfiler
4136       // is waiting for the external suspend request on this thread to
4137       // complete. wait_for_ext_suspend_completion() will eventually
4138       // timeout, but that takes time. Making this wait a suspend-
4139       // equivalent condition solves that timeout problem.
4140       //
4141       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4142                          Mutex::_as_suspend_equivalent_flag);
4143   }
4144 
4145   // Hang forever on exit if we are reporting an error.
4146   if (ShowMessageBoxOnError &amp;&amp; is_error_reported()) {
4147     os::infinite_sleep();
4148   }
4149   os::wait_for_keypress_at_exit();
4150 
4151   // run Java level shutdown hooks
4152   thread-&gt;invoke_shutdown_hooks();
4153 
4154   before_exit(thread);
4155 
4156   thread-&gt;exit(true);
4157 
4158   // Stop VM thread.
4159   {
4160     // 4945125 The vm thread comes to a safepoint during exit.
4161     // GC vm_operations can get caught at the safepoint, and the
4162     // heap is unparseable if they are caught. Grab the Heap_lock
4163     // to prevent this. The GC vm_operations will not be able to
4164     // queue until after the vm thread is dead. After this point,
4165     // we'll never emerge out of the safepoint before the VM exits.
4166 
4167     MutexLocker ml(Heap_lock);
4168 
4169     VMThread::wait_for_vm_thread_exit();
4170     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4171     VMThread::destroy();
4172   }
4173 
4174   // clean up ideal graph printers
4175 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4176   IdealGraphPrinter::clean_up();
4177 #endif
4178 
4179   // Now, all Java threads are gone except daemon threads. Daemon threads
4180   // running Java code or in VM are stopped by the Safepoint. However,
4181   // daemon threads executing native code are still running.  But they
4182   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4183   // simply kill or suspend them, as it is inherently deadlock-prone.
4184 
4185   VM_Exit::set_vm_exited();
4186 
4187   notify_vm_shutdown();
4188 
4189   delete thread;
4190 
4191 #if INCLUDE_JVMCI
4192   if (JVMCICounterSize &gt; 0) {
4193     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4194   }
4195 #endif
4196 
4197   // exit_globals() will delete tty
4198   exit_globals();
4199 
4200   LogConfiguration::finalize();
4201 
4202   return true;
4203 }
4204 
4205 
4206 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4207   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4208   return is_supported_jni_version(version);
4209 }
4210 
4211 
4212 jboolean Threads::is_supported_jni_version(jint version) {
4213   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4214   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4215   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4216   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4217   if (version == JNI_VERSION_9) return JNI_TRUE;
4218   return JNI_FALSE;
4219 }
4220 
4221 
4222 void Threads::add(JavaThread* p, bool force_daemon) {
4223   // The threads lock must be owned at this point
4224   assert_locked_or_safepoint(Threads_lock);
4225 
4226   // See the comment for this method in thread.hpp for its purpose and
4227   // why it is called here.
4228   p-&gt;initialize_queues();
4229   p-&gt;set_next(_thread_list);
4230   _thread_list = p;
4231   _number_of_threads++;
4232   oop threadObj = p-&gt;threadObj();
4233   bool daemon = true;
4234   // Bootstrapping problem: threadObj can be null for initial
4235   // JavaThread (or for threads attached via JNI)
4236   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4237     _number_of_non_daemon_threads++;
4238     daemon = false;
4239   }
4240 
4241   ThreadService::add_thread(p, daemon);
4242 
4243   // Possible GC point.
4244   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4245 }
4246 
4247 void Threads::remove(JavaThread* p) {
4248   // Extra scope needed for Thread_lock, so we can check
4249   // that we do not remove thread without safepoint code notice
4250   { MutexLocker ml(Threads_lock);
4251 
4252     assert(includes(p), "p must be present");
4253 
4254     JavaThread* current = _thread_list;
4255     JavaThread* prev    = NULL;
4256 
4257     while (current != p) {
4258       prev    = current;
4259       current = current-&gt;next();
4260     }
4261 
4262     if (prev) {
4263       prev-&gt;set_next(current-&gt;next());
4264     } else {
4265       _thread_list = p-&gt;next();
4266     }
4267     _number_of_threads--;
4268     oop threadObj = p-&gt;threadObj();
4269     bool daemon = true;
4270     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4271       _number_of_non_daemon_threads--;
4272       daemon = false;
4273 
4274       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4275       // on destroy_vm will wake up.
4276       if (number_of_non_daemon_threads() == 1) {
4277         Threads_lock-&gt;notify_all();
4278       }
4279     }
4280     ThreadService::remove_thread(p, daemon);
4281 
4282     // Make sure that safepoint code disregard this thread. This is needed since
4283     // the thread might mess around with locks after this point. This can cause it
4284     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4285     // of this thread since it is removed from the queue.
4286     p-&gt;set_terminated_value();
4287   } // unlock Threads_lock
4288 
4289   // Since Events::log uses a lock, we grab it outside the Threads_lock
4290   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4291 }
4292 
4293 // Threads_lock must be held when this is called (or must be called during a safepoint)
4294 bool Threads::includes(JavaThread* p) {
4295   assert(Threads_lock-&gt;is_locked(), "sanity check");
4296   ALL_JAVA_THREADS(q) {
4297     if (q == p) {
4298       return true;
4299     }
4300   }
4301   return false;
4302 }
4303 
4304 // Operations on the Threads list for GC.  These are not explicitly locked,
4305 // but the garbage collector must provide a safe context for them to run.
4306 // In particular, these things should never be called when the Threads_lock
4307 // is held by some other thread. (Note: the Safepoint abstraction also
4308 // uses the Threads_lock to guarantee this property. It also makes sure that
4309 // all threads gets blocked when exiting or starting).
4310 
4311 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4312   ALL_JAVA_THREADS(p) {
4313     p-&gt;oops_do(f, cf);
4314   }
4315   VMThread::vm_thread()-&gt;oops_do(f, cf);
4316 }
4317 
4318 void Threads::change_thread_claim_parity() {
4319   // Set the new claim parity.
4320   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4321          "Not in range.");
4322   _thread_claim_parity++;
4323   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4324   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4325          "Not in range.");
4326 }
4327 
4328 #ifdef ASSERT
4329 void Threads::assert_all_threads_claimed() {
4330   ALL_JAVA_THREADS(p) {
4331     const int thread_parity = p-&gt;oops_do_parity();
4332     assert((thread_parity == _thread_claim_parity),
4333            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4334   }
4335 }
4336 #endif // ASSERT
4337 
4338 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4339   int cp = Threads::thread_claim_parity();
4340   ALL_JAVA_THREADS(p) {
4341     if (p-&gt;claim_oops_do(is_par, cp)) {
4342       p-&gt;oops_do(f, cf);
4343     }
4344   }
4345   VMThread* vmt = VMThread::vm_thread();
4346   if (vmt-&gt;claim_oops_do(is_par, cp)) {
4347     vmt-&gt;oops_do(f, cf);
4348   }
4349 }
4350 
4351 #if INCLUDE_ALL_GCS
4352 // Used by ParallelScavenge
4353 void Threads::create_thread_roots_tasks(GCTaskQueue* q) {
4354   ALL_JAVA_THREADS(p) {
4355     q-&gt;enqueue(new ThreadRootsTask(p));
4356   }
4357   q-&gt;enqueue(new ThreadRootsTask(VMThread::vm_thread()));
4358 }
4359 
4360 // Used by Parallel Old
4361 void Threads::create_thread_roots_marking_tasks(GCTaskQueue* q) {
4362   ALL_JAVA_THREADS(p) {
4363     q-&gt;enqueue(new ThreadRootsMarkingTask(p));
4364   }
4365   q-&gt;enqueue(new ThreadRootsMarkingTask(VMThread::vm_thread()));
4366 }
4367 #endif // INCLUDE_ALL_GCS
4368 
4369 void Threads::nmethods_do(CodeBlobClosure* cf) {
4370   ALL_JAVA_THREADS(p) {
4371     // This is used by the code cache sweeper to mark nmethods that are active
4372     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4373     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4374     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4375       p-&gt;nmethods_do(cf);
4376     }
4377   }
4378 }
4379 
4380 void Threads::metadata_do(void f(Metadata*)) {
4381   ALL_JAVA_THREADS(p) {
4382     p-&gt;metadata_do(f);
4383   }
4384 }
4385 
4386 class ThreadHandlesClosure : public ThreadClosure {
4387   void (*_f)(Metadata*);
4388  public:
4389   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4390   virtual void do_thread(Thread* thread) {
4391     thread-&gt;metadata_handles_do(_f);
4392   }
4393 };
4394 
4395 void Threads::metadata_handles_do(void f(Metadata*)) {
4396   // Only walk the Handles in Thread.
4397   ThreadHandlesClosure handles_closure(f);
4398   threads_do(&amp;handles_closure);
4399 }
4400 
4401 void Threads::deoptimized_wrt_marked_nmethods() {
4402   ALL_JAVA_THREADS(p) {
4403     p-&gt;deoptimized_wrt_marked_nmethods();
4404   }
4405 }
4406 
4407 
4408 // Get count Java threads that are waiting to enter the specified monitor.
4409 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(int count,
4410                                                          address monitor,
4411                                                          bool doLock) {
4412   assert(doLock || SafepointSynchronize::is_at_safepoint(),
4413          "must grab Threads_lock or be at safepoint");
4414   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4415 
4416   int i = 0;
4417   {
4418     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4419     ALL_JAVA_THREADS(p) {
4420       if (!p-&gt;can_call_java()) continue;
4421 
4422       address pending = (address)p-&gt;current_pending_monitor();
4423       if (pending == monitor) {             // found a match
4424         if (i &lt; count) result-&gt;append(p);   // save the first count matches
4425         i++;
4426       }
4427     }
4428   }
4429   return result;
4430 }
4431 
4432 
4433 JavaThread *Threads::owning_thread_from_monitor_owner(address owner,
4434                                                       bool doLock) {
4435   assert(doLock ||
4436          Threads_lock-&gt;owned_by_self() ||
4437          SafepointSynchronize::is_at_safepoint(),
4438          "must grab Threads_lock or be at safepoint");
4439 
4440   // NULL owner means not locked so we can skip the search
4441   if (owner == NULL) return NULL;
4442 
4443   {
4444     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4445     ALL_JAVA_THREADS(p) {
4446       // first, see if owner is the address of a Java thread
4447       if (owner == (address)p) return p;
4448     }
4449   }
4450   // Cannot assert on lack of success here since this function may be
4451   // used by code that is trying to report useful problem information
4452   // like deadlock detection.
4453   if (UseHeavyMonitors) return NULL;
4454 
4455   // If we didn't find a matching Java thread and we didn't force use of
4456   // heavyweight monitors, then the owner is the stack address of the
4457   // Lock Word in the owning Java thread's stack.
4458   //
4459   JavaThread* the_owner = NULL;
4460   {
4461     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4462     ALL_JAVA_THREADS(q) {
4463       if (q-&gt;is_lock_owned(owner)) {
4464         the_owner = q;
4465         break;
4466       }
4467     }
4468   }
4469   // cannot assert on lack of success here; see above comment
4470   return the_owner;
4471 }
4472 
4473 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4474 void Threads::print_on(outputStream* st, bool print_stacks,
4475                        bool internal_format, bool print_concurrent_locks) {
4476   char buf[32];
4477   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4478 
4479   st-&gt;print_cr("Full thread dump %s (%s %s):",
4480                Abstract_VM_Version::vm_name(),
4481                Abstract_VM_Version::vm_release(),
4482                Abstract_VM_Version::vm_info_string());
4483   st-&gt;cr();
4484 
4485 #if INCLUDE_SERVICES
4486   // Dump concurrent locks
4487   ConcurrentLocksDump concurrent_locks;
4488   if (print_concurrent_locks) {
4489     concurrent_locks.dump_at_safepoint();
4490   }
4491 #endif // INCLUDE_SERVICES
4492 
4493   ALL_JAVA_THREADS(p) {
4494     ResourceMark rm;
4495     p-&gt;print_on(st);
4496     if (print_stacks) {
4497       if (internal_format) {
4498         p-&gt;trace_stack();
4499       } else {
4500         p-&gt;print_stack_on(st);
4501       }
4502     }
4503     st-&gt;cr();
4504 #if INCLUDE_SERVICES
4505     if (print_concurrent_locks) {
4506       concurrent_locks.print_locks_on(p, st);
4507     }
4508 #endif // INCLUDE_SERVICES
4509   }
4510 
4511   VMThread::vm_thread()-&gt;print_on(st);
4512   st-&gt;cr();
4513   Universe::heap()-&gt;print_gc_threads_on(st);
4514   WatcherThread* wt = WatcherThread::watcher_thread();
4515   if (wt != NULL) {
4516     wt-&gt;print_on(st);
4517     st-&gt;cr();
4518   }
4519   st-&gt;flush();
4520 }
4521 
4522 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4523                              int buflen, bool* found_current) {
4524   if (this_thread != NULL) {
4525     bool is_current = (current == this_thread);
4526     *found_current = *found_current || is_current;
4527     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4528 
4529     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4530     st-&gt;print(" ");
4531     this_thread-&gt;print_on_error(st, buf, buflen);
4532     st-&gt;cr();
4533   }
4534 }
4535 
4536 class PrintOnErrorClosure : public ThreadClosure {
4537   outputStream* _st;
4538   Thread* _current;
4539   char* _buf;
4540   int _buflen;
4541   bool* _found_current;
4542  public:
4543   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4544                       int buflen, bool* found_current) :
4545    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4546 
4547   virtual void do_thread(Thread* thread) {
4548     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4549   }
4550 };
4551 
4552 // Threads::print_on_error() is called by fatal error handler. It's possible
4553 // that VM is not at safepoint and/or current thread is inside signal handler.
4554 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4555 // memory (even in resource area), it might deadlock the error handler.
4556 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4557                              int buflen) {
4558   bool found_current = false;
4559   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4560   ALL_JAVA_THREADS(thread) {
4561     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4562   }
4563   st-&gt;cr();
4564 
4565   st-&gt;print_cr("Other Threads:");
4566   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4567   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4568 
4569   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4570   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4571 
4572   if (!found_current) {
4573     st-&gt;cr();
4574     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4575     current-&gt;print_on_error(st, buf, buflen);
4576     st-&gt;cr();
4577   }
4578   st-&gt;cr();
4579   st-&gt;print_cr("Threads with active compile tasks:");
4580   print_threads_compiling(st, buf, buflen);
4581 }
4582 
4583 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4584   ALL_JAVA_THREADS(thread) {
4585     if (thread-&gt;is_Compiler_thread()) {
4586       CompilerThread* ct = (CompilerThread*) thread;
4587       if (ct-&gt;task() != NULL) {
4588         thread-&gt;print_name_on_error(st, buf, buflen);
4589         ct-&gt;task()-&gt;print(st, NULL, true, true);
4590       }
4591     }
4592   }
4593 }
4594 
4595 
4596 // Internal SpinLock and Mutex
4597 // Based on ParkEvent
4598 
4599 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4600 //
4601 // We employ SpinLocks _only for low-contention, fixed-length
4602 // short-duration critical sections where we're concerned
4603 // about native mutex_t or HotSpot Mutex:: latency.
4604 // The mux construct provides a spin-then-block mutual exclusion
4605 // mechanism.
4606 //
4607 // Testing has shown that contention on the ListLock guarding gFreeList
4608 // is common.  If we implement ListLock as a simple SpinLock it's common
4609 // for the JVM to devolve to yielding with little progress.  This is true
4610 // despite the fact that the critical sections protected by ListLock are
4611 // extremely short.
4612 //
4613 // TODO-FIXME: ListLock should be of type SpinLock.
4614 // We should make this a 1st-class type, integrated into the lock
4615 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4616 // should have sufficient padding to avoid false-sharing and excessive
4617 // cache-coherency traffic.
4618 
4619 
4620 typedef volatile int SpinLockT;
4621 
4622 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4623   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4624     return;   // normal fast-path return
4625   }
4626 
4627   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4628   TEVENT(SpinAcquire - ctx);
4629   int ctr = 0;
4630   int Yields = 0;
4631   for (;;) {
4632     while (*adr != 0) {
4633       ++ctr;
4634       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4635         if (Yields &gt; 5) {
4636           os::naked_short_sleep(1);
4637         } else {
4638           os::naked_yield();
4639           ++Yields;
4640         }
4641       } else {
4642         SpinPause();
4643       }
4644     }
4645     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4646   }
4647 }
4648 
4649 void Thread::SpinRelease(volatile int * adr) {
4650   assert(*adr != 0, "invariant");
4651   OrderAccess::fence();      // guarantee at least release consistency.
4652   // Roach-motel semantics.
4653   // It's safe if subsequent LDs and STs float "up" into the critical section,
4654   // but prior LDs and STs within the critical section can't be allowed
4655   // to reorder or float past the ST that releases the lock.
4656   // Loads and stores in the critical section - which appear in program
4657   // order before the store that releases the lock - must also appear
4658   // before the store that releases the lock in memory visibility order.
4659   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4660   // the ST of 0 into the lock-word which releases the lock, so fence
4661   // more than covers this on all platforms.
4662   *adr = 0;
4663 }
4664 
4665 // muxAcquire and muxRelease:
4666 //
4667 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4668 //    The LSB of the word is set IFF the lock is held.
4669 //    The remainder of the word points to the head of a singly-linked list
4670 //    of threads blocked on the lock.
4671 //
4672 // *  The current implementation of muxAcquire-muxRelease uses its own
4673 //    dedicated Thread._MuxEvent instance.  If we're interested in
4674 //    minimizing the peak number of extant ParkEvent instances then
4675 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4676 //    as certain invariants were satisfied.  Specifically, care would need
4677 //    to be taken with regards to consuming unpark() "permits".
4678 //    A safe rule of thumb is that a thread would never call muxAcquire()
4679 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4680 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4681 //    consume an unpark() permit intended for monitorenter, for instance.
4682 //    One way around this would be to widen the restricted-range semaphore
4683 //    implemented in park().  Another alternative would be to provide
4684 //    multiple instances of the PlatformEvent() for each thread.  One
4685 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4686 //
4687 // *  Usage:
4688 //    -- Only as leaf locks
4689 //    -- for short-term locking only as muxAcquire does not perform
4690 //       thread state transitions.
4691 //
4692 // Alternatives:
4693 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4694 //    but with parking or spin-then-park instead of pure spinning.
4695 // *  Use Taura-Oyama-Yonenzawa locks.
4696 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4697 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4698 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4699 //    acquiring threads use timers (ParkTimed) to detect and recover from
4700 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4701 //    boundaries by using placement-new.
4702 // *  Augment MCS with advisory back-link fields maintained with CAS().
4703 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4704 //    The validity of the backlinks must be ratified before we trust the value.
4705 //    If the backlinks are invalid the exiting thread must back-track through the
4706 //    the forward links, which are always trustworthy.
4707 // *  Add a successor indication.  The LockWord is currently encoded as
4708 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4709 //    to provide the usual futile-wakeup optimization.
4710 //    See RTStt for details.
4711 // *  Consider schedctl.sc_nopreempt to cover the critical section.
4712 //
4713 
4714 
4715 typedef volatile intptr_t MutexT;      // Mux Lock-word
4716 enum MuxBits { LOCKBIT = 1 };
4717 
4718 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4719   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4720   if (w == 0) return;
4721   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4722     return;
4723   }
4724 
4725   TEVENT(muxAcquire - Contention);
4726   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4727   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4728   for (;;) {
4729     int its = (os::is_MP() ? 100 : 0) + 1;
4730 
4731     // Optional spin phase: spin-then-park strategy
4732     while (--its &gt;= 0) {
4733       w = *Lock;
4734       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4735         return;
4736       }
4737     }
4738 
4739     Self-&gt;reset();
4740     Self-&gt;OnList = intptr_t(Lock);
4741     // The following fence() isn't _strictly necessary as the subsequent
4742     // CAS() both serializes execution and ratifies the fetched *Lock value.
4743     OrderAccess::fence();
4744     for (;;) {
4745       w = *Lock;
4746       if ((w &amp; LOCKBIT) == 0) {
4747         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4748           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4749           return;
4750         }
4751         continue;      // Interference -- *Lock changed -- Just retry
4752       }
4753       assert(w &amp; LOCKBIT, "invariant");
4754       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4755       if (Atomic::cmpxchg_ptr(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4756     }
4757 
4758     while (Self-&gt;OnList != 0) {
4759       Self-&gt;park();
4760     }
4761   }
4762 }
4763 
4764 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4765   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4766   if (w == 0) return;
4767   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4768     return;
4769   }
4770 
4771   TEVENT(muxAcquire - Contention);
4772   ParkEvent * ReleaseAfter = NULL;
4773   if (ev == NULL) {
4774     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4775   }
4776   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4777   for (;;) {
4778     guarantee(ev-&gt;OnList == 0, "invariant");
4779     int its = (os::is_MP() ? 100 : 0) + 1;
4780 
4781     // Optional spin phase: spin-then-park strategy
4782     while (--its &gt;= 0) {
4783       w = *Lock;
4784       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4785         if (ReleaseAfter != NULL) {
4786           ParkEvent::Release(ReleaseAfter);
4787         }
4788         return;
4789       }
4790     }
4791 
4792     ev-&gt;reset();
4793     ev-&gt;OnList = intptr_t(Lock);
4794     // The following fence() isn't _strictly necessary as the subsequent
4795     // CAS() both serializes execution and ratifies the fetched *Lock value.
4796     OrderAccess::fence();
4797     for (;;) {
4798       w = *Lock;
4799       if ((w &amp; LOCKBIT) == 0) {
4800         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4801           ev-&gt;OnList = 0;
4802           // We call ::Release while holding the outer lock, thus
4803           // artificially lengthening the critical section.
4804           // Consider deferring the ::Release() until the subsequent unlock(),
4805           // after we've dropped the outer lock.
4806           if (ReleaseAfter != NULL) {
4807             ParkEvent::Release(ReleaseAfter);
4808           }
4809           return;
4810         }
4811         continue;      // Interference -- *Lock changed -- Just retry
4812       }
4813       assert(w &amp; LOCKBIT, "invariant");
4814       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4815       if (Atomic::cmpxchg_ptr(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4816     }
4817 
4818     while (ev-&gt;OnList != 0) {
4819       ev-&gt;park();
4820     }
4821   }
4822 }
4823 
4824 // Release() must extract a successor from the list and then wake that thread.
4825 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4826 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4827 // Release() would :
4828 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4829 // (B) Extract a successor from the private list "in-hand"
4830 // (C) attempt to CAS() the residual back into *Lock over null.
4831 //     If there were any newly arrived threads and the CAS() would fail.
4832 //     In that case Release() would detach the RATs, re-merge the list in-hand
4833 //     with the RATs and repeat as needed.  Alternately, Release() might
4834 //     detach and extract a successor, but then pass the residual list to the wakee.
4835 //     The wakee would be responsible for reattaching and remerging before it
4836 //     competed for the lock.
4837 //
4838 // Both "pop" and DMR are immune from ABA corruption -- there can be
4839 // multiple concurrent pushers, but only one popper or detacher.
4840 // This implementation pops from the head of the list.  This is unfair,
4841 // but tends to provide excellent throughput as hot threads remain hot.
4842 // (We wake recently run threads first).
4843 //
4844 // All paths through muxRelease() will execute a CAS.
4845 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4846 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4847 // executed within the critical section are complete and globally visible before the
4848 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4849 void Thread::muxRelease(volatile intptr_t * Lock)  {
4850   for (;;) {
4851     const intptr_t w = Atomic::cmpxchg_ptr(0, Lock, LOCKBIT);
4852     assert(w &amp; LOCKBIT, "invariant");
4853     if (w == LOCKBIT) return;
4854     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4855     assert(List != NULL, "invariant");
4856     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4857     ParkEvent * const nxt = List-&gt;ListNext;
4858     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4859 
4860     // The following CAS() releases the lock and pops the head element.
4861     // The CAS() also ratifies the previously fetched lock-word value.
4862     if (Atomic::cmpxchg_ptr (intptr_t(nxt), Lock, w) != w) {
4863       continue;
4864     }
4865     List-&gt;OnList = 0;
4866     OrderAccess::fence();
4867     List-&gt;unpark();
4868     return;
4869   }
4870 }
4871 
4872 
4873 void Threads::verify() {
4874   ALL_JAVA_THREADS(p) {
4875     p-&gt;verify();
4876   }
4877   VMThread* thread = VMThread::vm_thread();
4878   if (thread != NULL) thread-&gt;verify();
4879 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="4" type="hidden" /></form></body></html>
