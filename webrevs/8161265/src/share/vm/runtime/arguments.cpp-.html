<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/share/vm/runtime/arguments.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaAssertions.hpp"
  28 #include "classfile/stringTable.hpp"
  29 #include "classfile/symbolTable.hpp"
  30 #include "code/codeCacheExtensions.hpp"
  31 #include "gc/shared/cardTableRS.hpp"
  32 #include "gc/shared/genCollectedHeap.hpp"
  33 #include "gc/shared/referenceProcessor.hpp"
  34 #include "gc/shared/taskqueue.hpp"
  35 #include "logging/log.hpp"
  36 #include "logging/logTag.hpp"
  37 #include "logging/logConfiguration.hpp"
  38 #include "memory/allocation.inline.hpp"
  39 #include "memory/universe.inline.hpp"
  40 #include "oops/oop.inline.hpp"
  41 #include "prims/jvmtiExport.hpp"
  42 #include "runtime/arguments.hpp"
  43 #include "runtime/arguments_ext.hpp"
  44 #include "runtime/commandLineFlagConstraintList.hpp"
  45 #include "runtime/commandLineFlagWriteableList.hpp"
  46 #include "runtime/commandLineFlagRangeList.hpp"
  47 #include "runtime/globals.hpp"
  48 #include "runtime/globals_extension.hpp"
  49 #include "runtime/java.hpp"
  50 #include "runtime/os.hpp"
  51 #include "runtime/vm_version.hpp"
  52 #include "services/management.hpp"
  53 #include "services/memTracker.hpp"
  54 #include "utilities/defaultStream.hpp"
  55 #include "utilities/macros.hpp"
  56 #include "utilities/stringUtils.hpp"
  57 #if INCLUDE_JVMCI
  58 #include "jvmci/jvmciRuntime.hpp"
  59 #endif
  60 #if INCLUDE_ALL_GCS
  61 #include "gc/cms/compactibleFreeListSpace.hpp"
  62 #include "gc/g1/g1CollectedHeap.inline.hpp"
  63 #include "gc/parallel/parallelScavengeHeap.hpp"
  64 #endif // INCLUDE_ALL_GCS
  65 
  66 // Note: This is a special bug reporting site for the JVM
  67 #define DEFAULT_VENDOR_URL_BUG "http://bugreport.java.com/bugreport/crash.jsp"
  68 #define DEFAULT_JAVA_LAUNCHER  "generic"
  69 
  70 char*  Arguments::_jvm_flags_file               = NULL;
  71 char** Arguments::_jvm_flags_array              = NULL;
  72 int    Arguments::_num_jvm_flags                = 0;
  73 char** Arguments::_jvm_args_array               = NULL;
  74 int    Arguments::_num_jvm_args                 = 0;
  75 char*  Arguments::_java_command                 = NULL;
  76 SystemProperty* Arguments::_system_properties   = NULL;
  77 const char*  Arguments::_gc_log_filename        = NULL;
  78 bool   Arguments::_has_profile                  = false;
  79 size_t Arguments::_conservative_max_heap_alignment = 0;
  80 size_t Arguments::_min_heap_size                = 0;
  81 Arguments::Mode Arguments::_mode                = _mixed;
  82 bool   Arguments::_java_compiler                = false;
  83 bool   Arguments::_xdebug_mode                  = false;
  84 const char*  Arguments::_java_vendor_url_bug    = DEFAULT_VENDOR_URL_BUG;
  85 const char*  Arguments::_sun_java_launcher      = DEFAULT_JAVA_LAUNCHER;
  86 int    Arguments::_sun_java_launcher_pid        = -1;
  87 bool   Arguments::_sun_java_launcher_is_altjvm  = false;
  88 int    Arguments::_bootclassloader_append_index = -1;
  89 
  90 // These parameters are reset in method parse_vm_init_args()
  91 bool   Arguments::_AlwaysCompileLoopMethods     = AlwaysCompileLoopMethods;
  92 bool   Arguments::_UseOnStackReplacement        = UseOnStackReplacement;
  93 bool   Arguments::_BackgroundCompilation        = BackgroundCompilation;
  94 bool   Arguments::_ClipInlining                 = ClipInlining;
  95 intx   Arguments::_Tier3InvokeNotifyFreqLog     = Tier3InvokeNotifyFreqLog;
  96 intx   Arguments::_Tier4InvocationThreshold     = Tier4InvocationThreshold;
  97 
  98 char*  Arguments::SharedArchivePath             = NULL;
  99 
 100 AgentLibraryList Arguments::_libraryList;
 101 AgentLibraryList Arguments::_agentList;
 102 
 103 abort_hook_t     Arguments::_abort_hook         = NULL;
 104 exit_hook_t      Arguments::_exit_hook          = NULL;
 105 vfprintf_hook_t  Arguments::_vfprintf_hook      = NULL;
 106 
 107 
 108 SystemProperty *Arguments::_sun_boot_library_path = NULL;
 109 SystemProperty *Arguments::_java_library_path = NULL;
 110 SystemProperty *Arguments::_java_home = NULL;
 111 SystemProperty *Arguments::_java_class_path = NULL;
 112 SystemProperty *Arguments::_jdk_boot_class_path_append = NULL;
 113 
 114 GrowableArray&lt;ModuleXPatchPath*&gt; *Arguments::_xpatchprefix = NULL;
 115 PathString *Arguments::_system_boot_class_path = NULL;
 116 
 117 char* Arguments::_ext_dirs = NULL;
 118 
 119 // Check if head of 'option' matches 'name', and sets 'tail' to the remaining
 120 // part of the option string.
 121 static bool match_option(const JavaVMOption *option, const char* name,
 122                          const char** tail) {
 123   size_t len = strlen(name);
 124   if (strncmp(option-&gt;optionString, name, len) == 0) {
 125     *tail = option-&gt;optionString + len;
 126     return true;
 127   } else {
 128     return false;
 129   }
 130 }
 131 
 132 // Check if 'option' matches 'name'. No "tail" is allowed.
 133 static bool match_option(const JavaVMOption *option, const char* name) {
 134   const char* tail = NULL;
 135   bool result = match_option(option, name, &amp;tail);
 136   if (tail != NULL &amp;&amp; *tail == '\0') {
 137     return result;
 138   } else {
 139     return false;
 140   }
 141 }
 142 
 143 // Return true if any of the strings in null-terminated array 'names' matches.
 144 // If tail_allowed is true, then the tail must begin with a colon; otherwise,
 145 // the option must match exactly.
 146 static bool match_option(const JavaVMOption* option, const char** names, const char** tail,
 147   bool tail_allowed) {
 148   for (/* empty */; *names != NULL; ++names) {
 149     if (match_option(option, *names, tail)) {
 150       if (**tail == '\0' || tail_allowed &amp;&amp; **tail == ':') {
 151         return true;
 152       }
 153     }
 154   }
 155   return false;
 156 }
 157 
 158 static void logOption(const char* opt) {
 159   if (PrintVMOptions) {
 160     jio_fprintf(defaultStream::output_stream(), "VM option '%s'\n", opt);
 161   }
 162 }
 163 
 164 // Process java launcher properties.
 165 void Arguments::process_sun_java_launcher_properties(JavaVMInitArgs* args) {
 166   // See if sun.java.launcher, sun.java.launcher.is_altjvm or
 167   // sun.java.launcher.pid is defined.
 168   // Must do this before setting up other system properties,
 169   // as some of them may depend on launcher type.
 170   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
 171     const JavaVMOption* option = args-&gt;options + index;
 172     const char* tail;
 173 
 174     if (match_option(option, "-Dsun.java.launcher=", &amp;tail)) {
 175       process_java_launcher_argument(tail, option-&gt;extraInfo);
 176       continue;
 177     }
 178     if (match_option(option, "-Dsun.java.launcher.is_altjvm=", &amp;tail)) {
 179       if (strcmp(tail, "true") == 0) {
 180         _sun_java_launcher_is_altjvm = true;
 181       }
 182       continue;
 183     }
 184     if (match_option(option, "-Dsun.java.launcher.pid=", &amp;tail)) {
 185       _sun_java_launcher_pid = atoi(tail);
 186       continue;
 187     }
 188   }
 189 }
 190 
 191 // Initialize system properties key and value.
 192 void Arguments::init_system_properties() {
 193 
 194   // Set up _system_boot_class_path which is not a property but
 195   // relies heavily on argument processing and the jdk.boot.class.path.append
 196   // property. It is used to store the underlying system boot class path.
 197   _system_boot_class_path = new PathString(NULL);
 198 
 199   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.specification.name",
 200                                                                  "Java Virtual Machine Specification",  false));
 201   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.version", VM_Version::vm_release(),  false));
 202   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.name", VM_Version::vm_name(),  false));
 203   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.info", VM_Version::vm_info_string(),  true));
 204   PropertyList_add(&amp;_system_properties, new SystemProperty("jdk.debug", VM_Version::jdk_debug_level(),  false));
 205 
 206   // Following are JVMTI agent writable properties.
 207   // Properties values are set to NULL and they are
 208   // os specific they are initialized in os::init_system_properties_values().
 209   _sun_boot_library_path = new SystemProperty("sun.boot.library.path", NULL,  true);
 210   _java_library_path = new SystemProperty("java.library.path", NULL,  true);
 211   _java_home =  new SystemProperty("java.home", NULL,  true);
 212   _java_class_path = new SystemProperty("java.class.path", "",  true);
 213   // jdk.boot.class.path.append is a non-writeable, internal property.
 214   // It can only be set by either:
 215   //    - -Xbootclasspath/a:
 216   //    - AddToBootstrapClassLoaderSearch during JVMTI OnLoad phase
 217   _jdk_boot_class_path_append = new SystemProperty("jdk.boot.class.path.append", "", false, true);
 218 
 219   // Add to System Property list.
 220   PropertyList_add(&amp;_system_properties, _sun_boot_library_path);
 221   PropertyList_add(&amp;_system_properties, _java_library_path);
 222   PropertyList_add(&amp;_system_properties, _java_home);
 223   PropertyList_add(&amp;_system_properties, _java_class_path);
 224   PropertyList_add(&amp;_system_properties, _jdk_boot_class_path_append);
 225 
 226   // Set OS specific system properties values
 227   os::init_system_properties_values();
 228 }
 229 
 230 // Update/Initialize System properties after JDK version number is known
 231 void Arguments::init_version_specific_system_properties() {
 232   enum { bufsz = 16 };
 233   char buffer[bufsz];
 234   const char* spec_vendor = "Oracle Corporation";
 235   uint32_t spec_version = JDK_Version::current().major_version();
 236 
 237   jio_snprintf(buffer, bufsz, UINT32_FORMAT, spec_version);
 238 
 239   PropertyList_add(&amp;_system_properties,
 240       new SystemProperty("java.vm.specification.vendor",  spec_vendor, false));
 241   PropertyList_add(&amp;_system_properties,
 242       new SystemProperty("java.vm.specification.version", buffer, false));
 243   PropertyList_add(&amp;_system_properties,
 244       new SystemProperty("java.vm.vendor", VM_Version::vm_vendor(),  false));
 245 }
 246 
 247 /*
 248  *  -XX argument processing:
 249  *
 250  *  -XX arguments are defined in several places, such as:
 251  *      globals.hpp, globals_&lt;cpu&gt;.hpp, globals_&lt;os&gt;.hpp, &lt;compiler&gt;_globals.hpp, or &lt;gc&gt;_globals.hpp.
 252  *  -XX arguments are parsed in parse_argument().
 253  *  -XX argument bounds checking is done in check_vm_args_consistency().
 254  *
 255  * Over time -XX arguments may change. There are mechanisms to handle common cases:
 256  *
 257  *      ALIASED: An option that is simply another name for another option. This is often
 258  *               part of the process of deprecating a flag, but not all aliases need
 259  *               to be deprecated.
 260  *
 261  *               Create an alias for an option by adding the old and new option names to the
 262  *               "aliased_jvm_flags" table. Delete the old variable from globals.hpp (etc).
 263  *
 264  *   DEPRECATED: An option that is supported, but a warning is printed to let the user know that
 265  *               support may be removed in the future. Both regular and aliased options may be
 266  *               deprecated.
 267  *
 268  *               Add a deprecation warning for an option (or alias) by adding an entry in the
 269  *               "special_jvm_flags" table and setting the "deprecated_in" field.
 270  *               Often an option "deprecated" in one major release will
 271  *               be made "obsolete" in the next. In this case the entry should also have it's
 272  *               "obsolete_in" field set.
 273  *
 274  *     OBSOLETE: An option that has been removed (and deleted from globals.hpp), but is still accepted
 275  *               on the command line. A warning is printed to let the user know that option might not
 276  *               be accepted in the future.
 277  *
 278  *               Add an obsolete warning for an option by adding an entry in the "special_jvm_flags"
 279  *               table and setting the "obsolete_in" field.
 280  *
 281  *      EXPIRED: A deprecated or obsolete option that has an "accept_until" version less than or equal
 282  *               to the current JDK version. The system will flatly refuse to admit the existence of
 283  *               the flag. This allows a flag to die automatically over JDK releases.
 284  *
 285  *               Note that manual cleanup of expired options should be done at major JDK version upgrades:
 286  *                  - Newly expired options should be removed from the special_jvm_flags and aliased_jvm_flags tables.
 287  *                  - Newly obsolete or expired deprecated options should have their global variable
 288  *                    definitions removed (from globals.hpp, etc) and related implementations removed.
 289  *
 290  * Recommended approach for removing options:
 291  *
 292  * To remove options commonly used by customers (e.g. product, commercial -XX options), use
 293  * the 3-step model adding major release numbers to the deprecate, obsolete and expire columns.
 294  *
 295  * To remove internal options (e.g. diagnostic, experimental, develop options), use
 296  * a 2-step model adding major release numbers to the obsolete and expire columns.
 297  *
 298  * To change the name of an option, use the alias table as well as a 2-step
 299  * model adding major release numbers to the deprecate and expire columns.
 300  * Think twice about aliasing commonly used customer options.
 301  *
 302  * There are times when it is appropriate to leave a future release number as undefined.
 303  *
 304  * Tests:  Aliases should be tested in VMAliasOptions.java.
 305  *         Deprecated options should be tested in VMDeprecatedOptions.java.
 306  */
 307 
 308 // Obsolete or deprecated -XX flag.
 309 typedef struct {
 310   const char* name;
 311   JDK_Version deprecated_in; // When the deprecation warning started (or "undefined").
 312   JDK_Version obsolete_in;   // When the obsolete warning started (or "undefined").
 313   JDK_Version expired_in;    // When the option expires (or "undefined").
 314 } SpecialFlag;
 315 
 316 // The special_jvm_flags table declares options that are being deprecated and/or obsoleted. The
 317 // "deprecated_in" or "obsolete_in" fields may be set to "undefined", but not both.
 318 // When the JDK version reaches 'deprecated_in' limit, the JVM will process this flag on
 319 // the command-line as usual, but will issue a warning.
 320 // When the JDK version reaches 'obsolete_in' limit, the JVM will continue accepting this flag on
 321 // the command-line, while issuing a warning and ignoring the flag value.
 322 // Once the JDK version reaches 'expired_in' limit, the JVM will flatly refuse to admit the
 323 // existence of the flag.
 324 //
 325 // MANUAL CLEANUP ON JDK VERSION UPDATES:
 326 // This table ensures that the handling of options will update automatically when the JDK
 327 // version is incremented, but the source code needs to be cleanup up manually:
 328 // - As "deprecated" options age into "obsolete" or "expired" options, the associated "globals"
 329 //   variable should be removed, as well as users of the variable.
 330 // - As "deprecated" options age into "obsolete" options, move the entry into the
 331 //   "Obsolete Flags" section of the table.
 332 // - All expired options should be removed from the table.
 333 static SpecialFlag const special_jvm_flags[] = {
 334   // -------------- Deprecated Flags --------------
 335   // --- Non-alias flags - sorted by obsolete_in then expired_in:
 336   { "MaxGCMinorPauseMillis",        JDK_Version::jdk(8), JDK_Version::undefined(), JDK_Version::undefined() },
 337   { "UseParNewGC",                  JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 338   { "ConvertSleepToYield",          JDK_Version::jdk(9), JDK_Version::jdk(10),     JDK_Version::jdk(11) },
 339   { "ConvertYieldToSleep",          JDK_Version::jdk(9), JDK_Version::jdk(10),     JDK_Version::jdk(11) },
 340 
 341   // --- Deprecated alias flags (see also aliased_jvm_flags) - sorted by obsolete_in then expired_in:
 342   { "DefaultMaxRAMFraction",        JDK_Version::jdk(8), JDK_Version::undefined(), JDK_Version::undefined() },
 343   { "CreateMinidumpOnCrash",        JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 344   { "CMSMarkStackSizeMax",          JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 345   { "CMSMarkStackSize",             JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 346   { "G1MarkStackSize",              JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 347   { "ParallelMarkingThreads",       JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 348   { "ParallelCMSThreads",           JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 349 
 350   // -------------- Obsolete Flags - sorted by expired_in --------------
 351   { "UseOldInlining",                JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 352   { "SafepointPollOffset",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 353   { "UseBoundThreads",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 354   { "DefaultThreadPriority",         JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 355   { "NoYieldsInMicrolock",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 356   { "BackEdgeThreshold",             JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 357   { "UseNewReflection",              JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 358   { "ReflectionWrapResolutionErrors",JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 359   { "VerifyReflectionBytecodes",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 360   { "AutoShutdownNMT",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 361   { "NmethodSweepFraction",          JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 362   { "NmethodSweepCheckInterval",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 363   { "CodeCacheMinimumFreeSpace",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 364 #ifndef ZERO
 365   { "UseFastAccessorMethods",        JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 366   { "UseFastEmptyMethods",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 367 #endif // ZERO
 368   { "UseCompilerSafepoints",         JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 369   { "AdaptiveSizePausePolicy",       JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 370   { "ParallelGCRetainPLAB",          JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 371   { "ThreadSafetyMargin",            JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 372   { "LazyBootClassLoader",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 373   { "StarvationMonitorInterval",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 374   { "PreInflateSpin",                JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 375   { "JNIDetachReleasesMonitors",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 376   { "UseAltSigs",                    JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 377   { "SegmentedHeapDumpThreshold",    JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 378   { "PrintOopAddress",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 379 
 380 #ifdef TEST_VERIFY_SPECIAL_JVM_FLAGS
 381   { "dep &gt; obs",                    JDK_Version::jdk(9), JDK_Version::jdk(8), JDK_Version::undefined() },
 382   { "dep &gt; exp ",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(8) },
 383   { "obs &gt; exp ",                   JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(8) },
 384   { "not deprecated or obsolete",   JDK_Version::undefined(), JDK_Version::undefined(), JDK_Version::jdk(9) },
 385   { "dup option",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 386   { "dup option",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 387   { "BytecodeVerificationRemote",   JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::undefined() },
 388 #endif
 389 
 390   { NULL, JDK_Version(0), JDK_Version(0) }
 391 };
 392 
 393 // Flags that are aliases for other flags.
 394 typedef struct {
 395   const char* alias_name;
 396   const char* real_name;
 397 } AliasedFlag;
 398 
 399 static AliasedFlag const aliased_jvm_flags[] = {
 400   { "DefaultMaxRAMFraction",    "MaxRAMFraction"    },
 401   { "CMSMarkStackSizeMax",      "MarkStackSizeMax"  },
 402   { "CMSMarkStackSize",         "MarkStackSize"     },
 403   { "G1MarkStackSize",          "MarkStackSize"     },
 404   { "ParallelMarkingThreads",   "ConcGCThreads"     },
 405   { "ParallelCMSThreads",       "ConcGCThreads"     },
 406   { "CreateMinidumpOnCrash",    "CreateCoredumpOnCrash" },
 407   { NULL, NULL}
 408 };
 409 
 410 // NOTE: A compatibility request will be necessary for each alias to be removed.
 411 static AliasedLoggingFlag const aliased_logging_flags[] = {
 412   { "PrintCompressedOopsMode",   LogLevel::Info,  true,  LOG_TAGS(gc, heap, coops) },
 413   { "TraceBiasedLocking",        LogLevel::Info,  true,  LOG_TAGS(biasedlocking) },
 414   { "TraceClassLoading",         LogLevel::Info,  true,  LOG_TAGS(class, load) },
 415   { "TraceClassLoadingPreorder", LogLevel::Debug, true,  LOG_TAGS(class, preorder) },
 416   { "TraceClassPaths",           LogLevel::Info,  true,  LOG_TAGS(class, path) },
 417   { "TraceClassResolution",      LogLevel::Debug, true,  LOG_TAGS(class, resolve) },
 418   { "TraceClassUnloading",       LogLevel::Info,  true,  LOG_TAGS(class, unload) },
 419   { "TraceExceptions",           LogLevel::Info,  true,  LOG_TAGS(exceptions) },
 420   { "TraceLoaderConstraints",    LogLevel::Info,  true,  LOG_TAGS(class, loader, constraints) },
 421   { "TraceMonitorInflation",     LogLevel::Debug, true,  LOG_TAGS(monitorinflation) },
 422   { "TraceSafepointCleanupTime", LogLevel::Info,  true,  LOG_TAGS(safepoint, cleanup) },
 423   { "TraceJVMTIObjectTagging",   LogLevel::Debug, true,  LOG_TAGS(jvmti, objecttagging) },
 424   { "TraceRedefineClasses",      LogLevel::Info,  false, LOG_TAGS(redefine, class) },
 425   { NULL,                        LogLevel::Off,   false, LOG_TAGS(_NO_TAG) }
 426 };
 427 
 428 #ifndef PRODUCT
 429 // These options are removed in jdk9. Remove this code for jdk10.
 430 static AliasedFlag const removed_develop_logging_flags[] = {
 431   { "TraceClassInitialization",   "-Xlog:class+init" },
 432   { "TraceClassLoaderData",       "-Xlog:class+loader+data" },
 433   { "TraceDefaultMethods",        "-Xlog:defaultmethods=debug" },
 434   { "TraceItables",               "-Xlog:itables=debug" },
 435   { "TraceMonitorMismatch",       "-Xlog:monitormismatch=info" },
 436   { "TraceSafepoint",             "-Xlog:safepoint=debug" },
 437   { "TraceStartupTime",           "-Xlog:startuptime" },
 438   { "TraceVMOperation",           "-Xlog:vmoperation=debug" },
 439   { "PrintVtables",               "-Xlog:vtables=debug" },
 440   { "VerboseVerification",        "-Xlog:verification" },
 441   { NULL, NULL }
 442 };
 443 #endif //PRODUCT
 444 
 445 // Return true if "v" is less than "other", where "other" may be "undefined".
 446 static bool version_less_than(JDK_Version v, JDK_Version other) {
 447   assert(!v.is_undefined(), "must be defined");
 448   if (!other.is_undefined() &amp;&amp; v.compare(other) &gt;= 0) {
 449     return false;
 450   } else {
 451     return true;
 452   }
 453 }
 454 
 455 static bool lookup_special_flag(const char *flag_name, SpecialFlag&amp; flag) {
 456   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 457     if ((strcmp(special_jvm_flags[i].name, flag_name) == 0)) {
 458       flag = special_jvm_flags[i];
 459       return true;
 460     }
 461   }
 462   return false;
 463 }
 464 
 465 bool Arguments::is_obsolete_flag(const char *flag_name, JDK_Version* version) {
 466   assert(version != NULL, "Must provide a version buffer");
 467   SpecialFlag flag;
 468   if (lookup_special_flag(flag_name, flag)) {
 469     if (!flag.obsolete_in.is_undefined()) {
 470       if (version_less_than(JDK_Version::current(), flag.expired_in)) {
 471         *version = flag.obsolete_in;
 472         return true;
 473       }
 474     }
 475   }
 476   return false;
 477 }
 478 
 479 int Arguments::is_deprecated_flag(const char *flag_name, JDK_Version* version) {
 480   assert(version != NULL, "Must provide a version buffer");
 481   SpecialFlag flag;
 482   if (lookup_special_flag(flag_name, flag)) {
 483     if (!flag.deprecated_in.is_undefined()) {
 484       if (version_less_than(JDK_Version::current(), flag.obsolete_in) &amp;&amp;
 485           version_less_than(JDK_Version::current(), flag.expired_in)) {
 486         *version = flag.deprecated_in;
 487         return 1;
 488       } else {
 489         return -1;
 490       }
 491     }
 492   }
 493   return 0;
 494 }
 495 
 496 #ifndef PRODUCT
 497 const char* Arguments::removed_develop_logging_flag_name(const char* name){
 498   for (size_t i = 0; removed_develop_logging_flags[i].alias_name != NULL; i++) {
 499     const AliasedFlag&amp; flag = removed_develop_logging_flags[i];
 500     if (strcmp(flag.alias_name, name) == 0) {
 501       return flag.real_name;
 502     }
 503   }
 504   return NULL;
 505 }
 506 #endif // PRODUCT
 507 
 508 const char* Arguments::real_flag_name(const char *flag_name) {
 509   for (size_t i = 0; aliased_jvm_flags[i].alias_name != NULL; i++) {
 510     const AliasedFlag&amp; flag_status = aliased_jvm_flags[i];
 511     if (strcmp(flag_status.alias_name, flag_name) == 0) {
 512         return flag_status.real_name;
 513     }
 514   }
 515   return flag_name;
 516 }
 517 
 518 #ifdef ASSERT
 519 static bool lookup_special_flag(const char *flag_name, size_t skip_index) {
 520   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 521     if ((i != skip_index) &amp;&amp; (strcmp(special_jvm_flags[i].name, flag_name) == 0)) {
 522       return true;
 523     }
 524   }
 525   return false;
 526 }
 527 
 528 static bool verify_special_jvm_flags() {
 529   bool success = true;
 530   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 531     const SpecialFlag&amp; flag = special_jvm_flags[i];
 532     if (lookup_special_flag(flag.name, i)) {
 533       warning("Duplicate special flag declaration \"%s\"", flag.name);
 534       success = false;
 535     }
 536     if (flag.deprecated_in.is_undefined() &amp;&amp;
 537         flag.obsolete_in.is_undefined()) {
 538       warning("Special flag entry \"%s\" must declare version deprecated and/or obsoleted in.", flag.name);
 539       success = false;
 540     }
 541 
 542     if (!flag.deprecated_in.is_undefined()) {
 543       if (!version_less_than(flag.deprecated_in, flag.obsolete_in)) {
 544         warning("Special flag entry \"%s\" must be deprecated before obsoleted.", flag.name);
 545         success = false;
 546       }
 547 
 548       if (!version_less_than(flag.deprecated_in, flag.expired_in)) {
 549         warning("Special flag entry \"%s\" must be deprecated before expired.", flag.name);
 550         success = false;
 551       }
 552     }
 553 
 554     if (!flag.obsolete_in.is_undefined()) {
 555       if (!version_less_than(flag.obsolete_in, flag.expired_in)) {
 556         warning("Special flag entry \"%s\" must be obsoleted before expired.", flag.name);
 557         success = false;
 558       }
 559 
 560       // if flag has become obsolete it should not have a "globals" flag defined anymore.
 561       if (!version_less_than(JDK_Version::current(), flag.obsolete_in)) {
 562         if (Flag::find_flag(flag.name) != NULL) {
 563           warning("Global variable for obsolete special flag entry \"%s\" should be removed", flag.name);
 564           success = false;
 565         }
 566       }
 567     }
 568 
 569     if (!flag.expired_in.is_undefined()) {
 570       // if flag has become expired it should not have a "globals" flag defined anymore.
 571       if (!version_less_than(JDK_Version::current(), flag.expired_in)) {
 572         if (Flag::find_flag(flag.name) != NULL) {
 573           warning("Global variable for expired flag entry \"%s\" should be removed", flag.name);
 574           success = false;
 575         }
 576       }
 577     }
 578 
 579   }
 580   return success;
 581 }
 582 #endif
 583 
 584 // Parses a size specification string.
 585 bool Arguments::atojulong(const char *s, julong* result) {
 586   julong n = 0;
 587 
 588   // First char must be a digit. Don't allow negative numbers or leading spaces.
 589   if (!isdigit(*s)) {
 590     return false;
 591   }
 592 
 593   bool is_hex = (s[0] == '0' &amp;&amp; (s[1] == 'x' || s[1] == 'X'));
 594   char* remainder;
 595   errno = 0;
 596   n = strtoull(s, &amp;remainder, (is_hex ? 16 : 10));
 597   if (errno != 0) {
 598     return false;
 599   }
 600 
 601   // Fail if no number was read at all or if the remainder contains more than a single non-digit character.
 602   if (remainder == s || strlen(remainder) &gt; 1) {
 603     return false;
 604   }
 605 
 606   switch (*remainder) {
 607     case 'T': case 't':
 608       *result = n * G * K;
 609       // Check for overflow.
 610       if (*result/((julong)G * K) != n) return false;
 611       return true;
 612     case 'G': case 'g':
 613       *result = n * G;
 614       if (*result/G != n) return false;
 615       return true;
 616     case 'M': case 'm':
 617       *result = n * M;
 618       if (*result/M != n) return false;
 619       return true;
 620     case 'K': case 'k':
 621       *result = n * K;
 622       if (*result/K != n) return false;
 623       return true;
 624     case '\0':
 625       *result = n;
 626       return true;
 627     default:
 628       return false;
 629   }
 630 }
 631 
 632 Arguments::ArgsRange Arguments::check_memory_size(julong size, julong min_size) {
 633   if (size &lt; min_size) return arg_too_small;
 634   // Check that size will fit in a size_t (only relevant on 32-bit)
 635   if (size &gt; max_uintx) return arg_too_big;
 636   return arg_in_range;
 637 }
 638 
 639 // Describe an argument out of range error
 640 void Arguments::describe_range_error(ArgsRange errcode) {
 641   switch(errcode) {
 642   case arg_too_big:
 643     jio_fprintf(defaultStream::error_stream(),
 644                 "The specified size exceeds the maximum "
 645                 "representable size.\n");
 646     break;
 647   case arg_too_small:
 648   case arg_unreadable:
 649   case arg_in_range:
 650     // do nothing for now
 651     break;
 652   default:
 653     ShouldNotReachHere();
 654   }
 655 }
 656 
 657 static bool set_bool_flag(const char* name, bool value, Flag::Flags origin) {
 658   if (CommandLineFlags::boolAtPut(name, &amp;value, origin) == Flag::SUCCESS) {
 659     return true;
 660   } else {
 661     return false;
 662   }
 663 }
 664 
 665 static bool set_fp_numeric_flag(const char* name, char* value, Flag::Flags origin) {
 666   char* end;
 667   errno = 0;
 668   double v = strtod(value, &amp;end);
 669   if ((errno != 0) || (*end != 0)) {
 670     return false;
 671   }
 672 
 673   if (CommandLineFlags::doubleAtPut(name, &amp;v, origin) == Flag::SUCCESS) {
 674     return true;
 675   }
 676   return false;
 677 }
 678 
 679 static bool set_numeric_flag(const char* name, char* value, Flag::Flags origin) {
 680   julong v;
 681   int int_v;
 682   intx intx_v;
 683   bool is_neg = false;
 684   Flag* result = Flag::find_flag(name, strlen(name));
 685 
 686   if (result == NULL) {
 687     return false;
 688   }
 689 
 690   // Check the sign first since atojulong() parses only unsigned values.
 691   if (*value == '-') {
 692     if (!result-&gt;is_intx() &amp;&amp; !result-&gt;is_int()) {
 693       return false;
 694     }
 695     value++;
 696     is_neg = true;
 697   }
 698   if (!Arguments::atojulong(value, &amp;v)) {
 699     return false;
 700   }
 701   if (result-&gt;is_int()) {
 702     int_v = (int) v;
 703     if (is_neg) {
 704       int_v = -int_v;
 705     }
 706     return CommandLineFlags::intAtPut(result, &amp;int_v, origin) == Flag::SUCCESS;
 707   } else if (result-&gt;is_uint()) {
 708     uint uint_v = (uint) v;
 709     return CommandLineFlags::uintAtPut(result, &amp;uint_v, origin) == Flag::SUCCESS;
 710   } else if (result-&gt;is_intx()) {
 711     intx_v = (intx) v;
 712     if (is_neg) {
 713       intx_v = -intx_v;
 714     }
 715     return CommandLineFlags::intxAtPut(result, &amp;intx_v, origin) == Flag::SUCCESS;
 716   } else if (result-&gt;is_uintx()) {
 717     uintx uintx_v = (uintx) v;
 718     return CommandLineFlags::uintxAtPut(result, &amp;uintx_v, origin) == Flag::SUCCESS;
 719   } else if (result-&gt;is_uint64_t()) {
 720     uint64_t uint64_t_v = (uint64_t) v;
 721     return CommandLineFlags::uint64_tAtPut(result, &amp;uint64_t_v, origin) == Flag::SUCCESS;
 722   } else if (result-&gt;is_size_t()) {
 723     size_t size_t_v = (size_t) v;
 724     return CommandLineFlags::size_tAtPut(result, &amp;size_t_v, origin) == Flag::SUCCESS;
 725   } else {
 726     return false;
 727   }
 728 }
 729 
 730 static bool set_string_flag(const char* name, const char* value, Flag::Flags origin) {
 731   if (CommandLineFlags::ccstrAtPut(name, &amp;value, origin) != Flag::SUCCESS) return false;
 732   // Contract:  CommandLineFlags always returns a pointer that needs freeing.
 733   FREE_C_HEAP_ARRAY(char, value);
 734   return true;
 735 }
 736 
 737 static bool append_to_string_flag(const char* name, const char* new_value, Flag::Flags origin) {
 738   const char* old_value = "";
 739   if (CommandLineFlags::ccstrAt(name, &amp;old_value) != Flag::SUCCESS) return false;
 740   size_t old_len = old_value != NULL ? strlen(old_value) : 0;
 741   size_t new_len = strlen(new_value);
 742   const char* value;
 743   char* free_this_too = NULL;
 744   if (old_len == 0) {
 745     value = new_value;
 746   } else if (new_len == 0) {
 747     value = old_value;
 748   } else {
 749     char* buf = NEW_C_HEAP_ARRAY(char, old_len + 1 + new_len + 1, mtArguments);
 750     // each new setting adds another LINE to the switch:
 751     sprintf(buf, "%s\n%s", old_value, new_value);
 752     value = buf;
 753     free_this_too = buf;
 754   }
 755   (void) CommandLineFlags::ccstrAtPut(name, &amp;value, origin);
 756   // CommandLineFlags always returns a pointer that needs freeing.
 757   FREE_C_HEAP_ARRAY(char, value);
 758   if (free_this_too != NULL) {
 759     // CommandLineFlags made its own copy, so I must delete my own temp. buffer.
 760     FREE_C_HEAP_ARRAY(char, free_this_too);
 761   }
 762   return true;
 763 }
 764 
 765 const char* Arguments::handle_aliases_and_deprecation(const char* arg, bool warn) {
 766   const char* real_name = real_flag_name(arg);
 767   JDK_Version since = JDK_Version();
 768   switch (is_deprecated_flag(arg, &amp;since)) {
 769     case -1:
 770       return NULL; // obsolete or expired, don't process normally
 771     case 0:
 772       return real_name;
 773     case 1: {
 774       if (warn) {
 775         char version[256];
 776         since.to_string(version, sizeof(version));
 777         if (real_name != arg) {
 778           warning("Option %s was deprecated in version %s and will likely be removed in a future release. Use option %s instead.",
 779                   arg, version, real_name);
 780         } else {
 781           warning("Option %s was deprecated in version %s and will likely be removed in a future release.",
 782                   arg, version);
 783         }
 784       }
 785       return real_name;
 786     }
 787   }
 788   ShouldNotReachHere();
 789   return NULL;
 790 }
 791 
 792 void log_deprecated_flag(const char* name, bool on, AliasedLoggingFlag alf) {
 793   LogTagType tagSet[] = {alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5};
 794   // Set tagset string buffer at max size of 256, large enough for any alias tagset
 795   const int max_tagset_size = 256;
 796   int max_tagset_len = max_tagset_size - 1;
 797   char tagset_buffer[max_tagset_size];
 798   tagset_buffer[0] = '\0';
 799 
 800   // Write tag-set for aliased logging option, in string list form
 801   int max_tags = sizeof(tagSet)/sizeof(tagSet[0]);
 802   for (int i = 0; i &lt; max_tags &amp;&amp; tagSet[i] != LogTag::__NO_TAG; i++) {
 803     if (i &gt; 0) {
 804       strncat(tagset_buffer, "+", max_tagset_len - strlen(tagset_buffer));
 805     }
 806     strncat(tagset_buffer, LogTag::name(tagSet[i]), max_tagset_len - strlen(tagset_buffer));
 807   }
 808   if (!alf.exactMatch) {
 809       strncat(tagset_buffer, "*", max_tagset_len - strlen(tagset_buffer));
 810   }
 811   log_warning(arguments)("-XX:%s%s is deprecated. Will use -Xlog:%s=%s instead.",
 812                          (on) ? "+" : "-",
 813                          name,
 814                          tagset_buffer,
 815                          (on) ? LogLevel::name(alf.level) : "off");
 816 }
 817 
 818 AliasedLoggingFlag Arguments::catch_logging_aliases(const char* name, bool on){
 819   for (size_t i = 0; aliased_logging_flags[i].alias_name != NULL; i++) {
 820     const AliasedLoggingFlag&amp; alf = aliased_logging_flags[i];
 821     if (strcmp(alf.alias_name, name) == 0) {
 822       log_deprecated_flag(name, on, alf);
 823       return alf;
 824     }
 825   }
 826   AliasedLoggingFlag a = {NULL, LogLevel::Off, false, LOG_TAGS(_NO_TAG)};
 827   return a;
 828 }
 829 
 830 bool Arguments::parse_argument(const char* arg, Flag::Flags origin) {
 831 
 832   // range of acceptable characters spelled out for portability reasons
 833 #define NAME_RANGE  "[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_]"
 834 #define BUFLEN 255
 835   char name[BUFLEN+1];
 836   char dummy;
 837   const char* real_name;
 838   bool warn_if_deprecated = true;
 839 
 840   if (sscanf(arg, "-%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;dummy) == 1) {
 841     AliasedLoggingFlag alf = catch_logging_aliases(name, false);
 842     if (alf.alias_name != NULL){
 843       LogConfiguration::configure_stdout(LogLevel::Off, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 844       return true;
 845     }
 846     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 847     if (real_name == NULL) {
 848       return false;
 849     }
 850     return set_bool_flag(real_name, false, origin);
 851   }
 852   if (sscanf(arg, "+%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;dummy) == 1) {
 853     AliasedLoggingFlag alf = catch_logging_aliases(name, true);
 854     if (alf.alias_name != NULL){
 855       LogConfiguration::configure_stdout(alf.level, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 856       return true;
 857     }
 858     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 859     if (real_name == NULL) {
 860       return false;
 861     }
 862     return set_bool_flag(real_name, true, origin);
 863   }
 864 
 865   char punct;
 866   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;punct) == 2 &amp;&amp; punct == '=') {
 867     const char* value = strchr(arg, '=') + 1;
 868     Flag* flag;
 869 
 870     // this scanf pattern matches both strings (handled here) and numbers (handled later))
 871     AliasedLoggingFlag alf = catch_logging_aliases(name, true);
 872     if (alf.alias_name != NULL) {
 873       LogConfiguration::configure_stdout(alf.level, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 874       return true;
 875     }
 876     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 877     if (real_name == NULL) {
 878       return false;
 879     }
 880     flag = Flag::find_flag(real_name);
 881     if (flag != NULL &amp;&amp; flag-&gt;is_ccstr()) {
 882       if (flag-&gt;ccstr_accumulates()) {
 883         return append_to_string_flag(real_name, value, origin);
 884       } else {
 885         if (value[0] == '\0') {
 886           value = NULL;
 887         }
 888         return set_string_flag(real_name, value, origin);
 889       }
 890     } else {
 891       warn_if_deprecated = false; // if arg is deprecated, we've already done warning...
 892     }
 893   }
 894 
 895   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE ":%c", name, &amp;punct) == 2 &amp;&amp; punct == '=') {
 896     const char* value = strchr(arg, '=') + 1;
 897     // -XX:Foo:=xxx will reset the string flag to the given value.
 898     if (value[0] == '\0') {
 899       value = NULL;
 900     }
 901     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 902     if (real_name == NULL) {
 903       return false;
 904     }
 905     return set_string_flag(real_name, value, origin);
 906   }
 907 
 908 #define SIGNED_FP_NUMBER_RANGE "[-0123456789.eE+]"
 909 #define SIGNED_NUMBER_RANGE    "[-0123456789]"
 910 #define        NUMBER_RANGE    "[0123456789eE+-]"
 911   char value[BUFLEN + 1];
 912   char value2[BUFLEN + 1];
 913   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) SIGNED_NUMBER_RANGE "." "%" XSTR(BUFLEN) NUMBER_RANGE "%c", name, value, value2, &amp;dummy) == 3) {
 914     // Looks like a floating-point number -- try again with more lenient format string
 915     if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) SIGNED_FP_NUMBER_RANGE "%c", name, value, &amp;dummy) == 2) {
 916       real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 917       if (real_name == NULL) {
 918         return false;
 919       }
 920       return set_fp_numeric_flag(real_name, value, origin);
 921     }
 922   }
 923 
 924 #define VALUE_RANGE "[-kmgtxKMGTX0123456789abcdefABCDEF]"
 925   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) VALUE_RANGE "%c", name, value, &amp;dummy) == 2) {
 926     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 927     if (real_name == NULL) {
 928       return false;
 929     }
 930     return set_numeric_flag(real_name, value, origin);
 931   }
 932 
 933   return false;
 934 }
 935 
 936 void Arguments::add_string(char*** bldarray, int* count, const char* arg) {
 937   assert(bldarray != NULL, "illegal argument");
 938 
 939   if (arg == NULL) {
 940     return;
 941   }
 942 
 943   int new_count = *count + 1;
 944 
 945   // expand the array and add arg to the last element
 946   if (*bldarray == NULL) {
 947     *bldarray = NEW_C_HEAP_ARRAY(char*, new_count, mtArguments);
 948   } else {
 949     *bldarray = REALLOC_C_HEAP_ARRAY(char*, *bldarray, new_count, mtArguments);
 950   }
 951   (*bldarray)[*count] = os::strdup_check_oom(arg);
 952   *count = new_count;
 953 }
 954 
 955 void Arguments::build_jvm_args(const char* arg) {
 956   add_string(&amp;_jvm_args_array, &amp;_num_jvm_args, arg);
 957 }
 958 
 959 void Arguments::build_jvm_flags(const char* arg) {
 960   add_string(&amp;_jvm_flags_array, &amp;_num_jvm_flags, arg);
 961 }
 962 
 963 // utility function to return a string that concatenates all
 964 // strings in a given char** array
 965 const char* Arguments::build_resource_string(char** args, int count) {
 966   if (args == NULL || count == 0) {
 967     return NULL;
 968   }
 969   size_t length = strlen(args[0]) + 1; // add 1 for the null terminator
 970   for (int i = 1; i &lt; count; i++) {
 971     length += strlen(args[i]) + 1; // add 1 for a space
 972   }
 973   char* s = NEW_RESOURCE_ARRAY(char, length);
 974   strcpy(s, args[0]);
 975   for (int j = 1; j &lt; count; j++) {
 976     strcat(s, " ");
 977     strcat(s, args[j]);
 978   }
 979   return (const char*) s;
 980 }
 981 
 982 void Arguments::print_on(outputStream* st) {
 983   st-&gt;print_cr("VM Arguments:");
 984   if (num_jvm_flags() &gt; 0) {
 985     st-&gt;print("jvm_flags: "); print_jvm_flags_on(st);
 986     st-&gt;cr();
 987   }
 988   if (num_jvm_args() &gt; 0) {
 989     st-&gt;print("jvm_args: "); print_jvm_args_on(st);
 990     st-&gt;cr();
 991   }
 992   st-&gt;print_cr("java_command: %s", java_command() ? java_command() : "&lt;unknown&gt;");
 993   if (_java_class_path != NULL) {
 994     char* path = _java_class_path-&gt;value();
 995     st-&gt;print_cr("java_class_path (initial): %s", strlen(path) == 0 ? "&lt;not set&gt;" : path );
 996   }
 997   st-&gt;print_cr("Launcher Type: %s", _sun_java_launcher);
 998 }
 999 
1000 void Arguments::print_summary_on(outputStream* st) {
1001   // Print the command line.  Environment variables that are helpful for
1002   // reproducing the problem are written later in the hs_err file.
1003   // flags are from setting file
1004   if (num_jvm_flags() &gt; 0) {
1005     st-&gt;print_raw("Settings File: ");
1006     print_jvm_flags_on(st);
1007     st-&gt;cr();
1008   }
1009   // args are the command line and environment variable arguments.
1010   st-&gt;print_raw("Command Line: ");
1011   if (num_jvm_args() &gt; 0) {
1012     print_jvm_args_on(st);
1013   }
1014   // this is the classfile and any arguments to the java program
1015   if (java_command() != NULL) {
1016     st-&gt;print("%s", java_command());
1017   }
1018   st-&gt;cr();
1019 }
1020 
1021 void Arguments::print_jvm_flags_on(outputStream* st) {
1022   if (_num_jvm_flags &gt; 0) {
1023     for (int i=0; i &lt; _num_jvm_flags; i++) {
1024       st-&gt;print("%s ", _jvm_flags_array[i]);
1025     }
1026   }
1027 }
1028 
1029 void Arguments::print_jvm_args_on(outputStream* st) {
1030   if (_num_jvm_args &gt; 0) {
1031     for (int i=0; i &lt; _num_jvm_args; i++) {
1032       st-&gt;print("%s ", _jvm_args_array[i]);
1033     }
1034   }
1035 }
1036 
1037 bool Arguments::process_argument(const char* arg,
1038                                  jboolean ignore_unrecognized,
1039                                  Flag::Flags origin) {
1040   JDK_Version since = JDK_Version();
1041 
1042   if (parse_argument(arg, origin)) {
1043     return true;
1044   }
1045 
1046   // Determine if the flag has '+', '-', or '=' characters.
1047   bool has_plus_minus = (*arg == '+' || *arg == '-');
1048   const char* const argname = has_plus_minus ? arg + 1 : arg;
1049 
1050   size_t arg_len;
1051   const char* equal_sign = strchr(argname, '=');
1052   if (equal_sign == NULL) {
1053     arg_len = strlen(argname);
1054   } else {
1055     arg_len = equal_sign - argname;
1056   }
1057 
1058   // Only make the obsolete check for valid arguments.
1059   if (arg_len &lt;= BUFLEN) {
1060     // Construct a string which consists only of the argument name without '+', '-', or '='.
1061     char stripped_argname[BUFLEN+1];
1062     strncpy(stripped_argname, argname, arg_len);
1063     stripped_argname[arg_len] = '\0';  // strncpy may not null terminate.
1064     if (is_obsolete_flag(stripped_argname, &amp;since)) {
1065       char version[256];
1066       since.to_string(version, sizeof(version));
1067       warning("Ignoring option %s; support was removed in %s", stripped_argname, version);
1068       return true;
1069     }
1070 #ifndef PRODUCT
1071     else {
1072       const char* replacement;
1073       if ((replacement = removed_develop_logging_flag_name(stripped_argname)) != NULL){
1074         log_warning(arguments)("%s has been removed. Please use %s instead.",
1075                                stripped_argname,
1076                                replacement);
1077         return false;
1078       }
1079     }
1080 #endif //PRODUCT
1081   }
1082 
1083   // For locked flags, report a custom error message if available.
1084   // Otherwise, report the standard unrecognized VM option.
1085   Flag* found_flag = Flag::find_flag((const char*)argname, arg_len, true, true);
1086   if (found_flag != NULL) {
1087     char locked_message_buf[BUFLEN];
1088     Flag::MsgType msg_type = found_flag-&gt;get_locked_message(locked_message_buf, BUFLEN);
1089     if (strlen(locked_message_buf) == 0) {
1090       if (found_flag-&gt;is_bool() &amp;&amp; !has_plus_minus) {
1091         jio_fprintf(defaultStream::error_stream(),
1092           "Missing +/- setting for VM option '%s'\n", argname);
1093       } else if (!found_flag-&gt;is_bool() &amp;&amp; has_plus_minus) {
1094         jio_fprintf(defaultStream::error_stream(),
1095           "Unexpected +/- setting in VM option '%s'\n", argname);
1096       } else {
1097         jio_fprintf(defaultStream::error_stream(),
1098           "Improperly specified VM option '%s'\n", argname);
1099       }
1100     } else {
1101 #ifdef PRODUCT
1102       bool mismatched = ((msg_type == Flag::NOTPRODUCT_FLAG_BUT_PRODUCT_BUILD) ||
1103                          (msg_type == Flag::DEVELOPER_FLAG_BUT_PRODUCT_BUILD));
1104       if (ignore_unrecognized &amp;&amp; mismatched) {
1105         return true;
1106       }
1107 #endif
1108       jio_fprintf(defaultStream::error_stream(), "%s", locked_message_buf);
1109     }
1110   } else {
1111     if (ignore_unrecognized) {
1112       return true;
1113     }
1114     jio_fprintf(defaultStream::error_stream(),
1115                 "Unrecognized VM option '%s'\n", argname);
1116     Flag* fuzzy_matched = Flag::fuzzy_match((const char*)argname, arg_len, true);
1117     if (fuzzy_matched != NULL) {
1118       jio_fprintf(defaultStream::error_stream(),
1119                   "Did you mean '%s%s%s'? ",
1120                   (fuzzy_matched-&gt;is_bool()) ? "(+/-)" : "",
1121                   fuzzy_matched-&gt;_name,
1122                   (fuzzy_matched-&gt;is_bool()) ? "" : "=&lt;value&gt;");
1123     }
1124   }
1125 
1126   // allow for commandline "commenting out" options like -XX:#+Verbose
1127   return arg[0] == '#';
1128 }
1129 
1130 bool Arguments::process_settings_file(const char* file_name, bool should_exist, jboolean ignore_unrecognized) {
1131   FILE* stream = fopen(file_name, "rb");
1132   if (stream == NULL) {
1133     if (should_exist) {
1134       jio_fprintf(defaultStream::error_stream(),
1135                   "Could not open settings file %s\n", file_name);
1136       return false;
1137     } else {
1138       return true;
1139     }
1140   }
1141 
1142   char token[1024];
1143   int  pos = 0;
1144 
1145   bool in_white_space = true;
1146   bool in_comment     = false;
1147   bool in_quote       = false;
1148   char quote_c        = 0;
1149   bool result         = true;
1150 
1151   int c = getc(stream);
1152   while(c != EOF &amp;&amp; pos &lt; (int)(sizeof(token)-1)) {
1153     if (in_white_space) {
1154       if (in_comment) {
1155         if (c == '\n') in_comment = false;
1156       } else {
1157         if (c == '#') in_comment = true;
1158         else if (!isspace(c)) {
1159           in_white_space = false;
1160           token[pos++] = c;
1161         }
1162       }
1163     } else {
1164       if (c == '\n' || (!in_quote &amp;&amp; isspace(c))) {
1165         // token ends at newline, or at unquoted whitespace
1166         // this allows a way to include spaces in string-valued options
1167         token[pos] = '\0';
1168         logOption(token);
1169         result &amp;= process_argument(token, ignore_unrecognized, Flag::CONFIG_FILE);
1170         build_jvm_flags(token);
1171         pos = 0;
1172         in_white_space = true;
1173         in_quote = false;
1174       } else if (!in_quote &amp;&amp; (c == '\'' || c == '"')) {
1175         in_quote = true;
1176         quote_c = c;
1177       } else if (in_quote &amp;&amp; (c == quote_c)) {
1178         in_quote = false;
1179       } else {
1180         token[pos++] = c;
1181       }
1182     }
1183     c = getc(stream);
1184   }
1185   if (pos &gt; 0) {
1186     token[pos] = '\0';
1187     result &amp;= process_argument(token, ignore_unrecognized, Flag::CONFIG_FILE);
1188     build_jvm_flags(token);
1189   }
1190   fclose(stream);
1191   return result;
1192 }
1193 
1194 //=============================================================================================================
1195 // Parsing of properties (-D)
1196 
1197 const char* Arguments::get_property(const char* key) {
1198   return PropertyList_get_value(system_properties(), key);
1199 }
1200 
1201 bool Arguments::add_property(const char* prop) {
1202   const char* eq = strchr(prop, '=');
1203   const char* key;
1204   const char* value = "";
1205 
1206   if (eq == NULL) {
1207     // property doesn't have a value, thus use passed string
1208     key = prop;
1209   } else {
1210     // property have a value, thus extract it and save to the
1211     // allocated string
1212     size_t key_len = eq - prop;
1213     char* tmp_key = AllocateHeap(key_len + 1, mtArguments);
1214 
1215     strncpy(tmp_key, prop, key_len);
1216     tmp_key[key_len] = '\0';
1217     key = tmp_key;
1218 
1219     value = &amp;prop[key_len + 1];
1220   }
1221 
1222   if (strcmp(key, "java.compiler") == 0) {
1223     process_java_compiler_argument(value);
1224     // Record value in Arguments, but let it get passed to Java.
1225   } else if (strcmp(key, "sun.java.launcher.is_altjvm") == 0 ||
1226              strcmp(key, "sun.java.launcher.pid") == 0) {
1227     // sun.java.launcher.is_altjvm and sun.java.launcher.pid property are
1228     // private and are processed in process_sun_java_launcher_properties();
1229     // the sun.java.launcher property is passed on to the java application
1230   } else if (strcmp(key, "sun.boot.library.path") == 0) {
1231     PropertyList_unique_add(&amp;_system_properties, key, value, true);
1232   } else {
1233     if (strcmp(key, "sun.java.command") == 0) {
1234       char *old_java_command = _java_command;
1235       _java_command = os::strdup_check_oom(value, mtArguments);
1236       if (old_java_command != NULL) {
1237         os::free(old_java_command);
1238       }
1239     } else if (strcmp(key, "java.vendor.url.bug") == 0) {
1240       const char* old_java_vendor_url_bug = _java_vendor_url_bug;
1241       // save it in _java_vendor_url_bug, so JVM fatal error handler can access
1242       // its value without going through the property list or making a Java call.
1243       _java_vendor_url_bug = os::strdup_check_oom(value, mtArguments);
1244       if (old_java_vendor_url_bug != DEFAULT_VENDOR_URL_BUG) {
1245         assert(old_java_vendor_url_bug != NULL, "_java_vendor_url_bug is NULL");
1246         os::free((void *)old_java_vendor_url_bug);
1247       }
1248     }
1249 
1250     // Create new property and add at the end of the list
1251     PropertyList_unique_add(&amp;_system_properties, key, value);
1252   }
1253 
1254   if (key != prop) {
1255     // SystemProperty copy passed value, thus free previously allocated
1256     // memory
1257     FreeHeap((void *)key);
1258   }
1259 
1260   return true;
1261 }
1262 
1263 // sets or adds a module name to the jdk.launcher.addmods property
1264 bool Arguments::append_to_addmods_property(const char* module_name) {
1265   const char* key = "jdk.launcher.addmods";
1266   const char* old_value = Arguments::get_property(key);
1267   size_t buf_len = strlen(key) + strlen(module_name) + 2;
1268   if (old_value != NULL) {
1269     buf_len += strlen(old_value) + 1;
1270   }
1271   char* new_value = AllocateHeap(buf_len, mtArguments);
1272   if (new_value == NULL) {
1273     return false;
1274   }
1275   if (old_value == NULL) {
1276     jio_snprintf(new_value, buf_len, "%s=%s", key, module_name);
1277   } else {
1278     jio_snprintf(new_value, buf_len, "%s=%s,%s", key, old_value, module_name);
1279   }
1280   bool added = add_property(new_value);
1281   FreeHeap(new_value);
1282   return added;
1283 }
1284 
1285 #if INCLUDE_CDS
1286 void Arguments::check_unsupported_dumping_properties() {
1287   assert(DumpSharedSpaces, "this function is only used with -Xshare:dump");
1288   const char* unsupported_properties[5] = { "jdk.module.main",
1289                                            "jdk.module.path",
1290                                            "jdk.upgrade.module.path",
1291                                            "jdk.launcher.addmods",
1292                                            "jdk.launcher.limitmods" };
1293   const char* unsupported_options[5] = { "-m",
1294                                         "-modulepath",
1295                                         "-upgrademodulepath",
1296                                         "-addmods",
1297                                         "-limitmods" };
1298   SystemProperty* sp = system_properties();
1299   while (sp != NULL) {
1300     for (int i = 0; i &lt; 5; i++) {
1301       if (strcmp(sp-&gt;key(), unsupported_properties[i]) == 0) {
1302           vm_exit_during_initialization(
1303             "Cannot use the following option when dumping the shared archive", unsupported_options[i]);
1304       }
1305     }
1306     sp = sp-&gt;next();
1307   }
1308 }
1309 #endif
1310 
1311 //===========================================================================================================
1312 // Setting int/mixed/comp mode flags
1313 
1314 void Arguments::set_mode_flags(Mode mode) {
1315   // Set up default values for all flags.
1316   // If you add a flag to any of the branches below,
1317   // add a default value for it here.
1318   set_java_compiler(false);
1319   _mode                      = mode;
1320 
1321   // Ensure Agent_OnLoad has the correct initial values.
1322   // This may not be the final mode; mode may change later in onload phase.
1323   PropertyList_unique_add(&amp;_system_properties, "java.vm.info",
1324                           VM_Version::vm_info_string(), false);
1325 
1326   UseInterpreter             = true;
1327   UseCompiler                = true;
1328   UseLoopCounter             = true;
1329 
1330   // Default values may be platform/compiler dependent -
1331   // use the saved values
1332   ClipInlining               = Arguments::_ClipInlining;
1333   AlwaysCompileLoopMethods   = Arguments::_AlwaysCompileLoopMethods;
1334   UseOnStackReplacement      = Arguments::_UseOnStackReplacement;
1335   BackgroundCompilation      = Arguments::_BackgroundCompilation;
1336   if (TieredCompilation) {
1337     if (FLAG_IS_DEFAULT(Tier3InvokeNotifyFreqLog)) {
1338       Tier3InvokeNotifyFreqLog = Arguments::_Tier3InvokeNotifyFreqLog;
1339     }
1340     if (FLAG_IS_DEFAULT(Tier4InvocationThreshold)) {
1341       Tier4InvocationThreshold = Arguments::_Tier4InvocationThreshold;
1342     }
1343   }
1344 
1345   // Change from defaults based on mode
1346   switch (mode) {
1347   default:
1348     ShouldNotReachHere();
1349     break;
1350   case _int:
1351     UseCompiler              = false;
1352     UseLoopCounter           = false;
1353     AlwaysCompileLoopMethods = false;
1354     UseOnStackReplacement    = false;
1355     break;
1356   case _mixed:
1357     // same as default
1358     break;
1359   case _comp:
1360     UseInterpreter           = false;
1361     BackgroundCompilation    = false;
1362     ClipInlining             = false;
1363     // Be much more aggressive in tiered mode with -Xcomp and exercise C2 more.
1364     // We will first compile a level 3 version (C1 with full profiling), then do one invocation of it and
1365     // compile a level 4 (C2) and then continue executing it.
1366     if (TieredCompilation) {
1367       Tier3InvokeNotifyFreqLog = 0;
1368       Tier4InvocationThreshold = 0;
1369     }
1370     break;
1371   }
1372 }
1373 
1374 #if defined(COMPILER2) || INCLUDE_JVMCI || defined(_LP64) || !INCLUDE_CDS
1375 // Conflict: required to use shared spaces (-Xshare:on), but
1376 // incompatible command line options were chosen.
1377 
1378 static void no_shared_spaces(const char* message) {
1379   if (RequireSharedSpaces) {
1380     jio_fprintf(defaultStream::error_stream(),
1381       "Class data sharing is inconsistent with other specified options.\n");
1382     vm_exit_during_initialization("Unable to use shared archive.", message);
1383   } else {
1384     FLAG_SET_DEFAULT(UseSharedSpaces, false);
1385   }
1386 }
1387 #endif
1388 
1389 // Returns threshold scaled with the value of scale.
1390 // If scale &lt; 0.0, threshold is returned without scaling.
1391 intx Arguments::scaled_compile_threshold(intx threshold, double scale) {
1392   if (scale == 1.0 || scale &lt; 0.0) {
1393     return threshold;
1394   } else {
1395     return (intx)(threshold * scale);
1396   }
1397 }
1398 
1399 // Returns freq_log scaled with the value of scale.
1400 // Returned values are in the range of [0, InvocationCounter::number_of_count_bits + 1].
1401 // If scale &lt; 0.0, freq_log is returned without scaling.
1402 intx Arguments::scaled_freq_log(intx freq_log, double scale) {
1403   // Check if scaling is necessary or if negative value was specified.
1404   if (scale == 1.0 || scale &lt; 0.0) {
1405     return freq_log;
1406   }
1407   // Check values to avoid calculating log2 of 0.
1408   if (scale == 0.0 || freq_log == 0) {
1409     return 0;
1410   }
1411   // Determine the maximum notification frequency value currently supported.
1412   // The largest mask value that the interpreter/C1 can handle is
1413   // of length InvocationCounter::number_of_count_bits. Mask values are always
1414   // one bit shorter then the value of the notification frequency. Set
1415   // max_freq_bits accordingly.
1416   intx max_freq_bits = InvocationCounter::number_of_count_bits + 1;
1417   intx scaled_freq = scaled_compile_threshold((intx)1 &lt;&lt; freq_log, scale);
1418   if (scaled_freq == 0) {
1419     // Return 0 right away to avoid calculating log2 of 0.
1420     return 0;
1421   } else if (scaled_freq &gt; nth_bit(max_freq_bits)) {
1422     return max_freq_bits;
1423   } else {
1424     return log2_intptr(scaled_freq);
1425   }
1426 }
1427 
1428 void Arguments::set_tiered_flags() {
1429   // With tiered, set default policy to AdvancedThresholdPolicy, which is 3.
1430   if (FLAG_IS_DEFAULT(CompilationPolicyChoice)) {
1431     FLAG_SET_DEFAULT(CompilationPolicyChoice, 3);
1432   }
1433   if (CompilationPolicyChoice &lt; 2) {
1434     vm_exit_during_initialization(
1435       "Incompatible compilation policy selected", NULL);
1436   }
1437   // Increase the code cache size - tiered compiles a lot more.
1438   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
1439     FLAG_SET_ERGO(uintx, ReservedCodeCacheSize,
1440                   MIN2(CODE_CACHE_DEFAULT_LIMIT, ReservedCodeCacheSize * 5));
1441   }
1442   // Enable SegmentedCodeCache if TieredCompilation is enabled and ReservedCodeCacheSize &gt;= 240M
1443   if (FLAG_IS_DEFAULT(SegmentedCodeCache) &amp;&amp; ReservedCodeCacheSize &gt;= 240*M) {
1444     FLAG_SET_ERGO(bool, SegmentedCodeCache, true);
1445   }
1446   if (!UseInterpreter) { // -Xcomp
1447     Tier3InvokeNotifyFreqLog = 0;
1448     Tier4InvocationThreshold = 0;
1449   }
1450 
1451   if (CompileThresholdScaling &lt; 0) {
1452     vm_exit_during_initialization("Negative value specified for CompileThresholdScaling", NULL);
1453   }
1454 
1455   // Scale tiered compilation thresholds.
1456   // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves compilation thresholds unchanged.
1457   if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
1458     FLAG_SET_ERGO(intx, Tier0InvokeNotifyFreqLog, scaled_freq_log(Tier0InvokeNotifyFreqLog));
1459     FLAG_SET_ERGO(intx, Tier0BackedgeNotifyFreqLog, scaled_freq_log(Tier0BackedgeNotifyFreqLog));
1460 
1461     FLAG_SET_ERGO(intx, Tier3InvocationThreshold, scaled_compile_threshold(Tier3InvocationThreshold));
1462     FLAG_SET_ERGO(intx, Tier3MinInvocationThreshold, scaled_compile_threshold(Tier3MinInvocationThreshold));
1463     FLAG_SET_ERGO(intx, Tier3CompileThreshold, scaled_compile_threshold(Tier3CompileThreshold));
1464     FLAG_SET_ERGO(intx, Tier3BackEdgeThreshold, scaled_compile_threshold(Tier3BackEdgeThreshold));
1465 
1466     // Tier2{Invocation,MinInvocation,Compile,Backedge}Threshold should be scaled here
1467     // once these thresholds become supported.
1468 
1469     FLAG_SET_ERGO(intx, Tier2InvokeNotifyFreqLog, scaled_freq_log(Tier2InvokeNotifyFreqLog));
1470     FLAG_SET_ERGO(intx, Tier2BackedgeNotifyFreqLog, scaled_freq_log(Tier2BackedgeNotifyFreqLog));
1471 
1472     FLAG_SET_ERGO(intx, Tier3InvokeNotifyFreqLog, scaled_freq_log(Tier3InvokeNotifyFreqLog));
1473     FLAG_SET_ERGO(intx, Tier3BackedgeNotifyFreqLog, scaled_freq_log(Tier3BackedgeNotifyFreqLog));
1474 
1475     FLAG_SET_ERGO(intx, Tier23InlineeNotifyFreqLog, scaled_freq_log(Tier23InlineeNotifyFreqLog));
1476 
1477     FLAG_SET_ERGO(intx, Tier4InvocationThreshold, scaled_compile_threshold(Tier4InvocationThreshold));
1478     FLAG_SET_ERGO(intx, Tier4MinInvocationThreshold, scaled_compile_threshold(Tier4MinInvocationThreshold));
1479     FLAG_SET_ERGO(intx, Tier4CompileThreshold, scaled_compile_threshold(Tier4CompileThreshold));
1480     FLAG_SET_ERGO(intx, Tier4BackEdgeThreshold, scaled_compile_threshold(Tier4BackEdgeThreshold));
1481   }
1482 }
1483 
1484 #if INCLUDE_ALL_GCS
1485 static void disable_adaptive_size_policy(const char* collector_name) {
1486   if (UseAdaptiveSizePolicy) {
1487     if (FLAG_IS_CMDLINE(UseAdaptiveSizePolicy)) {
1488       warning("Disabling UseAdaptiveSizePolicy; it is incompatible with %s.",
1489               collector_name);
1490     }
1491     FLAG_SET_DEFAULT(UseAdaptiveSizePolicy, false);
1492   }
1493 }
1494 
1495 void Arguments::set_parnew_gc_flags() {
1496   assert(!UseSerialGC &amp;&amp; !UseParallelOldGC &amp;&amp; !UseParallelGC &amp;&amp; !UseG1GC,
1497          "control point invariant");
1498   assert(UseConcMarkSweepGC, "CMS is expected to be on here");
1499   assert(UseParNewGC, "ParNew should always be used with CMS");
1500 
1501   if (FLAG_IS_DEFAULT(ParallelGCThreads)) {
1502     FLAG_SET_DEFAULT(ParallelGCThreads, Abstract_VM_Version::parallel_worker_threads());
1503     assert(ParallelGCThreads &gt; 0, "We should always have at least one thread by default");
1504   } else if (ParallelGCThreads == 0) {
1505     jio_fprintf(defaultStream::error_stream(),
1506         "The ParNew GC can not be combined with -XX:ParallelGCThreads=0\n");
1507     vm_exit(1);
1508   }
1509 
1510   // By default YoungPLABSize and OldPLABSize are set to 4096 and 1024 respectively,
1511   // these settings are default for Parallel Scavenger. For ParNew+Tenured configuration
1512   // we set them to 1024 and 1024.
1513   // See CR 6362902.
1514   if (FLAG_IS_DEFAULT(YoungPLABSize)) {
1515     FLAG_SET_DEFAULT(YoungPLABSize, (intx)1024);
1516   }
1517   if (FLAG_IS_DEFAULT(OldPLABSize)) {
1518     FLAG_SET_DEFAULT(OldPLABSize, (intx)1024);
1519   }
1520 
1521   // When using compressed oops, we use local overflow stacks,
1522   // rather than using a global overflow list chained through
1523   // the klass word of the object's pre-image.
1524   if (UseCompressedOops &amp;&amp; !ParGCUseLocalOverflow) {
1525     if (!FLAG_IS_DEFAULT(ParGCUseLocalOverflow)) {
1526       warning("Forcing +ParGCUseLocalOverflow: needed if using compressed references");
1527     }
1528     FLAG_SET_DEFAULT(ParGCUseLocalOverflow, true);
1529   }
1530   assert(ParGCUseLocalOverflow || !UseCompressedOops, "Error");
1531 }
1532 
1533 // Adjust some sizes to suit CMS and/or ParNew needs; these work well on
1534 // sparc/solaris for certain applications, but would gain from
1535 // further optimization and tuning efforts, and would almost
1536 // certainly gain from analysis of platform and environment.
1537 void Arguments::set_cms_and_parnew_gc_flags() {
1538   assert(!UseSerialGC &amp;&amp; !UseParallelOldGC &amp;&amp; !UseParallelGC, "Error");
1539   assert(UseConcMarkSweepGC, "CMS is expected to be on here");
1540   assert(UseParNewGC, "ParNew should always be used with CMS");
1541 
1542   // Turn off AdaptiveSizePolicy by default for cms until it is complete.
1543   disable_adaptive_size_policy("UseConcMarkSweepGC");
1544 
1545   set_parnew_gc_flags();
1546 
1547   size_t max_heap = align_size_down(MaxHeapSize,
1548                                     CardTableRS::ct_max_alignment_constraint());
1549 
1550   // Now make adjustments for CMS
1551   intx   tenuring_default = (intx)6;
1552   size_t young_gen_per_worker = CMSYoungGenPerWorker;
1553 
1554   // Preferred young gen size for "short" pauses:
1555   // upper bound depends on # of threads and NewRatio.
1556   const size_t preferred_max_new_size_unaligned =
1557     MIN2(max_heap/(NewRatio+1), ScaleForWordSize(young_gen_per_worker * ParallelGCThreads));
1558   size_t preferred_max_new_size =
1559     align_size_up(preferred_max_new_size_unaligned, os::vm_page_size());
1560 
1561   // Unless explicitly requested otherwise, size young gen
1562   // for "short" pauses ~ CMSYoungGenPerWorker*ParallelGCThreads
1563 
1564   // If either MaxNewSize or NewRatio is set on the command line,
1565   // assume the user is trying to set the size of the young gen.
1566   if (FLAG_IS_DEFAULT(MaxNewSize) &amp;&amp; FLAG_IS_DEFAULT(NewRatio)) {
1567 
1568     // Set MaxNewSize to our calculated preferred_max_new_size unless
1569     // NewSize was set on the command line and it is larger than
1570     // preferred_max_new_size.
1571     if (!FLAG_IS_DEFAULT(NewSize)) {   // NewSize explicitly set at command-line
1572       FLAG_SET_ERGO(size_t, MaxNewSize, MAX2(NewSize, preferred_max_new_size));
1573     } else {
1574       FLAG_SET_ERGO(size_t, MaxNewSize, preferred_max_new_size);
1575     }
1576     log_trace(gc, heap)("CMS ergo set MaxNewSize: " SIZE_FORMAT, MaxNewSize);
1577 
1578     // Code along this path potentially sets NewSize and OldSize
1579     log_trace(gc, heap)("CMS set min_heap_size: " SIZE_FORMAT " initial_heap_size:  " SIZE_FORMAT " max_heap: " SIZE_FORMAT,
1580                         min_heap_size(), InitialHeapSize, max_heap);
1581     size_t min_new = preferred_max_new_size;
1582     if (FLAG_IS_CMDLINE(NewSize)) {
1583       min_new = NewSize;
1584     }
1585     if (max_heap &gt; min_new &amp;&amp; min_heap_size() &gt; min_new) {
1586       // Unless explicitly requested otherwise, make young gen
1587       // at least min_new, and at most preferred_max_new_size.
1588       if (FLAG_IS_DEFAULT(NewSize)) {
1589         FLAG_SET_ERGO(size_t, NewSize, MAX2(NewSize, min_new));
1590         FLAG_SET_ERGO(size_t, NewSize, MIN2(preferred_max_new_size, NewSize));
1591         log_trace(gc, heap)("CMS ergo set NewSize: " SIZE_FORMAT, NewSize);
1592       }
1593       // Unless explicitly requested otherwise, size old gen
1594       // so it's NewRatio x of NewSize.
1595       if (FLAG_IS_DEFAULT(OldSize)) {
1596         if (max_heap &gt; NewSize) {
1597           FLAG_SET_ERGO(size_t, OldSize, MIN2(NewRatio*NewSize, max_heap - NewSize));
1598           log_trace(gc, heap)("CMS ergo set OldSize: " SIZE_FORMAT, OldSize);
1599         }
1600       }
1601     }
1602   }
1603   // Unless explicitly requested otherwise, definitely
1604   // promote all objects surviving "tenuring_default" scavenges.
1605   if (FLAG_IS_DEFAULT(MaxTenuringThreshold) &amp;&amp;
1606       FLAG_IS_DEFAULT(SurvivorRatio)) {
1607     FLAG_SET_ERGO(uintx, MaxTenuringThreshold, tenuring_default);
1608   }
1609   // If we decided above (or user explicitly requested)
1610   // `promote all' (via MaxTenuringThreshold := 0),
1611   // prefer minuscule survivor spaces so as not to waste
1612   // space for (non-existent) survivors
1613   if (FLAG_IS_DEFAULT(SurvivorRatio) &amp;&amp; MaxTenuringThreshold == 0) {
1614     FLAG_SET_ERGO(uintx, SurvivorRatio, MAX2((uintx)1024, SurvivorRatio));
1615   }
1616 
1617   // OldPLABSize is interpreted in CMS as not the size of the PLAB in words,
1618   // but rather the number of free blocks of a given size that are used when
1619   // replenishing the local per-worker free list caches.
1620   if (FLAG_IS_DEFAULT(OldPLABSize)) {
1621     if (!FLAG_IS_DEFAULT(ResizeOldPLAB) &amp;&amp; !ResizeOldPLAB) {
1622       // OldPLAB sizing manually turned off: Use a larger default setting,
1623       // unless it was manually specified. This is because a too-low value
1624       // will slow down scavenges.
1625       FLAG_SET_ERGO(size_t, OldPLABSize, CompactibleFreeListSpaceLAB::_default_static_old_plab_size); // default value before 6631166
1626     } else {
1627       FLAG_SET_DEFAULT(OldPLABSize, CompactibleFreeListSpaceLAB::_default_dynamic_old_plab_size); // old CMSParPromoteBlocksToClaim default
1628     }
1629   }
1630 
1631   // If either of the static initialization defaults have changed, note this
1632   // modification.
1633   if (!FLAG_IS_DEFAULT(OldPLABSize) || !FLAG_IS_DEFAULT(OldPLABWeight)) {
1634     CompactibleFreeListSpaceLAB::modify_initialization(OldPLABSize, OldPLABWeight);
1635   }
1636 
1637   if (!ClassUnloading) {
1638     FLAG_SET_CMDLINE(bool, CMSClassUnloadingEnabled, false);
1639     FLAG_SET_CMDLINE(bool, ExplicitGCInvokesConcurrentAndUnloadsClasses, false);
1640   }
1641 
1642   log_trace(gc)("MarkStackSize: %uk  MarkStackSizeMax: %uk", (unsigned int) (MarkStackSize / K), (uint) (MarkStackSizeMax / K));
1643 }
1644 #endif // INCLUDE_ALL_GCS
1645 
1646 void set_object_alignment() {
1647   // Object alignment.
1648   assert(is_power_of_2(ObjectAlignmentInBytes), "ObjectAlignmentInBytes must be power of 2");
1649   MinObjAlignmentInBytes     = ObjectAlignmentInBytes;
1650   assert(MinObjAlignmentInBytes &gt;= HeapWordsPerLong * HeapWordSize, "ObjectAlignmentInBytes value is too small");
1651   MinObjAlignment            = MinObjAlignmentInBytes / HeapWordSize;
1652   assert(MinObjAlignmentInBytes == MinObjAlignment * HeapWordSize, "ObjectAlignmentInBytes value is incorrect");
1653   MinObjAlignmentInBytesMask = MinObjAlignmentInBytes - 1;
1654 
1655   LogMinObjAlignmentInBytes  = exact_log2(ObjectAlignmentInBytes);
1656   LogMinObjAlignment         = LogMinObjAlignmentInBytes - LogHeapWordSize;
1657 
1658   // Oop encoding heap max
1659   OopEncodingHeapMax = (uint64_t(max_juint) + 1) &lt;&lt; LogMinObjAlignmentInBytes;
1660 
1661   if (SurvivorAlignmentInBytes == 0) {
1662     SurvivorAlignmentInBytes = ObjectAlignmentInBytes;
1663   }
1664 
1665 #if INCLUDE_ALL_GCS
1666   // Set CMS global values
1667   CompactibleFreeListSpace::set_cms_values();
1668 #endif // INCLUDE_ALL_GCS
1669 }
1670 
1671 size_t Arguments::max_heap_for_compressed_oops() {
1672   // Avoid sign flip.
1673   assert(OopEncodingHeapMax &gt; (uint64_t)os::vm_page_size(), "Unusual page size");
1674   // We need to fit both the NULL page and the heap into the memory budget, while
1675   // keeping alignment constraints of the heap. To guarantee the latter, as the
1676   // NULL page is located before the heap, we pad the NULL page to the conservative
1677   // maximum alignment that the GC may ever impose upon the heap.
1678   size_t displacement_due_to_null_page = align_size_up_(os::vm_page_size(),
1679                                                         _conservative_max_heap_alignment);
1680 
1681   LP64_ONLY(return OopEncodingHeapMax - displacement_due_to_null_page);
1682   NOT_LP64(ShouldNotReachHere(); return 0);
1683 }
1684 
1685 bool Arguments::should_auto_select_low_pause_collector() {
1686   if (UseAutoGCSelectPolicy &amp;&amp;
1687       !FLAG_IS_DEFAULT(MaxGCPauseMillis) &amp;&amp;
1688       (MaxGCPauseMillis &lt;= AutoGCSelectPauseMillis)) {
1689     log_trace(gc)("Automatic selection of the low pause collector based on pause goal of %d (ms)", (int) MaxGCPauseMillis);
1690     return true;
1691   }
1692   return false;
1693 }
1694 
1695 void Arguments::set_use_compressed_oops() {
1696 #ifndef ZERO
1697 #ifdef _LP64
1698   // MaxHeapSize is not set up properly at this point, but
1699   // the only value that can override MaxHeapSize if we are
1700   // to use UseCompressedOops is InitialHeapSize.
1701   size_t max_heap_size = MAX2(MaxHeapSize, InitialHeapSize);
1702 
1703   if (max_heap_size &lt;= max_heap_for_compressed_oops()) {
1704 #if !defined(COMPILER1) || defined(TIERED)
1705     if (FLAG_IS_DEFAULT(UseCompressedOops)) {
1706       FLAG_SET_ERGO(bool, UseCompressedOops, true);
1707     }
1708 #endif
1709   } else {
1710     if (UseCompressedOops &amp;&amp; !FLAG_IS_DEFAULT(UseCompressedOops)) {
1711       warning("Max heap size too large for Compressed Oops");
1712       FLAG_SET_DEFAULT(UseCompressedOops, false);
1713       FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1714     }
1715   }
1716 #endif // _LP64
1717 #endif // ZERO
1718 }
1719 
1720 
1721 // NOTE: set_use_compressed_klass_ptrs() must be called after calling
1722 // set_use_compressed_oops().
1723 void Arguments::set_use_compressed_klass_ptrs() {
1724 #ifndef ZERO
1725 #ifdef _LP64
1726   // UseCompressedOops must be on for UseCompressedClassPointers to be on.
1727   if (!UseCompressedOops) {
1728     if (UseCompressedClassPointers) {
1729       warning("UseCompressedClassPointers requires UseCompressedOops");
1730     }
1731     FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1732   } else {
1733     // Turn on UseCompressedClassPointers too
1734     if (FLAG_IS_DEFAULT(UseCompressedClassPointers)) {
1735       FLAG_SET_ERGO(bool, UseCompressedClassPointers, true);
1736     }
1737     // Check the CompressedClassSpaceSize to make sure we use compressed klass ptrs.
1738     if (UseCompressedClassPointers) {
1739       if (CompressedClassSpaceSize &gt; KlassEncodingMetaspaceMax) {
1740         warning("CompressedClassSpaceSize is too large for UseCompressedClassPointers");
1741         FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1742       }
1743     }
1744   }
1745 #endif // _LP64
1746 #endif // !ZERO
1747 }
1748 
1749 void Arguments::set_conservative_max_heap_alignment() {
1750   // The conservative maximum required alignment for the heap is the maximum of
1751   // the alignments imposed by several sources: any requirements from the heap
1752   // itself, the collector policy and the maximum page size we may run the VM
1753   // with.
1754   size_t heap_alignment = GenCollectedHeap::conservative_max_heap_alignment();
1755 #if INCLUDE_ALL_GCS
1756   if (UseParallelGC) {
1757     heap_alignment = ParallelScavengeHeap::conservative_max_heap_alignment();
1758   } else if (UseG1GC) {
1759     heap_alignment = G1CollectedHeap::conservative_max_heap_alignment();
1760   }
1761 #endif // INCLUDE_ALL_GCS
1762   _conservative_max_heap_alignment = MAX4(heap_alignment,
1763                                           (size_t)os::vm_allocation_granularity(),
1764                                           os::max_page_size(),
1765                                           CollectorPolicy::compute_heap_alignment());
1766 }
1767 
1768 bool Arguments::gc_selected() {
1769 #if INCLUDE_ALL_GCS
1770   return UseSerialGC || UseParallelGC || UseParallelOldGC || UseConcMarkSweepGC || UseG1GC;
1771 #else
1772   return UseSerialGC;
1773 #endif // INCLUDE_ALL_GCS
1774 }
1775 
1776 void Arguments::select_gc_ergonomically() {
1777 #if INCLUDE_ALL_GCS
1778   if (os::is_server_class_machine()) {
1779     if (should_auto_select_low_pause_collector()) {
1780       FLAG_SET_ERGO_IF_DEFAULT(bool, UseConcMarkSweepGC, true);
1781     } else {
1782 #if defined(JAVASE_EMBEDDED)
1783       FLAG_SET_ERGO_IF_DEFAULT(bool, UseParallelGC, true);
1784 #else
1785       FLAG_SET_ERGO_IF_DEFAULT(bool, UseG1GC, true);
1786 #endif
1787     }
1788   } else {
1789     FLAG_SET_ERGO_IF_DEFAULT(bool, UseSerialGC, true);
1790   }
1791 #else
1792   UNSUPPORTED_OPTION(UseG1GC);
1793   UNSUPPORTED_OPTION(UseParallelGC);
1794   UNSUPPORTED_OPTION(UseParallelOldGC);
1795   UNSUPPORTED_OPTION(UseConcMarkSweepGC);
1796   UNSUPPORTED_OPTION(UseParNewGC);
1797   FLAG_SET_ERGO_IF_DEFAULT(bool, UseSerialGC, true);
1798 #endif // INCLUDE_ALL_GCS
1799 }
1800 
1801 void Arguments::select_gc() {
1802   if (!gc_selected()) {
1803     select_gc_ergonomically();
1804     if (!gc_selected()) {
1805       vm_exit_during_initialization("Garbage collector not selected (default collector explicitly disabled)", NULL);
1806     }
1807   }
1808 }
1809 
1810 void Arguments::set_ergonomics_flags() {
1811   select_gc();
1812 
1813 #if defined(COMPILER2) || INCLUDE_JVMCI
1814   // Shared spaces work fine with other GCs but causes bytecode rewriting
1815   // to be disabled, which hurts interpreter performance and decreases
1816   // server performance.  When -server is specified, keep the default off
1817   // unless it is asked for.  Future work: either add bytecode rewriting
1818   // at link time, or rewrite bytecodes in non-shared methods.
1819   if (!DumpSharedSpaces &amp;&amp; !RequireSharedSpaces &amp;&amp;
1820       (FLAG_IS_DEFAULT(UseSharedSpaces) || !UseSharedSpaces)) {
1821     no_shared_spaces("COMPILER2 default: -Xshare:auto | off, have to manually setup to on.");
1822   }
1823 #endif
1824 
1825   set_conservative_max_heap_alignment();
1826 
1827 #ifndef ZERO
1828 #ifdef _LP64
1829   set_use_compressed_oops();
1830 
1831   // set_use_compressed_klass_ptrs() must be called after calling
1832   // set_use_compressed_oops().
1833   set_use_compressed_klass_ptrs();
1834 
1835   // Also checks that certain machines are slower with compressed oops
1836   // in vm_version initialization code.
1837 #endif // _LP64
1838 #endif // !ZERO
1839 
1840   CodeCacheExtensions::set_ergonomics_flags();
1841 }
1842 
1843 void Arguments::set_parallel_gc_flags() {
1844   assert(UseParallelGC || UseParallelOldGC, "Error");
1845   // Enable ParallelOld unless it was explicitly disabled (cmd line or rc file).
1846   if (FLAG_IS_DEFAULT(UseParallelOldGC)) {
1847     FLAG_SET_DEFAULT(UseParallelOldGC, true);
1848   }
1849   FLAG_SET_DEFAULT(UseParallelGC, true);
1850 
1851   // If no heap maximum was requested explicitly, use some reasonable fraction
1852   // of the physical memory, up to a maximum of 1GB.
1853   FLAG_SET_DEFAULT(ParallelGCThreads,
1854                    Abstract_VM_Version::parallel_worker_threads());
1855   if (ParallelGCThreads == 0) {
1856     jio_fprintf(defaultStream::error_stream(),
1857         "The Parallel GC can not be combined with -XX:ParallelGCThreads=0\n");
1858     vm_exit(1);
1859   }
1860 
1861   if (UseAdaptiveSizePolicy) {
1862     // We don't want to limit adaptive heap sizing's freedom to adjust the heap
1863     // unless the user actually sets these flags.
1864     if (FLAG_IS_DEFAULT(MinHeapFreeRatio)) {
1865       FLAG_SET_DEFAULT(MinHeapFreeRatio, 0);
1866     }
1867     if (FLAG_IS_DEFAULT(MaxHeapFreeRatio)) {
1868       FLAG_SET_DEFAULT(MaxHeapFreeRatio, 100);
1869     }
1870   }
1871 
1872   // If InitialSurvivorRatio or MinSurvivorRatio were not specified, but the
1873   // SurvivorRatio has been set, reset their default values to SurvivorRatio +
1874   // 2.  By doing this we make SurvivorRatio also work for Parallel Scavenger.
1875   // See CR 6362902 for details.
1876   if (!FLAG_IS_DEFAULT(SurvivorRatio)) {
1877     if (FLAG_IS_DEFAULT(InitialSurvivorRatio)) {
1878        FLAG_SET_DEFAULT(InitialSurvivorRatio, SurvivorRatio + 2);
1879     }
1880     if (FLAG_IS_DEFAULT(MinSurvivorRatio)) {
1881       FLAG_SET_DEFAULT(MinSurvivorRatio, SurvivorRatio + 2);
1882     }
1883   }
1884 
1885   if (UseParallelOldGC) {
1886     // Par compact uses lower default values since they are treated as
1887     // minimums.  These are different defaults because of the different
1888     // interpretation and are not ergonomically set.
1889     if (FLAG_IS_DEFAULT(MarkSweepDeadRatio)) {
1890       FLAG_SET_DEFAULT(MarkSweepDeadRatio, 1);
1891     }
1892   }
1893 }
1894 
1895 void Arguments::set_g1_gc_flags() {
1896   assert(UseG1GC, "Error");
1897 #if defined(COMPILER1) || INCLUDE_JVMCI
1898   FastTLABRefill = false;
1899 #endif
1900   FLAG_SET_DEFAULT(ParallelGCThreads, Abstract_VM_Version::parallel_worker_threads());
1901   if (ParallelGCThreads == 0) {
1902     assert(!FLAG_IS_DEFAULT(ParallelGCThreads), "The default value for ParallelGCThreads should not be 0.");
1903     vm_exit_during_initialization("The flag -XX:+UseG1GC can not be combined with -XX:ParallelGCThreads=0", NULL);
1904   }
1905 
1906 #if INCLUDE_ALL_GCS
1907   if (FLAG_IS_DEFAULT(G1ConcRefinementThreads)) {
1908     FLAG_SET_ERGO(uint, G1ConcRefinementThreads, ParallelGCThreads);
1909   }
1910 #endif
1911 
1912   // MarkStackSize will be set (if it hasn't been set by the user)
1913   // when concurrent marking is initialized.
1914   // Its value will be based upon the number of parallel marking threads.
1915   // But we do set the maximum mark stack size here.
1916   if (FLAG_IS_DEFAULT(MarkStackSizeMax)) {
1917     FLAG_SET_DEFAULT(MarkStackSizeMax, 128 * TASKQUEUE_SIZE);
1918   }
1919 
1920   if (FLAG_IS_DEFAULT(GCTimeRatio) || GCTimeRatio == 0) {
1921     // In G1, we want the default GC overhead goal to be higher than
1922     // it is for PS, or the heap might be expanded too aggressively.
1923     // We set it here to ~8%.
1924     FLAG_SET_DEFAULT(GCTimeRatio, 12);
1925   }
1926 
1927   // Below, we might need to calculate the pause time interval based on
1928   // the pause target. When we do so we are going to give G1 maximum
1929   // flexibility and allow it to do pauses when it needs to. So, we'll
1930   // arrange that the pause interval to be pause time target + 1 to
1931   // ensure that a) the pause time target is maximized with respect to
1932   // the pause interval and b) we maintain the invariant that pause
1933   // time target &lt; pause interval. If the user does not want this
1934   // maximum flexibility, they will have to set the pause interval
1935   // explicitly.
1936 
1937   if (FLAG_IS_DEFAULT(MaxGCPauseMillis)) {
1938     // The default pause time target in G1 is 200ms
1939     FLAG_SET_DEFAULT(MaxGCPauseMillis, 200);
1940   }
1941 
1942   // Then, if the interval parameter was not set, set it according to
1943   // the pause time target (this will also deal with the case when the
1944   // pause time target is the default value).
1945   if (FLAG_IS_DEFAULT(GCPauseIntervalMillis)) {
1946     FLAG_SET_DEFAULT(GCPauseIntervalMillis, MaxGCPauseMillis + 1);
1947   }
1948 
1949   log_trace(gc)("MarkStackSize: %uk  MarkStackSizeMax: %uk", (unsigned int) (MarkStackSize / K), (uint) (MarkStackSizeMax / K));
1950 }
1951 
1952 void Arguments::set_gc_specific_flags() {
1953 #if INCLUDE_ALL_GCS
1954   // Set per-collector flags
1955   if (UseParallelGC || UseParallelOldGC) {
1956     set_parallel_gc_flags();
1957   } else if (UseConcMarkSweepGC) {
1958     set_cms_and_parnew_gc_flags();
1959   } else if (UseG1GC) {
1960     set_g1_gc_flags();
1961   }
1962   if (AssumeMP &amp;&amp; !UseSerialGC) {
1963     if (FLAG_IS_DEFAULT(ParallelGCThreads) &amp;&amp; ParallelGCThreads == 1) {
1964       warning("If the number of processors is expected to increase from one, then"
1965               " you should configure the number of parallel GC threads appropriately"
1966               " using -XX:ParallelGCThreads=N");
1967     }
1968   }
1969   if (MinHeapFreeRatio == 100) {
1970     // Keeping the heap 100% free is hard ;-) so limit it to 99%.
1971     FLAG_SET_ERGO(uintx, MinHeapFreeRatio, 99);
1972   }
1973 #endif // INCLUDE_ALL_GCS
1974 }
1975 
1976 julong Arguments::limit_by_allocatable_memory(julong limit) {
1977   julong max_allocatable;
1978   julong result = limit;
1979   if (os::has_allocatable_memory_limit(&amp;max_allocatable)) {
1980     result = MIN2(result, max_allocatable / MaxVirtMemFraction);
1981   }
1982   return result;
1983 }
1984 
1985 // Use static initialization to get the default before parsing
1986 static const size_t DefaultHeapBaseMinAddress = HeapBaseMinAddress;
1987 
1988 void Arguments::set_heap_size() {
1989   const julong phys_mem =
1990     FLAG_IS_DEFAULT(MaxRAM) ? MIN2(os::physical_memory(), (julong)MaxRAM)
1991                             : (julong)MaxRAM;
1992 
1993   // If the maximum heap size has not been set with -Xmx,
1994   // then set it as fraction of the size of physical memory,
1995   // respecting the maximum and minimum sizes of the heap.
1996   if (FLAG_IS_DEFAULT(MaxHeapSize)) {
1997     julong reasonable_max = phys_mem / MaxRAMFraction;
1998 
1999     if (phys_mem &lt;= MaxHeapSize * MinRAMFraction) {
2000       // Small physical memory, so use a minimum fraction of it for the heap
2001       reasonable_max = phys_mem / MinRAMFraction;
2002     } else {
2003       // Not-small physical memory, so require a heap at least
2004       // as large as MaxHeapSize
2005       reasonable_max = MAX2(reasonable_max, (julong)MaxHeapSize);
2006     }
2007     if (!FLAG_IS_DEFAULT(ErgoHeapSizeLimit) &amp;&amp; ErgoHeapSizeLimit != 0) {
2008       // Limit the heap size to ErgoHeapSizeLimit
2009       reasonable_max = MIN2(reasonable_max, (julong)ErgoHeapSizeLimit);
2010     }
2011     if (UseCompressedOops) {
2012       // Limit the heap size to the maximum possible when using compressed oops
2013       julong max_coop_heap = (julong)max_heap_for_compressed_oops();
2014 
2015       // HeapBaseMinAddress can be greater than default but not less than.
2016       if (!FLAG_IS_DEFAULT(HeapBaseMinAddress)) {
2017         if (HeapBaseMinAddress &lt; DefaultHeapBaseMinAddress) {
2018           // matches compressed oops printing flags
2019           log_debug(gc, heap, coops)("HeapBaseMinAddress must be at least " SIZE_FORMAT
2020                                      " (" SIZE_FORMAT "G) which is greater than value given " SIZE_FORMAT,
2021                                      DefaultHeapBaseMinAddress,
2022                                      DefaultHeapBaseMinAddress/G,
2023                                      HeapBaseMinAddress);
2024           FLAG_SET_ERGO(size_t, HeapBaseMinAddress, DefaultHeapBaseMinAddress);
2025         }
2026       }
2027 
2028       if (HeapBaseMinAddress + MaxHeapSize &lt; max_coop_heap) {
2029         // Heap should be above HeapBaseMinAddress to get zero based compressed oops
2030         // but it should be not less than default MaxHeapSize.
2031         max_coop_heap -= HeapBaseMinAddress;
2032       }
2033       reasonable_max = MIN2(reasonable_max, max_coop_heap);
2034     }
2035     reasonable_max = limit_by_allocatable_memory(reasonable_max);
2036 
2037     if (!FLAG_IS_DEFAULT(InitialHeapSize)) {
2038       // An initial heap size was specified on the command line,
2039       // so be sure that the maximum size is consistent.  Done
2040       // after call to limit_by_allocatable_memory because that
2041       // method might reduce the allocation size.
2042       reasonable_max = MAX2(reasonable_max, (julong)InitialHeapSize);
2043     }
2044 
2045     log_trace(gc, heap)("  Maximum heap size " SIZE_FORMAT, (size_t) reasonable_max);
2046     FLAG_SET_ERGO(size_t, MaxHeapSize, (size_t)reasonable_max);
2047   }
2048 
2049   // If the minimum or initial heap_size have not been set or requested to be set
2050   // ergonomically, set them accordingly.
2051   if (InitialHeapSize == 0 || min_heap_size() == 0) {
2052     julong reasonable_minimum = (julong)(OldSize + NewSize);
2053 
2054     reasonable_minimum = MIN2(reasonable_minimum, (julong)MaxHeapSize);
2055 
2056     reasonable_minimum = limit_by_allocatable_memory(reasonable_minimum);
2057 
2058     if (InitialHeapSize == 0) {
2059       julong reasonable_initial = phys_mem / InitialRAMFraction;
2060 
2061       reasonable_initial = MAX3(reasonable_initial, reasonable_minimum, (julong)min_heap_size());
2062       reasonable_initial = MIN2(reasonable_initial, (julong)MaxHeapSize);
2063 
2064       reasonable_initial = limit_by_allocatable_memory(reasonable_initial);
2065 
2066       log_trace(gc, heap)("  Initial heap size " SIZE_FORMAT, (size_t)reasonable_initial);
2067       FLAG_SET_ERGO(size_t, InitialHeapSize, (size_t)reasonable_initial);
2068     }
2069     // If the minimum heap size has not been set (via -Xms),
2070     // synchronize with InitialHeapSize to avoid errors with the default value.
2071     if (min_heap_size() == 0) {
2072       set_min_heap_size(MIN2((size_t)reasonable_minimum, InitialHeapSize));
2073       log_trace(gc, heap)("  Minimum heap size " SIZE_FORMAT, min_heap_size());
2074     }
2075   }
2076 }
2077 
2078 // This option inspects the machine and attempts to set various
2079 // parameters to be optimal for long-running, memory allocation
2080 // intensive jobs.  It is intended for machines with large
2081 // amounts of cpu and memory.
2082 jint Arguments::set_aggressive_heap_flags() {
2083   // initHeapSize is needed since _initial_heap_size is 4 bytes on a 32 bit
2084   // VM, but we may not be able to represent the total physical memory
2085   // available (like having 8gb of memory on a box but using a 32bit VM).
2086   // Thus, we need to make sure we're using a julong for intermediate
2087   // calculations.
2088   julong initHeapSize;
2089   julong total_memory = os::physical_memory();
2090 
2091   if (total_memory &lt; (julong) 256 * M) {
2092     jio_fprintf(defaultStream::error_stream(),
2093             "You need at least 256mb of memory to use -XX:+AggressiveHeap\n");
2094     vm_exit(1);
2095   }
2096 
2097   // The heap size is half of available memory, or (at most)
2098   // all of possible memory less 160mb (leaving room for the OS
2099   // when using ISM).  This is the maximum; because adaptive sizing
2100   // is turned on below, the actual space used may be smaller.
2101 
2102   initHeapSize = MIN2(total_memory / (julong) 2,
2103           total_memory - (julong) 160 * M);
2104 
2105   initHeapSize = limit_by_allocatable_memory(initHeapSize);
2106 
2107   if (FLAG_IS_DEFAULT(MaxHeapSize)) {
2108     if (FLAG_SET_CMDLINE(size_t, MaxHeapSize, initHeapSize) != Flag::SUCCESS) {
2109       return JNI_EINVAL;
2110     }
2111     if (FLAG_SET_CMDLINE(size_t, InitialHeapSize, initHeapSize) != Flag::SUCCESS) {
2112       return JNI_EINVAL;
2113     }
2114     // Currently the minimum size and the initial heap sizes are the same.
2115     set_min_heap_size(initHeapSize);
2116   }
2117   if (FLAG_IS_DEFAULT(NewSize)) {
2118     // Make the young generation 3/8ths of the total heap.
2119     if (FLAG_SET_CMDLINE(size_t, NewSize,
2120             ((julong) MaxHeapSize / (julong) 8) * (julong) 3) != Flag::SUCCESS) {
2121       return JNI_EINVAL;
2122     }
2123     if (FLAG_SET_CMDLINE(size_t, MaxNewSize, NewSize) != Flag::SUCCESS) {
2124       return JNI_EINVAL;
2125     }
2126   }
2127 
2128 #if !defined(_ALLBSD_SOURCE) &amp;&amp; !defined(AIX)  // UseLargePages is not yet supported on BSD and AIX.
2129   FLAG_SET_DEFAULT(UseLargePages, true);
2130 #endif
2131 
2132   // Increase some data structure sizes for efficiency
2133   if (FLAG_SET_CMDLINE(size_t, BaseFootPrintEstimate, MaxHeapSize) != Flag::SUCCESS) {
2134     return JNI_EINVAL;
2135   }
2136   if (FLAG_SET_CMDLINE(bool, ResizeTLAB, false) != Flag::SUCCESS) {
2137     return JNI_EINVAL;
2138   }
2139   if (FLAG_SET_CMDLINE(size_t, TLABSize, 256 * K) != Flag::SUCCESS) {
2140     return JNI_EINVAL;
2141   }
2142 
2143   // See the OldPLABSize comment below, but replace 'after promotion'
2144   // with 'after copying'.  YoungPLABSize is the size of the survivor
2145   // space per-gc-thread buffers.  The default is 4kw.
2146   if (FLAG_SET_CMDLINE(size_t, YoungPLABSize, 256 * K) != Flag::SUCCESS) { // Note: this is in words
2147     return JNI_EINVAL;
2148   }
2149 
2150   // OldPLABSize is the size of the buffers in the old gen that
2151   // UseParallelGC uses to promote live data that doesn't fit in the
2152   // survivor spaces.  At any given time, there's one for each gc thread.
2153   // The default size is 1kw. These buffers are rarely used, since the
2154   // survivor spaces are usually big enough.  For specjbb, however, there
2155   // are occasions when there's lots of live data in the young gen
2156   // and we end up promoting some of it.  We don't have a definite
2157   // explanation for why bumping OldPLABSize helps, but the theory
2158   // is that a bigger PLAB results in retaining something like the
2159   // original allocation order after promotion, which improves mutator
2160   // locality.  A minor effect may be that larger PLABs reduce the
2161   // number of PLAB allocation events during gc.  The value of 8kw
2162   // was arrived at by experimenting with specjbb.
2163   if (FLAG_SET_CMDLINE(size_t, OldPLABSize, 8 * K) != Flag::SUCCESS) { // Note: this is in words
2164     return JNI_EINVAL;
2165   }
2166 
2167   // Enable parallel GC and adaptive generation sizing
2168   if (FLAG_SET_CMDLINE(bool, UseParallelGC, true) != Flag::SUCCESS) {
2169     return JNI_EINVAL;
2170   }
2171   FLAG_SET_DEFAULT(ParallelGCThreads,
2172           Abstract_VM_Version::parallel_worker_threads());
2173 
2174   // Encourage steady state memory management
2175   if (FLAG_SET_CMDLINE(uintx, ThresholdTolerance, 100) != Flag::SUCCESS) {
2176     return JNI_EINVAL;
2177   }
2178 
2179   // This appears to improve mutator locality
2180   if (FLAG_SET_CMDLINE(bool, ScavengeBeforeFullGC, false) != Flag::SUCCESS) {
2181     return JNI_EINVAL;
2182   }
2183 
2184   // Get around early Solaris scheduling bug
2185   // (affinity vs other jobs on system)
2186   // but disallow DR and offlining (5008695).
2187   if (FLAG_SET_CMDLINE(bool, BindGCTaskThreadsToCPUs, true) != Flag::SUCCESS) {
2188     return JNI_EINVAL;
2189   }
2190 
2191   return JNI_OK;
2192 }
2193 
2194 // This must be called after ergonomics.
2195 void Arguments::set_bytecode_flags() {
2196   if (!RewriteBytecodes) {
2197     FLAG_SET_DEFAULT(RewriteFrequentPairs, false);
2198   }
2199 }
2200 
2201 // Aggressive optimization flags  -XX:+AggressiveOpts
2202 jint Arguments::set_aggressive_opts_flags() {
2203 #ifdef COMPILER2
2204   if (AggressiveUnboxing) {
2205     if (FLAG_IS_DEFAULT(EliminateAutoBox)) {
2206       FLAG_SET_DEFAULT(EliminateAutoBox, true);
2207     } else if (!EliminateAutoBox) {
2208       // warning("AggressiveUnboxing is disabled because EliminateAutoBox is disabled");
2209       AggressiveUnboxing = false;
2210     }
2211     if (FLAG_IS_DEFAULT(DoEscapeAnalysis)) {
2212       FLAG_SET_DEFAULT(DoEscapeAnalysis, true);
2213     } else if (!DoEscapeAnalysis) {
2214       // warning("AggressiveUnboxing is disabled because DoEscapeAnalysis is disabled");
2215       AggressiveUnboxing = false;
2216     }
2217   }
2218   if (AggressiveOpts || !FLAG_IS_DEFAULT(AutoBoxCacheMax)) {
2219     if (FLAG_IS_DEFAULT(EliminateAutoBox)) {
2220       FLAG_SET_DEFAULT(EliminateAutoBox, true);
2221     }
2222     if (FLAG_IS_DEFAULT(AutoBoxCacheMax)) {
2223       FLAG_SET_DEFAULT(AutoBoxCacheMax, 20000);
2224     }
2225 
2226     // Feed the cache size setting into the JDK
2227     char buffer[1024];
2228     sprintf(buffer, "java.lang.Integer.IntegerCache.high=" INTX_FORMAT, AutoBoxCacheMax);
2229     if (!add_property(buffer)) {
2230       return JNI_ENOMEM;
2231     }
2232   }
2233   if (AggressiveOpts &amp;&amp; FLAG_IS_DEFAULT(BiasedLockingStartupDelay)) {
2234     FLAG_SET_DEFAULT(BiasedLockingStartupDelay, 500);
2235   }
2236 #endif
2237 
2238   if (AggressiveOpts) {
2239 // Sample flag setting code
2240 //    if (FLAG_IS_DEFAULT(EliminateZeroing)) {
2241 //      FLAG_SET_DEFAULT(EliminateZeroing, true);
2242 //    }
2243   }
2244 
2245   return JNI_OK;
2246 }
2247 
2248 //===========================================================================================================
2249 // Parsing of java.compiler property
2250 
2251 void Arguments::process_java_compiler_argument(const char* arg) {
2252   // For backwards compatibility, Djava.compiler=NONE or ""
2253   // causes us to switch to -Xint mode UNLESS -Xdebug
2254   // is also specified.
2255   if (strlen(arg) == 0 || strcasecmp(arg, "NONE") == 0) {
2256     set_java_compiler(true);    // "-Djava.compiler[=...]" most recently seen.
2257   }
2258 }
2259 
2260 void Arguments::process_java_launcher_argument(const char* launcher, void* extra_info) {
2261   _sun_java_launcher = os::strdup_check_oom(launcher);
2262 }
2263 
2264 bool Arguments::created_by_java_launcher() {
2265   assert(_sun_java_launcher != NULL, "property must have value");
2266   return strcmp(DEFAULT_JAVA_LAUNCHER, _sun_java_launcher) != 0;
2267 }
2268 
2269 bool Arguments::sun_java_launcher_is_altjvm() {
2270   return _sun_java_launcher_is_altjvm;
2271 }
2272 
2273 //===========================================================================================================
2274 // Parsing of main arguments
2275 
2276 #if INCLUDE_JVMCI
2277 // Check consistency of jvmci vm argument settings.
2278 bool Arguments::check_jvmci_args_consistency() {
2279   if (!EnableJVMCI &amp;&amp; !JVMCIGlobals::check_jvmci_flags_are_consistent()) {
2280     JVMCIGlobals::print_jvmci_args_inconsistency_error_message();
2281     return false;
2282   }
2283   return true;
2284 }
2285 #endif //INCLUDE_JVMCI
2286 
2287 // Check consistency of GC selection
2288 bool Arguments::check_gc_consistency() {
2289   // Ensure that the user has not selected conflicting sets
2290   // of collectors.
2291   uint i = 0;
2292   if (UseSerialGC)                       i++;
2293   if (UseConcMarkSweepGC)                i++;
2294   if (UseParallelGC || UseParallelOldGC) i++;
2295   if (UseG1GC)                           i++;
2296   if (i &gt; 1) {
2297     jio_fprintf(defaultStream::error_stream(),
2298                 "Conflicting collector combinations in option list; "
2299                 "please refer to the release notes for the combinations "
2300                 "allowed\n");
2301     return false;
2302   }
2303 
2304   if (UseConcMarkSweepGC &amp;&amp; !UseParNewGC) {
2305     jio_fprintf(defaultStream::error_stream(),
2306         "It is not possible to combine the DefNew young collector with the CMS collector.\n");
2307     return false;
2308   }
2309 
2310   if (UseParNewGC &amp;&amp; !UseConcMarkSweepGC) {
2311     jio_fprintf(defaultStream::error_stream(),
2312         "It is not possible to combine the ParNew young collector with any collector other than CMS.\n");
2313     return false;
2314   }
2315 
2316   return true;
2317 }
2318 
2319 // Check the consistency of vm_init_args
2320 bool Arguments::check_vm_args_consistency() {
2321   // Method for adding checks for flag consistency.
2322   // The intent is to warn the user of all possible conflicts,
2323   // before returning an error.
2324   // Note: Needs platform-dependent factoring.
2325   bool status = true;
2326 
2327   if (TLABRefillWasteFraction == 0) {
2328     jio_fprintf(defaultStream::error_stream(),
2329                 "TLABRefillWasteFraction should be a denominator, "
2330                 "not " SIZE_FORMAT "\n",
2331                 TLABRefillWasteFraction);
2332     status = false;
2333   }
2334 
2335   if (FullGCALot &amp;&amp; FLAG_IS_DEFAULT(MarkSweepAlwaysCompactCount)) {
2336     MarkSweepAlwaysCompactCount = 1;  // Move objects every gc.
2337   }
2338 
2339   if (!(UseParallelGC || UseParallelOldGC) &amp;&amp; FLAG_IS_DEFAULT(ScavengeBeforeFullGC)) {
2340     FLAG_SET_DEFAULT(ScavengeBeforeFullGC, false);
2341   }
2342 
2343   if (GCTimeLimit == 100) {
2344     // Turn off gc-overhead-limit-exceeded checks
2345     FLAG_SET_DEFAULT(UseGCOverheadLimit, false);
2346   }
2347 
2348   status = status &amp;&amp; check_gc_consistency();
2349 
2350   // CMS space iteration, which FLSVerifyAllHeapreferences entails,
2351   // insists that we hold the requisite locks so that the iteration is
2352   // MT-safe. For the verification at start-up and shut-down, we don't
2353   // yet have a good way of acquiring and releasing these locks,
2354   // which are not visible at the CollectedHeap level. We want to
2355   // be able to acquire these locks and then do the iteration rather
2356   // than just disable the lock verification. This will be fixed under
2357   // bug 4788986.
2358   if (UseConcMarkSweepGC &amp;&amp; FLSVerifyAllHeapReferences) {
2359     if (VerifyDuringStartup) {
2360       warning("Heap verification at start-up disabled "
2361               "(due to current incompatibility with FLSVerifyAllHeapReferences)");
2362       VerifyDuringStartup = false; // Disable verification at start-up
2363     }
2364 
2365     if (VerifyBeforeExit) {
2366       warning("Heap verification at shutdown disabled "
2367               "(due to current incompatibility with FLSVerifyAllHeapReferences)");
2368       VerifyBeforeExit = false; // Disable verification at shutdown
2369     }
2370   }
2371 
2372   if (PrintNMTStatistics) {
2373 #if INCLUDE_NMT
2374     if (MemTracker::tracking_level() == NMT_off) {
2375 #endif // INCLUDE_NMT
2376       warning("PrintNMTStatistics is disabled, because native memory tracking is not enabled");
2377       PrintNMTStatistics = false;
2378 #if INCLUDE_NMT
2379     }
2380 #endif
2381   }
2382 #if INCLUDE_JVMCI
2383 
2384   status = status &amp;&amp; check_jvmci_args_consistency();
2385 
2386   if (EnableJVMCI) {
2387     if (!ScavengeRootsInCode) {
2388       warning("forcing ScavengeRootsInCode non-zero because JVMCI is enabled");
2389       ScavengeRootsInCode = 1;
2390     }
2391     if (FLAG_IS_DEFAULT(TypeProfileLevel)) {
2392       TypeProfileLevel = 0;
2393     }
2394     if (UseJVMCICompiler) {
2395       if (FLAG_IS_DEFAULT(TypeProfileWidth)) {
2396         TypeProfileWidth = 8;
2397       }
2398     }
2399   }
2400 #endif
2401 
2402   // Check lower bounds of the code cache
2403   // Template Interpreter code is approximately 3X larger in debug builds.
2404   uint min_code_cache_size = CodeCacheMinimumUseSpace DEBUG_ONLY(* 3);
2405   if (InitialCodeCacheSize &lt; (uintx)os::vm_page_size()) {
2406     jio_fprintf(defaultStream::error_stream(),
2407                 "Invalid InitialCodeCacheSize=%dK. Must be at least %dK.\n", InitialCodeCacheSize/K,
2408                 os::vm_page_size()/K);
2409     status = false;
2410   } else if (ReservedCodeCacheSize &lt; InitialCodeCacheSize) {
2411     jio_fprintf(defaultStream::error_stream(),
2412                 "Invalid ReservedCodeCacheSize: %dK. Must be at least InitialCodeCacheSize=%dK.\n",
2413                 ReservedCodeCacheSize/K, InitialCodeCacheSize/K);
2414     status = false;
2415   } else if (ReservedCodeCacheSize &lt; min_code_cache_size) {
2416     jio_fprintf(defaultStream::error_stream(),
2417                 "Invalid ReservedCodeCacheSize=%dK. Must be at least %uK.\n", ReservedCodeCacheSize/K,
2418                 min_code_cache_size/K);
2419     status = false;
2420   } else if (ReservedCodeCacheSize &gt; CODE_CACHE_SIZE_LIMIT) {
2421     // Code cache size larger than CODE_CACHE_SIZE_LIMIT is not supported.
2422     jio_fprintf(defaultStream::error_stream(),
2423                 "Invalid ReservedCodeCacheSize=%dM. Must be at most %uM.\n", ReservedCodeCacheSize/M,
2424                 CODE_CACHE_SIZE_LIMIT/M);
2425     status = false;
2426   } else if (NonNMethodCodeHeapSize &lt; min_code_cache_size) {
2427     jio_fprintf(defaultStream::error_stream(),
2428                 "Invalid NonNMethodCodeHeapSize=%dK. Must be at least %uK.\n", NonNMethodCodeHeapSize/K,
2429                 min_code_cache_size/K);
2430     status = false;
2431   }
2432 
2433 #ifdef _LP64
2434   if (!FLAG_IS_DEFAULT(CICompilerCount) &amp;&amp; !FLAG_IS_DEFAULT(CICompilerCountPerCPU) &amp;&amp; CICompilerCountPerCPU) {
2435     warning("The VM option CICompilerCountPerCPU overrides CICompilerCount.");
2436   }
2437 #endif
2438 
2439 #ifndef SUPPORT_RESERVED_STACK_AREA
2440   if (StackReservedPages != 0) {
2441     FLAG_SET_CMDLINE(intx, StackReservedPages, 0);
2442     warning("Reserved Stack Area not supported on this platform");
2443   }
2444 #endif
2445 
2446   if (BackgroundCompilation &amp;&amp; (CompileTheWorld || ReplayCompiles)) {
2447     if (!FLAG_IS_DEFAULT(BackgroundCompilation)) {
2448       warning("BackgroundCompilation disabled due to CompileTheWorld or ReplayCompiles options.");
2449     }
2450     FLAG_SET_CMDLINE(bool, BackgroundCompilation, false);
2451   }
2452   if (UseCompiler &amp;&amp; is_interpreter_only()) {
2453     if (!FLAG_IS_DEFAULT(UseCompiler)) {
2454       warning("UseCompiler disabled due to -Xint.");
2455     }
2456     FLAG_SET_CMDLINE(bool, UseCompiler, false);
2457   }
2458 #ifdef COMPILER2
2459   if (PostLoopMultiversioning &amp;&amp; !RangeCheckElimination) {
2460     if (!FLAG_IS_DEFAULT(PostLoopMultiversioning)) {
2461       warning("PostLoopMultiversioning disabled because RangeCheckElimination is disabled.");
2462     }
2463     FLAG_SET_CMDLINE(bool, PostLoopMultiversioning, false);
2464   }
2465 #endif
2466   return status;
2467 }
2468 
2469 bool Arguments::is_bad_option(const JavaVMOption* option, jboolean ignore,
2470   const char* option_type) {
2471   if (ignore) return false;
2472 
2473   const char* spacer = " ";
2474   if (option_type == NULL) {
2475     option_type = ++spacer; // Set both to the empty string.
2476   }
2477 
2478   if (os::obsolete_option(option)) {
2479     jio_fprintf(defaultStream::error_stream(),
2480                 "Obsolete %s%soption: %s\n", option_type, spacer,
2481       option-&gt;optionString);
2482     return false;
2483   } else {
2484     jio_fprintf(defaultStream::error_stream(),
2485                 "Unrecognized %s%soption: %s\n", option_type, spacer,
2486       option-&gt;optionString);
2487     return true;
2488   }
2489 }
2490 
2491 static const char* user_assertion_options[] = {
2492   "-da", "-ea", "-disableassertions", "-enableassertions", 0
2493 };
2494 
2495 static const char* system_assertion_options[] = {
2496   "-dsa", "-esa", "-disablesystemassertions", "-enablesystemassertions", 0
2497 };
2498 
2499 bool Arguments::parse_uintx(const char* value,
2500                             uintx* uintx_arg,
2501                             uintx min_size) {
2502 
2503   // Check the sign first since atojulong() parses only unsigned values.
2504   bool value_is_positive = !(*value == '-');
2505 
2506   if (value_is_positive) {
2507     julong n;
2508     bool good_return = atojulong(value, &amp;n);
2509     if (good_return) {
2510       bool above_minimum = n &gt;= min_size;
2511       bool value_is_too_large = n &gt; max_uintx;
2512 
2513       if (above_minimum &amp;&amp; !value_is_too_large) {
2514         *uintx_arg = n;
2515         return true;
2516       }
2517     }
2518   }
2519   return false;
2520 }
2521 
2522 Arguments::ArgsRange Arguments::parse_memory_size(const char* s,
2523                                                   julong* long_arg,
2524                                                   julong min_size) {
2525   if (!atojulong(s, long_arg)) return arg_unreadable;
2526   return check_memory_size(*long_arg, min_size);
2527 }
2528 
2529 // Parse JavaVMInitArgs structure
2530 
2531 jint Arguments::parse_vm_init_args(const JavaVMInitArgs *java_tool_options_args,
2532                                    const JavaVMInitArgs *java_options_args,
2533                                    const JavaVMInitArgs *cmd_line_args) {
2534   bool xpatch_javabase = false;
2535 
2536   // Save default settings for some mode flags
2537   Arguments::_AlwaysCompileLoopMethods = AlwaysCompileLoopMethods;
2538   Arguments::_UseOnStackReplacement    = UseOnStackReplacement;
2539   Arguments::_ClipInlining             = ClipInlining;
2540   Arguments::_BackgroundCompilation    = BackgroundCompilation;
2541   if (TieredCompilation) {
2542     Arguments::_Tier3InvokeNotifyFreqLog = Tier3InvokeNotifyFreqLog;
2543     Arguments::_Tier4InvocationThreshold = Tier4InvocationThreshold;
2544   }
2545 
2546   // Setup flags for mixed which is the default
2547   set_mode_flags(_mixed);
2548 
2549   // Parse args structure generated from JAVA_TOOL_OPTIONS environment
2550   // variable (if present).
2551   jint result = parse_each_vm_init_arg(java_tool_options_args, &amp;xpatch_javabase, Flag::ENVIRON_VAR);
2552   if (result != JNI_OK) {
2553     return result;
2554   }
2555 
2556   // Parse args structure generated from the command line flags.
2557   result = parse_each_vm_init_arg(cmd_line_args, &amp;xpatch_javabase, Flag::COMMAND_LINE);
2558   if (result != JNI_OK) {
2559     return result;
2560   }
2561 
2562   // Parse args structure generated from the _JAVA_OPTIONS environment
2563   // variable (if present) (mimics classic VM)
2564   result = parse_each_vm_init_arg(java_options_args, &amp;xpatch_javabase, Flag::ENVIRON_VAR);
2565   if (result != JNI_OK) {
2566     return result;
2567   }
2568 
2569   // Do final processing now that all arguments have been parsed
2570   result = finalize_vm_init_args();
2571   if (result != JNI_OK) {
2572     return result;
2573   }
2574 
2575   return JNI_OK;
2576 }
2577 
2578 // Checks if name in command-line argument -agent{lib,path}:name[=options]
2579 // represents a valid JDWP agent.  is_path==true denotes that we
2580 // are dealing with -agentpath (case where name is a path), otherwise with
2581 // -agentlib
2582 bool valid_jdwp_agent(char *name, bool is_path) {
2583   char *_name;
2584   const char *_jdwp = "jdwp";
2585   size_t _len_jdwp, _len_prefix;
2586 
2587   if (is_path) {
2588     if ((_name = strrchr(name, (int) *os::file_separator())) == NULL) {
2589       return false;
2590     }
2591 
2592     _name++;  // skip past last path separator
2593     _len_prefix = strlen(JNI_LIB_PREFIX);
2594 
2595     if (strncmp(_name, JNI_LIB_PREFIX, _len_prefix) != 0) {
2596       return false;
2597     }
2598 
2599     _name += _len_prefix;
2600     _len_jdwp = strlen(_jdwp);
2601 
2602     if (strncmp(_name, _jdwp, _len_jdwp) == 0) {
2603       _name += _len_jdwp;
2604     }
2605     else {
2606       return false;
2607     }
2608 
2609     if (strcmp(_name, JNI_LIB_SUFFIX) != 0) {
2610       return false;
2611     }
2612 
2613     return true;
2614   }
2615 
2616   if (strcmp(name, _jdwp) == 0) {
2617     return true;
2618   }
2619 
2620   return false;
2621 }
2622 
2623 jint Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* xpatch_javabase, Flag::Flags origin) {
2624   // For match_option to return remaining or value part of option string
2625   const char* tail;
2626 
2627   // iterate over arguments
2628   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
2629     bool is_absolute_path = false;  // for -agentpath vs -agentlib
2630 
2631     const JavaVMOption* option = args-&gt;options + index;
2632 
2633     if (!match_option(option, "-Djava.class.path", &amp;tail) &amp;&amp;
2634         !match_option(option, "-Dsun.java.command", &amp;tail) &amp;&amp;
2635         !match_option(option, "-Dsun.java.launcher", &amp;tail)) {
2636 
2637         // add all jvm options to the jvm_args string. This string
2638         // is used later to set the java.vm.args PerfData string constant.
2639         // the -Djava.class.path and the -Dsun.java.command options are
2640         // omitted from jvm_args string as each have their own PerfData
2641         // string constant object.
2642         build_jvm_args(option-&gt;optionString);
2643     }
2644 
2645     // -verbose:[class/gc/jni]
2646     if (match_option(option, "-verbose", &amp;tail)) {
2647       if (!strcmp(tail, ":class") || !strcmp(tail, "")) {
2648         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, load));
2649         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, unload));
2650       } else if (!strcmp(tail, ":gc")) {
2651         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(gc));
2652       } else if (!strcmp(tail, ":jni")) {
2653         if (FLAG_SET_CMDLINE(bool, PrintJNIResolving, true) != Flag::SUCCESS) {
2654           return JNI_EINVAL;
2655         }
2656       }
2657     // -da / -ea / -disableassertions / -enableassertions
2658     // These accept an optional class/package name separated by a colon, e.g.,
2659     // -da:java.lang.Thread.
2660     } else if (match_option(option, user_assertion_options, &amp;tail, true)) {
2661       bool enable = option-&gt;optionString[1] == 'e';     // char after '-' is 'e'
2662       if (*tail == '\0') {
2663         JavaAssertions::setUserClassDefault(enable);
2664       } else {
2665         assert(*tail == ':', "bogus match by match_option()");
2666         JavaAssertions::addOption(tail + 1, enable);
2667       }
2668     // -dsa / -esa / -disablesystemassertions / -enablesystemassertions
2669     } else if (match_option(option, system_assertion_options, &amp;tail, false)) {
2670       bool enable = option-&gt;optionString[1] == 'e';     // char after '-' is 'e'
2671       JavaAssertions::setSystemClassDefault(enable);
2672     // -bootclasspath:
2673     } else if (match_option(option, "-Xbootclasspath:", &amp;tail)) {
2674         jio_fprintf(defaultStream::output_stream(),
2675           "-Xbootclasspath is no longer a supported option.\n");
2676         return JNI_EINVAL;
2677     // -bootclasspath/a:
2678     } else if (match_option(option, "-Xbootclasspath/a:", &amp;tail)) {
2679       Arguments::set_bootclassloader_append_index((int)strlen(Arguments::get_sysclasspath())+1);
2680       Arguments::append_sysclasspath(tail);
2681     // -bootclasspath/p:
2682     } else if (match_option(option, "-Xbootclasspath/p:", &amp;tail)) {
2683         jio_fprintf(defaultStream::output_stream(),
2684           "-Xbootclasspath/p is no longer a supported option.\n");
2685         return JNI_EINVAL;
2686     // -Xrun
2687     } else if (match_option(option, "-Xrun", &amp;tail)) {
2688       if (tail != NULL) {
2689         const char* pos = strchr(tail, ':');
2690         size_t len = (pos == NULL) ? strlen(tail) : pos - tail;
2691         char* name = (char*)memcpy(NEW_C_HEAP_ARRAY(char, len + 1, mtArguments), tail, len);
2692         name[len] = '\0';
2693 
2694         char *options = NULL;
2695         if(pos != NULL) {
2696           size_t len2 = strlen(pos+1) + 1; // options start after ':'.  Final zero must be copied.
2697           options = (char*)memcpy(NEW_C_HEAP_ARRAY(char, len2, mtArguments), pos+1, len2);
2698         }
2699 #if !INCLUDE_JVMTI
2700         if (strcmp(name, "jdwp") == 0) {
2701           jio_fprintf(defaultStream::error_stream(),
2702             "Debugging agents are not supported in this VM\n");
2703           return JNI_ERR;
2704         }
2705 #endif // !INCLUDE_JVMTI
2706         add_init_library(name, options);
2707       }
2708     // -agentlib and -agentpath
2709     } else if (match_option(option, "-agentlib:", &amp;tail) ||
2710           (is_absolute_path = match_option(option, "-agentpath:", &amp;tail))) {
2711       if(tail != NULL) {
2712         const char* pos = strchr(tail, '=');
2713         size_t len = (pos == NULL) ? strlen(tail) : pos - tail;
2714         char* name = strncpy(NEW_C_HEAP_ARRAY(char, len + 1, mtArguments), tail, len);
2715         name[len] = '\0';
2716 
2717         char *options = NULL;
2718         if(pos != NULL) {
2719           options = os::strdup_check_oom(pos + 1, mtArguments);
2720         }
2721 #if !INCLUDE_JVMTI
2722         if (valid_jdwp_agent(name, is_absolute_path)) {
2723           jio_fprintf(defaultStream::error_stream(),
2724             "Debugging agents are not supported in this VM\n");
2725           return JNI_ERR;
2726         }
2727 #endif // !INCLUDE_JVMTI
2728         add_init_agent(name, options, is_absolute_path);
2729       }
2730     // -javaagent
2731     } else if (match_option(option, "-javaagent:", &amp;tail)) {
2732 #if !INCLUDE_JVMTI
2733       jio_fprintf(defaultStream::error_stream(),
2734         "Instrumentation agents are not supported in this VM\n");
2735       return JNI_ERR;
2736 #else
2737       if (tail != NULL) {
2738         char *options = strcpy(NEW_C_HEAP_ARRAY(char, strlen(tail) + 1, mtArguments), tail);
2739         add_init_agent("instrument", options, false);
2740         // java agents need module java.instrument
2741         if (!Arguments::append_to_addmods_property("java.instrument")) {
2742           return JNI_ENOMEM;
2743         }
2744       }
2745 #endif // !INCLUDE_JVMTI
2746     // -Xnoclassgc
2747     } else if (match_option(option, "-Xnoclassgc")) {
2748       if (FLAG_SET_CMDLINE(bool, ClassUnloading, false) != Flag::SUCCESS) {
2749         return JNI_EINVAL;
2750       }
2751     // -Xconcgc
2752     } else if (match_option(option, "-Xconcgc")) {
2753       if (FLAG_SET_CMDLINE(bool, UseConcMarkSweepGC, true) != Flag::SUCCESS) {
2754         return JNI_EINVAL;
2755       }
2756     // -Xnoconcgc
2757     } else if (match_option(option, "-Xnoconcgc")) {
2758       if (FLAG_SET_CMDLINE(bool, UseConcMarkSweepGC, false) != Flag::SUCCESS) {
2759         return JNI_EINVAL;
2760       }
2761     // -Xbatch
2762     } else if (match_option(option, "-Xbatch")) {
2763       if (FLAG_SET_CMDLINE(bool, BackgroundCompilation, false) != Flag::SUCCESS) {
2764         return JNI_EINVAL;
2765       }
2766     // -Xmn for compatibility with other JVM vendors
2767     } else if (match_option(option, "-Xmn", &amp;tail)) {
2768       julong long_initial_young_size = 0;
2769       ArgsRange errcode = parse_memory_size(tail, &amp;long_initial_young_size, 1);
2770       if (errcode != arg_in_range) {
2771         jio_fprintf(defaultStream::error_stream(),
2772                     "Invalid initial young generation size: %s\n", option-&gt;optionString);
2773         describe_range_error(errcode);
2774         return JNI_EINVAL;
2775       }
2776       if (FLAG_SET_CMDLINE(size_t, MaxNewSize, (size_t)long_initial_young_size) != Flag::SUCCESS) {
2777         return JNI_EINVAL;
2778       }
2779       if (FLAG_SET_CMDLINE(size_t, NewSize, (size_t)long_initial_young_size) != Flag::SUCCESS) {
2780         return JNI_EINVAL;
2781       }
2782     // -Xms
2783     } else if (match_option(option, "-Xms", &amp;tail)) {
2784       julong long_initial_heap_size = 0;
2785       // an initial heap size of 0 means automatically determine
2786       ArgsRange errcode = parse_memory_size(tail, &amp;long_initial_heap_size, 0);
2787       if (errcode != arg_in_range) {
2788         jio_fprintf(defaultStream::error_stream(),
2789                     "Invalid initial heap size: %s\n", option-&gt;optionString);
2790         describe_range_error(errcode);
2791         return JNI_EINVAL;
2792       }
2793       set_min_heap_size((size_t)long_initial_heap_size);
2794       // Currently the minimum size and the initial heap sizes are the same.
2795       // Can be overridden with -XX:InitialHeapSize.
2796       if (FLAG_SET_CMDLINE(size_t, InitialHeapSize, (size_t)long_initial_heap_size) != Flag::SUCCESS) {
2797         return JNI_EINVAL;
2798       }
2799     // -Xmx
2800     } else if (match_option(option, "-Xmx", &amp;tail) || match_option(option, "-XX:MaxHeapSize=", &amp;tail)) {
2801       julong long_max_heap_size = 0;
2802       ArgsRange errcode = parse_memory_size(tail, &amp;long_max_heap_size, 1);
2803       if (errcode != arg_in_range) {
2804         jio_fprintf(defaultStream::error_stream(),
2805                     "Invalid maximum heap size: %s\n", option-&gt;optionString);
2806         describe_range_error(errcode);
2807         return JNI_EINVAL;
2808       }
2809       if (FLAG_SET_CMDLINE(size_t, MaxHeapSize, (size_t)long_max_heap_size) != Flag::SUCCESS) {
2810         return JNI_EINVAL;
2811       }
2812     // Xmaxf
2813     } else if (match_option(option, "-Xmaxf", &amp;tail)) {
2814       char* err;
2815       int maxf = (int)(strtod(tail, &amp;err) * 100);
2816       if (*err != '\0' || *tail == '\0') {
2817         jio_fprintf(defaultStream::error_stream(),
2818                     "Bad max heap free percentage size: %s\n",
2819                     option-&gt;optionString);
2820         return JNI_EINVAL;
2821       } else {
2822         if (FLAG_SET_CMDLINE(uintx, MaxHeapFreeRatio, maxf) != Flag::SUCCESS) {
2823             return JNI_EINVAL;
2824         }
2825       }
2826     // Xminf
2827     } else if (match_option(option, "-Xminf", &amp;tail)) {
2828       char* err;
2829       int minf = (int)(strtod(tail, &amp;err) * 100);
2830       if (*err != '\0' || *tail == '\0') {
2831         jio_fprintf(defaultStream::error_stream(),
2832                     "Bad min heap free percentage size: %s\n",
2833                     option-&gt;optionString);
2834         return JNI_EINVAL;
2835       } else {
2836         if (FLAG_SET_CMDLINE(uintx, MinHeapFreeRatio, minf) != Flag::SUCCESS) {
2837           return JNI_EINVAL;
2838         }
2839       }
2840     // -Xss
2841     } else if (match_option(option, "-Xss", &amp;tail)) {
2842       julong long_ThreadStackSize = 0;
2843       ArgsRange errcode = parse_memory_size(tail, &amp;long_ThreadStackSize, 1000);
2844       if (errcode != arg_in_range) {
2845         jio_fprintf(defaultStream::error_stream(),
2846                     "Invalid thread stack size: %s\n", option-&gt;optionString);
2847         describe_range_error(errcode);
2848         return JNI_EINVAL;
2849       }
2850       // Internally track ThreadStackSize in units of 1024 bytes.
2851       if (FLAG_SET_CMDLINE(intx, ThreadStackSize,
2852                        round_to((int)long_ThreadStackSize, K) / K) != Flag::SUCCESS) {
2853         return JNI_EINVAL;
2854       }
2855     // -Xoss, -Xsqnopause, -Xoptimize, -Xboundthreads, -Xusealtsigs
2856     } else if (match_option(option, "-Xoss", &amp;tail) ||
2857                match_option(option, "-Xsqnopause") ||
2858                match_option(option, "-Xoptimize") ||
2859                match_option(option, "-Xboundthreads") ||
2860                match_option(option, "-Xusealtsigs")) {
2861       // All these options are deprecated in JDK 9 and will be removed in a future release
2862       char version[256];
2863       JDK_Version::jdk(9).to_string(version, sizeof(version));
2864       warning("Ignoring option %s; support was removed in %s", option-&gt;optionString, version);
2865     } else if (match_option(option, "-XX:CodeCacheExpansionSize=", &amp;tail)) {
2866       julong long_CodeCacheExpansionSize = 0;
2867       ArgsRange errcode = parse_memory_size(tail, &amp;long_CodeCacheExpansionSize, os::vm_page_size());
2868       if (errcode != arg_in_range) {
2869         jio_fprintf(defaultStream::error_stream(),
2870                    "Invalid argument: %s. Must be at least %luK.\n", option-&gt;optionString,
2871                    os::vm_page_size()/K);
2872         return JNI_EINVAL;
2873       }
2874       if (FLAG_SET_CMDLINE(uintx, CodeCacheExpansionSize, (uintx)long_CodeCacheExpansionSize) != Flag::SUCCESS) {
2875         return JNI_EINVAL;
2876       }
2877     } else if (match_option(option, "-Xmaxjitcodesize", &amp;tail) ||
2878                match_option(option, "-XX:ReservedCodeCacheSize=", &amp;tail)) {
2879       julong long_ReservedCodeCacheSize = 0;
2880 
2881       ArgsRange errcode = parse_memory_size(tail, &amp;long_ReservedCodeCacheSize, 1);
2882       if (errcode != arg_in_range) {
2883         jio_fprintf(defaultStream::error_stream(),
2884                     "Invalid maximum code cache size: %s.\n", option-&gt;optionString);
2885         return JNI_EINVAL;
2886       }
2887       if (FLAG_SET_CMDLINE(uintx, ReservedCodeCacheSize, (uintx)long_ReservedCodeCacheSize) != Flag::SUCCESS) {
2888         return JNI_EINVAL;
2889       }
2890       // -XX:NonNMethodCodeHeapSize=
2891     } else if (match_option(option, "-XX:NonNMethodCodeHeapSize=", &amp;tail)) {
2892       julong long_NonNMethodCodeHeapSize = 0;
2893 
2894       ArgsRange errcode = parse_memory_size(tail, &amp;long_NonNMethodCodeHeapSize, 1);
2895       if (errcode != arg_in_range) {
2896         jio_fprintf(defaultStream::error_stream(),
2897                     "Invalid maximum non-nmethod code heap size: %s.\n", option-&gt;optionString);
2898         return JNI_EINVAL;
2899       }
2900       if (FLAG_SET_CMDLINE(uintx, NonNMethodCodeHeapSize, (uintx)long_NonNMethodCodeHeapSize) != Flag::SUCCESS) {
2901         return JNI_EINVAL;
2902       }
2903       // -XX:ProfiledCodeHeapSize=
2904     } else if (match_option(option, "-XX:ProfiledCodeHeapSize=", &amp;tail)) {
2905       julong long_ProfiledCodeHeapSize = 0;
2906 
2907       ArgsRange errcode = parse_memory_size(tail, &amp;long_ProfiledCodeHeapSize, 1);
2908       if (errcode != arg_in_range) {
2909         jio_fprintf(defaultStream::error_stream(),
2910                     "Invalid maximum profiled code heap size: %s.\n", option-&gt;optionString);
2911         return JNI_EINVAL;
2912       }
2913       if (FLAG_SET_CMDLINE(uintx, ProfiledCodeHeapSize, (uintx)long_ProfiledCodeHeapSize) != Flag::SUCCESS) {
2914         return JNI_EINVAL;
2915       }
2916       // -XX:NonProfiledCodeHeapSizee=
2917     } else if (match_option(option, "-XX:NonProfiledCodeHeapSize=", &amp;tail)) {
2918       julong long_NonProfiledCodeHeapSize = 0;
2919 
2920       ArgsRange errcode = parse_memory_size(tail, &amp;long_NonProfiledCodeHeapSize, 1);
2921       if (errcode != arg_in_range) {
2922         jio_fprintf(defaultStream::error_stream(),
2923                     "Invalid maximum non-profiled code heap size: %s.\n", option-&gt;optionString);
2924         return JNI_EINVAL;
2925       }
2926       if (FLAG_SET_CMDLINE(uintx, NonProfiledCodeHeapSize, (uintx)long_NonProfiledCodeHeapSize) != Flag::SUCCESS) {
2927         return JNI_EINVAL;
2928       }
2929     // -green
2930     } else if (match_option(option, "-green")) {
2931       jio_fprintf(defaultStream::error_stream(),
2932                   "Green threads support not available\n");
2933           return JNI_EINVAL;
2934     // -native
2935     } else if (match_option(option, "-native")) {
2936           // HotSpot always uses native threads, ignore silently for compatibility
2937     // -Xrs
2938     } else if (match_option(option, "-Xrs")) {
2939           // Classic/EVM option, new functionality
2940       if (FLAG_SET_CMDLINE(bool, ReduceSignalUsage, true) != Flag::SUCCESS) {
2941         return JNI_EINVAL;
2942       }
2943     // -Xprof
2944     } else if (match_option(option, "-Xprof")) {
2945 #if INCLUDE_FPROF
2946       _has_profile = true;
2947 #else // INCLUDE_FPROF
2948       jio_fprintf(defaultStream::error_stream(),
2949         "Flat profiling is not supported in this VM.\n");
2950       return JNI_ERR;
2951 #endif // INCLUDE_FPROF
2952     // -Xconcurrentio
2953     } else if (match_option(option, "-Xconcurrentio")) {
2954       if (FLAG_SET_CMDLINE(bool, UseLWPSynchronization, true) != Flag::SUCCESS) {
2955         return JNI_EINVAL;
2956       }
2957       if (FLAG_SET_CMDLINE(bool, BackgroundCompilation, false) != Flag::SUCCESS) {
2958         return JNI_EINVAL;
2959       }
2960       if (FLAG_SET_CMDLINE(intx, DeferThrSuspendLoopCount, 1) != Flag::SUCCESS) {
2961         return JNI_EINVAL;
2962       }
2963       if (FLAG_SET_CMDLINE(bool, UseTLAB, false) != Flag::SUCCESS) {
2964         return JNI_EINVAL;
2965       }
2966       if (FLAG_SET_CMDLINE(size_t, NewSizeThreadIncrease, 16 * K) != Flag::SUCCESS) {  // 20Kb per thread added to new generation
2967         return JNI_EINVAL;
2968       }
2969 
2970       // -Xinternalversion
2971     } else if (match_option(option, "-Xinternalversion")) {
2972       jio_fprintf(defaultStream::output_stream(), "%s\n",
2973                   VM_Version::internal_vm_info_string());
2974       vm_exit(0);
2975 #ifndef PRODUCT
2976     // -Xprintflags
2977     } else if (match_option(option, "-Xprintflags")) {
2978       CommandLineFlags::printFlags(tty, false);
2979       vm_exit(0);
2980 #endif
2981     // -D
2982     } else if (match_option(option, "-D", &amp;tail)) {
2983       const char* value;
2984       if (match_option(option, "-Djava.endorsed.dirs=", &amp;value) &amp;&amp;
2985             *value!= '\0' &amp;&amp; strcmp(value, "\"\"") != 0) {
2986         // abort if -Djava.endorsed.dirs is set
2987         jio_fprintf(defaultStream::output_stream(),
2988           "-Djava.endorsed.dirs=%s is not supported. Endorsed standards and standalone APIs\n"
2989           "in modular form will be supported via the concept of upgradeable modules.\n", value);
2990         return JNI_EINVAL;
2991       }
2992       if (match_option(option, "-Djava.ext.dirs=", &amp;value) &amp;&amp;
2993             *value != '\0' &amp;&amp; strcmp(value, "\"\"") != 0) {
2994         // abort if -Djava.ext.dirs is set
2995         jio_fprintf(defaultStream::output_stream(),
2996           "-Djava.ext.dirs=%s is not supported.  Use -classpath instead.\n", value);
2997         return JNI_EINVAL;
2998       }
2999 
3000       if (!add_property(tail)) {
3001         return JNI_ENOMEM;
3002       }
3003       // Out of the box management support
3004       if (match_option(option, "-Dcom.sun.management", &amp;tail)) {
3005 #if INCLUDE_MANAGEMENT
3006         if (FLAG_SET_CMDLINE(bool, ManagementServer, true) != Flag::SUCCESS) {
3007           return JNI_EINVAL;
3008         }
3009         // management agent in module java.management
3010         if (!Arguments::append_to_addmods_property("java.management")) {
3011           return JNI_ENOMEM;
3012         }
3013 #else
3014         jio_fprintf(defaultStream::output_stream(),
3015           "-Dcom.sun.management is not supported in this VM.\n");
3016         return JNI_ERR;
3017 #endif
3018       }
3019       if (match_option(option, "-Djdk.launcher.patch.", &amp;tail)) {
3020         // -Djdk.launcher.patch.#=&lt;module&gt;=&lt;file&gt;(&lt;pathsep&gt;&lt;file&gt;)*
3021         // The number, #, specified will be increasing with each -Xpatch
3022         // specified on the command line.
3023         // Pick up module name, following the -D property's equal sign.
3024         const char* property_equal = strchr(tail, '=');
3025         if (property_equal == NULL) {
3026           jio_fprintf(defaultStream::output_stream(), "Missing '=' in -Xpatch specification\n");
3027           return JNI_ERR;
3028         } else {
3029           // Find the equal sign between the module name and the path specification
3030           const char* module_equal = strchr(property_equal + 1, '=');
3031           if (module_equal == NULL) {
3032             jio_fprintf(defaultStream::output_stream(), "Bad value for -Xpatch, no module name specified\n");
3033             return JNI_ERR;
3034           } else {
3035             // Pick out the module name, in between the two equal signs
3036             size_t module_len = module_equal - property_equal - 1;
3037             char* module_name = NEW_C_HEAP_ARRAY(char, module_len+1, mtArguments);
3038             memcpy(module_name, property_equal + 1, module_len);
3039             *(module_name + module_len) = '\0';
3040             // The path piece begins one past the module_equal sign
3041             Arguments::add_xpatchprefix(module_name, module_equal + 1, xpatch_javabase);
3042             FREE_C_HEAP_ARRAY(char, module_name);
3043           }
3044         }
3045       }
3046     // -Xint
3047     } else if (match_option(option, "-Xint")) {
3048           set_mode_flags(_int);
3049     // -Xmixed
3050     } else if (match_option(option, "-Xmixed")) {
3051           set_mode_flags(_mixed);
3052     // -Xcomp
3053     } else if (match_option(option, "-Xcomp")) {
3054       // for testing the compiler; turn off all flags that inhibit compilation
3055           set_mode_flags(_comp);
3056     // -Xshare:dump
3057     } else if (match_option(option, "-Xshare:dump")) {
3058       if (FLAG_SET_CMDLINE(bool, DumpSharedSpaces, true) != Flag::SUCCESS) {
3059         return JNI_EINVAL;
3060       }
3061       set_mode_flags(_int);     // Prevent compilation, which creates objects
3062     // -Xshare:on
3063     } else if (match_option(option, "-Xshare:on")) {
3064       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3065         return JNI_EINVAL;
3066       }
3067       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, true) != Flag::SUCCESS) {
3068         return JNI_EINVAL;
3069       }
3070     // -Xshare:auto
3071     } else if (match_option(option, "-Xshare:auto")) {
3072       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3073         return JNI_EINVAL;
3074       }
3075       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, false) != Flag::SUCCESS) {
3076         return JNI_EINVAL;
3077       }
3078     // -Xshare:off
3079     } else if (match_option(option, "-Xshare:off")) {
3080       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, false) != Flag::SUCCESS) {
3081         return JNI_EINVAL;
3082       }
3083       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, false) != Flag::SUCCESS) {
3084         return JNI_EINVAL;
3085       }
3086     // -Xverify
3087     } else if (match_option(option, "-Xverify", &amp;tail)) {
3088       if (strcmp(tail, ":all") == 0 || strcmp(tail, "") == 0) {
3089         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, true) != Flag::SUCCESS) {
3090           return JNI_EINVAL;
3091         }
3092         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true) != Flag::SUCCESS) {
3093           return JNI_EINVAL;
3094         }
3095       } else if (strcmp(tail, ":remote") == 0) {
3096         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false) != Flag::SUCCESS) {
3097           return JNI_EINVAL;
3098         }
3099         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true) != Flag::SUCCESS) {
3100           return JNI_EINVAL;
3101         }
3102       } else if (strcmp(tail, ":none") == 0) {
3103         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false) != Flag::SUCCESS) {
3104           return JNI_EINVAL;
3105         }
3106         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, false) != Flag::SUCCESS) {
3107           return JNI_EINVAL;
3108         }
3109       } else if (is_bad_option(option, args-&gt;ignoreUnrecognized, "verification")) {
3110         return JNI_EINVAL;
3111       }
3112     // -Xdebug
3113     } else if (match_option(option, "-Xdebug")) {
3114       // note this flag has been used, then ignore
3115       set_xdebug_mode(true);
3116     // -Xnoagent
3117     } else if (match_option(option, "-Xnoagent")) {
3118       // For compatibility with classic. HotSpot refuses to load the old style agent.dll.
3119     } else if (match_option(option, "-Xloggc:", &amp;tail)) {
3120       // Deprecated flag to redirect GC output to a file. -Xloggc:&lt;filename&gt;
3121       log_warning(gc)("-Xloggc is deprecated. Will use -Xlog:gc:%s instead.", tail);
3122       _gc_log_filename = os::strdup_check_oom(tail);
3123     } else if (match_option(option, "-Xlog", &amp;tail)) {
3124       bool ret = false;
3125       if (strcmp(tail, ":help") == 0) {
3126         LogConfiguration::print_command_line_help(defaultStream::output_stream());
3127         vm_exit(0);
3128       } else if (strcmp(tail, ":disable") == 0) {
3129         LogConfiguration::disable_logging();
3130         ret = true;
3131       } else if (*tail == '\0') {
3132         ret = LogConfiguration::parse_command_line_arguments();
3133         assert(ret, "-Xlog without arguments should never fail to parse");
3134       } else if (*tail == ':') {
3135         ret = LogConfiguration::parse_command_line_arguments(tail + 1);
3136       }
3137       if (ret == false) {
3138         jio_fprintf(defaultStream::error_stream(),
3139                     "Invalid -Xlog option '-Xlog%s'\n",
3140                     tail);
3141         return JNI_EINVAL;
3142       }
3143     // JNI hooks
3144     } else if (match_option(option, "-Xcheck", &amp;tail)) {
3145       if (!strcmp(tail, ":jni")) {
3146 #if !INCLUDE_JNI_CHECK
3147         warning("JNI CHECKING is not supported in this VM");
3148 #else
3149         CheckJNICalls = true;
3150 #endif // INCLUDE_JNI_CHECK
3151       } else if (is_bad_option(option, args-&gt;ignoreUnrecognized,
3152                                      "check")) {
3153         return JNI_EINVAL;
3154       }
3155     } else if (match_option(option, "vfprintf")) {
3156       _vfprintf_hook = CAST_TO_FN_PTR(vfprintf_hook_t, option-&gt;extraInfo);
3157     } else if (match_option(option, "exit")) {
3158       _exit_hook = CAST_TO_FN_PTR(exit_hook_t, option-&gt;extraInfo);
3159     } else if (match_option(option, "abort")) {
3160       _abort_hook = CAST_TO_FN_PTR(abort_hook_t, option-&gt;extraInfo);
3161     // -XX:+AggressiveHeap
3162     } else if (match_option(option, "-XX:+AggressiveHeap")) {
3163       jint result = set_aggressive_heap_flags();
3164       if (result != JNI_OK) {
3165           return result;
3166       }
3167     // Need to keep consistency of MaxTenuringThreshold and AlwaysTenure/NeverTenure;
3168     // and the last option wins.
3169     } else if (match_option(option, "-XX:+NeverTenure")) {
3170       if (FLAG_SET_CMDLINE(bool, NeverTenure, true) != Flag::SUCCESS) {
3171         return JNI_EINVAL;
3172       }
3173       if (FLAG_SET_CMDLINE(bool, AlwaysTenure, false) != Flag::SUCCESS) {
3174         return JNI_EINVAL;
3175       }
3176       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, markOopDesc::max_age + 1) != Flag::SUCCESS) {
3177         return JNI_EINVAL;
3178       }
3179     } else if (match_option(option, "-XX:+AlwaysTenure")) {
3180       if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3181         return JNI_EINVAL;
3182       }
3183       if (FLAG_SET_CMDLINE(bool, AlwaysTenure, true) != Flag::SUCCESS) {
3184         return JNI_EINVAL;
3185       }
3186       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, 0) != Flag::SUCCESS) {
3187         return JNI_EINVAL;
3188       }
3189     } else if (match_option(option, "-XX:MaxTenuringThreshold=", &amp;tail)) {
3190       uintx max_tenuring_thresh = 0;
3191       if (!parse_uintx(tail, &amp;max_tenuring_thresh, 0)) {
3192         jio_fprintf(defaultStream::error_stream(),
3193                     "Improperly specified VM option \'MaxTenuringThreshold=%s\'\n", tail);
3194         return JNI_EINVAL;
3195       }
3196 
3197       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, max_tenuring_thresh) != Flag::SUCCESS) {
3198         return JNI_EINVAL;
3199       }
3200 
3201       if (MaxTenuringThreshold == 0) {
3202         if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3203           return JNI_EINVAL;
3204         }
3205         if (FLAG_SET_CMDLINE(bool, AlwaysTenure, true) != Flag::SUCCESS) {
3206           return JNI_EINVAL;
3207         }
3208       } else {
3209         if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3210           return JNI_EINVAL;
3211         }
3212         if (FLAG_SET_CMDLINE(bool, AlwaysTenure, false) != Flag::SUCCESS) {
3213           return JNI_EINVAL;
3214         }
3215       }
3216     } else if (match_option(option, "-XX:+DisplayVMOutputToStderr")) {
3217       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStdout, false) != Flag::SUCCESS) {
3218         return JNI_EINVAL;
3219       }
3220       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStderr, true) != Flag::SUCCESS) {
3221         return JNI_EINVAL;
3222       }
3223     } else if (match_option(option, "-XX:+DisplayVMOutputToStdout")) {
3224       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStderr, false) != Flag::SUCCESS) {
3225         return JNI_EINVAL;
3226       }
3227       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStdout, true) != Flag::SUCCESS) {
3228         return JNI_EINVAL;
3229       }
3230     } else if (match_option(option, "-XX:+ExtendedDTraceProbes")) {
3231 #if defined(DTRACE_ENABLED)
3232       if (FLAG_SET_CMDLINE(bool, ExtendedDTraceProbes, true) != Flag::SUCCESS) {
3233         return JNI_EINVAL;
3234       }
3235       if (FLAG_SET_CMDLINE(bool, DTraceMethodProbes, true) != Flag::SUCCESS) {
3236         return JNI_EINVAL;
3237       }
3238       if (FLAG_SET_CMDLINE(bool, DTraceAllocProbes, true) != Flag::SUCCESS) {
3239         return JNI_EINVAL;
3240       }
3241       if (FLAG_SET_CMDLINE(bool, DTraceMonitorProbes, true) != Flag::SUCCESS) {
3242         return JNI_EINVAL;
3243       }
3244 #else // defined(DTRACE_ENABLED)
3245       jio_fprintf(defaultStream::error_stream(),
3246                   "ExtendedDTraceProbes flag is not applicable for this configuration\n");
3247       return JNI_EINVAL;
3248 #endif // defined(DTRACE_ENABLED)
3249 #ifdef ASSERT
3250     } else if (match_option(option, "-XX:+FullGCALot")) {
3251       if (FLAG_SET_CMDLINE(bool, FullGCALot, true) != Flag::SUCCESS) {
3252         return JNI_EINVAL;
3253       }
3254       // disable scavenge before parallel mark-compact
3255       if (FLAG_SET_CMDLINE(bool, ScavengeBeforeFullGC, false) != Flag::SUCCESS) {
3256         return JNI_EINVAL;
3257       }
3258 #endif
3259 #if !INCLUDE_MANAGEMENT
3260     } else if (match_option(option, "-XX:+ManagementServer")) {
3261         jio_fprintf(defaultStream::error_stream(),
3262           "ManagementServer is not supported in this VM.\n");
3263         return JNI_ERR;
3264 #endif // INCLUDE_MANAGEMENT
3265     } else if (match_option(option, "-XX:", &amp;tail)) { // -XX:xxxx
3266       // Skip -XX:Flags= and -XX:VMOptionsFile= since those cases have
3267       // already been handled
3268       if ((strncmp(tail, "Flags=", strlen("Flags=")) != 0) &amp;&amp;
3269           (strncmp(tail, "VMOptionsFile=", strlen("VMOptionsFile=")) != 0)) {
3270         if (!process_argument(tail, args-&gt;ignoreUnrecognized, origin)) {
3271           return JNI_EINVAL;
3272         }
3273       }
3274     // Unknown option
3275     } else if (is_bad_option(option, args-&gt;ignoreUnrecognized)) {
3276       return JNI_ERR;
3277     }
3278   }
3279 
3280   // PrintSharedArchiveAndExit will turn on
3281   //   -Xshare:on
3282   //   -Xlog:class+path=info
3283   if (PrintSharedArchiveAndExit) {
3284     if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3285       return JNI_EINVAL;
3286     }
3287     if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, true) != Flag::SUCCESS) {
3288       return JNI_EINVAL;
3289     }
3290     LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, path));
3291   }
3292 
3293   // Change the default value for flags  which have different default values
3294   // when working with older JDKs.
3295 #ifdef LINUX
3296  if (JDK_Version::current().compare_major(6) &lt;= 0 &amp;&amp;
3297       FLAG_IS_DEFAULT(UseLinuxPosixThreadCPUClocks)) {
3298     FLAG_SET_DEFAULT(UseLinuxPosixThreadCPUClocks, false);
3299   }
3300 #endif // LINUX
3301   fix_appclasspath();
3302   return JNI_OK;
3303 }
3304 
3305 void Arguments::add_xpatchprefix(const char* module_name, const char* path, bool* xpatch_javabase) {
3306   // For java.base check for duplicate -Xpatch options being specified on the command line.
3307   // This check is only required for java.base, all other duplicate module specifications
3308   // will be checked during module system initialization.  The module system initialization
3309   // will throw an ExceptionInInitializerError if this situation occurs.
3310   if (strcmp(module_name, "java.base") == 0) {
3311     if (*xpatch_javabase) {
3312       vm_exit_during_initialization("Cannot specify java.base more than once to -Xpatch");
3313     } else {
3314       *xpatch_javabase = true;
3315     }
3316   }
3317 
3318   // Create GrowableArray lazily, only if -Xpatch has been specified
3319   if (_xpatchprefix == NULL) {
3320     _xpatchprefix = new (ResourceObj::C_HEAP, mtArguments) GrowableArray&lt;ModuleXPatchPath*&gt;(10, true);
3321   }
3322 
3323   _xpatchprefix-&gt;push(new ModuleXPatchPath(module_name, path));
3324 }
3325 
3326 // Set property jdk.boot.class.path.append to the contents of the bootclasspath
3327 // that follows either the jimage file or exploded module directories.  The
3328 // property will contain -Xbootclasspath/a and/or jvmti appended additions.
3329 void Arguments::set_jdkbootclasspath_append() {
3330   char *sysclasspath = get_sysclasspath();
3331   assert(sysclasspath != NULL, "NULL sysclasspath");
3332   int bcp_a_idx = bootclassloader_append_index();
3333   if (bcp_a_idx != -1 &amp;&amp; bcp_a_idx &lt; (int)strlen(sysclasspath)) {
3334     _jdk_boot_class_path_append-&gt;set_value(sysclasspath + bcp_a_idx);
3335   }
3336 }
3337 
3338 // Remove all empty paths from the app classpath (if IgnoreEmptyClassPaths is enabled)
3339 //
3340 // This is necessary because some apps like to specify classpath like -cp foo.jar:${XYZ}:bar.jar
3341 // in their start-up scripts. If XYZ is empty, the classpath will look like "-cp foo.jar::bar.jar".
3342 // Java treats such empty paths as if the user specified "-cp foo.jar:.:bar.jar". I.e., an empty
3343 // path is treated as the current directory.
3344 //
3345 // This causes problems with CDS, which requires that all directories specified in the classpath
3346 // must be empty. In most cases, applications do NOT want to load classes from the current
3347 // directory anyway. Adding -XX:+IgnoreEmptyClassPaths will make these applications' start-up
3348 // scripts compatible with CDS.
3349 void Arguments::fix_appclasspath() {
3350   if (IgnoreEmptyClassPaths) {
3351     const char separator = *os::path_separator();
3352     const char* src = _java_class_path-&gt;value();
3353 
3354     // skip over all the leading empty paths
3355     while (*src == separator) {
3356       src ++;
3357     }
3358 
3359     char* copy = os::strdup_check_oom(src, mtArguments);
3360 
3361     // trim all trailing empty paths
3362     for (char* tail = copy + strlen(copy) - 1; tail &gt;= copy &amp;&amp; *tail == separator; tail--) {
3363       *tail = '\0';
3364     }
3365 
3366     char from[3] = {separator, separator, '\0'};
3367     char to  [2] = {separator, '\0'};
3368     while (StringUtils::replace_no_expand(copy, from, to) &gt; 0) {
3369       // Keep replacing "::" -&gt; ":" until we have no more "::" (non-windows)
3370       // Keep replacing ";;" -&gt; ";" until we have no more ";;" (windows)
3371     }
3372 
3373     _java_class_path-&gt;set_writeable_value(copy);
3374     FreeHeap(copy); // a copy was made by set_value, so don't need this anymore
3375   }
3376 }
3377 
3378 static bool has_jar_files(const char* directory) {
3379   DIR* dir = os::opendir(directory);
3380   if (dir == NULL) return false;
3381 
3382   struct dirent *entry;
3383   char *dbuf = NEW_C_HEAP_ARRAY(char, os::readdir_buf_size(directory), mtArguments);
3384   bool hasJarFile = false;
3385   while (!hasJarFile &amp;&amp; (entry = os::readdir(dir, (dirent *) dbuf)) != NULL) {
3386     const char* name = entry-&gt;d_name;
3387     const char* ext = name + strlen(name) - 4;
3388     hasJarFile = ext &gt; name &amp;&amp; (os::file_name_strcmp(ext, ".jar") == 0);
3389   }
3390   FREE_C_HEAP_ARRAY(char, dbuf);
3391   os::closedir(dir);
3392   return hasJarFile ;
3393 }
3394 
3395 static int check_non_empty_dirs(const char* path) {
3396   const char separator = *os::path_separator();
3397   const char* const end = path + strlen(path);
3398   int nonEmptyDirs = 0;
3399   while (path &lt; end) {
3400     const char* tmp_end = strchr(path, separator);
3401     if (tmp_end == NULL) {
3402       if (has_jar_files(path)) {
3403         nonEmptyDirs++;
3404         jio_fprintf(defaultStream::output_stream(),
3405           "Non-empty directory: %s\n", path);
3406       }
3407       path = end;
3408     } else {
3409       char* dirpath = NEW_C_HEAP_ARRAY(char, tmp_end - path + 1, mtArguments);
3410       memcpy(dirpath, path, tmp_end - path);
3411       dirpath[tmp_end - path] = '\0';
3412       if (has_jar_files(dirpath)) {
3413         nonEmptyDirs++;
3414         jio_fprintf(defaultStream::output_stream(),
3415           "Non-empty directory: %s\n", dirpath);
3416       }
3417       FREE_C_HEAP_ARRAY(char, dirpath);
3418       path = tmp_end + 1;
3419     }
3420   }
3421   return nonEmptyDirs;
3422 }
3423 
3424 jint Arguments::finalize_vm_init_args() {
3425   // check if the default lib/endorsed directory exists; if so, error
3426   char path[JVM_MAXPATHLEN];
3427   const char* fileSep = os::file_separator();
3428   sprintf(path, "%s%slib%sendorsed", Arguments::get_java_home(), fileSep, fileSep);
3429 
3430   if (CheckEndorsedAndExtDirs) {
3431     int nonEmptyDirs = 0;
3432     // check endorsed directory
3433     nonEmptyDirs += check_non_empty_dirs(path);
3434     // check the extension directories
3435     nonEmptyDirs += check_non_empty_dirs(Arguments::get_ext_dirs());
3436     if (nonEmptyDirs &gt; 0) {
3437       return JNI_ERR;
3438     }
3439   }
3440 
3441   DIR* dir = os::opendir(path);
3442   if (dir != NULL) {
3443     jio_fprintf(defaultStream::output_stream(),
3444       "&lt;JAVA_HOME&gt;/lib/endorsed is not supported. Endorsed standards and standalone APIs\n"
3445       "in modular form will be supported via the concept of upgradeable modules.\n");
3446     os::closedir(dir);
3447     return JNI_ERR;
3448   }
3449 
3450   sprintf(path, "%s%slib%sext", Arguments::get_java_home(), fileSep, fileSep);
3451   dir = os::opendir(path);
3452   if (dir != NULL) {
3453     jio_fprintf(defaultStream::output_stream(),
3454       "&lt;JAVA_HOME&gt;/lib/ext exists, extensions mechanism no longer supported; "
3455       "Use -classpath instead.\n.");
3456     os::closedir(dir);
3457     return JNI_ERR;
3458   }
3459 
3460   Arguments::set_bootclassloader_append_index(((int)strlen(Arguments::get_sysclasspath()))+1);
3461 
3462   // This must be done after all arguments have been processed.
3463   // java_compiler() true means set to "NONE" or empty.
3464   if (java_compiler() &amp;&amp; !xdebug_mode()) {
3465     // For backwards compatibility, we switch to interpreted mode if
3466     // -Djava.compiler="NONE" or "" is specified AND "-Xdebug" was
3467     // not specified.
3468     set_mode_flags(_int);
3469   }
3470 
3471   // CompileThresholdScaling == 0.0 is same as -Xint: Disable compilation (enable interpreter-only mode),
3472   // but like -Xint, leave compilation thresholds unaffected.
3473   // With tiered compilation disabled, setting CompileThreshold to 0 disables compilation as well.
3474   if ((CompileThresholdScaling == 0.0) || (!TieredCompilation &amp;&amp; CompileThreshold == 0)) {
3475     set_mode_flags(_int);
3476   }
3477 
3478   // eventually fix up InitialTenuringThreshold if only MaxTenuringThreshold is set
3479   if (FLAG_IS_DEFAULT(InitialTenuringThreshold) &amp;&amp; (InitialTenuringThreshold &gt; MaxTenuringThreshold)) {
3480     FLAG_SET_ERGO(uintx, InitialTenuringThreshold, MaxTenuringThreshold);
3481   }
3482 
3483 #if !defined(COMPILER2) &amp;&amp; !INCLUDE_JVMCI
3484   // Don't degrade server performance for footprint
3485   if (FLAG_IS_DEFAULT(UseLargePages) &amp;&amp;
3486       MaxHeapSize &lt; LargePageHeapSizeThreshold) {
3487     // No need for large granularity pages w/small heaps.
3488     // Note that large pages are enabled/disabled for both the
3489     // Java heap and the code cache.
3490     FLAG_SET_DEFAULT(UseLargePages, false);
3491   }
3492 
3493 #elif defined(COMPILER2)
3494   if (!FLAG_IS_DEFAULT(OptoLoopAlignment) &amp;&amp; FLAG_IS_DEFAULT(MaxLoopPad)) {
3495     FLAG_SET_DEFAULT(MaxLoopPad, OptoLoopAlignment-1);
3496   }
3497 #endif
3498 
3499 #if !defined(COMPILER2) &amp;&amp; !INCLUDE_JVMCI
3500   UNSUPPORTED_OPTION(ProfileInterpreter);
3501   NOT_PRODUCT(UNSUPPORTED_OPTION(TraceProfileInterpreter));
3502 #endif
3503 
3504 #ifndef TIERED
3505   // Tiered compilation is undefined.
3506   UNSUPPORTED_OPTION(TieredCompilation);
3507 #endif
3508 
3509 #if INCLUDE_JVMCI
3510   if (EnableJVMCI &amp;&amp; !append_to_addmods_property("jdk.vm.ci")) {
3511     return JNI_ENOMEM;
3512   }
3513 #endif
3514 
3515   // If we are running in a headless jre, force java.awt.headless property
3516   // to be true unless the property has already been set.
3517   // Also allow the OS environment variable JAVA_AWT_HEADLESS to set headless state.
3518   if (os::is_headless_jre()) {
3519     const char* headless = Arguments::get_property("java.awt.headless");
3520     if (headless == NULL) {
3521       const char *headless_env = ::getenv("JAVA_AWT_HEADLESS");
3522       if (headless_env == NULL) {
3523         if (!add_property("java.awt.headless=true")) {
3524           return JNI_ENOMEM;
3525         }
3526       } else {
3527         char buffer[256];
3528         jio_snprintf(buffer, sizeof(buffer), "java.awt.headless=%s", headless_env);
3529         if (!add_property(buffer)) {
3530           return JNI_ENOMEM;
3531         }
3532       }
3533     }
3534   }
3535 
3536   if (UseConcMarkSweepGC &amp;&amp; FLAG_IS_DEFAULT(UseParNewGC) &amp;&amp; !UseParNewGC) {
3537     // CMS can only be used with ParNew
3538     FLAG_SET_ERGO(bool, UseParNewGC, true);
3539   }
3540 
3541   if (!check_vm_args_consistency()) {
3542     return JNI_ERR;
3543   }
3544 
3545   return JNI_OK;
3546 }
3547 
3548 // Helper class for controlling the lifetime of JavaVMInitArgs
3549 // objects.  The contents of the JavaVMInitArgs are guaranteed to be
3550 // deleted on the destruction of the ScopedVMInitArgs object.
3551 class ScopedVMInitArgs : public StackObj {
3552  private:
3553   JavaVMInitArgs _args;
3554   char*          _container_name;
3555   bool           _is_set;
3556   char*          _vm_options_file_arg;
3557 
3558  public:
3559   ScopedVMInitArgs(const char *container_name) {
3560     _args.version = JNI_VERSION_1_2;
3561     _args.nOptions = 0;
3562     _args.options = NULL;
3563     _args.ignoreUnrecognized = false;
3564     _container_name = (char *)container_name;
3565     _is_set = false;
3566     _vm_options_file_arg = NULL;
3567   }
3568 
3569   // Populates the JavaVMInitArgs object represented by this
3570   // ScopedVMInitArgs object with the arguments in options.  The
3571   // allocated memory is deleted by the destructor.  If this method
3572   // returns anything other than JNI_OK, then this object is in a
3573   // partially constructed state, and should be abandoned.
3574   jint set_args(GrowableArray&lt;JavaVMOption&gt;* options) {
3575     _is_set = true;
3576     JavaVMOption* options_arr = NEW_C_HEAP_ARRAY_RETURN_NULL(
3577         JavaVMOption, options-&gt;length(), mtArguments);
3578     if (options_arr == NULL) {
3579       return JNI_ENOMEM;
3580     }
3581     _args.options = options_arr;
3582 
3583     for (int i = 0; i &lt; options-&gt;length(); i++) {
3584       options_arr[i] = options-&gt;at(i);
3585       options_arr[i].optionString = os::strdup(options_arr[i].optionString);
3586       if (options_arr[i].optionString == NULL) {
3587         // Rely on the destructor to do cleanup.
3588         _args.nOptions = i;
3589         return JNI_ENOMEM;
3590       }
3591     }
3592 
3593     _args.nOptions = options-&gt;length();
3594     _args.ignoreUnrecognized = IgnoreUnrecognizedVMOptions;
3595     return JNI_OK;
3596   }
3597 
3598   JavaVMInitArgs* get()             { return &amp;_args; }
3599   char* container_name()            { return _container_name; }
3600   bool  is_set()                    { return _is_set; }
3601   bool  found_vm_options_file_arg() { return _vm_options_file_arg != NULL; }
3602   char* vm_options_file_arg()       { return _vm_options_file_arg; }
3603 
3604   void set_vm_options_file_arg(const char *vm_options_file_arg) {
3605     if (_vm_options_file_arg != NULL) {
3606       os::free(_vm_options_file_arg);
3607     }
3608     _vm_options_file_arg = os::strdup_check_oom(vm_options_file_arg);
3609   }
3610 
3611   ~ScopedVMInitArgs() {
3612     if (_vm_options_file_arg != NULL) {
3613       os::free(_vm_options_file_arg);
3614     }
3615     if (_args.options == NULL) return;
3616     for (int i = 0; i &lt; _args.nOptions; i++) {
3617       os::free(_args.options[i].optionString);
3618     }
3619     FREE_C_HEAP_ARRAY(JavaVMOption, _args.options);
3620   }
3621 
3622   // Insert options into this option list, to replace option at
3623   // vm_options_file_pos (-XX:VMOptionsFile)
3624   jint insert(const JavaVMInitArgs* args,
3625               const JavaVMInitArgs* args_to_insert,
3626               const int vm_options_file_pos) {
3627     assert(_args.options == NULL, "shouldn't be set yet");
3628     assert(args_to_insert-&gt;nOptions != 0, "there should be args to insert");
3629     assert(vm_options_file_pos != -1, "vm_options_file_pos should be set");
3630 
3631     int length = args-&gt;nOptions + args_to_insert-&gt;nOptions - 1;
3632     GrowableArray&lt;JavaVMOption&gt; *options = new (ResourceObj::C_HEAP, mtArguments)
3633               GrowableArray&lt;JavaVMOption&gt;(length, true);    // Construct new option array
3634     for (int i = 0; i &lt; args-&gt;nOptions; i++) {
3635       if (i == vm_options_file_pos) {
3636         // insert the new options starting at the same place as the
3637         // -XX:VMOptionsFile option
3638         for (int j = 0; j &lt; args_to_insert-&gt;nOptions; j++) {
3639           options-&gt;push(args_to_insert-&gt;options[j]);
3640         }
3641       } else {
3642         options-&gt;push(args-&gt;options[i]);
3643       }
3644     }
3645     // make into options array
3646     jint result = set_args(options);
3647     delete options;
3648     return result;
3649   }
3650 };
3651 
3652 jint Arguments::parse_java_options_environment_variable(ScopedVMInitArgs* args) {
3653   return parse_options_environment_variable("_JAVA_OPTIONS", args);
3654 }
3655 
3656 jint Arguments::parse_java_tool_options_environment_variable(ScopedVMInitArgs* args) {
3657   return parse_options_environment_variable("JAVA_TOOL_OPTIONS", args);
3658 }
3659 
3660 jint Arguments::parse_options_environment_variable(const char* name,
3661                                                    ScopedVMInitArgs* vm_args) {
3662   char *buffer = ::getenv(name);
3663 
3664   // Don't check this environment variable if user has special privileges
3665   // (e.g. unix su command).
3666   if (buffer == NULL || os::have_special_privileges()) {
3667     return JNI_OK;
3668   }
3669 
3670   if ((buffer = os::strdup(buffer)) == NULL) {
3671     return JNI_ENOMEM;
3672   }
3673 
3674   int retcode = parse_options_buffer(name, buffer, strlen(buffer), vm_args);
3675 
3676   os::free(buffer);
3677   return retcode;
3678 }
3679 
3680 jint Arguments::parse_vm_options_file(const char* file_name, ScopedVMInitArgs* vm_args) {
3681   // read file into buffer
3682   int fd = ::open(file_name, O_RDONLY);
3683   if (fd &lt; 0) {
3684     jio_fprintf(defaultStream::error_stream(),
3685                 "Could not open options file '%s'\n",
3686                 file_name);
3687     return JNI_ERR;
3688   }
3689 
3690   struct stat stbuf;
3691   int retcode = os::stat(file_name, &amp;stbuf);
3692   if (retcode != 0) {
3693     jio_fprintf(defaultStream::error_stream(),
3694                 "Could not stat options file '%s'\n",
3695                 file_name);
3696     os::close(fd);
3697     return JNI_ERR;
3698   }
3699 
3700   if (stbuf.st_size == 0) {
3701     // tell caller there is no option data and that is ok
3702     os::close(fd);
3703     return JNI_OK;
3704   }
3705 
3706   // '+ 1' for NULL termination even with max bytes
3707   size_t bytes_alloc = stbuf.st_size + 1;
3708 
3709   char *buf = NEW_C_HEAP_ARRAY_RETURN_NULL(char, bytes_alloc, mtArguments);
3710   if (NULL == buf) {
3711     jio_fprintf(defaultStream::error_stream(),
3712                 "Could not allocate read buffer for options file parse\n");
3713     os::close(fd);
3714     return JNI_ENOMEM;
3715   }
3716 
3717   memset(buf, 0, bytes_alloc);
3718 
3719   // Fill buffer
3720   // Use ::read() instead of os::read because os::read()
3721   // might do a thread state transition
3722   // and it is too early for that here
3723 
3724   ssize_t bytes_read = ::read(fd, (void *)buf, (unsigned)bytes_alloc);
3725   os::close(fd);
3726   if (bytes_read &lt; 0) {
3727     FREE_C_HEAP_ARRAY(char, buf);
3728     jio_fprintf(defaultStream::error_stream(),
3729                 "Could not read options file '%s'\n", file_name);
3730     return JNI_ERR;
3731   }
3732 
3733   if (bytes_read == 0) {
3734     // tell caller there is no option data and that is ok
3735     FREE_C_HEAP_ARRAY(char, buf);
3736     return JNI_OK;
3737   }
3738 
3739   retcode = parse_options_buffer(file_name, buf, bytes_read, vm_args);
3740 
3741   FREE_C_HEAP_ARRAY(char, buf);
3742   return retcode;
3743 }
3744 
3745 jint Arguments::parse_options_buffer(const char* name, char* buffer, const size_t buf_len, ScopedVMInitArgs* vm_args) {
3746   GrowableArray&lt;JavaVMOption&gt; *options = new (ResourceObj::C_HEAP, mtArguments) GrowableArray&lt;JavaVMOption&gt;(2, true);    // Construct option array
3747 
3748   // some pointers to help with parsing
3749   char *buffer_end = buffer + buf_len;
3750   char *opt_hd = buffer;
3751   char *wrt = buffer;
3752   char *rd = buffer;
3753 
3754   // parse all options
3755   while (rd &lt; buffer_end) {
3756     // skip leading white space from the input string
3757     while (rd &lt; buffer_end &amp;&amp; isspace(*rd)) {
3758       rd++;
3759     }
3760 
3761     if (rd &gt;= buffer_end) {
3762       break;
3763     }
3764 
3765     // Remember this is where we found the head of the token.
3766     opt_hd = wrt;
3767 
3768     // Tokens are strings of non white space characters separated
3769     // by one or more white spaces.
3770     while (rd &lt; buffer_end &amp;&amp; !isspace(*rd)) {
3771       if (*rd == '\'' || *rd == '"') {      // handle a quoted string
3772         int quote = *rd;                    // matching quote to look for
3773         rd++;                               // don't copy open quote
3774         while (rd &lt; buffer_end &amp;&amp; *rd != quote) {
3775                                             // include everything (even spaces)
3776                                             // up until the close quote
3777           *wrt++ = *rd++;                   // copy to option string
3778         }
3779 
3780         if (rd &lt; buffer_end) {
3781           rd++;                             // don't copy close quote
3782         } else {
3783                                             // did not see closing quote
3784           jio_fprintf(defaultStream::error_stream(),
3785                       "Unmatched quote in %s\n", name);
3786           delete options;
3787           return JNI_ERR;
3788         }
3789       } else {
3790         *wrt++ = *rd++;                     // copy to option string
3791       }
3792     }
3793 
3794     // steal a white space character and set it to NULL
3795     *wrt++ = '\0';
3796     // We now have a complete token
3797 
3798     JavaVMOption option;
3799     option.optionString = opt_hd;
3800     option.extraInfo = NULL;
3801 
3802     options-&gt;append(option);                // Fill in option
3803 
3804     rd++;  // Advance to next character
3805   }
3806 
3807   // Fill out JavaVMInitArgs structure.
3808   jint status = vm_args-&gt;set_args(options);
3809 
3810   delete options;
3811   return status;
3812 }
3813 
3814 void Arguments::set_shared_spaces_flags() {
3815   if (DumpSharedSpaces) {
3816     if (Arguments::get_xpatchprefix() != NULL) {
3817       vm_exit_during_initialization(
3818         "Cannot use the following option when dumping the shared archive", "-Xpatch");
3819     }
3820 
3821     if (RequireSharedSpaces) {
3822       warning("Cannot dump shared archive while using shared archive");
3823     }
3824     UseSharedSpaces = false;
3825 #ifdef _LP64
3826     if (!UseCompressedOops || !UseCompressedClassPointers) {
3827       vm_exit_during_initialization(
3828         "Cannot dump shared archive when UseCompressedOops or UseCompressedClassPointers is off.", NULL);
3829     }
3830   } else {
3831     if (!UseCompressedOops || !UseCompressedClassPointers) {
3832       no_shared_spaces("UseCompressedOops and UseCompressedClassPointers must be on for UseSharedSpaces.");
3833     }
3834 #endif
3835   }
3836 }
3837 
3838 // Sharing support
3839 // Construct the path to the archive
3840 static char* get_shared_archive_path() {
3841   char *shared_archive_path;
3842   if (SharedArchiveFile == NULL) {
3843     char jvm_path[JVM_MAXPATHLEN];
3844     os::jvm_path(jvm_path, sizeof(jvm_path));
3845     char *end = strrchr(jvm_path, *os::file_separator());
3846     if (end != NULL) *end = '\0';
3847     size_t jvm_path_len = strlen(jvm_path);
3848     size_t file_sep_len = strlen(os::file_separator());
3849     const size_t len = jvm_path_len + file_sep_len + 20;
3850     shared_archive_path = NEW_C_HEAP_ARRAY(char, len, mtArguments);
3851     if (shared_archive_path != NULL) {
3852       jio_snprintf(shared_archive_path, len, "%s%sclasses.jsa",
3853         jvm_path, os::file_separator());
3854     }
3855   } else {
3856     shared_archive_path = os::strdup_check_oom(SharedArchiveFile, mtArguments);
3857   }
3858   return shared_archive_path;
3859 }
3860 
3861 #ifndef PRODUCT
3862 // Determine whether LogVMOutput should be implicitly turned on.
3863 static bool use_vm_log() {
3864   if (LogCompilation || !FLAG_IS_DEFAULT(LogFile) ||
3865       PrintCompilation || PrintInlining || PrintDependencies || PrintNativeNMethods ||
3866       PrintDebugInfo || PrintRelocations || PrintNMethods || PrintExceptionHandlers ||
3867       PrintAssembly || TraceDeoptimization || TraceDependencies ||
3868       (VerifyDependencies &amp;&amp; FLAG_IS_CMDLINE(VerifyDependencies))) {
3869     return true;
3870   }
3871 
3872 #ifdef COMPILER1
3873   if (PrintC1Statistics) {
3874     return true;
3875   }
3876 #endif // COMPILER1
3877 
3878 #ifdef COMPILER2
3879   if (PrintOptoAssembly || PrintOptoStatistics) {
3880     return true;
3881   }
3882 #endif // COMPILER2
3883 
3884   return false;
3885 }
3886 
3887 #endif // PRODUCT
3888 
3889 bool Arguments::args_contains_vm_options_file_arg(const JavaVMInitArgs* args) {
3890   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
3891     const JavaVMOption* option = args-&gt;options + index;
3892     const char* tail;
3893     if (match_option(option, "-XX:VMOptionsFile=", &amp;tail)) {
3894       return true;
3895     }
3896   }
3897   return false;
3898 }
3899 
3900 jint Arguments::insert_vm_options_file(const JavaVMInitArgs* args,
3901                                        const char* vm_options_file,
3902                                        const int vm_options_file_pos,
3903                                        ScopedVMInitArgs* vm_options_file_args,
3904                                        ScopedVMInitArgs* args_out) {
3905   jint code = parse_vm_options_file(vm_options_file, vm_options_file_args);
3906   if (code != JNI_OK) {
3907     return code;
3908   }
3909 
3910   if (vm_options_file_args-&gt;get()-&gt;nOptions &lt; 1) {
3911     return JNI_OK;
3912   }
3913 
3914   if (args_contains_vm_options_file_arg(vm_options_file_args-&gt;get())) {
3915     jio_fprintf(defaultStream::error_stream(),
3916                 "A VM options file may not refer to a VM options file. "
3917                 "Specification of '-XX:VMOptionsFile=&lt;file-name&gt;' in the "
3918                 "options file '%s' in options container '%s' is an error.\n",
3919                 vm_options_file_args-&gt;vm_options_file_arg(),
3920                 vm_options_file_args-&gt;container_name());
3921     return JNI_EINVAL;
3922   }
3923 
3924   return args_out-&gt;insert(args, vm_options_file_args-&gt;get(),
3925                           vm_options_file_pos);
3926 }
3927 
3928 // Expand -XX:VMOptionsFile found in args_in as needed.
3929 // mod_args and args_out parameters may return values as needed.
3930 jint Arguments::expand_vm_options_as_needed(const JavaVMInitArgs* args_in,
3931                                             ScopedVMInitArgs* mod_args,
3932                                             JavaVMInitArgs** args_out) {
3933   jint code = match_special_option_and_act(args_in, mod_args);
3934   if (code != JNI_OK) {
3935     return code;
3936   }
3937 
3938   if (mod_args-&gt;is_set()) {
3939     // args_in contains -XX:VMOptionsFile and mod_args contains the
3940     // original options from args_in along with the options expanded
3941     // from the VMOptionsFile. Return a short-hand to the caller.
3942     *args_out = mod_args-&gt;get();
3943   } else {
3944     *args_out = (JavaVMInitArgs *)args_in;  // no changes so use args_in
3945   }
3946   return JNI_OK;
3947 }
3948 
3949 jint Arguments::match_special_option_and_act(const JavaVMInitArgs* args,
3950                                              ScopedVMInitArgs* args_out) {
3951   // Remaining part of option string
3952   const char* tail;
3953   ScopedVMInitArgs vm_options_file_args(args_out-&gt;container_name());
3954 
3955   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
3956     const JavaVMOption* option = args-&gt;options + index;
3957     if (ArgumentsExt::process_options(option)) {
3958       continue;
3959     }
3960     if (match_option(option, "-XX:Flags=", &amp;tail)) {
3961       Arguments::set_jvm_flags_file(tail);
3962       continue;
3963     }
3964     if (match_option(option, "-XX:VMOptionsFile=", &amp;tail)) {
3965       if (vm_options_file_args.found_vm_options_file_arg()) {
3966         jio_fprintf(defaultStream::error_stream(),
3967                     "The option '%s' is already specified in the options "
3968                     "container '%s' so the specification of '%s' in the "
3969                     "same options container is an error.\n",
3970                     vm_options_file_args.vm_options_file_arg(),
3971                     vm_options_file_args.container_name(),
3972                     option-&gt;optionString);
3973         return JNI_EINVAL;
3974       }
3975       vm_options_file_args.set_vm_options_file_arg(option-&gt;optionString);
3976       // If there's a VMOptionsFile, parse that
3977       jint code = insert_vm_options_file(args, tail, index,
3978                                          &amp;vm_options_file_args, args_out);
3979       if (code != JNI_OK) {
3980         return code;
3981       }
3982       args_out-&gt;set_vm_options_file_arg(vm_options_file_args.vm_options_file_arg());
3983       if (args_out-&gt;is_set()) {
3984         // The VMOptions file inserted some options so switch 'args'
3985         // to the new set of options, and continue processing which
3986         // preserves "last option wins" semantics.
3987         args = args_out-&gt;get();
3988         // The first option from the VMOptionsFile replaces the
3989         // current option.  So we back track to process the
3990         // replacement option.
3991         index--;
3992       }
3993       continue;
3994     }
3995     if (match_option(option, "-XX:+PrintVMOptions")) {
3996       PrintVMOptions = true;
3997       continue;
3998     }
3999     if (match_option(option, "-XX:-PrintVMOptions")) {
4000       PrintVMOptions = false;
4001       continue;
4002     }
4003     if (match_option(option, "-XX:+IgnoreUnrecognizedVMOptions")) {
4004       IgnoreUnrecognizedVMOptions = true;
4005       continue;
4006     }
4007     if (match_option(option, "-XX:-IgnoreUnrecognizedVMOptions")) {
4008       IgnoreUnrecognizedVMOptions = false;
4009       continue;
4010     }
4011     if (match_option(option, "-XX:+PrintFlagsInitial")) {
4012       CommandLineFlags::printFlags(tty, false);
4013       vm_exit(0);
4014     }
4015     if (match_option(option, "-XX:NativeMemoryTracking", &amp;tail)) {
4016 #if INCLUDE_NMT
4017       // The launcher did not setup nmt environment variable properly.
4018       if (!MemTracker::check_launcher_nmt_support(tail)) {
4019         warning("Native Memory Tracking did not setup properly, using wrong launcher?");
4020       }
4021 
4022       // Verify if nmt option is valid.
4023       if (MemTracker::verify_nmt_option()) {
4024         // Late initialization, still in single-threaded mode.
4025         if (MemTracker::tracking_level() &gt;= NMT_summary) {
4026           MemTracker::init();
4027         }
4028       } else {
4029         vm_exit_during_initialization("Syntax error, expecting -XX:NativeMemoryTracking=[off|summary|detail]", NULL);
4030       }
4031       continue;
4032 #else
4033       jio_fprintf(defaultStream::error_stream(),
4034         "Native Memory Tracking is not supported in this VM\n");
4035       return JNI_ERR;
4036 #endif
4037     }
4038 
4039 #ifndef PRODUCT
4040     if (match_option(option, "-XX:+PrintFlagsWithComments")) {
4041       CommandLineFlags::printFlags(tty, true);
4042       vm_exit(0);
4043     }
4044 #endif
4045   }
4046   return JNI_OK;
4047 }
4048 
4049 static void print_options(const JavaVMInitArgs *args) {
4050   const char* tail;
4051   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
4052     const JavaVMOption *option = args-&gt;options + index;
4053     if (match_option(option, "-XX:", &amp;tail)) {
4054       logOption(tail);
4055     }
4056   }
4057 }
4058 
4059 bool Arguments::handle_deprecated_print_gc_flags() {
4060   if (PrintGC) {
4061     log_warning(gc)("-XX:+PrintGC is deprecated. Will use -Xlog:gc instead.");
4062   }
4063   if (PrintGCDetails) {
4064     log_warning(gc)("-XX:+PrintGCDetails is deprecated. Will use -Xlog:gc* instead.");
4065   }
4066 
4067   if (_gc_log_filename != NULL) {
4068     // -Xloggc was used to specify a filename
4069     const char* gc_conf = PrintGCDetails ? "gc*" : "gc";
4070     return  LogConfiguration::parse_log_arguments(_gc_log_filename, gc_conf, NULL, NULL, NULL);
4071   } else if (PrintGC || PrintGCDetails) {
4072     LogConfiguration::configure_stdout(LogLevel::Info, !PrintGCDetails, LOG_TAGS(gc));
4073   }
4074   return true;
4075 }
4076 
4077 // Parse entry point called from JNI_CreateJavaVM
4078 
4079 jint Arguments::parse(const JavaVMInitArgs* initial_cmd_args) {
4080   assert(verify_special_jvm_flags(), "deprecated and obsolete flag table inconsistent");
4081 
4082   // Initialize ranges, constraints and writeables
4083   CommandLineFlagRangeList::init();
4084   CommandLineFlagConstraintList::init();
4085   CommandLineFlagWriteableList::init();
4086 
4087   // If flag "-XX:Flags=flags-file" is used it will be the first option to be processed.
4088   const char* hotspotrc = ".hotspotrc";
4089   bool settings_file_specified = false;
4090   bool needs_hotspotrc_warning = false;
4091   ScopedVMInitArgs initial_java_tool_options_args("env_var='JAVA_TOOL_OPTIONS'");
4092   ScopedVMInitArgs initial_java_options_args("env_var='_JAVA_OPTIONS'");
4093 
4094   // Pointers to current working set of containers
4095   JavaVMInitArgs* cur_cmd_args;
4096   JavaVMInitArgs* cur_java_options_args;
4097   JavaVMInitArgs* cur_java_tool_options_args;
4098 
4099   // Containers for modified/expanded options
4100   ScopedVMInitArgs mod_cmd_args("cmd_line_args");
4101   ScopedVMInitArgs mod_java_tool_options_args("env_var='JAVA_TOOL_OPTIONS'");
4102   ScopedVMInitArgs mod_java_options_args("env_var='_JAVA_OPTIONS'");
4103 
4104 
4105   jint code =
4106       parse_java_tool_options_environment_variable(&amp;initial_java_tool_options_args);
4107   if (code != JNI_OK) {
4108     return code;
4109   }
4110 
4111   code = parse_java_options_environment_variable(&amp;initial_java_options_args);
4112   if (code != JNI_OK) {
4113     return code;
4114   }
4115 
4116   code = expand_vm_options_as_needed(initial_java_tool_options_args.get(),
4117                                      &amp;mod_java_tool_options_args,
4118                                      &amp;cur_java_tool_options_args);
4119   if (code != JNI_OK) {
4120     return code;
4121   }
4122 
4123   code = expand_vm_options_as_needed(initial_cmd_args,
4124                                      &amp;mod_cmd_args,
4125                                      &amp;cur_cmd_args);
4126   if (code != JNI_OK) {
4127     return code;
4128   }
4129 
4130   code = expand_vm_options_as_needed(initial_java_options_args.get(),
4131                                      &amp;mod_java_options_args,
4132                                      &amp;cur_java_options_args);
4133   if (code != JNI_OK) {
4134     return code;
4135   }
4136 
4137   const char* flags_file = Arguments::get_jvm_flags_file();
4138   settings_file_specified = (flags_file != NULL);
4139 
4140   if (IgnoreUnrecognizedVMOptions) {
4141     cur_cmd_args-&gt;ignoreUnrecognized = true;
4142     cur_java_tool_options_args-&gt;ignoreUnrecognized = true;
4143     cur_java_options_args-&gt;ignoreUnrecognized = true;
4144   }
4145 
4146   // Parse specified settings file
4147   if (settings_file_specified) {
4148     if (!process_settings_file(flags_file, true,
4149                                cur_cmd_args-&gt;ignoreUnrecognized)) {
4150       return JNI_EINVAL;
4151     }
4152   } else {
4153 #ifdef ASSERT
4154     // Parse default .hotspotrc settings file
4155     if (!process_settings_file(".hotspotrc", false,
4156                                cur_cmd_args-&gt;ignoreUnrecognized)) {
4157       return JNI_EINVAL;
4158     }
4159 #else
4160     struct stat buf;
4161     if (os::stat(hotspotrc, &amp;buf) == 0) {
4162       needs_hotspotrc_warning = true;
4163     }
4164 #endif
4165   }
4166 
4167   if (PrintVMOptions) {
4168     print_options(cur_java_tool_options_args);
4169     print_options(cur_cmd_args);
4170     print_options(cur_java_options_args);
4171   }
4172 
4173   // Parse JavaVMInitArgs structure passed in, as well as JAVA_TOOL_OPTIONS and _JAVA_OPTIONS
4174   jint result = parse_vm_init_args(cur_java_tool_options_args,
4175                                    cur_java_options_args,
4176                                    cur_cmd_args);
4177 
4178   if (result != JNI_OK) {
4179     return result;
4180   }
4181 
4182   // Call get_shared_archive_path() here, after possible SharedArchiveFile option got parsed.
4183   SharedArchivePath = get_shared_archive_path();
4184   if (SharedArchivePath == NULL) {
4185     return JNI_ENOMEM;
4186   }
4187 
4188   // Set up VerifySharedSpaces
4189   if (FLAG_IS_DEFAULT(VerifySharedSpaces) &amp;&amp; SharedArchiveFile != NULL) {
4190     VerifySharedSpaces = true;
4191   }
4192 
4193   // Delay warning until here so that we've had a chance to process
4194   // the -XX:-PrintWarnings flag
4195   if (needs_hotspotrc_warning) {
4196     warning("%s file is present but has been ignored.  "
4197             "Run with -XX:Flags=%s to load the file.",
4198             hotspotrc, hotspotrc);
4199   }
4200 
4201 #if defined(_ALLBSD_SOURCE) || defined(AIX)  // UseLargePages is not yet supported on BSD and AIX.
4202   UNSUPPORTED_OPTION(UseLargePages);
4203 #endif
4204 
4205   ArgumentsExt::report_unsupported_options();
4206 
4207 #ifndef PRODUCT
4208   if (TraceBytecodesAt != 0) {
4209     TraceBytecodes = true;
4210   }
4211   if (CountCompiledCalls) {
4212     if (UseCounterDecay) {
4213       warning("UseCounterDecay disabled because CountCalls is set");
4214       UseCounterDecay = false;
4215     }
4216   }
4217 #endif // PRODUCT
4218 
4219   if (ScavengeRootsInCode == 0) {
4220     if (!FLAG_IS_DEFAULT(ScavengeRootsInCode)) {
4221       warning("Forcing ScavengeRootsInCode non-zero");
4222     }
4223     ScavengeRootsInCode = 1;
4224   }
4225 
4226   if (!handle_deprecated_print_gc_flags()) {
4227     return JNI_EINVAL;
4228   }
4229 
4230   // Set object alignment values.
4231   set_object_alignment();
4232 
4233 #if !INCLUDE_CDS
4234   if (DumpSharedSpaces || RequireSharedSpaces) {
4235     jio_fprintf(defaultStream::error_stream(),
4236       "Shared spaces are not supported in this VM\n");
4237     return JNI_ERR;
4238   }
4239   if ((UseSharedSpaces &amp;&amp; FLAG_IS_CMDLINE(UseSharedSpaces)) || PrintSharedSpaces) {
4240     warning("Shared spaces are not supported in this VM");
4241     FLAG_SET_DEFAULT(UseSharedSpaces, false);
4242     FLAG_SET_DEFAULT(PrintSharedSpaces, false);
4243   }
4244   no_shared_spaces("CDS Disabled");
4245 #endif // INCLUDE_CDS
4246 
4247   return JNI_OK;
4248 }
4249 
4250 jint Arguments::apply_ergo() {
4251 
4252   // Set flags based on ergonomics.
4253   set_ergonomics_flags();
4254 
4255   set_shared_spaces_flags();
4256 
4257   // Check the GC selections again.
4258   if (!check_gc_consistency()) {
4259     return JNI_EINVAL;
4260   }
4261 
4262   if (TieredCompilation) {
4263     set_tiered_flags();
4264   } else {
4265     int max_compilation_policy_choice = 1;
4266 #ifdef COMPILER2
4267     max_compilation_policy_choice = 2;
4268 #endif
4269     // Check if the policy is valid.
4270     if (CompilationPolicyChoice &gt;= max_compilation_policy_choice) {
4271       vm_exit_during_initialization(
4272         "Incompatible compilation policy selected", NULL);
4273     }
4274     // Scale CompileThreshold
4275     // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves CompileThreshold unchanged.
4276     if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
4277       FLAG_SET_ERGO(intx, CompileThreshold, scaled_compile_threshold(CompileThreshold));
4278     }
4279   }
4280 
4281 #ifdef COMPILER2
4282 #ifndef PRODUCT
4283   if (PrintIdealGraphLevel &gt; 0) {
4284     FLAG_SET_ERGO(bool, PrintIdealGraph, true);
4285   }
4286 #endif
4287 #endif
4288 
4289   // Set heap size based on available physical memory
4290   set_heap_size();
4291 
4292   ArgumentsExt::set_gc_specific_flags();
4293 
4294   // Initialize Metaspace flags and alignments
4295   Metaspace::ergo_initialize();
4296 
4297   // Set bytecode rewriting flags
4298   set_bytecode_flags();
4299 
4300   // Set flags if Aggressive optimization flags (-XX:+AggressiveOpts) enabled
4301   jint code = set_aggressive_opts_flags();
4302   if (code != JNI_OK) {
4303     return code;
4304   }
4305 
4306   // Turn off biased locking for locking debug mode flags,
4307   // which are subtly different from each other but neither works with
4308   // biased locking
4309   if (UseHeavyMonitors
4310 #ifdef COMPILER1
4311       || !UseFastLocking
4312 #endif // COMPILER1
4313 #if INCLUDE_JVMCI
4314       || !JVMCIUseFastLocking
4315 #endif
4316     ) {
4317     if (!FLAG_IS_DEFAULT(UseBiasedLocking) &amp;&amp; UseBiasedLocking) {
4318       // flag set to true on command line; warn the user that they
4319       // can't enable biased locking here
4320       warning("Biased Locking is not supported with locking debug flags"
4321               "; ignoring UseBiasedLocking flag." );
4322     }
4323     UseBiasedLocking = false;
4324   }
4325 
4326 #ifdef CC_INTERP
4327   // Clear flags not supported on zero.
4328   FLAG_SET_DEFAULT(ProfileInterpreter, false);
4329   FLAG_SET_DEFAULT(UseBiasedLocking, false);
4330   LP64_ONLY(FLAG_SET_DEFAULT(UseCompressedOops, false));
4331   LP64_ONLY(FLAG_SET_DEFAULT(UseCompressedClassPointers, false));
4332 #endif // CC_INTERP
4333 
4334 #ifdef COMPILER2
4335   if (!EliminateLocks) {
4336     EliminateNestedLocks = false;
4337   }
4338   if (!Inline) {
4339     IncrementalInline = false;
4340   }
4341 #ifndef PRODUCT
4342   if (!IncrementalInline) {
4343     AlwaysIncrementalInline = false;
4344   }
4345 #endif
4346   if (!UseTypeSpeculation &amp;&amp; FLAG_IS_DEFAULT(TypeProfileLevel)) {
4347     // nothing to use the profiling, turn if off
4348     FLAG_SET_DEFAULT(TypeProfileLevel, 0);
4349   }
4350 #endif
4351 
4352   if (PrintAssembly &amp;&amp; FLAG_IS_DEFAULT(DebugNonSafepoints)) {
4353     warning("PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output");
4354     DebugNonSafepoints = true;
4355   }
4356 
4357   if (FLAG_IS_CMDLINE(CompressedClassSpaceSize) &amp;&amp; !UseCompressedClassPointers) {
4358     warning("Setting CompressedClassSpaceSize has no effect when compressed class pointers are not used");
4359   }
4360 
4361   if (UseOnStackReplacement &amp;&amp; !UseLoopCounter) {
4362     warning("On-stack-replacement requires loop counters; enabling loop counters");
4363     FLAG_SET_DEFAULT(UseLoopCounter, true);
4364   }
4365 
4366 #ifndef PRODUCT
4367   if (!LogVMOutput &amp;&amp; FLAG_IS_DEFAULT(LogVMOutput)) {
4368     if (use_vm_log()) {
4369       LogVMOutput = true;
4370     }
4371   }
4372 #endif // PRODUCT
4373 
4374   if (PrintCommandLineFlags) {
4375     CommandLineFlags::printSetFlags(tty);
4376   }
4377 
4378   // Apply CPU specific policy for the BiasedLocking
4379   if (UseBiasedLocking) {
4380     if (!VM_Version::use_biased_locking() &amp;&amp;
4381         !(FLAG_IS_CMDLINE(UseBiasedLocking))) {
4382       UseBiasedLocking = false;
4383     }
4384   }
4385 #ifdef COMPILER2
4386   if (!UseBiasedLocking || EmitSync != 0) {
4387     UseOptoBiasInlining = false;
4388   }
4389 #endif
4390 
4391   return JNI_OK;
4392 }
4393 
4394 jint Arguments::adjust_after_os() {
4395   if (UseNUMA) {
4396     if (UseParallelGC || UseParallelOldGC) {
4397       if (FLAG_IS_DEFAULT(MinHeapDeltaBytes)) {
4398          FLAG_SET_DEFAULT(MinHeapDeltaBytes, 64*M);
4399       }
4400     }
4401     // UseNUMAInterleaving is set to ON for all collectors and
4402     // platforms when UseNUMA is set to ON. NUMA-aware collectors
4403     // such as the parallel collector for Linux and Solaris will
4404     // interleave old gen and survivor spaces on top of NUMA
4405     // allocation policy for the eden space.
4406     // Non NUMA-aware collectors such as CMS, G1 and Serial-GC on
4407     // all platforms and ParallelGC on Windows will interleave all
4408     // of the heap spaces across NUMA nodes.
4409     if (FLAG_IS_DEFAULT(UseNUMAInterleaving)) {
4410       FLAG_SET_ERGO(bool, UseNUMAInterleaving, true);
4411     }
4412   }
4413   return JNI_OK;
4414 }
4415 
4416 int Arguments::PropertyList_count(SystemProperty* pl) {
4417   int count = 0;
4418   while(pl != NULL) {
4419     count++;
4420     pl = pl-&gt;next();
4421   }
4422   return count;
4423 }
4424 
4425 const char* Arguments::PropertyList_get_value(SystemProperty *pl, const char* key) {
4426   assert(key != NULL, "just checking");
4427   SystemProperty* prop;
4428   for (prop = pl; prop != NULL; prop = prop-&gt;next()) {
4429     if (strcmp(key, prop-&gt;key()) == 0) return prop-&gt;value();
4430   }
4431   return NULL;
4432 }
4433 
4434 const char* Arguments::PropertyList_get_key_at(SystemProperty *pl, int index) {
4435   int count = 0;
4436   const char* ret_val = NULL;
4437 
4438   while(pl != NULL) {
4439     if(count &gt;= index) {
4440       ret_val = pl-&gt;key();
4441       break;
4442     }
4443     count++;
4444     pl = pl-&gt;next();
4445   }
4446 
4447   return ret_val;
4448 }
4449 
4450 char* Arguments::PropertyList_get_value_at(SystemProperty* pl, int index) {
4451   int count = 0;
4452   char* ret_val = NULL;
4453 
4454   while(pl != NULL) {
4455     if(count &gt;= index) {
4456       ret_val = pl-&gt;value();
4457       break;
4458     }
4459     count++;
4460     pl = pl-&gt;next();
4461   }
4462 
4463   return ret_val;
4464 }
4465 
4466 void Arguments::PropertyList_add(SystemProperty** plist, SystemProperty *new_p) {
4467   SystemProperty* p = *plist;
4468   if (p == NULL) {
4469     *plist = new_p;
4470   } else {
4471     while (p-&gt;next() != NULL) {
4472       p = p-&gt;next();
4473     }
4474     p-&gt;set_next(new_p);
4475   }
4476 }
4477 
4478 void Arguments::PropertyList_add(SystemProperty** plist, const char* k, const char* v) {
4479   if (plist == NULL)
4480     return;
4481 
4482   SystemProperty* new_p = new SystemProperty(k, v, true);
4483   PropertyList_add(plist, new_p);
4484 }
4485 
4486 void Arguments::PropertyList_add(SystemProperty *element) {
4487   PropertyList_add(&amp;_system_properties, element);
4488 }
4489 
4490 // This add maintains unique property key in the list.
4491 void Arguments::PropertyList_unique_add(SystemProperty** plist, const char* k, const char* v, jboolean append) {
4492   if (plist == NULL)
4493     return;
4494 
4495   // If property key exist then update with new value.
4496   SystemProperty* prop;
4497   for (prop = *plist; prop != NULL; prop = prop-&gt;next()) {
4498     if (strcmp(k, prop-&gt;key()) == 0) {
4499       if (append) {
4500         prop-&gt;append_value(v);
4501       } else {
4502         prop-&gt;set_writeable_value(v);
4503       }
4504       return;
4505     }
4506   }
4507 
4508   PropertyList_add(plist, k, v);
4509 }
4510 
4511 // Copies src into buf, replacing "%%" with "%" and "%p" with pid
4512 // Returns true if all of the source pointed by src has been copied over to
4513 // the destination buffer pointed by buf. Otherwise, returns false.
4514 // Notes:
4515 // 1. If the length (buflen) of the destination buffer excluding the
4516 // NULL terminator character is not long enough for holding the expanded
4517 // pid characters, it also returns false instead of returning the partially
4518 // expanded one.
4519 // 2. The passed in "buflen" should be large enough to hold the null terminator.
4520 bool Arguments::copy_expand_pid(const char* src, size_t srclen,
4521                                 char* buf, size_t buflen) {
4522   const char* p = src;
4523   char* b = buf;
4524   const char* src_end = &amp;src[srclen];
4525   char* buf_end = &amp;buf[buflen - 1];
4526 
4527   while (p &lt; src_end &amp;&amp; b &lt; buf_end) {
4528     if (*p == '%') {
4529       switch (*(++p)) {
4530       case '%':         // "%%" ==&gt; "%"
4531         *b++ = *p++;
4532         break;
4533       case 'p':  {       //  "%p" ==&gt; current process id
4534         // buf_end points to the character before the last character so
4535         // that we could write '\0' to the end of the buffer.
4536         size_t buf_sz = buf_end - b + 1;
4537         int ret = jio_snprintf(b, buf_sz, "%d", os::current_process_id());
4538 
4539         // if jio_snprintf fails or the buffer is not long enough to hold
4540         // the expanded pid, returns false.
4541         if (ret &lt; 0 || ret &gt;= (int)buf_sz) {
4542           return false;
4543         } else {
4544           b += ret;
4545           assert(*b == '\0', "fail in copy_expand_pid");
4546           if (p == src_end &amp;&amp; b == buf_end + 1) {
4547             // reach the end of the buffer.
4548             return true;
4549           }
4550         }
4551         p++;
4552         break;
4553       }
4554       default :
4555         *b++ = '%';
4556       }
4557     } else {
4558       *b++ = *p++;
4559     }
4560   }
4561   *b = '\0';
4562   return (p == src_end); // return false if not all of the source was copied
4563 }
</pre></body></html>
