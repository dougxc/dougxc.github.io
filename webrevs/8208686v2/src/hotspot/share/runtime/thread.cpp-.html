<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/hotspot/share/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/javaClasses.hpp"
  29 #include "classfile/moduleEntry.hpp"
  30 #include "classfile/systemDictionary.hpp"
  31 #include "classfile/vmSymbols.hpp"
  32 #include "code/codeCache.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/barrierSet.hpp"
  37 #include "gc/shared/gcId.hpp"
  38 #include "gc/shared/gcLocker.inline.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jfr/jfrEvents.hpp"
  44 #include "jfr/support/jfrThreadId.hpp"
  45 #include "jvmtifiles/jvmtiEnv.hpp"
  46 #include "logging/log.hpp"
  47 #include "logging/logConfiguration.hpp"
  48 #include "logging/logStream.hpp"
  49 #include "memory/allocation.inline.hpp"
  50 #include "memory/metaspaceShared.hpp"
  51 #include "memory/oopFactory.hpp"
  52 #include "memory/resourceArea.hpp"
  53 #include "memory/universe.hpp"
  54 #include "oops/access.inline.hpp"
  55 #include "oops/instanceKlass.hpp"
  56 #include "oops/objArrayOop.hpp"
  57 #include "oops/oop.inline.hpp"
  58 #include "oops/symbol.hpp"
  59 #include "oops/typeArrayOop.inline.hpp"
  60 #include "oops/verifyOopClosure.hpp"
  61 #include "prims/jvm_misc.hpp"
  62 #include "prims/jvmtiExport.hpp"
  63 #include "prims/jvmtiThreadState.hpp"
  64 #include "prims/privilegedStack.hpp"
  65 #include "runtime/arguments.hpp"
  66 #include "runtime/atomic.hpp"
  67 #include "runtime/biasedLocking.hpp"
  68 #include "runtime/fieldDescriptor.inline.hpp"
  69 #include "runtime/flags/jvmFlagConstraintList.hpp"
  70 #include "runtime/flags/jvmFlagRangeList.hpp"
  71 #include "runtime/flags/jvmFlagWriteableList.hpp"
  72 #include "runtime/deoptimization.hpp"
  73 #include "runtime/frame.inline.hpp"
  74 #include "runtime/handshake.hpp"
  75 #include "runtime/init.hpp"
  76 #include "runtime/interfaceSupport.inline.hpp"
  77 #include "runtime/java.hpp"
  78 #include "runtime/javaCalls.hpp"
  79 #include "runtime/jniHandles.inline.hpp"
  80 #include "runtime/jniPeriodicChecker.hpp"
  81 #include "runtime/memprofiler.hpp"
  82 #include "runtime/mutexLocker.hpp"
  83 #include "runtime/objectMonitor.hpp"
  84 #include "runtime/orderAccess.hpp"
  85 #include "runtime/osThread.hpp"
  86 #include "runtime/prefetch.inline.hpp"
  87 #include "runtime/safepoint.hpp"
  88 #include "runtime/safepointMechanism.inline.hpp"
  89 #include "runtime/safepointVerifiers.hpp"
  90 #include "runtime/sharedRuntime.hpp"
  91 #include "runtime/statSampler.hpp"
  92 #include "runtime/stubRoutines.hpp"
  93 #include "runtime/sweeper.hpp"
  94 #include "runtime/task.hpp"
  95 #include "runtime/thread.inline.hpp"
  96 #include "runtime/threadCritical.hpp"
  97 #include "runtime/threadSMR.inline.hpp"
  98 #include "runtime/threadStatisticalInfo.hpp"
  99 #include "runtime/timer.hpp"
 100 #include "runtime/timerTrace.hpp"
 101 #include "runtime/vframe.inline.hpp"
 102 #include "runtime/vframeArray.hpp"
 103 #include "runtime/vframe_hp.hpp"
 104 #include "runtime/vmThread.hpp"
 105 #include "runtime/vm_operations.hpp"
 106 #include "runtime/vm_version.hpp"
 107 #include "services/attachListener.hpp"
 108 #include "services/management.hpp"
 109 #include "services/memTracker.hpp"
 110 #include "services/threadService.hpp"
 111 #include "utilities/align.hpp"
 112 #include "utilities/copy.hpp"
 113 #include "utilities/defaultStream.hpp"
 114 #include "utilities/dtrace.hpp"
 115 #include "utilities/events.hpp"
 116 #include "utilities/macros.hpp"
 117 #include "utilities/preserveException.hpp"
 118 #include "utilities/singleWriterSynchronizer.hpp"
 119 #include "utilities/vmError.hpp"
 120 #if INCLUDE_JVMCI
 121 #include "jvmci/jvmciCompiler.hpp"
 122 #include "jvmci/jvmciRuntime.hpp"
 123 #include "logging/logHandle.hpp"
 124 #endif
 125 #ifdef COMPILER1
 126 #include "c1/c1_Compiler.hpp"
 127 #endif
 128 #ifdef COMPILER2
 129 #include "opto/c2compiler.hpp"
 130 #include "opto/idealGraphPrinter.hpp"
 131 #endif
 132 #if INCLUDE_RTM_OPT
 133 #include "runtime/rtmLocking.hpp"
 134 #endif
 135 #if INCLUDE_JFR
 136 #include "jfr/jfr.hpp"
 137 #endif
 138 
 139 // Initialization after module runtime initialization
 140 void universe_post_module_init();  // must happen after call_initPhase2
 141 
 142 #ifdef DTRACE_ENABLED
 143 
 144 // Only bother with this argument setup if dtrace is available
 145 
 146   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 147   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 150     {                                                                      \
 151       ResourceMark rm(this);                                               \
 152       int len = 0;                                                         \
 153       const char* name = (javathread)-&gt;get_thread_name();                  \
 154       len = strlen(name);                                                  \
 155       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 156         (char *) name, len,                                                \
 157         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 158         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 159         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 160     }
 161 
 162 #else //  ndef DTRACE_ENABLED
 163 
 164   #define DTRACE_THREAD_PROBE(probe, javathread)
 165 
 166 #endif // ndef DTRACE_ENABLED
 167 
 168 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 169 // Current thread is maintained as a thread-local variable
 170 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 171 #endif
 172 
 173 // ======= Thread ========
 174 // Support for forcing alignment of thread objects for biased locking
 175 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 176   if (UseBiasedLocking) {
 177     const int alignment = markOopDesc::biased_lock_alignment;
 178     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 179     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 180                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 181                                                          AllocFailStrategy::RETURN_NULL);
 182     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 183     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 184            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 185            "JavaThread alignment code overflowed allocated storage");
 186     if (aligned_addr != real_malloc_addr) {
 187       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 188                               p2i(real_malloc_addr),
 189                               p2i(aligned_addr));
 190     }
 191     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 192     return aligned_addr;
 193   } else {
 194     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 195                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 196   }
 197 }
 198 
 199 void Thread::operator delete(void* p) {
 200   if (UseBiasedLocking) {
 201     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 202   } else {
 203     FreeHeap(p);
 204   }
 205 }
 206 
 207 void JavaThread::smr_delete() {
 208   if (_on_thread_list) {
 209     ThreadsSMRSupport::smr_delete(this);
 210   } else {
 211     delete this;
 212   }
 213 }
 214 
 215 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 216 // JavaThread
 217 
 218 
 219 Thread::Thread() {
 220   // stack and get_thread
 221   set_stack_base(NULL);
 222   set_stack_size(0);
 223   set_self_raw_id(0);
 224   set_lgrp_id(-1);
 225   DEBUG_ONLY(clear_suspendible_thread();)
 226 
 227   // allocated data structures
 228   set_osthread(NULL);
 229   set_resource_area(new (mtThread)ResourceArea());
 230   DEBUG_ONLY(_current_resource_mark = NULL;)
 231   set_handle_area(new (mtThread) HandleArea(NULL));
 232   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 233   set_active_handles(NULL);
 234   set_free_handle_block(NULL);
 235   set_last_handle_mark(NULL);
 236 
 237   // This initial value ==&gt; never claimed.
 238   _oops_do_parity = 0;
 239   _threads_hazard_ptr = NULL;
 240   _threads_list_ptr = NULL;
 241   _nested_threads_hazard_ptr_cnt = 0;
 242   _rcu_counter = 0;
 243 
 244   // the handle mark links itself to last_handle_mark
 245   new HandleMark(this);
 246 
 247   // plain initialization
 248   debug_only(_owned_locks = NULL;)
 249   debug_only(_allow_allocation_count = 0;)
 250   NOT_PRODUCT(_allow_safepoint_count = 0;)
 251   NOT_PRODUCT(_skip_gcalot = false;)
 252   _jvmti_env_iteration_count = 0;
 253   set_allocated_bytes(0);
 254   _vm_operation_started_count = 0;
 255   _vm_operation_completed_count = 0;
 256   _current_pending_monitor = NULL;
 257   _current_pending_monitor_is_from_java = true;
 258   _current_waiting_monitor = NULL;
 259   _num_nested_signal = 0;
 260   omFreeList = NULL;
 261   omFreeCount = 0;
 262   omFreeProvision = 32;
 263   omInUseList = NULL;
 264   omInUseCount = 0;
 265 
 266 #ifdef ASSERT
 267   _visited_for_critical_count = false;
 268 #endif
 269 
 270   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 271                          Monitor::_safepoint_check_sometimes);
 272   _suspend_flags = 0;
 273 
 274   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 275   _hashStateX = os::random();
 276   _hashStateY = 842502087;
 277   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 278   _hashStateW = 273326509;
 279 
 280   _OnTrap   = 0;
 281   _Stalled  = 0;
 282   _TypeTag  = 0x2BAD;
 283 
 284   // Many of the following fields are effectively final - immutable
 285   // Note that nascent threads can't use the Native Monitor-Mutex
 286   // construct until the _MutexEvent is initialized ...
 287   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 288   // we might instead use a stack of ParkEvents that we could provision on-demand.
 289   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 290   // and ::Release()
 291   _ParkEvent   = ParkEvent::Allocate(this);
 292   _SleepEvent  = ParkEvent::Allocate(this);
 293   _MutexEvent  = ParkEvent::Allocate(this);
 294   _MuxEvent    = ParkEvent::Allocate(this);
 295 
 296 #ifdef CHECK_UNHANDLED_OOPS
 297   if (CheckUnhandledOops) {
 298     _unhandled_oops = new UnhandledOops(this);
 299   }
 300 #endif // CHECK_UNHANDLED_OOPS
 301 #ifdef ASSERT
 302   if (UseBiasedLocking) {
 303     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 304     assert(this == _real_malloc_address ||
 305            this == align_up(_real_malloc_address, (int)markOopDesc::biased_lock_alignment),
 306            "bug in forced alignment of thread objects");
 307   }
 308 #endif // ASSERT
 309 
 310   // Notify the barrier set that a thread is being created. Note that some
 311   // threads are created before a barrier set is available. The call to
 312   // BarrierSet::on_thread_create() for these threads is therefore deferred
 313   // to BarrierSet::set_barrier_set().
 314   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 315   if (barrier_set != NULL) {
 316     barrier_set-&gt;on_thread_create(this);
 317   } else {
 318     DEBUG_ONLY(Threads::inc_threads_before_barrier_set();)
 319   }
 320 }
 321 
 322 void Thread::initialize_thread_current() {
 323 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 324   assert(_thr_current == NULL, "Thread::current already initialized");
 325   _thr_current = this;
 326 #endif
 327   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 328   ThreadLocalStorage::set_thread(this);
 329   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 330 }
 331 
 332 void Thread::clear_thread_current() {
 333   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 334 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 335   _thr_current = NULL;
 336 #endif
 337   ThreadLocalStorage::set_thread(NULL);
 338 }
 339 
 340 void Thread::record_stack_base_and_size() {
 341   set_stack_base(os::current_stack_base());
 342   set_stack_size(os::current_stack_size());
 343   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 344   // in initialize_thread(). Without the adjustment, stack size is
 345   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 346   // So far, only Solaris has real implementation of initialize_thread().
 347   //
 348   // set up any platform-specific state.
 349   os::initialize_thread(this);
 350 
 351   // Set stack limits after thread is initialized.
 352   if (is_Java_thread()) {
 353     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 354     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 355   }
 356 #if INCLUDE_NMT
 357   // record thread's native stack, stack grows downward
 358   MemTracker::record_thread_stack(stack_end(), stack_size());
 359 #endif // INCLUDE_NMT
 360   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 361     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 362     os::current_thread_id(), p2i(stack_base() - stack_size()),
 363     p2i(stack_base()), stack_size()/1024);
 364 }
 365 
 366 
 367 Thread::~Thread() {
 368   JFR_ONLY(Jfr::on_thread_destruct(this);)
 369 
 370   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 371   // set might not be available if we encountered errors during bootstrapping.
 372   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 373   if (barrier_set != NULL) {
 374     barrier_set-&gt;on_thread_destroy(this);
 375   }
 376 
 377 
 378   // stack_base can be NULL if the thread is never started or exited before
 379   // record_stack_base_and_size called. Although, we would like to ensure
 380   // that all started threads do call record_stack_base_and_size(), there is
 381   // not proper way to enforce that.
 382 #if INCLUDE_NMT
 383   if (_stack_base != NULL) {
 384     MemTracker::release_thread_stack(stack_end(), stack_size());
 385 #ifdef ASSERT
 386     set_stack_base(NULL);
 387 #endif
 388   }
 389 #endif // INCLUDE_NMT
 390 
 391   // deallocate data structures
 392   delete resource_area();
 393   // since the handle marks are using the handle area, we have to deallocated the root
 394   // handle mark before deallocating the thread's handle area,
 395   assert(last_handle_mark() != NULL, "check we have an element");
 396   delete last_handle_mark();
 397   assert(last_handle_mark() == NULL, "check we have reached the end");
 398 
 399   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 400   // We NULL out the fields for good hygiene.
 401   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 402   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 403   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 404   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 405 
 406   delete handle_area();
 407   delete metadata_handles();
 408 
 409   // SR_handler uses this as a termination indicator -
 410   // needs to happen before os::free_thread()
 411   delete _SR_lock;
 412   _SR_lock = NULL;
 413 
 414   // osthread() can be NULL, if creation of thread failed.
 415   if (osthread() != NULL) os::free_thread(osthread());
 416 
 417   // clear Thread::current if thread is deleting itself.
 418   // Needed to ensure JNI correctly detects non-attached threads.
 419   if (this == Thread::current()) {
 420     clear_thread_current();
 421   }
 422 
 423   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 424 }
 425 
 426 // NOTE: dummy function for assertion purpose.
 427 void Thread::run() {
 428   ShouldNotReachHere();
 429 }
 430 
 431 #ifdef ASSERT
 432 // A JavaThread is considered "dangling" if it is not the current
 433 // thread, has been added the Threads list, the system is not at a
 434 // safepoint and the Thread is not "protected".
 435 //
 436 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 437   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 438          !((JavaThread *) thread)-&gt;on_thread_list() ||
 439          SafepointSynchronize::is_at_safepoint() ||
 440          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 441          "possibility of dangling Thread pointer");
 442 }
 443 #endif
 444 
 445 ThreadPriority Thread::get_priority(const Thread* const thread) {
 446   ThreadPriority priority;
 447   // Can return an error!
 448   (void)os::get_priority(thread, priority);
 449   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 450   return priority;
 451 }
 452 
 453 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 454   debug_only(check_for_dangling_thread_pointer(thread);)
 455   // Can return an error!
 456   (void)os::set_priority(thread, priority);
 457 }
 458 
 459 
 460 void Thread::start(Thread* thread) {
 461   // Start is different from resume in that its safety is guaranteed by context or
 462   // being called from a Java method synchronized on the Thread object.
 463   if (!DisableStartThread) {
 464     if (thread-&gt;is_Java_thread()) {
 465       // Initialize the thread state to RUNNABLE before starting this thread.
 466       // Can not set it after the thread started because we do not know the
 467       // exact thread state at that time. It could be in MONITOR_WAIT or
 468       // in SLEEPING or some other state.
 469       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 470                                           java_lang_Thread::RUNNABLE);
 471     }
 472     os::start_thread(thread);
 473   }
 474 }
 475 
 476 // Enqueue a VM_Operation to do the job for us - sometime later
 477 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 478   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 479   VMThread::execute(vm_stop);
 480 }
 481 
 482 
 483 // Check if an external suspend request has completed (or has been
 484 // cancelled). Returns true if the thread is externally suspended and
 485 // false otherwise.
 486 //
 487 // The bits parameter returns information about the code path through
 488 // the routine. Useful for debugging:
 489 //
 490 // set in is_ext_suspend_completed():
 491 // 0x00000001 - routine was entered
 492 // 0x00000010 - routine return false at end
 493 // 0x00000100 - thread exited (return false)
 494 // 0x00000200 - suspend request cancelled (return false)
 495 // 0x00000400 - thread suspended (return true)
 496 // 0x00001000 - thread is in a suspend equivalent state (return true)
 497 // 0x00002000 - thread is native and walkable (return true)
 498 // 0x00004000 - thread is native_trans and walkable (needed retry)
 499 //
 500 // set in wait_for_ext_suspend_completion():
 501 // 0x00010000 - routine was entered
 502 // 0x00020000 - suspend request cancelled before loop (return false)
 503 // 0x00040000 - thread suspended before loop (return true)
 504 // 0x00080000 - suspend request cancelled in loop (return false)
 505 // 0x00100000 - thread suspended in loop (return true)
 506 // 0x00200000 - suspend not completed during retry loop (return false)
 507 
 508 // Helper class for tracing suspend wait debug bits.
 509 //
 510 // 0x00000100 indicates that the target thread exited before it could
 511 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 512 // 0x00080000 each indicate a cancelled suspend request so they don't
 513 // count as wait failures either.
 514 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 515 
 516 class TraceSuspendDebugBits : public StackObj {
 517  private:
 518   JavaThread * jt;
 519   bool         is_wait;
 520   bool         called_by_wait;  // meaningful when !is_wait
 521   uint32_t *   bits;
 522 
 523  public:
 524   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 525                         uint32_t *_bits) {
 526     jt             = _jt;
 527     is_wait        = _is_wait;
 528     called_by_wait = _called_by_wait;
 529     bits           = _bits;
 530   }
 531 
 532   ~TraceSuspendDebugBits() {
 533     if (!is_wait) {
 534 #if 1
 535       // By default, don't trace bits for is_ext_suspend_completed() calls.
 536       // That trace is very chatty.
 537       return;
 538 #else
 539       if (!called_by_wait) {
 540         // If tracing for is_ext_suspend_completed() is enabled, then only
 541         // trace calls to it from wait_for_ext_suspend_completion()
 542         return;
 543       }
 544 #endif
 545     }
 546 
 547     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 548       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 549         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 550         ResourceMark rm;
 551 
 552         tty-&gt;print_cr(
 553                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 554                       jt-&gt;get_thread_name(), *bits);
 555 
 556         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 557       }
 558     }
 559   }
 560 };
 561 #undef DEBUG_FALSE_BITS
 562 
 563 
 564 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 565                                           uint32_t *bits) {
 566   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 567 
 568   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 569   bool do_trans_retry;           // flag to force the retry
 570 
 571   *bits |= 0x00000001;
 572 
 573   do {
 574     do_trans_retry = false;
 575 
 576     if (is_exiting()) {
 577       // Thread is in the process of exiting. This is always checked
 578       // first to reduce the risk of dereferencing a freed JavaThread.
 579       *bits |= 0x00000100;
 580       return false;
 581     }
 582 
 583     if (!is_external_suspend()) {
 584       // Suspend request is cancelled. This is always checked before
 585       // is_ext_suspended() to reduce the risk of a rogue resume
 586       // confusing the thread that made the suspend request.
 587       *bits |= 0x00000200;
 588       return false;
 589     }
 590 
 591     if (is_ext_suspended()) {
 592       // thread is suspended
 593       *bits |= 0x00000400;
 594       return true;
 595     }
 596 
 597     // Now that we no longer do hard suspends of threads running
 598     // native code, the target thread can be changing thread state
 599     // while we are in this routine:
 600     //
 601     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 602     //
 603     // We save a copy of the thread state as observed at this moment
 604     // and make our decision about suspend completeness based on the
 605     // copy. This closes the race where the thread state is seen as
 606     // _thread_in_native_trans in the if-thread_blocked check, but is
 607     // seen as _thread_blocked in if-thread_in_native_trans check.
 608     JavaThreadState save_state = thread_state();
 609 
 610     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 611       // If the thread's state is _thread_blocked and this blocking
 612       // condition is known to be equivalent to a suspend, then we can
 613       // consider the thread to be externally suspended. This means that
 614       // the code that sets _thread_blocked has been modified to do
 615       // self-suspension if the blocking condition releases. We also
 616       // used to check for CONDVAR_WAIT here, but that is now covered by
 617       // the _thread_blocked with self-suspension check.
 618       //
 619       // Return true since we wouldn't be here unless there was still an
 620       // external suspend request.
 621       *bits |= 0x00001000;
 622       return true;
 623     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 624       // Threads running native code will self-suspend on native==&gt;VM/Java
 625       // transitions. If its stack is walkable (should always be the case
 626       // unless this function is called before the actual java_suspend()
 627       // call), then the wait is done.
 628       *bits |= 0x00002000;
 629       return true;
 630     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 631                save_state == _thread_in_native_trans &amp;&amp;
 632                frame_anchor()-&gt;walkable()) {
 633       // The thread is transitioning from thread_in_native to another
 634       // thread state. check_safepoint_and_suspend_for_native_trans()
 635       // will force the thread to self-suspend. If it hasn't gotten
 636       // there yet we may have caught the thread in-between the native
 637       // code check above and the self-suspend. Lucky us. If we were
 638       // called by wait_for_ext_suspend_completion(), then it
 639       // will be doing the retries so we don't have to.
 640       //
 641       // Since we use the saved thread state in the if-statement above,
 642       // there is a chance that the thread has already transitioned to
 643       // _thread_blocked by the time we get here. In that case, we will
 644       // make a single unnecessary pass through the logic below. This
 645       // doesn't hurt anything since we still do the trans retry.
 646 
 647       *bits |= 0x00004000;
 648 
 649       // Once the thread leaves thread_in_native_trans for another
 650       // thread state, we break out of this retry loop. We shouldn't
 651       // need this flag to prevent us from getting back here, but
 652       // sometimes paranoia is good.
 653       did_trans_retry = true;
 654 
 655       // We wait for the thread to transition to a more usable state.
 656       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 657         // We used to do an "os::yield_all(i)" call here with the intention
 658         // that yielding would increase on each retry. However, the parameter
 659         // is ignored on Linux which means the yield didn't scale up. Waiting
 660         // on the SR_lock below provides a much more predictable scale up for
 661         // the delay. It also provides a simple/direct point to check for any
 662         // safepoint requests from the VMThread
 663 
 664         // temporarily drops SR_lock while doing wait with safepoint check
 665         // (if we're a JavaThread - the WatcherThread can also call this)
 666         // and increase delay with each retry
 667         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 668 
 669         // check the actual thread state instead of what we saved above
 670         if (thread_state() != _thread_in_native_trans) {
 671           // the thread has transitioned to another thread state so
 672           // try all the checks (except this one) one more time.
 673           do_trans_retry = true;
 674           break;
 675         }
 676       } // end retry loop
 677 
 678 
 679     }
 680   } while (do_trans_retry);
 681 
 682   *bits |= 0x00000010;
 683   return false;
 684 }
 685 
 686 // Wait for an external suspend request to complete (or be cancelled).
 687 // Returns true if the thread is externally suspended and false otherwise.
 688 //
 689 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 690                                                  uint32_t *bits) {
 691   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 692                              false /* !called_by_wait */, bits);
 693 
 694   // local flag copies to minimize SR_lock hold time
 695   bool is_suspended;
 696   bool pending;
 697   uint32_t reset_bits;
 698 
 699   // set a marker so is_ext_suspend_completed() knows we are the caller
 700   *bits |= 0x00010000;
 701 
 702   // We use reset_bits to reinitialize the bits value at the top of
 703   // each retry loop. This allows the caller to make use of any
 704   // unused bits for their own marking purposes.
 705   reset_bits = *bits;
 706 
 707   {
 708     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 709     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 710                                             delay, bits);
 711     pending = is_external_suspend();
 712   }
 713   // must release SR_lock to allow suspension to complete
 714 
 715   if (!pending) {
 716     // A cancelled suspend request is the only false return from
 717     // is_ext_suspend_completed() that keeps us from entering the
 718     // retry loop.
 719     *bits |= 0x00020000;
 720     return false;
 721   }
 722 
 723   if (is_suspended) {
 724     *bits |= 0x00040000;
 725     return true;
 726   }
 727 
 728   for (int i = 1; i &lt;= retries; i++) {
 729     *bits = reset_bits;  // reinit to only track last retry
 730 
 731     // We used to do an "os::yield_all(i)" call here with the intention
 732     // that yielding would increase on each retry. However, the parameter
 733     // is ignored on Linux which means the yield didn't scale up. Waiting
 734     // on the SR_lock below provides a much more predictable scale up for
 735     // the delay. It also provides a simple/direct point to check for any
 736     // safepoint requests from the VMThread
 737 
 738     {
 739       MutexLocker ml(SR_lock());
 740       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 741       // can also call this)  and increase delay with each retry
 742       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 743 
 744       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 745                                               delay, bits);
 746 
 747       // It is possible for the external suspend request to be cancelled
 748       // (by a resume) before the actual suspend operation is completed.
 749       // Refresh our local copy to see if we still need to wait.
 750       pending = is_external_suspend();
 751     }
 752 
 753     if (!pending) {
 754       // A cancelled suspend request is the only false return from
 755       // is_ext_suspend_completed() that keeps us from staying in the
 756       // retry loop.
 757       *bits |= 0x00080000;
 758       return false;
 759     }
 760 
 761     if (is_suspended) {
 762       *bits |= 0x00100000;
 763       return true;
 764     }
 765   } // end retry loop
 766 
 767   // thread did not suspend after all our retries
 768   *bits |= 0x00200000;
 769   return false;
 770 }
 771 
 772 // Called from API entry points which perform stack walking. If the
 773 // associated JavaThread is the current thread, then wait_for_suspend
 774 // is not used. Otherwise, it determines if we should wait for the
 775 // "other" thread to complete external suspension. (NOTE: in future
 776 // releases the suspension mechanism should be reimplemented so this
 777 // is not necessary.)
 778 //
 779 bool
 780 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 781   if (this != JavaThread::current()) {
 782     // "other" threads require special handling.
 783     if (wait_for_suspend) {
 784       // We are allowed to wait for the external suspend to complete
 785       // so give the other thread a chance to get suspended.
 786       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 787                                            SuspendRetryDelay, bits)) {
 788         // Didn't make it so let the caller know.
 789         return false;
 790       }
 791     }
 792     // We aren't allowed to wait for the external suspend to complete
 793     // so if the other thread isn't externally suspended we need to
 794     // let the caller know.
 795     else if (!is_ext_suspend_completed_with_lock(bits)) {
 796       return false;
 797     }
 798   }
 799 
 800   return true;
 801 }
 802 
 803 #ifndef PRODUCT
 804 void JavaThread::record_jump(address target, address instr, const char* file,
 805                              int line) {
 806 
 807   // This should not need to be atomic as the only way for simultaneous
 808   // updates is via interrupts. Even then this should be rare or non-existent
 809   // and we don't care that much anyway.
 810 
 811   int index = _jmp_ring_index;
 812   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 813   _jmp_ring[index]._target = (intptr_t) target;
 814   _jmp_ring[index]._instruction = (intptr_t) instr;
 815   _jmp_ring[index]._file = file;
 816   _jmp_ring[index]._line = line;
 817 }
 818 #endif // PRODUCT
 819 
 820 void Thread::interrupt(Thread* thread) {
 821   debug_only(check_for_dangling_thread_pointer(thread);)
 822   os::interrupt(thread);
 823 }
 824 
 825 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 826   debug_only(check_for_dangling_thread_pointer(thread);)
 827   // Note:  If clear_interrupted==false, this simply fetches and
 828   // returns the value of the field osthread()-&gt;interrupted().
 829   return os::is_interrupted(thread, clear_interrupted);
 830 }
 831 
 832 
 833 // GC Support
 834 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 835   int thread_parity = _oops_do_parity;
 836   if (thread_parity != strong_roots_parity) {
 837     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 838     if (res == thread_parity) {
 839       return true;
 840     } else {
 841       guarantee(res == strong_roots_parity, "Or else what?");
 842       return false;
 843     }
 844   }
 845   return false;
 846 }
 847 
 848 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 849   active_handles()-&gt;oops_do(f);
 850   // Do oop for ThreadShadow
 851   f-&gt;do_oop((oop*)&amp;_pending_exception);
 852   handle_area()-&gt;oops_do(f);
 853 
 854   // We scan thread local monitor lists here, and the remaining global
 855   // monitors in ObjectSynchronizer::oops_do().
 856   ObjectSynchronizer::thread_local_used_oops_do(this, f);
 857 }
 858 
 859 void Thread::metadata_handles_do(void f(Metadata*)) {
 860   // Only walk the Handles in Thread.
 861   if (metadata_handles() != NULL) {
 862     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 863       f(metadata_handles()-&gt;at(i));
 864     }
 865   }
 866 }
 867 
 868 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 869   // get_priority assumes osthread initialized
 870   if (osthread() != NULL) {
 871     int os_prio;
 872     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 873       st-&gt;print("os_prio=%d ", os_prio);
 874     }
 875 
 876     st-&gt;print("cpu=%.2fms ",
 877               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 878               );
 879     st-&gt;print("elapsed=%.2fs ",
 880               _statistical_info.getElapsedTime() / 1000.0
 881               );
 882     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 883       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 884       st-&gt;print("allocated=" SIZE_FORMAT "%s ",
 885                 byte_size_in_proper_unit(allocated_bytes),
 886                 proper_unit_for_byte_size(allocated_bytes)
 887                 );
 888       st-&gt;print("defined_classes=" INT64_FORMAT " ", _statistical_info.getDefineClassCount());
 889     }
 890 
 891     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 892     osthread()-&gt;print_on(st);
 893   }
 894   ThreadsSMRSupport::print_info_on(this, st);
 895   st-&gt;print(" ");
 896   debug_only(if (WizardMode) print_owned_locks_on(st);)
 897 }
 898 
 899 // Thread::print_on_error() is called by fatal error handler. Don't use
 900 // any lock or allocate memory.
 901 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 902   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 903 
 904   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 905   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 906   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 907   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 908   else                                { st-&gt;print("Thread"); }
 909 
 910   if (is_Named_thread()) {
 911     st-&gt;print(" \"%s\"", name());
 912   }
 913 
 914   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 915             p2i(stack_end()), p2i(stack_base()));
 916 
 917   if (osthread()) {
 918     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 919   }
 920 
 921   ThreadsSMRSupport::print_info_on(this, st);
 922 }
 923 
 924 void Thread::print_value_on(outputStream* st) const {
 925   if (is_Named_thread()) {
 926     st-&gt;print(" \"%s\" ", name());
 927   }
 928   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 929 }
 930 
 931 #ifdef ASSERT
 932 void Thread::print_owned_locks_on(outputStream* st) const {
 933   Monitor *cur = _owned_locks;
 934   if (cur == NULL) {
 935     st-&gt;print(" (no locks) ");
 936   } else {
 937     st-&gt;print_cr(" Locks owned:");
 938     while (cur) {
 939       cur-&gt;print_on(st);
 940       cur = cur-&gt;next();
 941     }
 942   }
 943 }
 944 
 945 static int ref_use_count  = 0;
 946 
 947 bool Thread::owns_locks_but_compiled_lock() const {
 948   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 949     if (cur != Compile_lock) return true;
 950   }
 951   return false;
 952 }
 953 
 954 
 955 #endif
 956 
 957 #ifndef PRODUCT
 958 
 959 // The flag: potential_vm_operation notifies if this particular safepoint state could potentially
 960 // invoke the vm-thread (e.g., an oop allocation). In that case, we also have to make sure that
 961 // no locks which allow_vm_block's are held
 962 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 963   // Check if current thread is allowed to block at a safepoint
 964   if (!(_allow_safepoint_count == 0)) {
 965     fatal("Possible safepoint reached by thread that does not allow it");
 966   }
 967   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 968     fatal("LEAF method calling lock?");
 969   }
 970 
 971 #ifdef ASSERT
 972   if (potential_vm_operation &amp;&amp; is_Java_thread()
 973       &amp;&amp; !Universe::is_bootstrapping()) {
 974     // Make sure we do not hold any locks that the VM thread also uses.
 975     // This could potentially lead to deadlocks
 976     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 977       // Threads_lock is special, since the safepoint synchronization will not start before this is
 978       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 979       // since it is used to transfer control between JavaThreads and the VMThread
 980       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 981       if ((cur-&gt;allow_vm_block() &amp;&amp;
 982            cur != Threads_lock &amp;&amp;
 983            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 984            cur != VMOperationRequest_lock &amp;&amp;
 985            cur != VMOperationQueue_lock) ||
 986            cur-&gt;rank() == Mutex::special) {
 987         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 988       }
 989     }
 990   }
 991 
 992   if (GCALotAtAllSafepoints) {
 993     // We could enter a safepoint here and thus have a gc
 994     InterfaceSupport::check_gc_alot();
 995   }
 996 #endif
 997 }
 998 #endif
 999 
1000 bool Thread::is_in_stack(address adr) const {
1001   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
1002   address end = os::current_stack_pointer();
1003   // Allow non Java threads to call this without stack_base
1004   if (_stack_base == NULL) return true;
1005   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
1006 
1007   return false;
1008 }
1009 
1010 bool Thread::is_in_usable_stack(address adr) const {
1011   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
1012   size_t usable_stack_size = _stack_size - stack_guard_size;
1013 
1014   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
1015 }
1016 
1017 
1018 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1019 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1020 // used for compilation in the future. If that change is made, the need for these methods
1021 // should be revisited, and they should be removed if possible.
1022 
1023 bool Thread::is_lock_owned(address adr) const {
1024   return on_local_stack(adr);
1025 }
1026 
1027 bool Thread::set_as_starting_thread() {
1028   // NOTE: this must be called inside the main thread.
1029   return os::create_main_thread((JavaThread*)this);
1030 }
1031 
1032 static void initialize_class(Symbol* class_name, TRAPS) {
1033   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1034   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1035 }
1036 
1037 
1038 // Creates the initial ThreadGroup
1039 static Handle create_initial_thread_group(TRAPS) {
1040   Handle system_instance = JavaCalls::construct_new_instance(
1041                             SystemDictionary::ThreadGroup_klass(),
1042                             vmSymbols::void_method_signature(),
1043                             CHECK_NH);
1044   Universe::set_system_thread_group(system_instance());
1045 
1046   Handle string = java_lang_String::create_from_str("main", CHECK_NH);
1047   Handle main_instance = JavaCalls::construct_new_instance(
1048                             SystemDictionary::ThreadGroup_klass(),
1049                             vmSymbols::threadgroup_string_void_signature(),
1050                             system_instance,
1051                             string,
1052                             CHECK_NH);
1053   return main_instance;
1054 }
1055 
1056 // Creates the initial Thread
1057 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1058                                  TRAPS) {
1059   InstanceKlass* ik = SystemDictionary::Thread_klass();
1060   assert(ik-&gt;is_initialized(), "must be");
1061   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1062 
1063   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1064   // constructor calls Thread.current(), which must be set here for the
1065   // initial thread.
1066   java_lang_Thread::set_thread(thread_oop(), thread);
1067   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1068   thread-&gt;set_threadObj(thread_oop());
1069 
1070   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
1071 
1072   JavaValue result(T_VOID);
1073   JavaCalls::call_special(&amp;result, thread_oop,
1074                           ik,
1075                           vmSymbols::object_initializer_name(),
1076                           vmSymbols::threadgroup_string_void_signature(),
1077                           thread_group,
1078                           string,
1079                           CHECK_NULL);
1080   return thread_oop();
1081 }
1082 
1083 char java_runtime_name[128] = "";
1084 char java_runtime_version[128] = "";
1085 
1086 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1087 static const char* get_java_runtime_name(TRAPS) {
1088   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1089                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1090   fieldDescriptor fd;
1091   bool found = k != NULL &amp;&amp;
1092                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1093                                                         vmSymbols::string_signature(), &amp;fd);
1094   if (found) {
1095     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1096     if (name_oop == NULL) {
1097       return NULL;
1098     }
1099     const char* name = java_lang_String::as_utf8_string(name_oop,
1100                                                         java_runtime_name,
1101                                                         sizeof(java_runtime_name));
1102     return name;
1103   } else {
1104     return NULL;
1105   }
1106 }
1107 
1108 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1109 static const char* get_java_runtime_version(TRAPS) {
1110   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1111                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1112   fieldDescriptor fd;
1113   bool found = k != NULL &amp;&amp;
1114                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1115                                                         vmSymbols::string_signature(), &amp;fd);
1116   if (found) {
1117     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1118     if (name_oop == NULL) {
1119       return NULL;
1120     }
1121     const char* name = java_lang_String::as_utf8_string(name_oop,
1122                                                         java_runtime_version,
1123                                                         sizeof(java_runtime_version));
1124     return name;
1125   } else {
1126     return NULL;
1127   }
1128 }
1129 
1130 // General purpose hook into Java code, run once when the VM is initialized.
1131 // The Java library method itself may be changed independently from the VM.
1132 static void call_postVMInitHook(TRAPS) {
1133   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1134   if (klass != NULL) {
1135     JavaValue result(T_VOID);
1136     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1137                            vmSymbols::void_method_signature(),
1138                            CHECK);
1139   }
1140 }
1141 
1142 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1143                                     bool daemon, TRAPS) {
1144   assert(thread_group.not_null(), "thread group should be specified");
1145   assert(threadObj() == NULL, "should only create Java thread object once");
1146 
1147   InstanceKlass* ik = SystemDictionary::Thread_klass();
1148   assert(ik-&gt;is_initialized(), "must be");
1149   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1150 
1151   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1152   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1153   // constructor calls Thread.current(), which must be set here.
1154   java_lang_Thread::set_thread(thread_oop(), this);
1155   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1156   set_threadObj(thread_oop());
1157 
1158   JavaValue result(T_VOID);
1159   if (thread_name != NULL) {
1160     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1161     // Thread gets assigned specified name and null target
1162     JavaCalls::call_special(&amp;result,
1163                             thread_oop,
1164                             ik,
1165                             vmSymbols::object_initializer_name(),
1166                             vmSymbols::threadgroup_string_void_signature(),
1167                             thread_group,
1168                             name,
1169                             THREAD);
1170   } else {
1171     // Thread gets assigned name "Thread-nnn" and null target
1172     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1173     JavaCalls::call_special(&amp;result,
1174                             thread_oop,
1175                             ik,
1176                             vmSymbols::object_initializer_name(),
1177                             vmSymbols::threadgroup_runnable_void_signature(),
1178                             thread_group,
1179                             Handle(),
1180                             THREAD);
1181   }
1182 
1183 
1184   if (daemon) {
1185     java_lang_Thread::set_daemon(thread_oop());
1186   }
1187 
1188   if (HAS_PENDING_EXCEPTION) {
1189     return;
1190   }
1191 
1192   Klass* group =  SystemDictionary::ThreadGroup_klass();
1193   Handle threadObj(THREAD, this-&gt;threadObj());
1194 
1195   JavaCalls::call_special(&amp;result,
1196                           thread_group,
1197                           group,
1198                           vmSymbols::add_method_name(),
1199                           vmSymbols::thread_void_signature(),
1200                           threadObj,          // Arg 1
1201                           THREAD);
1202 }
1203 
1204 // List of all NonJavaThreads and safe iteration over that list.
1205 
1206 class NonJavaThread::List {
1207 public:
1208   NonJavaThread* volatile _head;
1209   SingleWriterSynchronizer _protect;
1210 
1211   List() : _head(NULL), _protect() {}
1212 };
1213 
1214 NonJavaThread::List NonJavaThread::_the_list;
1215 
1216 NonJavaThread::Iterator::Iterator() :
1217   _protect_enter(_the_list._protect.enter()),
1218   _current(OrderAccess::load_acquire(&amp;_the_list._head))
1219 {}
1220 
1221 NonJavaThread::Iterator::~Iterator() {
1222   _the_list._protect.exit(_protect_enter);
1223 }
1224 
1225 void NonJavaThread::Iterator::step() {
1226   assert(!end(), "precondition");
1227   _current = OrderAccess::load_acquire(&amp;_current-&gt;_next);
1228 }
1229 
1230 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1231   // Add this thread to _the_list.
1232   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1233   _next = _the_list._head;
1234   OrderAccess::release_store(&amp;_the_list._head, this);
1235 }
1236 
1237 NonJavaThread::~NonJavaThread() {
1238   // Remove this thread from _the_list.
1239   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1240   NonJavaThread* volatile* p = &amp;_the_list._head;
1241   for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1242     if (t == this) {
1243       *p = this-&gt;_next;
1244       // Wait for any in-progress iterators.
1245       _the_list._protect.synchronize();
1246       break;
1247     }
1248   }
1249 }
1250 
1251 // NamedThread --  non-JavaThread subclasses with multiple
1252 // uniquely named instances should derive from this.
1253 NamedThread::NamedThread() :
1254   NonJavaThread(),
1255   _name(NULL),
1256   _processed_thread(NULL),
1257   _gc_id(GCId::undefined())
1258 {}
1259 
1260 NamedThread::~NamedThread() {
1261   if (_name != NULL) {
1262     FREE_C_HEAP_ARRAY(char, _name);
1263     _name = NULL;
1264   }
1265 }
1266 
1267 void NamedThread::set_name(const char* format, ...) {
1268   guarantee(_name == NULL, "Only get to set name once.");
1269   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1270   guarantee(_name != NULL, "alloc failure");
1271   va_list ap;
1272   va_start(ap, format);
1273   jio_vsnprintf(_name, max_name_len, format, ap);
1274   va_end(ap);
1275 }
1276 
1277 void NamedThread::initialize_named_thread() {
1278   set_native_thread_name(name());
1279 }
1280 
1281 void NamedThread::print_on(outputStream* st) const {
1282   st-&gt;print("\"%s\" ", name());
1283   Thread::print_on(st);
1284   st-&gt;cr();
1285 }
1286 
1287 
1288 // ======= WatcherThread ========
1289 
1290 // The watcher thread exists to simulate timer interrupts.  It should
1291 // be replaced by an abstraction over whatever native support for
1292 // timer interrupts exists on the platform.
1293 
1294 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1295 bool WatcherThread::_startable = false;
1296 volatile bool  WatcherThread::_should_terminate = false;
1297 
1298 WatcherThread::WatcherThread() : NonJavaThread() {
1299   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1300   if (os::create_thread(this, os::watcher_thread)) {
1301     _watcher_thread = this;
1302 
1303     // Set the watcher thread to the highest OS priority which should not be
1304     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1305     // is created. The only normal thread using this priority is the reference
1306     // handler thread, which runs for very short intervals only.
1307     // If the VMThread's priority is not lower than the WatcherThread profiling
1308     // will be inaccurate.
1309     os::set_priority(this, MaxPriority);
1310     if (!DisableStartThread) {
1311       os::start_thread(this);
1312     }
1313   }
1314 }
1315 
1316 int WatcherThread::sleep() const {
1317   // The WatcherThread does not participate in the safepoint protocol
1318   // for the PeriodicTask_lock because it is not a JavaThread.
1319   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1320 
1321   if (_should_terminate) {
1322     // check for termination before we do any housekeeping or wait
1323     return 0;  // we did not sleep.
1324   }
1325 
1326   // remaining will be zero if there are no tasks,
1327   // causing the WatcherThread to sleep until a task is
1328   // enrolled
1329   int remaining = PeriodicTask::time_to_wait();
1330   int time_slept = 0;
1331 
1332   // we expect this to timeout - we only ever get unparked when
1333   // we should terminate or when a new task has been enrolled
1334   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1335 
1336   jlong time_before_loop = os::javaTimeNanos();
1337 
1338   while (true) {
1339     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1340                                             remaining);
1341     jlong now = os::javaTimeNanos();
1342 
1343     if (remaining == 0) {
1344       // if we didn't have any tasks we could have waited for a long time
1345       // consider the time_slept zero and reset time_before_loop
1346       time_slept = 0;
1347       time_before_loop = now;
1348     } else {
1349       // need to recalculate since we might have new tasks in _tasks
1350       time_slept = (int) ((now - time_before_loop) / 1000000);
1351     }
1352 
1353     // Change to task list or spurious wakeup of some kind
1354     if (timedout || _should_terminate) {
1355       break;
1356     }
1357 
1358     remaining = PeriodicTask::time_to_wait();
1359     if (remaining == 0) {
1360       // Last task was just disenrolled so loop around and wait until
1361       // another task gets enrolled
1362       continue;
1363     }
1364 
1365     remaining -= time_slept;
1366     if (remaining &lt;= 0) {
1367       break;
1368     }
1369   }
1370 
1371   return time_slept;
1372 }
1373 
1374 void WatcherThread::run() {
1375   assert(this == watcher_thread(), "just checking");
1376 
1377   this-&gt;record_stack_base_and_size();
1378   this-&gt;set_native_thread_name(this-&gt;name());
1379   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1380   while (true) {
1381     assert(watcher_thread() == Thread::current(), "thread consistency check");
1382     assert(watcher_thread() == this, "thread consistency check");
1383 
1384     // Calculate how long it'll be until the next PeriodicTask work
1385     // should be done, and sleep that amount of time.
1386     int time_waited = sleep();
1387 
1388     if (VMError::is_error_reported()) {
1389       // A fatal error has happened, the error handler(VMError::report_and_die)
1390       // should abort JVM after creating an error log file. However in some
1391       // rare cases, the error handler itself might deadlock. Here periodically
1392       // check for error reporting timeouts, and if it happens, just proceed to
1393       // abort the VM.
1394 
1395       // This code is in WatcherThread because WatcherThread wakes up
1396       // periodically so the fatal error handler doesn't need to do anything;
1397       // also because the WatcherThread is less likely to crash than other
1398       // threads.
1399 
1400       for (;;) {
1401         // Note: we use naked sleep in this loop because we want to avoid using
1402         // any kind of VM infrastructure which may be broken at this point.
1403         if (VMError::check_timeout()) {
1404           // We hit error reporting timeout. Error reporting was interrupted and
1405           // will be wrapping things up now (closing files etc). Give it some more
1406           // time, then quit the VM.
1407           os::naked_short_sleep(200);
1408           // Print a message to stderr.
1409           fdStream err(defaultStream::output_fd());
1410           err.print_raw_cr("# [ timer expired, abort... ]");
1411           // skip atexit/vm_exit/vm_abort hooks
1412           os::die();
1413         }
1414 
1415         // Wait a second, then recheck for timeout.
1416         os::naked_short_sleep(999);
1417       }
1418     }
1419 
1420     if (_should_terminate) {
1421       // check for termination before posting the next tick
1422       break;
1423     }
1424 
1425     PeriodicTask::real_time_tick(time_waited);
1426   }
1427 
1428   // Signal that it is terminated
1429   {
1430     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1431     _watcher_thread = NULL;
1432     Terminator_lock-&gt;notify();
1433   }
1434 }
1435 
1436 void WatcherThread::start() {
1437   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1438 
1439   if (watcher_thread() == NULL &amp;&amp; _startable) {
1440     _should_terminate = false;
1441     // Create the single instance of WatcherThread
1442     new WatcherThread();
1443   }
1444 }
1445 
1446 void WatcherThread::make_startable() {
1447   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1448   _startable = true;
1449 }
1450 
1451 void WatcherThread::stop() {
1452   {
1453     // Follow normal safepoint aware lock enter protocol since the
1454     // WatcherThread is stopped by another JavaThread.
1455     MutexLocker ml(PeriodicTask_lock);
1456     _should_terminate = true;
1457 
1458     WatcherThread* watcher = watcher_thread();
1459     if (watcher != NULL) {
1460       // unpark the WatcherThread so it can see that it should terminate
1461       watcher-&gt;unpark();
1462     }
1463   }
1464 
1465   MutexLocker mu(Terminator_lock);
1466 
1467   while (watcher_thread() != NULL) {
1468     // This wait should make safepoint checks, wait without a timeout,
1469     // and wait as a suspend-equivalent condition.
1470     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1471                           Mutex::_as_suspend_equivalent_flag);
1472   }
1473 }
1474 
1475 void WatcherThread::unpark() {
1476   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1477   PeriodicTask_lock-&gt;notify();
1478 }
1479 
1480 void WatcherThread::print_on(outputStream* st) const {
1481   st-&gt;print("\"%s\" ", name());
1482   Thread::print_on(st);
1483   st-&gt;cr();
1484 }
1485 
1486 // ======= JavaThread ========
1487 
1488 #if INCLUDE_JVMCI
1489 
1490 jlong* JavaThread::_jvmci_old_thread_counters;
1491 
1492 bool jvmci_counters_include(JavaThread* thread) {
1493   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1494 }
1495 
1496 void JavaThread::collect_counters(typeArrayOop array) {
1497   if (JVMCICounterSize &gt; 0) {
1498     JavaThreadIteratorWithHandle jtiwh;
1499     for (int i = 0; i &lt; array-&gt;length(); i++) {
1500       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1501     }
1502     for (; JavaThread *tp = jtiwh.next(); ) {
1503       if (jvmci_counters_include(tp)) {
1504         for (int i = 0; i &lt; array-&gt;length(); i++) {
1505           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1506         }
1507       }
1508     }
1509   }
1510 }
1511 
1512 #endif // INCLUDE_JVMCI
1513 
1514 // A JavaThread is a normal Java thread
1515 
1516 void JavaThread::initialize() {
1517   // Initialize fields
1518 
1519   set_saved_exception_pc(NULL);
1520   set_threadObj(NULL);
1521   _anchor.clear();
1522   set_entry_point(NULL);
1523   set_jni_functions(jni_functions());
1524   set_callee_target(NULL);
1525   set_vm_result(NULL);
1526   set_vm_result_2(NULL);
1527   set_vframe_array_head(NULL);
1528   set_vframe_array_last(NULL);
1529   set_deferred_locals(NULL);
1530   set_deopt_mark(NULL);
1531   set_deopt_compiled_method(NULL);
1532   clear_must_deopt_id();
1533   set_monitor_chunks(NULL);
1534   set_next(NULL);
1535   _on_thread_list = false;
1536   set_thread_state(_thread_new);
1537   _terminated = _not_terminated;
1538   _privileged_stack_top = NULL;
1539   _array_for_gc = NULL;
1540   _suspend_equivalent = false;
1541   _in_deopt_handler = 0;
1542   _doing_unsafe_access = false;
1543   _stack_guard_state = stack_guard_unused;
1544 #if INCLUDE_JVMCI
1545   _pending_monitorenter = false;
1546   _pending_deoptimization = -1;
1547   _pending_failed_speculation = 0;
1548   _pending_transfer_to_interpreter = false;
1549   _adjusting_comp_level = false;
1550   _jvmci._alternate_call_target = NULL;
1551   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1552   if (JVMCICounterSize &gt; 0) {
1553     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1554     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1555   } else {
1556     _jvmci_counters = NULL;
1557   }
1558 #endif // INCLUDE_JVMCI
1559   _reserved_stack_activation = NULL;  // stack base not known yet
1560   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1561   _exception_pc  = 0;
1562   _exception_handler_pc = 0;
1563   _is_method_handle_return = 0;
1564   _jvmti_thread_state= NULL;
1565   _should_post_on_exceptions_flag = JNI_FALSE;
1566   _interp_only_mode    = 0;
1567   _special_runtime_exit_condition = _no_async_condition;
1568   _pending_async_exception = NULL;
1569   _thread_stat = NULL;
1570   _thread_stat = new ThreadStatistics();
1571   _blocked_on_compilation = false;
1572   _jni_active_critical = 0;
1573   _pending_jni_exception_check_fn = NULL;
1574   _do_not_unlock_if_synchronized = false;
1575   _cached_monitor_info = NULL;
1576   _parker = Parker::Allocate(this);
1577 
1578 #ifndef PRODUCT
1579   _jmp_ring_index = 0;
1580   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1581     record_jump(NULL, NULL, NULL, 0);
1582   }
1583 #endif // PRODUCT
1584 
1585   // Setup safepoint state info for this thread
1586   ThreadSafepointState::create(this);
1587 
1588   debug_only(_java_call_counter = 0);
1589 
1590   // JVMTI PopFrame support
1591   _popframe_condition = popframe_inactive;
1592   _popframe_preserved_args = NULL;
1593   _popframe_preserved_args_size = 0;
1594   _frames_to_pop_failed_realloc = 0;
1595 
1596   if (SafepointMechanism::uses_thread_local_poll()) {
1597     SafepointMechanism::initialize_header(this);
1598   }
1599 
1600   pd_initialize();
1601 }
1602 
1603 JavaThread::JavaThread(bool is_attaching_via_jni) :
1604                        Thread() {
1605   initialize();
1606   if (is_attaching_via_jni) {
1607     _jni_attach_state = _attaching_via_jni;
1608   } else {
1609     _jni_attach_state = _not_attaching_via_jni;
1610   }
1611   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1612 }
1613 
1614 bool JavaThread::reguard_stack(address cur_sp) {
1615   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1616       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1617     return true; // Stack already guarded or guard pages not needed.
1618   }
1619 
1620   if (register_stack_overflow()) {
1621     // For those architectures which have separate register and
1622     // memory stacks, we must check the register stack to see if
1623     // it has overflowed.
1624     return false;
1625   }
1626 
1627   // Java code never executes within the yellow zone: the latter is only
1628   // there to provoke an exception during stack banging.  If java code
1629   // is executing there, either StackShadowPages should be larger, or
1630   // some exception code in c1, c2 or the interpreter isn't unwinding
1631   // when it should.
1632   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1633             "not enough space to reguard - increase StackShadowPages");
1634   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1635     enable_stack_yellow_reserved_zone();
1636     if (reserved_stack_activation() != stack_base()) {
1637       set_reserved_stack_activation(stack_base());
1638     }
1639   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1640     set_reserved_stack_activation(stack_base());
1641     enable_stack_reserved_zone();
1642   }
1643   return true;
1644 }
1645 
1646 bool JavaThread::reguard_stack(void) {
1647   return reguard_stack(os::current_stack_pointer());
1648 }
1649 
1650 
1651 void JavaThread::block_if_vm_exited() {
1652   if (_terminated == _vm_exited) {
1653     // _vm_exited is set at safepoint, and Threads_lock is never released
1654     // we will block here forever
1655     Threads_lock-&gt;lock_without_safepoint_check();
1656     ShouldNotReachHere();
1657   }
1658 }
1659 
1660 
1661 // Remove this ifdef when C1 is ported to the compiler interface.
1662 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1663 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1664 
1665 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1666                        Thread() {
1667   initialize();
1668   _jni_attach_state = _not_attaching_via_jni;
1669   set_entry_point(entry_point);
1670   // Create the native thread itself.
1671   // %note runtime_23
1672   os::ThreadType thr_type = os::java_thread;
1673   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1674                                                      os::java_thread;
1675   os::create_thread(this, thr_type, stack_sz);
1676   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1677   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1678   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1679   // the exception consists of creating the exception object &amp; initializing it, initialization
1680   // will leave the VM via a JavaCall and then all locks must be unlocked).
1681   //
1682   // The thread is still suspended when we reach here. Thread must be explicit started
1683   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1684   // by calling Threads:add. The reason why this is not done here, is because the thread
1685   // object must be fully initialized (take a look at JVM_Start)
1686 }
1687 
1688 JavaThread::~JavaThread() {
1689 
1690   // JSR166 -- return the parker to the free list
1691   Parker::Release(_parker);
1692   _parker = NULL;
1693 
1694   // Free any remaining  previous UnrollBlock
1695   vframeArray* old_array = vframe_array_last();
1696 
1697   if (old_array != NULL) {
1698     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1699     old_array-&gt;set_unroll_block(NULL);
1700     delete old_info;
1701     delete old_array;
1702   }
1703 
1704   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1705   if (deferred != NULL) {
1706     // This can only happen if thread is destroyed before deoptimization occurs.
1707     assert(deferred-&gt;length() != 0, "empty array!");
1708     do {
1709       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1710       deferred-&gt;remove_at(0);
1711       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1712       delete dlv;
1713     } while (deferred-&gt;length() != 0);
1714     delete deferred;
1715   }
1716 
1717   // All Java related clean up happens in exit
1718   ThreadSafepointState::destroy(this);
1719   if (_thread_stat != NULL) delete _thread_stat;
1720 
1721 #if INCLUDE_JVMCI
1722   if (JVMCICounterSize &gt; 0) {
1723     if (jvmci_counters_include(this)) {
1724       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1725         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1726       }
1727     }
1728     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1729   }
1730 #endif // INCLUDE_JVMCI
1731 }
1732 
1733 
1734 // The first routine called by a new Java thread
1735 void JavaThread::run() {
1736   // initialize thread-local alloc buffer related fields
1737   this-&gt;initialize_tlab();
1738 
1739   // used to test validity of stack trace backs
1740   this-&gt;record_base_of_stack_pointer();
1741 
1742   // Record real stack base and size.
1743   this-&gt;record_stack_base_and_size();
1744 
1745   this-&gt;create_stack_guard_pages();
1746 
1747   this-&gt;cache_global_variables();
1748 
1749   // Thread is now sufficient initialized to be handled by the safepoint code as being
1750   // in the VM. Change thread state from _thread_new to _thread_in_vm
1751   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1752 
1753   assert(JavaThread::current() == this, "sanity check");
1754   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1755 
1756   DTRACE_THREAD_PROBE(start, this);
1757 
1758   // This operation might block. We call that after all safepoint checks for a new thread has
1759   // been completed.
1760   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1761 
1762   if (JvmtiExport::should_post_thread_life()) {
1763     JvmtiExport::post_thread_start(this);
1764   }
1765 
1766   EventThreadStart event;
1767   if (event.should_commit()) {
1768     event.set_thread(JFR_THREAD_ID(this));
1769     event.commit();
1770   }
1771 
1772   // We call another function to do the rest so we are sure that the stack addresses used
1773   // from there will be lower than the stack base just computed
1774   thread_main_inner();
1775 
1776   // Note, thread is no longer valid at this point!
1777 }
1778 
1779 
1780 void JavaThread::thread_main_inner() {
1781   assert(JavaThread::current() == this, "sanity check");
1782   assert(this-&gt;threadObj() != NULL, "just checking");
1783 
1784   // Execute thread entry point unless this thread has a pending exception
1785   // or has been stopped before starting.
1786   // Note: Due to JVM_StopThread we can have pending exceptions already!
1787   if (!this-&gt;has_pending_exception() &amp;&amp;
1788       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1789     {
1790       ResourceMark rm(this);
1791       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1792     }
1793     HandleMark hm(this);
1794     this-&gt;entry_point()(this, this);
1795   }
1796 
1797   DTRACE_THREAD_PROBE(stop, this);
1798 
1799   this-&gt;exit(false);
1800   this-&gt;smr_delete();
1801 }
1802 
1803 
1804 static void ensure_join(JavaThread* thread) {
1805   // We do not need to grab the Threads_lock, since we are operating on ourself.
1806   Handle threadObj(thread, thread-&gt;threadObj());
1807   assert(threadObj.not_null(), "java thread object must exist");
1808   ObjectLocker lock(threadObj, thread);
1809   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1810   thread-&gt;clear_pending_exception();
1811   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1812   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1813   // Clear the native thread instance - this makes isAlive return false and allows the join()
1814   // to complete once we've done the notify_all below
1815   java_lang_Thread::set_thread(threadObj(), NULL);
1816   lock.notify_all(thread);
1817   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1818   thread-&gt;clear_pending_exception();
1819 }
1820 
1821 
1822 // For any new cleanup additions, please check to see if they need to be applied to
1823 // cleanup_failed_attach_current_thread as well.
1824 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1825   assert(this == JavaThread::current(), "thread consistency check");
1826 
1827   elapsedTimer _timer_exit_phase1;
1828   elapsedTimer _timer_exit_phase2;
1829   elapsedTimer _timer_exit_phase3;
1830   elapsedTimer _timer_exit_phase4;
1831 
1832   if (log_is_enabled(Debug, os, thread, timer)) {
1833     _timer_exit_phase1.start();
1834   }
1835 
1836   HandleMark hm(this);
1837   Handle uncaught_exception(this, this-&gt;pending_exception());
1838   this-&gt;clear_pending_exception();
1839   Handle threadObj(this, this-&gt;threadObj());
1840   assert(threadObj.not_null(), "Java thread object should be created");
1841 
1842   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1843   {
1844     EXCEPTION_MARK;
1845 
1846     CLEAR_PENDING_EXCEPTION;
1847   }
1848   if (!destroy_vm) {
1849     if (uncaught_exception.not_null()) {
1850       EXCEPTION_MARK;
1851       // Call method Thread.dispatchUncaughtException().
1852       Klass* thread_klass = SystemDictionary::Thread_klass();
1853       JavaValue result(T_VOID);
1854       JavaCalls::call_virtual(&amp;result,
1855                               threadObj, thread_klass,
1856                               vmSymbols::dispatchUncaughtException_name(),
1857                               vmSymbols::throwable_void_signature(),
1858                               uncaught_exception,
1859                               THREAD);
1860       if (HAS_PENDING_EXCEPTION) {
1861         ResourceMark rm(this);
1862         jio_fprintf(defaultStream::error_stream(),
1863                     "\nException: %s thrown from the UncaughtExceptionHandler"
1864                     " in thread \"%s\"\n",
1865                     pending_exception()-&gt;klass()-&gt;external_name(),
1866                     get_thread_name());
1867         CLEAR_PENDING_EXCEPTION;
1868       }
1869     }
1870 
1871     // Called before the java thread exit since we want to read info
1872     // from java_lang_Thread object
1873     EventThreadEnd event;
1874     if (event.should_commit()) {
1875       event.set_thread(JFR_THREAD_ID(this));
1876       event.commit();
1877     }
1878 
1879     // Call after last event on thread
1880     JFR_ONLY(Jfr::on_thread_exit(this);)
1881 
1882     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1883     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1884     // is deprecated anyhow.
1885     if (!is_Compiler_thread()) {
1886       int count = 3;
1887       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1888         EXCEPTION_MARK;
1889         JavaValue result(T_VOID);
1890         Klass* thread_klass = SystemDictionary::Thread_klass();
1891         JavaCalls::call_virtual(&amp;result,
1892                                 threadObj, thread_klass,
1893                                 vmSymbols::exit_method_name(),
1894                                 vmSymbols::void_method_signature(),
1895                                 THREAD);
1896         CLEAR_PENDING_EXCEPTION;
1897       }
1898     }
1899     // notify JVMTI
1900     if (JvmtiExport::should_post_thread_life()) {
1901       JvmtiExport::post_thread_end(this);
1902     }
1903 
1904     // We have notified the agents that we are exiting, before we go on,
1905     // we must check for a pending external suspend request and honor it
1906     // in order to not surprise the thread that made the suspend request.
1907     while (true) {
1908       {
1909         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1910         if (!is_external_suspend()) {
1911           set_terminated(_thread_exiting);
1912           ThreadService::current_thread_exiting(this);
1913           break;
1914         }
1915         // Implied else:
1916         // Things get a little tricky here. We have a pending external
1917         // suspend request, but we are holding the SR_lock so we
1918         // can't just self-suspend. So we temporarily drop the lock
1919         // and then self-suspend.
1920       }
1921 
1922       ThreadBlockInVM tbivm(this);
1923       java_suspend_self();
1924 
1925       // We're done with this suspend request, but we have to loop around
1926       // and check again. Eventually we will get SR_lock without a pending
1927       // external suspend request and will be able to mark ourselves as
1928       // exiting.
1929     }
1930     // no more external suspends are allowed at this point
1931   } else {
1932     // before_exit() has already posted JVMTI THREAD_END events
1933   }
1934 
1935   if (log_is_enabled(Debug, os, thread, timer)) {
1936     _timer_exit_phase1.stop();
1937     _timer_exit_phase2.start();
1938   }
1939   // Notify waiters on thread object. This has to be done after exit() is called
1940   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1941   // group should have the destroyed bit set before waiters are notified).
1942   ensure_join(this);
1943   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1944 
1945   if (log_is_enabled(Debug, os, thread, timer)) {
1946     _timer_exit_phase2.stop();
1947     _timer_exit_phase3.start();
1948   }
1949   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1950   // held by this thread must be released. The spec does not distinguish
1951   // between JNI-acquired and regular Java monitors. We can only see
1952   // regular Java monitors here if monitor enter-exit matching is broken.
1953   //
1954   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1955   // ObjectSynchronizer::release_monitors_owned_by_thread().
1956   if (exit_type == jni_detach) {
1957     // Sanity check even though JNI DetachCurrentThread() would have
1958     // returned JNI_ERR if there was a Java frame. JavaThread exit
1959     // should be done executing Java code by the time we get here.
1960     assert(!this-&gt;has_last_Java_frame(),
1961            "should not have a Java frame when detaching or exiting");
1962     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1963     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1964   }
1965 
1966   // These things needs to be done while we are still a Java Thread. Make sure that thread
1967   // is in a consistent state, in case GC happens
1968   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1969 
1970   if (active_handles() != NULL) {
1971     JNIHandleBlock* block = active_handles();
1972     set_active_handles(NULL);
1973     JNIHandleBlock::release_block(block);
1974   }
1975 
1976   if (free_handle_block() != NULL) {
1977     JNIHandleBlock* block = free_handle_block();
1978     set_free_handle_block(NULL);
1979     JNIHandleBlock::release_block(block);
1980   }
1981 
1982   // These have to be removed while this is still a valid thread.
1983   remove_stack_guard_pages();
1984 
1985   if (UseTLAB) {
1986     tlab().retire();
1987   }
1988 
1989   if (JvmtiEnv::environments_might_exist()) {
1990     JvmtiExport::cleanup_thread(this);
1991   }
1992 
1993   // We must flush any deferred card marks and other various GC barrier
1994   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
1995   // before removing a thread from the list of active threads.
1996   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
1997 
1998   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
1999     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
2000     os::current_thread_id());
2001 
2002   if (log_is_enabled(Debug, os, thread, timer)) {
2003     _timer_exit_phase3.stop();
2004     _timer_exit_phase4.start();
2005   }
2006   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2007   Threads::remove(this);
2008 
2009   if (log_is_enabled(Debug, os, thread, timer)) {
2010     _timer_exit_phase4.stop();
2011     ResourceMark rm(this);
2012     log_debug(os, thread, timer)("name='%s'"
2013                                  ", exit-phase1=" JLONG_FORMAT
2014                                  ", exit-phase2=" JLONG_FORMAT
2015                                  ", exit-phase3=" JLONG_FORMAT
2016                                  ", exit-phase4=" JLONG_FORMAT,
2017                                  get_thread_name(),
2018                                  _timer_exit_phase1.milliseconds(),
2019                                  _timer_exit_phase2.milliseconds(),
2020                                  _timer_exit_phase3.milliseconds(),
2021                                  _timer_exit_phase4.milliseconds());
2022   }
2023 }
2024 
2025 void JavaThread::cleanup_failed_attach_current_thread() {
2026   if (active_handles() != NULL) {
2027     JNIHandleBlock* block = active_handles();
2028     set_active_handles(NULL);
2029     JNIHandleBlock::release_block(block);
2030   }
2031 
2032   if (free_handle_block() != NULL) {
2033     JNIHandleBlock* block = free_handle_block();
2034     set_free_handle_block(NULL);
2035     JNIHandleBlock::release_block(block);
2036   }
2037 
2038   // These have to be removed while this is still a valid thread.
2039   remove_stack_guard_pages();
2040 
2041   if (UseTLAB) {
2042     tlab().retire();
2043   }
2044 
2045   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2046 
2047   Threads::remove(this);
2048   this-&gt;smr_delete();
2049 }
2050 
2051 JavaThread* JavaThread::active() {
2052   Thread* thread = Thread::current();
2053   if (thread-&gt;is_Java_thread()) {
2054     return (JavaThread*) thread;
2055   } else {
2056     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2057     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2058     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2059     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2060     return ret;
2061   }
2062 }
2063 
2064 bool JavaThread::is_lock_owned(address adr) const {
2065   if (Thread::is_lock_owned(adr)) return true;
2066 
2067   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2068     if (chunk-&gt;contains(adr)) return true;
2069   }
2070 
2071   return false;
2072 }
2073 
2074 
2075 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2076   chunk-&gt;set_next(monitor_chunks());
2077   set_monitor_chunks(chunk);
2078 }
2079 
2080 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2081   guarantee(monitor_chunks() != NULL, "must be non empty");
2082   if (monitor_chunks() == chunk) {
2083     set_monitor_chunks(chunk-&gt;next());
2084   } else {
2085     MonitorChunk* prev = monitor_chunks();
2086     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2087     prev-&gt;set_next(chunk-&gt;next());
2088   }
2089 }
2090 
2091 // JVM support.
2092 
2093 // Note: this function shouldn't block if it's called in
2094 // _thread_in_native_trans state (such as from
2095 // check_special_condition_for_native_trans()).
2096 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2097 
2098   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2099     // If we are at a polling page safepoint (not a poll return)
2100     // then we must defer async exception because live registers
2101     // will be clobbered by the exception path. Poll return is
2102     // ok because the call we a returning from already collides
2103     // with exception handling registers and so there is no issue.
2104     // (The exception handling path kills call result registers but
2105     //  this is ok since the exception kills the result anyway).
2106 
2107     if (is_at_poll_safepoint()) {
2108       // if the code we are returning to has deoptimized we must defer
2109       // the exception otherwise live registers get clobbered on the
2110       // exception path before deoptimization is able to retrieve them.
2111       //
2112       RegisterMap map(this, false);
2113       frame caller_fr = last_frame().sender(&amp;map);
2114       assert(caller_fr.is_compiled_frame(), "what?");
2115       if (caller_fr.is_deoptimized_frame()) {
2116         log_info(exceptions)("deferred async exception at compiled safepoint");
2117         return;
2118       }
2119     }
2120   }
2121 
2122   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2123   if (condition == _no_async_condition) {
2124     // Conditions have changed since has_special_runtime_exit_condition()
2125     // was called:
2126     // - if we were here only because of an external suspend request,
2127     //   then that was taken care of above (or cancelled) so we are done
2128     // - if we were here because of another async request, then it has
2129     //   been cleared between the has_special_runtime_exit_condition()
2130     //   and now so again we are done
2131     return;
2132   }
2133 
2134   // Check for pending async. exception
2135   if (_pending_async_exception != NULL) {
2136     // Only overwrite an already pending exception, if it is not a threadDeath.
2137     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2138 
2139       // We cannot call Exceptions::_throw(...) here because we cannot block
2140       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2141 
2142       LogTarget(Info, exceptions) lt;
2143       if (lt.is_enabled()) {
2144         ResourceMark rm;
2145         LogStream ls(lt);
2146         ls.print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2147           if (has_last_Java_frame()) {
2148             frame f = last_frame();
2149            ls.print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2150           }
2151         ls.print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2152       }
2153       _pending_async_exception = NULL;
2154       clear_has_async_exception();
2155     }
2156   }
2157 
2158   if (check_unsafe_error &amp;&amp;
2159       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2160     condition = _no_async_condition;  // done
2161     switch (thread_state()) {
2162     case _thread_in_vm: {
2163       JavaThread* THREAD = this;
2164       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2165     }
2166     case _thread_in_native: {
2167       ThreadInVMfromNative tiv(this);
2168       JavaThread* THREAD = this;
2169       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2170     }
2171     case _thread_in_Java: {
2172       ThreadInVMfromJava tiv(this);
2173       JavaThread* THREAD = this;
2174       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2175     }
2176     default:
2177       ShouldNotReachHere();
2178     }
2179   }
2180 
2181   assert(condition == _no_async_condition || has_pending_exception() ||
2182          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2183          "must have handled the async condition, if no exception");
2184 }
2185 
2186 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2187   //
2188   // Check for pending external suspend. Internal suspend requests do
2189   // not use handle_special_runtime_exit_condition().
2190   // If JNIEnv proxies are allowed, don't self-suspend if the target
2191   // thread is not the current thread. In older versions of jdbx, jdbx
2192   // threads could call into the VM with another thread's JNIEnv so we
2193   // can be here operating on behalf of a suspended thread (4432884).
2194   bool do_self_suspend = is_external_suspend_with_lock();
2195   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2196     //
2197     // Because thread is external suspended the safepoint code will count
2198     // thread as at a safepoint. This can be odd because we can be here
2199     // as _thread_in_Java which would normally transition to _thread_blocked
2200     // at a safepoint. We would like to mark the thread as _thread_blocked
2201     // before calling java_suspend_self like all other callers of it but
2202     // we must then observe proper safepoint protocol. (We can't leave
2203     // _thread_blocked with a safepoint in progress). However we can be
2204     // here as _thread_in_native_trans so we can't use a normal transition
2205     // constructor/destructor pair because they assert on that type of
2206     // transition. We could do something like:
2207     //
2208     // JavaThreadState state = thread_state();
2209     // set_thread_state(_thread_in_vm);
2210     // {
2211     //   ThreadBlockInVM tbivm(this);
2212     //   java_suspend_self()
2213     // }
2214     // set_thread_state(_thread_in_vm_trans);
2215     // if (safepoint) block;
2216     // set_thread_state(state);
2217     //
2218     // but that is pretty messy. Instead we just go with the way the
2219     // code has worked before and note that this is the only path to
2220     // java_suspend_self that doesn't put the thread in _thread_blocked
2221     // mode.
2222 
2223     frame_anchor()-&gt;make_walkable(this);
2224     java_suspend_self();
2225 
2226     // We might be here for reasons in addition to the self-suspend request
2227     // so check for other async requests.
2228   }
2229 
2230   if (check_asyncs) {
2231     check_and_handle_async_exceptions();
2232   }
2233 
2234   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2235 }
2236 
2237 void JavaThread::send_thread_stop(oop java_throwable)  {
2238   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2239   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2240   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2241 
2242   // Do not throw asynchronous exceptions against the compiler thread
2243   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2244   if (!can_call_java()) return;
2245 
2246   {
2247     // Actually throw the Throwable against the target Thread - however
2248     // only if there is no thread death exception installed already.
2249     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2250       // If the topmost frame is a runtime stub, then we are calling into
2251       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2252       // must deoptimize the caller before continuing, as the compiled  exception handler table
2253       // may not be valid
2254       if (has_last_Java_frame()) {
2255         frame f = last_frame();
2256         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2257           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2258           RegisterMap reg_map(this, UseBiasedLocking);
2259           frame compiled_frame = f.sender(&amp;reg_map);
2260           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2261             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2262           }
2263         }
2264       }
2265 
2266       // Set async. pending exception in thread.
2267       set_pending_async_exception(java_throwable);
2268 
2269       if (log_is_enabled(Info, exceptions)) {
2270          ResourceMark rm;
2271         log_info(exceptions)("Pending Async. exception installed of type: %s",
2272                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2273       }
2274       // for AbortVMOnException flag
2275       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2276     }
2277   }
2278 
2279 
2280   // Interrupt thread so it will wake up from a potential wait()
2281   Thread::interrupt(this);
2282 }
2283 
2284 // External suspension mechanism.
2285 //
2286 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2287 // to any VM_locks and it is at a transition
2288 // Self-suspension will happen on the transition out of the vm.
2289 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2290 //
2291 // Guarantees on return:
2292 //   + Target thread will not execute any new bytecode (that's why we need to
2293 //     force a safepoint)
2294 //   + Target thread will not enter any new monitors
2295 //
2296 void JavaThread::java_suspend() {
2297   ThreadsListHandle tlh;
2298   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2299     return;
2300   }
2301 
2302   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2303     if (!is_external_suspend()) {
2304       // a racing resume has cancelled us; bail out now
2305       return;
2306     }
2307 
2308     // suspend is done
2309     uint32_t debug_bits = 0;
2310     // Warning: is_ext_suspend_completed() may temporarily drop the
2311     // SR_lock to allow the thread to reach a stable thread state if
2312     // it is currently in a transient thread state.
2313     if (is_ext_suspend_completed(false /* !called_by_wait */,
2314                                  SuspendRetryDelay, &amp;debug_bits)) {
2315       return;
2316     }
2317   }
2318 
2319   VM_ThreadSuspend vm_suspend;
2320   VMThread::execute(&amp;vm_suspend);
2321 }
2322 
2323 // Part II of external suspension.
2324 // A JavaThread self suspends when it detects a pending external suspend
2325 // request. This is usually on transitions. It is also done in places
2326 // where continuing to the next transition would surprise the caller,
2327 // e.g., monitor entry.
2328 //
2329 // Returns the number of times that the thread self-suspended.
2330 //
2331 // Note: DO NOT call java_suspend_self() when you just want to block current
2332 //       thread. java_suspend_self() is the second stage of cooperative
2333 //       suspension for external suspend requests and should only be used
2334 //       to complete an external suspend request.
2335 //
2336 int JavaThread::java_suspend_self() {
2337   int ret = 0;
2338 
2339   // we are in the process of exiting so don't suspend
2340   if (is_exiting()) {
2341     clear_external_suspend();
2342     return ret;
2343   }
2344 
2345   assert(_anchor.walkable() ||
2346          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2347          "must have walkable stack");
2348 
2349   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2350 
2351   assert(!this-&gt;is_ext_suspended(),
2352          "a thread trying to self-suspend should not already be suspended");
2353 
2354   if (this-&gt;is_suspend_equivalent()) {
2355     // If we are self-suspending as a result of the lifting of a
2356     // suspend equivalent condition, then the suspend_equivalent
2357     // flag is not cleared until we set the ext_suspended flag so
2358     // that wait_for_ext_suspend_completion() returns consistent
2359     // results.
2360     this-&gt;clear_suspend_equivalent();
2361   }
2362 
2363   // A racing resume may have cancelled us before we grabbed SR_lock
2364   // above. Or another external suspend request could be waiting for us
2365   // by the time we return from SR_lock()-&gt;wait(). The thread
2366   // that requested the suspension may already be trying to walk our
2367   // stack and if we return now, we can change the stack out from under
2368   // it. This would be a "bad thing (TM)" and cause the stack walker
2369   // to crash. We stay self-suspended until there are no more pending
2370   // external suspend requests.
2371   while (is_external_suspend()) {
2372     ret++;
2373     this-&gt;set_ext_suspended();
2374 
2375     // _ext_suspended flag is cleared by java_resume()
2376     while (is_ext_suspended()) {
2377       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2378     }
2379   }
2380 
2381   return ret;
2382 }
2383 
2384 #ifdef ASSERT
2385 // Verify the JavaThread has not yet been published in the Threads::list, and
2386 // hence doesn't need protection from concurrent access at this stage.
2387 void JavaThread::verify_not_published() {
2388   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2389   // since an unpublished JavaThread doesn't participate in the
2390   // Thread-SMR protocol for keeping a ThreadsList alive.
2391   assert(!on_thread_list(), "JavaThread shouldn't have been published yet!");
2392 }
2393 #endif
2394 
2395 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2396 // progress or when _suspend_flags is non-zero.
2397 // Current thread needs to self-suspend if there is a suspend request and/or
2398 // block if a safepoint is in progress.
2399 // Async exception ISN'T checked.
2400 // Note only the ThreadInVMfromNative transition can call this function
2401 // directly and when thread state is _thread_in_native_trans
2402 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2403   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2404 
2405   JavaThread *curJT = JavaThread::current();
2406   bool do_self_suspend = thread-&gt;is_external_suspend();
2407 
2408   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2409 
2410   // If JNIEnv proxies are allowed, don't self-suspend if the target
2411   // thread is not the current thread. In older versions of jdbx, jdbx
2412   // threads could call into the VM with another thread's JNIEnv so we
2413   // can be here operating on behalf of a suspended thread (4432884).
2414   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2415     JavaThreadState state = thread-&gt;thread_state();
2416 
2417     // We mark this thread_blocked state as a suspend-equivalent so
2418     // that a caller to is_ext_suspend_completed() won't be confused.
2419     // The suspend-equivalent state is cleared by java_suspend_self().
2420     thread-&gt;set_suspend_equivalent();
2421 
2422     // If the safepoint code sees the _thread_in_native_trans state, it will
2423     // wait until the thread changes to other thread state. There is no
2424     // guarantee on how soon we can obtain the SR_lock and complete the
2425     // self-suspend request. It would be a bad idea to let safepoint wait for
2426     // too long. Temporarily change the state to _thread_blocked to
2427     // let the VM thread know that this thread is ready for GC. The problem
2428     // of changing thread state is that safepoint could happen just after
2429     // java_suspend_self() returns after being resumed, and VM thread will
2430     // see the _thread_blocked state. We must check for safepoint
2431     // after restoring the state and make sure we won't leave while a safepoint
2432     // is in progress.
2433     thread-&gt;set_thread_state(_thread_blocked);
2434     thread-&gt;java_suspend_self();
2435     thread-&gt;set_thread_state(state);
2436 
2437     InterfaceSupport::serialize_thread_state_with_handler(thread);
2438   }
2439 
2440   SafepointMechanism::block_if_requested(curJT);
2441 
2442   if (thread-&gt;is_deopt_suspend()) {
2443     thread-&gt;clear_deopt_suspend();
2444     RegisterMap map(thread, false);
2445     frame f = thread-&gt;last_frame();
2446     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2447       f = f.sender(&amp;map);
2448     }
2449     if (f.id() == thread-&gt;must_deopt_id()) {
2450       thread-&gt;clear_must_deopt_id();
2451       f.deoptimize(thread);
2452     } else {
2453       fatal("missed deoptimization!");
2454     }
2455   }
2456 
2457   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2458 }
2459 
2460 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2461 // progress or when _suspend_flags is non-zero.
2462 // Current thread needs to self-suspend if there is a suspend request and/or
2463 // block if a safepoint is in progress.
2464 // Also check for pending async exception (not including unsafe access error).
2465 // Note only the native==&gt;VM/Java barriers can call this function and when
2466 // thread state is _thread_in_native_trans.
2467 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2468   check_safepoint_and_suspend_for_native_trans(thread);
2469 
2470   if (thread-&gt;has_async_exception()) {
2471     // We are in _thread_in_native_trans state, don't handle unsafe
2472     // access error since that may block.
2473     thread-&gt;check_and_handle_async_exceptions(false);
2474   }
2475 }
2476 
2477 // This is a variant of the normal
2478 // check_special_condition_for_native_trans with slightly different
2479 // semantics for use by critical native wrappers.  It does all the
2480 // normal checks but also performs the transition back into
2481 // thread_in_Java state.  This is required so that critical natives
2482 // can potentially block and perform a GC if they are the last thread
2483 // exiting the GCLocker.
2484 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2485   check_special_condition_for_native_trans(thread);
2486 
2487   // Finish the transition
2488   thread-&gt;set_thread_state(_thread_in_Java);
2489 
2490   if (thread-&gt;do_critical_native_unlock()) {
2491     ThreadInVMfromJavaNoAsyncException tiv(thread);
2492     GCLocker::unlock_critical(thread);
2493     thread-&gt;clear_critical_native_unlock();
2494   }
2495 }
2496 
2497 // We need to guarantee the Threads_lock here, since resumes are not
2498 // allowed during safepoint synchronization
2499 // Can only resume from an external suspension
2500 void JavaThread::java_resume() {
2501   assert_locked_or_safepoint(Threads_lock);
2502 
2503   // Sanity check: thread is gone, has started exiting or the thread
2504   // was not externally suspended.
2505   ThreadsListHandle tlh;
2506   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2507     return;
2508   }
2509 
2510   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2511 
2512   clear_external_suspend();
2513 
2514   if (is_ext_suspended()) {
2515     clear_ext_suspended();
2516     SR_lock()-&gt;notify_all();
2517   }
2518 }
2519 
2520 size_t JavaThread::_stack_red_zone_size = 0;
2521 size_t JavaThread::_stack_yellow_zone_size = 0;
2522 size_t JavaThread::_stack_reserved_zone_size = 0;
2523 size_t JavaThread::_stack_shadow_zone_size = 0;
2524 
2525 void JavaThread::create_stack_guard_pages() {
2526   if (!os::uses_stack_guard_pages() ||
2527       _stack_guard_state != stack_guard_unused ||
2528       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2529       log_info(os, thread)("Stack guard page creation for thread "
2530                            UINTX_FORMAT " disabled", os::current_thread_id());
2531     return;
2532   }
2533   address low_addr = stack_end();
2534   size_t len = stack_guard_zone_size();
2535 
2536   assert(is_aligned(low_addr, os::vm_page_size()), "Stack base should be the start of a page");
2537   assert(is_aligned(len, os::vm_page_size()), "Stack size should be a multiple of page size");
2538 
2539   int must_commit = os::must_commit_stack_guard_pages();
2540   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2541 
2542   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2543     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2544     return;
2545   }
2546 
2547   if (os::guard_memory((char *) low_addr, len)) {
2548     _stack_guard_state = stack_guard_enabled;
2549   } else {
2550     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2551       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2552     if (os::uncommit_memory((char *) low_addr, len)) {
2553       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2554     }
2555     return;
2556   }
2557 
2558   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2559     PTR_FORMAT "-" PTR_FORMAT ".",
2560     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2561 }
2562 
2563 void JavaThread::remove_stack_guard_pages() {
2564   assert(Thread::current() == this, "from different thread");
2565   if (_stack_guard_state == stack_guard_unused) return;
2566   address low_addr = stack_end();
2567   size_t len = stack_guard_zone_size();
2568 
2569   if (os::must_commit_stack_guard_pages()) {
2570     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2571       _stack_guard_state = stack_guard_unused;
2572     } else {
2573       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2574         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2575       return;
2576     }
2577   } else {
2578     if (_stack_guard_state == stack_guard_unused) return;
2579     if (os::unguard_memory((char *) low_addr, len)) {
2580       _stack_guard_state = stack_guard_unused;
2581     } else {
2582       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2583         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2584       return;
2585     }
2586   }
2587 
2588   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2589     PTR_FORMAT "-" PTR_FORMAT ".",
2590     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2591 }
2592 
2593 void JavaThread::enable_stack_reserved_zone() {
2594   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2595   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2596 
2597   // The base notation is from the stack's point of view, growing downward.
2598   // We need to adjust it to work correctly with guard_memory()
2599   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2600 
2601   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2602   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2603 
2604   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2605     _stack_guard_state = stack_guard_enabled;
2606   } else {
2607     warning("Attempt to guard stack reserved zone failed.");
2608   }
2609   enable_register_stack_guard();
2610 }
2611 
2612 void JavaThread::disable_stack_reserved_zone() {
2613   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2614   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2615 
2616   // Simply return if called for a thread that does not use guard pages.
2617   if (_stack_guard_state == stack_guard_unused) return;
2618 
2619   // The base notation is from the stack's point of view, growing downward.
2620   // We need to adjust it to work correctly with guard_memory()
2621   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2622 
2623   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2624     _stack_guard_state = stack_guard_reserved_disabled;
2625   } else {
2626     warning("Attempt to unguard stack reserved zone failed.");
2627   }
2628   disable_register_stack_guard();
2629 }
2630 
2631 void JavaThread::enable_stack_yellow_reserved_zone() {
2632   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2633   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2634 
2635   // The base notation is from the stacks point of view, growing downward.
2636   // We need to adjust it to work correctly with guard_memory()
2637   address base = stack_red_zone_base();
2638 
2639   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2640   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2641 
2642   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2643     _stack_guard_state = stack_guard_enabled;
2644   } else {
2645     warning("Attempt to guard stack yellow zone failed.");
2646   }
2647   enable_register_stack_guard();
2648 }
2649 
2650 void JavaThread::disable_stack_yellow_reserved_zone() {
2651   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2652   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2653 
2654   // Simply return if called for a thread that does not use guard pages.
2655   if (_stack_guard_state == stack_guard_unused) return;
2656 
2657   // The base notation is from the stacks point of view, growing downward.
2658   // We need to adjust it to work correctly with guard_memory()
2659   address base = stack_red_zone_base();
2660 
2661   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2662     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2663   } else {
2664     warning("Attempt to unguard stack yellow zone failed.");
2665   }
2666   disable_register_stack_guard();
2667 }
2668 
2669 void JavaThread::enable_stack_red_zone() {
2670   // The base notation is from the stacks point of view, growing downward.
2671   // We need to adjust it to work correctly with guard_memory()
2672   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2673   address base = stack_red_zone_base() - stack_red_zone_size();
2674 
2675   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2676   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2677 
2678   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2679     warning("Attempt to guard stack red zone failed.");
2680   }
2681 }
2682 
2683 void JavaThread::disable_stack_red_zone() {
2684   // The base notation is from the stacks point of view, growing downward.
2685   // We need to adjust it to work correctly with guard_memory()
2686   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2687   address base = stack_red_zone_base() - stack_red_zone_size();
2688   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2689     warning("Attempt to unguard stack red zone failed.");
2690   }
2691 }
2692 
2693 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2694   // ignore is there is no stack
2695   if (!has_last_Java_frame()) return;
2696   // traverse the stack frames. Starts from top frame.
2697   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2698     frame* fr = fst.current();
2699     f(fr, fst.register_map());
2700   }
2701 }
2702 
2703 
2704 #ifndef PRODUCT
2705 // Deoptimization
2706 // Function for testing deoptimization
2707 void JavaThread::deoptimize() {
2708   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2709   StackFrameStream fst(this, UseBiasedLocking);
2710   bool deopt = false;           // Dump stack only if a deopt actually happens.
2711   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2712   // Iterate over all frames in the thread and deoptimize
2713   for (; !fst.is_done(); fst.next()) {
2714     if (fst.current()-&gt;can_be_deoptimized()) {
2715 
2716       if (only_at) {
2717         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2718         // consists of comma or carriage return separated numbers so
2719         // search for the current bci in that string.
2720         address pc = fst.current()-&gt;pc();
2721         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2722         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2723         char buffer[8];
2724         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2725         size_t len = strlen(buffer);
2726         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2727         while (found != NULL) {
2728           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2729               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2730             // Check that the bci found is bracketed by terminators.
2731             break;
2732           }
2733           found = strstr(found + 1, buffer);
2734         }
2735         if (!found) {
2736           continue;
2737         }
2738       }
2739 
2740       if (DebugDeoptimization &amp;&amp; !deopt) {
2741         deopt = true; // One-time only print before deopt
2742         tty-&gt;print_cr("[BEFORE Deoptimization]");
2743         trace_frames();
2744         trace_stack();
2745       }
2746       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2747     }
2748   }
2749 
2750   if (DebugDeoptimization &amp;&amp; deopt) {
2751     tty-&gt;print_cr("[AFTER Deoptimization]");
2752     trace_frames();
2753   }
2754 }
2755 
2756 
2757 // Make zombies
2758 void JavaThread::make_zombies() {
2759   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2760     if (fst.current()-&gt;can_be_deoptimized()) {
2761       // it is a Java nmethod
2762       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2763       nm-&gt;make_not_entrant();
2764     }
2765   }
2766 }
2767 #endif // PRODUCT
2768 
2769 
2770 void JavaThread::deoptimized_wrt_marked_nmethods() {
2771   if (!has_last_Java_frame()) return;
2772   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2773   StackFrameStream fst(this, UseBiasedLocking);
2774   for (; !fst.is_done(); fst.next()) {
2775     if (fst.current()-&gt;should_be_deoptimized()) {
2776       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2777     }
2778   }
2779 }
2780 
2781 
2782 // If the caller is a NamedThread, then remember, in the current scope,
2783 // the given JavaThread in its _processed_thread field.
2784 class RememberProcessedThread: public StackObj {
2785   NamedThread* _cur_thr;
2786  public:
2787   RememberProcessedThread(JavaThread* jthr) {
2788     Thread* thread = Thread::current();
2789     if (thread-&gt;is_Named_thread()) {
2790       _cur_thr = (NamedThread *)thread;
2791       _cur_thr-&gt;set_processed_thread(jthr);
2792     } else {
2793       _cur_thr = NULL;
2794     }
2795   }
2796 
2797   ~RememberProcessedThread() {
2798     if (_cur_thr) {
2799       _cur_thr-&gt;set_processed_thread(NULL);
2800     }
2801   }
2802 };
2803 
2804 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2805   // Verify that the deferred card marks have been flushed.
2806   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2807 
2808   // Traverse the GCHandles
2809   Thread::oops_do(f, cf);
2810 
2811   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2812          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2813 
2814   if (has_last_Java_frame()) {
2815     // Record JavaThread to GC thread
2816     RememberProcessedThread rpt(this);
2817 
2818     // Traverse the privileged stack
2819     if (_privileged_stack_top != NULL) {
2820       _privileged_stack_top-&gt;oops_do(f);
2821     }
2822 
2823     // traverse the registered growable array
2824     if (_array_for_gc != NULL) {
2825       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2826         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2827       }
2828     }
2829 
2830     // Traverse the monitor chunks
2831     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2832       chunk-&gt;oops_do(f);
2833     }
2834 
2835     // Traverse the execution stack
2836     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2837       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2838     }
2839   }
2840 
2841   // callee_target is never live across a gc point so NULL it here should
2842   // it still contain a methdOop.
2843 
2844   set_callee_target(NULL);
2845 
2846   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2847   // If we have deferred set_locals there might be oops waiting to be
2848   // written
2849   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2850   if (list != NULL) {
2851     for (int i = 0; i &lt; list-&gt;length(); i++) {
2852       list-&gt;at(i)-&gt;oops_do(f);
2853     }
2854   }
2855 
2856   // Traverse instance variables at the end since the GC may be moving things
2857   // around using this function
2858   f-&gt;do_oop((oop*) &amp;_threadObj);
2859   f-&gt;do_oop((oop*) &amp;_vm_result);
2860   f-&gt;do_oop((oop*) &amp;_exception_oop);
2861   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2862 
2863   if (jvmti_thread_state() != NULL) {
2864     jvmti_thread_state()-&gt;oops_do(f);
2865   }
2866 }
2867 
2868 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2869   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2870          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2871 
2872   if (has_last_Java_frame()) {
2873     // Traverse the execution stack
2874     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2875       fst.current()-&gt;nmethods_do(cf);
2876     }
2877   }
2878 }
2879 
2880 void JavaThread::metadata_do(void f(Metadata*)) {
2881   if (has_last_Java_frame()) {
2882     // Traverse the execution stack to call f() on the methods in the stack
2883     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2884       fst.current()-&gt;metadata_do(f);
2885     }
2886   } else if (is_Compiler_thread()) {
2887     // need to walk ciMetadata in current compile tasks to keep alive.
2888     CompilerThread* ct = (CompilerThread*)this;
2889     if (ct-&gt;env() != NULL) {
2890       ct-&gt;env()-&gt;metadata_do(f);
2891     }
2892     CompileTask* task = ct-&gt;task();
2893     if (task != NULL) {
2894       task-&gt;metadata_do(f);
2895     }
2896   }
2897 }
2898 
2899 // Printing
2900 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2901   switch (_thread_state) {
2902   case _thread_uninitialized:     return "_thread_uninitialized";
2903   case _thread_new:               return "_thread_new";
2904   case _thread_new_trans:         return "_thread_new_trans";
2905   case _thread_in_native:         return "_thread_in_native";
2906   case _thread_in_native_trans:   return "_thread_in_native_trans";
2907   case _thread_in_vm:             return "_thread_in_vm";
2908   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2909   case _thread_in_Java:           return "_thread_in_Java";
2910   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2911   case _thread_blocked:           return "_thread_blocked";
2912   case _thread_blocked_trans:     return "_thread_blocked_trans";
2913   default:                        return "unknown thread state";
2914   }
2915 }
2916 
2917 #ifndef PRODUCT
2918 void JavaThread::print_thread_state_on(outputStream *st) const {
2919   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2920 };
2921 void JavaThread::print_thread_state() const {
2922   print_thread_state_on(tty);
2923 }
2924 #endif // PRODUCT
2925 
2926 // Called by Threads::print() for VM_PrintThreads operation
2927 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
2928   st-&gt;print_raw("\"");
2929   st-&gt;print_raw(get_thread_name());
2930   st-&gt;print_raw("\" ");
2931   oop thread_oop = threadObj();
2932   if (thread_oop != NULL) {
2933     st-&gt;print("#" INT64_FORMAT " ", (int64_t)java_lang_Thread::thread_id(thread_oop));
2934     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2935     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2936   }
2937   Thread::print_on(st, print_extended_info);
2938   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2939   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2940   if (thread_oop != NULL) {
2941     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2942   }
2943 #ifndef PRODUCT
2944   print_thread_state_on(st);
2945   _safepoint_state-&gt;print_on(st);
2946 #endif // PRODUCT
2947   if (is_Compiler_thread()) {
2948     CompileTask *task = ((CompilerThread*)this)-&gt;task();
2949     if (task != NULL) {
2950       st-&gt;print("   Compiling: ");
2951       task-&gt;print(st, NULL, true, false);
2952     } else {
2953       st-&gt;print("   No compile task");
2954     }
2955     st-&gt;cr();
2956   }
2957 }
2958 
2959 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2960   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2961 }
2962 
2963 // Called by fatal error handler. The difference between this and
2964 // JavaThread::print() is that we can't grab lock or allocate memory.
2965 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2966   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2967   oop thread_obj = threadObj();
2968   if (thread_obj != NULL) {
2969     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2970   }
2971   st-&gt;print(" [");
2972   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2973   if (osthread()) {
2974     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2975   }
2976   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2977             p2i(stack_end()), p2i(stack_base()));
2978   st-&gt;print("]");
2979 
2980   ThreadsSMRSupport::print_info_on(this, st);
2981   return;
2982 }
2983 
2984 // Verification
2985 
2986 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2987 
2988 void JavaThread::verify() {
2989   // Verify oops in the thread.
2990   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2991 
2992   // Verify the stack frames.
2993   frames_do(frame_verify);
2994 }
2995 
2996 // CR 6300358 (sub-CR 2137150)
2997 // Most callers of this method assume that it can't return NULL but a
2998 // thread may not have a name whilst it is in the process of attaching to
2999 // the VM - see CR 6412693, and there are places where a JavaThread can be
3000 // seen prior to having it's threadObj set (eg JNI attaching threads and
3001 // if vm exit occurs during initialization). These cases can all be accounted
3002 // for such that this method never returns NULL.
3003 const char* JavaThread::get_thread_name() const {
3004 #ifdef ASSERT
3005   // early safepoints can hit while current thread does not yet have TLS
3006   if (!SafepointSynchronize::is_at_safepoint()) {
3007     Thread *cur = Thread::current();
3008     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3009       // Current JavaThreads are allowed to get their own name without
3010       // the Threads_lock.
3011       assert_locked_or_safepoint(Threads_lock);
3012     }
3013   }
3014 #endif // ASSERT
3015   return get_thread_name_string();
3016 }
3017 
3018 // Returns a non-NULL representation of this thread's name, or a suitable
3019 // descriptive string if there is no set name
3020 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3021   const char* name_str;
3022   oop thread_obj = threadObj();
3023   if (thread_obj != NULL) {
3024     oop name = java_lang_Thread::name(thread_obj);
3025     if (name != NULL) {
3026       if (buf == NULL) {
3027         name_str = java_lang_String::as_utf8_string(name);
3028       } else {
3029         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3030       }
3031     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3032       name_str = "&lt;no-name - thread is attaching&gt;";
3033     } else {
3034       name_str = Thread::name();
3035     }
3036   } else {
3037     name_str = Thread::name();
3038   }
3039   assert(name_str != NULL, "unexpected NULL thread name");
3040   return name_str;
3041 }
3042 
3043 
3044 const char* JavaThread::get_threadgroup_name() const {
3045   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3046   oop thread_obj = threadObj();
3047   if (thread_obj != NULL) {
3048     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3049     if (thread_group != NULL) {
3050       // ThreadGroup.name can be null
3051       return java_lang_ThreadGroup::name(thread_group);
3052     }
3053   }
3054   return NULL;
3055 }
3056 
3057 const char* JavaThread::get_parent_name() const {
3058   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3059   oop thread_obj = threadObj();
3060   if (thread_obj != NULL) {
3061     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3062     if (thread_group != NULL) {
3063       oop parent = java_lang_ThreadGroup::parent(thread_group);
3064       if (parent != NULL) {
3065         // ThreadGroup.name can be null
3066         return java_lang_ThreadGroup::name(parent);
3067       }
3068     }
3069   }
3070   return NULL;
3071 }
3072 
3073 ThreadPriority JavaThread::java_priority() const {
3074   oop thr_oop = threadObj();
3075   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3076   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3077   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3078   return priority;
3079 }
3080 
3081 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3082 
3083   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3084   // Link Java Thread object &lt;-&gt; C++ Thread
3085 
3086   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3087   // and put it into a new Handle.  The Handle "thread_oop" can then
3088   // be used to pass the C++ thread object to other methods.
3089 
3090   // Set the Java level thread object (jthread) field of the
3091   // new thread (a JavaThread *) to C++ thread object using the
3092   // "thread_oop" handle.
3093 
3094   // Set the thread field (a JavaThread *) of the
3095   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3096 
3097   Handle thread_oop(Thread::current(),
3098                     JNIHandles::resolve_non_null(jni_thread));
3099   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3100          "must be initialized");
3101   set_threadObj(thread_oop());
3102   java_lang_Thread::set_thread(thread_oop(), this);
3103 
3104   if (prio == NoPriority) {
3105     prio = java_lang_Thread::priority(thread_oop());
3106     assert(prio != NoPriority, "A valid priority should be present");
3107   }
3108 
3109   // Push the Java priority down to the native thread; needs Threads_lock
3110   Thread::set_priority(this, prio);
3111 
3112   // Add the new thread to the Threads list and set it in motion.
3113   // We must have threads lock in order to call Threads::add.
3114   // It is crucial that we do not block before the thread is
3115   // added to the Threads list for if a GC happens, then the java_thread oop
3116   // will not be visited by GC.
3117   Threads::add(this);
3118 }
3119 
3120 oop JavaThread::current_park_blocker() {
3121   // Support for JSR-166 locks
3122   oop thread_oop = threadObj();
3123   if (thread_oop != NULL &amp;&amp;
3124       JDK_Version::current().supports_thread_park_blocker()) {
3125     return java_lang_Thread::park_blocker(thread_oop);
3126   }
3127   return NULL;
3128 }
3129 
3130 
3131 void JavaThread::print_stack_on(outputStream* st) {
3132   if (!has_last_Java_frame()) return;
3133   ResourceMark rm;
3134   HandleMark   hm;
3135 
3136   RegisterMap reg_map(this);
3137   vframe* start_vf = last_java_vframe(&amp;reg_map);
3138   int count = 0;
3139   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3140     if (f-&gt;is_java_frame()) {
3141       javaVFrame* jvf = javaVFrame::cast(f);
3142       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3143 
3144       // Print out lock information
3145       if (JavaMonitorsInStackTrace) {
3146         jvf-&gt;print_lock_info_on(st, count);
3147       }
3148     } else {
3149       // Ignore non-Java frames
3150     }
3151 
3152     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3153     count++;
3154     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3155   }
3156 }
3157 
3158 
3159 // JVMTI PopFrame support
3160 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3161   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3162   if (in_bytes(size_in_bytes) != 0) {
3163     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3164     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3165     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3166   }
3167 }
3168 
3169 void* JavaThread::popframe_preserved_args() {
3170   return _popframe_preserved_args;
3171 }
3172 
3173 ByteSize JavaThread::popframe_preserved_args_size() {
3174   return in_ByteSize(_popframe_preserved_args_size);
3175 }
3176 
3177 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3178   int sz = in_bytes(popframe_preserved_args_size());
3179   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3180   return in_WordSize(sz / wordSize);
3181 }
3182 
3183 void JavaThread::popframe_free_preserved_args() {
3184   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3185   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3186   _popframe_preserved_args = NULL;
3187   _popframe_preserved_args_size = 0;
3188 }
3189 
3190 #ifndef PRODUCT
3191 
3192 void JavaThread::trace_frames() {
3193   tty-&gt;print_cr("[Describe stack]");
3194   int frame_no = 1;
3195   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3196     tty-&gt;print("  %d. ", frame_no++);
3197     fst.current()-&gt;print_value_on(tty, this);
3198     tty-&gt;cr();
3199   }
3200 }
3201 
3202 class PrintAndVerifyOopClosure: public OopClosure {
3203  protected:
3204   template &lt;class T&gt; inline void do_oop_work(T* p) {
3205     oop obj = RawAccess&lt;&gt;::oop_load(p);
3206     if (obj == NULL) return;
3207     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3208     if (oopDesc::is_oop_or_null(obj)) {
3209       if (obj-&gt;is_objArray()) {
3210         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3211       } else {
3212         obj-&gt;print();
3213       }
3214     } else {
3215       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3216     }
3217     tty-&gt;cr();
3218   }
3219  public:
3220   virtual void do_oop(oop* p) { do_oop_work(p); }
3221   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3222 };
3223 
3224 
3225 static void oops_print(frame* f, const RegisterMap *map) {
3226   PrintAndVerifyOopClosure print;
3227   f-&gt;print_value();
3228   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3229 }
3230 
3231 // Print our all the locations that contain oops and whether they are
3232 // valid or not.  This useful when trying to find the oldest frame
3233 // where an oop has gone bad since the frame walk is from youngest to
3234 // oldest.
3235 void JavaThread::trace_oops() {
3236   tty-&gt;print_cr("[Trace oops]");
3237   frames_do(oops_print);
3238 }
3239 
3240 
3241 #ifdef ASSERT
3242 // Print or validate the layout of stack frames
3243 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3244   ResourceMark rm;
3245   PRESERVE_EXCEPTION_MARK;
3246   FrameValues values;
3247   int frame_no = 0;
3248   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3249     fst.current()-&gt;describe(values, ++frame_no);
3250     if (depth == frame_no) break;
3251   }
3252   if (validate_only) {
3253     values.validate();
3254   } else {
3255     tty-&gt;print_cr("[Describe stack layout]");
3256     values.print(this);
3257   }
3258 }
3259 #endif
3260 
3261 void JavaThread::trace_stack_from(vframe* start_vf) {
3262   ResourceMark rm;
3263   int vframe_no = 1;
3264   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3265     if (f-&gt;is_java_frame()) {
3266       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3267     } else {
3268       f-&gt;print();
3269     }
3270     if (vframe_no &gt; StackPrintLimit) {
3271       tty-&gt;print_cr("...&lt;more frames&gt;...");
3272       return;
3273     }
3274   }
3275 }
3276 
3277 
3278 void JavaThread::trace_stack() {
3279   if (!has_last_Java_frame()) return;
3280   ResourceMark rm;
3281   HandleMark   hm;
3282   RegisterMap reg_map(this);
3283   trace_stack_from(last_java_vframe(&amp;reg_map));
3284 }
3285 
3286 
3287 #endif // PRODUCT
3288 
3289 
3290 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3291   assert(reg_map != NULL, "a map must be given");
3292   frame f = last_frame();
3293   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3294     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3295   }
3296   return NULL;
3297 }
3298 
3299 
3300 Klass* JavaThread::security_get_caller_class(int depth) {
3301   vframeStream vfst(this);
3302   vfst.security_get_caller_frame(depth);
3303   if (!vfst.at_end()) {
3304     return vfst.method()-&gt;method_holder();
3305   }
3306   return NULL;
3307 }
3308 
3309 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3310   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3311   CompileBroker::compiler_thread_loop();
3312 }
3313 
3314 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3315   NMethodSweeper::sweeper_loop();
3316 }
3317 
3318 // Create a CompilerThread
3319 CompilerThread::CompilerThread(CompileQueue* queue,
3320                                CompilerCounters* counters)
3321                                : JavaThread(&amp;compiler_thread_entry) {
3322   _env   = NULL;
3323   _log   = NULL;
3324   _task  = NULL;
3325   _queue = queue;
3326   _counters = counters;
3327   _buffer_blob = NULL;
3328   _compiler = NULL;
3329 
3330   // Compiler uses resource area for compilation, let's bias it to mtCompiler
3331   resource_area()-&gt;bias_to(mtCompiler);
3332 
3333 #ifndef PRODUCT
3334   _ideal_graph_printer = NULL;
3335 #endif
3336 }
3337 
3338 CompilerThread::~CompilerThread() {
3339   // Delete objects which were allocated on heap.
3340   delete _counters;
3341 }
3342 
3343 bool CompilerThread::can_call_java() const {
3344   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3345 }
3346 
3347 // Create sweeper thread
3348 CodeCacheSweeperThread::CodeCacheSweeperThread()
3349 : JavaThread(&amp;sweeper_thread_entry) {
3350   _scanned_compiled_method = NULL;
3351 }
3352 
3353 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3354   JavaThread::oops_do(f, cf);
3355   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3356     // Safepoints can occur when the sweeper is scanning an nmethod so
3357     // process it here to make sure it isn't unloaded in the middle of
3358     // a scan.
3359     cf-&gt;do_code_blob(_scanned_compiled_method);
3360   }
3361 }
3362 
3363 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3364   JavaThread::nmethods_do(cf);
3365   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3366     // Safepoints can occur when the sweeper is scanning an nmethod so
3367     // process it here to make sure it isn't unloaded in the middle of
3368     // a scan.
3369     cf-&gt;do_code_blob(_scanned_compiled_method);
3370   }
3371 }
3372 
3373 
3374 // ======= Threads ========
3375 
3376 // The Threads class links together all active threads, and provides
3377 // operations over all threads. It is protected by the Threads_lock,
3378 // which is also used in other global contexts like safepointing.
3379 // ThreadsListHandles are used to safely perform operations on one
3380 // or more threads without the risk of the thread exiting during the
3381 // operation.
3382 //
3383 // Note: The Threads_lock is currently more widely used than we
3384 // would like. We are actively migrating Threads_lock uses to other
3385 // mechanisms in order to reduce Threads_lock contention.
3386 
3387 JavaThread* Threads::_thread_list = NULL;
3388 int         Threads::_number_of_threads = 0;
3389 int         Threads::_number_of_non_daemon_threads = 0;
3390 int         Threads::_return_code = 0;
3391 int         Threads::_thread_claim_parity = 0;
3392 size_t      JavaThread::_stack_size_at_create = 0;
3393 
3394 #ifdef ASSERT
3395 bool        Threads::_vm_complete = false;
3396 size_t      Threads::_threads_before_barrier_set = 0;
3397 #endif
3398 
3399 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3400   Prefetch::read((void*)addr, prefetch_interval);
3401   return *addr;
3402 }
3403 
3404 // Possibly the ugliest for loop the world has seen. C++ does not allow
3405 // multiple types in the declaration section of the for loop. In this case
3406 // we are only dealing with pointers and hence can cast them. It looks ugly
3407 // but macros are ugly and therefore it's fine to make things absurdly ugly.
3408 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3409     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3410              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3411              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3412              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3413              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3414          MACRO_current_p != MACRO_end;                                                                                    \
3415          MACRO_current_p++,                                                                                               \
3416              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3417 
3418 // All JavaThreads
3419 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3420 
3421 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3422 void Threads::non_java_threads_do(ThreadClosure* tc) {
3423   NoSafepointVerifier nsv(!SafepointSynchronize::is_at_safepoint(), false);
3424   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3425     tc-&gt;do_thread(njti.current());
3426   }
3427 }
3428 
3429 // All JavaThreads
3430 void Threads::java_threads_do(ThreadClosure* tc) {
3431   assert_locked_or_safepoint(Threads_lock);
3432   // ALL_JAVA_THREADS iterates through all JavaThreads.
3433   ALL_JAVA_THREADS(p) {
3434     tc-&gt;do_thread(p);
3435   }
3436 }
3437 
3438 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3439   assert_locked_or_safepoint(Threads_lock);
3440   java_threads_do(tc);
3441   tc-&gt;do_thread(VMThread::vm_thread());
3442 }
3443 
3444 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3445 void Threads::threads_do(ThreadClosure* tc) {
3446   assert_locked_or_safepoint(Threads_lock);
3447   java_threads_do(tc);
3448   non_java_threads_do(tc);
3449 }
3450 
3451 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3452   int cp = Threads::thread_claim_parity();
3453   ALL_JAVA_THREADS(p) {
3454     if (p-&gt;claim_oops_do(is_par, cp)) {
3455       tc-&gt;do_thread(p);
3456     }
3457   }
3458   VMThread* vmt = VMThread::vm_thread();
3459   if (vmt-&gt;claim_oops_do(is_par, cp)) {
3460     tc-&gt;do_thread(vmt);
3461   }
3462 }
3463 
3464 // The system initialization in the library has three phases.
3465 //
3466 // Phase 1: java.lang.System class initialization
3467 //     java.lang.System is a primordial class loaded and initialized
3468 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3469 //     only does registerNatives and keeps the rest of the class
3470 //     initialization work later until thread initialization completes.
3471 //
3472 //     System.initPhase1 initializes the system properties, the static
3473 //     fields in, out, and err. Set up java signal handlers, OS-specific
3474 //     system settings, and thread group of the main thread.
3475 static void call_initPhase1(TRAPS) {
3476   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3477   JavaValue result(T_VOID);
3478   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3479                                          vmSymbols::void_method_signature(), CHECK);
3480 }
3481 
3482 // Phase 2. Module system initialization
3483 //     This will initialize the module system.  Only java.base classes
3484 //     can be loaded until phase 2 completes.
3485 //
3486 //     Call System.initPhase2 after the compiler initialization and jsr292
3487 //     classes get initialized because module initialization runs a lot of java
3488 //     code, that for performance reasons, should be compiled.  Also, this will
3489 //     enable the startup code to use lambda and other language features in this
3490 //     phase and onward.
3491 //
3492 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3493 static void call_initPhase2(TRAPS) {
3494   TraceTime timer("Initialize module system", TRACETIME_LOG(Info, startuptime));
3495 
3496   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3497 
3498   JavaValue result(T_INT);
3499   JavaCallArguments args;
3500   args.push_int(DisplayVMOutputToStderr);
3501   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3502   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3503                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3504   if (result.get_jint() != JNI_OK) {
3505     vm_exit_during_initialization(); // no message or exception
3506   }
3507 
3508   universe_post_module_init();
3509 }
3510 
3511 // Phase 3. final setup - set security manager, system class loader and TCCL
3512 //
3513 //     This will instantiate and set the security manager, set the system class
3514 //     loader as well as the thread context class loader.  The security manager
3515 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3516 //     other modules or the application's classpath.
3517 static void call_initPhase3(TRAPS) {
3518   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3519   JavaValue result(T_VOID);
3520   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3521                                          vmSymbols::void_method_signature(), CHECK);
3522 }
3523 
3524 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3525   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3526 
3527   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3528     create_vm_init_libraries();
3529   }
3530 
3531   initialize_class(vmSymbols::java_lang_String(), CHECK);
3532 
3533   // Inject CompactStrings value after the static initializers for String ran.
3534   java_lang_String::set_compact_strings(CompactStrings);
3535 
3536   // Initialize java_lang.System (needed before creating the thread)
3537   initialize_class(vmSymbols::java_lang_System(), CHECK);
3538   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3539   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3540   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3541   Handle thread_group = create_initial_thread_group(CHECK);
3542   Universe::set_main_thread_group(thread_group());
3543   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3544   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3545   main_thread-&gt;set_threadObj(thread_object);
3546   // Set thread status to running since main thread has
3547   // been started and running.
3548   java_lang_Thread::set_thread_status(thread_object,
3549                                       java_lang_Thread::RUNNABLE);
3550 
3551   // The VM creates objects of this class.
3552   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3553 
3554   // The VM preresolves methods to these classes. Make sure that they get initialized
3555   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3556   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3557 
3558   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3559   call_initPhase1(CHECK);
3560 
3561   // get the Java runtime name after java.lang.System is initialized
3562   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3563   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3564 
3565   // an instance of OutOfMemory exception has been allocated earlier
3566   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3567   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3568   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3569   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3570   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3571   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3572   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3573   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3574 }
3575 
3576 void Threads::initialize_jsr292_core_classes(TRAPS) {
3577   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3578 
3579   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3580   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3581   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3582   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3583 }
3584 
3585 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3586   extern void JDK_Version_init();
3587 
3588   // Preinitialize version info.
3589   VM_Version::early_initialize();
3590 
3591   // Check version
3592   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3593 
3594   // Initialize library-based TLS
3595   ThreadLocalStorage::init();
3596 
3597   // Initialize the output stream module
3598   ostream_init();
3599 
3600   // Process java launcher properties.
3601   Arguments::process_sun_java_launcher_properties(args);
3602 
3603   // Initialize the os module
3604   os::init();
3605 
3606   // Record VM creation timing statistics
3607   TraceVmCreationTime create_vm_timer;
3608   create_vm_timer.start();
3609 
3610   // Initialize system properties.
3611   Arguments::init_system_properties();
3612 
3613   // So that JDK version can be used as a discriminator when parsing arguments
3614   JDK_Version_init();
3615 
3616   // Update/Initialize System properties after JDK version number is known
3617   Arguments::init_version_specific_system_properties();
3618 
3619   // Make sure to initialize log configuration *before* parsing arguments
3620   LogConfiguration::initialize(create_vm_timer.begin_time());
3621 
3622   // Parse arguments
3623   // Note: this internally calls os::init_container_support()
3624   jint parse_result = Arguments::parse(args);
3625   if (parse_result != JNI_OK) return parse_result;
3626 
3627   os::init_before_ergo();
3628 
3629   jint ergo_result = Arguments::apply_ergo();
3630   if (ergo_result != JNI_OK) return ergo_result;
3631 
3632   // Final check of all ranges after ergonomics which may change values.
3633   if (!JVMFlagRangeList::check_ranges()) {
3634     return JNI_EINVAL;
3635   }
3636 
3637   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3638   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3639   if (!constraint_result) {
3640     return JNI_EINVAL;
3641   }
3642 
3643   JVMFlagWriteableList::mark_startup();
3644 
3645   if (PauseAtStartup) {
3646     os::pause();
3647   }
3648 
3649   HOTSPOT_VM_INIT_BEGIN();
3650 
3651   // Timing (must come after argument parsing)
3652   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3653 
3654 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3655   // Initialize assert poison page mechanism.
3656   if (ShowRegistersOnAssert) {
3657     initialize_assert_poison();
3658   }
3659 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3660 
3661   // Initialize the os module after parsing the args
3662   jint os_init_2_result = os::init_2();
3663   if (os_init_2_result != JNI_OK) return os_init_2_result;
3664 
3665   SafepointMechanism::initialize();
3666 
3667   jint adjust_after_os_result = Arguments::adjust_after_os();
3668   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3669 
3670   // Initialize output stream logging
3671   ostream_init_log();
3672 
3673   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3674   // Must be before create_vm_init_agents()
3675   if (Arguments::init_libraries_at_startup()) {
3676     convert_vm_init_libraries_to_agents();
3677   }
3678 
3679   // Launch -agentlib/-agentpath and converted -Xrun agents
3680   if (Arguments::init_agents_at_startup()) {
3681     create_vm_init_agents();
3682   }
3683 
3684   // Initialize Threads state
3685   _thread_list = NULL;
3686   _number_of_threads = 0;
3687   _number_of_non_daemon_threads = 0;
3688 
3689   // Initialize global data structures and create system classes in heap
3690   vm_init_globals();
3691 
3692 #if INCLUDE_JVMCI
3693   if (JVMCICounterSize &gt; 0) {
3694     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3695     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3696   } else {
3697     JavaThread::_jvmci_old_thread_counters = NULL;
3698   }
3699 #endif // INCLUDE_JVMCI
3700 
3701   // Attach the main thread to this os thread
3702   JavaThread* main_thread = new JavaThread();
3703   main_thread-&gt;set_thread_state(_thread_in_vm);
3704   main_thread-&gt;initialize_thread_current();
3705   // must do this before set_active_handles
3706   main_thread-&gt;record_stack_base_and_size();
3707   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3708 
3709   if (!main_thread-&gt;set_as_starting_thread()) {
3710     vm_shutdown_during_initialization(
3711                                       "Failed necessary internal allocation. Out of swap space");
3712     main_thread-&gt;smr_delete();
3713     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3714     return JNI_ENOMEM;
3715   }
3716 
3717   // Enable guard page *after* os::create_main_thread(), otherwise it would
3718   // crash Linux VM, see notes in os_linux.cpp.
3719   main_thread-&gt;create_stack_guard_pages();
3720 
3721   // Initialize Java-Level synchronization subsystem
3722   ObjectMonitor::Initialize();
3723 
3724   // Initialize global modules
3725   jint status = init_globals();
3726   if (status != JNI_OK) {
3727     main_thread-&gt;smr_delete();
3728     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3729     return status;
3730   }
3731 
3732   JFR_ONLY(Jfr::on_vm_init();)
3733 
3734   // Should be done after the heap is fully created
3735   main_thread-&gt;cache_global_variables();
3736 
3737   HandleMark hm;
3738 
3739   { MutexLocker mu(Threads_lock);
3740     Threads::add(main_thread);
3741   }
3742 
3743   // Any JVMTI raw monitors entered in onload will transition into
3744   // real raw monitor. VM is setup enough here for raw monitor enter.
3745   JvmtiExport::transition_pending_onload_raw_monitors();
3746 
3747   // Create the VMThread
3748   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3749 
3750   VMThread::create();
3751     Thread* vmthread = VMThread::vm_thread();
3752 
3753     if (!os::create_thread(vmthread, os::vm_thread)) {
3754       vm_exit_during_initialization("Cannot create VM thread. "
3755                                     "Out of system resources.");
3756     }
3757 
3758     // Wait for the VM thread to become ready, and VMThread::run to initialize
3759     // Monitors can have spurious returns, must always check another state flag
3760     {
3761       MutexLocker ml(Notify_lock);
3762       os::start_thread(vmthread);
3763       while (vmthread-&gt;active_handles() == NULL) {
3764         Notify_lock-&gt;wait();
3765       }
3766     }
3767   }
3768 
3769   assert(Universe::is_fully_initialized(), "not initialized");
3770   if (VerifyDuringStartup) {
3771     // Make sure we're starting with a clean slate.
3772     VM_Verify verify_op;
3773     VMThread::execute(&amp;verify_op);
3774   }
3775 
3776   // We need this to update the java.vm.info property in case any flags used
3777   // to initially define it have been changed. This is needed for both CDS and
3778   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3779   // is initially computed. See Abstract_VM_Version::vm_info_string().
3780   // This update must happen before we initialize the java classes, but
3781   // after any initialization logic that might modify the flags.
3782   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3783 
3784   Thread* THREAD = Thread::current();
3785 
3786   // Always call even when there are not JVMTI environments yet, since environments
3787   // may be attached late and JVMTI must track phases of VM execution
3788   JvmtiExport::enter_early_start_phase();
3789 
3790   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3791   JvmtiExport::post_early_vm_start();
3792 
3793   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3794 
3795   quicken_jni_functions();
3796 
3797   // No more stub generation allowed after that point.
3798   StubCodeDesc::freeze();
3799 
3800   // Set flag that basic initialization has completed. Used by exceptions and various
3801   // debug stuff, that does not work until all basic classes have been initialized.
3802   set_init_completed();
3803 
3804   LogConfiguration::post_initialize();
3805   Metaspace::post_initialize();
3806 
3807   HOTSPOT_VM_INIT_END();
3808 
3809   // record VM initialization completion time
3810 #if INCLUDE_MANAGEMENT
3811   Management::record_vm_init_completed();
3812 #endif // INCLUDE_MANAGEMENT
3813 
3814   // Signal Dispatcher needs to be started before VMInit event is posted
3815   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
3816 
3817   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3818   if (!DisableAttachMechanism) {
3819     AttachListener::vm_start();
3820     if (StartAttachListener || AttachListener::init_at_startup()) {
3821       AttachListener::init();
3822     }
3823   }
3824 
3825   // Launch -Xrun agents
3826   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3827   // back-end can launch with -Xdebug -Xrunjdwp.
3828   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3829     create_vm_init_libraries();
3830   }
3831 
3832   if (CleanChunkPoolAsync) {
3833     Chunk::start_chunk_pool_cleaner_task();
3834   }
3835 
3836   // initialize compiler(s)
3837 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
3838 #if INCLUDE_JVMCI
3839   bool force_JVMCI_intialization = false;
3840   if (EnableJVMCI) {
3841     // Initialize JVMCI eagerly when it is explicitly requested.
3842     // Or when JVMCIPrintProperties is enabled.
3843     // The JVMCI Java initialization code will read this flag and
3844     // do the printing if it's set.
3845     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;
3846 
3847     if (!force_JVMCI_intialization) {
3848       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3849       // compilations via JVMCI will not actually block until JVMCI is initialized.
3850       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
3851     }
3852   }
3853 #endif
3854   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
3855   // Postpone completion of compiler initialization to after JVMCI
3856   // is initialized to avoid timeouts of blocking compilations.
3857   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
3858     CompileBroker::compilation_init_phase2();
3859   }
3860 #endif
3861 
3862   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3863   // It is done after compilers are initialized, because otherwise compilations of
3864   // signature polymorphic MH intrinsics can be missed
3865   // (see SystemDictionary::find_method_handle_intrinsic).
3866   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3867 
3868   // This will initialize the module system.  Only java.base classes can be
3869   // loaded until phase 2 completes
3870   call_initPhase2(CHECK_JNI_ERR);
3871 
3872   // Always call even when there are not JVMTI environments yet, since environments
3873   // may be attached late and JVMTI must track phases of VM execution
3874   JvmtiExport::enter_start_phase();
3875 
3876   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3877   JvmtiExport::post_vm_start();
3878 
3879   // Final system initialization including security manager and system class loader
3880   call_initPhase3(CHECK_JNI_ERR);
3881 
3882   // cache the system and platform class loaders
3883   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
3884 
3885 #if INCLUDE_CDS
3886   if (DumpSharedSpaces) {
3887     // capture the module path info from the ModuleEntryTable
3888     ClassLoader::initialize_module_path(THREAD);
3889   }
3890 #endif
3891 
3892 #if INCLUDE_JVMCI
3893   if (force_JVMCI_intialization) {
3894     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3895     CompileBroker::compilation_init_phase2();
3896   }
3897 #endif
3898 
3899   // Always call even when there are not JVMTI environments yet, since environments
3900   // may be attached late and JVMTI must track phases of VM execution
3901   JvmtiExport::enter_live_phase();
3902 
3903   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3904   JvmtiExport::post_vm_initialized();
3905 
3906   JFR_ONLY(Jfr::on_vm_start();)
3907 
3908 #if INCLUDE_MANAGEMENT
3909   Management::initialize(THREAD);
3910 
3911   if (HAS_PENDING_EXCEPTION) {
3912     // management agent fails to start possibly due to
3913     // configuration problem and is responsible for printing
3914     // stack trace if appropriate. Simply exit VM.
3915     vm_exit(1);
3916   }
3917 #endif // INCLUDE_MANAGEMENT
3918 
3919   if (MemProfiling)                   MemProfiler::engage();
3920   StatSampler::engage();
3921   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3922 
3923   BiasedLocking::init();
3924 
3925 #if INCLUDE_RTM_OPT
3926   RTMLockingCounters::init();
3927 #endif
3928 
3929   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3930     call_postVMInitHook(THREAD);
3931     // The Java side of PostVMInitHook.run must deal with all
3932     // exceptions and provide means of diagnosis.
3933     if (HAS_PENDING_EXCEPTION) {
3934       CLEAR_PENDING_EXCEPTION;
3935     }
3936   }
3937 
3938   {
3939     MutexLocker ml(PeriodicTask_lock);
3940     // Make sure the WatcherThread can be started by WatcherThread::start()
3941     // or by dynamic enrollment.
3942     WatcherThread::make_startable();
3943     // Start up the WatcherThread if there are any periodic tasks
3944     // NOTE:  All PeriodicTasks should be registered by now. If they
3945     //   aren't, late joiners might appear to start slowly (we might
3946     //   take a while to process their first tick).
3947     if (PeriodicTask::num_tasks() &gt; 0) {
3948       WatcherThread::start();
3949     }
3950   }
3951 
3952   create_vm_timer.end();
3953 #ifdef ASSERT
3954   _vm_complete = true;
3955 #endif
3956 
3957   if (DumpSharedSpaces) {
3958     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3959     ShouldNotReachHere();
3960   }
3961 
3962   return JNI_OK;
3963 }
3964 
3965 // type for the Agent_OnLoad and JVM_OnLoad entry points
3966 extern "C" {
3967   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3968 }
3969 // Find a command line agent library and return its entry point for
3970 //         -agentlib:  -agentpath:   -Xrun
3971 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3972 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3973                                     const char *on_load_symbols[],
3974                                     size_t num_symbol_entries) {
3975   OnLoadEntry_t on_load_entry = NULL;
3976   void *library = NULL;
3977 
3978   if (!agent-&gt;valid()) {
3979     char buffer[JVM_MAXPATHLEN];
3980     char ebuf[1024] = "";
3981     const char *name = agent-&gt;name();
3982     const char *msg = "Could not find agent library ";
3983 
3984     // First check to see if agent is statically linked into executable
3985     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3986       library = agent-&gt;os_lib();
3987     } else if (agent-&gt;is_absolute_path()) {
3988       library = os::dll_load(name, ebuf, sizeof ebuf);
3989       if (library == NULL) {
3990         const char *sub_msg = " in absolute path, with error: ";
3991         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3992         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3993         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3994         // If we can't find the agent, exit.
3995         vm_exit_during_initialization(buf, NULL);
3996         FREE_C_HEAP_ARRAY(char, buf);
3997       }
3998     } else {
3999       // Try to load the agent from the standard dll directory
4000       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4001                              name)) {
4002         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4003       }
4004       if (library == NULL) { // Try the library path directory.
4005         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4006           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4007         }
4008         if (library == NULL) {
4009           const char *sub_msg = " on the library path, with error: ";
4010           const char *sub_msg2 = "\nModule java.instrument may be missing from runtime image.";
4011 
4012           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4013                        strlen(ebuf) + strlen(sub_msg2) + 1;
4014           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4015           if (!agent-&gt;is_instrument_lib()) {
4016             jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
4017           } else {
4018             jio_snprintf(buf, len, "%s%s%s%s%s", msg, name, sub_msg, ebuf, sub_msg2);
4019           }
4020           // If we can't find the agent, exit.
4021           vm_exit_during_initialization(buf, NULL);
4022           FREE_C_HEAP_ARRAY(char, buf);
4023         }
4024       }
4025     }
4026     agent-&gt;set_os_lib(library);
4027     agent-&gt;set_valid();
4028   }
4029 
4030   // Find the OnLoad function.
4031   on_load_entry =
4032     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4033                                                           false,
4034                                                           on_load_symbols,
4035                                                           num_symbol_entries));
4036   return on_load_entry;
4037 }
4038 
4039 // Find the JVM_OnLoad entry point
4040 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4041   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4042   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4043 }
4044 
4045 // Find the Agent_OnLoad entry point
4046 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4047   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4048   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4049 }
4050 
4051 // For backwards compatibility with -Xrun
4052 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4053 // treated like -agentpath:
4054 // Must be called before agent libraries are created
4055 void Threads::convert_vm_init_libraries_to_agents() {
4056   AgentLibrary* agent;
4057   AgentLibrary* next;
4058 
4059   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4060     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4061     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4062 
4063     // If there is an JVM_OnLoad function it will get called later,
4064     // otherwise see if there is an Agent_OnLoad
4065     if (on_load_entry == NULL) {
4066       on_load_entry = lookup_agent_on_load(agent);
4067       if (on_load_entry != NULL) {
4068         // switch it to the agent list -- so that Agent_OnLoad will be called,
4069         // JVM_OnLoad won't be attempted and Agent_OnUnload will
4070         Arguments::convert_library_to_agent(agent);
4071       } else {
4072         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
4073       }
4074     }
4075   }
4076 }
4077 
4078 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4079 // Invokes Agent_OnLoad
4080 // Called very early -- before JavaThreads exist
4081 void Threads::create_vm_init_agents() {
4082   extern struct JavaVM_ main_vm;
4083   AgentLibrary* agent;
4084 
4085   JvmtiExport::enter_onload_phase();
4086 
4087   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4088     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4089 
4090     if (on_load_entry != NULL) {
4091       // Invoke the Agent_OnLoad function
4092       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4093       if (err != JNI_OK) {
4094         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
4095       }
4096     } else {
4097       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
4098     }
4099   }
4100   JvmtiExport::enter_primordial_phase();
4101 }
4102 
4103 extern "C" {
4104   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4105 }
4106 
4107 void Threads::shutdown_vm_agents() {
4108   // Send any Agent_OnUnload notifications
4109   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4110   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4111   extern struct JavaVM_ main_vm;
4112   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4113 
4114     // Find the Agent_OnUnload function.
4115     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4116                                                    os::find_agent_function(agent,
4117                                                    false,
4118                                                    on_unload_symbols,
4119                                                    num_symbol_entries));
4120 
4121     // Invoke the Agent_OnUnload function
4122     if (unload_entry != NULL) {
4123       JavaThread* thread = JavaThread::current();
4124       ThreadToNativeFromVM ttn(thread);
4125       HandleMark hm(thread);
4126       (*unload_entry)(&amp;main_vm);
4127     }
4128   }
4129 }
4130 
4131 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4132 // Invokes JVM_OnLoad
4133 void Threads::create_vm_init_libraries() {
4134   extern struct JavaVM_ main_vm;
4135   AgentLibrary* agent;
4136 
4137   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4138     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4139 
4140     if (on_load_entry != NULL) {
4141       // Invoke the JVM_OnLoad function
4142       JavaThread* thread = JavaThread::current();
4143       ThreadToNativeFromVM ttn(thread);
4144       HandleMark hm(thread);
4145       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4146       if (err != JNI_OK) {
4147         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4148       }
4149     } else {
4150       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4151     }
4152   }
4153 }
4154 
4155 
4156 // Last thread running calls java.lang.Shutdown.shutdown()
4157 void JavaThread::invoke_shutdown_hooks() {
4158   HandleMark hm(this);
4159 
4160   // We could get here with a pending exception, if so clear it now.
4161   if (this-&gt;has_pending_exception()) {
4162     this-&gt;clear_pending_exception();
4163   }
4164 
4165   EXCEPTION_MARK;
4166   Klass* shutdown_klass =
4167     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4168                                       THREAD);
4169   if (shutdown_klass != NULL) {
4170     // SystemDictionary::resolve_or_null will return null if there was
4171     // an exception.  If we cannot load the Shutdown class, just don't
4172     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4173     // won't be run.  Note that if a shutdown hook was registered,
4174     // the Shutdown class would have already been loaded
4175     // (Runtime.addShutdownHook will load it).
4176     JavaValue result(T_VOID);
4177     JavaCalls::call_static(&amp;result,
4178                            shutdown_klass,
4179                            vmSymbols::shutdown_method_name(),
4180                            vmSymbols::void_method_signature(),
4181                            THREAD);
4182   }
4183   CLEAR_PENDING_EXCEPTION;
4184 }
4185 
4186 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4187 // the program falls off the end of main(). Another VM exit path is through
4188 // vm_exit() when the program calls System.exit() to return a value or when
4189 // there is a serious error in VM. The two shutdown paths are not exactly
4190 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4191 // and VM_Exit op at VM level.
4192 //
4193 // Shutdown sequence:
4194 //   + Shutdown native memory tracking if it is on
4195 //   + Wait until we are the last non-daemon thread to execute
4196 //     &lt;-- every thing is still working at this moment --&gt;
4197 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4198 //        shutdown hooks
4199 //   + Call before_exit(), prepare for VM exit
4200 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4201 //        currently the only user of this mechanism is File.deleteOnExit())
4202 //      &gt; stop StatSampler, watcher thread, CMS threads,
4203 //        post thread end and vm death events to JVMTI,
4204 //        stop signal thread
4205 //   + Call JavaThread::exit(), it will:
4206 //      &gt; release JNI handle blocks, remove stack guard pages
4207 //      &gt; remove this thread from Threads list
4208 //     &lt;-- no more Java code from this thread after this point --&gt;
4209 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4210 //     the compiler threads at safepoint
4211 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4212 //   + Disable tracing at JNI/JVM barriers
4213 //   + Set _vm_exited flag for threads that are still running native code
4214 //   + Delete this thread
4215 //   + Call exit_globals()
4216 //      &gt; deletes tty
4217 //      &gt; deletes PerfMemory resources
4218 //   + Return to caller
4219 
4220 bool Threads::destroy_vm() {
4221   JavaThread* thread = JavaThread::current();
4222 
4223 #ifdef ASSERT
4224   _vm_complete = false;
4225 #endif
4226   // Wait until we are the last non-daemon thread to execute
4227   { MutexLocker nu(Threads_lock);
4228     while (Threads::number_of_non_daemon_threads() &gt; 1)
4229       // This wait should make safepoint checks, wait without a timeout,
4230       // and wait as a suspend-equivalent condition.
4231       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4232                          Mutex::_as_suspend_equivalent_flag);
4233   }
4234 
4235   EventShutdown e;
4236   if (e.should_commit()) {
4237     e.set_reason("No remaining non-daemon Java threads");
4238     e.commit();
4239   }
4240 
4241   // Hang forever on exit if we are reporting an error.
4242   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4243     os::infinite_sleep();
4244   }
4245   os::wait_for_keypress_at_exit();
4246 
4247   // run Java level shutdown hooks
4248   thread-&gt;invoke_shutdown_hooks();
4249 
4250   before_exit(thread);
4251 
4252   thread-&gt;exit(true);
4253   // thread will never call smr_delete, instead of implicit cancel
4254   // in wait_for_vm_thread_exit we do it explicit.
4255   thread-&gt;cancel_handshake();
4256 
4257   // Stop VM thread.
4258   {
4259     // 4945125 The vm thread comes to a safepoint during exit.
4260     // GC vm_operations can get caught at the safepoint, and the
4261     // heap is unparseable if they are caught. Grab the Heap_lock
4262     // to prevent this. The GC vm_operations will not be able to
4263     // queue until after the vm thread is dead. After this point,
4264     // we'll never emerge out of the safepoint before the VM exits.
4265 
4266     MutexLocker ml(Heap_lock);
4267 
4268     VMThread::wait_for_vm_thread_exit();
4269     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4270     VMThread::destroy();
4271   }
4272 
4273   // Now, all Java threads are gone except daemon threads. Daemon threads
4274   // running Java code or in VM are stopped by the Safepoint. However,
4275   // daemon threads executing native code are still running.  But they
4276   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4277   // simply kill or suspend them, as it is inherently deadlock-prone.
4278 
4279   VM_Exit::set_vm_exited();
4280 
4281   // Clean up ideal graph printers after the VMThread has started
4282   // the final safepoint which will block all the Compiler threads.
4283   // Note that this Thread has already logically exited so the
4284   // clean_up() function's use of a JavaThreadIteratorWithHandle
4285   // would be a problem except set_vm_exited() has remembered the
4286   // shutdown thread which is granted a policy exception.
4287 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4288   IdealGraphPrinter::clean_up();
4289 #endif
4290 
4291   notify_vm_shutdown();
4292 
4293   // We are after VM_Exit::set_vm_exited() so we can't call
4294   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4295   // Deleting the shutdown thread here is safe because another
4296   // JavaThread cannot have an active ThreadsListHandle for
4297   // this JavaThread.
4298   delete thread;
4299 
4300 #if INCLUDE_JVMCI
4301   if (JVMCICounterSize &gt; 0) {
4302     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4303   }
4304 #endif
4305 
4306   // exit_globals() will delete tty
4307   exit_globals();
4308 
4309   LogConfiguration::finalize();
4310 
4311   return true;
4312 }
4313 
4314 
4315 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4316   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4317   return is_supported_jni_version(version);
4318 }
4319 
4320 
4321 jboolean Threads::is_supported_jni_version(jint version) {
4322   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4323   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4324   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4325   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4326   if (version == JNI_VERSION_9) return JNI_TRUE;
4327   if (version == JNI_VERSION_10) return JNI_TRUE;
4328   return JNI_FALSE;
4329 }
4330 
4331 
4332 void Threads::add(JavaThread* p, bool force_daemon) {
4333   // The threads lock must be owned at this point
4334   assert_locked_or_safepoint(Threads_lock);
4335 
4336   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4337 
4338   p-&gt;set_next(_thread_list);
4339   _thread_list = p;
4340 
4341   // Once a JavaThread is added to the Threads list, smr_delete() has
4342   // to be used to delete it. Otherwise we can just delete it directly.
4343   p-&gt;set_on_thread_list();
4344 
4345   _number_of_threads++;
4346   oop threadObj = p-&gt;threadObj();
4347   bool daemon = true;
4348   // Bootstrapping problem: threadObj can be null for initial
4349   // JavaThread (or for threads attached via JNI)
4350   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4351     _number_of_non_daemon_threads++;
4352     daemon = false;
4353   }
4354 
4355   ThreadService::add_thread(p, daemon);
4356 
4357   // Maintain fast thread list
4358   ThreadsSMRSupport::add_thread(p);
4359 
4360   // Possible GC point.
4361   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4362 }
4363 
4364 void Threads::remove(JavaThread* p) {
4365 
4366   // Reclaim the objectmonitors from the omInUseList and omFreeList of the moribund thread.
4367   ObjectSynchronizer::omFlush(p);
4368 
4369   // Extra scope needed for Thread_lock, so we can check
4370   // that we do not remove thread without safepoint code notice
4371   { MutexLocker ml(Threads_lock);
4372 
4373     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), "p must be present");
4374 
4375     // Maintain fast thread list
4376     ThreadsSMRSupport::remove_thread(p);
4377 
4378     JavaThread* current = _thread_list;
4379     JavaThread* prev    = NULL;
4380 
4381     while (current != p) {
4382       prev    = current;
4383       current = current-&gt;next();
4384     }
4385 
4386     if (prev) {
4387       prev-&gt;set_next(current-&gt;next());
4388     } else {
4389       _thread_list = p-&gt;next();
4390     }
4391 
4392     _number_of_threads--;
4393     oop threadObj = p-&gt;threadObj();
4394     bool daemon = true;
4395     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4396       _number_of_non_daemon_threads--;
4397       daemon = false;
4398 
4399       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4400       // on destroy_vm will wake up.
4401       if (number_of_non_daemon_threads() == 1) {
4402         Threads_lock-&gt;notify_all();
4403       }
4404     }
4405     ThreadService::remove_thread(p, daemon);
4406 
4407     // Make sure that safepoint code disregard this thread. This is needed since
4408     // the thread might mess around with locks after this point. This can cause it
4409     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4410     // of this thread since it is removed from the queue.
4411     p-&gt;set_terminated_value();
4412   } // unlock Threads_lock
4413 
4414   // Since Events::log uses a lock, we grab it outside the Threads_lock
4415   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4416 }
4417 
4418 // Operations on the Threads list for GC.  These are not explicitly locked,
4419 // but the garbage collector must provide a safe context for them to run.
4420 // In particular, these things should never be called when the Threads_lock
4421 // is held by some other thread. (Note: the Safepoint abstraction also
4422 // uses the Threads_lock to guarantee this property. It also makes sure that
4423 // all threads gets blocked when exiting or starting).
4424 
4425 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4426   ALL_JAVA_THREADS(p) {
4427     p-&gt;oops_do(f, cf);
4428   }
4429   VMThread::vm_thread()-&gt;oops_do(f, cf);
4430 }
4431 
4432 void Threads::change_thread_claim_parity() {
4433   // Set the new claim parity.
4434   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4435          "Not in range.");
4436   _thread_claim_parity++;
4437   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4438   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4439          "Not in range.");
4440 }
4441 
4442 #ifdef ASSERT
4443 void Threads::assert_all_threads_claimed() {
4444   ALL_JAVA_THREADS(p) {
4445     const int thread_parity = p-&gt;oops_do_parity();
4446     assert((thread_parity == _thread_claim_parity),
4447            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4448   }
4449   VMThread* vmt = VMThread::vm_thread();
4450   const int thread_parity = vmt-&gt;oops_do_parity();
4451   assert((thread_parity == _thread_claim_parity),
4452          "VMThread " PTR_FORMAT " has incorrect parity %d != %d", p2i(vmt), thread_parity, _thread_claim_parity);
4453 }
4454 #endif // ASSERT
4455 
4456 class ParallelOopsDoThreadClosure : public ThreadClosure {
4457 private:
4458   OopClosure* _f;
4459   CodeBlobClosure* _cf;
4460 public:
4461   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4462   void do_thread(Thread* t) {
4463     t-&gt;oops_do(_f, _cf);
4464   }
4465 };
4466 
4467 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4468   ParallelOopsDoThreadClosure tc(f, cf);
4469   possibly_parallel_threads_do(is_par, &amp;tc);
4470 }
4471 
4472 void Threads::nmethods_do(CodeBlobClosure* cf) {
4473   ALL_JAVA_THREADS(p) {
4474     // This is used by the code cache sweeper to mark nmethods that are active
4475     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4476     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4477     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4478       p-&gt;nmethods_do(cf);
4479     }
4480   }
4481 }
4482 
4483 void Threads::metadata_do(void f(Metadata*)) {
4484   ALL_JAVA_THREADS(p) {
4485     p-&gt;metadata_do(f);
4486   }
4487 }
4488 
4489 class ThreadHandlesClosure : public ThreadClosure {
4490   void (*_f)(Metadata*);
4491  public:
4492   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4493   virtual void do_thread(Thread* thread) {
4494     thread-&gt;metadata_handles_do(_f);
4495   }
4496 };
4497 
4498 void Threads::metadata_handles_do(void f(Metadata*)) {
4499   // Only walk the Handles in Thread.
4500   ThreadHandlesClosure handles_closure(f);
4501   threads_do(&amp;handles_closure);
4502 }
4503 
4504 void Threads::deoptimized_wrt_marked_nmethods() {
4505   ALL_JAVA_THREADS(p) {
4506     p-&gt;deoptimized_wrt_marked_nmethods();
4507   }
4508 }
4509 
4510 
4511 // Get count Java threads that are waiting to enter the specified monitor.
4512 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4513                                                          int count,
4514                                                          address monitor) {
4515   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4516 
4517   int i = 0;
4518   DO_JAVA_THREADS(t_list, p) {
4519     if (!p-&gt;can_call_java()) continue;
4520 
4521     address pending = (address)p-&gt;current_pending_monitor();
4522     if (pending == monitor) {             // found a match
4523       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4524       i++;
4525     }
4526   }
4527 
4528   return result;
4529 }
4530 
4531 
4532 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4533                                                       address owner) {
4534   // NULL owner means not locked so we can skip the search
4535   if (owner == NULL) return NULL;
4536 
4537   DO_JAVA_THREADS(t_list, p) {
4538     // first, see if owner is the address of a Java thread
4539     if (owner == (address)p) return p;
4540   }
4541 
4542   // Cannot assert on lack of success here since this function may be
4543   // used by code that is trying to report useful problem information
4544   // like deadlock detection.
4545   if (UseHeavyMonitors) return NULL;
4546 
4547   // If we didn't find a matching Java thread and we didn't force use of
4548   // heavyweight monitors, then the owner is the stack address of the
4549   // Lock Word in the owning Java thread's stack.
4550   //
4551   JavaThread* the_owner = NULL;
4552   DO_JAVA_THREADS(t_list, q) {
4553     if (q-&gt;is_lock_owned(owner)) {
4554       the_owner = q;
4555       break;
4556     }
4557   }
4558 
4559   // cannot assert on lack of success here; see above comment
4560   return the_owner;
4561 }
4562 
4563 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4564 void Threads::print_on(outputStream* st, bool print_stacks,
4565                        bool internal_format, bool print_concurrent_locks,
4566                        bool print_extended_info) {
4567   char buf[32];
4568   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4569 
4570   st-&gt;print_cr("Full thread dump %s (%s %s):",
4571                Abstract_VM_Version::vm_name(),
4572                Abstract_VM_Version::vm_release(),
4573                Abstract_VM_Version::vm_info_string());
4574   st-&gt;cr();
4575 
4576 #if INCLUDE_SERVICES
4577   // Dump concurrent locks
4578   ConcurrentLocksDump concurrent_locks;
4579   if (print_concurrent_locks) {
4580     concurrent_locks.dump_at_safepoint();
4581   }
4582 #endif // INCLUDE_SERVICES
4583 
4584   ThreadsSMRSupport::print_info_on(st);
4585   st-&gt;cr();
4586 
4587   ALL_JAVA_THREADS(p) {
4588     ResourceMark rm;
4589     p-&gt;print_on(st, print_extended_info);
4590     if (print_stacks) {
4591       if (internal_format) {
4592         p-&gt;trace_stack();
4593       } else {
4594         p-&gt;print_stack_on(st);
4595       }
4596     }
4597     st-&gt;cr();
4598 #if INCLUDE_SERVICES
4599     if (print_concurrent_locks) {
4600       concurrent_locks.print_locks_on(p, st);
4601     }
4602 #endif // INCLUDE_SERVICES
4603   }
4604 
4605   VMThread::vm_thread()-&gt;print_on(st);
4606   st-&gt;cr();
4607   Universe::heap()-&gt;print_gc_threads_on(st);
4608   WatcherThread* wt = WatcherThread::watcher_thread();
4609   if (wt != NULL) {
4610     wt-&gt;print_on(st);
4611     st-&gt;cr();
4612   }
4613 
4614   st-&gt;flush();
4615 }
4616 
4617 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4618                              int buflen, bool* found_current) {
4619   if (this_thread != NULL) {
4620     bool is_current = (current == this_thread);
4621     *found_current = *found_current || is_current;
4622     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4623 
4624     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4625     st-&gt;print(" ");
4626     this_thread-&gt;print_on_error(st, buf, buflen);
4627     st-&gt;cr();
4628   }
4629 }
4630 
4631 class PrintOnErrorClosure : public ThreadClosure {
4632   outputStream* _st;
4633   Thread* _current;
4634   char* _buf;
4635   int _buflen;
4636   bool* _found_current;
4637  public:
4638   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4639                       int buflen, bool* found_current) :
4640    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4641 
4642   virtual void do_thread(Thread* thread) {
4643     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4644   }
4645 };
4646 
4647 // Threads::print_on_error() is called by fatal error handler. It's possible
4648 // that VM is not at safepoint and/or current thread is inside signal handler.
4649 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4650 // memory (even in resource area), it might deadlock the error handler.
4651 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4652                              int buflen) {
4653   ThreadsSMRSupport::print_info_on(st);
4654   st-&gt;cr();
4655 
4656   bool found_current = false;
4657   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4658   ALL_JAVA_THREADS(thread) {
4659     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4660   }
4661   st-&gt;cr();
4662 
4663   st-&gt;print_cr("Other Threads:");
4664   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4665   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4666 
4667   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4668   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4669 
4670   if (!found_current) {
4671     st-&gt;cr();
4672     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4673     current-&gt;print_on_error(st, buf, buflen);
4674     st-&gt;cr();
4675   }
4676   st-&gt;cr();
4677 
4678   st-&gt;print_cr("Threads with active compile tasks:");
4679   print_threads_compiling(st, buf, buflen);
4680 }
4681 
4682 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4683   ALL_JAVA_THREADS(thread) {
4684     if (thread-&gt;is_Compiler_thread()) {
4685       CompilerThread* ct = (CompilerThread*) thread;
4686 
4687       // Keep task in local variable for NULL check.
4688       // ct-&gt;_task might be set to NULL by concurring compiler thread
4689       // because it completed the compilation. The task is never freed,
4690       // though, just returned to a free list.
4691       CompileTask* task = ct-&gt;task();
4692       if (task != NULL) {
4693         thread-&gt;print_name_on_error(st, buf, buflen);
4694         task-&gt;print(st, NULL, true, true);
4695       }
4696     }
4697   }
4698 }
4699 
4700 
4701 // Internal SpinLock and Mutex
4702 // Based on ParkEvent
4703 
4704 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4705 //
4706 // We employ SpinLocks _only for low-contention, fixed-length
4707 // short-duration critical sections where we're concerned
4708 // about native mutex_t or HotSpot Mutex:: latency.
4709 // The mux construct provides a spin-then-block mutual exclusion
4710 // mechanism.
4711 //
4712 // Testing has shown that contention on the ListLock guarding gFreeList
4713 // is common.  If we implement ListLock as a simple SpinLock it's common
4714 // for the JVM to devolve to yielding with little progress.  This is true
4715 // despite the fact that the critical sections protected by ListLock are
4716 // extremely short.
4717 //
4718 // TODO-FIXME: ListLock should be of type SpinLock.
4719 // We should make this a 1st-class type, integrated into the lock
4720 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4721 // should have sufficient padding to avoid false-sharing and excessive
4722 // cache-coherency traffic.
4723 
4724 
4725 typedef volatile int SpinLockT;
4726 
4727 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4728   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4729     return;   // normal fast-path return
4730   }
4731 
4732   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4733   int ctr = 0;
4734   int Yields = 0;
4735   for (;;) {
4736     while (*adr != 0) {
4737       ++ctr;
4738       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4739         if (Yields &gt; 5) {
4740           os::naked_short_sleep(1);
4741         } else {
4742           os::naked_yield();
4743           ++Yields;
4744         }
4745       } else {
4746         SpinPause();
4747       }
4748     }
4749     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4750   }
4751 }
4752 
4753 void Thread::SpinRelease(volatile int * adr) {
4754   assert(*adr != 0, "invariant");
4755   OrderAccess::fence();      // guarantee at least release consistency.
4756   // Roach-motel semantics.
4757   // It's safe if subsequent LDs and STs float "up" into the critical section,
4758   // but prior LDs and STs within the critical section can't be allowed
4759   // to reorder or float past the ST that releases the lock.
4760   // Loads and stores in the critical section - which appear in program
4761   // order before the store that releases the lock - must also appear
4762   // before the store that releases the lock in memory visibility order.
4763   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4764   // the ST of 0 into the lock-word which releases the lock, so fence
4765   // more than covers this on all platforms.
4766   *adr = 0;
4767 }
4768 
4769 // muxAcquire and muxRelease:
4770 //
4771 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4772 //    The LSB of the word is set IFF the lock is held.
4773 //    The remainder of the word points to the head of a singly-linked list
4774 //    of threads blocked on the lock.
4775 //
4776 // *  The current implementation of muxAcquire-muxRelease uses its own
4777 //    dedicated Thread._MuxEvent instance.  If we're interested in
4778 //    minimizing the peak number of extant ParkEvent instances then
4779 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4780 //    as certain invariants were satisfied.  Specifically, care would need
4781 //    to be taken with regards to consuming unpark() "permits".
4782 //    A safe rule of thumb is that a thread would never call muxAcquire()
4783 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4784 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4785 //    consume an unpark() permit intended for monitorenter, for instance.
4786 //    One way around this would be to widen the restricted-range semaphore
4787 //    implemented in park().  Another alternative would be to provide
4788 //    multiple instances of the PlatformEvent() for each thread.  One
4789 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4790 //
4791 // *  Usage:
4792 //    -- Only as leaf locks
4793 //    -- for short-term locking only as muxAcquire does not perform
4794 //       thread state transitions.
4795 //
4796 // Alternatives:
4797 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4798 //    but with parking or spin-then-park instead of pure spinning.
4799 // *  Use Taura-Oyama-Yonenzawa locks.
4800 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4801 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4802 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4803 //    acquiring threads use timers (ParkTimed) to detect and recover from
4804 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4805 //    boundaries by using placement-new.
4806 // *  Augment MCS with advisory back-link fields maintained with CAS().
4807 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4808 //    The validity of the backlinks must be ratified before we trust the value.
4809 //    If the backlinks are invalid the exiting thread must back-track through the
4810 //    the forward links, which are always trustworthy.
4811 // *  Add a successor indication.  The LockWord is currently encoded as
4812 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4813 //    to provide the usual futile-wakeup optimization.
4814 //    See RTStt for details.
4815 //
4816 
4817 
4818 const intptr_t LOCKBIT = 1;
4819 
4820 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4821   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4822   if (w == 0) return;
4823   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4824     return;
4825   }
4826 
4827   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4828   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4829   for (;;) {
4830     int its = (os::is_MP() ? 100 : 0) + 1;
4831 
4832     // Optional spin phase: spin-then-park strategy
4833     while (--its &gt;= 0) {
4834       w = *Lock;
4835       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4836         return;
4837       }
4838     }
4839 
4840     Self-&gt;reset();
4841     Self-&gt;OnList = intptr_t(Lock);
4842     // The following fence() isn't _strictly necessary as the subsequent
4843     // CAS() both serializes execution and ratifies the fetched *Lock value.
4844     OrderAccess::fence();
4845     for (;;) {
4846       w = *Lock;
4847       if ((w &amp; LOCKBIT) == 0) {
4848         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4849           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4850           return;
4851         }
4852         continue;      // Interference -- *Lock changed -- Just retry
4853       }
4854       assert(w &amp; LOCKBIT, "invariant");
4855       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4856       if (Atomic::cmpxchg(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4857     }
4858 
4859     while (Self-&gt;OnList != 0) {
4860       Self-&gt;park();
4861     }
4862   }
4863 }
4864 
4865 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4866   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4867   if (w == 0) return;
4868   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4869     return;
4870   }
4871 
4872   ParkEvent * ReleaseAfter = NULL;
4873   if (ev == NULL) {
4874     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4875   }
4876   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4877   for (;;) {
4878     guarantee(ev-&gt;OnList == 0, "invariant");
4879     int its = (os::is_MP() ? 100 : 0) + 1;
4880 
4881     // Optional spin phase: spin-then-park strategy
4882     while (--its &gt;= 0) {
4883       w = *Lock;
4884       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4885         if (ReleaseAfter != NULL) {
4886           ParkEvent::Release(ReleaseAfter);
4887         }
4888         return;
4889       }
4890     }
4891 
4892     ev-&gt;reset();
4893     ev-&gt;OnList = intptr_t(Lock);
4894     // The following fence() isn't _strictly necessary as the subsequent
4895     // CAS() both serializes execution and ratifies the fetched *Lock value.
4896     OrderAccess::fence();
4897     for (;;) {
4898       w = *Lock;
4899       if ((w &amp; LOCKBIT) == 0) {
4900         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4901           ev-&gt;OnList = 0;
4902           // We call ::Release while holding the outer lock, thus
4903           // artificially lengthening the critical section.
4904           // Consider deferring the ::Release() until the subsequent unlock(),
4905           // after we've dropped the outer lock.
4906           if (ReleaseAfter != NULL) {
4907             ParkEvent::Release(ReleaseAfter);
4908           }
4909           return;
4910         }
4911         continue;      // Interference -- *Lock changed -- Just retry
4912       }
4913       assert(w &amp; LOCKBIT, "invariant");
4914       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4915       if (Atomic::cmpxchg(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4916     }
4917 
4918     while (ev-&gt;OnList != 0) {
4919       ev-&gt;park();
4920     }
4921   }
4922 }
4923 
4924 // Release() must extract a successor from the list and then wake that thread.
4925 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4926 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4927 // Release() would :
4928 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4929 // (B) Extract a successor from the private list "in-hand"
4930 // (C) attempt to CAS() the residual back into *Lock over null.
4931 //     If there were any newly arrived threads and the CAS() would fail.
4932 //     In that case Release() would detach the RATs, re-merge the list in-hand
4933 //     with the RATs and repeat as needed.  Alternately, Release() might
4934 //     detach and extract a successor, but then pass the residual list to the wakee.
4935 //     The wakee would be responsible for reattaching and remerging before it
4936 //     competed for the lock.
4937 //
4938 // Both "pop" and DMR are immune from ABA corruption -- there can be
4939 // multiple concurrent pushers, but only one popper or detacher.
4940 // This implementation pops from the head of the list.  This is unfair,
4941 // but tends to provide excellent throughput as hot threads remain hot.
4942 // (We wake recently run threads first).
4943 //
4944 // All paths through muxRelease() will execute a CAS.
4945 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4946 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4947 // executed within the critical section are complete and globally visible before the
4948 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4949 void Thread::muxRelease(volatile intptr_t * Lock)  {
4950   for (;;) {
4951     const intptr_t w = Atomic::cmpxchg((intptr_t)0, Lock, LOCKBIT);
4952     assert(w &amp; LOCKBIT, "invariant");
4953     if (w == LOCKBIT) return;
4954     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4955     assert(List != NULL, "invariant");
4956     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4957     ParkEvent * const nxt = List-&gt;ListNext;
4958     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4959 
4960     // The following CAS() releases the lock and pops the head element.
4961     // The CAS() also ratifies the previously fetched lock-word value.
4962     if (Atomic::cmpxchg(intptr_t(nxt), Lock, w) != w) {
4963       continue;
4964     }
4965     List-&gt;OnList = 0;
4966     OrderAccess::fence();
4967     List-&gt;unpark();
4968     return;
4969   }
4970 }
4971 
4972 
4973 void Threads::verify() {
4974   ALL_JAVA_THREADS(p) {
4975     p-&gt;verify();
4976   }
4977   VMThread* thread = VMThread::vm_thread();
4978   if (thread != NULL) thread-&gt;verify();
4979 }
</pre></body></html>
