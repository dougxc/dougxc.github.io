<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/hotspot/share/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/javaClasses.hpp"
  29 #include "classfile/moduleEntry.hpp"
  30 #include "classfile/systemDictionary.hpp"
  31 #include "classfile/vmSymbols.hpp"
  32 #include "code/codeCache.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/barrierSet.hpp"
  37 #include "gc/shared/gcId.hpp"
  38 #include "gc/shared/gcLocker.inline.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jfr/jfrEvents.hpp"
  44 #include "jfr/support/jfrThreadId.hpp"
  45 #include "jvmtifiles/jvmtiEnv.hpp"
  46 #include "logging/log.hpp"
  47 #include "logging/logConfiguration.hpp"
  48 #include "logging/logStream.hpp"
  49 #include "memory/allocation.inline.hpp"
  50 #include "memory/metaspaceShared.hpp"
  51 #include "memory/oopFactory.hpp"
  52 #include "memory/resourceArea.hpp"
  53 #include "memory/universe.hpp"
  54 #include "oops/access.inline.hpp"
  55 #include "oops/instanceKlass.hpp"
  56 #include "oops/objArrayOop.hpp"
  57 #include "oops/oop.inline.hpp"
  58 #include "oops/symbol.hpp"
  59 #include "oops/typeArrayOop.inline.hpp"
  60 #include "oops/verifyOopClosure.hpp"
  61 #include "prims/jvm_misc.hpp"
  62 #include "prims/jvmtiExport.hpp"
  63 #include "prims/jvmtiThreadState.hpp"
  64 #include "prims/privilegedStack.hpp"
  65 #include "runtime/arguments.hpp"
  66 #include "runtime/atomic.hpp"
  67 #include "runtime/biasedLocking.hpp"
  68 #include "runtime/fieldDescriptor.inline.hpp"
  69 #include "runtime/flags/jvmFlagConstraintList.hpp"
  70 #include "runtime/flags/jvmFlagRangeList.hpp"
  71 #include "runtime/flags/jvmFlagWriteableList.hpp"
  72 #include "runtime/deoptimization.hpp"
  73 #include "runtime/frame.inline.hpp"
  74 #include "runtime/handshake.hpp"
  75 #include "runtime/init.hpp"
  76 #include "runtime/interfaceSupport.inline.hpp"
  77 #include "runtime/java.hpp"
  78 #include "runtime/javaCalls.hpp"
  79 #include "runtime/jniHandles.inline.hpp"
  80 #include "runtime/jniPeriodicChecker.hpp"
  81 #include "runtime/memprofiler.hpp"
  82 #include "runtime/mutexLocker.hpp"
  83 #include "runtime/objectMonitor.hpp"
  84 #include "runtime/orderAccess.hpp"
  85 #include "runtime/osThread.hpp"
  86 #include "runtime/prefetch.inline.hpp"
  87 #include "runtime/safepoint.hpp"
  88 #include "runtime/safepointMechanism.inline.hpp"
  89 #include "runtime/safepointVerifiers.hpp"
  90 #include "runtime/sharedRuntime.hpp"
  91 #include "runtime/statSampler.hpp"
  92 #include "runtime/stubRoutines.hpp"
  93 #include "runtime/sweeper.hpp"
  94 #include "runtime/task.hpp"
  95 #include "runtime/thread.inline.hpp"
  96 #include "runtime/threadCritical.hpp"
  97 #include "runtime/threadSMR.inline.hpp"
  98 #include "runtime/threadStatisticalInfo.hpp"
  99 #include "runtime/timer.hpp"
 100 #include "runtime/timerTrace.hpp"
 101 #include "runtime/vframe.inline.hpp"
 102 #include "runtime/vframeArray.hpp"
 103 #include "runtime/vframe_hp.hpp"
 104 #include "runtime/vmThread.hpp"
 105 #include "runtime/vm_operations.hpp"
 106 #include "runtime/vm_version.hpp"
 107 #include "services/attachListener.hpp"
 108 #include "services/management.hpp"
 109 #include "services/memTracker.hpp"
 110 #include "services/threadService.hpp"
 111 #include "utilities/align.hpp"
 112 #include "utilities/copy.hpp"
 113 #include "utilities/defaultStream.hpp"
 114 #include "utilities/dtrace.hpp"
 115 #include "utilities/events.hpp"
 116 #include "utilities/macros.hpp"
 117 #include "utilities/preserveException.hpp"
 118 #include "utilities/singleWriterSynchronizer.hpp"
 119 #include "utilities/vmError.hpp"
 120 #if INCLUDE_JVMCI
 121 #include "jvmci/jvmciCompiler.hpp"
 122 #include "jvmci/jvmciRuntime.hpp"
 123 #include "logging/logHandle.hpp"
 124 #endif
 125 #ifdef COMPILER1
 126 #include "c1/c1_Compiler.hpp"
 127 #endif
 128 #ifdef COMPILER2
 129 #include "opto/c2compiler.hpp"
 130 #include "opto/idealGraphPrinter.hpp"
 131 #endif
 132 #if INCLUDE_RTM_OPT
 133 #include "runtime/rtmLocking.hpp"
 134 #endif
 135 #if INCLUDE_JFR
 136 #include "jfr/jfr.hpp"
 137 #endif
 138 
 139 // Initialization after module runtime initialization
 140 void universe_post_module_init();  // must happen after call_initPhase2
 141 
 142 #ifdef DTRACE_ENABLED
 143 
 144 // Only bother with this argument setup if dtrace is available
 145 
 146   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 147   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 150     {                                                                      \
 151       ResourceMark rm(this);                                               \
 152       int len = 0;                                                         \
 153       const char* name = (javathread)-&gt;get_thread_name();                  \
 154       len = strlen(name);                                                  \
 155       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 156         (char *) name, len,                                                \
 157         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 158         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 159         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 160     }
 161 
 162 #else //  ndef DTRACE_ENABLED
 163 
 164   #define DTRACE_THREAD_PROBE(probe, javathread)
 165 
 166 #endif // ndef DTRACE_ENABLED
 167 
 168 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 169 // Current thread is maintained as a thread-local variable
 170 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 171 #endif
 172 
 173 // ======= Thread ========
 174 // Support for forcing alignment of thread objects for biased locking
 175 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 176   if (UseBiasedLocking) {
 177     const int alignment = markOopDesc::biased_lock_alignment;
 178     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 179     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 180                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 181                                                          AllocFailStrategy::RETURN_NULL);
 182     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 183     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 184            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 185            "JavaThread alignment code overflowed allocated storage");
 186     if (aligned_addr != real_malloc_addr) {
 187       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 188                               p2i(real_malloc_addr),
 189                               p2i(aligned_addr));
 190     }
 191     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 192     return aligned_addr;
 193   } else {
 194     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 195                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 196   }
 197 }
 198 
 199 void Thread::operator delete(void* p) {
 200   if (UseBiasedLocking) {
 201     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 202   } else {
 203     FreeHeap(p);
 204   }
 205 }
 206 
 207 void JavaThread::smr_delete() {
 208   if (_on_thread_list) {
 209     ThreadsSMRSupport::smr_delete(this);
 210   } else {
 211     delete this;
 212   }
 213 }
 214 
 215 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 216 // JavaThread
 217 
 218 
 219 Thread::Thread() {
 220   // stack and get_thread
 221   set_stack_base(NULL);
 222   set_stack_size(0);
 223   set_self_raw_id(0);
 224   set_lgrp_id(-1);
 225   DEBUG_ONLY(clear_suspendible_thread();)
 226 
 227   // allocated data structures
 228   set_osthread(NULL);
 229   set_resource_area(new (mtThread)ResourceArea());
 230   DEBUG_ONLY(_current_resource_mark = NULL;)
 231   set_handle_area(new (mtThread) HandleArea(NULL));
 232   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 233   set_active_handles(NULL);
 234   set_free_handle_block(NULL);
 235   set_last_handle_mark(NULL);
 236 
 237   // This initial value ==&gt; never claimed.
 238   _oops_do_parity = 0;
 239   _threads_hazard_ptr = NULL;
 240   _threads_list_ptr = NULL;
 241   _nested_threads_hazard_ptr_cnt = 0;
 242   _rcu_counter = 0;
 243 
 244   // the handle mark links itself to last_handle_mark
 245   new HandleMark(this);
 246 
 247   // plain initialization
 248   debug_only(_owned_locks = NULL;)
 249   debug_only(_allow_allocation_count = 0;)
 250   NOT_PRODUCT(_allow_safepoint_count = 0;)
 251   NOT_PRODUCT(_skip_gcalot = false;)
 252   _jvmti_env_iteration_count = 0;
 253   set_allocated_bytes(0);
 254   _vm_operation_started_count = 0;
 255   _vm_operation_completed_count = 0;
 256   _current_pending_monitor = NULL;
 257   _current_pending_monitor_is_from_java = true;
 258   _current_waiting_monitor = NULL;
 259   _num_nested_signal = 0;
 260   omFreeList = NULL;
 261   omFreeCount = 0;
 262   omFreeProvision = 32;
 263   omInUseList = NULL;
 264   omInUseCount = 0;
 265 
 266 #ifdef ASSERT
 267   _visited_for_critical_count = false;
 268 #endif
 269 
 270   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 271                          Monitor::_safepoint_check_sometimes);
 272   _suspend_flags = 0;
 273 
 274   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 275   _hashStateX = os::random();
 276   _hashStateY = 842502087;
 277   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 278   _hashStateW = 273326509;
 279 
 280   _OnTrap   = 0;
 281   _Stalled  = 0;
 282   _TypeTag  = 0x2BAD;
 283 
 284   // Many of the following fields are effectively final - immutable
 285   // Note that nascent threads can't use the Native Monitor-Mutex
 286   // construct until the _MutexEvent is initialized ...
 287   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 288   // we might instead use a stack of ParkEvents that we could provision on-demand.
 289   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 290   // and ::Release()
 291   _ParkEvent   = ParkEvent::Allocate(this);
 292   _SleepEvent  = ParkEvent::Allocate(this);
 293   _MutexEvent  = ParkEvent::Allocate(this);
 294   _MuxEvent    = ParkEvent::Allocate(this);
 295 
 296 #ifdef CHECK_UNHANDLED_OOPS
 297   if (CheckUnhandledOops) {
 298     _unhandled_oops = new UnhandledOops(this);
 299   }
 300 #endif // CHECK_UNHANDLED_OOPS
 301 #ifdef ASSERT
 302   if (UseBiasedLocking) {
 303     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 304     assert(this == _real_malloc_address ||
 305            this == align_up(_real_malloc_address, (int)markOopDesc::biased_lock_alignment),
 306            "bug in forced alignment of thread objects");
 307   }
 308 #endif // ASSERT
 309 
 310   // Notify the barrier set that a thread is being created. Note that some
 311   // threads are created before a barrier set is available. The call to
 312   // BarrierSet::on_thread_create() for these threads is therefore deferred
 313   // to BarrierSet::set_barrier_set().
 314   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 315   if (barrier_set != NULL) {
 316     barrier_set-&gt;on_thread_create(this);
 317   } else {
 318     DEBUG_ONLY(Threads::inc_threads_before_barrier_set();)
 319   }
 320 }
 321 
 322 void Thread::initialize_thread_current() {
 323 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 324   assert(_thr_current == NULL, "Thread::current already initialized");
 325   _thr_current = this;
 326 #endif
 327   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 328   ThreadLocalStorage::set_thread(this);
 329   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 330 }
 331 
 332 void Thread::clear_thread_current() {
 333   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 334 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 335   _thr_current = NULL;
 336 #endif
 337   ThreadLocalStorage::set_thread(NULL);
 338 }
 339 
 340 void Thread::record_stack_base_and_size() {
 341   set_stack_base(os::current_stack_base());
 342   set_stack_size(os::current_stack_size());
 343   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 344   // in initialize_thread(). Without the adjustment, stack size is
 345   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 346   // So far, only Solaris has real implementation of initialize_thread().
 347   //
 348   // set up any platform-specific state.
 349   os::initialize_thread(this);
 350 
 351   // Set stack limits after thread is initialized.
 352   if (is_Java_thread()) {
 353     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 354     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 355   }
 356 #if INCLUDE_NMT
 357   // record thread's native stack, stack grows downward
 358   MemTracker::record_thread_stack(stack_end(), stack_size());
 359 #endif // INCLUDE_NMT
 360   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 361     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 362     os::current_thread_id(), p2i(stack_base() - stack_size()),
 363     p2i(stack_base()), stack_size()/1024);
 364 }
 365 
 366 
 367 Thread::~Thread() {
 368   JFR_ONLY(Jfr::on_thread_destruct(this);)
 369 
 370   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 371   // set might not be available if we encountered errors during bootstrapping.
 372   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 373   if (barrier_set != NULL) {
 374     barrier_set-&gt;on_thread_destroy(this);
 375   }
 376 
 377 
 378   // stack_base can be NULL if the thread is never started or exited before
 379   // record_stack_base_and_size called. Although, we would like to ensure
 380   // that all started threads do call record_stack_base_and_size(), there is
 381   // not proper way to enforce that.
 382 #if INCLUDE_NMT
 383   if (_stack_base != NULL) {
 384     MemTracker::release_thread_stack(stack_end(), stack_size());
 385 #ifdef ASSERT
 386     set_stack_base(NULL);
 387 #endif
 388   }
 389 #endif // INCLUDE_NMT
 390 
 391   // deallocate data structures
 392   delete resource_area();
 393   // since the handle marks are using the handle area, we have to deallocated the root
 394   // handle mark before deallocating the thread's handle area,
 395   assert(last_handle_mark() != NULL, "check we have an element");
 396   delete last_handle_mark();
 397   assert(last_handle_mark() == NULL, "check we have reached the end");
 398 
 399   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 400   // We NULL out the fields for good hygiene.
 401   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 402   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 403   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 404   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 405 
 406   delete handle_area();
 407   delete metadata_handles();
 408 
 409   // SR_handler uses this as a termination indicator -
 410   // needs to happen before os::free_thread()
 411   delete _SR_lock;
 412   _SR_lock = NULL;
 413 
 414   // osthread() can be NULL, if creation of thread failed.
 415   if (osthread() != NULL) os::free_thread(osthread());
 416 
 417   // clear Thread::current if thread is deleting itself.
 418   // Needed to ensure JNI correctly detects non-attached threads.
 419   if (this == Thread::current()) {
 420     clear_thread_current();
 421   }
 422 
 423   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 424 }
 425 
 426 // NOTE: dummy function for assertion purpose.
 427 void Thread::run() {
 428   ShouldNotReachHere();
 429 }
 430 
 431 #ifdef ASSERT
 432 // A JavaThread is considered "dangling" if it is not the current
 433 // thread, has been added the Threads list, the system is not at a
 434 // safepoint and the Thread is not "protected".
 435 //
 436 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 437   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 438          !((JavaThread *) thread)-&gt;on_thread_list() ||
 439          SafepointSynchronize::is_at_safepoint() ||
 440          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 441          "possibility of dangling Thread pointer");
 442 }
 443 #endif
 444 
 445 ThreadPriority Thread::get_priority(const Thread* const thread) {
 446   ThreadPriority priority;
 447   // Can return an error!
 448   (void)os::get_priority(thread, priority);
 449   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 450   return priority;
 451 }
 452 
 453 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 454   debug_only(check_for_dangling_thread_pointer(thread);)
 455   // Can return an error!
 456   (void)os::set_priority(thread, priority);
 457 }
 458 
 459 
 460 void Thread::start(Thread* thread) {
 461   // Start is different from resume in that its safety is guaranteed by context or
 462   // being called from a Java method synchronized on the Thread object.
 463   if (!DisableStartThread) {
 464     if (thread-&gt;is_Java_thread()) {
 465       // Initialize the thread state to RUNNABLE before starting this thread.
 466       // Can not set it after the thread started because we do not know the
 467       // exact thread state at that time. It could be in MONITOR_WAIT or
 468       // in SLEEPING or some other state.
 469       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 470                                           java_lang_Thread::RUNNABLE);
 471     }
 472     os::start_thread(thread);
 473   }
 474 }
 475 
 476 // Enqueue a VM_Operation to do the job for us - sometime later
 477 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 478   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 479   VMThread::execute(vm_stop);
 480 }
 481 
 482 
 483 // Check if an external suspend request has completed (or has been
 484 // cancelled). Returns true if the thread is externally suspended and
 485 // false otherwise.
 486 //
 487 // The bits parameter returns information about the code path through
 488 // the routine. Useful for debugging:
 489 //
 490 // set in is_ext_suspend_completed():
 491 // 0x00000001 - routine was entered
 492 // 0x00000010 - routine return false at end
 493 // 0x00000100 - thread exited (return false)
 494 // 0x00000200 - suspend request cancelled (return false)
 495 // 0x00000400 - thread suspended (return true)
 496 // 0x00001000 - thread is in a suspend equivalent state (return true)
 497 // 0x00002000 - thread is native and walkable (return true)
 498 // 0x00004000 - thread is native_trans and walkable (needed retry)
 499 //
 500 // set in wait_for_ext_suspend_completion():
 501 // 0x00010000 - routine was entered
 502 // 0x00020000 - suspend request cancelled before loop (return false)
 503 // 0x00040000 - thread suspended before loop (return true)
 504 // 0x00080000 - suspend request cancelled in loop (return false)
 505 // 0x00100000 - thread suspended in loop (return true)
 506 // 0x00200000 - suspend not completed during retry loop (return false)
 507 
 508 // Helper class for tracing suspend wait debug bits.
 509 //
 510 // 0x00000100 indicates that the target thread exited before it could
 511 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 512 // 0x00080000 each indicate a cancelled suspend request so they don't
 513 // count as wait failures either.
 514 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 515 
 516 class TraceSuspendDebugBits : public StackObj {
 517  private:
 518   JavaThread * jt;
 519   bool         is_wait;
 520   bool         called_by_wait;  // meaningful when !is_wait
 521   uint32_t *   bits;
 522 
 523  public:
 524   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 525                         uint32_t *_bits) {
 526     jt             = _jt;
 527     is_wait        = _is_wait;
 528     called_by_wait = _called_by_wait;
 529     bits           = _bits;
 530   }
 531 
 532   ~TraceSuspendDebugBits() {
 533     if (!is_wait) {
 534 #if 1
 535       // By default, don't trace bits for is_ext_suspend_completed() calls.
 536       // That trace is very chatty.
 537       return;
 538 #else
 539       if (!called_by_wait) {
 540         // If tracing for is_ext_suspend_completed() is enabled, then only
 541         // trace calls to it from wait_for_ext_suspend_completion()
 542         return;
 543       }
 544 #endif
 545     }
 546 
 547     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 548       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 549         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 550         ResourceMark rm;
 551 
 552         tty-&gt;print_cr(
 553                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 554                       jt-&gt;get_thread_name(), *bits);
 555 
 556         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 557       }
 558     }
 559   }
 560 };
 561 #undef DEBUG_FALSE_BITS
 562 
 563 
 564 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 565                                           uint32_t *bits) {
 566   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 567 
 568   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 569   bool do_trans_retry;           // flag to force the retry
 570 
 571   *bits |= 0x00000001;
 572 
 573   do {
 574     do_trans_retry = false;
 575 
 576     if (is_exiting()) {
 577       // Thread is in the process of exiting. This is always checked
 578       // first to reduce the risk of dereferencing a freed JavaThread.
 579       *bits |= 0x00000100;
 580       return false;
 581     }
 582 
 583     if (!is_external_suspend()) {
 584       // Suspend request is cancelled. This is always checked before
 585       // is_ext_suspended() to reduce the risk of a rogue resume
 586       // confusing the thread that made the suspend request.
 587       *bits |= 0x00000200;
 588       return false;
 589     }
 590 
 591     if (is_ext_suspended()) {
 592       // thread is suspended
 593       *bits |= 0x00000400;
 594       return true;
 595     }
 596 
 597     // Now that we no longer do hard suspends of threads running
 598     // native code, the target thread can be changing thread state
 599     // while we are in this routine:
 600     //
 601     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 602     //
 603     // We save a copy of the thread state as observed at this moment
 604     // and make our decision about suspend completeness based on the
 605     // copy. This closes the race where the thread state is seen as
 606     // _thread_in_native_trans in the if-thread_blocked check, but is
 607     // seen as _thread_blocked in if-thread_in_native_trans check.
 608     JavaThreadState save_state = thread_state();
 609 
 610     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 611       // If the thread's state is _thread_blocked and this blocking
 612       // condition is known to be equivalent to a suspend, then we can
 613       // consider the thread to be externally suspended. This means that
 614       // the code that sets _thread_blocked has been modified to do
 615       // self-suspension if the blocking condition releases. We also
 616       // used to check for CONDVAR_WAIT here, but that is now covered by
 617       // the _thread_blocked with self-suspension check.
 618       //
 619       // Return true since we wouldn't be here unless there was still an
 620       // external suspend request.
 621       *bits |= 0x00001000;
 622       return true;
 623     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 624       // Threads running native code will self-suspend on native==&gt;VM/Java
 625       // transitions. If its stack is walkable (should always be the case
 626       // unless this function is called before the actual java_suspend()
 627       // call), then the wait is done.
 628       *bits |= 0x00002000;
 629       return true;
 630     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 631                save_state == _thread_in_native_trans &amp;&amp;
 632                frame_anchor()-&gt;walkable()) {
 633       // The thread is transitioning from thread_in_native to another
 634       // thread state. check_safepoint_and_suspend_for_native_trans()
 635       // will force the thread to self-suspend. If it hasn't gotten
 636       // there yet we may have caught the thread in-between the native
 637       // code check above and the self-suspend. Lucky us. If we were
 638       // called by wait_for_ext_suspend_completion(), then it
 639       // will be doing the retries so we don't have to.
 640       //
 641       // Since we use the saved thread state in the if-statement above,
 642       // there is a chance that the thread has already transitioned to
 643       // _thread_blocked by the time we get here. In that case, we will
 644       // make a single unnecessary pass through the logic below. This
 645       // doesn't hurt anything since we still do the trans retry.
 646 
 647       *bits |= 0x00004000;
 648 
 649       // Once the thread leaves thread_in_native_trans for another
 650       // thread state, we break out of this retry loop. We shouldn't
 651       // need this flag to prevent us from getting back here, but
 652       // sometimes paranoia is good.
 653       did_trans_retry = true;
 654 
 655       // We wait for the thread to transition to a more usable state.
 656       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 657         // We used to do an "os::yield_all(i)" call here with the intention
 658         // that yielding would increase on each retry. However, the parameter
 659         // is ignored on Linux which means the yield didn't scale up. Waiting
 660         // on the SR_lock below provides a much more predictable scale up for
 661         // the delay. It also provides a simple/direct point to check for any
 662         // safepoint requests from the VMThread
 663 
 664         // temporarily drops SR_lock while doing wait with safepoint check
 665         // (if we're a JavaThread - the WatcherThread can also call this)
 666         // and increase delay with each retry
 667         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 668 
 669         // check the actual thread state instead of what we saved above
 670         if (thread_state() != _thread_in_native_trans) {
 671           // the thread has transitioned to another thread state so
 672           // try all the checks (except this one) one more time.
 673           do_trans_retry = true;
 674           break;
 675         }
 676       } // end retry loop
 677 
 678 
 679     }
 680   } while (do_trans_retry);
 681 
 682   *bits |= 0x00000010;
 683   return false;
 684 }
 685 
 686 // Wait for an external suspend request to complete (or be cancelled).
 687 // Returns true if the thread is externally suspended and false otherwise.
 688 //
 689 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 690                                                  uint32_t *bits) {
 691   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 692                              false /* !called_by_wait */, bits);
 693 
 694   // local flag copies to minimize SR_lock hold time
 695   bool is_suspended;
 696   bool pending;
 697   uint32_t reset_bits;
 698 
 699   // set a marker so is_ext_suspend_completed() knows we are the caller
 700   *bits |= 0x00010000;
 701 
 702   // We use reset_bits to reinitialize the bits value at the top of
 703   // each retry loop. This allows the caller to make use of any
 704   // unused bits for their own marking purposes.
 705   reset_bits = *bits;
 706 
 707   {
 708     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 709     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 710                                             delay, bits);
 711     pending = is_external_suspend();
 712   }
 713   // must release SR_lock to allow suspension to complete
 714 
 715   if (!pending) {
 716     // A cancelled suspend request is the only false return from
 717     // is_ext_suspend_completed() that keeps us from entering the
 718     // retry loop.
 719     *bits |= 0x00020000;
 720     return false;
 721   }
 722 
 723   if (is_suspended) {
 724     *bits |= 0x00040000;
 725     return true;
 726   }
 727 
 728   for (int i = 1; i &lt;= retries; i++) {
 729     *bits = reset_bits;  // reinit to only track last retry
 730 
 731     // We used to do an "os::yield_all(i)" call here with the intention
 732     // that yielding would increase on each retry. However, the parameter
 733     // is ignored on Linux which means the yield didn't scale up. Waiting
 734     // on the SR_lock below provides a much more predictable scale up for
 735     // the delay. It also provides a simple/direct point to check for any
 736     // safepoint requests from the VMThread
 737 
 738     {
 739       MutexLocker ml(SR_lock());
 740       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 741       // can also call this)  and increase delay with each retry
 742       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 743 
 744       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 745                                               delay, bits);
 746 
 747       // It is possible for the external suspend request to be cancelled
 748       // (by a resume) before the actual suspend operation is completed.
 749       // Refresh our local copy to see if we still need to wait.
 750       pending = is_external_suspend();
 751     }
 752 
 753     if (!pending) {
 754       // A cancelled suspend request is the only false return from
 755       // is_ext_suspend_completed() that keeps us from staying in the
 756       // retry loop.
 757       *bits |= 0x00080000;
 758       return false;
 759     }
 760 
 761     if (is_suspended) {
 762       *bits |= 0x00100000;
 763       return true;
 764     }
 765   } // end retry loop
 766 
 767   // thread did not suspend after all our retries
 768   *bits |= 0x00200000;
 769   return false;
 770 }
 771 
 772 // Called from API entry points which perform stack walking. If the
 773 // associated JavaThread is the current thread, then wait_for_suspend
 774 // is not used. Otherwise, it determines if we should wait for the
 775 // "other" thread to complete external suspension. (NOTE: in future
 776 // releases the suspension mechanism should be reimplemented so this
 777 // is not necessary.)
 778 //
 779 bool
 780 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 781   if (this != JavaThread::current()) {
 782     // "other" threads require special handling.
 783     if (wait_for_suspend) {
 784       // We are allowed to wait for the external suspend to complete
 785       // so give the other thread a chance to get suspended.
 786       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 787                                            SuspendRetryDelay, bits)) {
 788         // Didn't make it so let the caller know.
 789         return false;
 790       }
 791     }
 792     // We aren't allowed to wait for the external suspend to complete
 793     // so if the other thread isn't externally suspended we need to
 794     // let the caller know.
 795     else if (!is_ext_suspend_completed_with_lock(bits)) {
 796       return false;
 797     }
 798   }
 799 
 800   return true;
 801 }
 802 
 803 #ifndef PRODUCT
 804 void JavaThread::record_jump(address target, address instr, const char* file,
 805                              int line) {
 806 
 807   // This should not need to be atomic as the only way for simultaneous
 808   // updates is via interrupts. Even then this should be rare or non-existent
 809   // and we don't care that much anyway.
 810 
 811   int index = _jmp_ring_index;
 812   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 813   _jmp_ring[index]._target = (intptr_t) target;
 814   _jmp_ring[index]._instruction = (intptr_t) instr;
 815   _jmp_ring[index]._file = file;
 816   _jmp_ring[index]._line = line;
 817 }
 818 #endif // PRODUCT
 819 
 820 void Thread::interrupt(Thread* thread) {
 821   debug_only(check_for_dangling_thread_pointer(thread);)
 822   os::interrupt(thread);
 823 }
 824 
 825 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 826   debug_only(check_for_dangling_thread_pointer(thread);)
 827   // Note:  If clear_interrupted==false, this simply fetches and
 828   // returns the value of the field osthread()-&gt;interrupted().
 829   return os::is_interrupted(thread, clear_interrupted);
 830 }
 831 
 832 
 833 // GC Support
 834 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 835   int thread_parity = _oops_do_parity;
 836   if (thread_parity != strong_roots_parity) {
 837     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 838     if (res == thread_parity) {
 839       return true;
 840     } else {
 841       guarantee(res == strong_roots_parity, "Or else what?");
 842       return false;
 843     }
 844   }
 845   return false;
 846 }
 847 
 848 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 849   active_handles()-&gt;oops_do(f);
 850   // Do oop for ThreadShadow
 851   f-&gt;do_oop((oop*)&amp;_pending_exception);
 852   handle_area()-&gt;oops_do(f);
 853 
 854   // We scan thread local monitor lists here, and the remaining global
 855   // monitors in ObjectSynchronizer::oops_do().
 856   ObjectSynchronizer::thread_local_used_oops_do(this, f);
 857 }
 858 
 859 void Thread::metadata_handles_do(void f(Metadata*)) {
 860   // Only walk the Handles in Thread.
 861   if (metadata_handles() != NULL) {
 862     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 863       f(metadata_handles()-&gt;at(i));
 864     }
 865   }
 866 }
 867 
 868 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 869   // get_priority assumes osthread initialized
 870   if (osthread() != NULL) {
 871     int os_prio;
 872     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 873       st-&gt;print("os_prio=%d ", os_prio);
 874     }
 875 
 876     st-&gt;print("cpu=%.2fms ",
 877               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 878               );
 879     st-&gt;print("elapsed=%.2fs ",
 880               _statistical_info.getElapsedTime() / 1000.0
 881               );
 882     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 883       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 884       st-&gt;print("allocated=" SIZE_FORMAT "%s ",
 885                 byte_size_in_proper_unit(allocated_bytes),
 886                 proper_unit_for_byte_size(allocated_bytes)
 887                 );
 888       st-&gt;print("defined_classes=" INT64_FORMAT " ", _statistical_info.getDefineClassCount());
 889     }
 890 
 891     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 892     osthread()-&gt;print_on(st);
 893   }
 894   ThreadsSMRSupport::print_info_on(this, st);
 895   st-&gt;print(" ");
 896   debug_only(if (WizardMode) print_owned_locks_on(st);)
 897 }
 898 
 899 // Thread::print_on_error() is called by fatal error handler. Don't use
 900 // any lock or allocate memory.
 901 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 902   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 903 
 904   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 905   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 906   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 907   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 908   else                                { st-&gt;print("Thread"); }
 909 
 910   if (is_Named_thread()) {
 911     st-&gt;print(" \"%s\"", name());
 912   }
 913 
 914   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 915             p2i(stack_end()), p2i(stack_base()));
 916 
 917   if (osthread()) {
 918     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 919   }
 920 
 921   ThreadsSMRSupport::print_info_on(this, st);
 922 }
 923 
 924 void Thread::print_value_on(outputStream* st) const {
 925   if (is_Named_thread()) {
 926     st-&gt;print(" \"%s\" ", name());
 927   }
 928   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 929 }
 930 
 931 #ifdef ASSERT
 932 void Thread::print_owned_locks_on(outputStream* st) const {
 933   Monitor *cur = _owned_locks;
 934   if (cur == NULL) {
 935     st-&gt;print(" (no locks) ");
 936   } else {
 937     st-&gt;print_cr(" Locks owned:");
 938     while (cur) {
 939       cur-&gt;print_on(st);
 940       cur = cur-&gt;next();
 941     }
 942   }
 943 }
 944 
 945 static int ref_use_count  = 0;
 946 
 947 bool Thread::owns_locks_but_compiled_lock() const {
 948   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 949     if (cur != Compile_lock) return true;
 950   }
 951   return false;
 952 }
 953 
 954 
 955 #endif
 956 
 957 #ifndef PRODUCT
 958 
 959 // The flag: potential_vm_operation notifies if this particular safepoint state could potentially
 960 // invoke the vm-thread (e.g., an oop allocation). In that case, we also have to make sure that
 961 // no locks which allow_vm_block's are held
 962 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 963   // Check if current thread is allowed to block at a safepoint
 964   if (!(_allow_safepoint_count == 0)) {
 965     fatal("Possible safepoint reached by thread that does not allow it");
 966   }
 967   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 968     fatal("LEAF method calling lock?");
 969   }
 970 
 971 #ifdef ASSERT
 972   if (potential_vm_operation &amp;&amp; is_Java_thread()
 973       &amp;&amp; !Universe::is_bootstrapping()) {
 974     // Make sure we do not hold any locks that the VM thread also uses.
 975     // This could potentially lead to deadlocks
 976     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 977       // Threads_lock is special, since the safepoint synchronization will not start before this is
 978       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 979       // since it is used to transfer control between JavaThreads and the VMThread
 980       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 981       if ((cur-&gt;allow_vm_block() &amp;&amp;
 982            cur != Threads_lock &amp;&amp;
 983            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 984            cur != VMOperationRequest_lock &amp;&amp;
 985            cur != VMOperationQueue_lock) ||
 986            cur-&gt;rank() == Mutex::special) {
 987         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 988       }
 989     }
 990   }
 991 
 992   if (GCALotAtAllSafepoints) {
 993     // We could enter a safepoint here and thus have a gc
 994     InterfaceSupport::check_gc_alot();
 995   }
 996 #endif
 997 }
 998 #endif
 999 
1000 bool Thread::is_in_stack(address adr) const {
1001   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
1002   address end = os::current_stack_pointer();
1003   // Allow non Java threads to call this without stack_base
1004   if (_stack_base == NULL) return true;
1005   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
1006 
1007   return false;
1008 }
1009 
1010 bool Thread::is_in_usable_stack(address adr) const {
1011   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
1012   size_t usable_stack_size = _stack_size - stack_guard_size;
1013 
1014   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
1015 }
1016 
1017 
1018 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1019 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1020 // used for compilation in the future. If that change is made, the need for these methods
1021 // should be revisited, and they should be removed if possible.
1022 
1023 bool Thread::is_lock_owned(address adr) const {
1024   return on_local_stack(adr);
1025 }
1026 
1027 bool Thread::set_as_starting_thread() {
1028   // NOTE: this must be called inside the main thread.
1029   return os::create_main_thread((JavaThread*)this);
1030 }
1031 
1032 static void initialize_class(Symbol* class_name, TRAPS) {
1033   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1034   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1035 }
1036 
1037 
1038 // Creates the initial ThreadGroup
1039 static Handle create_initial_thread_group(TRAPS) {
1040   Handle system_instance = JavaCalls::construct_new_instance(
1041                             SystemDictionary::ThreadGroup_klass(),
1042                             vmSymbols::void_method_signature(),
1043                             CHECK_NH);
1044   Universe::set_system_thread_group(system_instance());
1045 
1046   Handle string = java_lang_String::create_from_str("main", CHECK_NH);
1047   Handle main_instance = JavaCalls::construct_new_instance(
1048                             SystemDictionary::ThreadGroup_klass(),
1049                             vmSymbols::threadgroup_string_void_signature(),
1050                             system_instance,
1051                             string,
1052                             CHECK_NH);
1053   return main_instance;
1054 }
1055 
1056 // Creates the initial Thread
1057 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1058                                  TRAPS) {
1059   InstanceKlass* ik = SystemDictionary::Thread_klass();
1060   assert(ik-&gt;is_initialized(), "must be");
1061   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1062 
1063   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1064   // constructor calls Thread.current(), which must be set here for the
1065   // initial thread.
1066   java_lang_Thread::set_thread(thread_oop(), thread);
1067   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1068   thread-&gt;set_threadObj(thread_oop());
1069 
1070   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
1071 
1072   JavaValue result(T_VOID);
1073   JavaCalls::call_special(&amp;result, thread_oop,
1074                           ik,
1075                           vmSymbols::object_initializer_name(),
1076                           vmSymbols::threadgroup_string_void_signature(),
1077                           thread_group,
1078                           string,
1079                           CHECK_NULL);
1080   return thread_oop();
1081 }
1082 
1083 char java_runtime_name[128] = "";
1084 char java_runtime_version[128] = "";
1085 
1086 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1087 static const char* get_java_runtime_name(TRAPS) {
1088   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1089                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1090   fieldDescriptor fd;
1091   bool found = k != NULL &amp;&amp;
1092                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1093                                                         vmSymbols::string_signature(), &amp;fd);
1094   if (found) {
1095     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1096     if (name_oop == NULL) {
1097       return NULL;
1098     }
1099     const char* name = java_lang_String::as_utf8_string(name_oop,
1100                                                         java_runtime_name,
1101                                                         sizeof(java_runtime_name));
1102     return name;
1103   } else {
1104     return NULL;
1105   }
1106 }
1107 
1108 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1109 static const char* get_java_runtime_version(TRAPS) {
1110   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1111                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1112   fieldDescriptor fd;
1113   bool found = k != NULL &amp;&amp;
1114                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1115                                                         vmSymbols::string_signature(), &amp;fd);
1116   if (found) {
1117     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1118     if (name_oop == NULL) {
1119       return NULL;
1120     }
1121     const char* name = java_lang_String::as_utf8_string(name_oop,
1122                                                         java_runtime_version,
1123                                                         sizeof(java_runtime_version));
1124     return name;
1125   } else {
1126     return NULL;
1127   }
1128 }
1129 
1130 // General purpose hook into Java code, run once when the VM is initialized.
1131 // The Java library method itself may be changed independently from the VM.
1132 static void call_postVMInitHook(TRAPS) {
1133   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1134   if (klass != NULL) {
1135     JavaValue result(T_VOID);
1136     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1137                            vmSymbols::void_method_signature(),
1138                            CHECK);
1139   }
1140 }
1141 
1142 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1143                                     bool daemon, TRAPS) {
1144   assert(thread_group.not_null(), "thread group should be specified");
1145   assert(threadObj() == NULL, "should only create Java thread object once");
1146 
1147   InstanceKlass* ik = SystemDictionary::Thread_klass();
1148   assert(ik-&gt;is_initialized(), "must be");
1149   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1150 
1151   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1152   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1153   // constructor calls Thread.current(), which must be set here.
1154   java_lang_Thread::set_thread(thread_oop(), this);
1155   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1156   set_threadObj(thread_oop());
1157 
1158   JavaValue result(T_VOID);
1159   if (thread_name != NULL) {
1160     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1161     // Thread gets assigned specified name and null target
1162     JavaCalls::call_special(&amp;result,
1163                             thread_oop,
1164                             ik,
1165                             vmSymbols::object_initializer_name(),
1166                             vmSymbols::threadgroup_string_void_signature(),
1167                             thread_group,
1168                             name,
1169                             THREAD);
1170   } else {
1171     // Thread gets assigned name "Thread-nnn" and null target
1172     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1173     JavaCalls::call_special(&amp;result,
1174                             thread_oop,
1175                             ik,
1176                             vmSymbols::object_initializer_name(),
1177                             vmSymbols::threadgroup_runnable_void_signature(),
1178                             thread_group,
1179                             Handle(),
1180                             THREAD);
1181   }
1182 
1183 
1184   if (daemon) {
1185     java_lang_Thread::set_daemon(thread_oop());
1186   }
1187 
1188   if (HAS_PENDING_EXCEPTION) {
1189     return;
1190   }
1191 
1192   Klass* group =  SystemDictionary::ThreadGroup_klass();
1193   Handle threadObj(THREAD, this-&gt;threadObj());
1194 
1195   JavaCalls::call_special(&amp;result,
1196                           thread_group,
1197                           group,
1198                           vmSymbols::add_method_name(),
1199                           vmSymbols::thread_void_signature(),
1200                           threadObj,          // Arg 1
1201                           THREAD);
1202 }
1203 
1204 // List of all NonJavaThreads and safe iteration over that list.
1205 
1206 class NonJavaThread::List {
1207 public:
1208   NonJavaThread* volatile _head;
1209   SingleWriterSynchronizer _protect;
1210 
1211   List() : _head(NULL), _protect() {}
1212 };
1213 
1214 NonJavaThread::List NonJavaThread::_the_list;
1215 
1216 NonJavaThread::Iterator::Iterator() :
1217   _protect_enter(_the_list._protect.enter()),
1218   _current(OrderAccess::load_acquire(&amp;_the_list._head))
1219 {}
1220 
1221 NonJavaThread::Iterator::~Iterator() {
1222   _the_list._protect.exit(_protect_enter);
1223 }
1224 
1225 void NonJavaThread::Iterator::step() {
1226   assert(!end(), "precondition");
1227   _current = OrderAccess::load_acquire(&amp;_current-&gt;_next);
1228 }
1229 
1230 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1231   // Add this thread to _the_list.
1232   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1233   _next = _the_list._head;
1234   OrderAccess::release_store(&amp;_the_list._head, this);
1235 }
1236 
1237 NonJavaThread::~NonJavaThread() {
1238   // Remove this thread from _the_list.
1239   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1240   NonJavaThread* volatile* p = &amp;_the_list._head;
1241   for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1242     if (t == this) {
1243       *p = this-&gt;_next;
1244       // Wait for any in-progress iterators.
1245       _the_list._protect.synchronize();
1246       break;
1247     }
1248   }
1249 }
1250 
1251 // NamedThread --  non-JavaThread subclasses with multiple
1252 // uniquely named instances should derive from this.
1253 NamedThread::NamedThread() :
1254   NonJavaThread(),
1255   _name(NULL),
1256   _processed_thread(NULL),
1257   _gc_id(GCId::undefined())
1258 {}
1259 
1260 NamedThread::~NamedThread() {
1261   if (_name != NULL) {
1262     FREE_C_HEAP_ARRAY(char, _name);
1263     _name = NULL;
1264   }
1265 }
1266 
1267 void NamedThread::set_name(const char* format, ...) {
1268   guarantee(_name == NULL, "Only get to set name once.");
1269   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1270   guarantee(_name != NULL, "alloc failure");
1271   va_list ap;
1272   va_start(ap, format);
1273   jio_vsnprintf(_name, max_name_len, format, ap);
1274   va_end(ap);
1275 }
1276 
1277 void NamedThread::initialize_named_thread() {
1278   set_native_thread_name(name());
1279 }
1280 
1281 void NamedThread::print_on(outputStream* st) const {
1282   st-&gt;print("\"%s\" ", name());
1283   Thread::print_on(st);
1284   st-&gt;cr();
1285 }
1286 
1287 
1288 // ======= WatcherThread ========
1289 
1290 // The watcher thread exists to simulate timer interrupts.  It should
1291 // be replaced by an abstraction over whatever native support for
1292 // timer interrupts exists on the platform.
1293 
1294 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1295 bool WatcherThread::_startable = false;
1296 volatile bool  WatcherThread::_should_terminate = false;
1297 
1298 WatcherThread::WatcherThread() : NonJavaThread() {
1299   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1300   if (os::create_thread(this, os::watcher_thread)) {
1301     _watcher_thread = this;
1302 
1303     // Set the watcher thread to the highest OS priority which should not be
1304     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1305     // is created. The only normal thread using this priority is the reference
1306     // handler thread, which runs for very short intervals only.
1307     // If the VMThread's priority is not lower than the WatcherThread profiling
1308     // will be inaccurate.
1309     os::set_priority(this, MaxPriority);
1310     if (!DisableStartThread) {
1311       os::start_thread(this);
1312     }
1313   }
1314 }
1315 
1316 int WatcherThread::sleep() const {
1317   // The WatcherThread does not participate in the safepoint protocol
1318   // for the PeriodicTask_lock because it is not a JavaThread.
1319   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1320 
1321   if (_should_terminate) {
1322     // check for termination before we do any housekeeping or wait
1323     return 0;  // we did not sleep.
1324   }
1325 
1326   // remaining will be zero if there are no tasks,
1327   // causing the WatcherThread to sleep until a task is
1328   // enrolled
1329   int remaining = PeriodicTask::time_to_wait();
1330   int time_slept = 0;
1331 
1332   // we expect this to timeout - we only ever get unparked when
1333   // we should terminate or when a new task has been enrolled
1334   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1335 
1336   jlong time_before_loop = os::javaTimeNanos();
1337 
1338   while (true) {
1339     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1340                                             remaining);
1341     jlong now = os::javaTimeNanos();
1342 
1343     if (remaining == 0) {
1344       // if we didn't have any tasks we could have waited for a long time
1345       // consider the time_slept zero and reset time_before_loop
1346       time_slept = 0;
1347       time_before_loop = now;
1348     } else {
1349       // need to recalculate since we might have new tasks in _tasks
1350       time_slept = (int) ((now - time_before_loop) / 1000000);
1351     }
1352 
1353     // Change to task list or spurious wakeup of some kind
1354     if (timedout || _should_terminate) {
1355       break;
1356     }
1357 
1358     remaining = PeriodicTask::time_to_wait();
1359     if (remaining == 0) {
1360       // Last task was just disenrolled so loop around and wait until
1361       // another task gets enrolled
1362       continue;
1363     }
1364 
1365     remaining -= time_slept;
1366     if (remaining &lt;= 0) {
1367       break;
1368     }
1369   }
1370 
1371   return time_slept;
1372 }
1373 
1374 void WatcherThread::run() {
1375   assert(this == watcher_thread(), "just checking");
1376 
1377   this-&gt;record_stack_base_and_size();
1378   this-&gt;set_native_thread_name(this-&gt;name());
1379   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1380   while (true) {
1381     assert(watcher_thread() == Thread::current(), "thread consistency check");
1382     assert(watcher_thread() == this, "thread consistency check");
1383 
1384     // Calculate how long it'll be until the next PeriodicTask work
1385     // should be done, and sleep that amount of time.
1386     int time_waited = sleep();
1387 
1388     if (VMError::is_error_reported()) {
1389       // A fatal error has happened, the error handler(VMError::report_and_die)
1390       // should abort JVM after creating an error log file. However in some
1391       // rare cases, the error handler itself might deadlock. Here periodically
1392       // check for error reporting timeouts, and if it happens, just proceed to
1393       // abort the VM.
1394 
1395       // This code is in WatcherThread because WatcherThread wakes up
1396       // periodically so the fatal error handler doesn't need to do anything;
1397       // also because the WatcherThread is less likely to crash than other
1398       // threads.
1399 
1400       for (;;) {
1401         // Note: we use naked sleep in this loop because we want to avoid using
1402         // any kind of VM infrastructure which may be broken at this point.
1403         if (VMError::check_timeout()) {
1404           // We hit error reporting timeout. Error reporting was interrupted and
1405           // will be wrapping things up now (closing files etc). Give it some more
1406           // time, then quit the VM.
1407           os::naked_short_sleep(200);
1408           // Print a message to stderr.
1409           fdStream err(defaultStream::output_fd());
1410           err.print_raw_cr("# [ timer expired, abort... ]");
1411           // skip atexit/vm_exit/vm_abort hooks
1412           os::die();
1413         }
1414 
1415         // Wait a second, then recheck for timeout.
1416         os::naked_short_sleep(999);
1417       }
1418     }
1419 
1420     if (_should_terminate) {
1421       // check for termination before posting the next tick
1422       break;
1423     }
1424 
1425     PeriodicTask::real_time_tick(time_waited);
1426   }
1427 
1428   // Signal that it is terminated
1429   {
1430     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1431     _watcher_thread = NULL;
1432     Terminator_lock-&gt;notify();
1433   }
1434 }
1435 
1436 void WatcherThread::start() {
1437   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1438 
1439   if (watcher_thread() == NULL &amp;&amp; _startable) {
1440     _should_terminate = false;
1441     // Create the single instance of WatcherThread
1442     new WatcherThread();
1443   }
1444 }
1445 
1446 void WatcherThread::make_startable() {
1447   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1448   _startable = true;
1449 }
1450 
1451 void WatcherThread::stop() {
1452   {
1453     // Follow normal safepoint aware lock enter protocol since the
1454     // WatcherThread is stopped by another JavaThread.
1455     MutexLocker ml(PeriodicTask_lock);
1456     _should_terminate = true;
1457 
1458     WatcherThread* watcher = watcher_thread();
1459     if (watcher != NULL) {
1460       // unpark the WatcherThread so it can see that it should terminate
1461       watcher-&gt;unpark();
1462     }
1463   }
1464 
1465   MutexLocker mu(Terminator_lock);
1466 
1467   while (watcher_thread() != NULL) {
1468     // This wait should make safepoint checks, wait without a timeout,
1469     // and wait as a suspend-equivalent condition.
1470     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1471                           Mutex::_as_suspend_equivalent_flag);
1472   }
1473 }
1474 
1475 void WatcherThread::unpark() {
1476   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1477   PeriodicTask_lock-&gt;notify();
1478 }
1479 
1480 void WatcherThread::print_on(outputStream* st) const {
1481   st-&gt;print("\"%s\" ", name());
1482   Thread::print_on(st);
1483   st-&gt;cr();
1484 }
1485 
1486 // ======= JavaThread ========
1487 
1488 #if INCLUDE_JVMCI
1489 
1490 jlong* JavaThread::_jvmci_old_thread_counters;
1491 
1492 bool jvmci_counters_include(JavaThread* thread) {
1493   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1494 }
1495 
1496 void JavaThread::collect_counters(typeArrayOop array) {
1497   if (JVMCICounterSize &gt; 0) {
1498     JavaThreadIteratorWithHandle jtiwh;
1499     for (int i = 0; i &lt; array-&gt;length(); i++) {
1500       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1501     }
1502     for (; JavaThread *tp = jtiwh.next(); ) {
1503       if (jvmci_counters_include(tp)) {
1504         for (int i = 0; i &lt; array-&gt;length(); i++) {
1505           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1506         }
1507       }
1508     }
1509   }
1510 }
1511 
1512 #endif // INCLUDE_JVMCI
1513 
1514 // A JavaThread is a normal Java thread
1515 
1516 void JavaThread::initialize() {
1517   // Initialize fields
1518 
1519   set_saved_exception_pc(NULL);
1520   set_threadObj(NULL);
1521   _anchor.clear();
1522   set_entry_point(NULL);
1523   set_jni_functions(jni_functions());
1524   set_callee_target(NULL);
1525   set_vm_result(NULL);
1526   set_vm_result_2(NULL);
1527   set_vframe_array_head(NULL);
1528   set_vframe_array_last(NULL);
1529   set_deferred_locals(NULL);
1530   set_deopt_mark(NULL);
1531   set_deopt_compiled_method(NULL);
1532   clear_must_deopt_id();
1533   set_monitor_chunks(NULL);
1534   set_next(NULL);
1535   _on_thread_list = false;
1536   set_thread_state(_thread_new);
1537   _terminated = _not_terminated;
1538   _privileged_stack_top = NULL;
1539   _array_for_gc = NULL;
1540   _suspend_equivalent = false;
1541   _in_deopt_handler = 0;
1542   _doing_unsafe_access = false;
1543   _stack_guard_state = stack_guard_unused;
1544 #if INCLUDE_JVMCI
1545   _pending_monitorenter = false;
1546   _pending_deoptimization = -1;
1547   _pending_failed_speculation = 0;
1548   _pending_transfer_to_interpreter = false;
1549   _adjusting_comp_level = false;
1550   _in_retryable_allocation = false;
1551   _jvmci._alternate_call_target = NULL;
1552   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1553   if (JVMCICounterSize &gt; 0) {
1554     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1555     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1556   } else {
1557     _jvmci_counters = NULL;
1558   }
1559 #endif // INCLUDE_JVMCI
1560   _reserved_stack_activation = NULL;  // stack base not known yet
1561   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1562   _exception_pc  = 0;
1563   _exception_handler_pc = 0;
1564   _is_method_handle_return = 0;
1565   _jvmti_thread_state= NULL;
1566   _should_post_on_exceptions_flag = JNI_FALSE;
1567   _interp_only_mode    = 0;
1568   _special_runtime_exit_condition = _no_async_condition;
1569   _pending_async_exception = NULL;
1570   _thread_stat = NULL;
1571   _thread_stat = new ThreadStatistics();
1572   _blocked_on_compilation = false;
1573   _jni_active_critical = 0;
1574   _pending_jni_exception_check_fn = NULL;
1575   _do_not_unlock_if_synchronized = false;
1576   _cached_monitor_info = NULL;
1577   _parker = Parker::Allocate(this);
1578 
1579 #ifndef PRODUCT
1580   _jmp_ring_index = 0;
1581   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1582     record_jump(NULL, NULL, NULL, 0);
1583   }
1584 #endif // PRODUCT
1585 
1586   // Setup safepoint state info for this thread
1587   ThreadSafepointState::create(this);
1588 
1589   debug_only(_java_call_counter = 0);
1590 
1591   // JVMTI PopFrame support
1592   _popframe_condition = popframe_inactive;
1593   _popframe_preserved_args = NULL;
1594   _popframe_preserved_args_size = 0;
1595   _frames_to_pop_failed_realloc = 0;
1596 
1597   if (SafepointMechanism::uses_thread_local_poll()) {
1598     SafepointMechanism::initialize_header(this);
1599   }
1600 
1601   pd_initialize();
1602 }
1603 
1604 JavaThread::JavaThread(bool is_attaching_via_jni) :
1605                        Thread() {
1606   initialize();
1607   if (is_attaching_via_jni) {
1608     _jni_attach_state = _attaching_via_jni;
1609   } else {
1610     _jni_attach_state = _not_attaching_via_jni;
1611   }
1612   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1613 }
1614 
1615 bool JavaThread::reguard_stack(address cur_sp) {
1616   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1617       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1618     return true; // Stack already guarded or guard pages not needed.
1619   }
1620 
1621   if (register_stack_overflow()) {
1622     // For those architectures which have separate register and
1623     // memory stacks, we must check the register stack to see if
1624     // it has overflowed.
1625     return false;
1626   }
1627 
1628   // Java code never executes within the yellow zone: the latter is only
1629   // there to provoke an exception during stack banging.  If java code
1630   // is executing there, either StackShadowPages should be larger, or
1631   // some exception code in c1, c2 or the interpreter isn't unwinding
1632   // when it should.
1633   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1634             "not enough space to reguard - increase StackShadowPages");
1635   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1636     enable_stack_yellow_reserved_zone();
1637     if (reserved_stack_activation() != stack_base()) {
1638       set_reserved_stack_activation(stack_base());
1639     }
1640   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1641     set_reserved_stack_activation(stack_base());
1642     enable_stack_reserved_zone();
1643   }
1644   return true;
1645 }
1646 
1647 bool JavaThread::reguard_stack(void) {
1648   return reguard_stack(os::current_stack_pointer());
1649 }
1650 
1651 
1652 void JavaThread::block_if_vm_exited() {
1653   if (_terminated == _vm_exited) {
1654     // _vm_exited is set at safepoint, and Threads_lock is never released
1655     // we will block here forever
1656     Threads_lock-&gt;lock_without_safepoint_check();
1657     ShouldNotReachHere();
1658   }
1659 }
1660 
1661 
1662 // Remove this ifdef when C1 is ported to the compiler interface.
1663 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1664 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1665 
1666 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1667                        Thread() {
1668   initialize();
1669   _jni_attach_state = _not_attaching_via_jni;
1670   set_entry_point(entry_point);
1671   // Create the native thread itself.
1672   // %note runtime_23
1673   os::ThreadType thr_type = os::java_thread;
1674   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1675                                                      os::java_thread;
1676   os::create_thread(this, thr_type, stack_sz);
1677   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1678   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1679   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1680   // the exception consists of creating the exception object &amp; initializing it, initialization
1681   // will leave the VM via a JavaCall and then all locks must be unlocked).
1682   //
1683   // The thread is still suspended when we reach here. Thread must be explicit started
1684   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1685   // by calling Threads:add. The reason why this is not done here, is because the thread
1686   // object must be fully initialized (take a look at JVM_Start)
1687 }
1688 
1689 JavaThread::~JavaThread() {
1690 
1691   // JSR166 -- return the parker to the free list
1692   Parker::Release(_parker);
1693   _parker = NULL;
1694 
1695   // Free any remaining  previous UnrollBlock
1696   vframeArray* old_array = vframe_array_last();
1697 
1698   if (old_array != NULL) {
1699     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1700     old_array-&gt;set_unroll_block(NULL);
1701     delete old_info;
1702     delete old_array;
1703   }
1704 
1705   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1706   if (deferred != NULL) {
1707     // This can only happen if thread is destroyed before deoptimization occurs.
1708     assert(deferred-&gt;length() != 0, "empty array!");
1709     do {
1710       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1711       deferred-&gt;remove_at(0);
1712       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1713       delete dlv;
1714     } while (deferred-&gt;length() != 0);
1715     delete deferred;
1716   }
1717 
1718   // All Java related clean up happens in exit
1719   ThreadSafepointState::destroy(this);
1720   if (_thread_stat != NULL) delete _thread_stat;
1721 
1722 #if INCLUDE_JVMCI
1723   if (JVMCICounterSize &gt; 0) {
1724     if (jvmci_counters_include(this)) {
1725       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1726         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1727       }
1728     }
1729     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1730   }
1731 #endif // INCLUDE_JVMCI
1732 }
1733 
1734 
1735 // The first routine called by a new Java thread
1736 void JavaThread::run() {
1737   // initialize thread-local alloc buffer related fields
1738   this-&gt;initialize_tlab();
1739 
1740   // used to test validity of stack trace backs
1741   this-&gt;record_base_of_stack_pointer();
1742 
1743   // Record real stack base and size.
1744   this-&gt;record_stack_base_and_size();
1745 
1746   this-&gt;create_stack_guard_pages();
1747 
1748   this-&gt;cache_global_variables();
1749 
1750   // Thread is now sufficient initialized to be handled by the safepoint code as being
1751   // in the VM. Change thread state from _thread_new to _thread_in_vm
1752   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1753 
1754   assert(JavaThread::current() == this, "sanity check");
1755   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1756 
1757   DTRACE_THREAD_PROBE(start, this);
1758 
1759   // This operation might block. We call that after all safepoint checks for a new thread has
1760   // been completed.
1761   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1762 
1763   if (JvmtiExport::should_post_thread_life()) {
1764     JvmtiExport::post_thread_start(this);
1765   }
1766 
1767   EventThreadStart event;
1768   if (event.should_commit()) {
1769     event.set_thread(JFR_THREAD_ID(this));
1770     event.commit();
1771   }
1772 
1773   // We call another function to do the rest so we are sure that the stack addresses used
1774   // from there will be lower than the stack base just computed
1775   thread_main_inner();
1776 
1777   // Note, thread is no longer valid at this point!
1778 }
1779 
1780 
1781 void JavaThread::thread_main_inner() {
1782   assert(JavaThread::current() == this, "sanity check");
1783   assert(this-&gt;threadObj() != NULL, "just checking");
1784 
1785   // Execute thread entry point unless this thread has a pending exception
1786   // or has been stopped before starting.
1787   // Note: Due to JVM_StopThread we can have pending exceptions already!
1788   if (!this-&gt;has_pending_exception() &amp;&amp;
1789       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1790     {
1791       ResourceMark rm(this);
1792       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1793     }
1794     HandleMark hm(this);
1795     this-&gt;entry_point()(this, this);
1796   }
1797 
1798   DTRACE_THREAD_PROBE(stop, this);
1799 
1800   this-&gt;exit(false);
1801   this-&gt;smr_delete();
1802 }
1803 
1804 
1805 static void ensure_join(JavaThread* thread) {
1806   // We do not need to grab the Threads_lock, since we are operating on ourself.
1807   Handle threadObj(thread, thread-&gt;threadObj());
1808   assert(threadObj.not_null(), "java thread object must exist");
1809   ObjectLocker lock(threadObj, thread);
1810   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1811   thread-&gt;clear_pending_exception();
1812   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1813   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1814   // Clear the native thread instance - this makes isAlive return false and allows the join()
1815   // to complete once we've done the notify_all below
1816   java_lang_Thread::set_thread(threadObj(), NULL);
1817   lock.notify_all(thread);
1818   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1819   thread-&gt;clear_pending_exception();
1820 }
1821 
1822 
1823 // For any new cleanup additions, please check to see if they need to be applied to
1824 // cleanup_failed_attach_current_thread as well.
1825 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1826   assert(this == JavaThread::current(), "thread consistency check");
1827 
1828   elapsedTimer _timer_exit_phase1;
1829   elapsedTimer _timer_exit_phase2;
1830   elapsedTimer _timer_exit_phase3;
1831   elapsedTimer _timer_exit_phase4;
1832 
1833   if (log_is_enabled(Debug, os, thread, timer)) {
1834     _timer_exit_phase1.start();
1835   }
1836 
1837   HandleMark hm(this);
1838   Handle uncaught_exception(this, this-&gt;pending_exception());
1839   this-&gt;clear_pending_exception();
1840   Handle threadObj(this, this-&gt;threadObj());
1841   assert(threadObj.not_null(), "Java thread object should be created");
1842 
1843   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1844   {
1845     EXCEPTION_MARK;
1846 
1847     CLEAR_PENDING_EXCEPTION;
1848   }
1849   if (!destroy_vm) {
1850     if (uncaught_exception.not_null()) {
1851       EXCEPTION_MARK;
1852       // Call method Thread.dispatchUncaughtException().
1853       Klass* thread_klass = SystemDictionary::Thread_klass();
1854       JavaValue result(T_VOID);
1855       JavaCalls::call_virtual(&amp;result,
1856                               threadObj, thread_klass,
1857                               vmSymbols::dispatchUncaughtException_name(),
1858                               vmSymbols::throwable_void_signature(),
1859                               uncaught_exception,
1860                               THREAD);
1861       if (HAS_PENDING_EXCEPTION) {
1862         ResourceMark rm(this);
1863         jio_fprintf(defaultStream::error_stream(),
1864                     "\nException: %s thrown from the UncaughtExceptionHandler"
1865                     " in thread \"%s\"\n",
1866                     pending_exception()-&gt;klass()-&gt;external_name(),
1867                     get_thread_name());
1868         CLEAR_PENDING_EXCEPTION;
1869       }
1870     }
1871 
1872     // Called before the java thread exit since we want to read info
1873     // from java_lang_Thread object
1874     EventThreadEnd event;
1875     if (event.should_commit()) {
1876       event.set_thread(JFR_THREAD_ID(this));
1877       event.commit();
1878     }
1879 
1880     // Call after last event on thread
1881     JFR_ONLY(Jfr::on_thread_exit(this);)
1882 
1883     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1884     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1885     // is deprecated anyhow.
1886     if (!is_Compiler_thread()) {
1887       int count = 3;
1888       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1889         EXCEPTION_MARK;
1890         JavaValue result(T_VOID);
1891         Klass* thread_klass = SystemDictionary::Thread_klass();
1892         JavaCalls::call_virtual(&amp;result,
1893                                 threadObj, thread_klass,
1894                                 vmSymbols::exit_method_name(),
1895                                 vmSymbols::void_method_signature(),
1896                                 THREAD);
1897         CLEAR_PENDING_EXCEPTION;
1898       }
1899     }
1900     // notify JVMTI
1901     if (JvmtiExport::should_post_thread_life()) {
1902       JvmtiExport::post_thread_end(this);
1903     }
1904 
1905     // We have notified the agents that we are exiting, before we go on,
1906     // we must check for a pending external suspend request and honor it
1907     // in order to not surprise the thread that made the suspend request.
1908     while (true) {
1909       {
1910         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1911         if (!is_external_suspend()) {
1912           set_terminated(_thread_exiting);
1913           ThreadService::current_thread_exiting(this);
1914           break;
1915         }
1916         // Implied else:
1917         // Things get a little tricky here. We have a pending external
1918         // suspend request, but we are holding the SR_lock so we
1919         // can't just self-suspend. So we temporarily drop the lock
1920         // and then self-suspend.
1921       }
1922 
1923       ThreadBlockInVM tbivm(this);
1924       java_suspend_self();
1925 
1926       // We're done with this suspend request, but we have to loop around
1927       // and check again. Eventually we will get SR_lock without a pending
1928       // external suspend request and will be able to mark ourselves as
1929       // exiting.
1930     }
1931     // no more external suspends are allowed at this point
1932   } else {
1933     // before_exit() has already posted JVMTI THREAD_END events
1934   }
1935 
1936   if (log_is_enabled(Debug, os, thread, timer)) {
1937     _timer_exit_phase1.stop();
1938     _timer_exit_phase2.start();
1939   }
1940   // Notify waiters on thread object. This has to be done after exit() is called
1941   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1942   // group should have the destroyed bit set before waiters are notified).
1943   ensure_join(this);
1944   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1945 
1946   if (log_is_enabled(Debug, os, thread, timer)) {
1947     _timer_exit_phase2.stop();
1948     _timer_exit_phase3.start();
1949   }
1950   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1951   // held by this thread must be released. The spec does not distinguish
1952   // between JNI-acquired and regular Java monitors. We can only see
1953   // regular Java monitors here if monitor enter-exit matching is broken.
1954   //
1955   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1956   // ObjectSynchronizer::release_monitors_owned_by_thread().
1957   if (exit_type == jni_detach) {
1958     // Sanity check even though JNI DetachCurrentThread() would have
1959     // returned JNI_ERR if there was a Java frame. JavaThread exit
1960     // should be done executing Java code by the time we get here.
1961     assert(!this-&gt;has_last_Java_frame(),
1962            "should not have a Java frame when detaching or exiting");
1963     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1964     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1965   }
1966 
1967   // These things needs to be done while we are still a Java Thread. Make sure that thread
1968   // is in a consistent state, in case GC happens
1969   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1970 
1971   if (active_handles() != NULL) {
1972     JNIHandleBlock* block = active_handles();
1973     set_active_handles(NULL);
1974     JNIHandleBlock::release_block(block);
1975   }
1976 
1977   if (free_handle_block() != NULL) {
1978     JNIHandleBlock* block = free_handle_block();
1979     set_free_handle_block(NULL);
1980     JNIHandleBlock::release_block(block);
1981   }
1982 
1983   // These have to be removed while this is still a valid thread.
1984   remove_stack_guard_pages();
1985 
1986   if (UseTLAB) {
1987     tlab().retire();
1988   }
1989 
1990   if (JvmtiEnv::environments_might_exist()) {
1991     JvmtiExport::cleanup_thread(this);
1992   }
1993 
1994   // We must flush any deferred card marks and other various GC barrier
1995   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
1996   // before removing a thread from the list of active threads.
1997   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
1998 
1999   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
2000     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
2001     os::current_thread_id());
2002 
2003   if (log_is_enabled(Debug, os, thread, timer)) {
2004     _timer_exit_phase3.stop();
2005     _timer_exit_phase4.start();
2006   }
2007   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2008   Threads::remove(this);
2009 
2010   if (log_is_enabled(Debug, os, thread, timer)) {
2011     _timer_exit_phase4.stop();
2012     ResourceMark rm(this);
2013     log_debug(os, thread, timer)("name='%s'"
2014                                  ", exit-phase1=" JLONG_FORMAT
2015                                  ", exit-phase2=" JLONG_FORMAT
2016                                  ", exit-phase3=" JLONG_FORMAT
2017                                  ", exit-phase4=" JLONG_FORMAT,
2018                                  get_thread_name(),
2019                                  _timer_exit_phase1.milliseconds(),
2020                                  _timer_exit_phase2.milliseconds(),
2021                                  _timer_exit_phase3.milliseconds(),
2022                                  _timer_exit_phase4.milliseconds());
2023   }
2024 }
2025 
2026 void JavaThread::cleanup_failed_attach_current_thread() {
2027   if (active_handles() != NULL) {
2028     JNIHandleBlock* block = active_handles();
2029     set_active_handles(NULL);
2030     JNIHandleBlock::release_block(block);
2031   }
2032 
2033   if (free_handle_block() != NULL) {
2034     JNIHandleBlock* block = free_handle_block();
2035     set_free_handle_block(NULL);
2036     JNIHandleBlock::release_block(block);
2037   }
2038 
2039   // These have to be removed while this is still a valid thread.
2040   remove_stack_guard_pages();
2041 
2042   if (UseTLAB) {
2043     tlab().retire();
2044   }
2045 
2046   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2047 
2048   Threads::remove(this);
2049   this-&gt;smr_delete();
2050 }
2051 
2052 JavaThread* JavaThread::active() {
2053   Thread* thread = Thread::current();
2054   if (thread-&gt;is_Java_thread()) {
2055     return (JavaThread*) thread;
2056   } else {
2057     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2058     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2059     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2060     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2061     return ret;
2062   }
2063 }
2064 
2065 bool JavaThread::is_lock_owned(address adr) const {
2066   if (Thread::is_lock_owned(adr)) return true;
2067 
2068   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2069     if (chunk-&gt;contains(adr)) return true;
2070   }
2071 
2072   return false;
2073 }
2074 
2075 
2076 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2077   chunk-&gt;set_next(monitor_chunks());
2078   set_monitor_chunks(chunk);
2079 }
2080 
2081 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2082   guarantee(monitor_chunks() != NULL, "must be non empty");
2083   if (monitor_chunks() == chunk) {
2084     set_monitor_chunks(chunk-&gt;next());
2085   } else {
2086     MonitorChunk* prev = monitor_chunks();
2087     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2088     prev-&gt;set_next(chunk-&gt;next());
2089   }
2090 }
2091 
2092 // JVM support.
2093 
2094 // Note: this function shouldn't block if it's called in
2095 // _thread_in_native_trans state (such as from
2096 // check_special_condition_for_native_trans()).
2097 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2098 
2099   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2100     // If we are at a polling page safepoint (not a poll return)
2101     // then we must defer async exception because live registers
2102     // will be clobbered by the exception path. Poll return is
2103     // ok because the call we a returning from already collides
2104     // with exception handling registers and so there is no issue.
2105     // (The exception handling path kills call result registers but
2106     //  this is ok since the exception kills the result anyway).
2107 
2108     if (is_at_poll_safepoint()) {
2109       // if the code we are returning to has deoptimized we must defer
2110       // the exception otherwise live registers get clobbered on the
2111       // exception path before deoptimization is able to retrieve them.
2112       //
2113       RegisterMap map(this, false);
2114       frame caller_fr = last_frame().sender(&amp;map);
2115       assert(caller_fr.is_compiled_frame(), "what?");
2116       if (caller_fr.is_deoptimized_frame()) {
2117         log_info(exceptions)("deferred async exception at compiled safepoint");
2118         return;
2119       }
2120     }
2121   }
2122 
2123   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2124   if (condition == _no_async_condition) {
2125     // Conditions have changed since has_special_runtime_exit_condition()
2126     // was called:
2127     // - if we were here only because of an external suspend request,
2128     //   then that was taken care of above (or cancelled) so we are done
2129     // - if we were here because of another async request, then it has
2130     //   been cleared between the has_special_runtime_exit_condition()
2131     //   and now so again we are done
2132     return;
2133   }
2134 
2135   // Check for pending async. exception
2136   if (_pending_async_exception != NULL) {
2137     // Only overwrite an already pending exception, if it is not a threadDeath.
2138     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2139 
2140       // We cannot call Exceptions::_throw(...) here because we cannot block
2141       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2142 
2143       LogTarget(Info, exceptions) lt;
2144       if (lt.is_enabled()) {
2145         ResourceMark rm;
2146         LogStream ls(lt);
2147         ls.print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2148           if (has_last_Java_frame()) {
2149             frame f = last_frame();
2150            ls.print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2151           }
2152         ls.print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2153       }
2154       _pending_async_exception = NULL;
2155       clear_has_async_exception();
2156     }
2157   }
2158 
2159   if (check_unsafe_error &amp;&amp;
2160       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2161     condition = _no_async_condition;  // done
2162     switch (thread_state()) {
2163     case _thread_in_vm: {
2164       JavaThread* THREAD = this;
2165       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2166     }
2167     case _thread_in_native: {
2168       ThreadInVMfromNative tiv(this);
2169       JavaThread* THREAD = this;
2170       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2171     }
2172     case _thread_in_Java: {
2173       ThreadInVMfromJava tiv(this);
2174       JavaThread* THREAD = this;
2175       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2176     }
2177     default:
2178       ShouldNotReachHere();
2179     }
2180   }
2181 
2182   assert(condition == _no_async_condition || has_pending_exception() ||
2183          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2184          "must have handled the async condition, if no exception");
2185 }
2186 
2187 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2188   //
2189   // Check for pending external suspend. Internal suspend requests do
2190   // not use handle_special_runtime_exit_condition().
2191   // If JNIEnv proxies are allowed, don't self-suspend if the target
2192   // thread is not the current thread. In older versions of jdbx, jdbx
2193   // threads could call into the VM with another thread's JNIEnv so we
2194   // can be here operating on behalf of a suspended thread (4432884).
2195   bool do_self_suspend = is_external_suspend_with_lock();
2196   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2197     //
2198     // Because thread is external suspended the safepoint code will count
2199     // thread as at a safepoint. This can be odd because we can be here
2200     // as _thread_in_Java which would normally transition to _thread_blocked
2201     // at a safepoint. We would like to mark the thread as _thread_blocked
2202     // before calling java_suspend_self like all other callers of it but
2203     // we must then observe proper safepoint protocol. (We can't leave
2204     // _thread_blocked with a safepoint in progress). However we can be
2205     // here as _thread_in_native_trans so we can't use a normal transition
2206     // constructor/destructor pair because they assert on that type of
2207     // transition. We could do something like:
2208     //
2209     // JavaThreadState state = thread_state();
2210     // set_thread_state(_thread_in_vm);
2211     // {
2212     //   ThreadBlockInVM tbivm(this);
2213     //   java_suspend_self()
2214     // }
2215     // set_thread_state(_thread_in_vm_trans);
2216     // if (safepoint) block;
2217     // set_thread_state(state);
2218     //
2219     // but that is pretty messy. Instead we just go with the way the
2220     // code has worked before and note that this is the only path to
2221     // java_suspend_self that doesn't put the thread in _thread_blocked
2222     // mode.
2223 
2224     frame_anchor()-&gt;make_walkable(this);
2225     java_suspend_self();
2226 
2227     // We might be here for reasons in addition to the self-suspend request
2228     // so check for other async requests.
2229   }
2230 
2231   if (check_asyncs) {
2232     check_and_handle_async_exceptions();
2233   }
2234 
2235   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2236 }
2237 
2238 void JavaThread::send_thread_stop(oop java_throwable)  {
2239   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2240   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2241   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2242 
2243   // Do not throw asynchronous exceptions against the compiler thread
2244   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2245   if (!can_call_java()) return;
2246 
2247   {
2248     // Actually throw the Throwable against the target Thread - however
2249     // only if there is no thread death exception installed already.
2250     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2251       // If the topmost frame is a runtime stub, then we are calling into
2252       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2253       // must deoptimize the caller before continuing, as the compiled  exception handler table
2254       // may not be valid
2255       if (has_last_Java_frame()) {
2256         frame f = last_frame();
2257         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2258           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2259           RegisterMap reg_map(this, UseBiasedLocking);
2260           frame compiled_frame = f.sender(&amp;reg_map);
2261           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2262             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2263           }
2264         }
2265       }
2266 
2267       // Set async. pending exception in thread.
2268       set_pending_async_exception(java_throwable);
2269 
2270       if (log_is_enabled(Info, exceptions)) {
2271          ResourceMark rm;
2272         log_info(exceptions)("Pending Async. exception installed of type: %s",
2273                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2274       }
2275       // for AbortVMOnException flag
2276       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2277     }
2278   }
2279 
2280 
2281   // Interrupt thread so it will wake up from a potential wait()
2282   Thread::interrupt(this);
2283 }
2284 
2285 // External suspension mechanism.
2286 //
2287 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2288 // to any VM_locks and it is at a transition
2289 // Self-suspension will happen on the transition out of the vm.
2290 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2291 //
2292 // Guarantees on return:
2293 //   + Target thread will not execute any new bytecode (that's why we need to
2294 //     force a safepoint)
2295 //   + Target thread will not enter any new monitors
2296 //
2297 void JavaThread::java_suspend() {
2298   ThreadsListHandle tlh;
2299   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2300     return;
2301   }
2302 
2303   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2304     if (!is_external_suspend()) {
2305       // a racing resume has cancelled us; bail out now
2306       return;
2307     }
2308 
2309     // suspend is done
2310     uint32_t debug_bits = 0;
2311     // Warning: is_ext_suspend_completed() may temporarily drop the
2312     // SR_lock to allow the thread to reach a stable thread state if
2313     // it is currently in a transient thread state.
2314     if (is_ext_suspend_completed(false /* !called_by_wait */,
2315                                  SuspendRetryDelay, &amp;debug_bits)) {
2316       return;
2317     }
2318   }
2319 
2320   VM_ThreadSuspend vm_suspend;
2321   VMThread::execute(&amp;vm_suspend);
2322 }
2323 
2324 // Part II of external suspension.
2325 // A JavaThread self suspends when it detects a pending external suspend
2326 // request. This is usually on transitions. It is also done in places
2327 // where continuing to the next transition would surprise the caller,
2328 // e.g., monitor entry.
2329 //
2330 // Returns the number of times that the thread self-suspended.
2331 //
2332 // Note: DO NOT call java_suspend_self() when you just want to block current
2333 //       thread. java_suspend_self() is the second stage of cooperative
2334 //       suspension for external suspend requests and should only be used
2335 //       to complete an external suspend request.
2336 //
2337 int JavaThread::java_suspend_self() {
2338   int ret = 0;
2339 
2340   // we are in the process of exiting so don't suspend
2341   if (is_exiting()) {
2342     clear_external_suspend();
2343     return ret;
2344   }
2345 
2346   assert(_anchor.walkable() ||
2347          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2348          "must have walkable stack");
2349 
2350   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2351 
2352   assert(!this-&gt;is_ext_suspended(),
2353          "a thread trying to self-suspend should not already be suspended");
2354 
2355   if (this-&gt;is_suspend_equivalent()) {
2356     // If we are self-suspending as a result of the lifting of a
2357     // suspend equivalent condition, then the suspend_equivalent
2358     // flag is not cleared until we set the ext_suspended flag so
2359     // that wait_for_ext_suspend_completion() returns consistent
2360     // results.
2361     this-&gt;clear_suspend_equivalent();
2362   }
2363 
2364   // A racing resume may have cancelled us before we grabbed SR_lock
2365   // above. Or another external suspend request could be waiting for us
2366   // by the time we return from SR_lock()-&gt;wait(). The thread
2367   // that requested the suspension may already be trying to walk our
2368   // stack and if we return now, we can change the stack out from under
2369   // it. This would be a "bad thing (TM)" and cause the stack walker
2370   // to crash. We stay self-suspended until there are no more pending
2371   // external suspend requests.
2372   while (is_external_suspend()) {
2373     ret++;
2374     this-&gt;set_ext_suspended();
2375 
2376     // _ext_suspended flag is cleared by java_resume()
2377     while (is_ext_suspended()) {
2378       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2379     }
2380   }
2381 
2382   return ret;
2383 }
2384 
2385 #ifdef ASSERT
2386 // Verify the JavaThread has not yet been published in the Threads::list, and
2387 // hence doesn't need protection from concurrent access at this stage.
2388 void JavaThread::verify_not_published() {
2389   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2390   // since an unpublished JavaThread doesn't participate in the
2391   // Thread-SMR protocol for keeping a ThreadsList alive.
2392   assert(!on_thread_list(), "JavaThread shouldn't have been published yet!");
2393 }
2394 #endif
2395 
2396 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2397 // progress or when _suspend_flags is non-zero.
2398 // Current thread needs to self-suspend if there is a suspend request and/or
2399 // block if a safepoint is in progress.
2400 // Async exception ISN'T checked.
2401 // Note only the ThreadInVMfromNative transition can call this function
2402 // directly and when thread state is _thread_in_native_trans
2403 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2404   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2405 
2406   JavaThread *curJT = JavaThread::current();
2407   bool do_self_suspend = thread-&gt;is_external_suspend();
2408 
2409   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2410 
2411   // If JNIEnv proxies are allowed, don't self-suspend if the target
2412   // thread is not the current thread. In older versions of jdbx, jdbx
2413   // threads could call into the VM with another thread's JNIEnv so we
2414   // can be here operating on behalf of a suspended thread (4432884).
2415   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2416     JavaThreadState state = thread-&gt;thread_state();
2417 
2418     // We mark this thread_blocked state as a suspend-equivalent so
2419     // that a caller to is_ext_suspend_completed() won't be confused.
2420     // The suspend-equivalent state is cleared by java_suspend_self().
2421     thread-&gt;set_suspend_equivalent();
2422 
2423     // If the safepoint code sees the _thread_in_native_trans state, it will
2424     // wait until the thread changes to other thread state. There is no
2425     // guarantee on how soon we can obtain the SR_lock and complete the
2426     // self-suspend request. It would be a bad idea to let safepoint wait for
2427     // too long. Temporarily change the state to _thread_blocked to
2428     // let the VM thread know that this thread is ready for GC. The problem
2429     // of changing thread state is that safepoint could happen just after
2430     // java_suspend_self() returns after being resumed, and VM thread will
2431     // see the _thread_blocked state. We must check for safepoint
2432     // after restoring the state and make sure we won't leave while a safepoint
2433     // is in progress.
2434     thread-&gt;set_thread_state(_thread_blocked);
2435     thread-&gt;java_suspend_self();
2436     thread-&gt;set_thread_state(state);
2437 
2438     InterfaceSupport::serialize_thread_state_with_handler(thread);
2439   }
2440 
2441   SafepointMechanism::block_if_requested(curJT);
2442 
2443   if (thread-&gt;is_deopt_suspend()) {
2444     thread-&gt;clear_deopt_suspend();
2445     RegisterMap map(thread, false);
2446     frame f = thread-&gt;last_frame();
2447     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2448       f = f.sender(&amp;map);
2449     }
2450     if (f.id() == thread-&gt;must_deopt_id()) {
2451       thread-&gt;clear_must_deopt_id();
2452       f.deoptimize(thread);
2453     } else {
2454       fatal("missed deoptimization!");
2455     }
2456   }
2457 
2458   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2459 }
2460 
2461 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2462 // progress or when _suspend_flags is non-zero.
2463 // Current thread needs to self-suspend if there is a suspend request and/or
2464 // block if a safepoint is in progress.
2465 // Also check for pending async exception (not including unsafe access error).
2466 // Note only the native==&gt;VM/Java barriers can call this function and when
2467 // thread state is _thread_in_native_trans.
2468 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2469   check_safepoint_and_suspend_for_native_trans(thread);
2470 
2471   if (thread-&gt;has_async_exception()) {
2472     // We are in _thread_in_native_trans state, don't handle unsafe
2473     // access error since that may block.
2474     thread-&gt;check_and_handle_async_exceptions(false);
2475   }
2476 }
2477 
2478 // This is a variant of the normal
2479 // check_special_condition_for_native_trans with slightly different
2480 // semantics for use by critical native wrappers.  It does all the
2481 // normal checks but also performs the transition back into
2482 // thread_in_Java state.  This is required so that critical natives
2483 // can potentially block and perform a GC if they are the last thread
2484 // exiting the GCLocker.
2485 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2486   check_special_condition_for_native_trans(thread);
2487 
2488   // Finish the transition
2489   thread-&gt;set_thread_state(_thread_in_Java);
2490 
2491   if (thread-&gt;do_critical_native_unlock()) {
2492     ThreadInVMfromJavaNoAsyncException tiv(thread);
2493     GCLocker::unlock_critical(thread);
2494     thread-&gt;clear_critical_native_unlock();
2495   }
2496 }
2497 
2498 // We need to guarantee the Threads_lock here, since resumes are not
2499 // allowed during safepoint synchronization
2500 // Can only resume from an external suspension
2501 void JavaThread::java_resume() {
2502   assert_locked_or_safepoint(Threads_lock);
2503 
2504   // Sanity check: thread is gone, has started exiting or the thread
2505   // was not externally suspended.
2506   ThreadsListHandle tlh;
2507   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2508     return;
2509   }
2510 
2511   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2512 
2513   clear_external_suspend();
2514 
2515   if (is_ext_suspended()) {
2516     clear_ext_suspended();
2517     SR_lock()-&gt;notify_all();
2518   }
2519 }
2520 
2521 size_t JavaThread::_stack_red_zone_size = 0;
2522 size_t JavaThread::_stack_yellow_zone_size = 0;
2523 size_t JavaThread::_stack_reserved_zone_size = 0;
2524 size_t JavaThread::_stack_shadow_zone_size = 0;
2525 
2526 void JavaThread::create_stack_guard_pages() {
2527   if (!os::uses_stack_guard_pages() ||
2528       _stack_guard_state != stack_guard_unused ||
2529       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2530       log_info(os, thread)("Stack guard page creation for thread "
2531                            UINTX_FORMAT " disabled", os::current_thread_id());
2532     return;
2533   }
2534   address low_addr = stack_end();
2535   size_t len = stack_guard_zone_size();
2536 
2537   assert(is_aligned(low_addr, os::vm_page_size()), "Stack base should be the start of a page");
2538   assert(is_aligned(len, os::vm_page_size()), "Stack size should be a multiple of page size");
2539 
2540   int must_commit = os::must_commit_stack_guard_pages();
2541   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2542 
2543   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2544     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2545     return;
2546   }
2547 
2548   if (os::guard_memory((char *) low_addr, len)) {
2549     _stack_guard_state = stack_guard_enabled;
2550   } else {
2551     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2552       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2553     if (os::uncommit_memory((char *) low_addr, len)) {
2554       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2555     }
2556     return;
2557   }
2558 
2559   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2560     PTR_FORMAT "-" PTR_FORMAT ".",
2561     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2562 }
2563 
2564 void JavaThread::remove_stack_guard_pages() {
2565   assert(Thread::current() == this, "from different thread");
2566   if (_stack_guard_state == stack_guard_unused) return;
2567   address low_addr = stack_end();
2568   size_t len = stack_guard_zone_size();
2569 
2570   if (os::must_commit_stack_guard_pages()) {
2571     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2572       _stack_guard_state = stack_guard_unused;
2573     } else {
2574       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2575         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2576       return;
2577     }
2578   } else {
2579     if (_stack_guard_state == stack_guard_unused) return;
2580     if (os::unguard_memory((char *) low_addr, len)) {
2581       _stack_guard_state = stack_guard_unused;
2582     } else {
2583       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2584         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2585       return;
2586     }
2587   }
2588 
2589   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2590     PTR_FORMAT "-" PTR_FORMAT ".",
2591     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2592 }
2593 
2594 void JavaThread::enable_stack_reserved_zone() {
2595   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2596   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2597 
2598   // The base notation is from the stack's point of view, growing downward.
2599   // We need to adjust it to work correctly with guard_memory()
2600   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2601 
2602   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2603   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2604 
2605   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2606     _stack_guard_state = stack_guard_enabled;
2607   } else {
2608     warning("Attempt to guard stack reserved zone failed.");
2609   }
2610   enable_register_stack_guard();
2611 }
2612 
2613 void JavaThread::disable_stack_reserved_zone() {
2614   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2615   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2616 
2617   // Simply return if called for a thread that does not use guard pages.
2618   if (_stack_guard_state == stack_guard_unused) return;
2619 
2620   // The base notation is from the stack's point of view, growing downward.
2621   // We need to adjust it to work correctly with guard_memory()
2622   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2623 
2624   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2625     _stack_guard_state = stack_guard_reserved_disabled;
2626   } else {
2627     warning("Attempt to unguard stack reserved zone failed.");
2628   }
2629   disable_register_stack_guard();
2630 }
2631 
2632 void JavaThread::enable_stack_yellow_reserved_zone() {
2633   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2634   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2635 
2636   // The base notation is from the stacks point of view, growing downward.
2637   // We need to adjust it to work correctly with guard_memory()
2638   address base = stack_red_zone_base();
2639 
2640   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2641   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2642 
2643   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2644     _stack_guard_state = stack_guard_enabled;
2645   } else {
2646     warning("Attempt to guard stack yellow zone failed.");
2647   }
2648   enable_register_stack_guard();
2649 }
2650 
2651 void JavaThread::disable_stack_yellow_reserved_zone() {
2652   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2653   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2654 
2655   // Simply return if called for a thread that does not use guard pages.
2656   if (_stack_guard_state == stack_guard_unused) return;
2657 
2658   // The base notation is from the stacks point of view, growing downward.
2659   // We need to adjust it to work correctly with guard_memory()
2660   address base = stack_red_zone_base();
2661 
2662   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2663     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2664   } else {
2665     warning("Attempt to unguard stack yellow zone failed.");
2666   }
2667   disable_register_stack_guard();
2668 }
2669 
2670 void JavaThread::enable_stack_red_zone() {
2671   // The base notation is from the stacks point of view, growing downward.
2672   // We need to adjust it to work correctly with guard_memory()
2673   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2674   address base = stack_red_zone_base() - stack_red_zone_size();
2675 
2676   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2677   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2678 
2679   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2680     warning("Attempt to guard stack red zone failed.");
2681   }
2682 }
2683 
2684 void JavaThread::disable_stack_red_zone() {
2685   // The base notation is from the stacks point of view, growing downward.
2686   // We need to adjust it to work correctly with guard_memory()
2687   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2688   address base = stack_red_zone_base() - stack_red_zone_size();
2689   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2690     warning("Attempt to unguard stack red zone failed.");
2691   }
2692 }
2693 
2694 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2695   // ignore is there is no stack
2696   if (!has_last_Java_frame()) return;
2697   // traverse the stack frames. Starts from top frame.
2698   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2699     frame* fr = fst.current();
2700     f(fr, fst.register_map());
2701   }
2702 }
2703 
2704 
2705 #ifndef PRODUCT
2706 // Deoptimization
2707 // Function for testing deoptimization
2708 void JavaThread::deoptimize() {
2709   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2710   StackFrameStream fst(this, UseBiasedLocking);
2711   bool deopt = false;           // Dump stack only if a deopt actually happens.
2712   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2713   // Iterate over all frames in the thread and deoptimize
2714   for (; !fst.is_done(); fst.next()) {
2715     if (fst.current()-&gt;can_be_deoptimized()) {
2716 
2717       if (only_at) {
2718         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2719         // consists of comma or carriage return separated numbers so
2720         // search for the current bci in that string.
2721         address pc = fst.current()-&gt;pc();
2722         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2723         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2724         char buffer[8];
2725         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2726         size_t len = strlen(buffer);
2727         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2728         while (found != NULL) {
2729           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2730               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2731             // Check that the bci found is bracketed by terminators.
2732             break;
2733           }
2734           found = strstr(found + 1, buffer);
2735         }
2736         if (!found) {
2737           continue;
2738         }
2739       }
2740 
2741       if (DebugDeoptimization &amp;&amp; !deopt) {
2742         deopt = true; // One-time only print before deopt
2743         tty-&gt;print_cr("[BEFORE Deoptimization]");
2744         trace_frames();
2745         trace_stack();
2746       }
2747       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2748     }
2749   }
2750 
2751   if (DebugDeoptimization &amp;&amp; deopt) {
2752     tty-&gt;print_cr("[AFTER Deoptimization]");
2753     trace_frames();
2754   }
2755 }
2756 
2757 
2758 // Make zombies
2759 void JavaThread::make_zombies() {
2760   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2761     if (fst.current()-&gt;can_be_deoptimized()) {
2762       // it is a Java nmethod
2763       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2764       nm-&gt;make_not_entrant();
2765     }
2766   }
2767 }
2768 #endif // PRODUCT
2769 
2770 
2771 void JavaThread::deoptimized_wrt_marked_nmethods() {
2772   if (!has_last_Java_frame()) return;
2773   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2774   StackFrameStream fst(this, UseBiasedLocking);
2775   for (; !fst.is_done(); fst.next()) {
2776     if (fst.current()-&gt;should_be_deoptimized()) {
2777       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2778     }
2779   }
2780 }
2781 
2782 
2783 // If the caller is a NamedThread, then remember, in the current scope,
2784 // the given JavaThread in its _processed_thread field.
2785 class RememberProcessedThread: public StackObj {
2786   NamedThread* _cur_thr;
2787  public:
2788   RememberProcessedThread(JavaThread* jthr) {
2789     Thread* thread = Thread::current();
2790     if (thread-&gt;is_Named_thread()) {
2791       _cur_thr = (NamedThread *)thread;
2792       _cur_thr-&gt;set_processed_thread(jthr);
2793     } else {
2794       _cur_thr = NULL;
2795     }
2796   }
2797 
2798   ~RememberProcessedThread() {
2799     if (_cur_thr) {
2800       _cur_thr-&gt;set_processed_thread(NULL);
2801     }
2802   }
2803 };
2804 
2805 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2806   // Verify that the deferred card marks have been flushed.
2807   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2808 
2809   // Traverse the GCHandles
2810   Thread::oops_do(f, cf);
2811 
2812   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2813          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2814 
2815   if (has_last_Java_frame()) {
2816     // Record JavaThread to GC thread
2817     RememberProcessedThread rpt(this);
2818 
2819     // Traverse the privileged stack
2820     if (_privileged_stack_top != NULL) {
2821       _privileged_stack_top-&gt;oops_do(f);
2822     }
2823 
2824     // traverse the registered growable array
2825     if (_array_for_gc != NULL) {
2826       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2827         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2828       }
2829     }
2830 
2831     // Traverse the monitor chunks
2832     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2833       chunk-&gt;oops_do(f);
2834     }
2835 
2836     // Traverse the execution stack
2837     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2838       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2839     }
2840   }
2841 
2842   // callee_target is never live across a gc point so NULL it here should
2843   // it still contain a methdOop.
2844 
2845   set_callee_target(NULL);
2846 
2847   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2848   // If we have deferred set_locals there might be oops waiting to be
2849   // written
2850   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2851   if (list != NULL) {
2852     for (int i = 0; i &lt; list-&gt;length(); i++) {
2853       list-&gt;at(i)-&gt;oops_do(f);
2854     }
2855   }
2856 
2857   // Traverse instance variables at the end since the GC may be moving things
2858   // around using this function
2859   f-&gt;do_oop((oop*) &amp;_threadObj);
2860   f-&gt;do_oop((oop*) &amp;_vm_result);
2861   f-&gt;do_oop((oop*) &amp;_exception_oop);
2862   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2863 
2864   if (jvmti_thread_state() != NULL) {
2865     jvmti_thread_state()-&gt;oops_do(f);
2866   }
2867 }
2868 
2869 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2870   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2871          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2872 
2873   if (has_last_Java_frame()) {
2874     // Traverse the execution stack
2875     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2876       fst.current()-&gt;nmethods_do(cf);
2877     }
2878   }
2879 }
2880 
2881 void JavaThread::metadata_do(void f(Metadata*)) {
2882   if (has_last_Java_frame()) {
2883     // Traverse the execution stack to call f() on the methods in the stack
2884     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2885       fst.current()-&gt;metadata_do(f);
2886     }
2887   } else if (is_Compiler_thread()) {
2888     // need to walk ciMetadata in current compile tasks to keep alive.
2889     CompilerThread* ct = (CompilerThread*)this;
2890     if (ct-&gt;env() != NULL) {
2891       ct-&gt;env()-&gt;metadata_do(f);
2892     }
2893     CompileTask* task = ct-&gt;task();
2894     if (task != NULL) {
2895       task-&gt;metadata_do(f);
2896     }
2897   }
2898 }
2899 
2900 // Printing
2901 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2902   switch (_thread_state) {
2903   case _thread_uninitialized:     return "_thread_uninitialized";
2904   case _thread_new:               return "_thread_new";
2905   case _thread_new_trans:         return "_thread_new_trans";
2906   case _thread_in_native:         return "_thread_in_native";
2907   case _thread_in_native_trans:   return "_thread_in_native_trans";
2908   case _thread_in_vm:             return "_thread_in_vm";
2909   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2910   case _thread_in_Java:           return "_thread_in_Java";
2911   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2912   case _thread_blocked:           return "_thread_blocked";
2913   case _thread_blocked_trans:     return "_thread_blocked_trans";
2914   default:                        return "unknown thread state";
2915   }
2916 }
2917 
2918 #ifndef PRODUCT
2919 void JavaThread::print_thread_state_on(outputStream *st) const {
2920   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2921 };
2922 void JavaThread::print_thread_state() const {
2923   print_thread_state_on(tty);
2924 }
2925 #endif // PRODUCT
2926 
2927 // Called by Threads::print() for VM_PrintThreads operation
2928 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
2929   st-&gt;print_raw("\"");
2930   st-&gt;print_raw(get_thread_name());
2931   st-&gt;print_raw("\" ");
2932   oop thread_oop = threadObj();
2933   if (thread_oop != NULL) {
2934     st-&gt;print("#" INT64_FORMAT " ", (int64_t)java_lang_Thread::thread_id(thread_oop));
2935     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2936     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2937   }
2938   Thread::print_on(st, print_extended_info);
2939   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2940   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2941   if (thread_oop != NULL) {
2942     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2943   }
2944 #ifndef PRODUCT
2945   print_thread_state_on(st);
2946   _safepoint_state-&gt;print_on(st);
2947 #endif // PRODUCT
2948   if (is_Compiler_thread()) {
2949     CompileTask *task = ((CompilerThread*)this)-&gt;task();
2950     if (task != NULL) {
2951       st-&gt;print("   Compiling: ");
2952       task-&gt;print(st, NULL, true, false);
2953     } else {
2954       st-&gt;print("   No compile task");
2955     }
2956     st-&gt;cr();
2957   }
2958 }
2959 
2960 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2961   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2962 }
2963 
2964 // Called by fatal error handler. The difference between this and
2965 // JavaThread::print() is that we can't grab lock or allocate memory.
2966 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2967   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2968   oop thread_obj = threadObj();
2969   if (thread_obj != NULL) {
2970     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2971   }
2972   st-&gt;print(" [");
2973   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2974   if (osthread()) {
2975     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2976   }
2977   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2978             p2i(stack_end()), p2i(stack_base()));
2979   st-&gt;print("]");
2980 
2981   ThreadsSMRSupport::print_info_on(this, st);
2982   return;
2983 }
2984 
2985 // Verification
2986 
2987 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2988 
2989 void JavaThread::verify() {
2990   // Verify oops in the thread.
2991   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2992 
2993   // Verify the stack frames.
2994   frames_do(frame_verify);
2995 }
2996 
2997 // CR 6300358 (sub-CR 2137150)
2998 // Most callers of this method assume that it can't return NULL but a
2999 // thread may not have a name whilst it is in the process of attaching to
3000 // the VM - see CR 6412693, and there are places where a JavaThread can be
3001 // seen prior to having it's threadObj set (eg JNI attaching threads and
3002 // if vm exit occurs during initialization). These cases can all be accounted
3003 // for such that this method never returns NULL.
3004 const char* JavaThread::get_thread_name() const {
3005 #ifdef ASSERT
3006   // early safepoints can hit while current thread does not yet have TLS
3007   if (!SafepointSynchronize::is_at_safepoint()) {
3008     Thread *cur = Thread::current();
3009     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3010       // Current JavaThreads are allowed to get their own name without
3011       // the Threads_lock.
3012       assert_locked_or_safepoint(Threads_lock);
3013     }
3014   }
3015 #endif // ASSERT
3016   return get_thread_name_string();
3017 }
3018 
3019 // Returns a non-NULL representation of this thread's name, or a suitable
3020 // descriptive string if there is no set name
3021 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3022   const char* name_str;
3023   oop thread_obj = threadObj();
3024   if (thread_obj != NULL) {
3025     oop name = java_lang_Thread::name(thread_obj);
3026     if (name != NULL) {
3027       if (buf == NULL) {
3028         name_str = java_lang_String::as_utf8_string(name);
3029       } else {
3030         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3031       }
3032     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3033       name_str = "&lt;no-name - thread is attaching&gt;";
3034     } else {
3035       name_str = Thread::name();
3036     }
3037   } else {
3038     name_str = Thread::name();
3039   }
3040   assert(name_str != NULL, "unexpected NULL thread name");
3041   return name_str;
3042 }
3043 
3044 
3045 const char* JavaThread::get_threadgroup_name() const {
3046   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3047   oop thread_obj = threadObj();
3048   if (thread_obj != NULL) {
3049     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3050     if (thread_group != NULL) {
3051       // ThreadGroup.name can be null
3052       return java_lang_ThreadGroup::name(thread_group);
3053     }
3054   }
3055   return NULL;
3056 }
3057 
3058 const char* JavaThread::get_parent_name() const {
3059   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3060   oop thread_obj = threadObj();
3061   if (thread_obj != NULL) {
3062     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3063     if (thread_group != NULL) {
3064       oop parent = java_lang_ThreadGroup::parent(thread_group);
3065       if (parent != NULL) {
3066         // ThreadGroup.name can be null
3067         return java_lang_ThreadGroup::name(parent);
3068       }
3069     }
3070   }
3071   return NULL;
3072 }
3073 
3074 ThreadPriority JavaThread::java_priority() const {
3075   oop thr_oop = threadObj();
3076   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3077   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3078   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3079   return priority;
3080 }
3081 
3082 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3083 
3084   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3085   // Link Java Thread object &lt;-&gt; C++ Thread
3086 
3087   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3088   // and put it into a new Handle.  The Handle "thread_oop" can then
3089   // be used to pass the C++ thread object to other methods.
3090 
3091   // Set the Java level thread object (jthread) field of the
3092   // new thread (a JavaThread *) to C++ thread object using the
3093   // "thread_oop" handle.
3094 
3095   // Set the thread field (a JavaThread *) of the
3096   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3097 
3098   Handle thread_oop(Thread::current(),
3099                     JNIHandles::resolve_non_null(jni_thread));
3100   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3101          "must be initialized");
3102   set_threadObj(thread_oop());
3103   java_lang_Thread::set_thread(thread_oop(), this);
3104 
3105   if (prio == NoPriority) {
3106     prio = java_lang_Thread::priority(thread_oop());
3107     assert(prio != NoPriority, "A valid priority should be present");
3108   }
3109 
3110   // Push the Java priority down to the native thread; needs Threads_lock
3111   Thread::set_priority(this, prio);
3112 
3113   // Add the new thread to the Threads list and set it in motion.
3114   // We must have threads lock in order to call Threads::add.
3115   // It is crucial that we do not block before the thread is
3116   // added to the Threads list for if a GC happens, then the java_thread oop
3117   // will not be visited by GC.
3118   Threads::add(this);
3119 }
3120 
3121 oop JavaThread::current_park_blocker() {
3122   // Support for JSR-166 locks
3123   oop thread_oop = threadObj();
3124   if (thread_oop != NULL &amp;&amp;
3125       JDK_Version::current().supports_thread_park_blocker()) {
3126     return java_lang_Thread::park_blocker(thread_oop);
3127   }
3128   return NULL;
3129 }
3130 
3131 
3132 void JavaThread::print_stack_on(outputStream* st) {
3133   if (!has_last_Java_frame()) return;
3134   ResourceMark rm;
3135   HandleMark   hm;
3136 
3137   RegisterMap reg_map(this);
3138   vframe* start_vf = last_java_vframe(&amp;reg_map);
3139   int count = 0;
3140   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3141     if (f-&gt;is_java_frame()) {
3142       javaVFrame* jvf = javaVFrame::cast(f);
3143       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3144 
3145       // Print out lock information
3146       if (JavaMonitorsInStackTrace) {
3147         jvf-&gt;print_lock_info_on(st, count);
3148       }
3149     } else {
3150       // Ignore non-Java frames
3151     }
3152 
3153     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3154     count++;
3155     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3156   }
3157 }
3158 
3159 
3160 // JVMTI PopFrame support
3161 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3162   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3163   if (in_bytes(size_in_bytes) != 0) {
3164     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3165     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3166     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3167   }
3168 }
3169 
3170 void* JavaThread::popframe_preserved_args() {
3171   return _popframe_preserved_args;
3172 }
3173 
3174 ByteSize JavaThread::popframe_preserved_args_size() {
3175   return in_ByteSize(_popframe_preserved_args_size);
3176 }
3177 
3178 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3179   int sz = in_bytes(popframe_preserved_args_size());
3180   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3181   return in_WordSize(sz / wordSize);
3182 }
3183 
3184 void JavaThread::popframe_free_preserved_args() {
3185   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3186   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3187   _popframe_preserved_args = NULL;
3188   _popframe_preserved_args_size = 0;
3189 }
3190 
3191 #ifndef PRODUCT
3192 
3193 void JavaThread::trace_frames() {
3194   tty-&gt;print_cr("[Describe stack]");
3195   int frame_no = 1;
3196   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3197     tty-&gt;print("  %d. ", frame_no++);
3198     fst.current()-&gt;print_value_on(tty, this);
3199     tty-&gt;cr();
3200   }
3201 }
3202 
3203 class PrintAndVerifyOopClosure: public OopClosure {
3204  protected:
3205   template &lt;class T&gt; inline void do_oop_work(T* p) {
3206     oop obj = RawAccess&lt;&gt;::oop_load(p);
3207     if (obj == NULL) return;
3208     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3209     if (oopDesc::is_oop_or_null(obj)) {
3210       if (obj-&gt;is_objArray()) {
3211         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3212       } else {
3213         obj-&gt;print();
3214       }
3215     } else {
3216       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3217     }
3218     tty-&gt;cr();
3219   }
3220  public:
3221   virtual void do_oop(oop* p) { do_oop_work(p); }
3222   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3223 };
3224 
3225 
3226 static void oops_print(frame* f, const RegisterMap *map) {
3227   PrintAndVerifyOopClosure print;
3228   f-&gt;print_value();
3229   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3230 }
3231 
3232 // Print our all the locations that contain oops and whether they are
3233 // valid or not.  This useful when trying to find the oldest frame
3234 // where an oop has gone bad since the frame walk is from youngest to
3235 // oldest.
3236 void JavaThread::trace_oops() {
3237   tty-&gt;print_cr("[Trace oops]");
3238   frames_do(oops_print);
3239 }
3240 
3241 
3242 #ifdef ASSERT
3243 // Print or validate the layout of stack frames
3244 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3245   ResourceMark rm;
3246   PRESERVE_EXCEPTION_MARK;
3247   FrameValues values;
3248   int frame_no = 0;
3249   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3250     fst.current()-&gt;describe(values, ++frame_no);
3251     if (depth == frame_no) break;
3252   }
3253   if (validate_only) {
3254     values.validate();
3255   } else {
3256     tty-&gt;print_cr("[Describe stack layout]");
3257     values.print(this);
3258   }
3259 }
3260 #endif
3261 
3262 void JavaThread::trace_stack_from(vframe* start_vf) {
3263   ResourceMark rm;
3264   int vframe_no = 1;
3265   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3266     if (f-&gt;is_java_frame()) {
3267       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3268     } else {
3269       f-&gt;print();
3270     }
3271     if (vframe_no &gt; StackPrintLimit) {
3272       tty-&gt;print_cr("...&lt;more frames&gt;...");
3273       return;
3274     }
3275   }
3276 }
3277 
3278 
3279 void JavaThread::trace_stack() {
3280   if (!has_last_Java_frame()) return;
3281   ResourceMark rm;
3282   HandleMark   hm;
3283   RegisterMap reg_map(this);
3284   trace_stack_from(last_java_vframe(&amp;reg_map));
3285 }
3286 
3287 
3288 #endif // PRODUCT
3289 
3290 
3291 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3292   assert(reg_map != NULL, "a map must be given");
3293   frame f = last_frame();
3294   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3295     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3296   }
3297   return NULL;
3298 }
3299 
3300 
3301 Klass* JavaThread::security_get_caller_class(int depth) {
3302   vframeStream vfst(this);
3303   vfst.security_get_caller_frame(depth);
3304   if (!vfst.at_end()) {
3305     return vfst.method()-&gt;method_holder();
3306   }
3307   return NULL;
3308 }
3309 
3310 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3311   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3312   CompileBroker::compiler_thread_loop();
3313 }
3314 
3315 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3316   NMethodSweeper::sweeper_loop();
3317 }
3318 
3319 // Create a CompilerThread
3320 CompilerThread::CompilerThread(CompileQueue* queue,
3321                                CompilerCounters* counters)
3322                                : JavaThread(&amp;compiler_thread_entry) {
3323   _env   = NULL;
3324   _log   = NULL;
3325   _task  = NULL;
3326   _queue = queue;
3327   _counters = counters;
3328   _buffer_blob = NULL;
3329   _compiler = NULL;
3330 
3331   // Compiler uses resource area for compilation, let's bias it to mtCompiler
3332   resource_area()-&gt;bias_to(mtCompiler);
3333 
3334 #ifndef PRODUCT
3335   _ideal_graph_printer = NULL;
3336 #endif
3337 }
3338 
3339 CompilerThread::~CompilerThread() {
3340   // Delete objects which were allocated on heap.
3341   delete _counters;
3342 }
3343 
3344 bool CompilerThread::can_call_java() const {
3345   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3346 }
3347 
3348 // Create sweeper thread
3349 CodeCacheSweeperThread::CodeCacheSweeperThread()
3350 : JavaThread(&amp;sweeper_thread_entry) {
3351   _scanned_compiled_method = NULL;
3352 }
3353 
3354 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3355   JavaThread::oops_do(f, cf);
3356   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3357     // Safepoints can occur when the sweeper is scanning an nmethod so
3358     // process it here to make sure it isn't unloaded in the middle of
3359     // a scan.
3360     cf-&gt;do_code_blob(_scanned_compiled_method);
3361   }
3362 }
3363 
3364 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3365   JavaThread::nmethods_do(cf);
3366   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3367     // Safepoints can occur when the sweeper is scanning an nmethod so
3368     // process it here to make sure it isn't unloaded in the middle of
3369     // a scan.
3370     cf-&gt;do_code_blob(_scanned_compiled_method);
3371   }
3372 }
3373 
3374 
3375 // ======= Threads ========
3376 
3377 // The Threads class links together all active threads, and provides
3378 // operations over all threads. It is protected by the Threads_lock,
3379 // which is also used in other global contexts like safepointing.
3380 // ThreadsListHandles are used to safely perform operations on one
3381 // or more threads without the risk of the thread exiting during the
3382 // operation.
3383 //
3384 // Note: The Threads_lock is currently more widely used than we
3385 // would like. We are actively migrating Threads_lock uses to other
3386 // mechanisms in order to reduce Threads_lock contention.
3387 
3388 JavaThread* Threads::_thread_list = NULL;
3389 int         Threads::_number_of_threads = 0;
3390 int         Threads::_number_of_non_daemon_threads = 0;
3391 int         Threads::_return_code = 0;
3392 int         Threads::_thread_claim_parity = 0;
3393 size_t      JavaThread::_stack_size_at_create = 0;
3394 
3395 #ifdef ASSERT
3396 bool        Threads::_vm_complete = false;
3397 size_t      Threads::_threads_before_barrier_set = 0;
3398 #endif
3399 
3400 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3401   Prefetch::read((void*)addr, prefetch_interval);
3402   return *addr;
3403 }
3404 
3405 // Possibly the ugliest for loop the world has seen. C++ does not allow
3406 // multiple types in the declaration section of the for loop. In this case
3407 // we are only dealing with pointers and hence can cast them. It looks ugly
3408 // but macros are ugly and therefore it's fine to make things absurdly ugly.
3409 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3410     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3411              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3412              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3413              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3414              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3415          MACRO_current_p != MACRO_end;                                                                                    \
3416          MACRO_current_p++,                                                                                               \
3417              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3418 
3419 // All JavaThreads
3420 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3421 
3422 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3423 void Threads::non_java_threads_do(ThreadClosure* tc) {
3424   NoSafepointVerifier nsv(!SafepointSynchronize::is_at_safepoint(), false);
3425   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3426     tc-&gt;do_thread(njti.current());
3427   }
3428 }
3429 
3430 // All JavaThreads
3431 void Threads::java_threads_do(ThreadClosure* tc) {
3432   assert_locked_or_safepoint(Threads_lock);
3433   // ALL_JAVA_THREADS iterates through all JavaThreads.
3434   ALL_JAVA_THREADS(p) {
3435     tc-&gt;do_thread(p);
3436   }
3437 }
3438 
3439 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3440   assert_locked_or_safepoint(Threads_lock);
3441   java_threads_do(tc);
3442   tc-&gt;do_thread(VMThread::vm_thread());
3443 }
3444 
3445 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3446 void Threads::threads_do(ThreadClosure* tc) {
3447   assert_locked_or_safepoint(Threads_lock);
3448   java_threads_do(tc);
3449   non_java_threads_do(tc);
3450 }
3451 
3452 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3453   int cp = Threads::thread_claim_parity();
3454   ALL_JAVA_THREADS(p) {
3455     if (p-&gt;claim_oops_do(is_par, cp)) {
3456       tc-&gt;do_thread(p);
3457     }
3458   }
3459   VMThread* vmt = VMThread::vm_thread();
3460   if (vmt-&gt;claim_oops_do(is_par, cp)) {
3461     tc-&gt;do_thread(vmt);
3462   }
3463 }
3464 
3465 // The system initialization in the library has three phases.
3466 //
3467 // Phase 1: java.lang.System class initialization
3468 //     java.lang.System is a primordial class loaded and initialized
3469 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3470 //     only does registerNatives and keeps the rest of the class
3471 //     initialization work later until thread initialization completes.
3472 //
3473 //     System.initPhase1 initializes the system properties, the static
3474 //     fields in, out, and err. Set up java signal handlers, OS-specific
3475 //     system settings, and thread group of the main thread.
3476 static void call_initPhase1(TRAPS) {
3477   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3478   JavaValue result(T_VOID);
3479   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3480                                          vmSymbols::void_method_signature(), CHECK);
3481 }
3482 
3483 // Phase 2. Module system initialization
3484 //     This will initialize the module system.  Only java.base classes
3485 //     can be loaded until phase 2 completes.
3486 //
3487 //     Call System.initPhase2 after the compiler initialization and jsr292
3488 //     classes get initialized because module initialization runs a lot of java
3489 //     code, that for performance reasons, should be compiled.  Also, this will
3490 //     enable the startup code to use lambda and other language features in this
3491 //     phase and onward.
3492 //
3493 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3494 static void call_initPhase2(TRAPS) {
3495   TraceTime timer("Initialize module system", TRACETIME_LOG(Info, startuptime));
3496 
3497   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3498 
3499   JavaValue result(T_INT);
3500   JavaCallArguments args;
3501   args.push_int(DisplayVMOutputToStderr);
3502   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3503   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3504                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3505   if (result.get_jint() != JNI_OK) {
3506     vm_exit_during_initialization(); // no message or exception
3507   }
3508 
3509   universe_post_module_init();
3510 }
3511 
3512 // Phase 3. final setup - set security manager, system class loader and TCCL
3513 //
3514 //     This will instantiate and set the security manager, set the system class
3515 //     loader as well as the thread context class loader.  The security manager
3516 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3517 //     other modules or the application's classpath.
3518 static void call_initPhase3(TRAPS) {
3519   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3520   JavaValue result(T_VOID);
3521   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3522                                          vmSymbols::void_method_signature(), CHECK);
3523 }
3524 
3525 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3526   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3527 
3528   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3529     create_vm_init_libraries();
3530   }
3531 
3532   initialize_class(vmSymbols::java_lang_String(), CHECK);
3533 
3534   // Inject CompactStrings value after the static initializers for String ran.
3535   java_lang_String::set_compact_strings(CompactStrings);
3536 
3537   // Initialize java_lang.System (needed before creating the thread)
3538   initialize_class(vmSymbols::java_lang_System(), CHECK);
3539   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3540   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3541   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3542   Handle thread_group = create_initial_thread_group(CHECK);
3543   Universe::set_main_thread_group(thread_group());
3544   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3545   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3546   main_thread-&gt;set_threadObj(thread_object);
3547   // Set thread status to running since main thread has
3548   // been started and running.
3549   java_lang_Thread::set_thread_status(thread_object,
3550                                       java_lang_Thread::RUNNABLE);
3551 
3552   // The VM creates objects of this class.
3553   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3554 
3555   // The VM preresolves methods to these classes. Make sure that they get initialized
3556   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3557   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3558 
3559   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3560   call_initPhase1(CHECK);
3561 
3562   // get the Java runtime name after java.lang.System is initialized
3563   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3564   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3565 
3566   // an instance of OutOfMemory exception has been allocated earlier
3567   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3568   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3569   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3570   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3571   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3572   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3573   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3574   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3575 }
3576 
3577 void Threads::initialize_jsr292_core_classes(TRAPS) {
3578   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3579 
3580   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3581   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3582   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3583   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3584 }
3585 
3586 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3587   extern void JDK_Version_init();
3588 
3589   // Preinitialize version info.
3590   VM_Version::early_initialize();
3591 
3592   // Check version
3593   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3594 
3595   // Initialize library-based TLS
3596   ThreadLocalStorage::init();
3597 
3598   // Initialize the output stream module
3599   ostream_init();
3600 
3601   // Process java launcher properties.
3602   Arguments::process_sun_java_launcher_properties(args);
3603 
3604   // Initialize the os module
3605   os::init();
3606 
3607   // Record VM creation timing statistics
3608   TraceVmCreationTime create_vm_timer;
3609   create_vm_timer.start();
3610 
3611   // Initialize system properties.
3612   Arguments::init_system_properties();
3613 
3614   // So that JDK version can be used as a discriminator when parsing arguments
3615   JDK_Version_init();
3616 
3617   // Update/Initialize System properties after JDK version number is known
3618   Arguments::init_version_specific_system_properties();
3619 
3620   // Make sure to initialize log configuration *before* parsing arguments
3621   LogConfiguration::initialize(create_vm_timer.begin_time());
3622 
3623   // Parse arguments
3624   // Note: this internally calls os::init_container_support()
3625   jint parse_result = Arguments::parse(args);
3626   if (parse_result != JNI_OK) return parse_result;
3627 
3628   os::init_before_ergo();
3629 
3630   jint ergo_result = Arguments::apply_ergo();
3631   if (ergo_result != JNI_OK) return ergo_result;
3632 
3633   // Final check of all ranges after ergonomics which may change values.
3634   if (!JVMFlagRangeList::check_ranges()) {
3635     return JNI_EINVAL;
3636   }
3637 
3638   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3639   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3640   if (!constraint_result) {
3641     return JNI_EINVAL;
3642   }
3643 
3644   JVMFlagWriteableList::mark_startup();
3645 
3646   if (PauseAtStartup) {
3647     os::pause();
3648   }
3649 
3650   HOTSPOT_VM_INIT_BEGIN();
3651 
3652   // Timing (must come after argument parsing)
3653   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3654 
3655 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3656   // Initialize assert poison page mechanism.
3657   if (ShowRegistersOnAssert) {
3658     initialize_assert_poison();
3659   }
3660 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3661 
3662   // Initialize the os module after parsing the args
3663   jint os_init_2_result = os::init_2();
3664   if (os_init_2_result != JNI_OK) return os_init_2_result;
3665 
3666   SafepointMechanism::initialize();
3667 
3668   jint adjust_after_os_result = Arguments::adjust_after_os();
3669   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3670 
3671   // Initialize output stream logging
3672   ostream_init_log();
3673 
3674   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3675   // Must be before create_vm_init_agents()
3676   if (Arguments::init_libraries_at_startup()) {
3677     convert_vm_init_libraries_to_agents();
3678   }
3679 
3680   // Launch -agentlib/-agentpath and converted -Xrun agents
3681   if (Arguments::init_agents_at_startup()) {
3682     create_vm_init_agents();
3683   }
3684 
3685   // Initialize Threads state
3686   _thread_list = NULL;
3687   _number_of_threads = 0;
3688   _number_of_non_daemon_threads = 0;
3689 
3690   // Initialize global data structures and create system classes in heap
3691   vm_init_globals();
3692 
3693 #if INCLUDE_JVMCI
3694   if (JVMCICounterSize &gt; 0) {
3695     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3696     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3697   } else {
3698     JavaThread::_jvmci_old_thread_counters = NULL;
3699   }
3700 #endif // INCLUDE_JVMCI
3701 
3702   // Attach the main thread to this os thread
3703   JavaThread* main_thread = new JavaThread();
3704   main_thread-&gt;set_thread_state(_thread_in_vm);
3705   main_thread-&gt;initialize_thread_current();
3706   // must do this before set_active_handles
3707   main_thread-&gt;record_stack_base_and_size();
3708   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3709 
3710   if (!main_thread-&gt;set_as_starting_thread()) {
3711     vm_shutdown_during_initialization(
3712                                       "Failed necessary internal allocation. Out of swap space");
3713     main_thread-&gt;smr_delete();
3714     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3715     return JNI_ENOMEM;
3716   }
3717 
3718   // Enable guard page *after* os::create_main_thread(), otherwise it would
3719   // crash Linux VM, see notes in os_linux.cpp.
3720   main_thread-&gt;create_stack_guard_pages();
3721 
3722   // Initialize Java-Level synchronization subsystem
3723   ObjectMonitor::Initialize();
3724 
3725   // Initialize global modules
3726   jint status = init_globals();
3727   if (status != JNI_OK) {
3728     main_thread-&gt;smr_delete();
3729     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3730     return status;
3731   }
3732 
3733   JFR_ONLY(Jfr::on_vm_init();)
3734 
3735   // Should be done after the heap is fully created
3736   main_thread-&gt;cache_global_variables();
3737 
3738   HandleMark hm;
3739 
3740   { MutexLocker mu(Threads_lock);
3741     Threads::add(main_thread);
3742   }
3743 
3744   // Any JVMTI raw monitors entered in onload will transition into
3745   // real raw monitor. VM is setup enough here for raw monitor enter.
3746   JvmtiExport::transition_pending_onload_raw_monitors();
3747 
3748   // Create the VMThread
3749   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3750 
3751   VMThread::create();
3752     Thread* vmthread = VMThread::vm_thread();
3753 
3754     if (!os::create_thread(vmthread, os::vm_thread)) {
3755       vm_exit_during_initialization("Cannot create VM thread. "
3756                                     "Out of system resources.");
3757     }
3758 
3759     // Wait for the VM thread to become ready, and VMThread::run to initialize
3760     // Monitors can have spurious returns, must always check another state flag
3761     {
3762       MutexLocker ml(Notify_lock);
3763       os::start_thread(vmthread);
3764       while (vmthread-&gt;active_handles() == NULL) {
3765         Notify_lock-&gt;wait();
3766       }
3767     }
3768   }
3769 
3770   assert(Universe::is_fully_initialized(), "not initialized");
3771   if (VerifyDuringStartup) {
3772     // Make sure we're starting with a clean slate.
3773     VM_Verify verify_op;
3774     VMThread::execute(&amp;verify_op);
3775   }
3776 
3777   // We need this to update the java.vm.info property in case any flags used
3778   // to initially define it have been changed. This is needed for both CDS and
3779   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3780   // is initially computed. See Abstract_VM_Version::vm_info_string().
3781   // This update must happen before we initialize the java classes, but
3782   // after any initialization logic that might modify the flags.
3783   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3784 
3785   Thread* THREAD = Thread::current();
3786 
3787   // Always call even when there are not JVMTI environments yet, since environments
3788   // may be attached late and JVMTI must track phases of VM execution
3789   JvmtiExport::enter_early_start_phase();
3790 
3791   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3792   JvmtiExport::post_early_vm_start();
3793 
3794   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3795 
3796   quicken_jni_functions();
3797 
3798   // No more stub generation allowed after that point.
3799   StubCodeDesc::freeze();
3800 
3801   // Set flag that basic initialization has completed. Used by exceptions and various
3802   // debug stuff, that does not work until all basic classes have been initialized.
3803   set_init_completed();
3804 
3805   LogConfiguration::post_initialize();
3806   Metaspace::post_initialize();
3807 
3808   HOTSPOT_VM_INIT_END();
3809 
3810   // record VM initialization completion time
3811 #if INCLUDE_MANAGEMENT
3812   Management::record_vm_init_completed();
3813 #endif // INCLUDE_MANAGEMENT
3814 
3815   // Signal Dispatcher needs to be started before VMInit event is posted
3816   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
3817 
3818   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3819   if (!DisableAttachMechanism) {
3820     AttachListener::vm_start();
3821     if (StartAttachListener || AttachListener::init_at_startup()) {
3822       AttachListener::init();
3823     }
3824   }
3825 
3826   // Launch -Xrun agents
3827   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3828   // back-end can launch with -Xdebug -Xrunjdwp.
3829   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3830     create_vm_init_libraries();
3831   }
3832 
3833   if (CleanChunkPoolAsync) {
3834     Chunk::start_chunk_pool_cleaner_task();
3835   }
3836 
3837   // initialize compiler(s)
3838 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
3839 #if INCLUDE_JVMCI
3840   bool force_JVMCI_intialization = false;
3841   if (EnableJVMCI) {
3842     // Initialize JVMCI eagerly when it is explicitly requested.
3843     // Or when JVMCIPrintProperties is enabled.
3844     // The JVMCI Java initialization code will read this flag and
3845     // do the printing if it's set.
3846     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;
3847 
3848     if (!force_JVMCI_intialization) {
3849       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3850       // compilations via JVMCI will not actually block until JVMCI is initialized.
3851       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
3852     }
3853   }
3854 #endif
3855   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
3856   // Postpone completion of compiler initialization to after JVMCI
3857   // is initialized to avoid timeouts of blocking compilations.
3858   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
3859     CompileBroker::compilation_init_phase2();
3860   }
3861 #endif
3862 
3863   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3864   // It is done after compilers are initialized, because otherwise compilations of
3865   // signature polymorphic MH intrinsics can be missed
3866   // (see SystemDictionary::find_method_handle_intrinsic).
3867   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3868 
3869   // This will initialize the module system.  Only java.base classes can be
3870   // loaded until phase 2 completes
3871   call_initPhase2(CHECK_JNI_ERR);
3872 
3873   // Always call even when there are not JVMTI environments yet, since environments
3874   // may be attached late and JVMTI must track phases of VM execution
3875   JvmtiExport::enter_start_phase();
3876 
3877   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3878   JvmtiExport::post_vm_start();
3879 
3880   // Final system initialization including security manager and system class loader
3881   call_initPhase3(CHECK_JNI_ERR);
3882 
3883   // cache the system and platform class loaders
3884   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
3885 
3886 #if INCLUDE_CDS
3887   if (DumpSharedSpaces) {
3888     // capture the module path info from the ModuleEntryTable
3889     ClassLoader::initialize_module_path(THREAD);
3890   }
3891 #endif
3892 
3893 #if INCLUDE_JVMCI
3894   if (force_JVMCI_intialization) {
3895     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3896     CompileBroker::compilation_init_phase2();
3897   }
3898 #endif
3899 
3900   // Always call even when there are not JVMTI environments yet, since environments
3901   // may be attached late and JVMTI must track phases of VM execution
3902   JvmtiExport::enter_live_phase();
3903 
3904   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3905   JvmtiExport::post_vm_initialized();
3906 
3907   JFR_ONLY(Jfr::on_vm_start();)
3908 
3909 #if INCLUDE_MANAGEMENT
3910   Management::initialize(THREAD);
3911 
3912   if (HAS_PENDING_EXCEPTION) {
3913     // management agent fails to start possibly due to
3914     // configuration problem and is responsible for printing
3915     // stack trace if appropriate. Simply exit VM.
3916     vm_exit(1);
3917   }
3918 #endif // INCLUDE_MANAGEMENT
3919 
3920   if (MemProfiling)                   MemProfiler::engage();
3921   StatSampler::engage();
3922   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3923 
3924   BiasedLocking::init();
3925 
3926 #if INCLUDE_RTM_OPT
3927   RTMLockingCounters::init();
3928 #endif
3929 
3930   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3931     call_postVMInitHook(THREAD);
3932     // The Java side of PostVMInitHook.run must deal with all
3933     // exceptions and provide means of diagnosis.
3934     if (HAS_PENDING_EXCEPTION) {
3935       CLEAR_PENDING_EXCEPTION;
3936     }
3937   }
3938 
3939   {
3940     MutexLocker ml(PeriodicTask_lock);
3941     // Make sure the WatcherThread can be started by WatcherThread::start()
3942     // or by dynamic enrollment.
3943     WatcherThread::make_startable();
3944     // Start up the WatcherThread if there are any periodic tasks
3945     // NOTE:  All PeriodicTasks should be registered by now. If they
3946     //   aren't, late joiners might appear to start slowly (we might
3947     //   take a while to process their first tick).
3948     if (PeriodicTask::num_tasks() &gt; 0) {
3949       WatcherThread::start();
3950     }
3951   }
3952 
3953   create_vm_timer.end();
3954 #ifdef ASSERT
3955   _vm_complete = true;
3956 #endif
3957 
3958   if (DumpSharedSpaces) {
3959     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3960     ShouldNotReachHere();
3961   }
3962 
3963   return JNI_OK;
3964 }
3965 
3966 // type for the Agent_OnLoad and JVM_OnLoad entry points
3967 extern "C" {
3968   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3969 }
3970 // Find a command line agent library and return its entry point for
3971 //         -agentlib:  -agentpath:   -Xrun
3972 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3973 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3974                                     const char *on_load_symbols[],
3975                                     size_t num_symbol_entries) {
3976   OnLoadEntry_t on_load_entry = NULL;
3977   void *library = NULL;
3978 
3979   if (!agent-&gt;valid()) {
3980     char buffer[JVM_MAXPATHLEN];
3981     char ebuf[1024] = "";
3982     const char *name = agent-&gt;name();
3983     const char *msg = "Could not find agent library ";
3984 
3985     // First check to see if agent is statically linked into executable
3986     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3987       library = agent-&gt;os_lib();
3988     } else if (agent-&gt;is_absolute_path()) {
3989       library = os::dll_load(name, ebuf, sizeof ebuf);
3990       if (library == NULL) {
3991         const char *sub_msg = " in absolute path, with error: ";
3992         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3993         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3994         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3995         // If we can't find the agent, exit.
3996         vm_exit_during_initialization(buf, NULL);
3997         FREE_C_HEAP_ARRAY(char, buf);
3998       }
3999     } else {
4000       // Try to load the agent from the standard dll directory
4001       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4002                              name)) {
4003         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4004       }
4005       if (library == NULL) { // Try the library path directory.
4006         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4007           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4008         }
4009         if (library == NULL) {
4010           const char *sub_msg = " on the library path, with error: ";
4011           const char *sub_msg2 = "\nModule java.instrument may be missing from runtime image.";
4012 
4013           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4014                        strlen(ebuf) + strlen(sub_msg2) + 1;
4015           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4016           if (!agent-&gt;is_instrument_lib()) {
4017             jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
4018           } else {
4019             jio_snprintf(buf, len, "%s%s%s%s%s", msg, name, sub_msg, ebuf, sub_msg2);
4020           }
4021           // If we can't find the agent, exit.
4022           vm_exit_during_initialization(buf, NULL);
4023           FREE_C_HEAP_ARRAY(char, buf);
4024         }
4025       }
4026     }
4027     agent-&gt;set_os_lib(library);
4028     agent-&gt;set_valid();
4029   }
4030 
4031   // Find the OnLoad function.
4032   on_load_entry =
4033     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4034                                                           false,
4035                                                           on_load_symbols,
4036                                                           num_symbol_entries));
4037   return on_load_entry;
4038 }
4039 
4040 // Find the JVM_OnLoad entry point
4041 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4042   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4043   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4044 }
4045 
4046 // Find the Agent_OnLoad entry point
4047 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4048   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4049   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4050 }
4051 
4052 // For backwards compatibility with -Xrun
4053 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4054 // treated like -agentpath:
4055 // Must be called before agent libraries are created
4056 void Threads::convert_vm_init_libraries_to_agents() {
4057   AgentLibrary* agent;
4058   AgentLibrary* next;
4059 
4060   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4061     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4062     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4063 
4064     // If there is an JVM_OnLoad function it will get called later,
4065     // otherwise see if there is an Agent_OnLoad
4066     if (on_load_entry == NULL) {
4067       on_load_entry = lookup_agent_on_load(agent);
4068       if (on_load_entry != NULL) {
4069         // switch it to the agent list -- so that Agent_OnLoad will be called,
4070         // JVM_OnLoad won't be attempted and Agent_OnUnload will
4071         Arguments::convert_library_to_agent(agent);
4072       } else {
4073         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
4074       }
4075     }
4076   }
4077 }
4078 
4079 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4080 // Invokes Agent_OnLoad
4081 // Called very early -- before JavaThreads exist
4082 void Threads::create_vm_init_agents() {
4083   extern struct JavaVM_ main_vm;
4084   AgentLibrary* agent;
4085 
4086   JvmtiExport::enter_onload_phase();
4087 
4088   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4089     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4090 
4091     if (on_load_entry != NULL) {
4092       // Invoke the Agent_OnLoad function
4093       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4094       if (err != JNI_OK) {
4095         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
4096       }
4097     } else {
4098       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
4099     }
4100   }
4101   JvmtiExport::enter_primordial_phase();
4102 }
4103 
4104 extern "C" {
4105   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4106 }
4107 
4108 void Threads::shutdown_vm_agents() {
4109   // Send any Agent_OnUnload notifications
4110   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4111   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4112   extern struct JavaVM_ main_vm;
4113   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4114 
4115     // Find the Agent_OnUnload function.
4116     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4117                                                    os::find_agent_function(agent,
4118                                                    false,
4119                                                    on_unload_symbols,
4120                                                    num_symbol_entries));
4121 
4122     // Invoke the Agent_OnUnload function
4123     if (unload_entry != NULL) {
4124       JavaThread* thread = JavaThread::current();
4125       ThreadToNativeFromVM ttn(thread);
4126       HandleMark hm(thread);
4127       (*unload_entry)(&amp;main_vm);
4128     }
4129   }
4130 }
4131 
4132 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4133 // Invokes JVM_OnLoad
4134 void Threads::create_vm_init_libraries() {
4135   extern struct JavaVM_ main_vm;
4136   AgentLibrary* agent;
4137 
4138   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4139     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4140 
4141     if (on_load_entry != NULL) {
4142       // Invoke the JVM_OnLoad function
4143       JavaThread* thread = JavaThread::current();
4144       ThreadToNativeFromVM ttn(thread);
4145       HandleMark hm(thread);
4146       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4147       if (err != JNI_OK) {
4148         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4149       }
4150     } else {
4151       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4152     }
4153   }
4154 }
4155 
4156 
4157 // Last thread running calls java.lang.Shutdown.shutdown()
4158 void JavaThread::invoke_shutdown_hooks() {
4159   HandleMark hm(this);
4160 
4161   // We could get here with a pending exception, if so clear it now.
4162   if (this-&gt;has_pending_exception()) {
4163     this-&gt;clear_pending_exception();
4164   }
4165 
4166   EXCEPTION_MARK;
4167   Klass* shutdown_klass =
4168     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4169                                       THREAD);
4170   if (shutdown_klass != NULL) {
4171     // SystemDictionary::resolve_or_null will return null if there was
4172     // an exception.  If we cannot load the Shutdown class, just don't
4173     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4174     // won't be run.  Note that if a shutdown hook was registered,
4175     // the Shutdown class would have already been loaded
4176     // (Runtime.addShutdownHook will load it).
4177     JavaValue result(T_VOID);
4178     JavaCalls::call_static(&amp;result,
4179                            shutdown_klass,
4180                            vmSymbols::shutdown_method_name(),
4181                            vmSymbols::void_method_signature(),
4182                            THREAD);
4183   }
4184   CLEAR_PENDING_EXCEPTION;
4185 }
4186 
4187 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4188 // the program falls off the end of main(). Another VM exit path is through
4189 // vm_exit() when the program calls System.exit() to return a value or when
4190 // there is a serious error in VM. The two shutdown paths are not exactly
4191 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4192 // and VM_Exit op at VM level.
4193 //
4194 // Shutdown sequence:
4195 //   + Shutdown native memory tracking if it is on
4196 //   + Wait until we are the last non-daemon thread to execute
4197 //     &lt;-- every thing is still working at this moment --&gt;
4198 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4199 //        shutdown hooks
4200 //   + Call before_exit(), prepare for VM exit
4201 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4202 //        currently the only user of this mechanism is File.deleteOnExit())
4203 //      &gt; stop StatSampler, watcher thread, CMS threads,
4204 //        post thread end and vm death events to JVMTI,
4205 //        stop signal thread
4206 //   + Call JavaThread::exit(), it will:
4207 //      &gt; release JNI handle blocks, remove stack guard pages
4208 //      &gt; remove this thread from Threads list
4209 //     &lt;-- no more Java code from this thread after this point --&gt;
4210 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4211 //     the compiler threads at safepoint
4212 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4213 //   + Disable tracing at JNI/JVM barriers
4214 //   + Set _vm_exited flag for threads that are still running native code
4215 //   + Delete this thread
4216 //   + Call exit_globals()
4217 //      &gt; deletes tty
4218 //      &gt; deletes PerfMemory resources
4219 //   + Return to caller
4220 
4221 bool Threads::destroy_vm() {
4222   JavaThread* thread = JavaThread::current();
4223 
4224 #ifdef ASSERT
4225   _vm_complete = false;
4226 #endif
4227   // Wait until we are the last non-daemon thread to execute
4228   { MutexLocker nu(Threads_lock);
4229     while (Threads::number_of_non_daemon_threads() &gt; 1)
4230       // This wait should make safepoint checks, wait without a timeout,
4231       // and wait as a suspend-equivalent condition.
4232       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4233                          Mutex::_as_suspend_equivalent_flag);
4234   }
4235 
4236   EventShutdown e;
4237   if (e.should_commit()) {
4238     e.set_reason("No remaining non-daemon Java threads");
4239     e.commit();
4240   }
4241 
4242   // Hang forever on exit if we are reporting an error.
4243   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4244     os::infinite_sleep();
4245   }
4246   os::wait_for_keypress_at_exit();
4247 
4248   // run Java level shutdown hooks
4249   thread-&gt;invoke_shutdown_hooks();
4250 
4251   before_exit(thread);
4252 
4253   thread-&gt;exit(true);
4254   // thread will never call smr_delete, instead of implicit cancel
4255   // in wait_for_vm_thread_exit we do it explicit.
4256   thread-&gt;cancel_handshake();
4257 
4258   // Stop VM thread.
4259   {
4260     // 4945125 The vm thread comes to a safepoint during exit.
4261     // GC vm_operations can get caught at the safepoint, and the
4262     // heap is unparseable if they are caught. Grab the Heap_lock
4263     // to prevent this. The GC vm_operations will not be able to
4264     // queue until after the vm thread is dead. After this point,
4265     // we'll never emerge out of the safepoint before the VM exits.
4266 
4267     MutexLocker ml(Heap_lock);
4268 
4269     VMThread::wait_for_vm_thread_exit();
4270     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4271     VMThread::destroy();
4272   }
4273 
4274   // Now, all Java threads are gone except daemon threads. Daemon threads
4275   // running Java code or in VM are stopped by the Safepoint. However,
4276   // daemon threads executing native code are still running.  But they
4277   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4278   // simply kill or suspend them, as it is inherently deadlock-prone.
4279 
4280   VM_Exit::set_vm_exited();
4281 
4282   // Clean up ideal graph printers after the VMThread has started
4283   // the final safepoint which will block all the Compiler threads.
4284   // Note that this Thread has already logically exited so the
4285   // clean_up() function's use of a JavaThreadIteratorWithHandle
4286   // would be a problem except set_vm_exited() has remembered the
4287   // shutdown thread which is granted a policy exception.
4288 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4289   IdealGraphPrinter::clean_up();
4290 #endif
4291 
4292   notify_vm_shutdown();
4293 
4294   // We are after VM_Exit::set_vm_exited() so we can't call
4295   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4296   // Deleting the shutdown thread here is safe because another
4297   // JavaThread cannot have an active ThreadsListHandle for
4298   // this JavaThread.
4299   delete thread;
4300 
4301 #if INCLUDE_JVMCI
4302   if (JVMCICounterSize &gt; 0) {
4303     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4304   }
4305 #endif
4306 
4307   // exit_globals() will delete tty
4308   exit_globals();
4309 
4310   LogConfiguration::finalize();
4311 
4312   return true;
4313 }
4314 
4315 
4316 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4317   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4318   return is_supported_jni_version(version);
4319 }
4320 
4321 
4322 jboolean Threads::is_supported_jni_version(jint version) {
4323   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4324   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4325   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4326   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4327   if (version == JNI_VERSION_9) return JNI_TRUE;
4328   if (version == JNI_VERSION_10) return JNI_TRUE;
4329   return JNI_FALSE;
4330 }
4331 
4332 
4333 void Threads::add(JavaThread* p, bool force_daemon) {
4334   // The threads lock must be owned at this point
4335   assert_locked_or_safepoint(Threads_lock);
4336 
4337   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4338 
4339   p-&gt;set_next(_thread_list);
4340   _thread_list = p;
4341 
4342   // Once a JavaThread is added to the Threads list, smr_delete() has
4343   // to be used to delete it. Otherwise we can just delete it directly.
4344   p-&gt;set_on_thread_list();
4345 
4346   _number_of_threads++;
4347   oop threadObj = p-&gt;threadObj();
4348   bool daemon = true;
4349   // Bootstrapping problem: threadObj can be null for initial
4350   // JavaThread (or for threads attached via JNI)
4351   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4352     _number_of_non_daemon_threads++;
4353     daemon = false;
4354   }
4355 
4356   ThreadService::add_thread(p, daemon);
4357 
4358   // Maintain fast thread list
4359   ThreadsSMRSupport::add_thread(p);
4360 
4361   // Possible GC point.
4362   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4363 }
4364 
4365 void Threads::remove(JavaThread* p) {
4366 
4367   // Reclaim the objectmonitors from the omInUseList and omFreeList of the moribund thread.
4368   ObjectSynchronizer::omFlush(p);
4369 
4370   // Extra scope needed for Thread_lock, so we can check
4371   // that we do not remove thread without safepoint code notice
4372   { MutexLocker ml(Threads_lock);
4373 
4374     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), "p must be present");
4375 
4376     // Maintain fast thread list
4377     ThreadsSMRSupport::remove_thread(p);
4378 
4379     JavaThread* current = _thread_list;
4380     JavaThread* prev    = NULL;
4381 
4382     while (current != p) {
4383       prev    = current;
4384       current = current-&gt;next();
4385     }
4386 
4387     if (prev) {
4388       prev-&gt;set_next(current-&gt;next());
4389     } else {
4390       _thread_list = p-&gt;next();
4391     }
4392 
4393     _number_of_threads--;
4394     oop threadObj = p-&gt;threadObj();
4395     bool daemon = true;
4396     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4397       _number_of_non_daemon_threads--;
4398       daemon = false;
4399 
4400       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4401       // on destroy_vm will wake up.
4402       if (number_of_non_daemon_threads() == 1) {
4403         Threads_lock-&gt;notify_all();
4404       }
4405     }
4406     ThreadService::remove_thread(p, daemon);
4407 
4408     // Make sure that safepoint code disregard this thread. This is needed since
4409     // the thread might mess around with locks after this point. This can cause it
4410     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4411     // of this thread since it is removed from the queue.
4412     p-&gt;set_terminated_value();
4413   } // unlock Threads_lock
4414 
4415   // Since Events::log uses a lock, we grab it outside the Threads_lock
4416   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4417 }
4418 
4419 // Operations on the Threads list for GC.  These are not explicitly locked,
4420 // but the garbage collector must provide a safe context for them to run.
4421 // In particular, these things should never be called when the Threads_lock
4422 // is held by some other thread. (Note: the Safepoint abstraction also
4423 // uses the Threads_lock to guarantee this property. It also makes sure that
4424 // all threads gets blocked when exiting or starting).
4425 
4426 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4427   ALL_JAVA_THREADS(p) {
4428     p-&gt;oops_do(f, cf);
4429   }
4430   VMThread::vm_thread()-&gt;oops_do(f, cf);
4431 }
4432 
4433 void Threads::change_thread_claim_parity() {
4434   // Set the new claim parity.
4435   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4436          "Not in range.");
4437   _thread_claim_parity++;
4438   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4439   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4440          "Not in range.");
4441 }
4442 
4443 #ifdef ASSERT
4444 void Threads::assert_all_threads_claimed() {
4445   ALL_JAVA_THREADS(p) {
4446     const int thread_parity = p-&gt;oops_do_parity();
4447     assert((thread_parity == _thread_claim_parity),
4448            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4449   }
4450   VMThread* vmt = VMThread::vm_thread();
4451   const int thread_parity = vmt-&gt;oops_do_parity();
4452   assert((thread_parity == _thread_claim_parity),
4453          "VMThread " PTR_FORMAT " has incorrect parity %d != %d", p2i(vmt), thread_parity, _thread_claim_parity);
4454 }
4455 #endif // ASSERT
4456 
4457 class ParallelOopsDoThreadClosure : public ThreadClosure {
4458 private:
4459   OopClosure* _f;
4460   CodeBlobClosure* _cf;
4461 public:
4462   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4463   void do_thread(Thread* t) {
4464     t-&gt;oops_do(_f, _cf);
4465   }
4466 };
4467 
4468 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4469   ParallelOopsDoThreadClosure tc(f, cf);
4470   possibly_parallel_threads_do(is_par, &amp;tc);
4471 }
4472 
4473 void Threads::nmethods_do(CodeBlobClosure* cf) {
4474   ALL_JAVA_THREADS(p) {
4475     // This is used by the code cache sweeper to mark nmethods that are active
4476     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4477     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4478     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4479       p-&gt;nmethods_do(cf);
4480     }
4481   }
4482 }
4483 
4484 void Threads::metadata_do(void f(Metadata*)) {
4485   ALL_JAVA_THREADS(p) {
4486     p-&gt;metadata_do(f);
4487   }
4488 }
4489 
4490 class ThreadHandlesClosure : public ThreadClosure {
4491   void (*_f)(Metadata*);
4492  public:
4493   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4494   virtual void do_thread(Thread* thread) {
4495     thread-&gt;metadata_handles_do(_f);
4496   }
4497 };
4498 
4499 void Threads::metadata_handles_do(void f(Metadata*)) {
4500   // Only walk the Handles in Thread.
4501   ThreadHandlesClosure handles_closure(f);
4502   threads_do(&amp;handles_closure);
4503 }
4504 
4505 void Threads::deoptimized_wrt_marked_nmethods() {
4506   ALL_JAVA_THREADS(p) {
4507     p-&gt;deoptimized_wrt_marked_nmethods();
4508   }
4509 }
4510 
4511 
4512 // Get count Java threads that are waiting to enter the specified monitor.
4513 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4514                                                          int count,
4515                                                          address monitor) {
4516   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4517 
4518   int i = 0;
4519   DO_JAVA_THREADS(t_list, p) {
4520     if (!p-&gt;can_call_java()) continue;
4521 
4522     address pending = (address)p-&gt;current_pending_monitor();
4523     if (pending == monitor) {             // found a match
4524       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4525       i++;
4526     }
4527   }
4528 
4529   return result;
4530 }
4531 
4532 
4533 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4534                                                       address owner) {
4535   // NULL owner means not locked so we can skip the search
4536   if (owner == NULL) return NULL;
4537 
4538   DO_JAVA_THREADS(t_list, p) {
4539     // first, see if owner is the address of a Java thread
4540     if (owner == (address)p) return p;
4541   }
4542 
4543   // Cannot assert on lack of success here since this function may be
4544   // used by code that is trying to report useful problem information
4545   // like deadlock detection.
4546   if (UseHeavyMonitors) return NULL;
4547 
4548   // If we didn't find a matching Java thread and we didn't force use of
4549   // heavyweight monitors, then the owner is the stack address of the
4550   // Lock Word in the owning Java thread's stack.
4551   //
4552   JavaThread* the_owner = NULL;
4553   DO_JAVA_THREADS(t_list, q) {
4554     if (q-&gt;is_lock_owned(owner)) {
4555       the_owner = q;
4556       break;
4557     }
4558   }
4559 
4560   // cannot assert on lack of success here; see above comment
4561   return the_owner;
4562 }
4563 
4564 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4565 void Threads::print_on(outputStream* st, bool print_stacks,
4566                        bool internal_format, bool print_concurrent_locks,
4567                        bool print_extended_info) {
4568   char buf[32];
4569   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4570 
4571   st-&gt;print_cr("Full thread dump %s (%s %s):",
4572                Abstract_VM_Version::vm_name(),
4573                Abstract_VM_Version::vm_release(),
4574                Abstract_VM_Version::vm_info_string());
4575   st-&gt;cr();
4576 
4577 #if INCLUDE_SERVICES
4578   // Dump concurrent locks
4579   ConcurrentLocksDump concurrent_locks;
4580   if (print_concurrent_locks) {
4581     concurrent_locks.dump_at_safepoint();
4582   }
4583 #endif // INCLUDE_SERVICES
4584 
4585   ThreadsSMRSupport::print_info_on(st);
4586   st-&gt;cr();
4587 
4588   ALL_JAVA_THREADS(p) {
4589     ResourceMark rm;
4590     p-&gt;print_on(st, print_extended_info);
4591     if (print_stacks) {
4592       if (internal_format) {
4593         p-&gt;trace_stack();
4594       } else {
4595         p-&gt;print_stack_on(st);
4596       }
4597     }
4598     st-&gt;cr();
4599 #if INCLUDE_SERVICES
4600     if (print_concurrent_locks) {
4601       concurrent_locks.print_locks_on(p, st);
4602     }
4603 #endif // INCLUDE_SERVICES
4604   }
4605 
4606   VMThread::vm_thread()-&gt;print_on(st);
4607   st-&gt;cr();
4608   Universe::heap()-&gt;print_gc_threads_on(st);
4609   WatcherThread* wt = WatcherThread::watcher_thread();
4610   if (wt != NULL) {
4611     wt-&gt;print_on(st);
4612     st-&gt;cr();
4613   }
4614 
4615   st-&gt;flush();
4616 }
4617 
4618 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4619                              int buflen, bool* found_current) {
4620   if (this_thread != NULL) {
4621     bool is_current = (current == this_thread);
4622     *found_current = *found_current || is_current;
4623     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4624 
4625     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4626     st-&gt;print(" ");
4627     this_thread-&gt;print_on_error(st, buf, buflen);
4628     st-&gt;cr();
4629   }
4630 }
4631 
4632 class PrintOnErrorClosure : public ThreadClosure {
4633   outputStream* _st;
4634   Thread* _current;
4635   char* _buf;
4636   int _buflen;
4637   bool* _found_current;
4638  public:
4639   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4640                       int buflen, bool* found_current) :
4641    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4642 
4643   virtual void do_thread(Thread* thread) {
4644     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4645   }
4646 };
4647 
4648 // Threads::print_on_error() is called by fatal error handler. It's possible
4649 // that VM is not at safepoint and/or current thread is inside signal handler.
4650 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4651 // memory (even in resource area), it might deadlock the error handler.
4652 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4653                              int buflen) {
4654   ThreadsSMRSupport::print_info_on(st);
4655   st-&gt;cr();
4656 
4657   bool found_current = false;
4658   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4659   ALL_JAVA_THREADS(thread) {
4660     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4661   }
4662   st-&gt;cr();
4663 
4664   st-&gt;print_cr("Other Threads:");
4665   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4666   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4667 
4668   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4669   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4670 
4671   if (!found_current) {
4672     st-&gt;cr();
4673     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4674     current-&gt;print_on_error(st, buf, buflen);
4675     st-&gt;cr();
4676   }
4677   st-&gt;cr();
4678 
4679   st-&gt;print_cr("Threads with active compile tasks:");
4680   print_threads_compiling(st, buf, buflen);
4681 }
4682 
4683 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4684   ALL_JAVA_THREADS(thread) {
4685     if (thread-&gt;is_Compiler_thread()) {
4686       CompilerThread* ct = (CompilerThread*) thread;
4687 
4688       // Keep task in local variable for NULL check.
4689       // ct-&gt;_task might be set to NULL by concurring compiler thread
4690       // because it completed the compilation. The task is never freed,
4691       // though, just returned to a free list.
4692       CompileTask* task = ct-&gt;task();
4693       if (task != NULL) {
4694         thread-&gt;print_name_on_error(st, buf, buflen);
4695         task-&gt;print(st, NULL, true, true);
4696       }
4697     }
4698   }
4699 }
4700 
4701 
4702 // Internal SpinLock and Mutex
4703 // Based on ParkEvent
4704 
4705 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4706 //
4707 // We employ SpinLocks _only for low-contention, fixed-length
4708 // short-duration critical sections where we're concerned
4709 // about native mutex_t or HotSpot Mutex:: latency.
4710 // The mux construct provides a spin-then-block mutual exclusion
4711 // mechanism.
4712 //
4713 // Testing has shown that contention on the ListLock guarding gFreeList
4714 // is common.  If we implement ListLock as a simple SpinLock it's common
4715 // for the JVM to devolve to yielding with little progress.  This is true
4716 // despite the fact that the critical sections protected by ListLock are
4717 // extremely short.
4718 //
4719 // TODO-FIXME: ListLock should be of type SpinLock.
4720 // We should make this a 1st-class type, integrated into the lock
4721 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4722 // should have sufficient padding to avoid false-sharing and excessive
4723 // cache-coherency traffic.
4724 
4725 
4726 typedef volatile int SpinLockT;
4727 
4728 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4729   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4730     return;   // normal fast-path return
4731   }
4732 
4733   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4734   int ctr = 0;
4735   int Yields = 0;
4736   for (;;) {
4737     while (*adr != 0) {
4738       ++ctr;
4739       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4740         if (Yields &gt; 5) {
4741           os::naked_short_sleep(1);
4742         } else {
4743           os::naked_yield();
4744           ++Yields;
4745         }
4746       } else {
4747         SpinPause();
4748       }
4749     }
4750     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4751   }
4752 }
4753 
4754 void Thread::SpinRelease(volatile int * adr) {
4755   assert(*adr != 0, "invariant");
4756   OrderAccess::fence();      // guarantee at least release consistency.
4757   // Roach-motel semantics.
4758   // It's safe if subsequent LDs and STs float "up" into the critical section,
4759   // but prior LDs and STs within the critical section can't be allowed
4760   // to reorder or float past the ST that releases the lock.
4761   // Loads and stores in the critical section - which appear in program
4762   // order before the store that releases the lock - must also appear
4763   // before the store that releases the lock in memory visibility order.
4764   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4765   // the ST of 0 into the lock-word which releases the lock, so fence
4766   // more than covers this on all platforms.
4767   *adr = 0;
4768 }
4769 
4770 // muxAcquire and muxRelease:
4771 //
4772 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4773 //    The LSB of the word is set IFF the lock is held.
4774 //    The remainder of the word points to the head of a singly-linked list
4775 //    of threads blocked on the lock.
4776 //
4777 // *  The current implementation of muxAcquire-muxRelease uses its own
4778 //    dedicated Thread._MuxEvent instance.  If we're interested in
4779 //    minimizing the peak number of extant ParkEvent instances then
4780 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4781 //    as certain invariants were satisfied.  Specifically, care would need
4782 //    to be taken with regards to consuming unpark() "permits".
4783 //    A safe rule of thumb is that a thread would never call muxAcquire()
4784 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4785 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4786 //    consume an unpark() permit intended for monitorenter, for instance.
4787 //    One way around this would be to widen the restricted-range semaphore
4788 //    implemented in park().  Another alternative would be to provide
4789 //    multiple instances of the PlatformEvent() for each thread.  One
4790 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4791 //
4792 // *  Usage:
4793 //    -- Only as leaf locks
4794 //    -- for short-term locking only as muxAcquire does not perform
4795 //       thread state transitions.
4796 //
4797 // Alternatives:
4798 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4799 //    but with parking or spin-then-park instead of pure spinning.
4800 // *  Use Taura-Oyama-Yonenzawa locks.
4801 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4802 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4803 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4804 //    acquiring threads use timers (ParkTimed) to detect and recover from
4805 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4806 //    boundaries by using placement-new.
4807 // *  Augment MCS with advisory back-link fields maintained with CAS().
4808 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4809 //    The validity of the backlinks must be ratified before we trust the value.
4810 //    If the backlinks are invalid the exiting thread must back-track through the
4811 //    the forward links, which are always trustworthy.
4812 // *  Add a successor indication.  The LockWord is currently encoded as
4813 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4814 //    to provide the usual futile-wakeup optimization.
4815 //    See RTStt for details.
4816 //
4817 
4818 
4819 const intptr_t LOCKBIT = 1;
4820 
4821 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4822   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4823   if (w == 0) return;
4824   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4825     return;
4826   }
4827 
4828   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4829   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4830   for (;;) {
4831     int its = (os::is_MP() ? 100 : 0) + 1;
4832 
4833     // Optional spin phase: spin-then-park strategy
4834     while (--its &gt;= 0) {
4835       w = *Lock;
4836       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4837         return;
4838       }
4839     }
4840 
4841     Self-&gt;reset();
4842     Self-&gt;OnList = intptr_t(Lock);
4843     // The following fence() isn't _strictly necessary as the subsequent
4844     // CAS() both serializes execution and ratifies the fetched *Lock value.
4845     OrderAccess::fence();
4846     for (;;) {
4847       w = *Lock;
4848       if ((w &amp; LOCKBIT) == 0) {
4849         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4850           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4851           return;
4852         }
4853         continue;      // Interference -- *Lock changed -- Just retry
4854       }
4855       assert(w &amp; LOCKBIT, "invariant");
4856       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4857       if (Atomic::cmpxchg(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4858     }
4859 
4860     while (Self-&gt;OnList != 0) {
4861       Self-&gt;park();
4862     }
4863   }
4864 }
4865 
4866 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4867   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4868   if (w == 0) return;
4869   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4870     return;
4871   }
4872 
4873   ParkEvent * ReleaseAfter = NULL;
4874   if (ev == NULL) {
4875     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4876   }
4877   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4878   for (;;) {
4879     guarantee(ev-&gt;OnList == 0, "invariant");
4880     int its = (os::is_MP() ? 100 : 0) + 1;
4881 
4882     // Optional spin phase: spin-then-park strategy
4883     while (--its &gt;= 0) {
4884       w = *Lock;
4885       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4886         if (ReleaseAfter != NULL) {
4887           ParkEvent::Release(ReleaseAfter);
4888         }
4889         return;
4890       }
4891     }
4892 
4893     ev-&gt;reset();
4894     ev-&gt;OnList = intptr_t(Lock);
4895     // The following fence() isn't _strictly necessary as the subsequent
4896     // CAS() both serializes execution and ratifies the fetched *Lock value.
4897     OrderAccess::fence();
4898     for (;;) {
4899       w = *Lock;
4900       if ((w &amp; LOCKBIT) == 0) {
4901         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4902           ev-&gt;OnList = 0;
4903           // We call ::Release while holding the outer lock, thus
4904           // artificially lengthening the critical section.
4905           // Consider deferring the ::Release() until the subsequent unlock(),
4906           // after we've dropped the outer lock.
4907           if (ReleaseAfter != NULL) {
4908             ParkEvent::Release(ReleaseAfter);
4909           }
4910           return;
4911         }
4912         continue;      // Interference -- *Lock changed -- Just retry
4913       }
4914       assert(w &amp; LOCKBIT, "invariant");
4915       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4916       if (Atomic::cmpxchg(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4917     }
4918 
4919     while (ev-&gt;OnList != 0) {
4920       ev-&gt;park();
4921     }
4922   }
4923 }
4924 
4925 // Release() must extract a successor from the list and then wake that thread.
4926 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4927 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4928 // Release() would :
4929 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4930 // (B) Extract a successor from the private list "in-hand"
4931 // (C) attempt to CAS() the residual back into *Lock over null.
4932 //     If there were any newly arrived threads and the CAS() would fail.
4933 //     In that case Release() would detach the RATs, re-merge the list in-hand
4934 //     with the RATs and repeat as needed.  Alternately, Release() might
4935 //     detach and extract a successor, but then pass the residual list to the wakee.
4936 //     The wakee would be responsible for reattaching and remerging before it
4937 //     competed for the lock.
4938 //
4939 // Both "pop" and DMR are immune from ABA corruption -- there can be
4940 // multiple concurrent pushers, but only one popper or detacher.
4941 // This implementation pops from the head of the list.  This is unfair,
4942 // but tends to provide excellent throughput as hot threads remain hot.
4943 // (We wake recently run threads first).
4944 //
4945 // All paths through muxRelease() will execute a CAS.
4946 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4947 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4948 // executed within the critical section are complete and globally visible before the
4949 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4950 void Thread::muxRelease(volatile intptr_t * Lock)  {
4951   for (;;) {
4952     const intptr_t w = Atomic::cmpxchg((intptr_t)0, Lock, LOCKBIT);
4953     assert(w &amp; LOCKBIT, "invariant");
4954     if (w == LOCKBIT) return;
4955     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4956     assert(List != NULL, "invariant");
4957     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4958     ParkEvent * const nxt = List-&gt;ListNext;
4959     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4960 
4961     // The following CAS() releases the lock and pops the head element.
4962     // The CAS() also ratifies the previously fetched lock-word value.
4963     if (Atomic::cmpxchg(intptr_t(nxt), Lock, w) != w) {
4964       continue;
4965     }
4966     List-&gt;OnList = 0;
4967     OrderAccess::fence();
4968     List-&gt;unpark();
4969     return;
4970   }
4971 }
4972 
4973 
4974 void Threads::verify() {
4975   ALL_JAVA_THREADS(p) {
4976     p-&gt;verify();
4977   }
4978   VMThread* thread = VMThread::vm_thread();
4979   if (thread != NULL) thread-&gt;verify();
4980 }
</pre></body></html>
