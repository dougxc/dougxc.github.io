<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre></pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "aot/aotLoader.hpp"
  28 #include "classfile/classFileParser.hpp"
  29 #include "classfile/classFileStream.hpp"
  30 #include "classfile/classLoader.hpp"
  31 #include "classfile/classLoaderData.inline.hpp"
  32 #include "classfile/javaClasses.hpp"
  33 #include "classfile/moduleEntry.hpp"
  34 #include "classfile/systemDictionary.hpp"
  35 #include "classfile/systemDictionaryShared.hpp"
  36 #include "classfile/verifier.hpp"
  37 #include "classfile/vmSymbols.hpp"
  38 #include "code/dependencyContext.hpp"
  39 #include "compiler/compileBroker.hpp"
  40 #include "gc/shared/collectedHeap.inline.hpp"
  41 #include "interpreter/oopMapCache.hpp"
  42 #include "interpreter/rewriter.hpp"
  43 #include "jvmtifiles/jvmti.h"
  44 #include "logging/log.hpp"
  45 #include "logging/logMessage.hpp"
  46 #include "logging/logStream.hpp"
  47 #include "memory/allocation.inline.hpp"
  48 #include "memory/heapInspection.hpp"
  49 #include "memory/iterator.inline.hpp"
  50 #include "memory/metadataFactory.hpp"
  51 #include "memory/metaspaceClosure.hpp"
  52 #include "memory/metaspaceShared.hpp"
  53 #include "memory/oopFactory.hpp"
  54 #include "memory/resourceArea.hpp"
  55 #include "oops/fieldStreams.hpp"
  56 #include "oops/instanceClassLoaderKlass.hpp"
  57 #include "oops/instanceKlass.inline.hpp"
  58 #include "oops/instanceMirrorKlass.hpp"
  59 #include "oops/instanceOop.hpp"
  60 #include "oops/klass.inline.hpp"
  61 #include "oops/method.hpp"
  62 #include "oops/oop.inline.hpp"
  63 #include "oops/symbol.hpp"
  64 #include "prims/jvmtiExport.hpp"
  65 #include "prims/jvmtiRedefineClasses.hpp"
  66 #include "prims/jvmtiThreadState.hpp"
  67 #include "prims/methodComparator.hpp"
  68 #include "runtime/atomic.hpp"
  69 #include "runtime/fieldDescriptor.inline.hpp"
  70 #include "runtime/handles.inline.hpp"
  71 #include "runtime/javaCalls.hpp"
  72 #include "runtime/mutexLocker.hpp"
  73 #include "runtime/orderAccess.hpp"
  74 #include "runtime/thread.inline.hpp"
  75 #include "services/classLoadingService.hpp"
  76 #include "services/threadService.hpp"
  77 #include "utilities/dtrace.hpp"
  78 #include "utilities/macros.hpp"
  79 #include "utilities/stringUtils.hpp"
  80 #ifdef COMPILER1
  81 #include "c1/c1_Compiler.hpp"
  82 #endif
  83 #if INCLUDE_JFR
  84 #include "jfr/jfrEvents.hpp"
  85 #endif
  86 
  87 
  88 #ifdef DTRACE_ENABLED
  89 
  90 
  91 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  92 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  93 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
  94 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
  95 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
  96 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
  97 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
  98 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
  99 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 100   {                                                              \
 101     char* data = NULL;                                           \
 102     int len = 0;                                                 \
 103     Symbol* clss_name = name();                                  \
 104     if (clss_name != NULL) {                                     \
 105       data = (char*)clss_name-&gt;bytes();                          \
 106       len = clss_name-&gt;utf8_length();                            \
 107     }                                                            \
 108     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 109       data, len, (void*)class_loader(), thread_type);            \
 110   }
 111 
 112 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 113   {                                                              \
 114     char* data = NULL;                                           \
 115     int len = 0;                                                 \
 116     Symbol* clss_name = name();                                  \
 117     if (clss_name != NULL) {                                     \
 118       data = (char*)clss_name-&gt;bytes();                          \
 119       len = clss_name-&gt;utf8_length();                            \
 120     }                                                            \
 121     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 122       data, len, (void*)class_loader(), thread_type, wait);      \
 123   }
 124 
 125 #else //  ndef DTRACE_ENABLED
 126 
 127 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 128 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 129 
 130 #endif //  ndef DTRACE_ENABLED
 131 
 132 static inline bool is_class_loader(const Symbol* class_name,
 133                                    const ClassFileParser&amp; parser) {
 134   assert(class_name != NULL, "invariant");
 135 
 136   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 137     return true;
 138   }
 139 
 140   if (SystemDictionary::ClassLoader_klass_loaded()) {
 141     const Klass* const super_klass = parser.super_klass();
 142     if (super_klass != NULL) {
 143       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 144         return true;
 145       }
 146     }
 147   }
 148   return false;
 149 }
 150 
 151 // called to verify that k is a member of this nest
 152 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 153   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 154     if (log_is_enabled(Trace, class, nestmates)) {
 155       ResourceMark rm(THREAD);
 156       log_trace(class, nestmates)("Checked nest membership of %s in non-nest-host class %s",
 157                                   k-&gt;external_name(), this-&gt;external_name());
 158     }
 159     return false;
 160   }
 161 
 162   if (log_is_enabled(Trace, class, nestmates)) {
 163     ResourceMark rm(THREAD);
 164     log_trace(class, nestmates)("Checking nest membership of %s in %s",
 165                                 k-&gt;external_name(), this-&gt;external_name());
 166   }
 167 
 168   // Check names first and if they match then check actual klass. This avoids
 169   // resolving anything unnecessarily.
 170   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 171     int cp_index = _nest_members-&gt;at(i);
 172     Symbol* name = _constants-&gt;klass_name_at(cp_index);
 173     if (name == k-&gt;name()) {
 174       log_trace(class, nestmates)("- Found it at nest_members[%d] =&gt; cp[%d]", i, cp_index);
 175 
 176       // names match so check actual klass - this may trigger class loading if
 177       // it doesn't match (but that should be impossible)
 178       Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 179       if (k2 == k) {
 180         log_trace(class, nestmates)("- class is listed as a nest member");
 181         return true;
 182       } else {
 183         // same name but different klass!
 184         log_trace(class, nestmates)(" - klass comparison failed!");
 185         // can't have different classes for the same name, so we're done
 186         return false;
 187       }
 188     }
 189   }
 190   log_trace(class, nestmates)("- class is NOT a nest member!");
 191   return false;
 192 }
 193 
 194 // Return nest-host class, resolving, validating and saving it if needed.
 195 // In cases where this is called from a thread that can not do classloading
 196 // (such as a native JIT thread) then we simply return NULL, which in turn
 197 // causes the access check to return false. Such code will retry the access
 198 // from a more suitable environment later.
 199 InstanceKlass* InstanceKlass::nest_host(Symbol* validationException, TRAPS) {
 200   InstanceKlass* nest_host_k = _nest_host;
 201   if (nest_host_k == NULL) {
 202     // need to resolve and save our nest-host class. This could be attempted
 203     // concurrently but as the result is idempotent and we don't use the class
 204     // then we do not need any synchronization beyond what is implicitly used
 205     // during class loading.
 206     if (_nest_host_index != 0) { // we have a real nest_host
 207       // Before trying to resolve check if we're in a suitable context
 208       if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 209         if (log_is_enabled(Trace, class, nestmates)) {
 210           ResourceMark rm(THREAD);
 211           log_trace(class, nestmates)("Rejected resolution of nest-host of %s in unsuitable thread",
 212                                       this-&gt;external_name());
 213         }
 214         return NULL;
 215       }
 216 
 217       if (log_is_enabled(Trace, class, nestmates)) {
 218         ResourceMark rm(THREAD);
 219         log_trace(class, nestmates)("Resolving nest-host of %s using cp entry for %s",
 220                                     this-&gt;external_name(),
 221                                     _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 222       }
 223 
 224       Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 225       if (HAS_PENDING_EXCEPTION) {
 226         Handle exc_h = Handle(THREAD, PENDING_EXCEPTION);
 227         if (exc_h-&gt;is_a(SystemDictionary::NoClassDefFoundError_klass())) {
 228           // throw a new CDNFE with the original as its cause, and a clear msg
 229           ResourceMark rm(THREAD);
 230           char buf[200];
 231           CLEAR_PENDING_EXCEPTION;
 232           jio_snprintf(buf, sizeof(buf),
 233                        "Unable to load nest-host class (%s) of %s",
 234                        _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string(),
 235                        this-&gt;external_name());
 236           log_trace(class, nestmates)("%s - NoClassDefFoundError", buf);
 237           THROW_MSG_CAUSE_NULL(vmSymbols::java_lang_NoClassDefFoundError(), buf, exc_h);
 238         }
 239         // All other exceptions pass through (OOME, StackOverflowError, LinkageErrors etc).
 240         return NULL;
 241       }
 242 
 243       // A valid nest-host is an instance class in the current package that lists this
 244       // class as a nest member. If any of these conditions are not met we post the
 245       // requested exception type (if any) and return NULL
 246 
 247       const char* error = NULL;
 248 
 249       // JVMS 5.4.4 indicates package check comes first
 250       if (is_same_class_package(k)) {
 251 
 252         // Now check actual membership. We can't be a member if our "host" is
 253         // not an instance class.
 254         if (k-&gt;is_instance_klass()) {
 255           nest_host_k = InstanceKlass::cast(k);
 256 
 257           bool is_member = nest_host_k-&gt;has_nest_member(this, CHECK_NULL);
 258           if (is_member) {
 259             // save resolved nest-host value
 260             _nest_host = nest_host_k;
 261 
 262             if (log_is_enabled(Trace, class, nestmates)) {
 263               ResourceMark rm(THREAD);
 264               log_trace(class, nestmates)("Resolved nest-host of %s to %s",
 265                                           this-&gt;external_name(), k-&gt;external_name());
 266             }
 267             return nest_host_k;
 268           }
 269         }
 270         error = "current type is not listed as a nest member";
 271       } else {
 272         error = "types are in different packages";
 273       }
 274 
 275       if (log_is_enabled(Trace, class, nestmates)) {
 276         ResourceMark rm(THREAD);
 277         log_trace(class, nestmates)("Type %s is not a nest member of resolved type %s: %s",
 278                                     this-&gt;external_name(),
 279                                     k-&gt;external_name(),
 280                                     error);
 281       }
 282 
 283       if (validationException != NULL) {
 284         ResourceMark rm(THREAD);
 285         Exceptions::fthrow(THREAD_AND_LOCATION,
 286                            validationException,
 287                            "Type %s is not a nest member of %s: %s",
 288                            this-&gt;external_name(),
 289                            k-&gt;external_name(),
 290                            error
 291                            );
 292       }
 293       return NULL;
 294     } else {
 295       if (log_is_enabled(Trace, class, nestmates)) {
 296         ResourceMark rm(THREAD);
 297         log_trace(class, nestmates)("Type %s is not part of a nest: setting nest-host to self",
 298                                     this-&gt;external_name());
 299       }
 300       // save resolved nest-host value
 301       return (_nest_host = this);
 302     }
 303   }
 304   return nest_host_k;
 305 }
 306 
 307 // check if 'this' and k are nestmates (same nest_host), or k is our nest_host,
 308 // or we are k's nest_host - all of which is covered by comparing the two
 309 // resolved_nest_hosts
 310 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 311 
 312   assert(this != k, "this should be handled by higher-level code");
 313 
 314   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 315   // the target class k. Resolution exceptions will be passed on by upper
 316   // layers. IncompatibleClassChangeErrors from membership validation failures
 317   // will also be passed through.
 318 
 319   Symbol* icce = vmSymbols::java_lang_IncompatibleClassChangeError();
 320   InstanceKlass* cur_host = nest_host(icce, CHECK_false);
 321   if (cur_host == NULL) {
 322     return false;
 323   }
 324 
 325   Klass* k_nest_host = k-&gt;nest_host(icce, CHECK_false);
 326   if (k_nest_host == NULL) {
 327     return false;
 328   }
 329 
 330   bool access = (cur_host == k_nest_host);
 331 
 332   if (log_is_enabled(Trace, class, nestmates)) {
 333     ResourceMark rm(THREAD);
 334     log_trace(class, nestmates)("Class %s does %shave nestmate access to %s",
 335                                 this-&gt;external_name(),
 336                                 access ? "" : "NOT ",
 337                                 k-&gt;external_name());
 338   }
 339 
 340   return access;
 341 }
 342 
 343 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 344   const int size = InstanceKlass::size(parser.vtable_size(),
 345                                        parser.itable_size(),
 346                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 347                                        parser.is_interface(),
 348                                        parser.is_unsafe_anonymous(),
 349                                        should_store_fingerprint(parser.is_unsafe_anonymous()));
 350 
 351   const Symbol* const class_name = parser.class_name();
 352   assert(class_name != NULL, "invariant");
 353   ClassLoaderData* loader_data = parser.loader_data();
 354   assert(loader_data != NULL, "invariant");
 355 
 356   InstanceKlass* ik;
 357 
 358   // Allocation
 359   if (REF_NONE == parser.reference_type()) {
 360     if (class_name == vmSymbols::java_lang_Class()) {
 361       // mirror
 362       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 363     }
 364     else if (is_class_loader(class_name, parser)) {
 365       // class loader
 366       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 367     } else {
 368       // normal
 369       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_misc_kind_other);
 370     }
 371   } else {
 372     // reference
 373     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 374   }
 375 
 376   // Check for pending exception before adding to the loader data and incrementing
 377   // class count.  Can get OOM here.
 378   if (HAS_PENDING_EXCEPTION) {
 379     return NULL;
 380   }
 381 
 382   return ik;
 383 }
 384 
 385 
 386 // copy method ordering from resource area to Metaspace
 387 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 388   if (m != NULL) {
 389     // allocate a new array and copy contents (memcpy?)
 390     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 391     for (int i = 0; i &lt; m-&gt;length(); i++) {
 392       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 393     }
 394   } else {
 395     _method_ordering = Universe::the_empty_int_array();
 396   }
 397 }
 398 
 399 // create a new array of vtable_indices for default methods
 400 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 401   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 402   assert(default_vtable_indices() == NULL, "only create once");
 403   set_default_vtable_indices(vtable_indices);
 404   return vtable_indices;
 405 }
 406 
 407 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 408   Klass(id),
 409   _nest_members(NULL),
 410   _nest_host_index(0),
 411   _nest_host(NULL),
 412   _static_field_size(parser.static_field_size()),
 413   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 414   _itable_len(parser.itable_size()),
 415   _reference_type(parser.reference_type()) {
 416     set_vtable_length(parser.vtable_size());
 417     set_kind(kind);
 418     set_access_flags(parser.access_flags());
 419     set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 420     set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 421                                                     false));
 422 
 423     assert(NULL == _methods, "underlying memory not zeroed?");
 424     assert(is_instance_klass(), "is layout incorrect?");
 425     assert(size_helper() == parser.layout_size(), "incorrect size_helper?");
 426 }
 427 
 428 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 429                                        Array&lt;Method*&gt;* methods) {
 430   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 431       !methods-&gt;is_shared()) {
 432     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 433       Method* method = methods-&gt;at(i);
 434       if (method == NULL) continue;  // maybe null if error processing
 435       // Only want to delete methods that are not executing for RedefineClasses.
 436       // The previous version will point to them so they're not totally dangling
 437       assert (!method-&gt;on_stack(), "shouldn't be called with methods on stack");
 438       MetadataFactory::free_metadata(loader_data, method);
 439     }
 440     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 441   }
 442 }
 443 
 444 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 445                                           const Klass* super_klass,
 446                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 447                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 448   // Only deallocate transitive interfaces if not empty, same as super class
 449   // or same as local interfaces.  See code in parseClassFile.
 450   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 451   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 452     // check that the interfaces don't come from super class
 453     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 454                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 455     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 456       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 457     }
 458   }
 459 
 460   // local interfaces can be empty
 461   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 462       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 463     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 464   }
 465 }
 466 
 467 // This function deallocates the metadata and C heap pointers that the
 468 // InstanceKlass points to.
 469 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 470 
 471   // Orphan the mirror first, CMS thinks it's still live.
 472   if (java_mirror() != NULL) {
 473     java_lang_Class::set_klass(java_mirror(), NULL);
 474   }
 475 
 476   // Also remove mirror from handles
 477   loader_data-&gt;remove_handle(_java_mirror);
 478 
 479   // Need to take this class off the class loader data list.
 480   loader_data-&gt;remove_class(this);
 481 
 482   // The array_klass for this class is created later, after error handling.
 483   // For class redefinition, we keep the original class so this scratch class
 484   // doesn't have an array class.  Either way, assert that there is nothing
 485   // to deallocate.
 486   assert(array_klasses() == NULL, "array classes shouldn't be created for this class yet");
 487 
 488   // Release C heap allocated data that this might point to, which includes
 489   // reference counting symbol names.
 490   release_C_heap_structures();
 491 
 492   deallocate_methods(loader_data, methods());
 493   set_methods(NULL);
 494 
 495   if (method_ordering() != NULL &amp;&amp;
 496       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 497       !method_ordering()-&gt;is_shared()) {
 498     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 499   }
 500   set_method_ordering(NULL);
 501 
 502   // default methods can be empty
 503   if (default_methods() != NULL &amp;&amp;
 504       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 505       !default_methods()-&gt;is_shared()) {
 506     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 507   }
 508   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 509   set_default_methods(NULL);
 510 
 511   // default methods vtable indices can be empty
 512   if (default_vtable_indices() != NULL &amp;&amp;
 513       !default_vtable_indices()-&gt;is_shared()) {
 514     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 515   }
 516   set_default_vtable_indices(NULL);
 517 
 518 
 519   // This array is in Klass, but remove it with the InstanceKlass since
 520   // this place would be the only caller and it can share memory with transitive
 521   // interfaces.
 522   if (secondary_supers() != NULL &amp;&amp;
 523       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 524       // see comments in compute_secondary_supers about the following cast
 525       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 526       !secondary_supers()-&gt;is_shared()) {
 527     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 528   }
 529   set_secondary_supers(NULL);
 530 
 531   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 532   set_transitive_interfaces(NULL);
 533   set_local_interfaces(NULL);
 534 
 535   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 536     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 537   }
 538   set_fields(NULL, 0);
 539 
 540   // If a method from a redefined class is using this constant pool, don't
 541   // delete it, yet.  The new class's previous version will point to this.
 542   if (constants() != NULL) {
 543     assert (!constants()-&gt;on_stack(), "shouldn't be called if anything is onstack");
 544     if (!constants()-&gt;is_shared()) {
 545       MetadataFactory::free_metadata(loader_data, constants());
 546     }
 547     // Delete any cached resolution errors for the constant pool
 548     SystemDictionary::delete_resolution_error(constants());
 549 
 550     set_constants(NULL);
 551   }
 552 
 553   if (inner_classes() != NULL &amp;&amp;
 554       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 555       !inner_classes()-&gt;is_shared()) {
 556     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 557   }
 558   set_inner_classes(NULL);
 559 
 560   if (nest_members() != NULL &amp;&amp;
 561       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 562       !nest_members()-&gt;is_shared()) {
 563     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 564   }
 565   set_nest_members(NULL);
 566 
 567   // We should deallocate the Annotations instance if it's not in shared spaces.
 568   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 569     MetadataFactory::free_metadata(loader_data, annotations());
 570   }
 571   set_annotations(NULL);
 572 }
 573 
 574 bool InstanceKlass::should_be_initialized() const {
 575   return !is_initialized();
 576 }
 577 
 578 klassItable InstanceKlass::itable() const {
 579   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 580 }
 581 
 582 void InstanceKlass::eager_initialize(Thread *thread) {
 583   if (!EagerInitialization) return;
 584 
 585   if (this-&gt;is_not_initialized()) {
 586     // abort if the the class has a class initializer
 587     if (this-&gt;class_initializer() != NULL) return;
 588 
 589     // abort if it is java.lang.Object (initialization is handled in genesis)
 590     Klass* super_klass = super();
 591     if (super_klass == NULL) return;
 592 
 593     // abort if the super class should be initialized
 594     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 595 
 596     // call body to expose the this pointer
 597     eager_initialize_impl();
 598   }
 599 }
 600 
 601 // JVMTI spec thinks there are signers and protection domain in the
 602 // instanceKlass.  These accessors pretend these fields are there.
 603 // The hprof specification also thinks these fields are in InstanceKlass.
 604 oop InstanceKlass::protection_domain() const {
 605   // return the protection_domain from the mirror
 606   return java_lang_Class::protection_domain(java_mirror());
 607 }
 608 
 609 // To remove these from requires an incompatible change and CCC request.
 610 objArrayOop InstanceKlass::signers() const {
 611   // return the signers from the mirror
 612   return java_lang_Class::signers(java_mirror());
 613 }
 614 
 615 oop InstanceKlass::init_lock() const {
 616   // return the init lock from the mirror
 617   oop lock = java_lang_Class::init_lock(java_mirror());
 618   // Prevent reordering with any access of initialization state
 619   OrderAccess::loadload();
 620   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 621          "only fully initialized state can have a null lock");
 622   return lock;
 623 }
 624 
 625 // Set the initialization lock to null so the object can be GC'ed.  Any racing
 626 // threads to get this lock will see a null lock and will not lock.
 627 // That's okay because they all check for initialized state after getting
 628 // the lock and return.
 629 void InstanceKlass::fence_and_clear_init_lock() {
 630   // make sure previous stores are all done, notably the init_state.
 631   OrderAccess::storestore();
 632   java_lang_Class::set_init_lock(java_mirror(), NULL);
 633   assert(!is_not_initialized(), "class must be initialized now");
 634 }
 635 
 636 void InstanceKlass::eager_initialize_impl() {
 637   EXCEPTION_MARK;
 638   HandleMark hm(THREAD);
 639   Handle h_init_lock(THREAD, init_lock());
 640   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 641 
 642   // abort if someone beat us to the initialization
 643   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 644 
 645   ClassState old_state = init_state();
 646   link_class_impl(THREAD);
 647   if (HAS_PENDING_EXCEPTION) {
 648     CLEAR_PENDING_EXCEPTION;
 649     // Abort if linking the class throws an exception.
 650 
 651     // Use a test to avoid redundantly resetting the state if there's
 652     // no change.  Set_init_state() asserts that state changes make
 653     // progress, whereas here we might just be spinning in place.
 654     if (old_state != _init_state)
 655       set_init_state(old_state);
 656   } else {
 657     // linking successfull, mark class as initialized
 658     set_init_state(fully_initialized);
 659     fence_and_clear_init_lock();
 660     // trace
 661     if (log_is_enabled(Info, class, init)) {
 662       ResourceMark rm(THREAD);
 663       log_info(class, init)("[Initialized %s without side effects]", external_name());
 664     }
 665   }
 666 }
 667 
 668 
 669 // See "The Virtual Machine Specification" section 2.16.5 for a detailed explanation of the class initialization
 670 // process. The step comments refers to the procedure described in that section.
 671 // Note: implementation moved to static method to expose the this pointer.
 672 void InstanceKlass::initialize(TRAPS) {
 673   if (this-&gt;should_be_initialized()) {
 674     initialize_impl(CHECK);
 675     // Note: at this point the class may be initialized
 676     //       OR it may be in the state of being initialized
 677     //       in case of recursive initialization!
 678   } else {
 679     assert(is_initialized(), "sanity check");
 680   }
 681 }
 682 
 683 
 684 bool InstanceKlass::verify_code(TRAPS) {
 685   // 1) Verify the bytecodes
 686   return Verifier::verify(this, should_verify_class(), THREAD);
 687 }
 688 
 689 void InstanceKlass::link_class(TRAPS) {
 690   assert(is_loaded(), "must be loaded");
 691   if (!is_linked()) {
 692     link_class_impl(CHECK);
 693   }
 694 }
 695 
 696 // Called to verify that a class can link during initialization, without
 697 // throwing a VerifyError.
 698 bool InstanceKlass::link_class_or_fail(TRAPS) {
 699   assert(is_loaded(), "must be loaded");
 700   if (!is_linked()) {
 701     link_class_impl(CHECK_false);
 702   }
 703   return is_linked();
 704 }
 705 
 706 bool InstanceKlass::link_class_impl(TRAPS) {
 707   if (DumpSharedSpaces &amp;&amp; is_in_error_state()) {
 708     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 709     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 710     // a convenient way to stop repeat attempts to verify the same (bad) class.
 711     //
 712     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 713     // if we are executing Java code. This is not a problem for CDS dumping phase since
 714     // it doesn't execute any Java code.
 715     ResourceMark rm(THREAD);
 716     Exceptions::fthrow(THREAD_AND_LOCATION,
 717                        vmSymbols::java_lang_NoClassDefFoundError(),
 718                        "Class %s, or one of its supertypes, failed class initialization",
 719                        external_name());
 720     return false;
 721   }
 722   // return if already verified
 723   if (is_linked()) {
 724     return true;
 725   }
 726 
 727   // Timing
 728   // timer handles recursion
 729   assert(THREAD-&gt;is_Java_thread(), "non-JavaThread in link_class_impl");
 730   JavaThread* jt = (JavaThread*)THREAD;
 731 
 732   // link super class before linking this class
 733   Klass* super_klass = super();
 734   if (super_klass != NULL) {
 735     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 736       ResourceMark rm(THREAD);
 737       Exceptions::fthrow(
 738         THREAD_AND_LOCATION,
 739         vmSymbols::java_lang_IncompatibleClassChangeError(),
 740         "class %s has interface %s as super class",
 741         external_name(),
 742         super_klass-&gt;external_name()
 743       );
 744       return false;
 745     }
 746 
 747     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 748     ik_super-&gt;link_class_impl(CHECK_false);
 749   }
 750 
 751   // link all interfaces implemented by this class before linking this class
 752   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 753   int num_interfaces = interfaces-&gt;length();
 754   for (int index = 0; index &lt; num_interfaces; index++) {
 755     InstanceKlass* interk = interfaces-&gt;at(index);
 756     interk-&gt;link_class_impl(CHECK_false);
 757   }
 758 
 759   // in case the class is linked in the process of linking its superclasses
 760   if (is_linked()) {
 761     return true;
 762   }
 763 
 764   // trace only the link time for this klass that includes
 765   // the verification time
 766   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 767                              ClassLoader::perf_class_link_selftime(),
 768                              ClassLoader::perf_classes_linked(),
 769                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 770                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 771                              PerfClassTraceTime::CLASS_LINK);
 772 
 773   // verification &amp; rewriting
 774   {
 775     HandleMark hm(THREAD);
 776     Handle h_init_lock(THREAD, init_lock());
 777     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 778     // rewritten will have been set if loader constraint error found
 779     // on an earlier link attempt
 780     // don't verify or rewrite if already rewritten
 781     //
 782 
 783     if (!is_linked()) {
 784       if (!is_rewritten()) {
 785         {
 786           bool verify_ok = verify_code(THREAD);
 787           if (!verify_ok) {
 788             return false;
 789           }
 790         }
 791 
 792         // Just in case a side-effect of verify linked this class already
 793         // (which can sometimes happen since the verifier loads classes
 794         // using custom class loaders, which are free to initialize things)
 795         if (is_linked()) {
 796           return true;
 797         }
 798 
 799         // also sets rewritten
 800         rewrite_class(CHECK_false);
 801       } else if (is_shared()) {
 802         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 803       }
 804 
 805       // relocate jsrs and link methods after they are all rewritten
 806       link_methods(CHECK_false);
 807 
 808       // Initialize the vtable and interface table after
 809       // methods have been rewritten since rewrite may
 810       // fabricate new Method*s.
 811       // also does loader constraint checking
 812       //
 813       // initialize_vtable and initialize_itable need to be rerun for
 814       // a shared class if the class is not loaded by the NULL classloader.
 815       ClassLoaderData * loader_data = class_loader_data();
 816       if (!(is_shared() &amp;&amp;
 817             loader_data-&gt;is_the_null_class_loader_data())) {
 818         vtable().initialize_vtable(true, CHECK_false);
 819         itable().initialize_itable(true, CHECK_false);
 820       }
 821 #ifdef ASSERT
 822       else {
 823         vtable().verify(tty, true);
 824         // In case itable verification is ever added.
 825         // itable().verify(tty, true);
 826       }
 827 #endif
 828       set_init_state(linked);
 829       if (JvmtiExport::should_post_class_prepare()) {
 830         Thread *thread = THREAD;
 831         assert(thread-&gt;is_Java_thread(), "thread-&gt;is_Java_thread()");
 832         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 833       }
 834     }
 835   }
 836   return true;
 837 }
 838 
 839 // Rewrite the byte codes of all of the methods of a class.
 840 // The rewriter must be called exactly once. Rewriting must happen after
 841 // verification but before the first method of the class is executed.
 842 void InstanceKlass::rewrite_class(TRAPS) {
 843   assert(is_loaded(), "must be loaded");
 844   if (is_rewritten()) {
 845     assert(is_shared(), "rewriting an unshared class?");
 846     return;
 847   }
 848   Rewriter::rewrite(this, CHECK);
 849   set_rewritten();
 850 }
 851 
 852 // Now relocate and link method entry points after class is rewritten.
 853 // This is outside is_rewritten flag. In case of an exception, it can be
 854 // executed more than once.
 855 void InstanceKlass::link_methods(TRAPS) {
 856   int len = methods()-&gt;length();
 857   for (int i = len-1; i &gt;= 0; i--) {
 858     methodHandle m(THREAD, methods()-&gt;at(i));
 859 
 860     // Set up method entry points for compiler and interpreter    .
 861     m-&gt;link_method(m, CHECK);
 862   }
 863 }
 864 
 865 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
 866 void InstanceKlass::initialize_super_interfaces(TRAPS) {
 867   assert (has_nonstatic_concrete_methods(), "caller should have checked this");
 868   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
 869     InstanceKlass* ik = local_interfaces()-&gt;at(i);
 870 
 871     // Initialization is depth first search ie. we start with top of the inheritance tree
 872     // has_nonstatic_concrete_methods drives searching superinterfaces since it
 873     // means has_nonstatic_concrete_methods in its superinterface hierarchy
 874     if (ik-&gt;has_nonstatic_concrete_methods()) {
 875       ik-&gt;initialize_super_interfaces(CHECK);
 876     }
 877 
 878     // Only initialize() interfaces that "declare" concrete methods.
 879     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
 880       ik-&gt;initialize(CHECK);
 881     }
 882   }
 883 }
 884 
 885 void InstanceKlass::initialize_impl(TRAPS) {
 886   HandleMark hm(THREAD);
 887 
 888   // Make sure klass is linked (verified) before initialization
 889   // A class could already be verified, since it has been reflected upon.
 890   link_class(CHECK);
 891 
 892   DTRACE_CLASSINIT_PROBE(required, -1);
 893 
 894   bool wait = false;
 895 
 896   // refer to the JVM book page 47 for description of steps
 897   // Step 1
 898   {
 899     Handle h_init_lock(THREAD, init_lock());
 900     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 901 
 902     Thread *self = THREAD; // it's passed the current thread
 903 
 904     // Step 2
 905     // If we were to use wait() instead of waitInterruptibly() then
 906     // we might end up throwing IE from link/symbol resolution sites
 907     // that aren't expected to throw.  This would wreak havoc.  See 6320309.
 908     while(is_being_initialized() &amp;&amp; !is_reentrant_initialization(self)) {
 909         wait = true;
 910       ol.waitUninterruptibly(CHECK);
 911     }
 912 
 913     // Step 3
 914     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(self)) {
 915       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
 916       return;
 917     }
 918 
 919     // Step 4
 920     if (is_initialized()) {
 921       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
 922       return;
 923     }
 924 
 925     // Step 5
 926     if (is_in_error_state()) {
 927       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
 928       ResourceMark rm(THREAD);
 929       const char* desc = "Could not initialize class ";
 930       const char* className = external_name();
 931       size_t msglen = strlen(desc) + strlen(className) + 1;
 932       char* message = NEW_RESOURCE_ARRAY(char, msglen);
 933       if (NULL == message) {
 934         // Out of memory: can't create detailed error message
 935           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
 936       } else {
 937         jio_snprintf(message, msglen, "%s%s", desc, className);
 938           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
 939       }
 940     }
 941 
 942     // Step 6
 943     set_init_state(being_initialized);
 944     set_init_thread(self);
 945   }
 946 
 947   // Step 7
 948   // Next, if C is a class rather than an interface, initialize it's super class and super
 949   // interfaces.
 950   if (!is_interface()) {
 951     Klass* super_klass = super();
 952     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
 953       super_klass-&gt;initialize(THREAD);
 954     }
 955     // If C implements any interface that declares a non-static, concrete method,
 956     // the initialization of C triggers initialization of its super interfaces.
 957     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
 958     // having a superinterface that declares, non-static, concrete methods
 959     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
 960       initialize_super_interfaces(THREAD);
 961     }
 962 
 963     // If any exceptions, complete abruptly, throwing the same exception as above.
 964     if (HAS_PENDING_EXCEPTION) {
 965       Handle e(THREAD, PENDING_EXCEPTION);
 966       CLEAR_PENDING_EXCEPTION;
 967       {
 968         EXCEPTION_MARK;
 969         // Locks object, set state, and notify all waiting threads
 970         set_initialization_state_and_notify(initialization_error, THREAD);
 971         CLEAR_PENDING_EXCEPTION;
 972       }
 973       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
 974       THROW_OOP(e());
 975     }
 976   }
 977 
 978 
 979   // Look for aot compiled methods for this klass, including class initializer.
 980   AOTLoader::load_for_klass(this, THREAD);
 981 
 982   // Step 8
 983   {
 984     assert(THREAD-&gt;is_Java_thread(), "non-JavaThread in initialize_impl");
 985     JavaThread* jt = (JavaThread*)THREAD;
 986     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
 987     // Timer includes any side effects of class initialization (resolution,
 988     // etc), but not recursive entry into call_class_initializer().
 989     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
 990                              ClassLoader::perf_class_init_selftime(),
 991                              ClassLoader::perf_classes_inited(),
 992                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 993                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 994                              PerfClassTraceTime::CLASS_CLINIT);
 995     call_class_initializer(THREAD);
 996   }
 997 
 998   // Step 9
 999   if (!HAS_PENDING_EXCEPTION) {
1000     set_initialization_state_and_notify(fully_initialized, CHECK);
1001     {
1002       debug_only(vtable().verify(tty, true);)
1003     }
1004   }
1005   else {
1006     // Step 10 and 11
1007     Handle e(THREAD, PENDING_EXCEPTION);
1008     CLEAR_PENDING_EXCEPTION;
1009     // JVMTI has already reported the pending exception
1010     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1011     JvmtiExport::clear_detected_exception((JavaThread*)THREAD);
1012     {
1013       EXCEPTION_MARK;
1014       set_initialization_state_and_notify(initialization_error, THREAD);
1015       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1016       // JVMTI has already reported the pending exception
1017       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1018       JvmtiExport::clear_detected_exception((JavaThread*)THREAD);
1019     }
1020     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1021     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1022       THROW_OOP(e());
1023     } else {
1024       JavaCallArguments args(e);
1025       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1026                 vmSymbols::throwable_void_signature(),
1027                 &amp;args);
1028     }
1029   }
1030   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1031 }
1032 
1033 
1034 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1035   Handle h_init_lock(THREAD, init_lock());
1036   if (h_init_lock() != NULL) {
1037     ObjectLocker ol(h_init_lock, THREAD);
1038     set_init_state(state);
1039     fence_and_clear_init_lock();
1040     ol.notify_all(CHECK);
1041   } else {
1042     assert(h_init_lock() != NULL, "The initialization state should never be set twice");
1043     set_init_state(state);
1044   }
1045 }
1046 
1047 Klass* InstanceKlass::implementor() const {
1048   assert_locked_or_safepoint(Compile_lock);
1049   Klass** k = adr_implementor();
1050   if (k == NULL) {
1051     return NULL;
1052   } else {
1053     return *k;
1054   }
1055 }
1056 
1057 void InstanceKlass::set_implementor(Klass* k) {
1058   assert_lock_strong(Compile_lock);
1059   assert(is_interface(), "not interface");
1060   Klass** addr = adr_implementor();
1061   assert(addr != NULL, "null addr");
1062   if (addr != NULL) {
1063     *addr = k;
1064   }
1065 }
1066 
1067 int  InstanceKlass::nof_implementors() const {
1068   assert_lock_strong(Compile_lock);
1069   Klass* k = implementor();
1070   if (k == NULL) {
1071     return 0;
1072   } else if (k != this) {
1073     return 1;
1074   } else {
1075     return 2;
1076   }
1077 }
1078 
1079 // The embedded _implementor field can only record one implementor.
1080 // When there are more than one implementors, the _implementor field
1081 // is set to the interface Klass* itself. Following are the possible
1082 // values for the _implementor field:
1083 //   NULL                  - no implementor
1084 //   implementor Klass*    - one implementor
1085 //   self                  - more than one implementor
1086 //
1087 // The _implementor field only exists for interfaces.
1088 void InstanceKlass::add_implementor(Klass* k) {
1089   assert_lock_strong(Compile_lock);
1090   assert(is_interface(), "not interface");
1091   // Filter out my subinterfaces.
1092   // (Note: Interfaces are never on the subklass list.)
1093   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1094 
1095   // Filter out subclasses whose supers already implement me.
1096   // (Note: CHA must walk subclasses of direct implementors
1097   // in order to locate indirect implementors.)
1098   Klass* sk = k-&gt;super();
1099   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1100     // We only need to check one immediate superclass, since the
1101     // implements_interface query looks at transitive_interfaces.
1102     // Any supers of the super have the same (or fewer) transitive_interfaces.
1103     return;
1104 
1105   Klass* ik = implementor();
1106   if (ik == NULL) {
1107     set_implementor(k);
1108   } else if (ik != this) {
1109     // There is already an implementor. Use itself as an indicator of
1110     // more than one implementors.
1111     set_implementor(this);
1112   }
1113 
1114   // The implementor also implements the transitive_interfaces
1115   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1116     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1117   }
1118 }
1119 
1120 void InstanceKlass::init_implementor() {
1121   if (is_interface()) {
1122     set_implementor(NULL);
1123   }
1124 }
1125 
1126 
1127 void InstanceKlass::process_interfaces(Thread *thread) {
1128   // link this class into the implementors list of every interface it implements
1129   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1130     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), "must be a klass");
1131     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1132     assert(interf-&gt;is_interface(), "expected interface");
1133     interf-&gt;add_implementor(this);
1134   }
1135 }
1136 
1137 bool InstanceKlass::can_be_primary_super_slow() const {
1138   if (is_interface())
1139     return false;
1140   else
1141     return Klass::can_be_primary_super_slow();
1142 }
1143 
1144 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1145                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1146   // The secondaries are the implemented interfaces.
1147   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1148   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1149   if (num_secondaries == 0) {
1150     // Must share this for correct bootstrapping!
1151     set_secondary_supers(Universe::the_empty_klass_array());
1152     return NULL;
1153   } else if (num_extra_slots == 0) {
1154     // The secondary super list is exactly the same as the transitive interfaces, so
1155     // let's use it instead of making a copy.
1156     // Redefine classes has to be careful not to delete this!
1157     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1158     // (but it's safe to do here because we won't write into _secondary_supers from this point on).
1159     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1160     return NULL;
1161   } else {
1162     // Copy transitive interfaces to a temporary growable array to be constructed
1163     // into the secondary super list with extra slots.
1164     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1165     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1166       secondaries-&gt;push(interfaces-&gt;at(i));
1167     }
1168     return secondaries;
1169   }
1170 }
1171 
1172 bool InstanceKlass::compute_is_subtype_of(Klass* k) {
1173   if (k-&gt;is_interface()) {
1174     return implements_interface(k);
1175   } else {
1176     return Klass::compute_is_subtype_of(k);
1177   }
1178 }
1179 
1180 bool InstanceKlass::implements_interface(Klass* k) const {
1181   if (this == k) return true;
1182   assert(k-&gt;is_interface(), "should be an interface class");
1183   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1184     if (transitive_interfaces()-&gt;at(i) == k) {
1185       return true;
1186     }
1187   }
1188   return false;
1189 }
1190 
1191 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1192   // Verify direct super interface
1193   if (this == k) return true;
1194   assert(k-&gt;is_interface(), "should be an interface class");
1195   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1196     if (local_interfaces()-&gt;at(i) == k) {
1197       return true;
1198     }
1199   }
1200   return false;
1201 }
1202 
1203 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
<a name="1" id="anc1"></a><span class="changed">1204   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);</span>







1205   int size = objArrayOopDesc::object_size(length);
1206   Klass* ak = array_klass(n, CHECK_NULL);
1207   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1208                                                                 /* do_zero */ true, CHECK_NULL);
1209   return o;
1210 }
1211 
1212 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1213   if (TraceFinalizerRegistration) {
1214     tty-&gt;print("Registered ");
1215     i-&gt;print_value_on(tty);
1216     tty-&gt;print_cr(" (" INTPTR_FORMAT ") as finalizable", p2i(i));
1217   }
1218   instanceHandle h_i(THREAD, i);
1219   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1220   JavaValue result(T_VOID);
1221   JavaCallArguments args(h_i);
1222   methodHandle mh (THREAD, Universe::finalizer_register_method());
1223   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1224   return h_i();
1225 }
1226 
1227 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1228   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1229   int size = size_helper();  // Query before forming handle.
1230 
1231   instanceOop i;
1232 
1233   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1234   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1235     i = register_finalizer(i, CHECK_NULL);
1236   }
1237   return i;
1238 }
1239 
1240 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1241   return instanceHandle(THREAD, allocate_instance(THREAD));
1242 }
1243 
1244 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1245   if (is_interface() || is_abstract()) {
1246     ResourceMark rm(THREAD);
1247     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1248               : vmSymbols::java_lang_InstantiationException(), external_name());
1249   }
1250   if (this == SystemDictionary::Class_klass()) {
1251     ResourceMark rm(THREAD);
1252     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1253               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1254   }
1255 }
1256 
1257 Klass* InstanceKlass::array_klass_impl(bool or_null, int n, TRAPS) {
1258   // Need load-acquire for lock-free read
1259   if (array_klasses_acquire() == NULL) {
1260     if (or_null) return NULL;
1261 
1262     ResourceMark rm;
1263     JavaThread *jt = (JavaThread *)THREAD;
1264     {
1265       // Atomic creation of array_klasses
1266       MutexLocker mc(Compile_lock, THREAD);   // for vtables
1267       MutexLocker ma(MultiArray_lock, THREAD);
1268 
1269       // Check if update has already taken place
1270       if (array_klasses() == NULL) {
1271         Klass*    k = ObjArrayKlass::allocate_objArray_klass(class_loader_data(), 1, this, CHECK_NULL);
1272         // use 'release' to pair with lock-free load
1273         release_set_array_klasses(k);
1274       }
1275     }
1276   }
1277   // _this will always be set at this point
1278   ObjArrayKlass* oak = (ObjArrayKlass*)array_klasses();
1279   if (or_null) {
1280     return oak-&gt;array_klass_or_null(n);
1281   }
1282   return oak-&gt;array_klass(n, THREAD);
1283 }
1284 
1285 Klass* InstanceKlass::array_klass_impl(bool or_null, TRAPS) {
1286   return array_klass_impl(or_null, 1, THREAD);
1287 }
1288 
1289 static int call_class_initializer_counter = 0;   // for debugging
1290 
1291 Method* InstanceKlass::class_initializer() const {
1292   Method* clinit = find_method(
1293       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1294   if (clinit != NULL &amp;&amp; clinit-&gt;has_valid_initializer_flags()) {
1295     return clinit;
1296   }
1297   return NULL;
1298 }
1299 
1300 void InstanceKlass::call_class_initializer(TRAPS) {
1301   if (ReplayCompiles &amp;&amp;
1302       (ReplaySuppressInitializers == 1 ||
1303        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1304     // Hide the existence of the initializer for the purpose of replaying the compile
1305     return;
1306   }
1307 
1308   methodHandle h_method(THREAD, class_initializer());
1309   assert(!is_initialized(), "we cannot initialize twice");
1310   LogTarget(Info, class, init) lt;
1311   if (lt.is_enabled()) {
1312     ResourceMark rm;
1313     LogStream ls(lt);
1314     ls.print("%d Initializing ", call_class_initializer_counter++);
1315     name()-&gt;print_value_on(&amp;ls);
1316     ls.print_cr("%s (" INTPTR_FORMAT ")", h_method() == NULL ? "(no method)" : "", p2i(this));
1317   }
1318   if (h_method() != NULL) {
1319     JavaCallArguments args; // No arguments
1320     JavaValue result(T_VOID);
1321     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1322   }
1323 }
1324 
1325 
1326 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1327   InterpreterOopMap* entry_for) {
1328   // Lazily create the _oop_map_cache at first request
1329   // Lock-free access requires load_acquire.
1330   OopMapCache* oop_map_cache = OrderAccess::load_acquire(&amp;_oop_map_cache);
1331   if (oop_map_cache == NULL) {
1332     MutexLocker x(OopMapCacheAlloc_lock);
1333     // Check if _oop_map_cache was allocated while we were waiting for this lock
1334     if ((oop_map_cache = _oop_map_cache) == NULL) {
1335       oop_map_cache = new OopMapCache();
1336       // Ensure _oop_map_cache is stable, since it is examined without a lock
1337       OrderAccess::release_store(&amp;_oop_map_cache, oop_map_cache);
1338     }
1339   }
1340   // _oop_map_cache is constant after init; lookup below does its own locking.
1341   oop_map_cache-&gt;lookup(method, bci, entry_for);
1342 }
1343 
1344 
1345 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1346   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1347     Symbol* f_name = fs.name();
1348     Symbol* f_sig  = fs.signature();
1349     if (f_name == name &amp;&amp; f_sig == sig) {
1350       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1351       return true;
1352     }
1353   }
1354   return false;
1355 }
1356 
1357 
1358 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1359   const int n = local_interfaces()-&gt;length();
1360   for (int i = 0; i &lt; n; i++) {
1361     Klass* intf1 = local_interfaces()-&gt;at(i);
1362     assert(intf1-&gt;is_interface(), "just checking type");
1363     // search for field in current interface
1364     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1365       assert(fd-&gt;is_static(), "interface field must be static");
1366       return intf1;
1367     }
1368     // search for field in direct superinterfaces
1369     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1370     if (intf2 != NULL) return intf2;
1371   }
1372   // otherwise field lookup fails
1373   return NULL;
1374 }
1375 
1376 
1377 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1378   // search order according to newest JVM spec (5.4.3.2, p.167).
1379   // 1) search for field in current klass
1380   if (find_local_field(name, sig, fd)) {
1381     return const_cast&lt;InstanceKlass*&gt;(this);
1382   }
1383   // 2) search for field recursively in direct superinterfaces
1384   { Klass* intf = find_interface_field(name, sig, fd);
1385     if (intf != NULL) return intf;
1386   }
1387   // 3) apply field lookup recursively if superclass exists
1388   { Klass* supr = super();
1389     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1390   }
1391   // 4) otherwise field lookup fails
1392   return NULL;
1393 }
1394 
1395 
1396 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1397   // search order according to newest JVM spec (5.4.3.2, p.167).
1398   // 1) search for field in current klass
1399   if (find_local_field(name, sig, fd)) {
1400     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1401   }
1402   // 2) search for field recursively in direct superinterfaces
1403   if (is_static) {
1404     Klass* intf = find_interface_field(name, sig, fd);
1405     if (intf != NULL) return intf;
1406   }
1407   // 3) apply field lookup recursively if superclass exists
1408   { Klass* supr = super();
1409     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1410   }
1411   // 4) otherwise field lookup fails
1412   return NULL;
1413 }
1414 
1415 
1416 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1417   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1418     if (fs.offset() == offset) {
1419       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1420       if (fd-&gt;is_static() == is_static) return true;
1421     }
1422   }
1423   return false;
1424 }
1425 
1426 
1427 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1428   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1429   while (klass != NULL) {
1430     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1431       return true;
1432     }
1433     klass = klass-&gt;super();
1434   }
1435   return false;
1436 }
1437 
1438 
1439 void InstanceKlass::methods_do(void f(Method* method)) {
1440   // Methods aren't stable until they are loaded.  This can be read outside
1441   // a lock through the ClassLoaderData for profiling
1442   if (!is_loaded()) {
1443     return;
1444   }
1445 
1446   int len = methods()-&gt;length();
1447   for (int index = 0; index &lt; len; index++) {
1448     Method* m = methods()-&gt;at(index);
1449     assert(m-&gt;is_method(), "must be method");
1450     f(m);
1451   }
1452 }
1453 
1454 
1455 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1456   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1457     if (fs.access_flags().is_static()) {
1458       fieldDescriptor&amp; fd = fs.field_descriptor();
1459       cl-&gt;do_field(&amp;fd);
1460     }
1461   }
1462 }
1463 
1464 
1465 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1466   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1467     if (fs.access_flags().is_static()) {
1468       fieldDescriptor&amp; fd = fs.field_descriptor();
1469       f(&amp;fd, mirror, CHECK);
1470     }
1471   }
1472 }
1473 
1474 
1475 static int compare_fields_by_offset(int* a, int* b) {
1476   return a[0] - b[0];
1477 }
1478 
1479 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1480   InstanceKlass* super = superklass();
1481   if (super != NULL) {
1482     super-&gt;do_nonstatic_fields(cl);
1483   }
1484   fieldDescriptor fd;
1485   int length = java_fields_count();
1486   // In DebugInfo nonstatic fields are sorted by offset.
1487   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1488   int j = 0;
1489   for (int i = 0; i &lt; length; i += 1) {
1490     fd.reinitialize(this, i);
1491     if (!fd.is_static()) {
1492       fields_sorted[j + 0] = fd.offset();
1493       fields_sorted[j + 1] = i;
1494       j += 2;
1495     }
1496   }
1497   if (j &gt; 0) {
1498     length = j;
1499     // _sort_Fn is defined in growableArray.hpp.
1500     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1501     for (int i = 0; i &lt; length; i += 2) {
1502       fd.reinitialize(this, fields_sorted[i + 1]);
1503       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], "only nonstatic fields");
1504       cl-&gt;do_field(&amp;fd);
1505     }
1506   }
1507   FREE_C_HEAP_ARRAY(int, fields_sorted);
1508 }
1509 
1510 
1511 void InstanceKlass::array_klasses_do(void f(Klass* k, TRAPS), TRAPS) {
1512   if (array_klasses() != NULL)
1513     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f, THREAD);
1514 }
1515 
1516 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1517   if (array_klasses() != NULL)
1518     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f);
1519 }
1520 
1521 #ifdef ASSERT
1522 static int linear_search(const Array&lt;Method*&gt;* methods,
1523                          const Symbol* name,
1524                          const Symbol* signature) {
1525   const int len = methods-&gt;length();
1526   for (int index = 0; index &lt; len; index++) {
1527     const Method* const m = methods-&gt;at(index);
1528     assert(m-&gt;is_method(), "must be method");
1529     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1530        return index;
1531     }
1532   }
1533   return -1;
1534 }
1535 #endif
1536 
1537 static int binary_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1538   int len = methods-&gt;length();
1539   // methods are sorted, so do binary search
1540   int l = 0;
1541   int h = len - 1;
1542   while (l &lt;= h) {
1543     int mid = (l + h) &gt;&gt; 1;
1544     Method* m = methods-&gt;at(mid);
1545     assert(m-&gt;is_method(), "must be method");
1546     int res = m-&gt;name()-&gt;fast_compare(name);
1547     if (res == 0) {
1548       return mid;
1549     } else if (res &lt; 0) {
1550       l = mid + 1;
1551     } else {
1552       h = mid - 1;
1553     }
1554   }
1555   return -1;
1556 }
1557 
1558 // find_method looks up the name/signature in the local methods array
1559 Method* InstanceKlass::find_method(const Symbol* name,
1560                                    const Symbol* signature) const {
1561   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1562 }
1563 
1564 Method* InstanceKlass::find_method_impl(const Symbol* name,
1565                                         const Symbol* signature,
1566                                         OverpassLookupMode overpass_mode,
1567                                         StaticLookupMode static_mode,
1568                                         PrivateLookupMode private_mode) const {
1569   return InstanceKlass::find_method_impl(methods(),
1570                                          name,
1571                                          signature,
1572                                          overpass_mode,
1573                                          static_mode,
1574                                          private_mode);
1575 }
1576 
1577 // find_instance_method looks up the name/signature in the local methods array
1578 // and skips over static methods
1579 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1580                                             const Symbol* name,
1581                                             const Symbol* signature,
1582                                             PrivateLookupMode private_mode) {
1583   Method* const meth = InstanceKlass::find_method_impl(methods,
1584                                                  name,
1585                                                  signature,
1586                                                  find_overpass,
1587                                                  skip_static,
1588                                                  private_mode);
1589   assert(((meth == NULL) || !meth-&gt;is_static()),
1590     "find_instance_method should have skipped statics");
1591   return meth;
1592 }
1593 
1594 // find_instance_method looks up the name/signature in the local methods array
1595 // and skips over static methods
1596 Method* InstanceKlass::find_instance_method(const Symbol* name,
1597                                             const Symbol* signature,
1598                                             PrivateLookupMode private_mode) const {
1599   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1600 }
1601 
1602 // Find looks up the name/signature in the local methods array
1603 // and filters on the overpass, static and private flags
1604 // This returns the first one found
1605 // note that the local methods array can have up to one overpass, one static
1606 // and one instance (private or not) with the same name/signature
1607 Method* InstanceKlass::find_local_method(const Symbol* name,
1608                                          const Symbol* signature,
1609                                          OverpassLookupMode overpass_mode,
1610                                          StaticLookupMode static_mode,
1611                                          PrivateLookupMode private_mode) const {
1612   return InstanceKlass::find_method_impl(methods(),
1613                                          name,
1614                                          signature,
1615                                          overpass_mode,
1616                                          static_mode,
1617                                          private_mode);
1618 }
1619 
1620 // Find looks up the name/signature in the local methods array
1621 // and filters on the overpass, static and private flags
1622 // This returns the first one found
1623 // note that the local methods array can have up to one overpass, one static
1624 // and one instance (private or not) with the same name/signature
1625 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1626                                          const Symbol* name,
1627                                          const Symbol* signature,
1628                                          OverpassLookupMode overpass_mode,
1629                                          StaticLookupMode static_mode,
1630                                          PrivateLookupMode private_mode) {
1631   return InstanceKlass::find_method_impl(methods,
1632                                          name,
1633                                          signature,
1634                                          overpass_mode,
1635                                          static_mode,
1636                                          private_mode);
1637 }
1638 
1639 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1640                                    const Symbol* name,
1641                                    const Symbol* signature) {
1642   return InstanceKlass::find_method_impl(methods,
1643                                          name,
1644                                          signature,
1645                                          find_overpass,
1646                                          find_static,
1647                                          find_private);
1648 }
1649 
1650 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1651                                         const Symbol* name,
1652                                         const Symbol* signature,
1653                                         OverpassLookupMode overpass_mode,
1654                                         StaticLookupMode static_mode,
1655                                         PrivateLookupMode private_mode) {
1656   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1657   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1658 }
1659 
1660 // true if method matches signature and conforms to skipping_X conditions.
1661 static bool method_matches(const Method* m,
1662                            const Symbol* signature,
1663                            bool skipping_overpass,
1664                            bool skipping_static,
1665                            bool skipping_private) {
1666   return ((m-&gt;signature() == signature) &amp;&amp;
1667     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1668     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1669     (!skipping_private || !m-&gt;is_private()));
1670 }
1671 
1672 // Used directly for default_methods to find the index into the
1673 // default_vtable_indices, and indirectly by find_method
1674 // find_method_index looks in the local methods array to return the index
1675 // of the matching name/signature. If, overpass methods are being ignored,
1676 // the search continues to find a potential non-overpass match.  This capability
1677 // is important during method resolution to prefer a static method, for example,
1678 // over an overpass method.
1679 // There is the possibility in any _method's array to have the same name/signature
1680 // for a static method, an overpass method and a local instance method
1681 // To correctly catch a given method, the search criteria may need
1682 // to explicitly skip the other two. For local instance methods, it
1683 // is often necessary to skip private methods
1684 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1685                                      const Symbol* name,
1686                                      const Symbol* signature,
1687                                      OverpassLookupMode overpass_mode,
1688                                      StaticLookupMode static_mode,
1689                                      PrivateLookupMode private_mode) {
1690   const bool skipping_overpass = (overpass_mode == skip_overpass);
1691   const bool skipping_static = (static_mode == skip_static);
1692   const bool skipping_private = (private_mode == skip_private);
1693   const int hit = binary_search(methods, name);
1694   if (hit != -1) {
1695     const Method* const m = methods-&gt;at(hit);
1696 
1697     // Do linear search to find matching signature.  First, quick check
1698     // for common case, ignoring overpasses if requested.
1699     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1700       return hit;
1701     }
1702 
1703     // search downwards through overloaded methods
1704     int i;
1705     for (i = hit - 1; i &gt;= 0; --i) {
1706         const Method* const m = methods-&gt;at(i);
1707         assert(m-&gt;is_method(), "must be method");
1708         if (m-&gt;name() != name) {
1709           break;
1710         }
1711         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1712           return i;
1713         }
1714     }
1715     // search upwards
1716     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1717         const Method* const m = methods-&gt;at(i);
1718         assert(m-&gt;is_method(), "must be method");
1719         if (m-&gt;name() != name) {
1720           break;
1721         }
1722         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1723           return i;
1724         }
1725     }
1726     // not found
1727 #ifdef ASSERT
1728     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1729       linear_search(methods, name, signature);
1730     assert(-1 == index, "binary search should have found entry %d", index);
1731 #endif
1732   }
1733   return -1;
1734 }
1735 
1736 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1737   return find_method_by_name(methods(), name, end);
1738 }
1739 
1740 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1741                                        const Symbol* name,
1742                                        int* end_ptr) {
1743   assert(end_ptr != NULL, "just checking");
1744   int start = binary_search(methods, name);
1745   int end = start + 1;
1746   if (start != -1) {
1747     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1748     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1749     *end_ptr = end;
1750     return start;
1751   }
1752   return -1;
1753 }
1754 
1755 // uncached_lookup_method searches both the local class methods array and all
1756 // superclasses methods arrays, skipping any overpass methods in superclasses,
1757 // and possibly skipping private methods.
1758 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1759                                               const Symbol* signature,
1760                                               OverpassLookupMode overpass_mode,
1761                                               PrivateLookupMode private_mode) const {
1762   OverpassLookupMode overpass_local_mode = overpass_mode;
1763   const Klass* klass = this;
1764   while (klass != NULL) {
1765     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1766                                                                         signature,
1767                                                                         overpass_local_mode,
1768                                                                         find_static,
1769                                                                         private_mode);
1770     if (method != NULL) {
1771       return method;
1772     }
1773     klass = klass-&gt;super();
1774     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
1775   }
1776   return NULL;
1777 }
1778 
1779 #ifdef ASSERT
1780 // search through class hierarchy and return true if this class or
1781 // one of the superclasses was redefined
1782 bool InstanceKlass::has_redefined_this_or_super() const {
1783   const Klass* klass = this;
1784   while (klass != NULL) {
1785     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
1786       return true;
1787     }
1788     klass = klass-&gt;super();
1789   }
1790   return false;
1791 }
1792 #endif
1793 
1794 // lookup a method in the default methods list then in all transitive interfaces
1795 // Do NOT return private or static methods
1796 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
1797                                                          Symbol* signature) const {
1798   Method* m = NULL;
1799   if (default_methods() != NULL) {
1800     m = find_method(default_methods(), name, signature);
1801   }
1802   // Look up interfaces
1803   if (m == NULL) {
1804     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
1805   }
1806   return m;
1807 }
1808 
1809 // lookup a method in all the interfaces that this class implements
1810 // Do NOT return private or static methods, new in JDK8 which are not externally visible
1811 // They should only be found in the initial InterfaceMethodRef
1812 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
1813                                                        Symbol* signature,
1814                                                        DefaultsLookupMode defaults_mode) const {
1815   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
1816   int num_ifs = all_ifs-&gt;length();
1817   InstanceKlass *ik = NULL;
1818   for (int i = 0; i &lt; num_ifs; i++) {
1819     ik = all_ifs-&gt;at(i);
1820     Method* m = ik-&gt;lookup_method(name, signature);
1821     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
1822         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
1823       return m;
1824     }
1825   }
1826   return NULL;
1827 }
1828 
1829 /* jni_id_for_impl for jfieldIds only */
1830 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
1831   MutexLocker ml(JfieldIdCreation_lock);
1832   // Retry lookup after we got the lock
1833   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1834   if (probe == NULL) {
1835     // Slow case, allocate new static field identifier
1836     probe = new JNIid(this, offset, jni_ids());
1837     set_jni_ids(probe);
1838   }
1839   return probe;
1840 }
1841 
1842 
1843 /* jni_id_for for jfieldIds only */
1844 JNIid* InstanceKlass::jni_id_for(int offset) {
1845   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1846   if (probe == NULL) {
1847     probe = jni_id_for_impl(offset);
1848   }
1849   return probe;
1850 }
1851 
1852 u2 InstanceKlass::enclosing_method_data(int offset) const {
1853   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
1854   if (inner_class_list == NULL) {
1855     return 0;
1856   }
1857   const int length = inner_class_list-&gt;length();
1858   if (length % inner_class_next_offset == 0) {
1859     return 0;
1860   }
1861   const int index = length - enclosing_method_attribute_size;
1862   assert(offset &lt; enclosing_method_attribute_size, "invalid offset");
1863   return inner_class_list-&gt;at(index + offset);
1864 }
1865 
1866 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
1867                                                  u2 method_index) {
1868   Array&lt;jushort&gt;* inner_class_list = inner_classes();
1869   assert (inner_class_list != NULL, "_inner_classes list is not set up");
1870   int length = inner_class_list-&gt;length();
1871   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
1872     int index = length - enclosing_method_attribute_size;
1873     inner_class_list-&gt;at_put(
1874       index + enclosing_method_class_index_offset, class_index);
1875     inner_class_list-&gt;at_put(
1876       index + enclosing_method_method_index_offset, method_index);
1877   }
1878 }
1879 
1880 // Lookup or create a jmethodID.
1881 // This code is called by the VMThread and JavaThreads so the
1882 // locking has to be done very carefully to avoid deadlocks
1883 // and/or other cache consistency problems.
1884 //
1885 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
1886   size_t idnum = (size_t)method_h-&gt;method_idnum();
1887   jmethodID* jmeths = methods_jmethod_ids_acquire();
1888   size_t length = 0;
1889   jmethodID id = NULL;
1890 
1891   // We use a double-check locking idiom here because this cache is
1892   // performance sensitive. In the normal system, this cache only
1893   // transitions from NULL to non-NULL which is safe because we use
1894   // release_set_methods_jmethod_ids() to advertise the new cache.
1895   // A partially constructed cache should never be seen by a racing
1896   // thread. We also use release_store() to save a new jmethodID
1897   // in the cache so a partially constructed jmethodID should never be
1898   // seen either. Cache reads of existing jmethodIDs proceed without a
1899   // lock, but cache writes of a new jmethodID requires uniqueness and
1900   // creation of the cache itself requires no leaks so a lock is
1901   // generally acquired in those two cases.
1902   //
1903   // If the RedefineClasses() API has been used, then this cache can
1904   // grow and we'll have transitions from non-NULL to bigger non-NULL.
1905   // Cache creation requires no leaks and we require safety between all
1906   // cache accesses and freeing of the old cache so a lock is generally
1907   // acquired when the RedefineClasses() API has been used.
1908 
1909   if (jmeths != NULL) {
1910     // the cache already exists
1911     if (!idnum_can_increment()) {
1912       // the cache can't grow so we can just get the current values
1913       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
1914     } else {
1915       // cache can grow so we have to be more careful
1916       if (Threads::number_of_threads() == 0 ||
1917           SafepointSynchronize::is_at_safepoint()) {
1918         // we're single threaded or at a safepoint - no locking needed
1919         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
1920       } else {
1921         MutexLocker ml(JmethodIdCreation_lock);
1922         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
1923       }
1924     }
1925   }
1926   // implied else:
1927   // we need to allocate a cache so default length and id values are good
1928 
1929   if (jmeths == NULL ||   // no cache yet
1930       length &lt;= idnum ||  // cache is too short
1931       id == NULL) {       // cache doesn't contain entry
1932 
1933     // This function can be called by the VMThread so we have to do all
1934     // things that might block on a safepoint before grabbing the lock.
1935     // Otherwise, we can deadlock with the VMThread or have a cache
1936     // consistency issue. These vars keep track of what we might have
1937     // to free after the lock is dropped.
1938     jmethodID  to_dealloc_id     = NULL;
1939     jmethodID* to_dealloc_jmeths = NULL;
1940 
1941     // may not allocate new_jmeths or use it if we allocate it
1942     jmethodID* new_jmeths = NULL;
1943     if (length &lt;= idnum) {
1944       // allocate a new cache that might be used
1945       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
1946       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
1947       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
1948       // cache size is stored in element[0], other elements offset by one
1949       new_jmeths[0] = (jmethodID)size;
1950     }
1951 
1952     // allocate a new jmethodID that might be used
1953     jmethodID new_id = NULL;
1954     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
1955       // The method passed in is old (but not obsolete), we need to use the current version
1956       Method* current_method = method_with_idnum((int)idnum);
1957       assert(current_method != NULL, "old and but not obsolete, so should exist");
1958       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
1959     } else {
1960       // It is the current version of the method or an obsolete method,
1961       // use the version passed in
1962       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
1963     }
1964 
1965     if (Threads::number_of_threads() == 0 ||
1966         SafepointSynchronize::is_at_safepoint()) {
1967       // we're single threaded or at a safepoint - no locking needed
1968       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
1969                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
1970     } else {
1971       MutexLocker ml(JmethodIdCreation_lock);
1972       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
1973                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
1974     }
1975 
1976     // The lock has been dropped so we can free resources.
1977     // Free up either the old cache or the new cache if we allocated one.
1978     if (to_dealloc_jmeths != NULL) {
1979       FreeHeap(to_dealloc_jmeths);
1980     }
1981     // free up the new ID since it wasn't needed
1982     if (to_dealloc_id != NULL) {
1983       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
1984     }
1985   }
1986   return id;
1987 }
1988 
1989 // Figure out how many jmethodIDs haven't been allocated, and make
1990 // sure space for them is pre-allocated.  This makes getting all
1991 // method ids much, much faster with classes with more than 8
1992 // methods, and has a *substantial* effect on performance with jvmti
1993 // code that loads all jmethodIDs for all classes.
1994 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
1995   int new_jmeths = 0;
1996   int length = methods()-&gt;length();
1997   for (int index = start_offset; index &lt; length; index++) {
1998     Method* m = methods()-&gt;at(index);
1999     jmethodID id = m-&gt;find_jmethod_id_or_null();
2000     if (id == NULL) {
2001       new_jmeths++;
2002     }
2003   }
2004   if (new_jmeths != 0) {
2005     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2006   }
2007 }
2008 
2009 // Common code to fetch the jmethodID from the cache or update the
2010 // cache with the new jmethodID. This function should never do anything
2011 // that causes the caller to go to a safepoint or we can deadlock with
2012 // the VMThread or have cache consistency issues.
2013 //
2014 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2015             size_t idnum, jmethodID new_id,
2016             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2017             jmethodID** to_dealloc_jmeths_p) {
2018   assert(new_id != NULL, "sanity check");
2019   assert(to_dealloc_id_p != NULL, "sanity check");
2020   assert(to_dealloc_jmeths_p != NULL, "sanity check");
2021   assert(Threads::number_of_threads() == 0 ||
2022          SafepointSynchronize::is_at_safepoint() ||
2023          JmethodIdCreation_lock-&gt;owned_by_self(), "sanity check");
2024 
2025   // reacquire the cache - we are locked, single threaded or at a safepoint
2026   jmethodID* jmeths = methods_jmethod_ids_acquire();
2027   jmethodID  id     = NULL;
2028   size_t     length = 0;
2029 
2030   if (jmeths == NULL ||                         // no cache yet
2031       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2032     if (jmeths != NULL) {
2033       // copy any existing entries from the old cache
2034       for (size_t index = 0; index &lt; length; index++) {
2035         new_jmeths[index+1] = jmeths[index+1];
2036       }
2037       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2038     }
2039     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2040   } else {
2041     // fetch jmethodID (if any) from the existing cache
2042     id = jmeths[idnum+1];
2043     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2044   }
2045   if (id == NULL) {
2046     // No matching jmethodID in the existing cache or we have a new
2047     // cache or we just grew the cache. This cache write is done here
2048     // by the first thread to win the foot race because a jmethodID
2049     // needs to be unique once it is generally available.
2050     id = new_id;
2051 
2052     // The jmethodID cache can be read while unlocked so we have to
2053     // make sure the new jmethodID is complete before installing it
2054     // in the cache.
2055     OrderAccess::release_store(&amp;jmeths[idnum+1], id);
2056   } else {
2057     *to_dealloc_id_p = new_id; // save new id for later delete
2058   }
2059   return id;
2060 }
2061 
2062 
2063 // Common code to get the jmethodID cache length and the jmethodID
2064 // value at index idnum if there is one.
2065 //
2066 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2067        size_t idnum, size_t *length_p, jmethodID* id_p) {
2068   assert(cache != NULL, "sanity check");
2069   assert(length_p != NULL, "sanity check");
2070   assert(id_p != NULL, "sanity check");
2071 
2072   // cache size is stored in element[0], other elements offset by one
2073   *length_p = (size_t)cache[0];
2074   if (*length_p &lt;= idnum) {  // cache is too short
2075     *id_p = NULL;
2076   } else {
2077     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2078   }
2079 }
2080 
2081 
2082 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2083 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2084   size_t idnum = (size_t)method-&gt;method_idnum();
2085   jmethodID* jmeths = methods_jmethod_ids_acquire();
2086   size_t length;                                // length assigned as debugging crumb
2087   jmethodID id = NULL;
2088   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2089       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2090     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2091   }
2092   return id;
2093 }
2094 
2095 inline DependencyContext InstanceKlass::dependencies() {
2096   DependencyContext dep_context(&amp;_dep_context);
2097   return dep_context;
2098 }
2099 
2100 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2101   return dependencies().mark_dependent_nmethods(changes);
2102 }
2103 
2104 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2105   dependencies().add_dependent_nmethod(nm);
2106 }
2107 
2108 void InstanceKlass::remove_dependent_nmethod(nmethod* nm, bool delete_immediately) {
2109   dependencies().remove_dependent_nmethod(nm, delete_immediately);
2110 }
2111 
2112 #ifndef PRODUCT
2113 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2114   dependencies().print_dependent_nmethods(verbose);
2115 }
2116 
2117 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2118   return dependencies().is_dependent_nmethod(nm);
2119 }
2120 #endif //PRODUCT
2121 
2122 void InstanceKlass::clean_weak_instanceklass_links() {
2123   clean_implementors_list();
2124   clean_method_data();
2125 
2126   // Since GC iterates InstanceKlasses sequentially, it is safe to remove stale entries here.
2127   DependencyContext dep_context(&amp;_dep_context);
2128   dep_context.expunge_stale_entries();
2129 }
2130 
2131 void InstanceKlass::clean_implementors_list() {
2132   assert(is_loader_alive(), "this klass should be live");
2133   if (is_interface()) {
2134     if (ClassUnloading) {
2135       Klass* impl = implementor();
2136       if (impl != NULL) {
2137         if (!impl-&gt;is_loader_alive()) {
2138           // remove this guy
2139           Klass** klass = adr_implementor();
2140           assert(klass != NULL, "null klass");
2141           if (klass != NULL) {
2142             *klass = NULL;
2143           }
2144         }
2145       }
2146     }
2147   }
2148 }
2149 
2150 void InstanceKlass::clean_method_data() {
2151   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2152     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2153     if (mdo != NULL) {
2154       mdo-&gt;clean_method_data(/*always_clean*/false);
2155     }
2156   }
2157 }
2158 
2159 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2160   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2161     ResourceMark rm;
2162     log_trace(class, fingerprint)("%s : super %s not fingerprinted", external_name(), java_super()-&gt;external_name());
2163     return false;
2164   }
2165 
2166   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2167   if (local_interfaces != NULL) {
2168     int length = local_interfaces-&gt;length();
2169     for (int i = 0; i &lt; length; i++) {
2170       InstanceKlass* intf = local_interfaces-&gt;at(i);
2171       if (!intf-&gt;has_passed_fingerprint_check()) {
2172         ResourceMark rm;
2173         log_trace(class, fingerprint)("%s : interface %s not fingerprinted", external_name(), intf-&gt;external_name());
2174         return false;
2175       }
2176     }
2177   }
2178 
2179   return true;
2180 }
2181 
2182 bool InstanceKlass::should_store_fingerprint(bool is_unsafe_anonymous) {
2183 #if INCLUDE_AOT
2184   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2185   if (CalculateClassFingerprint) {
2186     // (1) We are running AOT to generate a shared library.
2187     return true;
2188   }
2189   if (DumpSharedSpaces) {
2190     // (2) We are running -Xshare:dump to create a shared archive
2191     return true;
2192   }
2193   if (UseAOT &amp;&amp; is_unsafe_anonymous) {
2194     // (3) We are using AOT code from a shared library and see an unsafe anonymous class
2195     return true;
2196   }
2197 #endif
2198 
2199   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2200   // but do not store the 64-bit fingerprint to save space.
2201   return false;
2202 }
2203 
2204 bool InstanceKlass::has_stored_fingerprint() const {
2205 #if INCLUDE_AOT
2206   return should_store_fingerprint() || is_shared();
2207 #else
2208   return false;
2209 #endif
2210 }
2211 
2212 uint64_t InstanceKlass::get_stored_fingerprint() const {
2213   address adr = adr_fingerprint();
2214   if (adr != NULL) {
2215     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2216   }
2217   return 0;
2218 }
2219 
2220 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2221   address adr = adr_fingerprint();
2222   if (adr != NULL) {
2223     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2224 
2225     ResourceMark rm;
2226     log_trace(class, fingerprint)("stored as " PTR64_FORMAT " for class %s", fingerprint, external_name());
2227   }
2228 }
2229 
2230 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2231   Klass::metaspace_pointers_do(it);
2232 
2233   if (log_is_enabled(Trace, cds)) {
2234     ResourceMark rm;
2235     log_trace(cds)("Iter(InstanceKlass): %p (%s)", this, external_name());
2236   }
2237 
2238   it-&gt;push(&amp;_annotations);
2239   it-&gt;push((Klass**)&amp;_array_klasses);
2240   it-&gt;push(&amp;_constants);
2241   it-&gt;push(&amp;_inner_classes);
2242   it-&gt;push(&amp;_array_name);
2243 #if INCLUDE_JVMTI
2244   it-&gt;push(&amp;_previous_versions);
2245 #endif
2246   it-&gt;push(&amp;_methods);
2247   it-&gt;push(&amp;_default_methods);
2248   it-&gt;push(&amp;_local_interfaces);
2249   it-&gt;push(&amp;_transitive_interfaces);
2250   it-&gt;push(&amp;_method_ordering);
2251   it-&gt;push(&amp;_default_vtable_indices);
2252   it-&gt;push(&amp;_fields);
2253 
2254   if (itable_length() &gt; 0) {
2255     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2256     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2257     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2258                          / itableOffsetEntry::size();
2259 
2260     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2261       if (ioe-&gt;interface_klass() != NULL) {
2262         it-&gt;push(ioe-&gt;interface_klass_addr());
2263         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2264         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2265         for (int index = 0; index &lt; n; index ++) {
2266           it-&gt;push(ime[index].method_addr());
2267         }
2268       }
2269     }
2270   }
2271 
2272   it-&gt;push(&amp;_nest_members);
2273 }
2274 
2275 void InstanceKlass::remove_unshareable_info() {
2276   Klass::remove_unshareable_info();
2277 
2278   if (is_in_error_state()) {
2279     // Classes are attempted to link during dumping and may fail,
2280     // but these classes are still in the dictionary and class list in CLD.
2281     // Check in_error state first because in_error is &gt; linked state, so
2282     // is_linked() is true.
2283     // If there's a linking error, there is nothing else to remove.
2284     return;
2285   }
2286 
2287   // Reset to the 'allocated' state to prevent any premature accessing to
2288   // a shared class at runtime while the class is still being loaded and
2289   // restored. A class' init_state is set to 'loaded' at runtime when it's
2290   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2291   _init_state = allocated;
2292 
2293   {
2294     MutexLocker ml(Compile_lock);
2295     init_implementor();
2296   }
2297 
2298   constants()-&gt;remove_unshareable_info();
2299 
2300   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2301     Method* m = methods()-&gt;at(i);
2302     m-&gt;remove_unshareable_info();
2303   }
2304 
2305   // do array classes also.
2306   if (array_klasses() != NULL) {
2307     array_klasses()-&gt;remove_unshareable_info();
2308   }
2309 
2310   // These are not allocated from metaspace, but they should should all be empty
2311   // during dump time, so we don't need to worry about them in InstanceKlass::iterate().
2312   guarantee(_source_debug_extension == NULL, "must be");
2313   guarantee(_dep_context == DependencyContext::EMPTY, "must be");
2314   guarantee(_osr_nmethods_head == NULL, "must be");
2315 
2316 #if INCLUDE_JVMTI
2317   guarantee(_breakpoints == NULL, "must be");
2318   guarantee(_previous_versions == NULL, "must be");
2319 #endif
2320 
2321   _init_thread = NULL;
2322   _methods_jmethod_ids = NULL;
2323   _jni_ids = NULL;
2324   _oop_map_cache = NULL;
2325   // clear _nest_host to ensure re-load at runtime
2326   _nest_host = NULL;
2327 }
2328 
2329 void InstanceKlass::remove_java_mirror() {
2330   Klass::remove_java_mirror();
2331 
2332   // do array classes also.
2333   if (array_klasses() != NULL) {
2334     array_klasses()-&gt;remove_java_mirror();
2335   }
2336 }
2337 
2338 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS) {
2339   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2340   // before the InstanceKlass is added to the SystemDictionary. Make
2341   // sure the current state is &lt;loaded.
2342   assert(!is_loaded(), "invalid init state");
2343   set_package(loader_data, CHECK);
2344   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2345 
2346   Array&lt;Method*&gt;* methods = this-&gt;methods();
2347   int num_methods = methods-&gt;length();
2348   for (int index2 = 0; index2 &lt; num_methods; ++index2) {
2349     methodHandle m(THREAD, methods-&gt;at(index2));
2350     m-&gt;restore_unshareable_info(CHECK);
2351   }
2352   if (JvmtiExport::has_redefined_a_class()) {
2353     // Reinitialize vtable because RedefineClasses may have changed some
2354     // entries in this vtable for super classes so the CDS vtable might
2355     // point to old or obsolete entries.  RedefineClasses doesn't fix up
2356     // vtables in the shared system dictionary, only the main one.
2357     // It also redefines the itable too so fix that too.
2358     vtable().initialize_vtable(false, CHECK);
2359     itable().initialize_itable(false, CHECK);
2360   }
2361 
2362   // restore constant pool resolved references
2363   constants()-&gt;restore_unshareable_info(CHECK);
2364 
2365   if (array_klasses() != NULL) {
2366     // Array classes have null protection domain.
2367     // --&gt; see ArrayKlass::complete_create_array_klass()
2368     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2369   }
2370 }
2371 
2372 // returns true IFF is_in_error_state() has been changed as a result of this call.
2373 bool InstanceKlass::check_sharing_error_state() {
2374   assert(DumpSharedSpaces, "should only be called during dumping");
2375   bool old_state = is_in_error_state();
2376 
2377   if (!is_in_error_state()) {
2378     bool bad = false;
2379     for (InstanceKlass* sup = java_super(); sup; sup = sup-&gt;java_super()) {
2380       if (sup-&gt;is_in_error_state()) {
2381         bad = true;
2382         break;
2383       }
2384     }
2385     if (!bad) {
2386       Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces();
2387       for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
2388         InstanceKlass* iface = interfaces-&gt;at(i);
2389         if (iface-&gt;is_in_error_state()) {
2390           bad = true;
2391           break;
2392         }
2393       }
2394     }
2395 
2396     if (bad) {
2397       set_in_error_state();
2398     }
2399   }
2400 
2401   return (old_state != is_in_error_state());
2402 }
2403 
2404 #if INCLUDE_JVMTI
2405 static void clear_all_breakpoints(Method* m) {
2406   m-&gt;clear_all_breakpoints();
2407 }
2408 #endif
2409 
2410 void InstanceKlass::unload_class(InstanceKlass* ik) {
2411   // Release dependencies.
2412   ik-&gt;dependencies().remove_all_dependents();
2413 
2414   // notify the debugger
2415   if (JvmtiExport::should_post_class_unload()) {
2416     JvmtiExport::post_class_unload(ik);
2417   }
2418 
2419   // notify ClassLoadingService of class unload
2420   ClassLoadingService::notify_class_unloaded(ik);
2421 
2422 #if INCLUDE_JFR
2423   assert(ik != NULL, "invariant");
2424   EventClassUnload event;
2425   event.set_unloadedClass(ik);
2426   event.set_definingClassLoader(ik-&gt;class_loader_data());
2427   event.commit();
2428 #endif
2429 }
2430 
2431 void InstanceKlass::release_C_heap_structures(InstanceKlass* ik) {
2432   // Clean up C heap
2433   ik-&gt;release_C_heap_structures();
2434   ik-&gt;constants()-&gt;release_C_heap_structures();
2435 }
2436 
2437 void InstanceKlass::release_C_heap_structures() {
2438   // Can't release the constant pool here because the constant pool can be
2439   // deallocated separately from the InstanceKlass for default methods and
2440   // redefine classes.
2441 
2442   // Deallocate oop map cache
2443   if (_oop_map_cache != NULL) {
2444     delete _oop_map_cache;
2445     _oop_map_cache = NULL;
2446   }
2447 
2448   // Deallocate JNI identifiers for jfieldIDs
2449   JNIid::deallocate(jni_ids());
2450   set_jni_ids(NULL);
2451 
2452   jmethodID* jmeths = methods_jmethod_ids_acquire();
2453   if (jmeths != (jmethodID*)NULL) {
2454     release_set_methods_jmethod_ids(NULL);
2455     FreeHeap(jmeths);
2456   }
2457 
2458   assert(_dep_context == DependencyContext::EMPTY,
2459          "dependencies should already be cleaned");
2460 
2461 #if INCLUDE_JVMTI
2462   // Deallocate breakpoint records
2463   if (breakpoints() != 0x0) {
2464     methods_do(clear_all_breakpoints);
2465     assert(breakpoints() == 0x0, "should have cleared breakpoints");
2466   }
2467 
2468   // deallocate the cached class file
2469   if (_cached_class_file != NULL &amp;&amp; !MetaspaceShared::is_in_shared_metaspace(_cached_class_file)) {
2470     os::free(_cached_class_file);
2471     _cached_class_file = NULL;
2472   }
2473 #endif
2474 
2475   // Decrement symbol reference counts associated with the unloaded class.
2476   if (_name != NULL) _name-&gt;decrement_refcount();
2477   // unreference array name derived from this class name (arrays of an unloaded
2478   // class can't be referenced anymore).
2479   if (_array_name != NULL)  _array_name-&gt;decrement_refcount();
2480   if (_source_debug_extension != NULL) FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2481 }
2482 
2483 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2484   if (array == NULL) {
2485     _source_debug_extension = NULL;
2486   } else {
2487     // Adding one to the attribute length in order to store a null terminator
2488     // character could cause an overflow because the attribute length is
2489     // already coded with an u4 in the classfile, but in practice, it's
2490     // unlikely to happen.
2491     assert((length+1) &gt; length, "Overflow checking");
2492     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2493     for (int i = 0; i &lt; length; i++) {
2494       sde[i] = array[i];
2495     }
2496     sde[length] = '\0';
2497     _source_debug_extension = sde;
2498   }
2499 }
2500 
2501 const char* InstanceKlass::signature_name() const {
2502   int hash_len = 0;
2503   char hash_buf[40];
2504 
2505   // If this is an unsafe anonymous class, append a hash to make the name unique
2506   if (is_unsafe_anonymous()) {
2507     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2508     jio_snprintf(hash_buf, sizeof(hash_buf), "/" UINTX_FORMAT, (uintx)hash);
2509     hash_len = (int)strlen(hash_buf);
2510   }
2511 
2512   // Get the internal name as a c string
2513   const char* src = (const char*) (name()-&gt;as_C_string());
2514   const int src_length = (int)strlen(src);
2515 
2516   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2517 
2518   // Add L as type indicator
2519   int dest_index = 0;
2520   dest[dest_index++] = 'L';
2521 
2522   // Add the actual class name
2523   for (int src_index = 0; src_index &lt; src_length; ) {
2524     dest[dest_index++] = src[src_index++];
2525   }
2526 
2527   // If we have a hash, append it
2528   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2529     dest[dest_index++] = hash_buf[hash_index++];
2530   }
2531 
2532   // Add the semicolon and the NULL
2533   dest[dest_index++] = ';';
2534   dest[dest_index] = '\0';
2535   return dest;
2536 }
2537 
2538 // Used to obtain the package name from a fully qualified class name.
2539 Symbol* InstanceKlass::package_from_name(const Symbol* name, TRAPS) {
2540   if (name == NULL) {
2541     return NULL;
2542   } else {
2543     if (name-&gt;utf8_length() &lt;= 0) {
2544       return NULL;
2545     }
2546     ResourceMark rm;
2547     const char* package_name = ClassLoader::package_from_name((const char*) name-&gt;as_C_string());
2548     if (package_name == NULL) {
2549       return NULL;
2550     }
2551     Symbol* pkg_name = SymbolTable::new_symbol(package_name, THREAD);
2552     return pkg_name;
2553   }
2554 }
2555 
2556 ModuleEntry* InstanceKlass::module() const {
2557   // For an unsafe anonymous class return the host class' module
2558   if (is_unsafe_anonymous()) {
2559     assert(unsafe_anonymous_host() != NULL, "unsafe anonymous class must have a host class");
2560     return unsafe_anonymous_host()-&gt;module();
2561   }
2562 
2563   // Class is in a named package
2564   if (!in_unnamed_package()) {
2565     return _package_entry-&gt;module();
2566   }
2567 
2568   // Class is in an unnamed package, return its loader's unnamed module
2569   return class_loader_data()-&gt;unnamed_module();
2570 }
2571 
2572 void InstanceKlass::set_package(ClassLoaderData* loader_data, TRAPS) {
2573 
2574   // ensure java/ packages only loaded by boot or platform builtin loaders
2575   check_prohibited_package(name(), loader_data, CHECK);
2576 
2577   TempNewSymbol pkg_name = package_from_name(name(), CHECK);
2578 
2579   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2580 
2581     // Find in class loader's package entry table.
2582     _package_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2583 
2584     // If the package name is not found in the loader's package
2585     // entry table, it is an indication that the package has not
2586     // been defined. Consider it defined within the unnamed module.
2587     if (_package_entry == NULL) {
2588       ResourceMark rm;
2589 
2590       if (!ModuleEntryTable::javabase_defined()) {
2591         // Before java.base is defined during bootstrapping, define all packages in
2592         // the java.base module.  If a non-java.base package is erroneously placed
2593         // in the java.base module it will be caught later when java.base
2594         // is defined by ModuleEntryTable::verify_javabase_packages check.
2595         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME " module is NULL");
2596         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2597       } else {
2598         assert(loader_data-&gt;unnamed_module() != NULL, "unnamed module is NULL");
2599         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2600                                                          loader_data-&gt;unnamed_module());
2601       }
2602 
2603       // A package should have been successfully created
2604       assert(_package_entry != NULL, "Package entry for class %s not found, loader %s",
2605              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2606     }
2607 
2608     if (log_is_enabled(Debug, module)) {
2609       ResourceMark rm;
2610       ModuleEntry* m = _package_entry-&gt;module();
2611       log_trace(module)("Setting package: class: %s, package: %s, loader: %s, module: %s",
2612                         external_name(),
2613                         pkg_name-&gt;as_C_string(),
2614                         loader_data-&gt;loader_name_and_id(),
2615                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2616     }
2617   } else {
2618     ResourceMark rm;
2619     log_trace(module)("Setting package: class: %s, package: unnamed, loader: %s, module: %s",
2620                       external_name(),
2621                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : "NULL",
2622                       UNNAMED_MODULE);
2623   }
2624 }
2625 
2626 
2627 // different versions of is_same_class_package
2628 
2629 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2630   oop classloader1 = this-&gt;class_loader();
2631   PackageEntry* classpkg1 = this-&gt;package();
2632   if (class2-&gt;is_objArray_klass()) {
2633     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2634   }
2635 
2636   oop classloader2;
2637   PackageEntry* classpkg2;
2638   if (class2-&gt;is_instance_klass()) {
2639     classloader2 = class2-&gt;class_loader();
2640     classpkg2 = class2-&gt;package();
2641   } else {
2642     assert(class2-&gt;is_typeArray_klass(), "should be type array");
2643     classloader2 = NULL;
2644     classpkg2 = NULL;
2645   }
2646 
2647   // Same package is determined by comparing class loader
2648   // and package entries. Both must be the same. This rule
2649   // applies even to classes that are defined in the unnamed
2650   // package, they still must have the same class loader.
2651   if (oopDesc::equals(classloader1, classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2652     return true;
2653   }
2654 
2655   return false;
2656 }
2657 
2658 // return true if this class and other_class are in the same package. Classloader
2659 // and classname information is enough to determine a class's package
2660 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2661                                           const Symbol* other_class_name) const {
2662   if (!oopDesc::equals(class_loader(), other_class_loader)) {
2663     return false;
2664   }
2665   if (name()-&gt;fast_compare(other_class_name) == 0) {
2666      return true;
2667   }
2668 
2669   {
2670     ResourceMark rm;
2671 
2672     bool bad_class_name = false;
2673     const char* other_pkg =
2674       ClassLoader::package_from_name((const char*) other_class_name-&gt;as_C_string(), &amp;bad_class_name);
2675     if (bad_class_name) {
2676       return false;
2677     }
2678     // Check that package_from_name() returns NULL, not "", if there is no package.
2679     assert(other_pkg == NULL || strlen(other_pkg) &gt; 0, "package name is empty string");
2680 
2681     const Symbol* const this_package_name =
2682       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2683 
2684     if (this_package_name == NULL || other_pkg == NULL) {
2685       // One of the two doesn't have a package.  Only return true if the other
2686       // one also doesn't have a package.
2687       return (const char*)this_package_name == other_pkg;
2688     }
2689 
2690     // Check if package is identical
2691     return this_package_name-&gt;equals(other_pkg);
2692   }
2693 }
2694 
2695 // Returns true iff super_method can be overridden by a method in targetclassname
2696 // See JLS 3rd edition 8.4.6.1
2697 // Assumes name-signature match
2698 // "this" is InstanceKlass of super_method which must exist
2699 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2700 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2701    // Private methods can not be overridden
2702    if (super_method-&gt;is_private()) {
2703      return false;
2704    }
2705    // If super method is accessible, then override
2706    if ((super_method-&gt;is_protected()) ||
2707        (super_method-&gt;is_public())) {
2708      return true;
2709    }
2710    // Package-private methods are not inherited outside of package
2711    assert(super_method-&gt;is_package_private(), "must be package private");
2712    return(is_same_class_package(targetclassloader(), targetclassname));
2713 }
2714 
2715 // Only boot and platform class loaders can define classes in "java/" packages.
2716 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2717                                              ClassLoaderData* loader_data,
2718                                              TRAPS) {
2719   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2720       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2721       class_name != NULL) {
2722     ResourceMark rm(THREAD);
2723     char* name = class_name-&gt;as_C_string();
2724     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == '/') {
2725       TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK);
2726       assert(pkg_name != NULL, "Error in parsing package name starting with 'java/'");
2727       name = pkg_name-&gt;as_C_string();
2728       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2729       StringUtils::replace_no_expand(name, "/", ".");
2730       const char* msg_text1 = "Class loader (instance of): ";
2731       const char* msg_text2 = " tried to load prohibited package name: ";
2732       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2733       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2734       jio_snprintf(message, len, "%s%s%s%s", msg_text1, class_loader_name, msg_text2, name);
2735       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2736     }
2737   }
2738   return;
2739 }
2740 
2741 // tell if two classes have the same enclosing class (at package level)
2742 bool InstanceKlass::is_same_package_member(const Klass* class2, TRAPS) const {
2743   if (class2 == this) return true;
2744   if (!class2-&gt;is_instance_klass())  return false;
2745 
2746   // must be in same package before we try anything else
2747   if (!is_same_class_package(class2))
2748     return false;
2749 
2750   // As long as there is an outer_this.getEnclosingClass,
2751   // shift the search outward.
2752   const InstanceKlass* outer_this = this;
2753   for (;;) {
2754     // As we walk along, look for equalities between outer_this and class2.
2755     // Eventually, the walks will terminate as outer_this stops
2756     // at the top-level class around the original class.
2757     bool ignore_inner_is_member;
2758     const Klass* next = outer_this-&gt;compute_enclosing_class(&amp;ignore_inner_is_member,
2759                                                             CHECK_false);
2760     if (next == NULL)  break;
2761     if (next == class2)  return true;
2762     outer_this = InstanceKlass::cast(next);
2763   }
2764 
2765   // Now do the same for class2.
2766   const InstanceKlass* outer2 = InstanceKlass::cast(class2);
2767   for (;;) {
2768     bool ignore_inner_is_member;
2769     Klass* next = outer2-&gt;compute_enclosing_class(&amp;ignore_inner_is_member,
2770                                                     CHECK_false);
2771     if (next == NULL)  break;
2772     // Might as well check the new outer against all available values.
2773     if (next == this)  return true;
2774     if (next == outer_this)  return true;
2775     outer2 = InstanceKlass::cast(next);
2776   }
2777 
2778   // If by this point we have not found an equality between the
2779   // two classes, we know they are in separate package members.
2780   return false;
2781 }
2782 
2783 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2784   constantPoolHandle i_cp(THREAD, constants());
2785   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2786     int ioff = iter.inner_class_info_index();
2787     if (ioff != 0) {
2788       // Check to see if the name matches the class we're looking for
2789       // before attempting to find the class.
2790       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
2791         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
2792         if (this == inner_klass) {
2793           *ooff = iter.outer_class_info_index();
2794           *noff = iter.inner_name_index();
2795           return true;
2796         }
2797       }
2798     }
2799   }
2800   return false;
2801 }
2802 
2803 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
2804   InstanceKlass* outer_klass = NULL;
2805   *inner_is_member = false;
2806   int ooff = 0, noff = 0;
2807   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
2808   if (has_inner_classes_attr) {
2809     constantPoolHandle i_cp(THREAD, constants());
2810     if (ooff != 0) {
2811       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
2812       outer_klass = InstanceKlass::cast(ok);
2813       *inner_is_member = true;
2814     }
2815     if (NULL == outer_klass) {
2816       // It may be unsafe anonymous; try for that.
2817       int encl_method_class_idx = enclosing_method_class_index();
2818       if (encl_method_class_idx != 0) {
2819         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
2820         outer_klass = InstanceKlass::cast(ok);
2821         *inner_is_member = false;
2822       }
2823     }
2824   }
2825 
2826   // If no inner class attribute found for this class.
2827   if (NULL == outer_klass) return NULL;
2828 
2829   // Throws an exception if outer klass has not declared k as an inner klass
2830   // We need evidence that each klass knows about the other, or else
2831   // the system could allow a spoof of an inner class to gain access rights.
2832   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
2833   return outer_klass;
2834 }
2835 
2836 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
2837   jint access = access_flags().as_int();
2838 
2839   // But check if it happens to be member class.
2840   InnerClassesIterator iter(this);
2841   for (; !iter.done(); iter.next()) {
2842     int ioff = iter.inner_class_info_index();
2843     // Inner class attribute can be zero, skip it.
2844     // Strange but true:  JVM spec. allows null inner class refs.
2845     if (ioff == 0) continue;
2846 
2847     // only look at classes that are already loaded
2848     // since we are looking for the flags for our self.
2849     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
2850     if (name() == inner_name) {
2851       // This is really a member class.
2852       access = iter.inner_access_flags();
2853       break;
2854     }
2855   }
2856   // Remember to strip ACC_SUPER bit
2857   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
2858 }
2859 
2860 jint InstanceKlass::jvmti_class_status() const {
2861   jint result = 0;
2862 
2863   if (is_linked()) {
2864     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
2865   }
2866 
2867   if (is_initialized()) {
2868     assert(is_linked(), "Class status is not consistent");
2869     result |= JVMTI_CLASS_STATUS_INITIALIZED;
2870   }
2871   if (is_in_error_state()) {
2872     result |= JVMTI_CLASS_STATUS_ERROR;
2873   }
2874   return result;
2875 }
2876 
2877 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
2878   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2879   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2880   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2881                        / itableOffsetEntry::size();
2882 
2883   for (int cnt = 0 ; ; cnt ++, ioe ++) {
2884     // If the interface isn't implemented by the receiver class,
2885     // the VM should throw IncompatibleClassChangeError.
2886     if (cnt &gt;= nof_interfaces) {
2887       ResourceMark rm(THREAD);
2888       stringStream ss;
2889       bool same_module = (module() == holder-&gt;module());
2890       ss.print("Receiver class %s does not implement "
2891                "the interface %s defining the method to be called "
2892                "(%s%s%s)",
2893                external_name(), holder-&gt;external_name(),
2894                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
2895                (same_module) ? "" : "; ",
2896                (same_module) ? "" : holder-&gt;class_in_module_of_loader());
2897       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
2898     }
2899 
2900     Klass* ik = ioe-&gt;interface_klass();
2901     if (ik == holder) break;
2902   }
2903 
2904   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2905   Method* m = ime[index].method();
2906   if (m == NULL) {
2907     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
2908   }
2909   return m;
2910 }
2911 
2912 
2913 #if INCLUDE_JVMTI
2914 // update default_methods for redefineclasses for methods that are
2915 // not yet in the vtable due to concurrent subclass define and superinterface
2916 // redefinition
2917 // Note: those in the vtable, should have been updated via adjust_method_entries
2918 void InstanceKlass::adjust_default_methods(InstanceKlass* holder, bool* trace_name_printed) {
2919   // search the default_methods for uses of either obsolete or EMCP methods
2920   if (default_methods() != NULL) {
2921     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
2922       Method* old_method = default_methods()-&gt;at(index);
2923       if (old_method == NULL || old_method-&gt;method_holder() != holder || !old_method-&gt;is_old()) {
2924         continue; // skip uninteresting entries
2925       }
2926       assert(!old_method-&gt;is_deleted(), "default methods may not be deleted");
2927 
2928       Method* new_method = holder-&gt;method_with_idnum(old_method-&gt;orig_method_idnum());
2929 
2930       assert(new_method != NULL, "method_with_idnum() should not be NULL");
2931       assert(old_method != new_method, "sanity check");
2932 
2933       default_methods()-&gt;at_put(index, new_method);
2934       if (log_is_enabled(Info, redefine, class, update)) {
2935         ResourceMark rm;
2936         if (!(*trace_name_printed)) {
2937           log_info(redefine, class, update)
2938             ("adjust: klassname=%s default methods from name=%s",
2939              external_name(), old_method-&gt;method_holder()-&gt;external_name());
2940           *trace_name_printed = true;
2941         }
2942         log_debug(redefine, class, update, vtables)
2943           ("default method update: %s(%s) ",
2944            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
2945       }
2946     }
2947   }
2948 }
2949 #endif // INCLUDE_JVMTI
2950 
2951 // On-stack replacement stuff
2952 void InstanceKlass::add_osr_nmethod(nmethod* n) {
2953   // only one compilation can be active
2954   {
2955     // This is a short non-blocking critical region, so the no safepoint check is ok.
2956     MutexLockerEx ml(OsrList_lock, Mutex::_no_safepoint_check_flag);
2957     assert(n-&gt;is_osr_method(), "wrong kind of nmethod");
2958     n-&gt;set_osr_link(osr_nmethods_head());
2959     set_osr_nmethods_head(n);
2960     // Raise the highest osr level if necessary
2961     if (TieredCompilation) {
2962       Method* m = n-&gt;method();
2963       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
2964     }
2965   }
2966 
2967   // Get rid of the osr methods for the same bci that have lower levels.
2968   if (TieredCompilation) {
2969     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
2970       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
2971       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
2972         inv-&gt;make_not_entrant();
2973       }
2974     }
2975   }
2976 }
2977 
2978 // Remove osr nmethod from the list. Return true if found and removed.
2979 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
2980   // This is a short non-blocking critical region, so the no safepoint check is ok.
2981   MutexLockerEx ml(OsrList_lock, Mutex::_no_safepoint_check_flag);
2982   assert(n-&gt;is_osr_method(), "wrong kind of nmethod");
2983   nmethod* last = NULL;
2984   nmethod* cur  = osr_nmethods_head();
2985   int max_level = CompLevel_none;  // Find the max comp level excluding n
2986   Method* m = n-&gt;method();
2987   // Search for match
2988   bool found = false;
2989   while(cur != NULL &amp;&amp; cur != n) {
2990     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
2991       // Find max level before n
2992       max_level = MAX2(max_level, cur-&gt;comp_level());
2993     }
2994     last = cur;
2995     cur = cur-&gt;osr_link();
2996   }
2997   nmethod* next = NULL;
2998   if (cur == n) {
2999     found = true;
3000     next = cur-&gt;osr_link();
3001     if (last == NULL) {
3002       // Remove first element
3003       set_osr_nmethods_head(next);
3004     } else {
3005       last-&gt;set_osr_link(next);
3006     }
3007   }
3008   n-&gt;set_osr_link(NULL);
3009   if (TieredCompilation) {
3010     cur = next;
3011     while (cur != NULL) {
3012       // Find max level after n
3013       if (m == cur-&gt;method()) {
3014         max_level = MAX2(max_level, cur-&gt;comp_level());
3015       }
3016       cur = cur-&gt;osr_link();
3017     }
3018     m-&gt;set_highest_osr_comp_level(max_level);
3019   }
3020   return found;
3021 }
3022 
3023 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3024   // This is a short non-blocking critical region, so the no safepoint check is ok.
3025   MutexLockerEx ml(OsrList_lock, Mutex::_no_safepoint_check_flag);
3026   nmethod* osr = osr_nmethods_head();
3027   int found = 0;
3028   while (osr != NULL) {
3029     assert(osr-&gt;is_osr_method(), "wrong kind of nmethod found in chain");
3030     if (osr-&gt;method() == m) {
3031       osr-&gt;mark_for_deoptimization();
3032       found++;
3033     }
3034     osr = osr-&gt;osr_link();
3035   }
3036   return found;
3037 }
3038 
3039 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3040   // This is a short non-blocking critical region, so the no safepoint check is ok.
3041   MutexLockerEx ml(OsrList_lock, Mutex::_no_safepoint_check_flag);
3042   nmethod* osr = osr_nmethods_head();
3043   nmethod* best = NULL;
3044   while (osr != NULL) {
3045     assert(osr-&gt;is_osr_method(), "wrong kind of nmethod found in chain");
3046     // There can be a time when a c1 osr method exists but we are waiting
3047     // for a c2 version. When c2 completes its osr nmethod we will trash
3048     // the c1 version and only be able to find the c2 version. However
3049     // while we overflow in the c1 code at back branches we don't want to
3050     // try and switch to the same code as we are already running
3051 
3052     if (osr-&gt;method() == m &amp;&amp;
3053         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3054       if (match_level) {
3055         if (osr-&gt;comp_level() == comp_level) {
3056           // Found a match - return it.
3057           return osr;
3058         }
3059       } else {
3060         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3061           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3062             // Found the best possible - return it.
3063             return osr;
3064           }
3065           best = osr;
3066         }
3067       }
3068     }
3069     osr = osr-&gt;osr_link();
3070   }
3071   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level &amp;&amp; match_level == false) {
3072     return best;
3073   }
3074   return NULL;
3075 }
3076 
3077 // -----------------------------------------------------------------------------------------------------
3078 // Printing
3079 
3080 #ifndef PRODUCT
3081 
3082 #define BULLET  " - "
3083 
3084 static const char* state_names[] = {
3085   "allocated", "loaded", "linked", "being_initialized", "fully_initialized", "initialization_error"
3086 };
3087 
3088 static void print_vtable(intptr_t* start, int len, outputStream* st) {
3089   for (int i = 0; i &lt; len; i++) {
3090     intptr_t e = start[i];
3091     st-&gt;print("%d : " INTPTR_FORMAT, i, e);
3092     if (e != 0 &amp;&amp; ((Metadata*)e)-&gt;is_metaspace_object()) {
3093       st-&gt;print(" ");
3094       ((Metadata*)e)-&gt;print_value_on(st);
3095     }
3096     st-&gt;cr();
3097   }
3098 }
3099 
3100 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3101   return print_vtable(reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3102 }
3103 
3104 void InstanceKlass::print_on(outputStream* st) const {
3105   assert(is_klass(), "must be klass");
3106   Klass::print_on(st);
3107 
3108   st-&gt;print(BULLET"instance size:     %d", size_helper());                        st-&gt;cr();
3109   st-&gt;print(BULLET"klass size:        %d", size());                               st-&gt;cr();
3110   st-&gt;print(BULLET"access:            "); access_flags().print_on(st);            st-&gt;cr();
3111   st-&gt;print(BULLET"state:             "); st-&gt;print_cr("%s", state_names[_init_state]);
3112   st-&gt;print(BULLET"name:              "); name()-&gt;print_value_on(st);             st-&gt;cr();
3113   st-&gt;print(BULLET"super:             "); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3114   st-&gt;print(BULLET"sub:               ");
3115   Klass* sub = subklass();
3116   int n;
3117   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3118     if (n &lt; MaxSubklassPrintSize) {
3119       sub-&gt;print_value_on(st);
3120       st-&gt;print("   ");
3121     }
3122   }
3123   if (n &gt;= MaxSubklassPrintSize) st-&gt;print("(" INTX_FORMAT " more klasses...)", n - MaxSubklassPrintSize);
3124   st-&gt;cr();
3125 
3126   if (is_interface()) {
3127     MutexLocker ml(Compile_lock);
3128     st-&gt;print_cr(BULLET"nof implementors:  %d", nof_implementors());
3129     if (nof_implementors() == 1) {
3130       st-&gt;print_cr(BULLET"implementor:    ");
3131       st-&gt;print("   ");
3132       implementor()-&gt;print_value_on(st);
3133       st-&gt;cr();
3134     }
3135   }
3136 
3137   st-&gt;print(BULLET"arrays:            "); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3138   st-&gt;print(BULLET"methods:           "); methods()-&gt;print_value_on(st);                  st-&gt;cr();
3139   if (Verbose || WizardMode) {
3140     Array&lt;Method*&gt;* method_array = methods();
3141     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3142       st-&gt;print("%d : ", i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3143     }
3144   }
3145   st-&gt;print(BULLET"method ordering:   "); method_ordering()-&gt;print_value_on(st);      st-&gt;cr();
3146   st-&gt;print(BULLET"default_methods:   "); default_methods()-&gt;print_value_on(st);      st-&gt;cr();
3147   if (Verbose &amp;&amp; default_methods() != NULL) {
3148     Array&lt;Method*&gt;* method_array = default_methods();
3149     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3150       st-&gt;print("%d : ", i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3151     }
3152   }
3153   if (default_vtable_indices() != NULL) {
3154     st-&gt;print(BULLET"default vtable indices:   "); default_vtable_indices()-&gt;print_value_on(st);       st-&gt;cr();
3155   }
3156   st-&gt;print(BULLET"local interfaces:  "); local_interfaces()-&gt;print_value_on(st);      st-&gt;cr();
3157   st-&gt;print(BULLET"trans. interfaces: "); transitive_interfaces()-&gt;print_value_on(st); st-&gt;cr();
3158   st-&gt;print(BULLET"constants:         "); constants()-&gt;print_value_on(st);         st-&gt;cr();
3159   if (class_loader_data() != NULL) {
3160     st-&gt;print(BULLET"class loader data:  ");
3161     class_loader_data()-&gt;print_value_on(st);
3162     st-&gt;cr();
3163   }
3164   st-&gt;print(BULLET"unsafe anonymous host class:        "); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3165   if (source_file_name() != NULL) {
3166     st-&gt;print(BULLET"source file:       ");
3167     source_file_name()-&gt;print_value_on(st);
3168     st-&gt;cr();
3169   }
3170   if (source_debug_extension() != NULL) {
3171     st-&gt;print(BULLET"source debug extension:       ");
3172     st-&gt;print("%s", source_debug_extension());
3173     st-&gt;cr();
3174   }
3175   st-&gt;print(BULLET"class annotations:       "); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3176   st-&gt;print(BULLET"class type annotations:  "); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3177   st-&gt;print(BULLET"field annotations:       "); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3178   st-&gt;print(BULLET"field type annotations:  "); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3179   {
3180     bool have_pv = false;
3181     // previous versions are linked together through the InstanceKlass
3182     for (InstanceKlass* pv_node = previous_versions();
3183          pv_node != NULL;
3184          pv_node = pv_node-&gt;previous_versions()) {
3185       if (!have_pv)
3186         st-&gt;print(BULLET"previous version:  ");
3187       have_pv = true;
3188       pv_node-&gt;constants()-&gt;print_value_on(st);
3189     }
3190     if (have_pv) st-&gt;cr();
3191   }
3192 
3193   if (generic_signature() != NULL) {
3194     st-&gt;print(BULLET"generic signature: ");
3195     generic_signature()-&gt;print_value_on(st);
3196     st-&gt;cr();
3197   }
3198   st-&gt;print(BULLET"inner classes:     "); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3199   st-&gt;print(BULLET"nest members:     "); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3200   if (java_mirror() != NULL) {
3201     st-&gt;print(BULLET"java mirror:       ");
3202     java_mirror()-&gt;print_value_on(st);
3203     st-&gt;cr();
3204   } else {
3205     st-&gt;print_cr(BULLET"java mirror:       NULL");
3206   }
3207   st-&gt;print(BULLET"vtable length      %d  (start addr: " INTPTR_FORMAT ")", vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3208   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3209   st-&gt;print(BULLET"itable length      %d (start addr: " INTPTR_FORMAT ")", itable_length(), p2i(start_of_itable())); st-&gt;cr();
3210   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_itable(), itable_length(), st);
3211   st-&gt;print_cr(BULLET"---- static fields (%d words):", static_field_size());
3212   FieldPrinter print_static_field(st);
3213   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3214   st-&gt;print_cr(BULLET"---- non-static fields (%d words):", nonstatic_field_size());
3215   FieldPrinter print_nonstatic_field(st);
3216   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3217   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3218 
3219   st-&gt;print(BULLET"non-static oop maps: ");
3220   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3221   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3222   while (map &lt; end_map) {
3223     st-&gt;print("%d-%d ", map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3224     map++;
3225   }
3226   st-&gt;cr();
3227 }
3228 
3229 #endif //PRODUCT
3230 
3231 void InstanceKlass::print_value_on(outputStream* st) const {
3232   assert(is_klass(), "must be klass");
3233   if (Verbose || WizardMode)  access_flags().print_on(st);
3234   name()-&gt;print_value_on(st);
3235 }
3236 
3237 #ifndef PRODUCT
3238 
3239 void FieldPrinter::do_field(fieldDescriptor* fd) {
3240   _st-&gt;print(BULLET);
3241    if (_obj == NULL) {
3242      fd-&gt;print_on(_st);
3243      _st-&gt;cr();
3244    } else {
3245      fd-&gt;print_on_for(_st, _obj);
3246      _st-&gt;cr();
3247    }
3248 }
3249 
3250 
3251 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3252   Klass::oop_print_on(obj, st);
3253 
3254   if (this == SystemDictionary::String_klass()) {
3255     typeArrayOop value  = java_lang_String::value(obj);
3256     juint        length = java_lang_String::length(obj);
3257     if (value != NULL &amp;&amp;
3258         value-&gt;is_typeArray() &amp;&amp;
3259         length &lt;= (juint) value-&gt;length()) {
3260       st-&gt;print(BULLET"string: ");
3261       java_lang_String::print(obj, st);
3262       st-&gt;cr();
3263       if (!WizardMode)  return;  // that is enough
3264     }
3265   }
3266 
3267   st-&gt;print_cr(BULLET"---- fields (total size %d words):", oop_size(obj));
3268   FieldPrinter print_field(st, obj);
3269   do_nonstatic_fields(&amp;print_field);
3270 
3271   if (this == SystemDictionary::Class_klass()) {
3272     st-&gt;print(BULLET"signature: ");
3273     java_lang_Class::print_signature(obj, st);
3274     st-&gt;cr();
3275     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3276     st-&gt;print(BULLET"fake entry for mirror: ");
3277     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3278     st-&gt;cr();
3279     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3280     st-&gt;print(BULLET"fake entry for array: ");
3281     Metadata::print_value_on_maybe_null(st, array_klass);
3282     st-&gt;cr();
3283     st-&gt;print_cr(BULLET"fake entry for oop_size: %d", java_lang_Class::oop_size(obj));
3284     st-&gt;print_cr(BULLET"fake entry for static_oop_field_count: %d", java_lang_Class::static_oop_field_count(obj));
3285     Klass* real_klass = java_lang_Class::as_Klass(obj);
3286     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3287       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3288     }
3289   } else if (this == SystemDictionary::MethodType_klass()) {
3290     st-&gt;print(BULLET"signature: ");
3291     java_lang_invoke_MethodType::print_signature(obj, st);
3292     st-&gt;cr();
3293   }
3294 }
3295 
3296 bool InstanceKlass::verify_itable_index(int i) {
3297   int method_count = klassItable::method_count_for_interface(this);
3298   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, "index out of bounds");
3299   return true;
3300 }
3301 
3302 #endif //PRODUCT
3303 
3304 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3305   st-&gt;print("a ");
3306   name()-&gt;print_value_on(st);
3307   obj-&gt;print_address_on(st);
3308   if (this == SystemDictionary::String_klass()
3309       &amp;&amp; java_lang_String::value(obj) != NULL) {
3310     ResourceMark rm;
3311     int len = java_lang_String::length(obj);
3312     int plen = (len &lt; 24 ? len : 12);
3313     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3314     st-&gt;print(" = \"%s\"", str);
3315     if (len &gt; plen)
3316       st-&gt;print("...[%d]", len);
3317   } else if (this == SystemDictionary::Class_klass()) {
3318     Klass* k = java_lang_Class::as_Klass(obj);
3319     st-&gt;print(" = ");
3320     if (k != NULL) {
3321       k-&gt;print_value_on(st);
3322     } else {
3323       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3324       st-&gt;print("%s", tname ? tname : "type?");
3325     }
3326   } else if (this == SystemDictionary::MethodType_klass()) {
3327     st-&gt;print(" = ");
3328     java_lang_invoke_MethodType::print_signature(obj, st);
3329   } else if (java_lang_boxing_object::is_instance(obj)) {
3330     st-&gt;print(" = ");
3331     java_lang_boxing_object::print(obj, st);
3332   } else if (this == SystemDictionary::LambdaForm_klass()) {
3333     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3334     if (vmentry != NULL) {
3335       st-&gt;print(" =&gt; ");
3336       vmentry-&gt;print_value_on(st);
3337     }
3338   } else if (this == SystemDictionary::MemberName_klass()) {
3339     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3340     if (vmtarget != NULL) {
3341       st-&gt;print(" = ");
3342       vmtarget-&gt;print_value_on(st);
3343     } else {
3344       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3345       st-&gt;print(".");
3346       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3347     }
3348   }
3349 }
3350 
3351 const char* InstanceKlass::internal_name() const {
3352   return external_name();
3353 }
3354 
3355 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3356                                              const char* module_name,
3357                                              const ClassFileStream* cfs) const {
3358   if (!log_is_enabled(Info, class, load)) {
3359     return;
3360   }
3361 
3362   ResourceMark rm;
3363   LogMessage(class, load) msg;
3364   stringStream info_stream;
3365 
3366   // Name and class hierarchy info
3367   info_stream.print("%s", external_name());
3368 
3369   // Source
3370   if (cfs != NULL) {
3371     if (cfs-&gt;source() != NULL) {
3372       if (module_name != NULL) {
3373         if (ClassLoader::is_modules_image(cfs-&gt;source())) {
3374           info_stream.print(" source: jrt:/%s", module_name);
3375         } else {
3376           info_stream.print(" source: %s", cfs-&gt;source());
3377         }
3378       } else {
3379         info_stream.print(" source: %s", cfs-&gt;source());
3380       }
3381     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3382       Thread* THREAD = Thread::current();
3383       Klass* caller =
3384             THREAD-&gt;is_Java_thread()
3385                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3386                 : NULL;
3387       // caller can be NULL, for example, during a JVMTI VM_Init hook
3388       if (caller != NULL) {
3389         info_stream.print(" source: instance of %s", caller-&gt;external_name());
3390       } else {
3391         // source is unknown
3392       }
3393     } else {
3394       oop class_loader = loader_data-&gt;class_loader();
3395       info_stream.print(" source: %s", class_loader-&gt;klass()-&gt;external_name());
3396     }
3397   } else {
3398     info_stream.print(" source: shared objects file");
3399   }
3400 
3401   msg.info("%s", info_stream.as_string());
3402 
3403   if (log_is_enabled(Debug, class, load)) {
3404     stringStream debug_stream;
3405 
3406     // Class hierarchy info
3407     debug_stream.print(" klass: " INTPTR_FORMAT " super: " INTPTR_FORMAT,
3408                        p2i(this),  p2i(superklass()));
3409 
3410     // Interfaces
3411     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3412       debug_stream.print(" interfaces:");
3413       int length = local_interfaces()-&gt;length();
3414       for (int i = 0; i &lt; length; i++) {
3415         debug_stream.print(" " INTPTR_FORMAT,
3416                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3417       }
3418     }
3419 
3420     // Class loader
3421     debug_stream.print(" loader: [");
3422     loader_data-&gt;print_value_on(&amp;debug_stream);
3423     debug_stream.print("]");
3424 
3425     // Classfile checksum
3426     if (cfs) {
3427       debug_stream.print(" bytes: %d checksum: %08x",
3428                          cfs-&gt;length(),
3429                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3430                          cfs-&gt;length()));
3431     }
3432 
3433     msg.debug("%s", debug_stream.as_string());
3434   }
3435 }
3436 
3437 #if INCLUDE_SERVICES
3438 // Size Statistics
3439 void InstanceKlass::collect_statistics(KlassSizeStats *sz) const {
3440   Klass::collect_statistics(sz);
3441 
3442   sz-&gt;_inst_size  = wordSize * size_helper();
3443   sz-&gt;_vtab_bytes = wordSize * vtable_length();
3444   sz-&gt;_itab_bytes = wordSize * itable_length();
3445   sz-&gt;_nonstatic_oopmap_bytes = wordSize * nonstatic_oop_map_size();
3446 
3447   int n = 0;
3448   n += (sz-&gt;_methods_array_bytes         = sz-&gt;count_array(methods()));
3449   n += (sz-&gt;_method_ordering_bytes       = sz-&gt;count_array(method_ordering()));
3450   n += (sz-&gt;_local_interfaces_bytes      = sz-&gt;count_array(local_interfaces()));
3451   n += (sz-&gt;_transitive_interfaces_bytes = sz-&gt;count_array(transitive_interfaces()));
3452   n += (sz-&gt;_fields_bytes                = sz-&gt;count_array(fields()));
3453   n += (sz-&gt;_inner_classes_bytes         = sz-&gt;count_array(inner_classes()));
3454   n += (sz-&gt;_nest_members_bytes          = sz-&gt;count_array(nest_members()));
3455   sz-&gt;_ro_bytes += n;
3456 
3457   const ConstantPool* cp = constants();
3458   if (cp) {
3459     cp-&gt;collect_statistics(sz);
3460   }
3461 
3462   const Annotations* anno = annotations();
3463   if (anno) {
3464     anno-&gt;collect_statistics(sz);
3465   }
3466 
3467   const Array&lt;Method*&gt;* methods_array = methods();
3468   if (methods()) {
3469     for (int i = 0; i &lt; methods_array-&gt;length(); i++) {
3470       Method* method = methods_array-&gt;at(i);
3471       if (method) {
3472         sz-&gt;_method_count ++;
3473         method-&gt;collect_statistics(sz);
3474       }
3475     }
3476   }
3477 }
3478 #endif // INCLUDE_SERVICES
3479 
3480 // Verification
3481 
3482 class VerifyFieldClosure: public BasicOopIterateClosure {
3483  protected:
3484   template &lt;class T&gt; void do_oop_work(T* p) {
3485     oop obj = RawAccess&lt;&gt;::oop_load(p);
3486     if (!oopDesc::is_oop_or_null(obj)) {
3487       tty-&gt;print_cr("Failed: " PTR_FORMAT " -&gt; " PTR_FORMAT, p2i(p), p2i(obj));
3488       Universe::print_on(tty);
3489       guarantee(false, "boom");
3490     }
3491   }
3492  public:
3493   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3494   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3495 };
3496 
3497 void InstanceKlass::verify_on(outputStream* st) {
3498 #ifndef PRODUCT
3499   // Avoid redundant verifies, this really should be in product.
3500   if (_verify_count == Universe::verify_count()) return;
3501   _verify_count = Universe::verify_count();
3502 #endif
3503 
3504   // Verify Klass
3505   Klass::verify_on(st);
3506 
3507   // Verify that klass is present in ClassLoaderData
3508   guarantee(class_loader_data()-&gt;contains_klass(this),
3509             "this class isn't found in class loader data");
3510 
3511   // Verify vtables
3512   if (is_linked()) {
3513     // $$$ This used to be done only for m/s collections.  Doing it
3514     // always seemed a valid generalization.  (DLD -- 6/00)
3515     vtable().verify(st);
3516   }
3517 
3518   // Verify first subklass
3519   if (subklass() != NULL) {
3520     guarantee(subklass()-&gt;is_klass(), "should be klass");
3521   }
3522 
3523   // Verify siblings
3524   Klass* super = this-&gt;super();
3525   Klass* sib = next_sibling();
3526   if (sib != NULL) {
3527     if (sib == this) {
3528       fatal("subclass points to itself " PTR_FORMAT, p2i(sib));
3529     }
3530 
3531     guarantee(sib-&gt;is_klass(), "should be klass");
3532     guarantee(sib-&gt;super() == super, "siblings should have same superklass");
3533   }
3534 
3535   // Verify implementor fields requires the Compile_lock, but this is sometimes
3536   // called inside a safepoint, so don't verify.
3537 
3538   // Verify local interfaces
3539   if (local_interfaces()) {
3540     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3541     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3542       InstanceKlass* e = local_interfaces-&gt;at(j);
3543       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), "invalid local interface");
3544     }
3545   }
3546 
3547   // Verify transitive interfaces
3548   if (transitive_interfaces() != NULL) {
3549     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3550     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3551       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3552       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), "invalid transitive interface");
3553     }
3554   }
3555 
3556   // Verify methods
3557   if (methods() != NULL) {
3558     Array&lt;Method*&gt;* methods = this-&gt;methods();
3559     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3560       guarantee(methods-&gt;at(j)-&gt;is_method(), "non-method in methods array");
3561     }
3562     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3563       Method* m1 = methods-&gt;at(j);
3564       Method* m2 = methods-&gt;at(j + 1);
3565       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, "methods not sorted correctly");
3566     }
3567   }
3568 
3569   // Verify method ordering
3570   if (method_ordering() != NULL) {
3571     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3572     int length = method_ordering-&gt;length();
3573     if (JvmtiExport::can_maintain_original_method_order() ||
3574         ((UseSharedSpaces || DumpSharedSpaces) &amp;&amp; length != 0)) {
3575       guarantee(length == methods()-&gt;length(), "invalid method ordering length");
3576       jlong sum = 0;
3577       for (int j = 0; j &lt; length; j++) {
3578         int original_index = method_ordering-&gt;at(j);
3579         guarantee(original_index &gt;= 0, "invalid method ordering index");
3580         guarantee(original_index &lt; length, "invalid method ordering index");
3581         sum += original_index;
3582       }
3583       // Verify sum of indices 0,1,...,length-1
3584       guarantee(sum == ((jlong)length*(length-1))/2, "invalid method ordering sum");
3585     } else {
3586       guarantee(length == 0, "invalid method ordering length");
3587     }
3588   }
3589 
3590   // Verify default methods
3591   if (default_methods() != NULL) {
3592     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3593     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3594       guarantee(methods-&gt;at(j)-&gt;is_method(), "non-method in methods array");
3595     }
3596     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3597       Method* m1 = methods-&gt;at(j);
3598       Method* m2 = methods-&gt;at(j + 1);
3599       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, "methods not sorted correctly");
3600     }
3601   }
3602 
3603   // Verify JNI static field identifiers
3604   if (jni_ids() != NULL) {
3605     jni_ids()-&gt;verify(this);
3606   }
3607 
3608   // Verify other fields
3609   if (array_klasses() != NULL) {
3610     guarantee(array_klasses()-&gt;is_klass(), "should be klass");
3611   }
3612   if (constants() != NULL) {
3613     guarantee(constants()-&gt;is_constantPool(), "should be constant pool");
3614   }
3615   const Klass* anonymous_host = unsafe_anonymous_host();
3616   if (anonymous_host != NULL) {
3617     guarantee(anonymous_host-&gt;is_klass(), "should be klass");
3618   }
3619 }
3620 
3621 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3622   Klass::oop_verify_on(obj, st);
3623   VerifyFieldClosure blk;
3624   obj-&gt;oop_iterate(&amp;blk);
3625 }
3626 
3627 
3628 // JNIid class for jfieldIDs only
3629 // Note to reviewers:
3630 // These JNI functions are just moved over to column 1 and not changed
3631 // in the compressed oops workspace.
3632 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3633   _holder = holder;
3634   _offset = offset;
3635   _next = next;
3636   debug_only(_is_static_field_id = false;)
3637 }
3638 
3639 
3640 JNIid* JNIid::find(int offset) {
3641   JNIid* current = this;
3642   while (current != NULL) {
3643     if (current-&gt;offset() == offset) return current;
3644     current = current-&gt;next();
3645   }
3646   return NULL;
3647 }
3648 
3649 void JNIid::deallocate(JNIid* current) {
3650   while (current != NULL) {
3651     JNIid* next = current-&gt;next();
3652     delete current;
3653     current = next;
3654   }
3655 }
3656 
3657 
3658 void JNIid::verify(Klass* holder) {
3659   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3660   int end_field_offset;
3661   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3662 
3663   JNIid* current = this;
3664   while (current != NULL) {
3665     guarantee(current-&gt;holder() == holder, "Invalid klass in JNIid");
3666 #ifdef ASSERT
3667     int o = current-&gt;offset();
3668     if (current-&gt;is_static_field_id()) {
3669       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  "Invalid static field offset in JNIid");
3670     }
3671 #endif
3672     current = current-&gt;next();
3673   }
3674 }
3675 
3676 #ifdef ASSERT
3677 void InstanceKlass::set_init_state(ClassState state) {
3678   bool good_state = is_shared() ? (_init_state &lt;= state)
3679                                                : (_init_state &lt; state);
3680   assert(good_state || state == allocated, "illegal state transition");
3681   _init_state = (u1)state;
3682 }
3683 #endif
3684 
3685 #if INCLUDE_JVMTI
3686 
3687 // RedefineClasses() support for previous versions
3688 
3689 // Globally, there is at least one previous version of a class to walk
3690 // during class unloading, which is saved because old methods in the class
3691 // are still running.   Otherwise the previous version list is cleaned up.
3692 bool InstanceKlass::_has_previous_versions = false;
3693 
3694 // Returns true if there are previous versions of a class for class
3695 // unloading only. Also resets the flag to false. purge_previous_version
3696 // will set the flag to true if there are any left, i.e., if there's any
3697 // work to do for next time. This is to avoid the expensive code cache
3698 // walk in CLDG::clean_deallocate_lists().
3699 bool InstanceKlass::has_previous_versions_and_reset() {
3700   bool ret = _has_previous_versions;
3701   log_trace(redefine, class, iklass, purge)("Class unloading: has_previous_versions = %s",
3702      ret ? "true" : "false");
3703   _has_previous_versions = false;
3704   return ret;
3705 }
3706 
3707 // Purge previous versions before adding new previous versions of the class and
3708 // during class unloading.
3709 void InstanceKlass::purge_previous_version_list() {
3710   assert(SafepointSynchronize::is_at_safepoint(), "only called at safepoint");
3711   assert(has_been_redefined(), "Should only be called for main class");
3712 
3713   // Quick exit.
3714   if (previous_versions() == NULL) {
3715     return;
3716   }
3717 
3718   // This klass has previous versions so see what we can cleanup
3719   // while it is safe to do so.
3720 
3721   int deleted_count = 0;    // leave debugging breadcrumbs
3722   int live_count = 0;
3723   ClassLoaderData* loader_data = class_loader_data();
3724   assert(loader_data != NULL, "should never be null");
3725 
3726   ResourceMark rm;
3727   log_trace(redefine, class, iklass, purge)("%s: previous versions", external_name());
3728 
3729   // previous versions are linked together through the InstanceKlass
3730   InstanceKlass* pv_node = previous_versions();
3731   InstanceKlass* last = this;
3732   int version = 0;
3733 
3734   // check the previous versions list
3735   for (; pv_node != NULL; ) {
3736 
3737     ConstantPool* pvcp = pv_node-&gt;constants();
3738     assert(pvcp != NULL, "cp ref was unexpectedly cleared");
3739 
3740     if (!pvcp-&gt;on_stack()) {
3741       // If the constant pool isn't on stack, none of the methods
3742       // are executing.  Unlink this previous_version.
3743       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3744       // so will be deallocated during the next phase of class unloading.
3745       log_trace(redefine, class, iklass, purge)
3746         ("previous version " INTPTR_FORMAT " is dead.", p2i(pv_node));
3747       // For debugging purposes.
3748       pv_node-&gt;set_is_scratch_class();
3749       // Unlink from previous version list.
3750       assert(pv_node-&gt;class_loader_data() == loader_data, "wrong loader_data");
3751       InstanceKlass* next = pv_node-&gt;previous_versions();
3752       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3753       last-&gt;link_previous_versions(next);
3754       // Add to the deallocate list after unlinking
3755       loader_data-&gt;add_to_deallocate_list(pv_node);
3756       pv_node = next;
3757       deleted_count++;
3758       version++;
3759       continue;
3760     } else {
3761       log_trace(redefine, class, iklass, purge)("previous version " INTPTR_FORMAT " is alive", p2i(pv_node));
3762       assert(pvcp-&gt;pool_holder() != NULL, "Constant pool with no holder");
3763       guarantee (!loader_data-&gt;is_unloading(), "unloaded classes can't be on the stack");
3764       live_count++;
3765       // found a previous version for next time we do class unloading
3766       _has_previous_versions = true;
3767     }
3768 
3769     // At least one method is live in this previous version.
3770     // Reset dead EMCP methods not to get breakpoints.
3771     // All methods are deallocated when all of the methods for this class are no
3772     // longer running.
3773     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
3774     if (method_refs != NULL) {
3775       log_trace(redefine, class, iklass, purge)("previous methods length=%d", method_refs-&gt;length());
3776       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
3777         Method* method = method_refs-&gt;at(j);
3778 
3779         if (!method-&gt;on_stack()) {
3780           // no breakpoints for non-running methods
3781           if (method-&gt;is_running_emcp()) {
3782             method-&gt;set_running_emcp(false);
3783           }
3784         } else {
3785           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
3786                   "emcp method cannot run after emcp bit is cleared");
3787           log_trace(redefine, class, iklass, purge)
3788             ("purge: %s(%s): prev method @%d in version @%d is alive",
3789              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
3790         }
3791       }
3792     }
3793     // next previous version
3794     last = pv_node;
3795     pv_node = pv_node-&gt;previous_versions();
3796     version++;
3797   }
3798   log_trace(redefine, class, iklass, purge)
3799     ("previous version stats: live=%d, deleted=%d", live_count, deleted_count);
3800 }
3801 
3802 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
3803                                                 int emcp_method_count) {
3804   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
3805 
3806   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
3807       _previous_versions != NULL) {
3808     // We have a mix of obsolete and EMCP methods so we have to
3809     // clear out any matching EMCP method entries the hard way.
3810     int local_count = 0;
3811     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3812       Method* old_method = old_methods-&gt;at(i);
3813       if (old_method-&gt;is_obsolete()) {
3814         // only obsolete methods are interesting
3815         Symbol* m_name = old_method-&gt;name();
3816         Symbol* m_signature = old_method-&gt;signature();
3817 
3818         // previous versions are linked together through the InstanceKlass
3819         int j = 0;
3820         for (InstanceKlass* prev_version = _previous_versions;
3821              prev_version != NULL;
3822              prev_version = prev_version-&gt;previous_versions(), j++) {
3823 
3824           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
3825           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
3826             Method* method = method_refs-&gt;at(k);
3827 
3828             if (!method-&gt;is_obsolete() &amp;&amp;
3829                 method-&gt;name() == m_name &amp;&amp;
3830                 method-&gt;signature() == m_signature) {
3831               // The current RedefineClasses() call has made all EMCP
3832               // versions of this method obsolete so mark it as obsolete
3833               log_trace(redefine, class, iklass, add)
3834                 ("%s(%s): flush obsolete method @%d in version @%d",
3835                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
3836 
3837               method-&gt;set_is_obsolete();
3838               break;
3839             }
3840           }
3841 
3842           // The previous loop may not find a matching EMCP method, but
3843           // that doesn't mean that we can optimize and not go any
3844           // further back in the PreviousVersion generations. The EMCP
3845           // method for this generation could have already been made obsolete,
3846           // but there still may be an older EMCP method that has not
3847           // been made obsolete.
3848         }
3849 
3850         if (++local_count &gt;= obsolete_method_count) {
3851           // no more obsolete methods so bail out now
3852           break;
3853         }
3854       }
3855     }
3856   }
3857 }
3858 
3859 // Save the scratch_class as the previous version if any of the methods are running.
3860 // The previous_versions are used to set breakpoints in EMCP methods and they are
3861 // also used to clean MethodData links to redefined methods that are no longer running.
3862 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
3863                                          int emcp_method_count) {
3864   assert(Thread::current()-&gt;is_VM_thread(),
3865          "only VMThread can add previous versions");
3866 
3867   ResourceMark rm;
3868   log_trace(redefine, class, iklass, add)
3869     ("adding previous version ref for %s, EMCP_cnt=%d", scratch_class-&gt;external_name(), emcp_method_count);
3870 
3871   // Clean out old previous versions for this class
3872   purge_previous_version_list();
3873 
3874   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
3875   // a previous redefinition may be made obsolete by this redefinition.
3876   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
3877   mark_newly_obsolete_methods(old_methods, emcp_method_count);
3878 
3879   // If the constant pool for this previous version of the class
3880   // is not marked as being on the stack, then none of the methods
3881   // in this previous version of the class are on the stack so
3882   // we don't need to add this as a previous version.
3883   ConstantPool* cp_ref = scratch_class-&gt;constants();
3884   if (!cp_ref-&gt;on_stack()) {
3885     log_trace(redefine, class, iklass, add)("scratch class not added; no methods are running");
3886     // For debugging purposes.
3887     scratch_class-&gt;set_is_scratch_class();
3888     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
3889     return;
3890   }
3891 
3892   if (emcp_method_count != 0) {
3893     // At least one method is still running, check for EMCP methods
3894     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3895       Method* old_method = old_methods-&gt;at(i);
3896       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
3897         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
3898         // we can add breakpoints for it.
3899 
3900         // We set the method-&gt;on_stack bit during safepoints for class redefinition
3901         // and use this bit to set the is_running_emcp bit.
3902         // After the safepoint, the on_stack bit is cleared and the running emcp
3903         // method may exit.   If so, we would set a breakpoint in a method that
3904         // is never reached, but this won't be noticeable to the programmer.
3905         old_method-&gt;set_running_emcp(true);
3906         log_trace(redefine, class, iklass, add)
3907           ("EMCP method %s is on_stack " INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
3908       } else if (!old_method-&gt;is_obsolete()) {
3909         log_trace(redefine, class, iklass, add)
3910           ("EMCP method %s is NOT on_stack " INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
3911       }
3912     }
3913   }
3914 
3915   // Add previous version if any methods are still running.
3916   // Set has_previous_version flag for processing during class unloading.
3917   _has_previous_versions = true;
3918   log_trace(redefine, class, iklass, add) ("scratch class added; one of its methods is on_stack.");
3919   assert(scratch_class-&gt;previous_versions() == NULL, "shouldn't have a previous version");
3920   scratch_class-&gt;link_previous_versions(previous_versions());
3921   link_previous_versions(scratch_class);
3922 } // end add_previous_version()
3923 
3924 #endif // INCLUDE_JVMTI
3925 
3926 Method* InstanceKlass::method_with_idnum(int idnum) {
3927   Method* m = NULL;
3928   if (idnum &lt; methods()-&gt;length()) {
3929     m = methods()-&gt;at(idnum);
3930   }
3931   if (m == NULL || m-&gt;method_idnum() != idnum) {
3932     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
3933       m = methods()-&gt;at(index);
3934       if (m-&gt;method_idnum() == idnum) {
3935         return m;
3936       }
3937     }
3938     // None found, return null for the caller to handle.
3939     return NULL;
3940   }
3941   return m;
3942 }
3943 
3944 
3945 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
3946   if (idnum &gt;= methods()-&gt;length()) {
3947     return NULL;
3948   }
3949   Method* m = methods()-&gt;at(idnum);
3950   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
3951     return m;
3952   }
3953   // Obsolete method idnum does not match the original idnum
3954   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
3955     m = methods()-&gt;at(index);
3956     if (m-&gt;orig_method_idnum() == idnum) {
3957       return m;
3958     }
3959   }
3960   // None found, return null for the caller to handle.
3961   return NULL;
3962 }
3963 
3964 
3965 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
3966   InstanceKlass* holder = get_klass_version(version);
3967   if (holder == NULL) {
3968     return NULL; // The version of klass is gone, no method is found
3969   }
3970   Method* method = holder-&gt;method_with_orig_idnum(idnum);
3971   return method;
3972 }
3973 
3974 #if INCLUDE_JVMTI
3975 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
3976   if (MetaspaceShared::is_in_shared_metaspace(_cached_class_file)) {
3977     // Ignore the archived class stream data
3978     return NULL;
3979   } else {
3980     return _cached_class_file;
3981   }
3982 }
3983 
3984 jint InstanceKlass::get_cached_class_file_len() {
3985   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
3986 }
3987 
3988 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
3989   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
3990 }
3991 
3992 #if INCLUDE_CDS
3993 JvmtiCachedClassFileData* InstanceKlass::get_archived_class_data() {
3994   if (DumpSharedSpaces) {
3995     return _cached_class_file;
3996   } else {
3997     assert(this-&gt;is_shared(), "class should be shared");
3998     if (MetaspaceShared::is_in_shared_metaspace(_cached_class_file)) {
3999       return _cached_class_file;
4000     } else {
4001       return NULL;
4002     }
4003   }
4004 }
4005 #endif
4006 #endif
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="2" type="hidden" /></form></body></html>
