<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>hotspot Udiff src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMethodData.java</title>

<style type="text/css" media="screen">
span.new {
    color: blue;
    font-weight: normal;
}
</style>

</head>
<body id="SUNWwebrev">
<center><a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotJVMCIRuntime.java.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotReferenceMap.java.udiff.html' target='_top'>next &gt</a></center>
<h2>src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMethodData.java</h2>
        <a class="print" href="javascript:print()">Print this page</a>
<pre></pre>
        <pre>
</pre><hr /><pre>
<span class="newmarker">@@ -28,54 +28,33 @@</span>
 import static jdk.vm.ci.hotspot.HotSpotVMConfig.config;
 import static jdk.vm.ci.hotspot.UnsafeAccess.UNSAFE;
 
 import java.util.Arrays;
 
<span class="removed">-import jdk.vm.ci.hotspot.HotSpotMethodDataAccessor.Tag;</span>
<span class="new">+import jdk.internal.misc.Unsafe;</span>
 import jdk.vm.ci.meta.DeoptimizationReason;
 import jdk.vm.ci.meta.JavaMethodProfile;
 import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
 import jdk.vm.ci.meta.JavaTypeProfile;
 import jdk.vm.ci.meta.JavaTypeProfile.ProfiledType;
 import jdk.vm.ci.meta.ResolvedJavaMethod;
 import jdk.vm.ci.meta.ResolvedJavaType;
 import jdk.vm.ci.meta.TriState;
<span class="removed">-import jdk.internal.misc.Unsafe;</span>
 
 /**
<span class="removed">- * Access to a HotSpot MethodData structure (defined in methodData.hpp).</span>
<span class="new">+ * Access to a HotSpot {@code MethodData} structure (defined in methodData.hpp).</span>
  */
<span class="removed">-public final class HotSpotMethodData {</span>
<span class="new">+final class HotSpotMethodData {</span>
 
<span class="removed">-    private static final HotSpotVMConfig config = config();</span>
<span class="removed">-    private static final HotSpotMethodDataAccessor NO_DATA_NO_EXCEPTION_ACCESSOR = new NoMethodData(TriState.FALSE);</span>
<span class="removed">-    private static final HotSpotMethodDataAccessor NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR = new NoMethodData(TriState.UNKNOWN);</span>
<span class="removed">-</span>
<span class="removed">-    // sorted by tag</span>
<span class="removed">-    // @formatter:off</span>
<span class="removed">-    private static final HotSpotMethodDataAccessor[] PROFILE_DATA_ACCESSORS = {</span>
<span class="removed">-        null,</span>
<span class="removed">-        new BitData(),</span>
<span class="removed">-        new CounterData(),</span>
<span class="removed">-        new JumpData(),</span>
<span class="removed">-        new ReceiverTypeData(),</span>
<span class="removed">-        new VirtualCallData(),</span>
<span class="removed">-        new RetData(),</span>
<span class="removed">-        new BranchData(),</span>
<span class="removed">-        new MultiBranchData(),</span>
<span class="removed">-        new ArgInfoData(),</span>
<span class="removed">-        new UnknownProfileData(Tag.CallTypeData),</span>
<span class="removed">-        new VirtualCallTypeData(),</span>
<span class="removed">-        new UnknownProfileData(Tag.ParametersTypeData),</span>
<span class="removed">-        new UnknownProfileData(Tag.SpeculativeTrapData),</span>
<span class="removed">-    };</span>
<span class="removed">-    // @formatter:on</span>
<span class="new">+    static final HotSpotVMConfig config = config();</span>
<span class="new">+    static final HotSpotMethodDataAccessor NO_DATA_NO_EXCEPTION_ACCESSOR = new NoMethodData(config, config.dataLayoutNoTag, TriState.FALSE);</span>
<span class="new">+    static final HotSpotMethodDataAccessor NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR = new NoMethodData(config, config.dataLayoutNoTag, TriState.UNKNOWN);</span>
 
     /**
      * Reference to the C++ MethodData object.
      */
<span class="removed">-    private final long metaspaceMethodData;</span>
<span class="new">+    final long metaspaceMethodData;</span>
     @SuppressWarnings("unused") private final HotSpotResolvedJavaMethodImpl method;
 
     public HotSpotMethodData(long metaspaceMethodData, HotSpotResolvedJavaMethodImpl method) {
         this.metaspaceMethodData = metaspaceMethodData;
         this.method = method;
</pre><hr /><pre>
<span class="newmarker">@@ -131,14 +110,11 @@</span>
     public HotSpotMethodDataAccessor getNormalData(int position) {
         if (position &gt;= normalDataSize()) {
             return null;
         }
 
<span class="removed">-        HotSpotMethodDataAccessor result = getData(position);</span>
<span class="removed">-        final Tag tag = AbstractMethodData.readTag(this, position);</span>
<span class="removed">-        assert result != null : "NO_DATA tag is not allowed " + tag;</span>
<span class="removed">-        return result;</span>
<span class="new">+        return getData(position);</span>
     }
 
     public HotSpotMethodDataAccessor getExtraData(int position) {
         if (position &gt;= normalDataSize() + extraDataSize()) {
             return null;
</pre><hr /><pre>
<span class="newmarker">@@ -158,22 +134,22 @@</span>
         }
     }
 
     private HotSpotMethodDataAccessor getData(int position) {
         assert position &gt;= 0 : "out of bounds";
<span class="removed">-        final Tag tag = AbstractMethodData.readTag(this, position);</span>
<span class="removed">-        HotSpotMethodDataAccessor accessor = PROFILE_DATA_ACCESSORS[tag.getValue()];</span>
<span class="new">+        final int tag = HotSpotMethodDataAccessor.readTag(config, this, position);</span>
<span class="new">+        HotSpotMethodDataAccessor accessor = PROFILE_DATA_ACCESSORS[tag];</span>
         assert accessor == null || accessor.getTag() == tag : "wrong data accessor " + accessor + " for tag " + tag;
         return accessor;
     }
 
<span class="removed">-    private int readUnsignedByte(int position, int offsetInBytes) {</span>
<span class="new">+    int readUnsignedByte(int position, int offsetInBytes) {</span>
         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);
         return UNSAFE.getByte(metaspaceMethodData + fullOffsetInBytes) &amp; 0xFF;
     }
 
<span class="removed">-    private int readUnsignedShort(int position, int offsetInBytes) {</span>
<span class="new">+    int readUnsignedShort(int position, int offsetInBytes) {</span>
         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);
         return UNSAFE.getShort(metaspaceMethodData + fullOffsetInBytes) &amp; 0xFFFF;
     }
 
     /**
</pre><hr /><pre>
<span class="newmarker">@@ -267,106 +243,18 @@</span>
 
         }
         return sb.toString();
     }
 
<span class="removed">-    private abstract static class AbstractMethodData implements HotSpotMethodDataAccessor {</span>
<span class="removed">-</span>
<span class="removed">-        /**</span>
<span class="removed">-         * Corresponds to {@code exception_seen_flag}.</span>
<span class="removed">-         */</span>
<span class="removed">-        private static final int EXCEPTIONS_MASK = 1 &lt;&lt; config.bitDataExceptionSeenFlag;</span>
<span class="removed">-</span>
<span class="removed">-        private final Tag tag;</span>
<span class="removed">-        protected final int staticSize;</span>
<span class="removed">-</span>
<span class="removed">-        protected AbstractMethodData(Tag tag, int staticSize) {</span>
<span class="removed">-            this.tag = tag;</span>
<span class="removed">-            this.staticSize = staticSize;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        public Tag getTag() {</span>
<span class="removed">-            return tag;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        public static Tag readTag(HotSpotMethodData data, int position) {</span>
<span class="removed">-            final int tag = data.readUnsignedByte(position, config.dataLayoutTagOffset);</span>
<span class="removed">-            return Tag.getEnum(tag);</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public int getBCI(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return data.readUnsignedShort(position, config.dataLayoutBCIOffset);</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public final int getSize(HotSpotMethodData data, int position) {</span>
<span class="removed">-            int size = staticSize + getDynamicSize(data, position);</span>
<span class="removed">-            // Sanity check against VM</span>
<span class="removed">-            int vmSize = HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);</span>
<span class="removed">-            assert size == vmSize : size + " != " + vmSize;</span>
<span class="removed">-            return size;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public TriState getExceptionSeen(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return TriState.get((getFlags(data, position) &amp; EXCEPTIONS_MASK) != 0);</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public JavaTypeProfile getTypeProfile(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return null;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public JavaMethodProfile getMethodProfile(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return null;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public double getBranchTakenProbability(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return -1;</span>
<span class="removed">-        }</span>
<span class="new">+    static final int NO_DATA_SIZE = cellIndexToOffset(0);</span>
 
<span class="removed">-        @Override</span>
<span class="removed">-        public double[] getSwitchProbabilities(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return null;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public int getExecutionCount(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return -1;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        @Override</span>
<span class="removed">-        public TriState getNullSeen(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return TriState.UNKNOWN;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        protected int getFlags(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return data.readUnsignedByte(position, config.dataLayoutFlagsOffset);</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        /**</span>
<span class="removed">-         * @param data</span>
<span class="removed">-         * @param position</span>
<span class="removed">-         */</span>
<span class="removed">-        protected int getDynamicSize(HotSpotMethodData data, int position) {</span>
<span class="removed">-            return 0;</span>
<span class="removed">-        }</span>
<span class="removed">-</span>
<span class="removed">-        public abstract StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos);</span>
<span class="removed">-    }</span>
<span class="removed">-</span>
<span class="removed">-    private static class NoMethodData extends AbstractMethodData {</span>
<span class="removed">-</span>
<span class="removed">-        private static final int NO_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="new">+    static class NoMethodData extends HotSpotMethodDataAccessor {</span>
 
         private final TriState exceptionSeen;
 
<span class="removed">-        protected NoMethodData(TriState exceptionSeen) {</span>
<span class="removed">-            super(Tag.No, NO_DATA_SIZE);</span>
<span class="new">+        protected NoMethodData(HotSpotVMConfig config, int tag, TriState exceptionSeen) {</span>
<span class="new">+            super(config, tag, NO_DATA_SIZE);</span>
             this.exceptionSeen = exceptionSeen;
         }
 
         @Override
         public int getBCI(HotSpotMethodData data, int position) {
</pre><hr /><pre>
<span class="newmarker">@@ -382,21 +270,21 @@</span>
         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
             return sb;
         }
     }
 
<span class="removed">-    private static class BitData extends AbstractMethodData {</span>
<span class="new">+    static final int BIT_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="new">+    static final int BIT_DATA_NULL_SEEN_FLAG = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
 
<span class="removed">-        private static final int BIT_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="removed">-        private static final int BIT_DATA_NULL_SEEN_FLAG = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
<span class="new">+    static class BitData extends HotSpotMethodDataAccessor {</span>
 
<span class="removed">-        private BitData() {</span>
<span class="removed">-            super(Tag.BitData, BIT_DATA_SIZE);</span>
<span class="new">+        private BitData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, BIT_DATA_SIZE);</span>
         }
 
<span class="removed">-        protected BitData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected BitData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public TriState getNullSeen(HotSpotMethodData data, int position) {
             return TriState.get((getFlags(data, position) &amp; BIT_DATA_NULL_SEEN_FLAG) != 0);
</pre><hr /><pre>
<span class="newmarker">@@ -406,21 +294,21 @@</span>
         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
             return sb.append(format("exception_seen(%s)", getExceptionSeen(data, pos)));
         }
     }
 
<span class="removed">-    private static class CounterData extends BitData {</span>
<span class="new">+    static final int COUNTER_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="new">+    static final int COUNTER_DATA_COUNT_OFFSET = cellIndexToOffset(config.methodDataCountOffset);</span>
 
<span class="removed">-        private static final int COUNTER_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="removed">-        private static final int COUNTER_DATA_COUNT_OFFSET = cellIndexToOffset(config.methodDataCountOffset);</span>
<span class="new">+    static class CounterData extends BitData {</span>
 
<span class="removed">-        CounterData() {</span>
<span class="removed">-            super(Tag.CounterData, COUNTER_DATA_SIZE);</span>
<span class="new">+        CounterData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, COUNTER_DATA_SIZE);</span>
         }
 
<span class="removed">-        protected CounterData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected CounterData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public int getExecutionCount(HotSpotMethodData data, int position) {
             return getCounterValue(data, position);
</pre><hr /><pre>
<span class="newmarker">@@ -434,22 +322,22 @@</span>
         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
             return sb.append(format("count(%d) null_seen(%s) exception_seen(%s)", getCounterValue(data, pos), getNullSeen(data, pos), getExceptionSeen(data, pos)));
         }
     }
 
<span class="removed">-    private static class JumpData extends AbstractMethodData {</span>
<span class="new">+    static final int JUMP_DATA_SIZE = cellIndexToOffset(2);</span>
<span class="new">+    static final int TAKEN_COUNT_OFFSET = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="new">+    static final int TAKEN_DISPLACEMENT_OFFSET = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
 
<span class="removed">-        private static final int JUMP_DATA_SIZE = cellIndexToOffset(2);</span>
<span class="removed">-        protected static final int TAKEN_COUNT_OFFSET = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="removed">-        protected static final int TAKEN_DISPLACEMENT_OFFSET = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
<span class="new">+    static class JumpData extends HotSpotMethodDataAccessor {</span>
 
<span class="removed">-        JumpData() {</span>
<span class="removed">-            super(Tag.JumpData, JUMP_DATA_SIZE);</span>
<span class="new">+        JumpData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, JUMP_DATA_SIZE);</span>
         }
 
<span class="removed">-        protected JumpData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected JumpData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
             return getExecutionCount(data, position) != 0 ? 1 : 0;
</pre><hr /><pre>
<span class="newmarker">@@ -482,20 +370,20 @@</span>
             this.counts = counts;
             this.totalCount = totalCount;
         }
     }
 
<span class="removed">-    private abstract static class AbstractTypeData extends CounterData {</span>
<span class="new">+    static final int TYPE_DATA_ROW_SIZE = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
 
<span class="removed">-        protected static final int TYPE_DATA_ROW_SIZE = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
<span class="new">+    static final int NONPROFILED_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="new">+    static final int TYPE_DATA_FIRST_TYPE_OFFSET = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="new">+    static final int TYPE_DATA_FIRST_TYPE_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
 
<span class="removed">-        protected static final int NONPROFILED_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="removed">-        protected static final int TYPE_DATA_FIRST_TYPE_OFFSET = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="removed">-        protected static final int TYPE_DATA_FIRST_TYPE_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
<span class="new">+    abstract static class AbstractTypeData extends CounterData {</span>
 
<span class="removed">-        protected AbstractTypeData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected AbstractTypeData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public JavaTypeProfile getTypeProfile(HotSpotMethodData data, int position) {
             return createTypeProfile(getNullSeen(data, position), getRawTypeProfile(data, position));
</pre><hr /><pre>
<span class="newmarker">@@ -537,11 +425,11 @@</span>
             return new RawItemProfile&lt;&gt;(entries, types, counts, totalCount);
         }
 
         protected abstract long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position);
 
<span class="removed">-        private static JavaTypeProfile createTypeProfile(TriState nullSeen, RawItemProfile&lt;ResolvedJavaType&gt; profile) {</span>
<span class="new">+        private JavaTypeProfile createTypeProfile(TriState nullSeen, RawItemProfile&lt;ResolvedJavaType&gt; profile) {</span>
             if (profile.entries &lt;= 0 || profile.totalCount &lt;= 0) {
                 return null;
             }
 
             ProfiledType[] ptypes = new ProfiledType[profile.entries];
</pre><hr /><pre>
<span class="newmarker">@@ -581,20 +469,20 @@</span>
             }
             return sb;
         }
     }
 
<span class="removed">-    private static class ReceiverTypeData extends AbstractTypeData {</span>
<span class="new">+    static final int TYPE_CHECK_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
 
<span class="removed">-        private static final int TYPE_CHECK_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="new">+    static class ReceiverTypeData extends AbstractTypeData {</span>
 
<span class="removed">-        ReceiverTypeData() {</span>
<span class="removed">-            super(Tag.ReceiverTypeData, TYPE_CHECK_DATA_SIZE);</span>
<span class="new">+        ReceiverTypeData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, TYPE_CHECK_DATA_SIZE);</span>
         }
 
<span class="removed">-        protected ReceiverTypeData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected ReceiverTypeData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public int getExecutionCount(HotSpotMethodData data, int position) {
             return -1;
</pre><hr /><pre>
<span class="newmarker">@@ -604,22 +492,22 @@</span>
         protected long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position) {
             return data.readUnsignedIntAsSignedInt(position, NONPROFILED_COUNT_OFFSET);
         }
     }
 
<span class="removed">-    private static class VirtualCallData extends ReceiverTypeData {</span>
<span class="new">+    static final int VIRTUAL_CALL_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="new">+    static final int VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET = TYPE_DATA_FIRST_TYPE_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="new">+    static final int VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET = TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
 
<span class="removed">-        private static final int VIRTUAL_CALL_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="removed">-        private static final int VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET = TYPE_DATA_FIRST_TYPE_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="removed">-        private static final int VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET = TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="new">+    static class VirtualCallData extends ReceiverTypeData {</span>
 
<span class="removed">-        VirtualCallData() {</span>
<span class="removed">-            super(Tag.VirtualCallData, VIRTUAL_CALL_DATA_SIZE);</span>
<span class="new">+        VirtualCallData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, VIRTUAL_CALL_DATA_SIZE);</span>
         }
 
<span class="removed">-        protected VirtualCallData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        protected VirtualCallData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         public int getExecutionCount(HotSpotMethodData data, int position) {
             final int typeProfileWidth = config.typeProfileWidth;
</pre><hr /><pre>
<span class="newmarker">@@ -645,11 +533,11 @@</span>
         @Override
         public JavaMethodProfile getMethodProfile(HotSpotMethodData data, int position) {
             return createMethodProfile(getRawMethodProfile(data, position));
         }
 
<span class="removed">-        private static RawItemProfile&lt;ResolvedJavaMethod&gt; getRawMethodProfile(HotSpotMethodData data, int position) {</span>
<span class="new">+        private RawItemProfile&lt;ResolvedJavaMethod&gt; getRawMethodProfile(HotSpotMethodData data, int position) {</span>
             int profileWidth = config.methodProfileWidth;
 
             ResolvedJavaMethod[] methods = new ResolvedJavaMethod[profileWidth];
             long[] counts = new long[profileWidth];
             long totalCount = 0;
</pre><hr /><pre>
<span class="newmarker">@@ -669,11 +557,11 @@</span>
 
             totalCount += getMethodsNotRecordedExecutionCount(data, position);
             return new RawItemProfile&lt;&gt;(entries, methods, counts, totalCount);
         }
 
<span class="removed">-        private static JavaMethodProfile createMethodProfile(RawItemProfile&lt;ResolvedJavaMethod&gt; profile) {</span>
<span class="new">+        private JavaMethodProfile createMethodProfile(RawItemProfile&lt;ResolvedJavaMethod&gt; profile) {</span>
             if (profile.entries &lt;= 0 || profile.totalCount &lt;= 0) {
                 return null;
             }
 
             ProfiledMethod[] pmethods = new ProfiledMethod[profile.entries];
</pre><hr /><pre>
<span class="newmarker">@@ -710,40 +598,40 @@</span>
             }
             return sb;
         }
     }
 
<span class="removed">-    private static class VirtualCallTypeData extends VirtualCallData {</span>
<span class="new">+    static class VirtualCallTypeData extends VirtualCallData {</span>
 
<span class="removed">-        VirtualCallTypeData() {</span>
<span class="removed">-            super(Tag.VirtualCallTypeData, 0);</span>
<span class="new">+        VirtualCallTypeData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, 0);</span>
         }
 
         @Override
         protected int getDynamicSize(HotSpotMethodData data, int position) {
             assert staticSize == 0;
             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
         }
     }
 
<span class="removed">-    private static class RetData extends CounterData {</span>
<span class="new">+    static final int RET_DATA_ROW_SIZE = cellsToBytes(3);</span>
<span class="new">+    static final int RET_DATA_SIZE = cellIndexToOffset(1) + RET_DATA_ROW_SIZE * config.bciProfileWidth;</span>
 
<span class="removed">-        private static final int RET_DATA_ROW_SIZE = cellsToBytes(3);</span>
<span class="removed">-        private static final int RET_DATA_SIZE = cellIndexToOffset(1) + RET_DATA_ROW_SIZE * config.bciProfileWidth;</span>
<span class="new">+    static class RetData extends CounterData {</span>
 
<span class="removed">-        RetData() {</span>
<span class="removed">-            super(Tag.RetData, RET_DATA_SIZE);</span>
<span class="new">+        RetData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, RET_DATA_SIZE);</span>
         }
     }
 
<span class="removed">-    private static class BranchData extends JumpData {</span>
<span class="new">+    static final int BRANCH_DATA_SIZE = cellIndexToOffset(3);</span>
<span class="new">+    static final int NOT_TAKEN_COUNT_OFFSET = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
 
<span class="removed">-        private static final int BRANCH_DATA_SIZE = cellIndexToOffset(3);</span>
<span class="removed">-        private static final int NOT_TAKEN_COUNT_OFFSET = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
<span class="new">+    static class BranchData extends JumpData {</span>
 
<span class="removed">-        BranchData() {</span>
<span class="removed">-            super(Tag.BranchData, BRANCH_DATA_SIZE);</span>
<span class="new">+        BranchData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, BRANCH_DATA_SIZE);</span>
         }
 
         @Override
         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
             long takenCount = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET);
</pre><hr /><pre>
<span class="newmarker">@@ -766,17 +654,17 @@</span>
             double takenProbability = getBranchTakenProbability(data, pos);
             return sb.append(format("taken(%d, %4.2f) not_taken(%d, %4.2f) displacement(%d)", taken, takenProbability, notTaken, 1.0D - takenProbability, getTakenDisplacement(data, pos)));
         }
     }
 
<span class="removed">-    private static class ArrayData extends AbstractMethodData {</span>
<span class="new">+    static final int ARRAY_DATA_LENGTH_OFFSET = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="new">+    static final int ARRAY_DATA_START_OFFSET = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
 
<span class="removed">-        private static final int ARRAY_DATA_LENGTH_OFFSET = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="removed">-        protected static final int ARRAY_DATA_START_OFFSET = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
<span class="new">+    static class ArrayData extends HotSpotMethodDataAccessor {</span>
 
<span class="removed">-        ArrayData(Tag tag, int staticSize) {</span>
<span class="removed">-            super(tag, staticSize);</span>
<span class="new">+        ArrayData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="new">+            super(config, tag, staticSize);</span>
         }
 
         @Override
         protected int getDynamicSize(HotSpotMethodData data, int position) {
             return cellsToBytes(getLength(data, position));
</pre><hr /><pre>
<span class="newmarker">@@ -790,20 +678,20 @@</span>
         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
             return sb.append(format("length(%d)", getLength(data, pos)));
         }
     }
 
<span class="removed">-    private static class MultiBranchData extends ArrayData {</span>
<span class="new">+    static final int MULTI_BRANCH_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="new">+    static final int MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS = config.multiBranchDataPerCaseCellCount;</span>
<span class="new">+    static final int MULTI_BRANCH_DATA_ROW_SIZE = cellsToBytes(MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS);</span>
<span class="new">+    static final int MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(0);</span>
<span class="new">+    static final int MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(1);</span>
 
<span class="removed">-        private static final int MULTI_BRANCH_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="removed">-        private static final int MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS = config.multiBranchDataPerCaseCellCount;</span>
<span class="removed">-        private static final int MULTI_BRANCH_DATA_ROW_SIZE = cellsToBytes(MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS);</span>
<span class="removed">-        private static final int MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(0);</span>
<span class="removed">-        private static final int MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(1);</span>
<span class="new">+    static class MultiBranchData extends ArrayData {</span>
 
<span class="removed">-        MultiBranchData() {</span>
<span class="removed">-            super(Tag.MultiBranchData, MULTI_BRANCH_DATA_SIZE);</span>
<span class="new">+        MultiBranchData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, MULTI_BRANCH_DATA_SIZE);</span>
         }
 
         @Override
         public double[] getSwitchProbabilities(HotSpotMethodData data, int position) {
             int arrayLength = getLength(data, position);
</pre><hr /><pre>
<span class="newmarker">@@ -876,33 +764,32 @@</span>
             }
             return sb;
         }
     }
 
<span class="removed">-    private static class ArgInfoData extends ArrayData {</span>
<span class="new">+    static final int ARG_INFO_DATA_SIZE = cellIndexToOffset(1);</span>
 
<span class="removed">-        private static final int ARG_INFO_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="new">+    static class ArgInfoData extends ArrayData {</span>
 
<span class="removed">-        ArgInfoData() {</span>
<span class="removed">-            super(Tag.ArgInfoData, ARG_INFO_DATA_SIZE);</span>
<span class="new">+        ArgInfoData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, ARG_INFO_DATA_SIZE);</span>
         }
     }
 
<span class="removed">-    private static class UnknownProfileData extends AbstractMethodData {</span>
<span class="removed">-        UnknownProfileData(Tag tag) {</span>
<span class="removed">-            super(tag, 0);</span>
<span class="new">+    static class UnknownProfileData extends HotSpotMethodDataAccessor {</span>
<span class="new">+        UnknownProfileData(HotSpotVMConfig config, int tag) {</span>
<span class="new">+            super(config, tag, 0);</span>
         }
 
         @Override
         protected int getDynamicSize(HotSpotMethodData data, int position) {
             assert staticSize == 0;
             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
         }
 
         @Override
         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
<span class="removed">-            // TODO Auto-generated method stub</span>
             return null;
         }
     }
 
     public void setCompiledIRSize(int size) {
</pre><hr /><pre>
<span class="newmarker">@@ -910,6 +797,43 @@</span>
     }
 
     public int getCompiledIRSize() {
         return UNSAFE.getInt(metaspaceMethodData + config.methodDataIRSizeOffset);
     }
<span class="new">+</span>
<span class="new">+    // sorted by tag</span>
<span class="new">+    // @formatter:off</span>
<span class="new">+    static final HotSpotMethodDataAccessor[] PROFILE_DATA_ACCESSORS = {</span>
<span class="new">+        null,</span>
<span class="new">+        new BitData(config, config.dataLayoutBitDataTag),</span>
<span class="new">+        new CounterData(config, config.dataLayoutCounterDataTag),</span>
<span class="new">+        new JumpData(config, config.dataLayoutJumpDataTag),</span>
<span class="new">+        new ReceiverTypeData(config, config.dataLayoutReceiverTypeDataTag),</span>
<span class="new">+        new VirtualCallData(config, config.dataLayoutVirtualCallDataTag),</span>
<span class="new">+        new RetData(config, config.dataLayoutRetDataTag),</span>
<span class="new">+        new BranchData(config, config.dataLayoutBranchDataTag),</span>
<span class="new">+        new MultiBranchData(config, config.dataLayoutMultiBranchDataTag),</span>
<span class="new">+        new ArgInfoData(config, config.dataLayoutArgInfoDataTag),</span>
<span class="new">+        new UnknownProfileData(config, config.dataLayoutCallTypeDataTag),</span>
<span class="new">+        new VirtualCallTypeData(config, config.dataLayoutVirtualCallTypeDataTag),</span>
<span class="new">+        new UnknownProfileData(config, config.dataLayoutParametersTypeDataTag),</span>
<span class="new">+        new UnknownProfileData(config, config.dataLayoutSpeculativeTrapDataTag),</span>
<span class="new">+    };</span>
<span class="new">+</span>
<span class="new">+    private static boolean checkAccessorTags() {</span>
<span class="new">+        int expectedTag = 0;</span>
<span class="new">+        for (HotSpotMethodDataAccessor accessor : PROFILE_DATA_ACCESSORS) {</span>
<span class="new">+            if (expectedTag ==0 ) {</span>
<span class="new">+                assert accessor == null;</span>
<span class="new">+            } else {</span>
<span class="new">+                assert accessor.tag == expectedTag: expectedTag + " != " + accessor.tag + " " + accessor;</span>
<span class="new">+            }</span>
<span class="new">+            expectedTag++;</span>
<span class="new">+        }</span>
<span class="new">+        return true;</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    static {</span>
<span class="new">+        assert checkAccessorTags();</span>
<span class="new">+    }</span>
<span class="new">+    // @formatter:on</span>
 }
</pre>
<center><a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotJVMCIRuntime.java.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotReferenceMap.java.udiff.html' target='_top'>next &gt</a></center>
</body></html>

