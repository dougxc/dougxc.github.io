<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre></pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaAssertions.hpp"
  28 #include "classfile/stringTable.hpp"
  29 #include "classfile/symbolTable.hpp"
  30 #include "code/codeCacheExtensions.hpp"
  31 #include "gc/shared/cardTableRS.hpp"
  32 #include "gc/shared/genCollectedHeap.hpp"
  33 #include "gc/shared/referenceProcessor.hpp"
  34 #include "gc/shared/taskqueue.hpp"
  35 #include "logging/log.hpp"
  36 #include "logging/logTag.hpp"
  37 #include "logging/logConfiguration.hpp"
  38 #include "memory/allocation.inline.hpp"
  39 #include "memory/universe.inline.hpp"
  40 #include "oops/oop.inline.hpp"
  41 #include "prims/jvmtiExport.hpp"
  42 #include "runtime/arguments.hpp"
  43 #include "runtime/arguments_ext.hpp"
  44 #include "runtime/commandLineFlagConstraintList.hpp"
  45 #include "runtime/commandLineFlagWriteableList.hpp"
  46 #include "runtime/commandLineFlagRangeList.hpp"
  47 #include "runtime/globals.hpp"
  48 #include "runtime/globals_extension.hpp"
  49 #include "runtime/java.hpp"
  50 #include "runtime/os.hpp"
  51 #include "runtime/vm_version.hpp"
  52 #include "services/management.hpp"
  53 #include "services/memTracker.hpp"
  54 #include "utilities/defaultStream.hpp"
  55 #include "utilities/macros.hpp"
  56 #include "utilities/stringUtils.hpp"
  57 #if INCLUDE_JVMCI
  58 #include "jvmci/jvmciRuntime.hpp"
  59 #endif
  60 #if INCLUDE_ALL_GCS
  61 #include "gc/cms/compactibleFreeListSpace.hpp"
  62 #include "gc/g1/g1CollectedHeap.inline.hpp"
  63 #include "gc/parallel/parallelScavengeHeap.hpp"
  64 #endif // INCLUDE_ALL_GCS
  65 
  66 // Note: This is a special bug reporting site for the JVM
  67 #define DEFAULT_VENDOR_URL_BUG "http://bugreport.java.com/bugreport/crash.jsp"
  68 #define DEFAULT_JAVA_LAUNCHER  "generic"
  69 
  70 char*  Arguments::_jvm_flags_file               = NULL;
  71 char** Arguments::_jvm_flags_array              = NULL;
  72 int    Arguments::_num_jvm_flags                = 0;
  73 char** Arguments::_jvm_args_array               = NULL;
  74 int    Arguments::_num_jvm_args                 = 0;
  75 char*  Arguments::_java_command                 = NULL;
  76 SystemProperty* Arguments::_system_properties   = NULL;
  77 const char*  Arguments::_gc_log_filename        = NULL;
  78 bool   Arguments::_has_profile                  = false;
  79 size_t Arguments::_conservative_max_heap_alignment = 0;
  80 size_t Arguments::_min_heap_size                = 0;
  81 Arguments::Mode Arguments::_mode                = _mixed;
  82 bool   Arguments::_java_compiler                = false;
  83 bool   Arguments::_xdebug_mode                  = false;
  84 const char*  Arguments::_java_vendor_url_bug    = DEFAULT_VENDOR_URL_BUG;
  85 const char*  Arguments::_sun_java_launcher      = DEFAULT_JAVA_LAUNCHER;
  86 int    Arguments::_sun_java_launcher_pid        = -1;
  87 bool   Arguments::_sun_java_launcher_is_altjvm  = false;
  88 int    Arguments::_bootclassloader_append_index = -1;
  89 
  90 // These parameters are reset in method parse_vm_init_args()
  91 bool   Arguments::_AlwaysCompileLoopMethods     = AlwaysCompileLoopMethods;
  92 bool   Arguments::_UseOnStackReplacement        = UseOnStackReplacement;
  93 bool   Arguments::_BackgroundCompilation        = BackgroundCompilation;
  94 bool   Arguments::_ClipInlining                 = ClipInlining;
  95 intx   Arguments::_Tier3InvokeNotifyFreqLog     = Tier3InvokeNotifyFreqLog;
  96 intx   Arguments::_Tier4InvocationThreshold     = Tier4InvocationThreshold;
  97 
  98 char*  Arguments::SharedArchivePath             = NULL;
  99 
 100 AgentLibraryList Arguments::_libraryList;
 101 AgentLibraryList Arguments::_agentList;
 102 
 103 abort_hook_t     Arguments::_abort_hook         = NULL;
 104 exit_hook_t      Arguments::_exit_hook          = NULL;
 105 vfprintf_hook_t  Arguments::_vfprintf_hook      = NULL;
 106 
 107 
 108 SystemProperty *Arguments::_sun_boot_library_path = NULL;
 109 SystemProperty *Arguments::_java_library_path = NULL;
 110 SystemProperty *Arguments::_java_home = NULL;
 111 SystemProperty *Arguments::_java_class_path = NULL;
 112 SystemProperty *Arguments::_jdk_boot_class_path_append = NULL;
 113 
 114 GrowableArray&lt;ModuleXPatchPath*&gt; *Arguments::_xpatchprefix = NULL;
 115 PathString *Arguments::_system_boot_class_path = NULL;
 116 
 117 char* Arguments::_ext_dirs = NULL;
 118 
 119 // Check if head of 'option' matches 'name', and sets 'tail' to the remaining
 120 // part of the option string.
 121 static bool match_option(const JavaVMOption *option, const char* name,
 122                          const char** tail) {
 123   size_t len = strlen(name);
 124   if (strncmp(option-&gt;optionString, name, len) == 0) {
 125     *tail = option-&gt;optionString + len;
 126     return true;
 127   } else {
 128     return false;
 129   }
 130 }
 131 
 132 // Check if 'option' matches 'name'. No "tail" is allowed.
 133 static bool match_option(const JavaVMOption *option, const char* name) {
 134   const char* tail = NULL;
 135   bool result = match_option(option, name, &amp;tail);
 136   if (tail != NULL &amp;&amp; *tail == '\0') {
 137     return result;
 138   } else {
 139     return false;
 140   }
 141 }
 142 
 143 // Return true if any of the strings in null-terminated array 'names' matches.
 144 // If tail_allowed is true, then the tail must begin with a colon; otherwise,
 145 // the option must match exactly.
 146 static bool match_option(const JavaVMOption* option, const char** names, const char** tail,
 147   bool tail_allowed) {
 148   for (/* empty */; *names != NULL; ++names) {
 149     if (match_option(option, *names, tail)) {
 150       if (**tail == '\0' || tail_allowed &amp;&amp; **tail == ':') {
 151         return true;
 152       }
 153     }
 154   }
 155   return false;
 156 }
 157 
 158 static void logOption(const char* opt) {
 159   if (PrintVMOptions) {
 160     jio_fprintf(defaultStream::output_stream(), "VM option '%s'\n", opt);
 161   }
 162 }
 163 
 164 // Process java launcher properties.
 165 void Arguments::process_sun_java_launcher_properties(JavaVMInitArgs* args) {
 166   // See if sun.java.launcher, sun.java.launcher.is_altjvm or
 167   // sun.java.launcher.pid is defined.
 168   // Must do this before setting up other system properties,
 169   // as some of them may depend on launcher type.
 170   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
 171     const JavaVMOption* option = args-&gt;options + index;
 172     const char* tail;
 173 
 174     if (match_option(option, "-Dsun.java.launcher=", &amp;tail)) {
 175       process_java_launcher_argument(tail, option-&gt;extraInfo);
 176       continue;
 177     }
 178     if (match_option(option, "-Dsun.java.launcher.is_altjvm=", &amp;tail)) {
 179       if (strcmp(tail, "true") == 0) {
 180         _sun_java_launcher_is_altjvm = true;
 181       }
 182       continue;
 183     }
 184     if (match_option(option, "-Dsun.java.launcher.pid=", &amp;tail)) {
 185       _sun_java_launcher_pid = atoi(tail);
 186       continue;
 187     }
 188   }
 189 }
 190 
 191 // Initialize system properties key and value.
 192 void Arguments::init_system_properties() {
 193 
 194   // Set up _system_boot_class_path which is not a property but
 195   // relies heavily on argument processing and the jdk.boot.class.path.append
 196   // property. It is used to store the underlying system boot class path.
 197   _system_boot_class_path = new PathString(NULL);
 198 
 199   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.specification.name",
 200                                                                  "Java Virtual Machine Specification",  false));
 201   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.version", VM_Version::vm_release(),  false));
 202   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.name", VM_Version::vm_name(),  false));
 203   PropertyList_add(&amp;_system_properties, new SystemProperty("java.vm.info", VM_Version::vm_info_string(),  true));
 204   PropertyList_add(&amp;_system_properties, new SystemProperty("jdk.debug", VM_Version::jdk_debug_level(),  false));
 205 
 206   // Following are JVMTI agent writable properties.
 207   // Properties values are set to NULL and they are
 208   // os specific they are initialized in os::init_system_properties_values().
 209   _sun_boot_library_path = new SystemProperty("sun.boot.library.path", NULL,  true);
 210   _java_library_path = new SystemProperty("java.library.path", NULL,  true);
 211   _java_home =  new SystemProperty("java.home", NULL,  true);
 212   _java_class_path = new SystemProperty("java.class.path", "",  true);
 213   // jdk.boot.class.path.append is a non-writeable, internal property.
 214   // It can only be set by either:
 215   //    - -Xbootclasspath/a:
 216   //    - AddToBootstrapClassLoaderSearch during JVMTI OnLoad phase
 217   _jdk_boot_class_path_append = new SystemProperty("jdk.boot.class.path.append", "", false, true);
 218 
 219   // Add to System Property list.
 220   PropertyList_add(&amp;_system_properties, _sun_boot_library_path);
 221   PropertyList_add(&amp;_system_properties, _java_library_path);
 222   PropertyList_add(&amp;_system_properties, _java_home);
 223   PropertyList_add(&amp;_system_properties, _java_class_path);
 224   PropertyList_add(&amp;_system_properties, _jdk_boot_class_path_append);
 225 
 226   // Set OS specific system properties values
 227   os::init_system_properties_values();
 228 }
 229 
 230 // Update/Initialize System properties after JDK version number is known
 231 void Arguments::init_version_specific_system_properties() {
 232   enum { bufsz = 16 };
 233   char buffer[bufsz];
 234   const char* spec_vendor = "Oracle Corporation";
 235   uint32_t spec_version = JDK_Version::current().major_version();
 236 
 237   jio_snprintf(buffer, bufsz, UINT32_FORMAT, spec_version);
 238 
 239   PropertyList_add(&amp;_system_properties,
 240       new SystemProperty("java.vm.specification.vendor",  spec_vendor, false));
 241   PropertyList_add(&amp;_system_properties,
 242       new SystemProperty("java.vm.specification.version", buffer, false));
 243   PropertyList_add(&amp;_system_properties,
 244       new SystemProperty("java.vm.vendor", VM_Version::vm_vendor(),  false));
 245 }
 246 
 247 /*
 248  *  -XX argument processing:
 249  *
 250  *  -XX arguments are defined in several places, such as:
 251  *      globals.hpp, globals_&lt;cpu&gt;.hpp, globals_&lt;os&gt;.hpp, &lt;compiler&gt;_globals.hpp, or &lt;gc&gt;_globals.hpp.
 252  *  -XX arguments are parsed in parse_argument().
 253  *  -XX argument bounds checking is done in check_vm_args_consistency().
 254  *
 255  * Over time -XX arguments may change. There are mechanisms to handle common cases:
 256  *
 257  *      ALIASED: An option that is simply another name for another option. This is often
 258  *               part of the process of deprecating a flag, but not all aliases need
 259  *               to be deprecated.
 260  *
 261  *               Create an alias for an option by adding the old and new option names to the
 262  *               "aliased_jvm_flags" table. Delete the old variable from globals.hpp (etc).
 263  *
 264  *   DEPRECATED: An option that is supported, but a warning is printed to let the user know that
 265  *               support may be removed in the future. Both regular and aliased options may be
 266  *               deprecated.
 267  *
 268  *               Add a deprecation warning for an option (or alias) by adding an entry in the
 269  *               "special_jvm_flags" table and setting the "deprecated_in" field.
 270  *               Often an option "deprecated" in one major release will
 271  *               be made "obsolete" in the next. In this case the entry should also have it's
 272  *               "obsolete_in" field set.
 273  *
 274  *     OBSOLETE: An option that has been removed (and deleted from globals.hpp), but is still accepted
 275  *               on the command line. A warning is printed to let the user know that option might not
 276  *               be accepted in the future.
 277  *
 278  *               Add an obsolete warning for an option by adding an entry in the "special_jvm_flags"
 279  *               table and setting the "obsolete_in" field.
 280  *
 281  *      EXPIRED: A deprecated or obsolete option that has an "accept_until" version less than or equal
 282  *               to the current JDK version. The system will flatly refuse to admit the existence of
 283  *               the flag. This allows a flag to die automatically over JDK releases.
 284  *
 285  *               Note that manual cleanup of expired options should be done at major JDK version upgrades:
 286  *                  - Newly expired options should be removed from the special_jvm_flags and aliased_jvm_flags tables.
 287  *                  - Newly obsolete or expired deprecated options should have their global variable
 288  *                    definitions removed (from globals.hpp, etc) and related implementations removed.
 289  *
 290  * Recommended approach for removing options:
 291  *
 292  * To remove options commonly used by customers (e.g. product, commercial -XX options), use
 293  * the 3-step model adding major release numbers to the deprecate, obsolete and expire columns.
 294  *
 295  * To remove internal options (e.g. diagnostic, experimental, develop options), use
 296  * a 2-step model adding major release numbers to the obsolete and expire columns.
 297  *
 298  * To change the name of an option, use the alias table as well as a 2-step
 299  * model adding major release numbers to the deprecate and expire columns.
 300  * Think twice about aliasing commonly used customer options.
 301  *
 302  * There are times when it is appropriate to leave a future release number as undefined.
 303  *
 304  * Tests:  Aliases should be tested in VMAliasOptions.java.
 305  *         Deprecated options should be tested in VMDeprecatedOptions.java.
 306  */
 307 
 308 // Obsolete or deprecated -XX flag.
 309 typedef struct {
 310   const char* name;
 311   JDK_Version deprecated_in; // When the deprecation warning started (or "undefined").
 312   JDK_Version obsolete_in;   // When the obsolete warning started (or "undefined").
 313   JDK_Version expired_in;    // When the option expires (or "undefined").
 314 } SpecialFlag;
 315 
 316 // The special_jvm_flags table declares options that are being deprecated and/or obsoleted. The
 317 // "deprecated_in" or "obsolete_in" fields may be set to "undefined", but not both.
 318 // When the JDK version reaches 'deprecated_in' limit, the JVM will process this flag on
 319 // the command-line as usual, but will issue a warning.
 320 // When the JDK version reaches 'obsolete_in' limit, the JVM will continue accepting this flag on
 321 // the command-line, while issuing a warning and ignoring the flag value.
 322 // Once the JDK version reaches 'expired_in' limit, the JVM will flatly refuse to admit the
 323 // existence of the flag.
 324 //
 325 // MANUAL CLEANUP ON JDK VERSION UPDATES:
 326 // This table ensures that the handling of options will update automatically when the JDK
 327 // version is incremented, but the source code needs to be cleanup up manually:
 328 // - As "deprecated" options age into "obsolete" or "expired" options, the associated "globals"
 329 //   variable should be removed, as well as users of the variable.
 330 // - As "deprecated" options age into "obsolete" options, move the entry into the
 331 //   "Obsolete Flags" section of the table.
 332 // - All expired options should be removed from the table.
 333 static SpecialFlag const special_jvm_flags[] = {
 334   // -------------- Deprecated Flags --------------
 335   // --- Non-alias flags - sorted by obsolete_in then expired_in:
 336   { "MaxGCMinorPauseMillis",        JDK_Version::jdk(8), JDK_Version::undefined(), JDK_Version::undefined() },
 337   { "UseParNewGC",                  JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 338   { "ConvertSleepToYield",          JDK_Version::jdk(9), JDK_Version::jdk(10),     JDK_Version::jdk(11) },
 339   { "ConvertYieldToSleep",          JDK_Version::jdk(9), JDK_Version::jdk(10),     JDK_Version::jdk(11) },
 340 
 341   // --- Deprecated alias flags (see also aliased_jvm_flags) - sorted by obsolete_in then expired_in:
 342   { "DefaultMaxRAMFraction",        JDK_Version::jdk(8), JDK_Version::undefined(), JDK_Version::undefined() },
 343   { "CreateMinidumpOnCrash",        JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 344   { "CMSMarkStackSizeMax",          JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 345   { "CMSMarkStackSize",             JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 346   { "G1MarkStackSize",              JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 347   { "ParallelMarkingThreads",       JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 348   { "ParallelCMSThreads",           JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(10) },
 349 
 350   // -------------- Obsolete Flags - sorted by expired_in --------------
 351   { "UseOldInlining",                JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 352   { "SafepointPollOffset",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 353   { "UseBoundThreads",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 354   { "DefaultThreadPriority",         JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 355   { "NoYieldsInMicrolock",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 356   { "BackEdgeThreshold",             JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 357   { "UseNewReflection",              JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 358   { "ReflectionWrapResolutionErrors",JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 359   { "VerifyReflectionBytecodes",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 360   { "AutoShutdownNMT",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 361   { "NmethodSweepFraction",          JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 362   { "NmethodSweepCheckInterval",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 363   { "CodeCacheMinimumFreeSpace",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 364 #ifndef ZERO
 365   { "UseFastAccessorMethods",        JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 366   { "UseFastEmptyMethods",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 367 #endif // ZERO
 368   { "UseCompilerSafepoints",         JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 369   { "AdaptiveSizePausePolicy",       JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 370   { "ParallelGCRetainPLAB",          JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 371   { "ThreadSafetyMargin",            JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 372   { "LazyBootClassLoader",           JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 373   { "StarvationMonitorInterval",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 374   { "PreInflateSpin",                JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 375   { "JNIDetachReleasesMonitors",     JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 376   { "UseAltSigs",                    JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 377   { "SegmentedHeapDumpThreshold",    JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 378   { "PrintOopAddress",               JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(10) },
 379 
 380 #ifdef TEST_VERIFY_SPECIAL_JVM_FLAGS
 381   { "dep &gt; obs",                    JDK_Version::jdk(9), JDK_Version::jdk(8), JDK_Version::undefined() },
 382   { "dep &gt; exp ",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::jdk(8) },
 383   { "obs &gt; exp ",                   JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::jdk(8) },
 384   { "not deprecated or obsolete",   JDK_Version::undefined(), JDK_Version::undefined(), JDK_Version::jdk(9) },
 385   { "dup option",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 386   { "dup option",                   JDK_Version::jdk(9), JDK_Version::undefined(), JDK_Version::undefined() },
 387   { "BytecodeVerificationRemote",   JDK_Version::undefined(), JDK_Version::jdk(9), JDK_Version::undefined() },
 388 #endif
 389 
 390   { NULL, JDK_Version(0), JDK_Version(0) }
 391 };
 392 
 393 // Flags that are aliases for other flags.
 394 typedef struct {
 395   const char* alias_name;
 396   const char* real_name;
 397 } AliasedFlag;
 398 
 399 static AliasedFlag const aliased_jvm_flags[] = {
 400   { "DefaultMaxRAMFraction",    "MaxRAMFraction"    },
 401   { "CMSMarkStackSizeMax",      "MarkStackSizeMax"  },
 402   { "CMSMarkStackSize",         "MarkStackSize"     },
 403   { "G1MarkStackSize",          "MarkStackSize"     },
 404   { "ParallelMarkingThreads",   "ConcGCThreads"     },
 405   { "ParallelCMSThreads",       "ConcGCThreads"     },
 406   { "CreateMinidumpOnCrash",    "CreateCoredumpOnCrash" },
 407   { NULL, NULL}
 408 };
 409 
 410 // NOTE: A compatibility request will be necessary for each alias to be removed.
 411 static AliasedLoggingFlag const aliased_logging_flags[] = {
 412   { "PrintCompressedOopsMode",   LogLevel::Info,  true,  LOG_TAGS(gc, heap, coops) },
 413   { "TraceBiasedLocking",        LogLevel::Info,  true,  LOG_TAGS(biasedlocking) },
 414   { "TraceClassLoading",         LogLevel::Info,  true,  LOG_TAGS(class, load) },
 415   { "TraceClassLoadingPreorder", LogLevel::Debug, true,  LOG_TAGS(class, preorder) },
 416   { "TraceClassPaths",           LogLevel::Info,  true,  LOG_TAGS(class, path) },
 417   { "TraceClassResolution",      LogLevel::Debug, true,  LOG_TAGS(class, resolve) },
 418   { "TraceClassUnloading",       LogLevel::Info,  true,  LOG_TAGS(class, unload) },
 419   { "TraceExceptions",           LogLevel::Info,  true,  LOG_TAGS(exceptions) },
 420   { "TraceLoaderConstraints",    LogLevel::Info,  true,  LOG_TAGS(class, loader, constraints) },
 421   { "TraceMonitorInflation",     LogLevel::Debug, true,  LOG_TAGS(monitorinflation) },
 422   { "TraceSafepointCleanupTime", LogLevel::Info,  true,  LOG_TAGS(safepoint, cleanup) },
 423   { "TraceJVMTIObjectTagging",   LogLevel::Debug, true,  LOG_TAGS(jvmti, objecttagging) },
 424   { "TraceRedefineClasses",      LogLevel::Info,  false, LOG_TAGS(redefine, class) },
 425   { NULL,                        LogLevel::Off,   false, LOG_TAGS(_NO_TAG) }
 426 };
 427 
 428 #ifndef PRODUCT
 429 // These options are removed in jdk9. Remove this code for jdk10.
 430 static AliasedFlag const removed_develop_logging_flags[] = {
 431   { "TraceClassInitialization",   "-Xlog:class+init" },
 432   { "TraceClassLoaderData",       "-Xlog:class+loader+data" },
 433   { "TraceDefaultMethods",        "-Xlog:defaultmethods=debug" },
 434   { "TraceItables",               "-Xlog:itables=debug" },
 435   { "TraceMonitorMismatch",       "-Xlog:monitormismatch=info" },
 436   { "TraceSafepoint",             "-Xlog:safepoint=debug" },
 437   { "TraceStartupTime",           "-Xlog:startuptime" },
 438   { "TraceVMOperation",           "-Xlog:vmoperation=debug" },
 439   { "PrintVtables",               "-Xlog:vtables=debug" },
 440   { "VerboseVerification",        "-Xlog:verification" },
 441   { NULL, NULL }
 442 };
 443 #endif //PRODUCT
 444 
 445 // Return true if "v" is less than "other", where "other" may be "undefined".
 446 static bool version_less_than(JDK_Version v, JDK_Version other) {
 447   assert(!v.is_undefined(), "must be defined");
 448   if (!other.is_undefined() &amp;&amp; v.compare(other) &gt;= 0) {
 449     return false;
 450   } else {
 451     return true;
 452   }
 453 }
 454 
 455 static bool lookup_special_flag(const char *flag_name, SpecialFlag&amp; flag) {
 456   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 457     if ((strcmp(special_jvm_flags[i].name, flag_name) == 0)) {
 458       flag = special_jvm_flags[i];
 459       return true;
 460     }
 461   }
 462   return false;
 463 }
 464 
 465 bool Arguments::is_obsolete_flag(const char *flag_name, JDK_Version* version) {
 466   assert(version != NULL, "Must provide a version buffer");
 467   SpecialFlag flag;
 468   if (lookup_special_flag(flag_name, flag)) {
 469     if (!flag.obsolete_in.is_undefined()) {
 470       if (version_less_than(JDK_Version::current(), flag.expired_in)) {
 471         *version = flag.obsolete_in;
 472         return true;
 473       }
 474     }
 475   }
 476   return false;
 477 }
 478 
 479 int Arguments::is_deprecated_flag(const char *flag_name, JDK_Version* version) {
 480   assert(version != NULL, "Must provide a version buffer");
 481   SpecialFlag flag;
 482   if (lookup_special_flag(flag_name, flag)) {
 483     if (!flag.deprecated_in.is_undefined()) {
 484       if (version_less_than(JDK_Version::current(), flag.obsolete_in) &amp;&amp;
 485           version_less_than(JDK_Version::current(), flag.expired_in)) {
 486         *version = flag.deprecated_in;
 487         return 1;
 488       } else {
 489         return -1;
 490       }
 491     }
 492   }
 493   return 0;
 494 }
 495 
 496 #ifndef PRODUCT
 497 const char* Arguments::removed_develop_logging_flag_name(const char* name){
 498   for (size_t i = 0; removed_develop_logging_flags[i].alias_name != NULL; i++) {
 499     const AliasedFlag&amp; flag = removed_develop_logging_flags[i];
 500     if (strcmp(flag.alias_name, name) == 0) {
 501       return flag.real_name;
 502     }
 503   }
 504   return NULL;
 505 }
 506 #endif // PRODUCT
 507 
 508 const char* Arguments::real_flag_name(const char *flag_name) {
 509   for (size_t i = 0; aliased_jvm_flags[i].alias_name != NULL; i++) {
 510     const AliasedFlag&amp; flag_status = aliased_jvm_flags[i];
 511     if (strcmp(flag_status.alias_name, flag_name) == 0) {
 512         return flag_status.real_name;
 513     }
 514   }
 515   return flag_name;
 516 }
 517 
 518 #ifdef ASSERT
 519 static bool lookup_special_flag(const char *flag_name, size_t skip_index) {
 520   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 521     if ((i != skip_index) &amp;&amp; (strcmp(special_jvm_flags[i].name, flag_name) == 0)) {
 522       return true;
 523     }
 524   }
 525   return false;
 526 }
 527 
 528 static bool verify_special_jvm_flags() {
 529   bool success = true;
 530   for (size_t i = 0; special_jvm_flags[i].name != NULL; i++) {
 531     const SpecialFlag&amp; flag = special_jvm_flags[i];
 532     if (lookup_special_flag(flag.name, i)) {
 533       warning("Duplicate special flag declaration \"%s\"", flag.name);
 534       success = false;
 535     }
 536     if (flag.deprecated_in.is_undefined() &amp;&amp;
 537         flag.obsolete_in.is_undefined()) {
 538       warning("Special flag entry \"%s\" must declare version deprecated and/or obsoleted in.", flag.name);
 539       success = false;
 540     }
 541 
 542     if (!flag.deprecated_in.is_undefined()) {
 543       if (!version_less_than(flag.deprecated_in, flag.obsolete_in)) {
 544         warning("Special flag entry \"%s\" must be deprecated before obsoleted.", flag.name);
 545         success = false;
 546       }
 547 
 548       if (!version_less_than(flag.deprecated_in, flag.expired_in)) {
 549         warning("Special flag entry \"%s\" must be deprecated before expired.", flag.name);
 550         success = false;
 551       }
 552     }
 553 
 554     if (!flag.obsolete_in.is_undefined()) {
 555       if (!version_less_than(flag.obsolete_in, flag.expired_in)) {
 556         warning("Special flag entry \"%s\" must be obsoleted before expired.", flag.name);
 557         success = false;
 558       }
 559 
 560       // if flag has become obsolete it should not have a "globals" flag defined anymore.
 561       if (!version_less_than(JDK_Version::current(), flag.obsolete_in)) {
 562         if (Flag::find_flag(flag.name) != NULL) {
 563           warning("Global variable for obsolete special flag entry \"%s\" should be removed", flag.name);
 564           success = false;
 565         }
 566       }
 567     }
 568 
 569     if (!flag.expired_in.is_undefined()) {
 570       // if flag has become expired it should not have a "globals" flag defined anymore.
 571       if (!version_less_than(JDK_Version::current(), flag.expired_in)) {
 572         if (Flag::find_flag(flag.name) != NULL) {
 573           warning("Global variable for expired flag entry \"%s\" should be removed", flag.name);
 574           success = false;
 575         }
 576       }
 577     }
 578 
 579   }
 580   return success;
 581 }
 582 #endif
 583 
 584 // Parses a size specification string.
 585 bool Arguments::atojulong(const char *s, julong* result) {
 586   julong n = 0;
 587 
 588   // First char must be a digit. Don't allow negative numbers or leading spaces.
 589   if (!isdigit(*s)) {
 590     return false;
 591   }
 592 
 593   bool is_hex = (s[0] == '0' &amp;&amp; (s[1] == 'x' || s[1] == 'X'));
 594   char* remainder;
 595   errno = 0;
 596   n = strtoull(s, &amp;remainder, (is_hex ? 16 : 10));
 597   if (errno != 0) {
 598     return false;
 599   }
 600 
 601   // Fail if no number was read at all or if the remainder contains more than a single non-digit character.
 602   if (remainder == s || strlen(remainder) &gt; 1) {
 603     return false;
 604   }
 605 
 606   switch (*remainder) {
 607     case 'T': case 't':
 608       *result = n * G * K;
 609       // Check for overflow.
 610       if (*result/((julong)G * K) != n) return false;
 611       return true;
 612     case 'G': case 'g':
 613       *result = n * G;
 614       if (*result/G != n) return false;
 615       return true;
 616     case 'M': case 'm':
 617       *result = n * M;
 618       if (*result/M != n) return false;
 619       return true;
 620     case 'K': case 'k':
 621       *result = n * K;
 622       if (*result/K != n) return false;
 623       return true;
 624     case '\0':
 625       *result = n;
 626       return true;
 627     default:
 628       return false;
 629   }
 630 }
 631 
 632 Arguments::ArgsRange Arguments::check_memory_size(julong size, julong min_size) {
 633   if (size &lt; min_size) return arg_too_small;
 634   // Check that size will fit in a size_t (only relevant on 32-bit)
 635   if (size &gt; max_uintx) return arg_too_big;
 636   return arg_in_range;
 637 }
 638 
 639 // Describe an argument out of range error
 640 void Arguments::describe_range_error(ArgsRange errcode) {
 641   switch(errcode) {
 642   case arg_too_big:
 643     jio_fprintf(defaultStream::error_stream(),
 644                 "The specified size exceeds the maximum "
 645                 "representable size.\n");
 646     break;
 647   case arg_too_small:
 648   case arg_unreadable:
 649   case arg_in_range:
 650     // do nothing for now
 651     break;
 652   default:
 653     ShouldNotReachHere();
 654   }
 655 }
 656 
 657 static bool set_bool_flag(const char* name, bool value, Flag::Flags origin) {
 658   if (CommandLineFlags::boolAtPut(name, &amp;value, origin) == Flag::SUCCESS) {
 659     return true;
 660   } else {
 661     return false;
 662   }
 663 }
 664 
 665 static bool set_fp_numeric_flag(const char* name, char* value, Flag::Flags origin) {
 666   char* end;
 667   errno = 0;
 668   double v = strtod(value, &amp;end);
 669   if ((errno != 0) || (*end != 0)) {
 670     return false;
 671   }
 672 
 673   if (CommandLineFlags::doubleAtPut(name, &amp;v, origin) == Flag::SUCCESS) {
 674     return true;
 675   }
 676   return false;
 677 }
 678 
 679 static bool set_numeric_flag(const char* name, char* value, Flag::Flags origin) {
 680   julong v;
 681   int int_v;
 682   intx intx_v;
 683   bool is_neg = false;
 684   Flag* result = Flag::find_flag(name, strlen(name));
 685 
 686   if (result == NULL) {
 687     return false;
 688   }
 689 
 690   // Check the sign first since atojulong() parses only unsigned values.
 691   if (*value == '-') {
 692     if (!result-&gt;is_intx() &amp;&amp; !result-&gt;is_int()) {
 693       return false;
 694     }
 695     value++;
 696     is_neg = true;
 697   }
 698   if (!Arguments::atojulong(value, &amp;v)) {
 699     return false;
 700   }
 701   if (result-&gt;is_int()) {
 702     int_v = (int) v;
 703     if (is_neg) {
 704       int_v = -int_v;
 705     }
 706     return CommandLineFlags::intAtPut(result, &amp;int_v, origin) == Flag::SUCCESS;
 707   } else if (result-&gt;is_uint()) {
 708     uint uint_v = (uint) v;
 709     return CommandLineFlags::uintAtPut(result, &amp;uint_v, origin) == Flag::SUCCESS;
 710   } else if (result-&gt;is_intx()) {
 711     intx_v = (intx) v;
 712     if (is_neg) {
 713       intx_v = -intx_v;
 714     }
 715     return CommandLineFlags::intxAtPut(result, &amp;intx_v, origin) == Flag::SUCCESS;
 716   } else if (result-&gt;is_uintx()) {
 717     uintx uintx_v = (uintx) v;
 718     return CommandLineFlags::uintxAtPut(result, &amp;uintx_v, origin) == Flag::SUCCESS;
 719   } else if (result-&gt;is_uint64_t()) {
 720     uint64_t uint64_t_v = (uint64_t) v;
 721     return CommandLineFlags::uint64_tAtPut(result, &amp;uint64_t_v, origin) == Flag::SUCCESS;
 722   } else if (result-&gt;is_size_t()) {
 723     size_t size_t_v = (size_t) v;
 724     return CommandLineFlags::size_tAtPut(result, &amp;size_t_v, origin) == Flag::SUCCESS;
 725   } else {
 726     return false;
 727   }
 728 }
 729 
 730 static bool set_string_flag(const char* name, const char* value, Flag::Flags origin) {
 731   if (CommandLineFlags::ccstrAtPut(name, &amp;value, origin) != Flag::SUCCESS) return false;
 732   // Contract:  CommandLineFlags always returns a pointer that needs freeing.
 733   FREE_C_HEAP_ARRAY(char, value);
 734   return true;
 735 }
 736 
 737 static bool append_to_string_flag(const char* name, const char* new_value, Flag::Flags origin) {
 738   const char* old_value = "";
 739   if (CommandLineFlags::ccstrAt(name, &amp;old_value) != Flag::SUCCESS) return false;
 740   size_t old_len = old_value != NULL ? strlen(old_value) : 0;
 741   size_t new_len = strlen(new_value);
 742   const char* value;
 743   char* free_this_too = NULL;
 744   if (old_len == 0) {
 745     value = new_value;
 746   } else if (new_len == 0) {
 747     value = old_value;
 748   } else {
 749     char* buf = NEW_C_HEAP_ARRAY(char, old_len + 1 + new_len + 1, mtArguments);
 750     // each new setting adds another LINE to the switch:
 751     sprintf(buf, "%s\n%s", old_value, new_value);
 752     value = buf;
 753     free_this_too = buf;
 754   }
 755   (void) CommandLineFlags::ccstrAtPut(name, &amp;value, origin);
 756   // CommandLineFlags always returns a pointer that needs freeing.
 757   FREE_C_HEAP_ARRAY(char, value);
 758   if (free_this_too != NULL) {
 759     // CommandLineFlags made its own copy, so I must delete my own temp. buffer.
 760     FREE_C_HEAP_ARRAY(char, free_this_too);
 761   }
 762   return true;
 763 }
 764 
 765 const char* Arguments::handle_aliases_and_deprecation(const char* arg, bool warn) {
 766   const char* real_name = real_flag_name(arg);
 767   JDK_Version since = JDK_Version();
 768   switch (is_deprecated_flag(arg, &amp;since)) {
 769     case -1:
 770       return NULL; // obsolete or expired, don't process normally
 771     case 0:
 772       return real_name;
 773     case 1: {
 774       if (warn) {
 775         char version[256];
 776         since.to_string(version, sizeof(version));
 777         if (real_name != arg) {
 778           warning("Option %s was deprecated in version %s and will likely be removed in a future release. Use option %s instead.",
 779                   arg, version, real_name);
 780         } else {
 781           warning("Option %s was deprecated in version %s and will likely be removed in a future release.",
 782                   arg, version);
 783         }
 784       }
 785       return real_name;
 786     }
 787   }
 788   ShouldNotReachHere();
 789   return NULL;
 790 }
 791 
 792 void log_deprecated_flag(const char* name, bool on, AliasedLoggingFlag alf) {
 793   LogTagType tagSet[] = {alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5};
 794   // Set tagset string buffer at max size of 256, large enough for any alias tagset
 795   const int max_tagset_size = 256;
 796   int max_tagset_len = max_tagset_size - 1;
 797   char tagset_buffer[max_tagset_size];
 798   tagset_buffer[0] = '\0';
 799 
 800   // Write tag-set for aliased logging option, in string list form
 801   int max_tags = sizeof(tagSet)/sizeof(tagSet[0]);
 802   for (int i = 0; i &lt; max_tags &amp;&amp; tagSet[i] != LogTag::__NO_TAG; i++) {
 803     if (i &gt; 0) {
 804       strncat(tagset_buffer, "+", max_tagset_len - strlen(tagset_buffer));
 805     }
 806     strncat(tagset_buffer, LogTag::name(tagSet[i]), max_tagset_len - strlen(tagset_buffer));
 807   }
 808   if (!alf.exactMatch) {
 809       strncat(tagset_buffer, "*", max_tagset_len - strlen(tagset_buffer));
 810   }
 811   log_warning(arguments)("-XX:%s%s is deprecated. Will use -Xlog:%s=%s instead.",
 812                          (on) ? "+" : "-",
 813                          name,
 814                          tagset_buffer,
 815                          (on) ? LogLevel::name(alf.level) : "off");
 816 }
 817 
 818 AliasedLoggingFlag Arguments::catch_logging_aliases(const char* name, bool on){
 819   for (size_t i = 0; aliased_logging_flags[i].alias_name != NULL; i++) {
 820     const AliasedLoggingFlag&amp; alf = aliased_logging_flags[i];
 821     if (strcmp(alf.alias_name, name) == 0) {
 822       log_deprecated_flag(name, on, alf);
 823       return alf;
 824     }
 825   }
 826   AliasedLoggingFlag a = {NULL, LogLevel::Off, false, LOG_TAGS(_NO_TAG)};
 827   return a;
 828 }
 829 
 830 bool Arguments::parse_argument(const char* arg, Flag::Flags origin) {
 831 
 832   // range of acceptable characters spelled out for portability reasons
 833 #define NAME_RANGE  "[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_]"
 834 #define BUFLEN 255
 835   char name[BUFLEN+1];
 836   char dummy;
 837   const char* real_name;
 838   bool warn_if_deprecated = true;
 839 
 840   if (sscanf(arg, "-%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;dummy) == 1) {
 841     AliasedLoggingFlag alf = catch_logging_aliases(name, false);
 842     if (alf.alias_name != NULL){
 843       LogConfiguration::configure_stdout(LogLevel::Off, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 844       return true;
 845     }
 846     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 847     if (real_name == NULL) {
 848       return false;
 849     }
 850     return set_bool_flag(real_name, false, origin);
 851   }
 852   if (sscanf(arg, "+%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;dummy) == 1) {
 853     AliasedLoggingFlag alf = catch_logging_aliases(name, true);
 854     if (alf.alias_name != NULL){
 855       LogConfiguration::configure_stdout(alf.level, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 856       return true;
 857     }
 858     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 859     if (real_name == NULL) {
 860       return false;
 861     }
 862     return set_bool_flag(real_name, true, origin);
 863   }
 864 
 865   char punct;
 866   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "%c", name, &amp;punct) == 2 &amp;&amp; punct == '=') {
 867     const char* value = strchr(arg, '=') + 1;
 868     Flag* flag;
 869 
 870     // this scanf pattern matches both strings (handled here) and numbers (handled later))
 871     AliasedLoggingFlag alf = catch_logging_aliases(name, true);
 872     if (alf.alias_name != NULL) {
 873       LogConfiguration::configure_stdout(alf.level, alf.exactMatch, alf.tag0, alf.tag1, alf.tag2, alf.tag3, alf.tag4, alf.tag5);
 874       return true;
 875     }
 876     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 877     if (real_name == NULL) {
 878       return false;
 879     }
 880     flag = Flag::find_flag(real_name);
 881     if (flag != NULL &amp;&amp; flag-&gt;is_ccstr()) {
 882       if (flag-&gt;ccstr_accumulates()) {
 883         return append_to_string_flag(real_name, value, origin);
 884       } else {
 885         if (value[0] == '\0') {
 886           value = NULL;
 887         }
 888         return set_string_flag(real_name, value, origin);
 889       }
 890     } else {
 891       warn_if_deprecated = false; // if arg is deprecated, we've already done warning...
 892     }
 893   }
 894 
 895   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE ":%c", name, &amp;punct) == 2 &amp;&amp; punct == '=') {
 896     const char* value = strchr(arg, '=') + 1;
 897     // -XX:Foo:=xxx will reset the string flag to the given value.
 898     if (value[0] == '\0') {
 899       value = NULL;
 900     }
 901     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 902     if (real_name == NULL) {
 903       return false;
 904     }
 905     return set_string_flag(real_name, value, origin);
 906   }
 907 
 908 #define SIGNED_FP_NUMBER_RANGE "[-0123456789.eE+]"
 909 #define SIGNED_NUMBER_RANGE    "[-0123456789]"
 910 #define        NUMBER_RANGE    "[0123456789eE+-]"
 911   char value[BUFLEN + 1];
 912   char value2[BUFLEN + 1];
 913   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) SIGNED_NUMBER_RANGE "." "%" XSTR(BUFLEN) NUMBER_RANGE "%c", name, value, value2, &amp;dummy) == 3) {
 914     // Looks like a floating-point number -- try again with more lenient format string
 915     if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) SIGNED_FP_NUMBER_RANGE "%c", name, value, &amp;dummy) == 2) {
 916       real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 917       if (real_name == NULL) {
 918         return false;
 919       }
 920       return set_fp_numeric_flag(real_name, value, origin);
 921     }
 922   }
 923 
 924 #define VALUE_RANGE "[-kmgtxKMGTX0123456789abcdefABCDEF]"
 925   if (sscanf(arg, "%" XSTR(BUFLEN) NAME_RANGE "=" "%" XSTR(BUFLEN) VALUE_RANGE "%c", name, value, &amp;dummy) == 2) {
 926     real_name = handle_aliases_and_deprecation(name, warn_if_deprecated);
 927     if (real_name == NULL) {
 928       return false;
 929     }
 930     return set_numeric_flag(real_name, value, origin);
 931   }
 932 
 933   return false;
 934 }
 935 
 936 void Arguments::add_string(char*** bldarray, int* count, const char* arg) {
 937   assert(bldarray != NULL, "illegal argument");
 938 
 939   if (arg == NULL) {
 940     return;
 941   }
 942 
 943   int new_count = *count + 1;
 944 
 945   // expand the array and add arg to the last element
 946   if (*bldarray == NULL) {
 947     *bldarray = NEW_C_HEAP_ARRAY(char*, new_count, mtArguments);
 948   } else {
 949     *bldarray = REALLOC_C_HEAP_ARRAY(char*, *bldarray, new_count, mtArguments);
 950   }
 951   (*bldarray)[*count] = os::strdup_check_oom(arg);
 952   *count = new_count;
 953 }
 954 
 955 void Arguments::build_jvm_args(const char* arg) {
 956   add_string(&amp;_jvm_args_array, &amp;_num_jvm_args, arg);
 957 }
 958 
 959 void Arguments::build_jvm_flags(const char* arg) {
 960   add_string(&amp;_jvm_flags_array, &amp;_num_jvm_flags, arg);
 961 }
 962 
 963 // utility function to return a string that concatenates all
 964 // strings in a given char** array
 965 const char* Arguments::build_resource_string(char** args, int count) {
 966   if (args == NULL || count == 0) {
 967     return NULL;
 968   }
 969   size_t length = strlen(args[0]) + 1; // add 1 for the null terminator
 970   for (int i = 1; i &lt; count; i++) {
 971     length += strlen(args[i]) + 1; // add 1 for a space
 972   }
 973   char* s = NEW_RESOURCE_ARRAY(char, length);
 974   strcpy(s, args[0]);
 975   for (int j = 1; j &lt; count; j++) {
 976     strcat(s, " ");
 977     strcat(s, args[j]);
 978   }
 979   return (const char*) s;
 980 }
 981 
 982 void Arguments::print_on(outputStream* st) {
 983   st-&gt;print_cr("VM Arguments:");
 984   if (num_jvm_flags() &gt; 0) {
 985     st-&gt;print("jvm_flags: "); print_jvm_flags_on(st);
 986     st-&gt;cr();
 987   }
 988   if (num_jvm_args() &gt; 0) {
 989     st-&gt;print("jvm_args: "); print_jvm_args_on(st);
 990     st-&gt;cr();
 991   }
 992   st-&gt;print_cr("java_command: %s", java_command() ? java_command() : "&lt;unknown&gt;");
 993   if (_java_class_path != NULL) {
 994     char* path = _java_class_path-&gt;value();
 995     st-&gt;print_cr("java_class_path (initial): %s", strlen(path) == 0 ? "&lt;not set&gt;" : path );
 996   }
 997   st-&gt;print_cr("Launcher Type: %s", _sun_java_launcher);
 998 }
 999 
1000 void Arguments::print_summary_on(outputStream* st) {
1001   // Print the command line.  Environment variables that are helpful for
1002   // reproducing the problem are written later in the hs_err file.
1003   // flags are from setting file
1004   if (num_jvm_flags() &gt; 0) {
1005     st-&gt;print_raw("Settings File: ");
1006     print_jvm_flags_on(st);
1007     st-&gt;cr();
1008   }
1009   // args are the command line and environment variable arguments.
1010   st-&gt;print_raw("Command Line: ");
1011   if (num_jvm_args() &gt; 0) {
1012     print_jvm_args_on(st);
1013   }
1014   // this is the classfile and any arguments to the java program
1015   if (java_command() != NULL) {
1016     st-&gt;print("%s", java_command());
1017   }
1018   st-&gt;cr();
1019 }
1020 
1021 void Arguments::print_jvm_flags_on(outputStream* st) {
1022   if (_num_jvm_flags &gt; 0) {
1023     for (int i=0; i &lt; _num_jvm_flags; i++) {
1024       st-&gt;print("%s ", _jvm_flags_array[i]);
1025     }
1026   }
1027 }
1028 
1029 void Arguments::print_jvm_args_on(outputStream* st) {
1030   if (_num_jvm_args &gt; 0) {
1031     for (int i=0; i &lt; _num_jvm_args; i++) {
1032       st-&gt;print("%s ", _jvm_args_array[i]);
1033     }
1034   }
1035 }
1036 
1037 bool Arguments::process_argument(const char* arg,
1038                                  jboolean ignore_unrecognized,
1039                                  Flag::Flags origin) {
1040   JDK_Version since = JDK_Version();
1041 
1042   if (parse_argument(arg, origin)) {
1043     return true;
1044   }
1045 
1046   // Determine if the flag has '+', '-', or '=' characters.
1047   bool has_plus_minus = (*arg == '+' || *arg == '-');
1048   const char* const argname = has_plus_minus ? arg + 1 : arg;
1049 
1050   size_t arg_len;
1051   const char* equal_sign = strchr(argname, '=');
1052   if (equal_sign == NULL) {
1053     arg_len = strlen(argname);
1054   } else {
1055     arg_len = equal_sign - argname;
1056   }
1057 
1058   // Only make the obsolete check for valid arguments.
1059   if (arg_len &lt;= BUFLEN) {
1060     // Construct a string which consists only of the argument name without '+', '-', or '='.
1061     char stripped_argname[BUFLEN+1];
1062     strncpy(stripped_argname, argname, arg_len);
1063     stripped_argname[arg_len] = '\0';  // strncpy may not null terminate.
1064     if (is_obsolete_flag(stripped_argname, &amp;since)) {
1065       char version[256];
1066       since.to_string(version, sizeof(version));
1067       warning("Ignoring option %s; support was removed in %s", stripped_argname, version);
1068       return true;
1069     }
1070 #ifndef PRODUCT
1071     else {
1072       const char* replacement;
1073       if ((replacement = removed_develop_logging_flag_name(stripped_argname)) != NULL){
1074         log_warning(arguments)("%s has been removed. Please use %s instead.",
1075                                stripped_argname,
1076                                replacement);
1077         return false;
1078       }
1079     }
1080 #endif //PRODUCT
1081   }
1082 
1083   // For locked flags, report a custom error message if available.
1084   // Otherwise, report the standard unrecognized VM option.
1085   Flag* found_flag = Flag::find_flag((const char*)argname, arg_len, true, true);
1086   if (found_flag != NULL) {
1087     char locked_message_buf[BUFLEN];
1088     Flag::MsgType msg_type = found_flag-&gt;get_locked_message(locked_message_buf, BUFLEN);
1089     if (strlen(locked_message_buf) == 0) {
1090       if (found_flag-&gt;is_bool() &amp;&amp; !has_plus_minus) {
1091         jio_fprintf(defaultStream::error_stream(),
1092           "Missing +/- setting for VM option '%s'\n", argname);
1093       } else if (!found_flag-&gt;is_bool() &amp;&amp; has_plus_minus) {
1094         jio_fprintf(defaultStream::error_stream(),
1095           "Unexpected +/- setting in VM option '%s'\n", argname);
1096       } else {
1097         jio_fprintf(defaultStream::error_stream(),
1098           "Improperly specified VM option '%s'\n", argname);
1099       }
1100     } else {
1101 #ifdef PRODUCT
1102       bool mismatched = ((msg_type == Flag::NOTPRODUCT_FLAG_BUT_PRODUCT_BUILD) ||
1103                          (msg_type == Flag::DEVELOPER_FLAG_BUT_PRODUCT_BUILD));
1104       if (ignore_unrecognized &amp;&amp; mismatched) {
1105         return true;
1106       }
1107 #endif
1108       jio_fprintf(defaultStream::error_stream(), "%s", locked_message_buf);
1109     }
1110   } else {
1111     if (ignore_unrecognized) {
1112       return true;
1113     }
1114     jio_fprintf(defaultStream::error_stream(),
1115                 "Unrecognized VM option '%s'\n", argname);
1116     Flag* fuzzy_matched = Flag::fuzzy_match((const char*)argname, arg_len, true);
1117     if (fuzzy_matched != NULL) {
1118       jio_fprintf(defaultStream::error_stream(),
1119                   "Did you mean '%s%s%s'? ",
1120                   (fuzzy_matched-&gt;is_bool()) ? "(+/-)" : "",
1121                   fuzzy_matched-&gt;_name,
1122                   (fuzzy_matched-&gt;is_bool()) ? "" : "=&lt;value&gt;");
1123     }
1124   }
1125 
1126   // allow for commandline "commenting out" options like -XX:#+Verbose
1127   return arg[0] == '#';
1128 }
1129 
1130 bool Arguments::process_settings_file(const char* file_name, bool should_exist, jboolean ignore_unrecognized) {
1131   FILE* stream = fopen(file_name, "rb");
1132   if (stream == NULL) {
1133     if (should_exist) {
1134       jio_fprintf(defaultStream::error_stream(),
1135                   "Could not open settings file %s\n", file_name);
1136       return false;
1137     } else {
1138       return true;
1139     }
1140   }
1141 
1142   char token[1024];
1143   int  pos = 0;
1144 
1145   bool in_white_space = true;
1146   bool in_comment     = false;
1147   bool in_quote       = false;
1148   char quote_c        = 0;
1149   bool result         = true;
1150 
1151   int c = getc(stream);
1152   while(c != EOF &amp;&amp; pos &lt; (int)(sizeof(token)-1)) {
1153     if (in_white_space) {
1154       if (in_comment) {
1155         if (c == '\n') in_comment = false;
1156       } else {
1157         if (c == '#') in_comment = true;
1158         else if (!isspace(c)) {
1159           in_white_space = false;
1160           token[pos++] = c;
1161         }
1162       }
1163     } else {
1164       if (c == '\n' || (!in_quote &amp;&amp; isspace(c))) {
1165         // token ends at newline, or at unquoted whitespace
1166         // this allows a way to include spaces in string-valued options
1167         token[pos] = '\0';
1168         logOption(token);
1169         result &amp;= process_argument(token, ignore_unrecognized, Flag::CONFIG_FILE);
1170         build_jvm_flags(token);
1171         pos = 0;
1172         in_white_space = true;
1173         in_quote = false;
1174       } else if (!in_quote &amp;&amp; (c == '\'' || c == '"')) {
1175         in_quote = true;
1176         quote_c = c;
1177       } else if (in_quote &amp;&amp; (c == quote_c)) {
1178         in_quote = false;
1179       } else {
1180         token[pos++] = c;
1181       }
1182     }
1183     c = getc(stream);
1184   }
1185   if (pos &gt; 0) {
1186     token[pos] = '\0';
1187     result &amp;= process_argument(token, ignore_unrecognized, Flag::CONFIG_FILE);
1188     build_jvm_flags(token);
1189   }
1190   fclose(stream);
1191   return result;
1192 }
1193 
1194 //=============================================================================================================
1195 // Parsing of properties (-D)
1196 
1197 const char* Arguments::get_property(const char* key) {
1198   return PropertyList_get_value(system_properties(), key);
1199 }
1200 
1201 bool Arguments::add_property(const char* prop) {
1202   const char* eq = strchr(prop, '=');
1203   const char* key;
1204   const char* value = "";
1205 
1206   if (eq == NULL) {
1207     // property doesn't have a value, thus use passed string
1208     key = prop;
1209   } else {
1210     // property have a value, thus extract it and save to the
1211     // allocated string
1212     size_t key_len = eq - prop;
1213     char* tmp_key = AllocateHeap(key_len + 1, mtArguments);
1214 
1215     strncpy(tmp_key, prop, key_len);
1216     tmp_key[key_len] = '\0';
1217     key = tmp_key;
1218 
1219     value = &amp;prop[key_len + 1];
1220   }
1221 
1222   if (strcmp(key, "java.compiler") == 0) {
1223     process_java_compiler_argument(value);
1224     // Record value in Arguments, but let it get passed to Java.
1225   } else if (strcmp(key, "sun.java.launcher.is_altjvm") == 0 ||
1226              strcmp(key, "sun.java.launcher.pid") == 0) {
1227     // sun.java.launcher.is_altjvm and sun.java.launcher.pid property are
1228     // private and are processed in process_sun_java_launcher_properties();
1229     // the sun.java.launcher property is passed on to the java application
1230   } else if (strcmp(key, "sun.boot.library.path") == 0) {
1231     PropertyList_unique_add(&amp;_system_properties, key, value, true);
1232   } else {
1233     if (strcmp(key, "sun.java.command") == 0) {
1234       char *old_java_command = _java_command;
1235       _java_command = os::strdup_check_oom(value, mtArguments);
1236       if (old_java_command != NULL) {
1237         os::free(old_java_command);
1238       }
1239     } else if (strcmp(key, "java.vendor.url.bug") == 0) {
1240       const char* old_java_vendor_url_bug = _java_vendor_url_bug;
1241       // save it in _java_vendor_url_bug, so JVM fatal error handler can access
1242       // its value without going through the property list or making a Java call.
1243       _java_vendor_url_bug = os::strdup_check_oom(value, mtArguments);
1244       if (old_java_vendor_url_bug != DEFAULT_VENDOR_URL_BUG) {
1245         assert(old_java_vendor_url_bug != NULL, "_java_vendor_url_bug is NULL");
1246         os::free((void *)old_java_vendor_url_bug);
1247       }
1248     }
1249 
1250     // Create new property and add at the end of the list
1251     PropertyList_unique_add(&amp;_system_properties, key, value);
1252   }
1253 
1254   if (key != prop) {
1255     // SystemProperty copy passed value, thus free previously allocated
1256     // memory
1257     FreeHeap((void *)key);
1258   }
1259 
1260   return true;
1261 }
1262 
1263 // sets or adds a module name to the jdk.launcher.addmods property
1264 bool Arguments::append_to_addmods_property(const char* module_name) {
1265   const char* key = "jdk.launcher.addmods";
1266   const char* old_value = Arguments::get_property(key);
1267   size_t buf_len = strlen(key) + strlen(module_name) + 2;
1268   if (old_value != NULL) {
1269     buf_len += strlen(old_value) + 1;
1270   }
1271   char* new_value = AllocateHeap(buf_len, mtArguments);
1272   if (new_value == NULL) {
1273     return false;
1274   }
1275   if (old_value == NULL) {
1276     jio_snprintf(new_value, buf_len, "%s=%s", key, module_name);
1277   } else {
1278     jio_snprintf(new_value, buf_len, "%s=%s,%s", key, old_value, module_name);
1279   }
1280   bool added = add_property(new_value);
1281   FreeHeap(new_value);
1282   return added;
1283 }
1284 
1285 #if INCLUDE_CDS
1286 void Arguments::check_unsupported_dumping_properties() {
1287   assert(DumpSharedSpaces, "this function is only used with -Xshare:dump");
1288   const char* unsupported_properties[5] = { "jdk.module.main",
1289                                            "jdk.module.path",
1290                                            "jdk.upgrade.module.path",
1291                                            "jdk.launcher.addmods",
1292                                            "jdk.launcher.limitmods" };
1293   const char* unsupported_options[5] = { "-m",
1294                                         "-modulepath",
1295                                         "-upgrademodulepath",
1296                                         "-addmods",
1297                                         "-limitmods" };
1298   SystemProperty* sp = system_properties();
1299   while (sp != NULL) {
1300     for (int i = 0; i &lt; 5; i++) {
1301       if (strcmp(sp-&gt;key(), unsupported_properties[i]) == 0) {
1302           vm_exit_during_initialization(
1303             "Cannot use the following option when dumping the shared archive", unsupported_options[i]);
1304       }
1305     }
1306     sp = sp-&gt;next();
1307   }
1308 }
1309 #endif
1310 
1311 //===========================================================================================================
1312 // Setting int/mixed/comp mode flags
1313 
1314 void Arguments::set_mode_flags(Mode mode) {
1315   // Set up default values for all flags.
1316   // If you add a flag to any of the branches below,
1317   // add a default value for it here.
1318   set_java_compiler(false);
1319   _mode                      = mode;
1320 
1321   // Ensure Agent_OnLoad has the correct initial values.
1322   // This may not be the final mode; mode may change later in onload phase.
1323   PropertyList_unique_add(&amp;_system_properties, "java.vm.info",
1324                           VM_Version::vm_info_string(), false);
1325 
1326   UseInterpreter             = true;
1327   UseCompiler                = true;
1328   UseLoopCounter             = true;
1329 
1330   // Default values may be platform/compiler dependent -
1331   // use the saved values
1332   ClipInlining               = Arguments::_ClipInlining;
1333   AlwaysCompileLoopMethods   = Arguments::_AlwaysCompileLoopMethods;
1334   UseOnStackReplacement      = Arguments::_UseOnStackReplacement;
1335   BackgroundCompilation      = Arguments::_BackgroundCompilation;
1336   if (TieredCompilation) {
1337     if (FLAG_IS_DEFAULT(Tier3InvokeNotifyFreqLog)) {
1338       Tier3InvokeNotifyFreqLog = Arguments::_Tier3InvokeNotifyFreqLog;
1339     }
1340     if (FLAG_IS_DEFAULT(Tier4InvocationThreshold)) {
1341       Tier4InvocationThreshold = Arguments::_Tier4InvocationThreshold;
1342     }
1343   }
1344 
1345   // Change from defaults based on mode
1346   switch (mode) {
1347   default:
1348     ShouldNotReachHere();
1349     break;
1350   case _int:
1351     UseCompiler              = false;
1352     UseLoopCounter           = false;
1353     AlwaysCompileLoopMethods = false;
1354     UseOnStackReplacement    = false;
1355     break;
1356   case _mixed:
1357     // same as default
1358     break;
1359   case _comp:
1360     UseInterpreter           = false;
1361     BackgroundCompilation    = false;
1362     ClipInlining             = false;
1363     // Be much more aggressive in tiered mode with -Xcomp and exercise C2 more.
1364     // We will first compile a level 3 version (C1 with full profiling), then do one invocation of it and
1365     // compile a level 4 (C2) and then continue executing it.
1366     if (TieredCompilation) {
1367       Tier3InvokeNotifyFreqLog = 0;
1368       Tier4InvocationThreshold = 0;
1369     }
1370     break;
1371   }
1372 }
1373 
1374 #if defined(COMPILER2) || INCLUDE_JVMCI || defined(_LP64) || !INCLUDE_CDS
1375 // Conflict: required to use shared spaces (-Xshare:on), but
1376 // incompatible command line options were chosen.
1377 
1378 static void no_shared_spaces(const char* message) {
1379   if (RequireSharedSpaces) {
1380     jio_fprintf(defaultStream::error_stream(),
1381       "Class data sharing is inconsistent with other specified options.\n");
1382     vm_exit_during_initialization("Unable to use shared archive.", message);
1383   } else {
1384     FLAG_SET_DEFAULT(UseSharedSpaces, false);
1385   }
1386 }
1387 #endif
1388 
1389 // Returns threshold scaled with the value of scale.
1390 // If scale &lt; 0.0, threshold is returned without scaling.
1391 intx Arguments::scaled_compile_threshold(intx threshold, double scale) {
1392   if (scale == 1.0 || scale &lt; 0.0) {
1393     return threshold;
1394   } else {
1395     return (intx)(threshold * scale);
1396   }
1397 }
1398 
1399 // Returns freq_log scaled with the value of scale.
1400 // Returned values are in the range of [0, InvocationCounter::number_of_count_bits + 1].
1401 // If scale &lt; 0.0, freq_log is returned without scaling.
1402 intx Arguments::scaled_freq_log(intx freq_log, double scale) {
1403   // Check if scaling is necessary or if negative value was specified.
1404   if (scale == 1.0 || scale &lt; 0.0) {
1405     return freq_log;
1406   }
1407   // Check values to avoid calculating log2 of 0.
1408   if (scale == 0.0 || freq_log == 0) {
1409     return 0;
1410   }
1411   // Determine the maximum notification frequency value currently supported.
1412   // The largest mask value that the interpreter/C1 can handle is
1413   // of length InvocationCounter::number_of_count_bits. Mask values are always
1414   // one bit shorter then the value of the notification frequency. Set
1415   // max_freq_bits accordingly.
1416   intx max_freq_bits = InvocationCounter::number_of_count_bits + 1;
1417   intx scaled_freq = scaled_compile_threshold((intx)1 &lt;&lt; freq_log, scale);
1418   if (scaled_freq == 0) {
1419     // Return 0 right away to avoid calculating log2 of 0.
1420     return 0;
1421   } else if (scaled_freq &gt; nth_bit(max_freq_bits)) {
1422     return max_freq_bits;
1423   } else {
1424     return log2_intptr(scaled_freq);
1425   }
1426 }
1427 
1428 void Arguments::set_tiered_flags() {
1429   // With tiered, set default policy to AdvancedThresholdPolicy, which is 3.
1430   if (FLAG_IS_DEFAULT(CompilationPolicyChoice)) {
1431     FLAG_SET_DEFAULT(CompilationPolicyChoice, 3);
1432   }
1433   if (CompilationPolicyChoice &lt; 2) {
1434     vm_exit_during_initialization(
1435       "Incompatible compilation policy selected", NULL);
1436   }
1437   // Increase the code cache size - tiered compiles a lot more.
1438   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
1439     FLAG_SET_ERGO(uintx, ReservedCodeCacheSize,
1440                   MIN2(CODE_CACHE_DEFAULT_LIMIT, ReservedCodeCacheSize * 5));
1441   }
1442   // Enable SegmentedCodeCache if TieredCompilation is enabled and ReservedCodeCacheSize &gt;= 240M
1443   if (FLAG_IS_DEFAULT(SegmentedCodeCache) &amp;&amp; ReservedCodeCacheSize &gt;= 240*M) {
1444     FLAG_SET_ERGO(bool, SegmentedCodeCache, true);
1445   }
1446   if (!UseInterpreter) { // -Xcomp
1447     Tier3InvokeNotifyFreqLog = 0;
1448     Tier4InvocationThreshold = 0;
1449   }
1450 
1451   if (CompileThresholdScaling &lt; 0) {
1452     vm_exit_during_initialization("Negative value specified for CompileThresholdScaling", NULL);
1453   }
1454 
1455   // Scale tiered compilation thresholds.
1456   // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves compilation thresholds unchanged.
1457   if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
1458     FLAG_SET_ERGO(intx, Tier0InvokeNotifyFreqLog, scaled_freq_log(Tier0InvokeNotifyFreqLog));
1459     FLAG_SET_ERGO(intx, Tier0BackedgeNotifyFreqLog, scaled_freq_log(Tier0BackedgeNotifyFreqLog));
1460 
1461     FLAG_SET_ERGO(intx, Tier3InvocationThreshold, scaled_compile_threshold(Tier3InvocationThreshold));
1462     FLAG_SET_ERGO(intx, Tier3MinInvocationThreshold, scaled_compile_threshold(Tier3MinInvocationThreshold));
1463     FLAG_SET_ERGO(intx, Tier3CompileThreshold, scaled_compile_threshold(Tier3CompileThreshold));
1464     FLAG_SET_ERGO(intx, Tier3BackEdgeThreshold, scaled_compile_threshold(Tier3BackEdgeThreshold));
1465 
1466     // Tier2{Invocation,MinInvocation,Compile,Backedge}Threshold should be scaled here
1467     // once these thresholds become supported.
1468 
1469     FLAG_SET_ERGO(intx, Tier2InvokeNotifyFreqLog, scaled_freq_log(Tier2InvokeNotifyFreqLog));
1470     FLAG_SET_ERGO(intx, Tier2BackedgeNotifyFreqLog, scaled_freq_log(Tier2BackedgeNotifyFreqLog));
1471 
1472     FLAG_SET_ERGO(intx, Tier3InvokeNotifyFreqLog, scaled_freq_log(Tier3InvokeNotifyFreqLog));
1473     FLAG_SET_ERGO(intx, Tier3BackedgeNotifyFreqLog, scaled_freq_log(Tier3BackedgeNotifyFreqLog));
1474 
1475     FLAG_SET_ERGO(intx, Tier23InlineeNotifyFreqLog, scaled_freq_log(Tier23InlineeNotifyFreqLog));
1476 
1477     FLAG_SET_ERGO(intx, Tier4InvocationThreshold, scaled_compile_threshold(Tier4InvocationThreshold));
1478     FLAG_SET_ERGO(intx, Tier4MinInvocationThreshold, scaled_compile_threshold(Tier4MinInvocationThreshold));
1479     FLAG_SET_ERGO(intx, Tier4CompileThreshold, scaled_compile_threshold(Tier4CompileThreshold));
1480     FLAG_SET_ERGO(intx, Tier4BackEdgeThreshold, scaled_compile_threshold(Tier4BackEdgeThreshold));
1481   }
1482 }
1483 
1484 #if INCLUDE_ALL_GCS
1485 static void disable_adaptive_size_policy(const char* collector_name) {
1486   if (UseAdaptiveSizePolicy) {
1487     if (FLAG_IS_CMDLINE(UseAdaptiveSizePolicy)) {
1488       warning("Disabling UseAdaptiveSizePolicy; it is incompatible with %s.",
1489               collector_name);
1490     }
1491     FLAG_SET_DEFAULT(UseAdaptiveSizePolicy, false);
1492   }
1493 }
1494 
1495 void Arguments::set_parnew_gc_flags() {
1496   assert(!UseSerialGC &amp;&amp; !UseParallelOldGC &amp;&amp; !UseParallelGC &amp;&amp; !UseG1GC,
1497          "control point invariant");
1498   assert(UseConcMarkSweepGC, "CMS is expected to be on here");
1499   assert(UseParNewGC, "ParNew should always be used with CMS");
1500 
1501   if (FLAG_IS_DEFAULT(ParallelGCThreads)) {
1502     FLAG_SET_DEFAULT(ParallelGCThreads, Abstract_VM_Version::parallel_worker_threads());
1503     assert(ParallelGCThreads &gt; 0, "We should always have at least one thread by default");
1504   } else if (ParallelGCThreads == 0) {
1505     jio_fprintf(defaultStream::error_stream(),
1506         "The ParNew GC can not be combined with -XX:ParallelGCThreads=0\n");
1507     vm_exit(1);
1508   }
1509 
1510   // By default YoungPLABSize and OldPLABSize are set to 4096 and 1024 respectively,
1511   // these settings are default for Parallel Scavenger. For ParNew+Tenured configuration
1512   // we set them to 1024 and 1024.
1513   // See CR 6362902.
1514   if (FLAG_IS_DEFAULT(YoungPLABSize)) {
1515     FLAG_SET_DEFAULT(YoungPLABSize, (intx)1024);
1516   }
1517   if (FLAG_IS_DEFAULT(OldPLABSize)) {
1518     FLAG_SET_DEFAULT(OldPLABSize, (intx)1024);
1519   }
1520 
1521   // When using compressed oops, we use local overflow stacks,
1522   // rather than using a global overflow list chained through
1523   // the klass word of the object's pre-image.
1524   if (UseCompressedOops &amp;&amp; !ParGCUseLocalOverflow) {
1525     if (!FLAG_IS_DEFAULT(ParGCUseLocalOverflow)) {
1526       warning("Forcing +ParGCUseLocalOverflow: needed if using compressed references");
1527     }
1528     FLAG_SET_DEFAULT(ParGCUseLocalOverflow, true);
1529   }
1530   assert(ParGCUseLocalOverflow || !UseCompressedOops, "Error");
1531 }
1532 
1533 // Adjust some sizes to suit CMS and/or ParNew needs; these work well on
1534 // sparc/solaris for certain applications, but would gain from
1535 // further optimization and tuning efforts, and would almost
1536 // certainly gain from analysis of platform and environment.
1537 void Arguments::set_cms_and_parnew_gc_flags() {
1538   assert(!UseSerialGC &amp;&amp; !UseParallelOldGC &amp;&amp; !UseParallelGC, "Error");
1539   assert(UseConcMarkSweepGC, "CMS is expected to be on here");
1540   assert(UseParNewGC, "ParNew should always be used with CMS");
1541 
1542   // Turn off AdaptiveSizePolicy by default for cms until it is complete.
1543   disable_adaptive_size_policy("UseConcMarkSweepGC");
1544 
1545   set_parnew_gc_flags();
1546 
1547   size_t max_heap = align_size_down(MaxHeapSize,
1548                                     CardTableRS::ct_max_alignment_constraint());
1549 
1550   // Now make adjustments for CMS
1551   intx   tenuring_default = (intx)6;
1552   size_t young_gen_per_worker = CMSYoungGenPerWorker;
1553 
1554   // Preferred young gen size for "short" pauses:
1555   // upper bound depends on # of threads and NewRatio.
1556   const size_t preferred_max_new_size_unaligned =
1557     MIN2(max_heap/(NewRatio+1), ScaleForWordSize(young_gen_per_worker * ParallelGCThreads));
1558   size_t preferred_max_new_size =
1559     align_size_up(preferred_max_new_size_unaligned, os::vm_page_size());
1560 
1561   // Unless explicitly requested otherwise, size young gen
1562   // for "short" pauses ~ CMSYoungGenPerWorker*ParallelGCThreads
1563 
1564   // If either MaxNewSize or NewRatio is set on the command line,
1565   // assume the user is trying to set the size of the young gen.
1566   if (FLAG_IS_DEFAULT(MaxNewSize) &amp;&amp; FLAG_IS_DEFAULT(NewRatio)) {
1567 
1568     // Set MaxNewSize to our calculated preferred_max_new_size unless
1569     // NewSize was set on the command line and it is larger than
1570     // preferred_max_new_size.
1571     if (!FLAG_IS_DEFAULT(NewSize)) {   // NewSize explicitly set at command-line
1572       FLAG_SET_ERGO(size_t, MaxNewSize, MAX2(NewSize, preferred_max_new_size));
1573     } else {
1574       FLAG_SET_ERGO(size_t, MaxNewSize, preferred_max_new_size);
1575     }
1576     log_trace(gc, heap)("CMS ergo set MaxNewSize: " SIZE_FORMAT, MaxNewSize);
1577 
1578     // Code along this path potentially sets NewSize and OldSize
1579     log_trace(gc, heap)("CMS set min_heap_size: " SIZE_FORMAT " initial_heap_size:  " SIZE_FORMAT " max_heap: " SIZE_FORMAT,
1580                         min_heap_size(), InitialHeapSize, max_heap);
1581     size_t min_new = preferred_max_new_size;
1582     if (FLAG_IS_CMDLINE(NewSize)) {
1583       min_new = NewSize;
1584     }
1585     if (max_heap &gt; min_new &amp;&amp; min_heap_size() &gt; min_new) {
1586       // Unless explicitly requested otherwise, make young gen
1587       // at least min_new, and at most preferred_max_new_size.
1588       if (FLAG_IS_DEFAULT(NewSize)) {
1589         FLAG_SET_ERGO(size_t, NewSize, MAX2(NewSize, min_new));
1590         FLAG_SET_ERGO(size_t, NewSize, MIN2(preferred_max_new_size, NewSize));
1591         log_trace(gc, heap)("CMS ergo set NewSize: " SIZE_FORMAT, NewSize);
1592       }
1593       // Unless explicitly requested otherwise, size old gen
1594       // so it's NewRatio x of NewSize.
1595       if (FLAG_IS_DEFAULT(OldSize)) {
1596         if (max_heap &gt; NewSize) {
1597           FLAG_SET_ERGO(size_t, OldSize, MIN2(NewRatio*NewSize, max_heap - NewSize));
1598           log_trace(gc, heap)("CMS ergo set OldSize: " SIZE_FORMAT, OldSize);
1599         }
1600       }
1601     }
1602   }
1603   // Unless explicitly requested otherwise, definitely
1604   // promote all objects surviving "tenuring_default" scavenges.
1605   if (FLAG_IS_DEFAULT(MaxTenuringThreshold) &amp;&amp;
1606       FLAG_IS_DEFAULT(SurvivorRatio)) {
1607     FLAG_SET_ERGO(uintx, MaxTenuringThreshold, tenuring_default);
1608   }
1609   // If we decided above (or user explicitly requested)
1610   // `promote all' (via MaxTenuringThreshold := 0),
1611   // prefer minuscule survivor spaces so as not to waste
1612   // space for (non-existent) survivors
1613   if (FLAG_IS_DEFAULT(SurvivorRatio) &amp;&amp; MaxTenuringThreshold == 0) {
1614     FLAG_SET_ERGO(uintx, SurvivorRatio, MAX2((uintx)1024, SurvivorRatio));
1615   }
1616 
1617   // OldPLABSize is interpreted in CMS as not the size of the PLAB in words,
1618   // but rather the number of free blocks of a given size that are used when
1619   // replenishing the local per-worker free list caches.
1620   if (FLAG_IS_DEFAULT(OldPLABSize)) {
1621     if (!FLAG_IS_DEFAULT(ResizeOldPLAB) &amp;&amp; !ResizeOldPLAB) {
1622       // OldPLAB sizing manually turned off: Use a larger default setting,
1623       // unless it was manually specified. This is because a too-low value
1624       // will slow down scavenges.
1625       FLAG_SET_ERGO(size_t, OldPLABSize, CompactibleFreeListSpaceLAB::_default_static_old_plab_size); // default value before 6631166
1626     } else {
1627       FLAG_SET_DEFAULT(OldPLABSize, CompactibleFreeListSpaceLAB::_default_dynamic_old_plab_size); // old CMSParPromoteBlocksToClaim default
1628     }
1629   }
1630 
1631   // If either of the static initialization defaults have changed, note this
1632   // modification.
1633   if (!FLAG_IS_DEFAULT(OldPLABSize) || !FLAG_IS_DEFAULT(OldPLABWeight)) {
1634     CompactibleFreeListSpaceLAB::modify_initialization(OldPLABSize, OldPLABWeight);
1635   }
1636 
1637   if (!ClassUnloading) {
1638     FLAG_SET_CMDLINE(bool, CMSClassUnloadingEnabled, false);
1639     FLAG_SET_CMDLINE(bool, ExplicitGCInvokesConcurrentAndUnloadsClasses, false);
1640   }
1641 
1642   log_trace(gc)("MarkStackSize: %uk  MarkStackSizeMax: %uk", (unsigned int) (MarkStackSize / K), (uint) (MarkStackSizeMax / K));
1643 }
1644 #endif // INCLUDE_ALL_GCS
1645 
1646 void set_object_alignment() {
1647   // Object alignment.
1648   assert(is_power_of_2(ObjectAlignmentInBytes), "ObjectAlignmentInBytes must be power of 2");
1649   MinObjAlignmentInBytes     = ObjectAlignmentInBytes;
1650   assert(MinObjAlignmentInBytes &gt;= HeapWordsPerLong * HeapWordSize, "ObjectAlignmentInBytes value is too small");
1651   MinObjAlignment            = MinObjAlignmentInBytes / HeapWordSize;
1652   assert(MinObjAlignmentInBytes == MinObjAlignment * HeapWordSize, "ObjectAlignmentInBytes value is incorrect");
1653   MinObjAlignmentInBytesMask = MinObjAlignmentInBytes - 1;
1654 
1655   LogMinObjAlignmentInBytes  = exact_log2(ObjectAlignmentInBytes);
1656   LogMinObjAlignment         = LogMinObjAlignmentInBytes - LogHeapWordSize;
1657 
1658   // Oop encoding heap max
1659   OopEncodingHeapMax = (uint64_t(max_juint) + 1) &lt;&lt; LogMinObjAlignmentInBytes;
1660 
1661   if (SurvivorAlignmentInBytes == 0) {
1662     SurvivorAlignmentInBytes = ObjectAlignmentInBytes;
1663   }
1664 
1665 #if INCLUDE_ALL_GCS
1666   // Set CMS global values
1667   CompactibleFreeListSpace::set_cms_values();
1668 #endif // INCLUDE_ALL_GCS
1669 }
1670 
1671 size_t Arguments::max_heap_for_compressed_oops() {
1672   // Avoid sign flip.
1673   assert(OopEncodingHeapMax &gt; (uint64_t)os::vm_page_size(), "Unusual page size");
1674   // We need to fit both the NULL page and the heap into the memory budget, while
1675   // keeping alignment constraints of the heap. To guarantee the latter, as the
1676   // NULL page is located before the heap, we pad the NULL page to the conservative
1677   // maximum alignment that the GC may ever impose upon the heap.
1678   size_t displacement_due_to_null_page = align_size_up_(os::vm_page_size(),
1679                                                         _conservative_max_heap_alignment);
1680 
1681   LP64_ONLY(return OopEncodingHeapMax - displacement_due_to_null_page);
1682   NOT_LP64(ShouldNotReachHere(); return 0);
1683 }
1684 
1685 bool Arguments::should_auto_select_low_pause_collector() {
1686   if (UseAutoGCSelectPolicy &amp;&amp;
1687       !FLAG_IS_DEFAULT(MaxGCPauseMillis) &amp;&amp;
1688       (MaxGCPauseMillis &lt;= AutoGCSelectPauseMillis)) {
1689     log_trace(gc)("Automatic selection of the low pause collector based on pause goal of %d (ms)", (int) MaxGCPauseMillis);
1690     return true;
1691   }
1692   return false;
1693 }
1694 
1695 void Arguments::set_use_compressed_oops() {
1696 #ifndef ZERO
1697 #ifdef _LP64
1698   // MaxHeapSize is not set up properly at this point, but
1699   // the only value that can override MaxHeapSize if we are
1700   // to use UseCompressedOops is InitialHeapSize.
1701   size_t max_heap_size = MAX2(MaxHeapSize, InitialHeapSize);
1702 
1703   if (max_heap_size &lt;= max_heap_for_compressed_oops()) {
1704 #if !defined(COMPILER1) || defined(TIERED)
1705     if (FLAG_IS_DEFAULT(UseCompressedOops)) {
1706       FLAG_SET_ERGO(bool, UseCompressedOops, true);
1707     }
1708 #endif
1709   } else {
1710     if (UseCompressedOops &amp;&amp; !FLAG_IS_DEFAULT(UseCompressedOops)) {
1711       warning("Max heap size too large for Compressed Oops");
1712       FLAG_SET_DEFAULT(UseCompressedOops, false);
1713       FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1714     }
1715   }
1716 #endif // _LP64
1717 #endif // ZERO
1718 }
1719 
1720 
1721 // NOTE: set_use_compressed_klass_ptrs() must be called after calling
1722 // set_use_compressed_oops().
1723 void Arguments::set_use_compressed_klass_ptrs() {
1724 #ifndef ZERO
1725 #ifdef _LP64
1726   // UseCompressedOops must be on for UseCompressedClassPointers to be on.
1727   if (!UseCompressedOops) {
1728     if (UseCompressedClassPointers) {
1729       warning("UseCompressedClassPointers requires UseCompressedOops");
1730     }
1731     FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1732   } else {
1733     // Turn on UseCompressedClassPointers too
1734     if (FLAG_IS_DEFAULT(UseCompressedClassPointers)) {
1735       FLAG_SET_ERGO(bool, UseCompressedClassPointers, true);
1736     }
1737     // Check the CompressedClassSpaceSize to make sure we use compressed klass ptrs.
1738     if (UseCompressedClassPointers) {
1739       if (CompressedClassSpaceSize &gt; KlassEncodingMetaspaceMax) {
1740         warning("CompressedClassSpaceSize is too large for UseCompressedClassPointers");
1741         FLAG_SET_DEFAULT(UseCompressedClassPointers, false);
1742       }
1743     }
1744   }
1745 #endif // _LP64
1746 #endif // !ZERO
1747 }
1748 
1749 void Arguments::set_conservative_max_heap_alignment() {
1750   // The conservative maximum required alignment for the heap is the maximum of
1751   // the alignments imposed by several sources: any requirements from the heap
1752   // itself, the collector policy and the maximum page size we may run the VM
1753   // with.
1754   size_t heap_alignment = GenCollectedHeap::conservative_max_heap_alignment();
1755 #if INCLUDE_ALL_GCS
1756   if (UseParallelGC) {
1757     heap_alignment = ParallelScavengeHeap::conservative_max_heap_alignment();
1758   } else if (UseG1GC) {
1759     heap_alignment = G1CollectedHeap::conservative_max_heap_alignment();
1760   }
1761 #endif // INCLUDE_ALL_GCS
1762   _conservative_max_heap_alignment = MAX4(heap_alignment,
1763                                           (size_t)os::vm_allocation_granularity(),
1764                                           os::max_page_size(),
1765                                           CollectorPolicy::compute_heap_alignment());
1766 }
1767 
1768 bool Arguments::gc_selected() {
1769 #if INCLUDE_ALL_GCS
1770   return UseSerialGC || UseParallelGC || UseParallelOldGC || UseConcMarkSweepGC || UseG1GC;
1771 #else
1772   return UseSerialGC;
1773 #endif // INCLUDE_ALL_GCS
1774 }
1775 
1776 void Arguments::select_gc_ergonomically() {
1777 #if INCLUDE_ALL_GCS
1778   if (os::is_server_class_machine()) {
1779     if (should_auto_select_low_pause_collector()) {
1780       FLAG_SET_ERGO_IF_DEFAULT(bool, UseConcMarkSweepGC, true);
1781     } else {
1782 #if defined(JAVASE_EMBEDDED)
1783       FLAG_SET_ERGO_IF_DEFAULT(bool, UseParallelGC, true);
1784 #else
1785       FLAG_SET_ERGO_IF_DEFAULT(bool, UseG1GC, true);
1786 #endif
1787     }
1788   } else {
1789     FLAG_SET_ERGO_IF_DEFAULT(bool, UseSerialGC, true);
1790   }
1791 #else
1792   UNSUPPORTED_OPTION(UseG1GC);
1793   UNSUPPORTED_OPTION(UseParallelGC);
1794   UNSUPPORTED_OPTION(UseParallelOldGC);
1795   UNSUPPORTED_OPTION(UseConcMarkSweepGC);
1796   UNSUPPORTED_OPTION(UseParNewGC);
1797   FLAG_SET_ERGO_IF_DEFAULT(bool, UseSerialGC, true);
1798 #endif // INCLUDE_ALL_GCS
1799 }
1800 
1801 void Arguments::select_gc() {
1802   if (!gc_selected()) {
1803     select_gc_ergonomically();
1804     if (!gc_selected()) {
1805       vm_exit_during_initialization("Garbage collector not selected (default collector explicitly disabled)", NULL);
1806     }
1807   }
1808 }
1809 
1810 void Arguments::set_ergonomics_flags() {
1811   select_gc();
1812 
1813 #if defined(COMPILER2) || INCLUDE_JVMCI
1814   // Shared spaces work fine with other GCs but causes bytecode rewriting
1815   // to be disabled, which hurts interpreter performance and decreases
1816   // server performance.  When -server is specified, keep the default off
1817   // unless it is asked for.  Future work: either add bytecode rewriting
1818   // at link time, or rewrite bytecodes in non-shared methods.
1819   if (!DumpSharedSpaces &amp;&amp; !RequireSharedSpaces &amp;&amp;
1820       (FLAG_IS_DEFAULT(UseSharedSpaces) || !UseSharedSpaces)) {
1821     no_shared_spaces("COMPILER2 default: -Xshare:auto | off, have to manually setup to on.");
1822   }
1823 #endif
1824 
1825   set_conservative_max_heap_alignment();
1826 
1827 #ifndef ZERO
1828 #ifdef _LP64
1829   set_use_compressed_oops();
1830 
1831   // set_use_compressed_klass_ptrs() must be called after calling
1832   // set_use_compressed_oops().
1833   set_use_compressed_klass_ptrs();
1834 
1835   // Also checks that certain machines are slower with compressed oops
1836   // in vm_version initialization code.
1837 #endif // _LP64
1838 #endif // !ZERO
1839 
1840   CodeCacheExtensions::set_ergonomics_flags();
1841 }
1842 
1843 void Arguments::set_parallel_gc_flags() {
1844   assert(UseParallelGC || UseParallelOldGC, "Error");
1845   // Enable ParallelOld unless it was explicitly disabled (cmd line or rc file).
1846   if (FLAG_IS_DEFAULT(UseParallelOldGC)) {
1847     FLAG_SET_DEFAULT(UseParallelOldGC, true);
1848   }
1849   FLAG_SET_DEFAULT(UseParallelGC, true);
1850 
1851   // If no heap maximum was requested explicitly, use some reasonable fraction
1852   // of the physical memory, up to a maximum of 1GB.
1853   FLAG_SET_DEFAULT(ParallelGCThreads,
1854                    Abstract_VM_Version::parallel_worker_threads());
1855   if (ParallelGCThreads == 0) {
1856     jio_fprintf(defaultStream::error_stream(),
1857         "The Parallel GC can not be combined with -XX:ParallelGCThreads=0\n");
1858     vm_exit(1);
1859   }
1860 
1861   if (UseAdaptiveSizePolicy) {
1862     // We don't want to limit adaptive heap sizing's freedom to adjust the heap
1863     // unless the user actually sets these flags.
1864     if (FLAG_IS_DEFAULT(MinHeapFreeRatio)) {
1865       FLAG_SET_DEFAULT(MinHeapFreeRatio, 0);
1866     }
1867     if (FLAG_IS_DEFAULT(MaxHeapFreeRatio)) {
1868       FLAG_SET_DEFAULT(MaxHeapFreeRatio, 100);
1869     }
1870   }
1871 
1872   // If InitialSurvivorRatio or MinSurvivorRatio were not specified, but the
1873   // SurvivorRatio has been set, reset their default values to SurvivorRatio +
1874   // 2.  By doing this we make SurvivorRatio also work for Parallel Scavenger.
1875   // See CR 6362902 for details.
1876   if (!FLAG_IS_DEFAULT(SurvivorRatio)) {
1877     if (FLAG_IS_DEFAULT(InitialSurvivorRatio)) {
1878        FLAG_SET_DEFAULT(InitialSurvivorRatio, SurvivorRatio + 2);
1879     }
1880     if (FLAG_IS_DEFAULT(MinSurvivorRatio)) {
1881       FLAG_SET_DEFAULT(MinSurvivorRatio, SurvivorRatio + 2);
1882     }
1883   }
1884 
1885   if (UseParallelOldGC) {
1886     // Par compact uses lower default values since they are treated as
1887     // minimums.  These are different defaults because of the different
1888     // interpretation and are not ergonomically set.
1889     if (FLAG_IS_DEFAULT(MarkSweepDeadRatio)) {
1890       FLAG_SET_DEFAULT(MarkSweepDeadRatio, 1);
1891     }
1892   }
1893 }
1894 
1895 void Arguments::set_g1_gc_flags() {
1896   assert(UseG1GC, "Error");
1897 #if defined(COMPILER1) || INCLUDE_JVMCI
1898   FastTLABRefill = false;
1899 #endif
1900   FLAG_SET_DEFAULT(ParallelGCThreads, Abstract_VM_Version::parallel_worker_threads());
1901   if (ParallelGCThreads == 0) {
1902     assert(!FLAG_IS_DEFAULT(ParallelGCThreads), "The default value for ParallelGCThreads should not be 0.");
1903     vm_exit_during_initialization("The flag -XX:+UseG1GC can not be combined with -XX:ParallelGCThreads=0", NULL);
1904   }
1905 
1906 #if INCLUDE_ALL_GCS
1907   if (FLAG_IS_DEFAULT(G1ConcRefinementThreads)) {
1908     FLAG_SET_ERGO(uint, G1ConcRefinementThreads, ParallelGCThreads);
1909   }
1910 #endif
1911 
1912   // MarkStackSize will be set (if it hasn't been set by the user)
1913   // when concurrent marking is initialized.
1914   // Its value will be based upon the number of parallel marking threads.
1915   // But we do set the maximum mark stack size here.
1916   if (FLAG_IS_DEFAULT(MarkStackSizeMax)) {
1917     FLAG_SET_DEFAULT(MarkStackSizeMax, 128 * TASKQUEUE_SIZE);
1918   }
1919 
1920   if (FLAG_IS_DEFAULT(GCTimeRatio) || GCTimeRatio == 0) {
1921     // In G1, we want the default GC overhead goal to be higher than
1922     // it is for PS, or the heap might be expanded too aggressively.
1923     // We set it here to ~8%.
1924     FLAG_SET_DEFAULT(GCTimeRatio, 12);
1925   }
1926 
1927   // Below, we might need to calculate the pause time interval based on
1928   // the pause target. When we do so we are going to give G1 maximum
1929   // flexibility and allow it to do pauses when it needs to. So, we'll
1930   // arrange that the pause interval to be pause time target + 1 to
1931   // ensure that a) the pause time target is maximized with respect to
1932   // the pause interval and b) we maintain the invariant that pause
1933   // time target &lt; pause interval. If the user does not want this
1934   // maximum flexibility, they will have to set the pause interval
1935   // explicitly.
1936 
1937   if (FLAG_IS_DEFAULT(MaxGCPauseMillis)) {
1938     // The default pause time target in G1 is 200ms
1939     FLAG_SET_DEFAULT(MaxGCPauseMillis, 200);
1940   }
1941 
1942   // Then, if the interval parameter was not set, set it according to
1943   // the pause time target (this will also deal with the case when the
1944   // pause time target is the default value).
1945   if (FLAG_IS_DEFAULT(GCPauseIntervalMillis)) {
1946     FLAG_SET_DEFAULT(GCPauseIntervalMillis, MaxGCPauseMillis + 1);
1947   }
1948 
1949   log_trace(gc)("MarkStackSize: %uk  MarkStackSizeMax: %uk", (unsigned int) (MarkStackSize / K), (uint) (MarkStackSizeMax / K));
1950 }
1951 
1952 void Arguments::set_gc_specific_flags() {
1953 #if INCLUDE_ALL_GCS
1954   // Set per-collector flags
1955   if (UseParallelGC || UseParallelOldGC) {
1956     set_parallel_gc_flags();
1957   } else if (UseConcMarkSweepGC) {
1958     set_cms_and_parnew_gc_flags();
1959   } else if (UseG1GC) {
1960     set_g1_gc_flags();
1961   }
1962   if (AssumeMP &amp;&amp; !UseSerialGC) {
1963     if (FLAG_IS_DEFAULT(ParallelGCThreads) &amp;&amp; ParallelGCThreads == 1) {
1964       warning("If the number of processors is expected to increase from one, then"
1965               " you should configure the number of parallel GC threads appropriately"
1966               " using -XX:ParallelGCThreads=N");
1967     }
1968   }
1969   if (MinHeapFreeRatio == 100) {
1970     // Keeping the heap 100% free is hard ;-) so limit it to 99%.
1971     FLAG_SET_ERGO(uintx, MinHeapFreeRatio, 99);
1972   }
1973 #endif // INCLUDE_ALL_GCS
1974 }
1975 
1976 julong Arguments::limit_by_allocatable_memory(julong limit) {
1977   julong max_allocatable;
1978   julong result = limit;
1979   if (os::has_allocatable_memory_limit(&amp;max_allocatable)) {
1980     result = MIN2(result, max_allocatable / MaxVirtMemFraction);
1981   }
1982   return result;
1983 }
1984 
1985 // Use static initialization to get the default before parsing
1986 static const size_t DefaultHeapBaseMinAddress = HeapBaseMinAddress;
1987 
1988 void Arguments::set_heap_size() {
1989   const julong phys_mem =
1990     FLAG_IS_DEFAULT(MaxRAM) ? MIN2(os::physical_memory(), (julong)MaxRAM)
1991                             : (julong)MaxRAM;
1992 
1993   // If the maximum heap size has not been set with -Xmx,
1994   // then set it as fraction of the size of physical memory,
1995   // respecting the maximum and minimum sizes of the heap.
1996   if (FLAG_IS_DEFAULT(MaxHeapSize)) {
1997     julong reasonable_max = phys_mem / MaxRAMFraction;
1998 
1999     if (phys_mem &lt;= MaxHeapSize * MinRAMFraction) {
2000       // Small physical memory, so use a minimum fraction of it for the heap
2001       reasonable_max = phys_mem / MinRAMFraction;
2002     } else {
2003       // Not-small physical memory, so require a heap at least
2004       // as large as MaxHeapSize
2005       reasonable_max = MAX2(reasonable_max, (julong)MaxHeapSize);
2006     }
2007     if (!FLAG_IS_DEFAULT(ErgoHeapSizeLimit) &amp;&amp; ErgoHeapSizeLimit != 0) {
2008       // Limit the heap size to ErgoHeapSizeLimit
2009       reasonable_max = MIN2(reasonable_max, (julong)ErgoHeapSizeLimit);
2010     }
2011     if (UseCompressedOops) {
2012       // Limit the heap size to the maximum possible when using compressed oops
2013       julong max_coop_heap = (julong)max_heap_for_compressed_oops();
2014 
2015       // HeapBaseMinAddress can be greater than default but not less than.
2016       if (!FLAG_IS_DEFAULT(HeapBaseMinAddress)) {
2017         if (HeapBaseMinAddress &lt; DefaultHeapBaseMinAddress) {
2018           // matches compressed oops printing flags
2019           log_debug(gc, heap, coops)("HeapBaseMinAddress must be at least " SIZE_FORMAT
2020                                      " (" SIZE_FORMAT "G) which is greater than value given " SIZE_FORMAT,
2021                                      DefaultHeapBaseMinAddress,
2022                                      DefaultHeapBaseMinAddress/G,
2023                                      HeapBaseMinAddress);
2024           FLAG_SET_ERGO(size_t, HeapBaseMinAddress, DefaultHeapBaseMinAddress);
2025         }
2026       }
2027 
2028       if (HeapBaseMinAddress + MaxHeapSize &lt; max_coop_heap) {
2029         // Heap should be above HeapBaseMinAddress to get zero based compressed oops
2030         // but it should be not less than default MaxHeapSize.
2031         max_coop_heap -= HeapBaseMinAddress;
2032       }
2033       reasonable_max = MIN2(reasonable_max, max_coop_heap);
2034     }
2035     reasonable_max = limit_by_allocatable_memory(reasonable_max);
2036 
2037     if (!FLAG_IS_DEFAULT(InitialHeapSize)) {
2038       // An initial heap size was specified on the command line,
2039       // so be sure that the maximum size is consistent.  Done
2040       // after call to limit_by_allocatable_memory because that
2041       // method might reduce the allocation size.
2042       reasonable_max = MAX2(reasonable_max, (julong)InitialHeapSize);
2043     }
2044 
2045     log_trace(gc, heap)("  Maximum heap size " SIZE_FORMAT, (size_t) reasonable_max);
2046     FLAG_SET_ERGO(size_t, MaxHeapSize, (size_t)reasonable_max);
2047   }
2048 
2049   // If the minimum or initial heap_size have not been set or requested to be set
2050   // ergonomically, set them accordingly.
2051   if (InitialHeapSize == 0 || min_heap_size() == 0) {
2052     julong reasonable_minimum = (julong)(OldSize + NewSize);
2053 
2054     reasonable_minimum = MIN2(reasonable_minimum, (julong)MaxHeapSize);
2055 
2056     reasonable_minimum = limit_by_allocatable_memory(reasonable_minimum);
2057 
2058     if (InitialHeapSize == 0) {
2059       julong reasonable_initial = phys_mem / InitialRAMFraction;
2060 
2061       reasonable_initial = MAX3(reasonable_initial, reasonable_minimum, (julong)min_heap_size());
2062       reasonable_initial = MIN2(reasonable_initial, (julong)MaxHeapSize);
2063 
2064       reasonable_initial = limit_by_allocatable_memory(reasonable_initial);
2065 
2066       log_trace(gc, heap)("  Initial heap size " SIZE_FORMAT, (size_t)reasonable_initial);
2067       FLAG_SET_ERGO(size_t, InitialHeapSize, (size_t)reasonable_initial);
2068     }
2069     // If the minimum heap size has not been set (via -Xms),
2070     // synchronize with InitialHeapSize to avoid errors with the default value.
2071     if (min_heap_size() == 0) {
2072       set_min_heap_size(MIN2((size_t)reasonable_minimum, InitialHeapSize));
2073       log_trace(gc, heap)("  Minimum heap size " SIZE_FORMAT, min_heap_size());
2074     }
2075   }
2076 }
2077 
2078 // This option inspects the machine and attempts to set various
2079 // parameters to be optimal for long-running, memory allocation
2080 // intensive jobs.  It is intended for machines with large
2081 // amounts of cpu and memory.
2082 jint Arguments::set_aggressive_heap_flags() {
2083   // initHeapSize is needed since _initial_heap_size is 4 bytes on a 32 bit
2084   // VM, but we may not be able to represent the total physical memory
2085   // available (like having 8gb of memory on a box but using a 32bit VM).
2086   // Thus, we need to make sure we're using a julong for intermediate
2087   // calculations.
2088   julong initHeapSize;
2089   julong total_memory = os::physical_memory();
2090 
2091   if (total_memory &lt; (julong) 256 * M) {
2092     jio_fprintf(defaultStream::error_stream(),
2093             "You need at least 256mb of memory to use -XX:+AggressiveHeap\n");
2094     vm_exit(1);
2095   }
2096 
2097   // The heap size is half of available memory, or (at most)
2098   // all of possible memory less 160mb (leaving room for the OS
2099   // when using ISM).  This is the maximum; because adaptive sizing
2100   // is turned on below, the actual space used may be smaller.
2101 
2102   initHeapSize = MIN2(total_memory / (julong) 2,
2103           total_memory - (julong) 160 * M);
2104 
2105   initHeapSize = limit_by_allocatable_memory(initHeapSize);
2106 
2107   if (FLAG_IS_DEFAULT(MaxHeapSize)) {
2108     if (FLAG_SET_CMDLINE(size_t, MaxHeapSize, initHeapSize) != Flag::SUCCESS) {
2109       return JNI_EINVAL;
2110     }
2111     if (FLAG_SET_CMDLINE(size_t, InitialHeapSize, initHeapSize) != Flag::SUCCESS) {
2112       return JNI_EINVAL;
2113     }
2114     // Currently the minimum size and the initial heap sizes are the same.
2115     set_min_heap_size(initHeapSize);
2116   }
2117   if (FLAG_IS_DEFAULT(NewSize)) {
2118     // Make the young generation 3/8ths of the total heap.
2119     if (FLAG_SET_CMDLINE(size_t, NewSize,
2120             ((julong) MaxHeapSize / (julong) 8) * (julong) 3) != Flag::SUCCESS) {
2121       return JNI_EINVAL;
2122     }
2123     if (FLAG_SET_CMDLINE(size_t, MaxNewSize, NewSize) != Flag::SUCCESS) {
2124       return JNI_EINVAL;
2125     }
2126   }
2127 
2128 #if !defined(_ALLBSD_SOURCE) &amp;&amp; !defined(AIX)  // UseLargePages is not yet supported on BSD and AIX.
2129   FLAG_SET_DEFAULT(UseLargePages, true);
2130 #endif
2131 
2132   // Increase some data structure sizes for efficiency
2133   if (FLAG_SET_CMDLINE(size_t, BaseFootPrintEstimate, MaxHeapSize) != Flag::SUCCESS) {
2134     return JNI_EINVAL;
2135   }
2136   if (FLAG_SET_CMDLINE(bool, ResizeTLAB, false) != Flag::SUCCESS) {
2137     return JNI_EINVAL;
2138   }
2139   if (FLAG_SET_CMDLINE(size_t, TLABSize, 256 * K) != Flag::SUCCESS) {
2140     return JNI_EINVAL;
2141   }
2142 
2143   // See the OldPLABSize comment below, but replace 'after promotion'
2144   // with 'after copying'.  YoungPLABSize is the size of the survivor
2145   // space per-gc-thread buffers.  The default is 4kw.
2146   if (FLAG_SET_CMDLINE(size_t, YoungPLABSize, 256 * K) != Flag::SUCCESS) { // Note: this is in words
2147     return JNI_EINVAL;
2148   }
2149 
2150   // OldPLABSize is the size of the buffers in the old gen that
2151   // UseParallelGC uses to promote live data that doesn't fit in the
2152   // survivor spaces.  At any given time, there's one for each gc thread.
2153   // The default size is 1kw. These buffers are rarely used, since the
2154   // survivor spaces are usually big enough.  For specjbb, however, there
2155   // are occasions when there's lots of live data in the young gen
2156   // and we end up promoting some of it.  We don't have a definite
2157   // explanation for why bumping OldPLABSize helps, but the theory
2158   // is that a bigger PLAB results in retaining something like the
2159   // original allocation order after promotion, which improves mutator
2160   // locality.  A minor effect may be that larger PLABs reduce the
2161   // number of PLAB allocation events during gc.  The value of 8kw
2162   // was arrived at by experimenting with specjbb.
2163   if (FLAG_SET_CMDLINE(size_t, OldPLABSize, 8 * K) != Flag::SUCCESS) { // Note: this is in words
2164     return JNI_EINVAL;
2165   }
2166 
2167   // Enable parallel GC and adaptive generation sizing
2168   if (FLAG_SET_CMDLINE(bool, UseParallelGC, true) != Flag::SUCCESS) {
2169     return JNI_EINVAL;
2170   }
2171   FLAG_SET_DEFAULT(ParallelGCThreads,
2172           Abstract_VM_Version::parallel_worker_threads());
2173 
2174   // Encourage steady state memory management
2175   if (FLAG_SET_CMDLINE(uintx, ThresholdTolerance, 100) != Flag::SUCCESS) {
2176     return JNI_EINVAL;
2177   }
2178 
2179   // This appears to improve mutator locality
2180   if (FLAG_SET_CMDLINE(bool, ScavengeBeforeFullGC, false) != Flag::SUCCESS) {
2181     return JNI_EINVAL;
2182   }
2183 
2184   // Get around early Solaris scheduling bug
2185   // (affinity vs other jobs on system)
2186   // but disallow DR and offlining (5008695).
2187   if (FLAG_SET_CMDLINE(bool, BindGCTaskThreadsToCPUs, true) != Flag::SUCCESS) {
2188     return JNI_EINVAL;
2189   }
2190 
2191   return JNI_OK;
2192 }
2193 
2194 // This must be called after ergonomics.
2195 void Arguments::set_bytecode_flags() {
2196   if (!RewriteBytecodes) {
2197     FLAG_SET_DEFAULT(RewriteFrequentPairs, false);
2198   }
2199 }
2200 
2201 // Aggressive optimization flags  -XX:+AggressiveOpts
2202 jint Arguments::set_aggressive_opts_flags() {
2203 #ifdef COMPILER2
2204   if (AggressiveUnboxing) {
2205     if (FLAG_IS_DEFAULT(EliminateAutoBox)) {
2206       FLAG_SET_DEFAULT(EliminateAutoBox, true);
2207     } else if (!EliminateAutoBox) {
2208       // warning("AggressiveUnboxing is disabled because EliminateAutoBox is disabled");
2209       AggressiveUnboxing = false;
2210     }
2211     if (FLAG_IS_DEFAULT(DoEscapeAnalysis)) {
2212       FLAG_SET_DEFAULT(DoEscapeAnalysis, true);
2213     } else if (!DoEscapeAnalysis) {
2214       // warning("AggressiveUnboxing is disabled because DoEscapeAnalysis is disabled");
2215       AggressiveUnboxing = false;
2216     }
2217   }
2218   if (AggressiveOpts || !FLAG_IS_DEFAULT(AutoBoxCacheMax)) {
2219     if (FLAG_IS_DEFAULT(EliminateAutoBox)) {
2220       FLAG_SET_DEFAULT(EliminateAutoBox, true);
2221     }
2222     if (FLAG_IS_DEFAULT(AutoBoxCacheMax)) {
2223       FLAG_SET_DEFAULT(AutoBoxCacheMax, 20000);
2224     }
2225 
2226     // Feed the cache size setting into the JDK
2227     char buffer[1024];
2228     sprintf(buffer, "java.lang.Integer.IntegerCache.high=" INTX_FORMAT, AutoBoxCacheMax);
2229     if (!add_property(buffer)) {
2230       return JNI_ENOMEM;
2231     }
2232   }
2233   if (AggressiveOpts &amp;&amp; FLAG_IS_DEFAULT(BiasedLockingStartupDelay)) {
2234     FLAG_SET_DEFAULT(BiasedLockingStartupDelay, 500);
2235   }
2236 #endif
2237 
2238   if (AggressiveOpts) {
2239 // Sample flag setting code
2240 //    if (FLAG_IS_DEFAULT(EliminateZeroing)) {
2241 //      FLAG_SET_DEFAULT(EliminateZeroing, true);
2242 //    }
2243   }
2244 
2245   return JNI_OK;
2246 }
2247 
2248 //===========================================================================================================
2249 // Parsing of java.compiler property
2250 
2251 void Arguments::process_java_compiler_argument(const char* arg) {
2252   // For backwards compatibility, Djava.compiler=NONE or ""
2253   // causes us to switch to -Xint mode UNLESS -Xdebug
2254   // is also specified.
2255   if (strlen(arg) == 0 || strcasecmp(arg, "NONE") == 0) {
2256     set_java_compiler(true);    // "-Djava.compiler[=...]" most recently seen.
2257   }
2258 }
2259 
2260 void Arguments::process_java_launcher_argument(const char* launcher, void* extra_info) {
2261   _sun_java_launcher = os::strdup_check_oom(launcher);
2262 }
2263 
2264 bool Arguments::created_by_java_launcher() {
2265   assert(_sun_java_launcher != NULL, "property must have value");
2266   return strcmp(DEFAULT_JAVA_LAUNCHER, _sun_java_launcher) != 0;
2267 }
2268 
2269 bool Arguments::sun_java_launcher_is_altjvm() {
2270   return _sun_java_launcher_is_altjvm;
2271 }
2272 
2273 //===========================================================================================================
2274 // Parsing of main arguments
2275 
2276 #if INCLUDE_JVMCI
2277 // Check consistency of jvmci vm argument settings.
2278 bool Arguments::check_jvmci_args_consistency() {
<a name="1" id="anc1"></a><span class="changed">2279    return JVMCIGlobals::check_jvmci_flags_are_consistent();</span>




2280 }
2281 #endif //INCLUDE_JVMCI
2282 
2283 // Check consistency of GC selection
2284 bool Arguments::check_gc_consistency() {
2285   // Ensure that the user has not selected conflicting sets
2286   // of collectors.
2287   uint i = 0;
2288   if (UseSerialGC)                       i++;
2289   if (UseConcMarkSweepGC)                i++;
2290   if (UseParallelGC || UseParallelOldGC) i++;
2291   if (UseG1GC)                           i++;
2292   if (i &gt; 1) {
2293     jio_fprintf(defaultStream::error_stream(),
2294                 "Conflicting collector combinations in option list; "
2295                 "please refer to the release notes for the combinations "
2296                 "allowed\n");
2297     return false;
2298   }
2299 
2300   if (UseConcMarkSweepGC &amp;&amp; !UseParNewGC) {
2301     jio_fprintf(defaultStream::error_stream(),
2302         "It is not possible to combine the DefNew young collector with the CMS collector.\n");
2303     return false;
2304   }
2305 
2306   if (UseParNewGC &amp;&amp; !UseConcMarkSweepGC) {
2307     jio_fprintf(defaultStream::error_stream(),
2308         "It is not possible to combine the ParNew young collector with any collector other than CMS.\n");
2309     return false;
2310   }
2311 
2312   return true;
2313 }
2314 
2315 // Check the consistency of vm_init_args
2316 bool Arguments::check_vm_args_consistency() {
2317   // Method for adding checks for flag consistency.
2318   // The intent is to warn the user of all possible conflicts,
2319   // before returning an error.
2320   // Note: Needs platform-dependent factoring.
2321   bool status = true;
2322 
2323   if (TLABRefillWasteFraction == 0) {
2324     jio_fprintf(defaultStream::error_stream(),
2325                 "TLABRefillWasteFraction should be a denominator, "
2326                 "not " SIZE_FORMAT "\n",
2327                 TLABRefillWasteFraction);
2328     status = false;
2329   }
2330 
2331   if (FullGCALot &amp;&amp; FLAG_IS_DEFAULT(MarkSweepAlwaysCompactCount)) {
2332     MarkSweepAlwaysCompactCount = 1;  // Move objects every gc.
2333   }
2334 
2335   if (!(UseParallelGC || UseParallelOldGC) &amp;&amp; FLAG_IS_DEFAULT(ScavengeBeforeFullGC)) {
2336     FLAG_SET_DEFAULT(ScavengeBeforeFullGC, false);
2337   }
2338 
2339   if (GCTimeLimit == 100) {
2340     // Turn off gc-overhead-limit-exceeded checks
2341     FLAG_SET_DEFAULT(UseGCOverheadLimit, false);
2342   }
2343 
2344   status = status &amp;&amp; check_gc_consistency();
2345 
2346   // CMS space iteration, which FLSVerifyAllHeapreferences entails,
2347   // insists that we hold the requisite locks so that the iteration is
2348   // MT-safe. For the verification at start-up and shut-down, we don't
2349   // yet have a good way of acquiring and releasing these locks,
2350   // which are not visible at the CollectedHeap level. We want to
2351   // be able to acquire these locks and then do the iteration rather
2352   // than just disable the lock verification. This will be fixed under
2353   // bug 4788986.
2354   if (UseConcMarkSweepGC &amp;&amp; FLSVerifyAllHeapReferences) {
2355     if (VerifyDuringStartup) {
2356       warning("Heap verification at start-up disabled "
2357               "(due to current incompatibility with FLSVerifyAllHeapReferences)");
2358       VerifyDuringStartup = false; // Disable verification at start-up
2359     }
2360 
2361     if (VerifyBeforeExit) {
2362       warning("Heap verification at shutdown disabled "
2363               "(due to current incompatibility with FLSVerifyAllHeapReferences)");
2364       VerifyBeforeExit = false; // Disable verification at shutdown
2365     }
2366   }
2367 
2368   if (PrintNMTStatistics) {
2369 #if INCLUDE_NMT
2370     if (MemTracker::tracking_level() == NMT_off) {
2371 #endif // INCLUDE_NMT
2372       warning("PrintNMTStatistics is disabled, because native memory tracking is not enabled");
2373       PrintNMTStatistics = false;
2374 #if INCLUDE_NMT
2375     }
2376 #endif
2377   }
2378 #if INCLUDE_JVMCI
2379 
2380   status = status &amp;&amp; check_jvmci_args_consistency();
2381 
2382   if (EnableJVMCI) {
2383     if (!ScavengeRootsInCode) {
2384       warning("forcing ScavengeRootsInCode non-zero because JVMCI is enabled");
2385       ScavengeRootsInCode = 1;
2386     }
2387     if (FLAG_IS_DEFAULT(TypeProfileLevel)) {
2388       TypeProfileLevel = 0;
2389     }
2390     if (UseJVMCICompiler) {
2391       if (FLAG_IS_DEFAULT(TypeProfileWidth)) {
2392         TypeProfileWidth = 8;
2393       }
2394     }
2395   }
2396 #endif
2397 
2398   // Check lower bounds of the code cache
2399   // Template Interpreter code is approximately 3X larger in debug builds.
2400   uint min_code_cache_size = CodeCacheMinimumUseSpace DEBUG_ONLY(* 3);
2401   if (InitialCodeCacheSize &lt; (uintx)os::vm_page_size()) {
2402     jio_fprintf(defaultStream::error_stream(),
2403                 "Invalid InitialCodeCacheSize=%dK. Must be at least %dK.\n", InitialCodeCacheSize/K,
2404                 os::vm_page_size()/K);
2405     status = false;
2406   } else if (ReservedCodeCacheSize &lt; InitialCodeCacheSize) {
2407     jio_fprintf(defaultStream::error_stream(),
2408                 "Invalid ReservedCodeCacheSize: %dK. Must be at least InitialCodeCacheSize=%dK.\n",
2409                 ReservedCodeCacheSize/K, InitialCodeCacheSize/K);
2410     status = false;
2411   } else if (ReservedCodeCacheSize &lt; min_code_cache_size) {
2412     jio_fprintf(defaultStream::error_stream(),
2413                 "Invalid ReservedCodeCacheSize=%dK. Must be at least %uK.\n", ReservedCodeCacheSize/K,
2414                 min_code_cache_size/K);
2415     status = false;
2416   } else if (ReservedCodeCacheSize &gt; CODE_CACHE_SIZE_LIMIT) {
2417     // Code cache size larger than CODE_CACHE_SIZE_LIMIT is not supported.
2418     jio_fprintf(defaultStream::error_stream(),
2419                 "Invalid ReservedCodeCacheSize=%dM. Must be at most %uM.\n", ReservedCodeCacheSize/M,
2420                 CODE_CACHE_SIZE_LIMIT/M);
2421     status = false;
2422   } else if (NonNMethodCodeHeapSize &lt; min_code_cache_size) {
2423     jio_fprintf(defaultStream::error_stream(),
2424                 "Invalid NonNMethodCodeHeapSize=%dK. Must be at least %uK.\n", NonNMethodCodeHeapSize/K,
2425                 min_code_cache_size/K);
2426     status = false;
2427   }
2428 
2429 #ifdef _LP64
2430   if (!FLAG_IS_DEFAULT(CICompilerCount) &amp;&amp; !FLAG_IS_DEFAULT(CICompilerCountPerCPU) &amp;&amp; CICompilerCountPerCPU) {
2431     warning("The VM option CICompilerCountPerCPU overrides CICompilerCount.");
2432   }
2433 #endif
2434 
2435 #ifndef SUPPORT_RESERVED_STACK_AREA
2436   if (StackReservedPages != 0) {
2437     FLAG_SET_CMDLINE(intx, StackReservedPages, 0);
2438     warning("Reserved Stack Area not supported on this platform");
2439   }
2440 #endif
2441 
2442   if (BackgroundCompilation &amp;&amp; (CompileTheWorld || ReplayCompiles)) {
2443     if (!FLAG_IS_DEFAULT(BackgroundCompilation)) {
2444       warning("BackgroundCompilation disabled due to CompileTheWorld or ReplayCompiles options.");
2445     }
2446     FLAG_SET_CMDLINE(bool, BackgroundCompilation, false);
2447   }
2448   if (UseCompiler &amp;&amp; is_interpreter_only()) {
2449     if (!FLAG_IS_DEFAULT(UseCompiler)) {
2450       warning("UseCompiler disabled due to -Xint.");
2451     }
2452     FLAG_SET_CMDLINE(bool, UseCompiler, false);
2453   }
2454 #ifdef COMPILER2
2455   if (PostLoopMultiversioning &amp;&amp; !RangeCheckElimination) {
2456     if (!FLAG_IS_DEFAULT(PostLoopMultiversioning)) {
2457       warning("PostLoopMultiversioning disabled because RangeCheckElimination is disabled.");
2458     }
2459     FLAG_SET_CMDLINE(bool, PostLoopMultiversioning, false);
2460   }
2461 #endif
2462   return status;
2463 }
2464 
2465 bool Arguments::is_bad_option(const JavaVMOption* option, jboolean ignore,
2466   const char* option_type) {
2467   if (ignore) return false;
2468 
2469   const char* spacer = " ";
2470   if (option_type == NULL) {
2471     option_type = ++spacer; // Set both to the empty string.
2472   }
2473 
2474   if (os::obsolete_option(option)) {
2475     jio_fprintf(defaultStream::error_stream(),
2476                 "Obsolete %s%soption: %s\n", option_type, spacer,
2477       option-&gt;optionString);
2478     return false;
2479   } else {
2480     jio_fprintf(defaultStream::error_stream(),
2481                 "Unrecognized %s%soption: %s\n", option_type, spacer,
2482       option-&gt;optionString);
2483     return true;
2484   }
2485 }
2486 
2487 static const char* user_assertion_options[] = {
2488   "-da", "-ea", "-disableassertions", "-enableassertions", 0
2489 };
2490 
2491 static const char* system_assertion_options[] = {
2492   "-dsa", "-esa", "-disablesystemassertions", "-enablesystemassertions", 0
2493 };
2494 
2495 bool Arguments::parse_uintx(const char* value,
2496                             uintx* uintx_arg,
2497                             uintx min_size) {
2498 
2499   // Check the sign first since atojulong() parses only unsigned values.
2500   bool value_is_positive = !(*value == '-');
2501 
2502   if (value_is_positive) {
2503     julong n;
2504     bool good_return = atojulong(value, &amp;n);
2505     if (good_return) {
2506       bool above_minimum = n &gt;= min_size;
2507       bool value_is_too_large = n &gt; max_uintx;
2508 
2509       if (above_minimum &amp;&amp; !value_is_too_large) {
2510         *uintx_arg = n;
2511         return true;
2512       }
2513     }
2514   }
2515   return false;
2516 }
2517 
2518 Arguments::ArgsRange Arguments::parse_memory_size(const char* s,
2519                                                   julong* long_arg,
2520                                                   julong min_size) {
2521   if (!atojulong(s, long_arg)) return arg_unreadable;
2522   return check_memory_size(*long_arg, min_size);
2523 }
2524 
2525 // Parse JavaVMInitArgs structure
2526 
2527 jint Arguments::parse_vm_init_args(const JavaVMInitArgs *java_tool_options_args,
2528                                    const JavaVMInitArgs *java_options_args,
2529                                    const JavaVMInitArgs *cmd_line_args) {
2530   bool xpatch_javabase = false;
2531 
2532   // Save default settings for some mode flags
2533   Arguments::_AlwaysCompileLoopMethods = AlwaysCompileLoopMethods;
2534   Arguments::_UseOnStackReplacement    = UseOnStackReplacement;
2535   Arguments::_ClipInlining             = ClipInlining;
2536   Arguments::_BackgroundCompilation    = BackgroundCompilation;
2537   if (TieredCompilation) {
2538     Arguments::_Tier3InvokeNotifyFreqLog = Tier3InvokeNotifyFreqLog;
2539     Arguments::_Tier4InvocationThreshold = Tier4InvocationThreshold;
2540   }
2541 
2542   // Setup flags for mixed which is the default
2543   set_mode_flags(_mixed);
2544 
2545   // Parse args structure generated from JAVA_TOOL_OPTIONS environment
2546   // variable (if present).
2547   jint result = parse_each_vm_init_arg(java_tool_options_args, &amp;xpatch_javabase, Flag::ENVIRON_VAR);
2548   if (result != JNI_OK) {
2549     return result;
2550   }
2551 
2552   // Parse args structure generated from the command line flags.
2553   result = parse_each_vm_init_arg(cmd_line_args, &amp;xpatch_javabase, Flag::COMMAND_LINE);
2554   if (result != JNI_OK) {
2555     return result;
2556   }
2557 
2558   // Parse args structure generated from the _JAVA_OPTIONS environment
2559   // variable (if present) (mimics classic VM)
2560   result = parse_each_vm_init_arg(java_options_args, &amp;xpatch_javabase, Flag::ENVIRON_VAR);
2561   if (result != JNI_OK) {
2562     return result;
2563   }
2564 
2565   // Do final processing now that all arguments have been parsed
2566   result = finalize_vm_init_args();
2567   if (result != JNI_OK) {
2568     return result;
2569   }
2570 
2571   return JNI_OK;
2572 }
2573 
2574 // Checks if name in command-line argument -agent{lib,path}:name[=options]
2575 // represents a valid JDWP agent.  is_path==true denotes that we
2576 // are dealing with -agentpath (case where name is a path), otherwise with
2577 // -agentlib
2578 bool valid_jdwp_agent(char *name, bool is_path) {
2579   char *_name;
2580   const char *_jdwp = "jdwp";
2581   size_t _len_jdwp, _len_prefix;
2582 
2583   if (is_path) {
2584     if ((_name = strrchr(name, (int) *os::file_separator())) == NULL) {
2585       return false;
2586     }
2587 
2588     _name++;  // skip past last path separator
2589     _len_prefix = strlen(JNI_LIB_PREFIX);
2590 
2591     if (strncmp(_name, JNI_LIB_PREFIX, _len_prefix) != 0) {
2592       return false;
2593     }
2594 
2595     _name += _len_prefix;
2596     _len_jdwp = strlen(_jdwp);
2597 
2598     if (strncmp(_name, _jdwp, _len_jdwp) == 0) {
2599       _name += _len_jdwp;
2600     }
2601     else {
2602       return false;
2603     }
2604 
2605     if (strcmp(_name, JNI_LIB_SUFFIX) != 0) {
2606       return false;
2607     }
2608 
2609     return true;
2610   }
2611 
2612   if (strcmp(name, _jdwp) == 0) {
2613     return true;
2614   }
2615 
2616   return false;
2617 }
2618 
2619 jint Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* xpatch_javabase, Flag::Flags origin) {
2620   // For match_option to return remaining or value part of option string
2621   const char* tail;
2622 
2623   // iterate over arguments
2624   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
2625     bool is_absolute_path = false;  // for -agentpath vs -agentlib
2626 
2627     const JavaVMOption* option = args-&gt;options + index;
2628 
2629     if (!match_option(option, "-Djava.class.path", &amp;tail) &amp;&amp;
2630         !match_option(option, "-Dsun.java.command", &amp;tail) &amp;&amp;
2631         !match_option(option, "-Dsun.java.launcher", &amp;tail)) {
2632 
2633         // add all jvm options to the jvm_args string. This string
2634         // is used later to set the java.vm.args PerfData string constant.
2635         // the -Djava.class.path and the -Dsun.java.command options are
2636         // omitted from jvm_args string as each have their own PerfData
2637         // string constant object.
2638         build_jvm_args(option-&gt;optionString);
2639     }
2640 
2641     // -verbose:[class/gc/jni]
2642     if (match_option(option, "-verbose", &amp;tail)) {
2643       if (!strcmp(tail, ":class") || !strcmp(tail, "")) {
2644         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, load));
2645         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, unload));
2646       } else if (!strcmp(tail, ":gc")) {
2647         LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(gc));
2648       } else if (!strcmp(tail, ":jni")) {
2649         if (FLAG_SET_CMDLINE(bool, PrintJNIResolving, true) != Flag::SUCCESS) {
2650           return JNI_EINVAL;
2651         }
2652       }
2653     // -da / -ea / -disableassertions / -enableassertions
2654     // These accept an optional class/package name separated by a colon, e.g.,
2655     // -da:java.lang.Thread.
2656     } else if (match_option(option, user_assertion_options, &amp;tail, true)) {
2657       bool enable = option-&gt;optionString[1] == 'e';     // char after '-' is 'e'
2658       if (*tail == '\0') {
2659         JavaAssertions::setUserClassDefault(enable);
2660       } else {
2661         assert(*tail == ':', "bogus match by match_option()");
2662         JavaAssertions::addOption(tail + 1, enable);
2663       }
2664     // -dsa / -esa / -disablesystemassertions / -enablesystemassertions
2665     } else if (match_option(option, system_assertion_options, &amp;tail, false)) {
2666       bool enable = option-&gt;optionString[1] == 'e';     // char after '-' is 'e'
2667       JavaAssertions::setSystemClassDefault(enable);
2668     // -bootclasspath:
2669     } else if (match_option(option, "-Xbootclasspath:", &amp;tail)) {
2670         jio_fprintf(defaultStream::output_stream(),
2671           "-Xbootclasspath is no longer a supported option.\n");
2672         return JNI_EINVAL;
2673     // -bootclasspath/a:
2674     } else if (match_option(option, "-Xbootclasspath/a:", &amp;tail)) {
2675       Arguments::set_bootclassloader_append_index((int)strlen(Arguments::get_sysclasspath())+1);
2676       Arguments::append_sysclasspath(tail);
2677     // -bootclasspath/p:
2678     } else if (match_option(option, "-Xbootclasspath/p:", &amp;tail)) {
2679         jio_fprintf(defaultStream::output_stream(),
2680           "-Xbootclasspath/p is no longer a supported option.\n");
2681         return JNI_EINVAL;
2682     // -Xrun
2683     } else if (match_option(option, "-Xrun", &amp;tail)) {
2684       if (tail != NULL) {
2685         const char* pos = strchr(tail, ':');
2686         size_t len = (pos == NULL) ? strlen(tail) : pos - tail;
2687         char* name = (char*)memcpy(NEW_C_HEAP_ARRAY(char, len + 1, mtArguments), tail, len);
2688         name[len] = '\0';
2689 
2690         char *options = NULL;
2691         if(pos != NULL) {
2692           size_t len2 = strlen(pos+1) + 1; // options start after ':'.  Final zero must be copied.
2693           options = (char*)memcpy(NEW_C_HEAP_ARRAY(char, len2, mtArguments), pos+1, len2);
2694         }
2695 #if !INCLUDE_JVMTI
2696         if (strcmp(name, "jdwp") == 0) {
2697           jio_fprintf(defaultStream::error_stream(),
2698             "Debugging agents are not supported in this VM\n");
2699           return JNI_ERR;
2700         }
2701 #endif // !INCLUDE_JVMTI
2702         add_init_library(name, options);
2703       }
2704     // -agentlib and -agentpath
2705     } else if (match_option(option, "-agentlib:", &amp;tail) ||
2706           (is_absolute_path = match_option(option, "-agentpath:", &amp;tail))) {
2707       if(tail != NULL) {
2708         const char* pos = strchr(tail, '=');
2709         size_t len = (pos == NULL) ? strlen(tail) : pos - tail;
2710         char* name = strncpy(NEW_C_HEAP_ARRAY(char, len + 1, mtArguments), tail, len);
2711         name[len] = '\0';
2712 
2713         char *options = NULL;
2714         if(pos != NULL) {
2715           options = os::strdup_check_oom(pos + 1, mtArguments);
2716         }
2717 #if !INCLUDE_JVMTI
2718         if (valid_jdwp_agent(name, is_absolute_path)) {
2719           jio_fprintf(defaultStream::error_stream(),
2720             "Debugging agents are not supported in this VM\n");
2721           return JNI_ERR;
2722         }
2723 #endif // !INCLUDE_JVMTI
2724         add_init_agent(name, options, is_absolute_path);
2725       }
2726     // -javaagent
2727     } else if (match_option(option, "-javaagent:", &amp;tail)) {
2728 #if !INCLUDE_JVMTI
2729       jio_fprintf(defaultStream::error_stream(),
2730         "Instrumentation agents are not supported in this VM\n");
2731       return JNI_ERR;
2732 #else
2733       if (tail != NULL) {
2734         char *options = strcpy(NEW_C_HEAP_ARRAY(char, strlen(tail) + 1, mtArguments), tail);
2735         add_init_agent("instrument", options, false);
2736         // java agents need module java.instrument
2737         if (!Arguments::append_to_addmods_property("java.instrument")) {
2738           return JNI_ENOMEM;
2739         }
2740       }
2741 #endif // !INCLUDE_JVMTI
2742     // -Xnoclassgc
2743     } else if (match_option(option, "-Xnoclassgc")) {
2744       if (FLAG_SET_CMDLINE(bool, ClassUnloading, false) != Flag::SUCCESS) {
2745         return JNI_EINVAL;
2746       }
2747     // -Xconcgc
2748     } else if (match_option(option, "-Xconcgc")) {
2749       if (FLAG_SET_CMDLINE(bool, UseConcMarkSweepGC, true) != Flag::SUCCESS) {
2750         return JNI_EINVAL;
2751       }
2752     // -Xnoconcgc
2753     } else if (match_option(option, "-Xnoconcgc")) {
2754       if (FLAG_SET_CMDLINE(bool, UseConcMarkSweepGC, false) != Flag::SUCCESS) {
2755         return JNI_EINVAL;
2756       }
2757     // -Xbatch
2758     } else if (match_option(option, "-Xbatch")) {
2759       if (FLAG_SET_CMDLINE(bool, BackgroundCompilation, false) != Flag::SUCCESS) {
2760         return JNI_EINVAL;
2761       }
2762     // -Xmn for compatibility with other JVM vendors
2763     } else if (match_option(option, "-Xmn", &amp;tail)) {
2764       julong long_initial_young_size = 0;
2765       ArgsRange errcode = parse_memory_size(tail, &amp;long_initial_young_size, 1);
2766       if (errcode != arg_in_range) {
2767         jio_fprintf(defaultStream::error_stream(),
2768                     "Invalid initial young generation size: %s\n", option-&gt;optionString);
2769         describe_range_error(errcode);
2770         return JNI_EINVAL;
2771       }
2772       if (FLAG_SET_CMDLINE(size_t, MaxNewSize, (size_t)long_initial_young_size) != Flag::SUCCESS) {
2773         return JNI_EINVAL;
2774       }
2775       if (FLAG_SET_CMDLINE(size_t, NewSize, (size_t)long_initial_young_size) != Flag::SUCCESS) {
2776         return JNI_EINVAL;
2777       }
2778     // -Xms
2779     } else if (match_option(option, "-Xms", &amp;tail)) {
2780       julong long_initial_heap_size = 0;
2781       // an initial heap size of 0 means automatically determine
2782       ArgsRange errcode = parse_memory_size(tail, &amp;long_initial_heap_size, 0);
2783       if (errcode != arg_in_range) {
2784         jio_fprintf(defaultStream::error_stream(),
2785                     "Invalid initial heap size: %s\n", option-&gt;optionString);
2786         describe_range_error(errcode);
2787         return JNI_EINVAL;
2788       }
2789       set_min_heap_size((size_t)long_initial_heap_size);
2790       // Currently the minimum size and the initial heap sizes are the same.
2791       // Can be overridden with -XX:InitialHeapSize.
2792       if (FLAG_SET_CMDLINE(size_t, InitialHeapSize, (size_t)long_initial_heap_size) != Flag::SUCCESS) {
2793         return JNI_EINVAL;
2794       }
2795     // -Xmx
2796     } else if (match_option(option, "-Xmx", &amp;tail) || match_option(option, "-XX:MaxHeapSize=", &amp;tail)) {
2797       julong long_max_heap_size = 0;
2798       ArgsRange errcode = parse_memory_size(tail, &amp;long_max_heap_size, 1);
2799       if (errcode != arg_in_range) {
2800         jio_fprintf(defaultStream::error_stream(),
2801                     "Invalid maximum heap size: %s\n", option-&gt;optionString);
2802         describe_range_error(errcode);
2803         return JNI_EINVAL;
2804       }
2805       if (FLAG_SET_CMDLINE(size_t, MaxHeapSize, (size_t)long_max_heap_size) != Flag::SUCCESS) {
2806         return JNI_EINVAL;
2807       }
2808     // Xmaxf
2809     } else if (match_option(option, "-Xmaxf", &amp;tail)) {
2810       char* err;
2811       int maxf = (int)(strtod(tail, &amp;err) * 100);
2812       if (*err != '\0' || *tail == '\0') {
2813         jio_fprintf(defaultStream::error_stream(),
2814                     "Bad max heap free percentage size: %s\n",
2815                     option-&gt;optionString);
2816         return JNI_EINVAL;
2817       } else {
2818         if (FLAG_SET_CMDLINE(uintx, MaxHeapFreeRatio, maxf) != Flag::SUCCESS) {
2819             return JNI_EINVAL;
2820         }
2821       }
2822     // Xminf
2823     } else if (match_option(option, "-Xminf", &amp;tail)) {
2824       char* err;
2825       int minf = (int)(strtod(tail, &amp;err) * 100);
2826       if (*err != '\0' || *tail == '\0') {
2827         jio_fprintf(defaultStream::error_stream(),
2828                     "Bad min heap free percentage size: %s\n",
2829                     option-&gt;optionString);
2830         return JNI_EINVAL;
2831       } else {
2832         if (FLAG_SET_CMDLINE(uintx, MinHeapFreeRatio, minf) != Flag::SUCCESS) {
2833           return JNI_EINVAL;
2834         }
2835       }
2836     // -Xss
2837     } else if (match_option(option, "-Xss", &amp;tail)) {
2838       julong long_ThreadStackSize = 0;
2839       ArgsRange errcode = parse_memory_size(tail, &amp;long_ThreadStackSize, 1000);
2840       if (errcode != arg_in_range) {
2841         jio_fprintf(defaultStream::error_stream(),
2842                     "Invalid thread stack size: %s\n", option-&gt;optionString);
2843         describe_range_error(errcode);
2844         return JNI_EINVAL;
2845       }
2846       // Internally track ThreadStackSize in units of 1024 bytes.
2847       if (FLAG_SET_CMDLINE(intx, ThreadStackSize,
2848                        round_to((int)long_ThreadStackSize, K) / K) != Flag::SUCCESS) {
2849         return JNI_EINVAL;
2850       }
2851     // -Xoss, -Xsqnopause, -Xoptimize, -Xboundthreads, -Xusealtsigs
2852     } else if (match_option(option, "-Xoss", &amp;tail) ||
2853                match_option(option, "-Xsqnopause") ||
2854                match_option(option, "-Xoptimize") ||
2855                match_option(option, "-Xboundthreads") ||
2856                match_option(option, "-Xusealtsigs")) {
2857       // All these options are deprecated in JDK 9 and will be removed in a future release
2858       char version[256];
2859       JDK_Version::jdk(9).to_string(version, sizeof(version));
2860       warning("Ignoring option %s; support was removed in %s", option-&gt;optionString, version);
2861     } else if (match_option(option, "-XX:CodeCacheExpansionSize=", &amp;tail)) {
2862       julong long_CodeCacheExpansionSize = 0;
2863       ArgsRange errcode = parse_memory_size(tail, &amp;long_CodeCacheExpansionSize, os::vm_page_size());
2864       if (errcode != arg_in_range) {
2865         jio_fprintf(defaultStream::error_stream(),
2866                    "Invalid argument: %s. Must be at least %luK.\n", option-&gt;optionString,
2867                    os::vm_page_size()/K);
2868         return JNI_EINVAL;
2869       }
2870       if (FLAG_SET_CMDLINE(uintx, CodeCacheExpansionSize, (uintx)long_CodeCacheExpansionSize) != Flag::SUCCESS) {
2871         return JNI_EINVAL;
2872       }
2873     } else if (match_option(option, "-Xmaxjitcodesize", &amp;tail) ||
2874                match_option(option, "-XX:ReservedCodeCacheSize=", &amp;tail)) {
2875       julong long_ReservedCodeCacheSize = 0;
2876 
2877       ArgsRange errcode = parse_memory_size(tail, &amp;long_ReservedCodeCacheSize, 1);
2878       if (errcode != arg_in_range) {
2879         jio_fprintf(defaultStream::error_stream(),
2880                     "Invalid maximum code cache size: %s.\n", option-&gt;optionString);
2881         return JNI_EINVAL;
2882       }
2883       if (FLAG_SET_CMDLINE(uintx, ReservedCodeCacheSize, (uintx)long_ReservedCodeCacheSize) != Flag::SUCCESS) {
2884         return JNI_EINVAL;
2885       }
2886       // -XX:NonNMethodCodeHeapSize=
2887     } else if (match_option(option, "-XX:NonNMethodCodeHeapSize=", &amp;tail)) {
2888       julong long_NonNMethodCodeHeapSize = 0;
2889 
2890       ArgsRange errcode = parse_memory_size(tail, &amp;long_NonNMethodCodeHeapSize, 1);
2891       if (errcode != arg_in_range) {
2892         jio_fprintf(defaultStream::error_stream(),
2893                     "Invalid maximum non-nmethod code heap size: %s.\n", option-&gt;optionString);
2894         return JNI_EINVAL;
2895       }
2896       if (FLAG_SET_CMDLINE(uintx, NonNMethodCodeHeapSize, (uintx)long_NonNMethodCodeHeapSize) != Flag::SUCCESS) {
2897         return JNI_EINVAL;
2898       }
2899       // -XX:ProfiledCodeHeapSize=
2900     } else if (match_option(option, "-XX:ProfiledCodeHeapSize=", &amp;tail)) {
2901       julong long_ProfiledCodeHeapSize = 0;
2902 
2903       ArgsRange errcode = parse_memory_size(tail, &amp;long_ProfiledCodeHeapSize, 1);
2904       if (errcode != arg_in_range) {
2905         jio_fprintf(defaultStream::error_stream(),
2906                     "Invalid maximum profiled code heap size: %s.\n", option-&gt;optionString);
2907         return JNI_EINVAL;
2908       }
2909       if (FLAG_SET_CMDLINE(uintx, ProfiledCodeHeapSize, (uintx)long_ProfiledCodeHeapSize) != Flag::SUCCESS) {
2910         return JNI_EINVAL;
2911       }
2912       // -XX:NonProfiledCodeHeapSizee=
2913     } else if (match_option(option, "-XX:NonProfiledCodeHeapSize=", &amp;tail)) {
2914       julong long_NonProfiledCodeHeapSize = 0;
2915 
2916       ArgsRange errcode = parse_memory_size(tail, &amp;long_NonProfiledCodeHeapSize, 1);
2917       if (errcode != arg_in_range) {
2918         jio_fprintf(defaultStream::error_stream(),
2919                     "Invalid maximum non-profiled code heap size: %s.\n", option-&gt;optionString);
2920         return JNI_EINVAL;
2921       }
2922       if (FLAG_SET_CMDLINE(uintx, NonProfiledCodeHeapSize, (uintx)long_NonProfiledCodeHeapSize) != Flag::SUCCESS) {
2923         return JNI_EINVAL;
2924       }
2925     // -green
2926     } else if (match_option(option, "-green")) {
2927       jio_fprintf(defaultStream::error_stream(),
2928                   "Green threads support not available\n");
2929           return JNI_EINVAL;
2930     // -native
2931     } else if (match_option(option, "-native")) {
2932           // HotSpot always uses native threads, ignore silently for compatibility
2933     // -Xrs
2934     } else if (match_option(option, "-Xrs")) {
2935           // Classic/EVM option, new functionality
2936       if (FLAG_SET_CMDLINE(bool, ReduceSignalUsage, true) != Flag::SUCCESS) {
2937         return JNI_EINVAL;
2938       }
2939     // -Xprof
2940     } else if (match_option(option, "-Xprof")) {
2941 #if INCLUDE_FPROF
2942       _has_profile = true;
2943 #else // INCLUDE_FPROF
2944       jio_fprintf(defaultStream::error_stream(),
2945         "Flat profiling is not supported in this VM.\n");
2946       return JNI_ERR;
2947 #endif // INCLUDE_FPROF
2948     // -Xconcurrentio
2949     } else if (match_option(option, "-Xconcurrentio")) {
2950       if (FLAG_SET_CMDLINE(bool, UseLWPSynchronization, true) != Flag::SUCCESS) {
2951         return JNI_EINVAL;
2952       }
2953       if (FLAG_SET_CMDLINE(bool, BackgroundCompilation, false) != Flag::SUCCESS) {
2954         return JNI_EINVAL;
2955       }
2956       if (FLAG_SET_CMDLINE(intx, DeferThrSuspendLoopCount, 1) != Flag::SUCCESS) {
2957         return JNI_EINVAL;
2958       }
2959       if (FLAG_SET_CMDLINE(bool, UseTLAB, false) != Flag::SUCCESS) {
2960         return JNI_EINVAL;
2961       }
2962       if (FLAG_SET_CMDLINE(size_t, NewSizeThreadIncrease, 16 * K) != Flag::SUCCESS) {  // 20Kb per thread added to new generation
2963         return JNI_EINVAL;
2964       }
2965 
2966       // -Xinternalversion
2967     } else if (match_option(option, "-Xinternalversion")) {
2968       jio_fprintf(defaultStream::output_stream(), "%s\n",
2969                   VM_Version::internal_vm_info_string());
2970       vm_exit(0);
2971 #ifndef PRODUCT
2972     // -Xprintflags
2973     } else if (match_option(option, "-Xprintflags")) {
2974       CommandLineFlags::printFlags(tty, false);
2975       vm_exit(0);
2976 #endif
2977     // -D
2978     } else if (match_option(option, "-D", &amp;tail)) {
2979       const char* value;
2980       if (match_option(option, "-Djava.endorsed.dirs=", &amp;value) &amp;&amp;
2981             *value!= '\0' &amp;&amp; strcmp(value, "\"\"") != 0) {
2982         // abort if -Djava.endorsed.dirs is set
2983         jio_fprintf(defaultStream::output_stream(),
2984           "-Djava.endorsed.dirs=%s is not supported. Endorsed standards and standalone APIs\n"
2985           "in modular form will be supported via the concept of upgradeable modules.\n", value);
2986         return JNI_EINVAL;
2987       }
2988       if (match_option(option, "-Djava.ext.dirs=", &amp;value) &amp;&amp;
2989             *value != '\0' &amp;&amp; strcmp(value, "\"\"") != 0) {
2990         // abort if -Djava.ext.dirs is set
2991         jio_fprintf(defaultStream::output_stream(),
2992           "-Djava.ext.dirs=%s is not supported.  Use -classpath instead.\n", value);
2993         return JNI_EINVAL;
2994       }
2995 
2996       if (!add_property(tail)) {
2997         return JNI_ENOMEM;
2998       }
2999       // Out of the box management support
3000       if (match_option(option, "-Dcom.sun.management", &amp;tail)) {
3001 #if INCLUDE_MANAGEMENT
3002         if (FLAG_SET_CMDLINE(bool, ManagementServer, true) != Flag::SUCCESS) {
3003           return JNI_EINVAL;
3004         }
3005         // management agent in module java.management
3006         if (!Arguments::append_to_addmods_property("java.management")) {
3007           return JNI_ENOMEM;
3008         }
3009 #else
3010         jio_fprintf(defaultStream::output_stream(),
3011           "-Dcom.sun.management is not supported in this VM.\n");
3012         return JNI_ERR;
3013 #endif
3014       }
3015       if (match_option(option, "-Djdk.launcher.patch.", &amp;tail)) {
3016         // -Djdk.launcher.patch.#=&lt;module&gt;=&lt;file&gt;(&lt;pathsep&gt;&lt;file&gt;)*
3017         // The number, #, specified will be increasing with each -Xpatch
3018         // specified on the command line.
3019         // Pick up module name, following the -D property's equal sign.
3020         const char* property_equal = strchr(tail, '=');
3021         if (property_equal == NULL) {
3022           jio_fprintf(defaultStream::output_stream(), "Missing '=' in -Xpatch specification\n");
3023           return JNI_ERR;
3024         } else {
3025           // Find the equal sign between the module name and the path specification
3026           const char* module_equal = strchr(property_equal + 1, '=');
3027           if (module_equal == NULL) {
3028             jio_fprintf(defaultStream::output_stream(), "Bad value for -Xpatch, no module name specified\n");
3029             return JNI_ERR;
3030           } else {
3031             // Pick out the module name, in between the two equal signs
3032             size_t module_len = module_equal - property_equal - 1;
3033             char* module_name = NEW_C_HEAP_ARRAY(char, module_len+1, mtArguments);
3034             memcpy(module_name, property_equal + 1, module_len);
3035             *(module_name + module_len) = '\0';
3036             // The path piece begins one past the module_equal sign
3037             Arguments::add_xpatchprefix(module_name, module_equal + 1, xpatch_javabase);
3038             FREE_C_HEAP_ARRAY(char, module_name);
3039           }
3040         }
3041       }
3042     // -Xint
3043     } else if (match_option(option, "-Xint")) {
3044           set_mode_flags(_int);
3045     // -Xmixed
3046     } else if (match_option(option, "-Xmixed")) {
3047           set_mode_flags(_mixed);
3048     // -Xcomp
3049     } else if (match_option(option, "-Xcomp")) {
3050       // for testing the compiler; turn off all flags that inhibit compilation
3051           set_mode_flags(_comp);
3052     // -Xshare:dump
3053     } else if (match_option(option, "-Xshare:dump")) {
3054       if (FLAG_SET_CMDLINE(bool, DumpSharedSpaces, true) != Flag::SUCCESS) {
3055         return JNI_EINVAL;
3056       }
3057       set_mode_flags(_int);     // Prevent compilation, which creates objects
3058     // -Xshare:on
3059     } else if (match_option(option, "-Xshare:on")) {
3060       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3061         return JNI_EINVAL;
3062       }
3063       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, true) != Flag::SUCCESS) {
3064         return JNI_EINVAL;
3065       }
3066     // -Xshare:auto
3067     } else if (match_option(option, "-Xshare:auto")) {
3068       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3069         return JNI_EINVAL;
3070       }
3071       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, false) != Flag::SUCCESS) {
3072         return JNI_EINVAL;
3073       }
3074     // -Xshare:off
3075     } else if (match_option(option, "-Xshare:off")) {
3076       if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, false) != Flag::SUCCESS) {
3077         return JNI_EINVAL;
3078       }
3079       if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, false) != Flag::SUCCESS) {
3080         return JNI_EINVAL;
3081       }
3082     // -Xverify
3083     } else if (match_option(option, "-Xverify", &amp;tail)) {
3084       if (strcmp(tail, ":all") == 0 || strcmp(tail, "") == 0) {
3085         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, true) != Flag::SUCCESS) {
3086           return JNI_EINVAL;
3087         }
3088         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true) != Flag::SUCCESS) {
3089           return JNI_EINVAL;
3090         }
3091       } else if (strcmp(tail, ":remote") == 0) {
3092         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false) != Flag::SUCCESS) {
3093           return JNI_EINVAL;
3094         }
3095         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true) != Flag::SUCCESS) {
3096           return JNI_EINVAL;
3097         }
3098       } else if (strcmp(tail, ":none") == 0) {
3099         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false) != Flag::SUCCESS) {
3100           return JNI_EINVAL;
3101         }
3102         if (FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, false) != Flag::SUCCESS) {
3103           return JNI_EINVAL;
3104         }
3105       } else if (is_bad_option(option, args-&gt;ignoreUnrecognized, "verification")) {
3106         return JNI_EINVAL;
3107       }
3108     // -Xdebug
3109     } else if (match_option(option, "-Xdebug")) {
3110       // note this flag has been used, then ignore
3111       set_xdebug_mode(true);
3112     // -Xnoagent
3113     } else if (match_option(option, "-Xnoagent")) {
3114       // For compatibility with classic. HotSpot refuses to load the old style agent.dll.
3115     } else if (match_option(option, "-Xloggc:", &amp;tail)) {
3116       // Deprecated flag to redirect GC output to a file. -Xloggc:&lt;filename&gt;
3117       log_warning(gc)("-Xloggc is deprecated. Will use -Xlog:gc:%s instead.", tail);
3118       _gc_log_filename = os::strdup_check_oom(tail);
3119     } else if (match_option(option, "-Xlog", &amp;tail)) {
3120       bool ret = false;
3121       if (strcmp(tail, ":help") == 0) {
3122         LogConfiguration::print_command_line_help(defaultStream::output_stream());
3123         vm_exit(0);
3124       } else if (strcmp(tail, ":disable") == 0) {
3125         LogConfiguration::disable_logging();
3126         ret = true;
3127       } else if (*tail == '\0') {
3128         ret = LogConfiguration::parse_command_line_arguments();
3129         assert(ret, "-Xlog without arguments should never fail to parse");
3130       } else if (*tail == ':') {
3131         ret = LogConfiguration::parse_command_line_arguments(tail + 1);
3132       }
3133       if (ret == false) {
3134         jio_fprintf(defaultStream::error_stream(),
3135                     "Invalid -Xlog option '-Xlog%s'\n",
3136                     tail);
3137         return JNI_EINVAL;
3138       }
3139     // JNI hooks
3140     } else if (match_option(option, "-Xcheck", &amp;tail)) {
3141       if (!strcmp(tail, ":jni")) {
3142 #if !INCLUDE_JNI_CHECK
3143         warning("JNI CHECKING is not supported in this VM");
3144 #else
3145         CheckJNICalls = true;
3146 #endif // INCLUDE_JNI_CHECK
3147       } else if (is_bad_option(option, args-&gt;ignoreUnrecognized,
3148                                      "check")) {
3149         return JNI_EINVAL;
3150       }
3151     } else if (match_option(option, "vfprintf")) {
3152       _vfprintf_hook = CAST_TO_FN_PTR(vfprintf_hook_t, option-&gt;extraInfo);
3153     } else if (match_option(option, "exit")) {
3154       _exit_hook = CAST_TO_FN_PTR(exit_hook_t, option-&gt;extraInfo);
3155     } else if (match_option(option, "abort")) {
3156       _abort_hook = CAST_TO_FN_PTR(abort_hook_t, option-&gt;extraInfo);
3157     // -XX:+AggressiveHeap
3158     } else if (match_option(option, "-XX:+AggressiveHeap")) {
3159       jint result = set_aggressive_heap_flags();
3160       if (result != JNI_OK) {
3161           return result;
3162       }
3163     // Need to keep consistency of MaxTenuringThreshold and AlwaysTenure/NeverTenure;
3164     // and the last option wins.
3165     } else if (match_option(option, "-XX:+NeverTenure")) {
3166       if (FLAG_SET_CMDLINE(bool, NeverTenure, true) != Flag::SUCCESS) {
3167         return JNI_EINVAL;
3168       }
3169       if (FLAG_SET_CMDLINE(bool, AlwaysTenure, false) != Flag::SUCCESS) {
3170         return JNI_EINVAL;
3171       }
3172       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, markOopDesc::max_age + 1) != Flag::SUCCESS) {
3173         return JNI_EINVAL;
3174       }
3175     } else if (match_option(option, "-XX:+AlwaysTenure")) {
3176       if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3177         return JNI_EINVAL;
3178       }
3179       if (FLAG_SET_CMDLINE(bool, AlwaysTenure, true) != Flag::SUCCESS) {
3180         return JNI_EINVAL;
3181       }
3182       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, 0) != Flag::SUCCESS) {
3183         return JNI_EINVAL;
3184       }
3185     } else if (match_option(option, "-XX:MaxTenuringThreshold=", &amp;tail)) {
3186       uintx max_tenuring_thresh = 0;
3187       if (!parse_uintx(tail, &amp;max_tenuring_thresh, 0)) {
3188         jio_fprintf(defaultStream::error_stream(),
3189                     "Improperly specified VM option \'MaxTenuringThreshold=%s\'\n", tail);
3190         return JNI_EINVAL;
3191       }
3192 
3193       if (FLAG_SET_CMDLINE(uintx, MaxTenuringThreshold, max_tenuring_thresh) != Flag::SUCCESS) {
3194         return JNI_EINVAL;
3195       }
3196 
3197       if (MaxTenuringThreshold == 0) {
3198         if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3199           return JNI_EINVAL;
3200         }
3201         if (FLAG_SET_CMDLINE(bool, AlwaysTenure, true) != Flag::SUCCESS) {
3202           return JNI_EINVAL;
3203         }
3204       } else {
3205         if (FLAG_SET_CMDLINE(bool, NeverTenure, false) != Flag::SUCCESS) {
3206           return JNI_EINVAL;
3207         }
3208         if (FLAG_SET_CMDLINE(bool, AlwaysTenure, false) != Flag::SUCCESS) {
3209           return JNI_EINVAL;
3210         }
3211       }
3212     } else if (match_option(option, "-XX:+DisplayVMOutputToStderr")) {
3213       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStdout, false) != Flag::SUCCESS) {
3214         return JNI_EINVAL;
3215       }
3216       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStderr, true) != Flag::SUCCESS) {
3217         return JNI_EINVAL;
3218       }
3219     } else if (match_option(option, "-XX:+DisplayVMOutputToStdout")) {
3220       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStderr, false) != Flag::SUCCESS) {
3221         return JNI_EINVAL;
3222       }
3223       if (FLAG_SET_CMDLINE(bool, DisplayVMOutputToStdout, true) != Flag::SUCCESS) {
3224         return JNI_EINVAL;
3225       }
3226     } else if (match_option(option, "-XX:+ExtendedDTraceProbes")) {
3227 #if defined(DTRACE_ENABLED)
3228       if (FLAG_SET_CMDLINE(bool, ExtendedDTraceProbes, true) != Flag::SUCCESS) {
3229         return JNI_EINVAL;
3230       }
3231       if (FLAG_SET_CMDLINE(bool, DTraceMethodProbes, true) != Flag::SUCCESS) {
3232         return JNI_EINVAL;
3233       }
3234       if (FLAG_SET_CMDLINE(bool, DTraceAllocProbes, true) != Flag::SUCCESS) {
3235         return JNI_EINVAL;
3236       }
3237       if (FLAG_SET_CMDLINE(bool, DTraceMonitorProbes, true) != Flag::SUCCESS) {
3238         return JNI_EINVAL;
3239       }
3240 #else // defined(DTRACE_ENABLED)
3241       jio_fprintf(defaultStream::error_stream(),
3242                   "ExtendedDTraceProbes flag is not applicable for this configuration\n");
3243       return JNI_EINVAL;
3244 #endif // defined(DTRACE_ENABLED)
3245 #ifdef ASSERT
3246     } else if (match_option(option, "-XX:+FullGCALot")) {
3247       if (FLAG_SET_CMDLINE(bool, FullGCALot, true) != Flag::SUCCESS) {
3248         return JNI_EINVAL;
3249       }
3250       // disable scavenge before parallel mark-compact
3251       if (FLAG_SET_CMDLINE(bool, ScavengeBeforeFullGC, false) != Flag::SUCCESS) {
3252         return JNI_EINVAL;
3253       }
3254 #endif
3255 #if !INCLUDE_MANAGEMENT
3256     } else if (match_option(option, "-XX:+ManagementServer")) {
3257         jio_fprintf(defaultStream::error_stream(),
3258           "ManagementServer is not supported in this VM.\n");
3259         return JNI_ERR;
3260 #endif // INCLUDE_MANAGEMENT
3261     } else if (match_option(option, "-XX:", &amp;tail)) { // -XX:xxxx
3262       // Skip -XX:Flags= and -XX:VMOptionsFile= since those cases have
3263       // already been handled
3264       if ((strncmp(tail, "Flags=", strlen("Flags=")) != 0) &amp;&amp;
3265           (strncmp(tail, "VMOptionsFile=", strlen("VMOptionsFile=")) != 0)) {
3266         if (!process_argument(tail, args-&gt;ignoreUnrecognized, origin)) {
3267           return JNI_EINVAL;
3268         }
3269       }
3270     // Unknown option
3271     } else if (is_bad_option(option, args-&gt;ignoreUnrecognized)) {
3272       return JNI_ERR;
3273     }
3274   }
3275 
3276   // PrintSharedArchiveAndExit will turn on
3277   //   -Xshare:on
3278   //   -Xlog:class+path=info
3279   if (PrintSharedArchiveAndExit) {
3280     if (FLAG_SET_CMDLINE(bool, UseSharedSpaces, true) != Flag::SUCCESS) {
3281       return JNI_EINVAL;
3282     }
3283     if (FLAG_SET_CMDLINE(bool, RequireSharedSpaces, true) != Flag::SUCCESS) {
3284       return JNI_EINVAL;
3285     }
3286     LogConfiguration::configure_stdout(LogLevel::Info, true, LOG_TAGS(class, path));
3287   }
3288 
3289   // Change the default value for flags  which have different default values
3290   // when working with older JDKs.
3291 #ifdef LINUX
3292  if (JDK_Version::current().compare_major(6) &lt;= 0 &amp;&amp;
3293       FLAG_IS_DEFAULT(UseLinuxPosixThreadCPUClocks)) {
3294     FLAG_SET_DEFAULT(UseLinuxPosixThreadCPUClocks, false);
3295   }
3296 #endif // LINUX
3297   fix_appclasspath();
3298   return JNI_OK;
3299 }
3300 
3301 void Arguments::add_xpatchprefix(const char* module_name, const char* path, bool* xpatch_javabase) {
3302   // For java.base check for duplicate -Xpatch options being specified on the command line.
3303   // This check is only required for java.base, all other duplicate module specifications
3304   // will be checked during module system initialization.  The module system initialization
3305   // will throw an ExceptionInInitializerError if this situation occurs.
3306   if (strcmp(module_name, "java.base") == 0) {
3307     if (*xpatch_javabase) {
3308       vm_exit_during_initialization("Cannot specify java.base more than once to -Xpatch");
3309     } else {
3310       *xpatch_javabase = true;
3311     }
3312   }
3313 
3314   // Create GrowableArray lazily, only if -Xpatch has been specified
3315   if (_xpatchprefix == NULL) {
3316     _xpatchprefix = new (ResourceObj::C_HEAP, mtArguments) GrowableArray&lt;ModuleXPatchPath*&gt;(10, true);
3317   }
3318 
3319   _xpatchprefix-&gt;push(new ModuleXPatchPath(module_name, path));
3320 }
3321 
3322 // Set property jdk.boot.class.path.append to the contents of the bootclasspath
3323 // that follows either the jimage file or exploded module directories.  The
3324 // property will contain -Xbootclasspath/a and/or jvmti appended additions.
3325 void Arguments::set_jdkbootclasspath_append() {
3326   char *sysclasspath = get_sysclasspath();
3327   assert(sysclasspath != NULL, "NULL sysclasspath");
3328   int bcp_a_idx = bootclassloader_append_index();
3329   if (bcp_a_idx != -1 &amp;&amp; bcp_a_idx &lt; (int)strlen(sysclasspath)) {
3330     _jdk_boot_class_path_append-&gt;set_value(sysclasspath + bcp_a_idx);
3331   }
3332 }
3333 
3334 // Remove all empty paths from the app classpath (if IgnoreEmptyClassPaths is enabled)
3335 //
3336 // This is necessary because some apps like to specify classpath like -cp foo.jar:${XYZ}:bar.jar
3337 // in their start-up scripts. If XYZ is empty, the classpath will look like "-cp foo.jar::bar.jar".
3338 // Java treats such empty paths as if the user specified "-cp foo.jar:.:bar.jar". I.e., an empty
3339 // path is treated as the current directory.
3340 //
3341 // This causes problems with CDS, which requires that all directories specified in the classpath
3342 // must be empty. In most cases, applications do NOT want to load classes from the current
3343 // directory anyway. Adding -XX:+IgnoreEmptyClassPaths will make these applications' start-up
3344 // scripts compatible with CDS.
3345 void Arguments::fix_appclasspath() {
3346   if (IgnoreEmptyClassPaths) {
3347     const char separator = *os::path_separator();
3348     const char* src = _java_class_path-&gt;value();
3349 
3350     // skip over all the leading empty paths
3351     while (*src == separator) {
3352       src ++;
3353     }
3354 
3355     char* copy = os::strdup_check_oom(src, mtArguments);
3356 
3357     // trim all trailing empty paths
3358     for (char* tail = copy + strlen(copy) - 1; tail &gt;= copy &amp;&amp; *tail == separator; tail--) {
3359       *tail = '\0';
3360     }
3361 
3362     char from[3] = {separator, separator, '\0'};
3363     char to  [2] = {separator, '\0'};
3364     while (StringUtils::replace_no_expand(copy, from, to) &gt; 0) {
3365       // Keep replacing "::" -&gt; ":" until we have no more "::" (non-windows)
3366       // Keep replacing ";;" -&gt; ";" until we have no more ";;" (windows)
3367     }
3368 
3369     _java_class_path-&gt;set_writeable_value(copy);
3370     FreeHeap(copy); // a copy was made by set_value, so don't need this anymore
3371   }
3372 }
3373 
3374 static bool has_jar_files(const char* directory) {
3375   DIR* dir = os::opendir(directory);
3376   if (dir == NULL) return false;
3377 
3378   struct dirent *entry;
3379   char *dbuf = NEW_C_HEAP_ARRAY(char, os::readdir_buf_size(directory), mtArguments);
3380   bool hasJarFile = false;
3381   while (!hasJarFile &amp;&amp; (entry = os::readdir(dir, (dirent *) dbuf)) != NULL) {
3382     const char* name = entry-&gt;d_name;
3383     const char* ext = name + strlen(name) - 4;
3384     hasJarFile = ext &gt; name &amp;&amp; (os::file_name_strcmp(ext, ".jar") == 0);
3385   }
3386   FREE_C_HEAP_ARRAY(char, dbuf);
3387   os::closedir(dir);
3388   return hasJarFile ;
3389 }
3390 
3391 static int check_non_empty_dirs(const char* path) {
3392   const char separator = *os::path_separator();
3393   const char* const end = path + strlen(path);
3394   int nonEmptyDirs = 0;
3395   while (path &lt; end) {
3396     const char* tmp_end = strchr(path, separator);
3397     if (tmp_end == NULL) {
3398       if (has_jar_files(path)) {
3399         nonEmptyDirs++;
3400         jio_fprintf(defaultStream::output_stream(),
3401           "Non-empty directory: %s\n", path);
3402       }
3403       path = end;
3404     } else {
3405       char* dirpath = NEW_C_HEAP_ARRAY(char, tmp_end - path + 1, mtArguments);
3406       memcpy(dirpath, path, tmp_end - path);
3407       dirpath[tmp_end - path] = '\0';
3408       if (has_jar_files(dirpath)) {
3409         nonEmptyDirs++;
3410         jio_fprintf(defaultStream::output_stream(),
3411           "Non-empty directory: %s\n", dirpath);
3412       }
3413       FREE_C_HEAP_ARRAY(char, dirpath);
3414       path = tmp_end + 1;
3415     }
3416   }
3417   return nonEmptyDirs;
3418 }
3419 
3420 jint Arguments::finalize_vm_init_args() {
3421   // check if the default lib/endorsed directory exists; if so, error
3422   char path[JVM_MAXPATHLEN];
3423   const char* fileSep = os::file_separator();
3424   sprintf(path, "%s%slib%sendorsed", Arguments::get_java_home(), fileSep, fileSep);
3425 
3426   if (CheckEndorsedAndExtDirs) {
3427     int nonEmptyDirs = 0;
3428     // check endorsed directory
3429     nonEmptyDirs += check_non_empty_dirs(path);
3430     // check the extension directories
3431     nonEmptyDirs += check_non_empty_dirs(Arguments::get_ext_dirs());
3432     if (nonEmptyDirs &gt; 0) {
3433       return JNI_ERR;
3434     }
3435   }
3436 
3437   DIR* dir = os::opendir(path);
3438   if (dir != NULL) {
3439     jio_fprintf(defaultStream::output_stream(),
3440       "&lt;JAVA_HOME&gt;/lib/endorsed is not supported. Endorsed standards and standalone APIs\n"
3441       "in modular form will be supported via the concept of upgradeable modules.\n");
3442     os::closedir(dir);
3443     return JNI_ERR;
3444   }
3445 
3446   sprintf(path, "%s%slib%sext", Arguments::get_java_home(), fileSep, fileSep);
3447   dir = os::opendir(path);
3448   if (dir != NULL) {
3449     jio_fprintf(defaultStream::output_stream(),
3450       "&lt;JAVA_HOME&gt;/lib/ext exists, extensions mechanism no longer supported; "
3451       "Use -classpath instead.\n.");
3452     os::closedir(dir);
3453     return JNI_ERR;
3454   }
3455 
3456   Arguments::set_bootclassloader_append_index(((int)strlen(Arguments::get_sysclasspath()))+1);
3457 
3458   // This must be done after all arguments have been processed.
3459   // java_compiler() true means set to "NONE" or empty.
3460   if (java_compiler() &amp;&amp; !xdebug_mode()) {
3461     // For backwards compatibility, we switch to interpreted mode if
3462     // -Djava.compiler="NONE" or "" is specified AND "-Xdebug" was
3463     // not specified.
3464     set_mode_flags(_int);
3465   }
3466 
3467   // CompileThresholdScaling == 0.0 is same as -Xint: Disable compilation (enable interpreter-only mode),
3468   // but like -Xint, leave compilation thresholds unaffected.
3469   // With tiered compilation disabled, setting CompileThreshold to 0 disables compilation as well.
3470   if ((CompileThresholdScaling == 0.0) || (!TieredCompilation &amp;&amp; CompileThreshold == 0)) {
3471     set_mode_flags(_int);
3472   }
3473 
3474   // eventually fix up InitialTenuringThreshold if only MaxTenuringThreshold is set
3475   if (FLAG_IS_DEFAULT(InitialTenuringThreshold) &amp;&amp; (InitialTenuringThreshold &gt; MaxTenuringThreshold)) {
3476     FLAG_SET_ERGO(uintx, InitialTenuringThreshold, MaxTenuringThreshold);
3477   }
3478 
3479 #if !defined(COMPILER2) &amp;&amp; !INCLUDE_JVMCI
3480   // Don't degrade server performance for footprint
3481   if (FLAG_IS_DEFAULT(UseLargePages) &amp;&amp;
3482       MaxHeapSize &lt; LargePageHeapSizeThreshold) {
3483     // No need for large granularity pages w/small heaps.
3484     // Note that large pages are enabled/disabled for both the
3485     // Java heap and the code cache.
3486     FLAG_SET_DEFAULT(UseLargePages, false);
3487   }
3488 
3489 #elif defined(COMPILER2)
3490   if (!FLAG_IS_DEFAULT(OptoLoopAlignment) &amp;&amp; FLAG_IS_DEFAULT(MaxLoopPad)) {
3491     FLAG_SET_DEFAULT(MaxLoopPad, OptoLoopAlignment-1);
3492   }
3493 #endif
3494 
3495 #if !defined(COMPILER2) &amp;&amp; !INCLUDE_JVMCI
3496   UNSUPPORTED_OPTION(ProfileInterpreter);
3497   NOT_PRODUCT(UNSUPPORTED_OPTION(TraceProfileInterpreter));
3498 #endif
3499 
3500 #ifndef TIERED
3501   // Tiered compilation is undefined.
3502   UNSUPPORTED_OPTION(TieredCompilation);
3503 #endif
3504 
3505 #if INCLUDE_JVMCI
3506   if (EnableJVMCI &amp;&amp; !append_to_addmods_property("jdk.vm.ci")) {
3507     return JNI_ENOMEM;
3508   }
3509 #endif
3510 
3511   // If we are running in a headless jre, force java.awt.headless property
3512   // to be true unless the property has already been set.
3513   // Also allow the OS environment variable JAVA_AWT_HEADLESS to set headless state.
3514   if (os::is_headless_jre()) {
3515     const char* headless = Arguments::get_property("java.awt.headless");
3516     if (headless == NULL) {
3517       const char *headless_env = ::getenv("JAVA_AWT_HEADLESS");
3518       if (headless_env == NULL) {
3519         if (!add_property("java.awt.headless=true")) {
3520           return JNI_ENOMEM;
3521         }
3522       } else {
3523         char buffer[256];
3524         jio_snprintf(buffer, sizeof(buffer), "java.awt.headless=%s", headless_env);
3525         if (!add_property(buffer)) {
3526           return JNI_ENOMEM;
3527         }
3528       }
3529     }
3530   }
3531 
3532   if (UseConcMarkSweepGC &amp;&amp; FLAG_IS_DEFAULT(UseParNewGC) &amp;&amp; !UseParNewGC) {
3533     // CMS can only be used with ParNew
3534     FLAG_SET_ERGO(bool, UseParNewGC, true);
3535   }
3536 
3537   if (!check_vm_args_consistency()) {
3538     return JNI_ERR;
3539   }
3540 
3541   return JNI_OK;
3542 }
3543 
3544 // Helper class for controlling the lifetime of JavaVMInitArgs
3545 // objects.  The contents of the JavaVMInitArgs are guaranteed to be
3546 // deleted on the destruction of the ScopedVMInitArgs object.
3547 class ScopedVMInitArgs : public StackObj {
3548  private:
3549   JavaVMInitArgs _args;
3550   char*          _container_name;
3551   bool           _is_set;
3552   char*          _vm_options_file_arg;
3553 
3554  public:
3555   ScopedVMInitArgs(const char *container_name) {
3556     _args.version = JNI_VERSION_1_2;
3557     _args.nOptions = 0;
3558     _args.options = NULL;
3559     _args.ignoreUnrecognized = false;
3560     _container_name = (char *)container_name;
3561     _is_set = false;
3562     _vm_options_file_arg = NULL;
3563   }
3564 
3565   // Populates the JavaVMInitArgs object represented by this
3566   // ScopedVMInitArgs object with the arguments in options.  The
3567   // allocated memory is deleted by the destructor.  If this method
3568   // returns anything other than JNI_OK, then this object is in a
3569   // partially constructed state, and should be abandoned.
3570   jint set_args(GrowableArray&lt;JavaVMOption&gt;* options) {
3571     _is_set = true;
3572     JavaVMOption* options_arr = NEW_C_HEAP_ARRAY_RETURN_NULL(
3573         JavaVMOption, options-&gt;length(), mtArguments);
3574     if (options_arr == NULL) {
3575       return JNI_ENOMEM;
3576     }
3577     _args.options = options_arr;
3578 
3579     for (int i = 0; i &lt; options-&gt;length(); i++) {
3580       options_arr[i] = options-&gt;at(i);
3581       options_arr[i].optionString = os::strdup(options_arr[i].optionString);
3582       if (options_arr[i].optionString == NULL) {
3583         // Rely on the destructor to do cleanup.
3584         _args.nOptions = i;
3585         return JNI_ENOMEM;
3586       }
3587     }
3588 
3589     _args.nOptions = options-&gt;length();
3590     _args.ignoreUnrecognized = IgnoreUnrecognizedVMOptions;
3591     return JNI_OK;
3592   }
3593 
3594   JavaVMInitArgs* get()             { return &amp;_args; }
3595   char* container_name()            { return _container_name; }
3596   bool  is_set()                    { return _is_set; }
3597   bool  found_vm_options_file_arg() { return _vm_options_file_arg != NULL; }
3598   char* vm_options_file_arg()       { return _vm_options_file_arg; }
3599 
3600   void set_vm_options_file_arg(const char *vm_options_file_arg) {
3601     if (_vm_options_file_arg != NULL) {
3602       os::free(_vm_options_file_arg);
3603     }
3604     _vm_options_file_arg = os::strdup_check_oom(vm_options_file_arg);
3605   }
3606 
3607   ~ScopedVMInitArgs() {
3608     if (_vm_options_file_arg != NULL) {
3609       os::free(_vm_options_file_arg);
3610     }
3611     if (_args.options == NULL) return;
3612     for (int i = 0; i &lt; _args.nOptions; i++) {
3613       os::free(_args.options[i].optionString);
3614     }
3615     FREE_C_HEAP_ARRAY(JavaVMOption, _args.options);
3616   }
3617 
3618   // Insert options into this option list, to replace option at
3619   // vm_options_file_pos (-XX:VMOptionsFile)
3620   jint insert(const JavaVMInitArgs* args,
3621               const JavaVMInitArgs* args_to_insert,
3622               const int vm_options_file_pos) {
3623     assert(_args.options == NULL, "shouldn't be set yet");
3624     assert(args_to_insert-&gt;nOptions != 0, "there should be args to insert");
3625     assert(vm_options_file_pos != -1, "vm_options_file_pos should be set");
3626 
3627     int length = args-&gt;nOptions + args_to_insert-&gt;nOptions - 1;
3628     GrowableArray&lt;JavaVMOption&gt; *options = new (ResourceObj::C_HEAP, mtArguments)
3629               GrowableArray&lt;JavaVMOption&gt;(length, true);    // Construct new option array
3630     for (int i = 0; i &lt; args-&gt;nOptions; i++) {
3631       if (i == vm_options_file_pos) {
3632         // insert the new options starting at the same place as the
3633         // -XX:VMOptionsFile option
3634         for (int j = 0; j &lt; args_to_insert-&gt;nOptions; j++) {
3635           options-&gt;push(args_to_insert-&gt;options[j]);
3636         }
3637       } else {
3638         options-&gt;push(args-&gt;options[i]);
3639       }
3640     }
3641     // make into options array
3642     jint result = set_args(options);
3643     delete options;
3644     return result;
3645   }
3646 };
3647 
3648 jint Arguments::parse_java_options_environment_variable(ScopedVMInitArgs* args) {
3649   return parse_options_environment_variable("_JAVA_OPTIONS", args);
3650 }
3651 
3652 jint Arguments::parse_java_tool_options_environment_variable(ScopedVMInitArgs* args) {
3653   return parse_options_environment_variable("JAVA_TOOL_OPTIONS", args);
3654 }
3655 
3656 jint Arguments::parse_options_environment_variable(const char* name,
3657                                                    ScopedVMInitArgs* vm_args) {
3658   char *buffer = ::getenv(name);
3659 
3660   // Don't check this environment variable if user has special privileges
3661   // (e.g. unix su command).
3662   if (buffer == NULL || os::have_special_privileges()) {
3663     return JNI_OK;
3664   }
3665 
3666   if ((buffer = os::strdup(buffer)) == NULL) {
3667     return JNI_ENOMEM;
3668   }
3669 
3670   int retcode = parse_options_buffer(name, buffer, strlen(buffer), vm_args);
3671 
3672   os::free(buffer);
3673   return retcode;
3674 }
3675 
3676 jint Arguments::parse_vm_options_file(const char* file_name, ScopedVMInitArgs* vm_args) {
3677   // read file into buffer
3678   int fd = ::open(file_name, O_RDONLY);
3679   if (fd &lt; 0) {
3680     jio_fprintf(defaultStream::error_stream(),
3681                 "Could not open options file '%s'\n",
3682                 file_name);
3683     return JNI_ERR;
3684   }
3685 
3686   struct stat stbuf;
3687   int retcode = os::stat(file_name, &amp;stbuf);
3688   if (retcode != 0) {
3689     jio_fprintf(defaultStream::error_stream(),
3690                 "Could not stat options file '%s'\n",
3691                 file_name);
3692     os::close(fd);
3693     return JNI_ERR;
3694   }
3695 
3696   if (stbuf.st_size == 0) {
3697     // tell caller there is no option data and that is ok
3698     os::close(fd);
3699     return JNI_OK;
3700   }
3701 
3702   // '+ 1' for NULL termination even with max bytes
3703   size_t bytes_alloc = stbuf.st_size + 1;
3704 
3705   char *buf = NEW_C_HEAP_ARRAY_RETURN_NULL(char, bytes_alloc, mtArguments);
3706   if (NULL == buf) {
3707     jio_fprintf(defaultStream::error_stream(),
3708                 "Could not allocate read buffer for options file parse\n");
3709     os::close(fd);
3710     return JNI_ENOMEM;
3711   }
3712 
3713   memset(buf, 0, bytes_alloc);
3714 
3715   // Fill buffer
3716   // Use ::read() instead of os::read because os::read()
3717   // might do a thread state transition
3718   // and it is too early for that here
3719 
3720   ssize_t bytes_read = ::read(fd, (void *)buf, (unsigned)bytes_alloc);
3721   os::close(fd);
3722   if (bytes_read &lt; 0) {
3723     FREE_C_HEAP_ARRAY(char, buf);
3724     jio_fprintf(defaultStream::error_stream(),
3725                 "Could not read options file '%s'\n", file_name);
3726     return JNI_ERR;
3727   }
3728 
3729   if (bytes_read == 0) {
3730     // tell caller there is no option data and that is ok
3731     FREE_C_HEAP_ARRAY(char, buf);
3732     return JNI_OK;
3733   }
3734 
3735   retcode = parse_options_buffer(file_name, buf, bytes_read, vm_args);
3736 
3737   FREE_C_HEAP_ARRAY(char, buf);
3738   return retcode;
3739 }
3740 
3741 jint Arguments::parse_options_buffer(const char* name, char* buffer, const size_t buf_len, ScopedVMInitArgs* vm_args) {
3742   GrowableArray&lt;JavaVMOption&gt; *options = new (ResourceObj::C_HEAP, mtArguments) GrowableArray&lt;JavaVMOption&gt;(2, true);    // Construct option array
3743 
3744   // some pointers to help with parsing
3745   char *buffer_end = buffer + buf_len;
3746   char *opt_hd = buffer;
3747   char *wrt = buffer;
3748   char *rd = buffer;
3749 
3750   // parse all options
3751   while (rd &lt; buffer_end) {
3752     // skip leading white space from the input string
3753     while (rd &lt; buffer_end &amp;&amp; isspace(*rd)) {
3754       rd++;
3755     }
3756 
3757     if (rd &gt;= buffer_end) {
3758       break;
3759     }
3760 
3761     // Remember this is where we found the head of the token.
3762     opt_hd = wrt;
3763 
3764     // Tokens are strings of non white space characters separated
3765     // by one or more white spaces.
3766     while (rd &lt; buffer_end &amp;&amp; !isspace(*rd)) {
3767       if (*rd == '\'' || *rd == '"') {      // handle a quoted string
3768         int quote = *rd;                    // matching quote to look for
3769         rd++;                               // don't copy open quote
3770         while (rd &lt; buffer_end &amp;&amp; *rd != quote) {
3771                                             // include everything (even spaces)
3772                                             // up until the close quote
3773           *wrt++ = *rd++;                   // copy to option string
3774         }
3775 
3776         if (rd &lt; buffer_end) {
3777           rd++;                             // don't copy close quote
3778         } else {
3779                                             // did not see closing quote
3780           jio_fprintf(defaultStream::error_stream(),
3781                       "Unmatched quote in %s\n", name);
3782           delete options;
3783           return JNI_ERR;
3784         }
3785       } else {
3786         *wrt++ = *rd++;                     // copy to option string
3787       }
3788     }
3789 
3790     // steal a white space character and set it to NULL
3791     *wrt++ = '\0';
3792     // We now have a complete token
3793 
3794     JavaVMOption option;
3795     option.optionString = opt_hd;
3796     option.extraInfo = NULL;
3797 
3798     options-&gt;append(option);                // Fill in option
3799 
3800     rd++;  // Advance to next character
3801   }
3802 
3803   // Fill out JavaVMInitArgs structure.
3804   jint status = vm_args-&gt;set_args(options);
3805 
3806   delete options;
3807   return status;
3808 }
3809 
3810 void Arguments::set_shared_spaces_flags() {
3811   if (DumpSharedSpaces) {
3812     if (Arguments::get_xpatchprefix() != NULL) {
3813       vm_exit_during_initialization(
3814         "Cannot use the following option when dumping the shared archive", "-Xpatch");
3815     }
3816 
3817     if (RequireSharedSpaces) {
3818       warning("Cannot dump shared archive while using shared archive");
3819     }
3820     UseSharedSpaces = false;
3821 #ifdef _LP64
3822     if (!UseCompressedOops || !UseCompressedClassPointers) {
3823       vm_exit_during_initialization(
3824         "Cannot dump shared archive when UseCompressedOops or UseCompressedClassPointers is off.", NULL);
3825     }
3826   } else {
3827     if (!UseCompressedOops || !UseCompressedClassPointers) {
3828       no_shared_spaces("UseCompressedOops and UseCompressedClassPointers must be on for UseSharedSpaces.");
3829     }
3830 #endif
3831   }
3832 }
3833 
3834 // Sharing support
3835 // Construct the path to the archive
3836 static char* get_shared_archive_path() {
3837   char *shared_archive_path;
3838   if (SharedArchiveFile == NULL) {
3839     char jvm_path[JVM_MAXPATHLEN];
3840     os::jvm_path(jvm_path, sizeof(jvm_path));
3841     char *end = strrchr(jvm_path, *os::file_separator());
3842     if (end != NULL) *end = '\0';
3843     size_t jvm_path_len = strlen(jvm_path);
3844     size_t file_sep_len = strlen(os::file_separator());
3845     const size_t len = jvm_path_len + file_sep_len + 20;
3846     shared_archive_path = NEW_C_HEAP_ARRAY(char, len, mtArguments);
3847     if (shared_archive_path != NULL) {
3848       jio_snprintf(shared_archive_path, len, "%s%sclasses.jsa",
3849         jvm_path, os::file_separator());
3850     }
3851   } else {
3852     shared_archive_path = os::strdup_check_oom(SharedArchiveFile, mtArguments);
3853   }
3854   return shared_archive_path;
3855 }
3856 
3857 #ifndef PRODUCT
3858 // Determine whether LogVMOutput should be implicitly turned on.
3859 static bool use_vm_log() {
3860   if (LogCompilation || !FLAG_IS_DEFAULT(LogFile) ||
3861       PrintCompilation || PrintInlining || PrintDependencies || PrintNativeNMethods ||
3862       PrintDebugInfo || PrintRelocations || PrintNMethods || PrintExceptionHandlers ||
3863       PrintAssembly || TraceDeoptimization || TraceDependencies ||
3864       (VerifyDependencies &amp;&amp; FLAG_IS_CMDLINE(VerifyDependencies))) {
3865     return true;
3866   }
3867 
3868 #ifdef COMPILER1
3869   if (PrintC1Statistics) {
3870     return true;
3871   }
3872 #endif // COMPILER1
3873 
3874 #ifdef COMPILER2
3875   if (PrintOptoAssembly || PrintOptoStatistics) {
3876     return true;
3877   }
3878 #endif // COMPILER2
3879 
3880   return false;
3881 }
3882 
3883 #endif // PRODUCT
3884 
3885 bool Arguments::args_contains_vm_options_file_arg(const JavaVMInitArgs* args) {
3886   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
3887     const JavaVMOption* option = args-&gt;options + index;
3888     const char* tail;
3889     if (match_option(option, "-XX:VMOptionsFile=", &amp;tail)) {
3890       return true;
3891     }
3892   }
3893   return false;
3894 }
3895 
3896 jint Arguments::insert_vm_options_file(const JavaVMInitArgs* args,
3897                                        const char* vm_options_file,
3898                                        const int vm_options_file_pos,
3899                                        ScopedVMInitArgs* vm_options_file_args,
3900                                        ScopedVMInitArgs* args_out) {
3901   jint code = parse_vm_options_file(vm_options_file, vm_options_file_args);
3902   if (code != JNI_OK) {
3903     return code;
3904   }
3905 
3906   if (vm_options_file_args-&gt;get()-&gt;nOptions &lt; 1) {
3907     return JNI_OK;
3908   }
3909 
3910   if (args_contains_vm_options_file_arg(vm_options_file_args-&gt;get())) {
3911     jio_fprintf(defaultStream::error_stream(),
3912                 "A VM options file may not refer to a VM options file. "
3913                 "Specification of '-XX:VMOptionsFile=&lt;file-name&gt;' in the "
3914                 "options file '%s' in options container '%s' is an error.\n",
3915                 vm_options_file_args-&gt;vm_options_file_arg(),
3916                 vm_options_file_args-&gt;container_name());
3917     return JNI_EINVAL;
3918   }
3919 
3920   return args_out-&gt;insert(args, vm_options_file_args-&gt;get(),
3921                           vm_options_file_pos);
3922 }
3923 
3924 // Expand -XX:VMOptionsFile found in args_in as needed.
3925 // mod_args and args_out parameters may return values as needed.
3926 jint Arguments::expand_vm_options_as_needed(const JavaVMInitArgs* args_in,
3927                                             ScopedVMInitArgs* mod_args,
3928                                             JavaVMInitArgs** args_out) {
3929   jint code = match_special_option_and_act(args_in, mod_args);
3930   if (code != JNI_OK) {
3931     return code;
3932   }
3933 
3934   if (mod_args-&gt;is_set()) {
3935     // args_in contains -XX:VMOptionsFile and mod_args contains the
3936     // original options from args_in along with the options expanded
3937     // from the VMOptionsFile. Return a short-hand to the caller.
3938     *args_out = mod_args-&gt;get();
3939   } else {
3940     *args_out = (JavaVMInitArgs *)args_in;  // no changes so use args_in
3941   }
3942   return JNI_OK;
3943 }
3944 
3945 jint Arguments::match_special_option_and_act(const JavaVMInitArgs* args,
3946                                              ScopedVMInitArgs* args_out) {
3947   // Remaining part of option string
3948   const char* tail;
3949   ScopedVMInitArgs vm_options_file_args(args_out-&gt;container_name());
3950 
3951   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
3952     const JavaVMOption* option = args-&gt;options + index;
3953     if (ArgumentsExt::process_options(option)) {
3954       continue;
3955     }
3956     if (match_option(option, "-XX:Flags=", &amp;tail)) {
3957       Arguments::set_jvm_flags_file(tail);
3958       continue;
3959     }
3960     if (match_option(option, "-XX:VMOptionsFile=", &amp;tail)) {
3961       if (vm_options_file_args.found_vm_options_file_arg()) {
3962         jio_fprintf(defaultStream::error_stream(),
3963                     "The option '%s' is already specified in the options "
3964                     "container '%s' so the specification of '%s' in the "
3965                     "same options container is an error.\n",
3966                     vm_options_file_args.vm_options_file_arg(),
3967                     vm_options_file_args.container_name(),
3968                     option-&gt;optionString);
3969         return JNI_EINVAL;
3970       }
3971       vm_options_file_args.set_vm_options_file_arg(option-&gt;optionString);
3972       // If there's a VMOptionsFile, parse that
3973       jint code = insert_vm_options_file(args, tail, index,
3974                                          &amp;vm_options_file_args, args_out);
3975       if (code != JNI_OK) {
3976         return code;
3977       }
3978       args_out-&gt;set_vm_options_file_arg(vm_options_file_args.vm_options_file_arg());
3979       if (args_out-&gt;is_set()) {
3980         // The VMOptions file inserted some options so switch 'args'
3981         // to the new set of options, and continue processing which
3982         // preserves "last option wins" semantics.
3983         args = args_out-&gt;get();
3984         // The first option from the VMOptionsFile replaces the
3985         // current option.  So we back track to process the
3986         // replacement option.
3987         index--;
3988       }
3989       continue;
3990     }
3991     if (match_option(option, "-XX:+PrintVMOptions")) {
3992       PrintVMOptions = true;
3993       continue;
3994     }
3995     if (match_option(option, "-XX:-PrintVMOptions")) {
3996       PrintVMOptions = false;
3997       continue;
3998     }
3999     if (match_option(option, "-XX:+IgnoreUnrecognizedVMOptions")) {
4000       IgnoreUnrecognizedVMOptions = true;
4001       continue;
4002     }
4003     if (match_option(option, "-XX:-IgnoreUnrecognizedVMOptions")) {
4004       IgnoreUnrecognizedVMOptions = false;
4005       continue;
4006     }
4007     if (match_option(option, "-XX:+PrintFlagsInitial")) {
4008       CommandLineFlags::printFlags(tty, false);
4009       vm_exit(0);
4010     }
4011     if (match_option(option, "-XX:NativeMemoryTracking", &amp;tail)) {
4012 #if INCLUDE_NMT
4013       // The launcher did not setup nmt environment variable properly.
4014       if (!MemTracker::check_launcher_nmt_support(tail)) {
4015         warning("Native Memory Tracking did not setup properly, using wrong launcher?");
4016       }
4017 
4018       // Verify if nmt option is valid.
4019       if (MemTracker::verify_nmt_option()) {
4020         // Late initialization, still in single-threaded mode.
4021         if (MemTracker::tracking_level() &gt;= NMT_summary) {
4022           MemTracker::init();
4023         }
4024       } else {
4025         vm_exit_during_initialization("Syntax error, expecting -XX:NativeMemoryTracking=[off|summary|detail]", NULL);
4026       }
4027       continue;
4028 #else
4029       jio_fprintf(defaultStream::error_stream(),
4030         "Native Memory Tracking is not supported in this VM\n");
4031       return JNI_ERR;
4032 #endif
4033     }
4034 
4035 #ifndef PRODUCT
4036     if (match_option(option, "-XX:+PrintFlagsWithComments")) {
4037       CommandLineFlags::printFlags(tty, true);
4038       vm_exit(0);
4039     }
4040 #endif
4041   }
4042   return JNI_OK;
4043 }
4044 
4045 static void print_options(const JavaVMInitArgs *args) {
4046   const char* tail;
4047   for (int index = 0; index &lt; args-&gt;nOptions; index++) {
4048     const JavaVMOption *option = args-&gt;options + index;
4049     if (match_option(option, "-XX:", &amp;tail)) {
4050       logOption(tail);
4051     }
4052   }
4053 }
4054 
4055 bool Arguments::handle_deprecated_print_gc_flags() {
4056   if (PrintGC) {
4057     log_warning(gc)("-XX:+PrintGC is deprecated. Will use -Xlog:gc instead.");
4058   }
4059   if (PrintGCDetails) {
4060     log_warning(gc)("-XX:+PrintGCDetails is deprecated. Will use -Xlog:gc* instead.");
4061   }
4062 
4063   if (_gc_log_filename != NULL) {
4064     // -Xloggc was used to specify a filename
4065     const char* gc_conf = PrintGCDetails ? "gc*" : "gc";
4066     return  LogConfiguration::parse_log_arguments(_gc_log_filename, gc_conf, NULL, NULL, NULL);
4067   } else if (PrintGC || PrintGCDetails) {
4068     LogConfiguration::configure_stdout(LogLevel::Info, !PrintGCDetails, LOG_TAGS(gc));
4069   }
4070   return true;
4071 }
4072 
4073 // Parse entry point called from JNI_CreateJavaVM
4074 
4075 jint Arguments::parse(const JavaVMInitArgs* initial_cmd_args) {
4076   assert(verify_special_jvm_flags(), "deprecated and obsolete flag table inconsistent");
4077 
4078   // Initialize ranges, constraints and writeables
4079   CommandLineFlagRangeList::init();
4080   CommandLineFlagConstraintList::init();
4081   CommandLineFlagWriteableList::init();
4082 
4083   // If flag "-XX:Flags=flags-file" is used it will be the first option to be processed.
4084   const char* hotspotrc = ".hotspotrc";
4085   bool settings_file_specified = false;
4086   bool needs_hotspotrc_warning = false;
4087   ScopedVMInitArgs initial_java_tool_options_args("env_var='JAVA_TOOL_OPTIONS'");
4088   ScopedVMInitArgs initial_java_options_args("env_var='_JAVA_OPTIONS'");
4089 
4090   // Pointers to current working set of containers
4091   JavaVMInitArgs* cur_cmd_args;
4092   JavaVMInitArgs* cur_java_options_args;
4093   JavaVMInitArgs* cur_java_tool_options_args;
4094 
4095   // Containers for modified/expanded options
4096   ScopedVMInitArgs mod_cmd_args("cmd_line_args");
4097   ScopedVMInitArgs mod_java_tool_options_args("env_var='JAVA_TOOL_OPTIONS'");
4098   ScopedVMInitArgs mod_java_options_args("env_var='_JAVA_OPTIONS'");
4099 
4100 
4101   jint code =
4102       parse_java_tool_options_environment_variable(&amp;initial_java_tool_options_args);
4103   if (code != JNI_OK) {
4104     return code;
4105   }
4106 
4107   code = parse_java_options_environment_variable(&amp;initial_java_options_args);
4108   if (code != JNI_OK) {
4109     return code;
4110   }
4111 
4112   code = expand_vm_options_as_needed(initial_java_tool_options_args.get(),
4113                                      &amp;mod_java_tool_options_args,
4114                                      &amp;cur_java_tool_options_args);
4115   if (code != JNI_OK) {
4116     return code;
4117   }
4118 
4119   code = expand_vm_options_as_needed(initial_cmd_args,
4120                                      &amp;mod_cmd_args,
4121                                      &amp;cur_cmd_args);
4122   if (code != JNI_OK) {
4123     return code;
4124   }
4125 
4126   code = expand_vm_options_as_needed(initial_java_options_args.get(),
4127                                      &amp;mod_java_options_args,
4128                                      &amp;cur_java_options_args);
4129   if (code != JNI_OK) {
4130     return code;
4131   }
4132 
4133   const char* flags_file = Arguments::get_jvm_flags_file();
4134   settings_file_specified = (flags_file != NULL);
4135 
4136   if (IgnoreUnrecognizedVMOptions) {
4137     cur_cmd_args-&gt;ignoreUnrecognized = true;
4138     cur_java_tool_options_args-&gt;ignoreUnrecognized = true;
4139     cur_java_options_args-&gt;ignoreUnrecognized = true;
4140   }
4141 
4142   // Parse specified settings file
4143   if (settings_file_specified) {
4144     if (!process_settings_file(flags_file, true,
4145                                cur_cmd_args-&gt;ignoreUnrecognized)) {
4146       return JNI_EINVAL;
4147     }
4148   } else {
4149 #ifdef ASSERT
4150     // Parse default .hotspotrc settings file
4151     if (!process_settings_file(".hotspotrc", false,
4152                                cur_cmd_args-&gt;ignoreUnrecognized)) {
4153       return JNI_EINVAL;
4154     }
4155 #else
4156     struct stat buf;
4157     if (os::stat(hotspotrc, &amp;buf) == 0) {
4158       needs_hotspotrc_warning = true;
4159     }
4160 #endif
4161   }
4162 
4163   if (PrintVMOptions) {
4164     print_options(cur_java_tool_options_args);
4165     print_options(cur_cmd_args);
4166     print_options(cur_java_options_args);
4167   }
4168 
4169   // Parse JavaVMInitArgs structure passed in, as well as JAVA_TOOL_OPTIONS and _JAVA_OPTIONS
4170   jint result = parse_vm_init_args(cur_java_tool_options_args,
4171                                    cur_java_options_args,
4172                                    cur_cmd_args);
4173 
4174   if (result != JNI_OK) {
4175     return result;
4176   }
4177 
4178   // Call get_shared_archive_path() here, after possible SharedArchiveFile option got parsed.
4179   SharedArchivePath = get_shared_archive_path();
4180   if (SharedArchivePath == NULL) {
4181     return JNI_ENOMEM;
4182   }
4183 
4184   // Set up VerifySharedSpaces
4185   if (FLAG_IS_DEFAULT(VerifySharedSpaces) &amp;&amp; SharedArchiveFile != NULL) {
4186     VerifySharedSpaces = true;
4187   }
4188 
4189   // Delay warning until here so that we've had a chance to process
4190   // the -XX:-PrintWarnings flag
4191   if (needs_hotspotrc_warning) {
4192     warning("%s file is present but has been ignored.  "
4193             "Run with -XX:Flags=%s to load the file.",
4194             hotspotrc, hotspotrc);
4195   }
4196 
4197 #if defined(_ALLBSD_SOURCE) || defined(AIX)  // UseLargePages is not yet supported on BSD and AIX.
4198   UNSUPPORTED_OPTION(UseLargePages);
4199 #endif
4200 
4201   ArgumentsExt::report_unsupported_options();
4202 
4203 #ifndef PRODUCT
4204   if (TraceBytecodesAt != 0) {
4205     TraceBytecodes = true;
4206   }
4207   if (CountCompiledCalls) {
4208     if (UseCounterDecay) {
4209       warning("UseCounterDecay disabled because CountCalls is set");
4210       UseCounterDecay = false;
4211     }
4212   }
4213 #endif // PRODUCT
4214 
4215   if (ScavengeRootsInCode == 0) {
4216     if (!FLAG_IS_DEFAULT(ScavengeRootsInCode)) {
4217       warning("Forcing ScavengeRootsInCode non-zero");
4218     }
4219     ScavengeRootsInCode = 1;
4220   }
4221 
4222   if (!handle_deprecated_print_gc_flags()) {
4223     return JNI_EINVAL;
4224   }
4225 
4226   // Set object alignment values.
4227   set_object_alignment();
4228 
4229 #if !INCLUDE_CDS
4230   if (DumpSharedSpaces || RequireSharedSpaces) {
4231     jio_fprintf(defaultStream::error_stream(),
4232       "Shared spaces are not supported in this VM\n");
4233     return JNI_ERR;
4234   }
4235   if ((UseSharedSpaces &amp;&amp; FLAG_IS_CMDLINE(UseSharedSpaces)) || PrintSharedSpaces) {
4236     warning("Shared spaces are not supported in this VM");
4237     FLAG_SET_DEFAULT(UseSharedSpaces, false);
4238     FLAG_SET_DEFAULT(PrintSharedSpaces, false);
4239   }
4240   no_shared_spaces("CDS Disabled");
4241 #endif // INCLUDE_CDS
4242 
4243   return JNI_OK;
4244 }
4245 
4246 jint Arguments::apply_ergo() {
4247 
4248   // Set flags based on ergonomics.
4249   set_ergonomics_flags();
4250 
4251   set_shared_spaces_flags();
4252 
4253   // Check the GC selections again.
4254   if (!check_gc_consistency()) {
4255     return JNI_EINVAL;
4256   }
4257 
4258   if (TieredCompilation) {
4259     set_tiered_flags();
4260   } else {
4261     int max_compilation_policy_choice = 1;
4262 #ifdef COMPILER2
4263     max_compilation_policy_choice = 2;
4264 #endif
4265     // Check if the policy is valid.
4266     if (CompilationPolicyChoice &gt;= max_compilation_policy_choice) {
4267       vm_exit_during_initialization(
4268         "Incompatible compilation policy selected", NULL);
4269     }
4270     // Scale CompileThreshold
4271     // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves CompileThreshold unchanged.
4272     if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
4273       FLAG_SET_ERGO(intx, CompileThreshold, scaled_compile_threshold(CompileThreshold));
4274     }
4275   }
4276 
4277 #ifdef COMPILER2
4278 #ifndef PRODUCT
4279   if (PrintIdealGraphLevel &gt; 0) {
4280     FLAG_SET_ERGO(bool, PrintIdealGraph, true);
4281   }
4282 #endif
4283 #endif
4284 
4285   // Set heap size based on available physical memory
4286   set_heap_size();
4287 
4288   ArgumentsExt::set_gc_specific_flags();
4289 
4290   // Initialize Metaspace flags and alignments
4291   Metaspace::ergo_initialize();
4292 
4293   // Set bytecode rewriting flags
4294   set_bytecode_flags();
4295 
4296   // Set flags if Aggressive optimization flags (-XX:+AggressiveOpts) enabled
4297   jint code = set_aggressive_opts_flags();
4298   if (code != JNI_OK) {
4299     return code;
4300   }
4301 
4302   // Turn off biased locking for locking debug mode flags,
4303   // which are subtly different from each other but neither works with
4304   // biased locking
4305   if (UseHeavyMonitors
4306 #ifdef COMPILER1
4307       || !UseFastLocking
4308 #endif // COMPILER1
4309 #if INCLUDE_JVMCI
4310       || !JVMCIUseFastLocking
4311 #endif
4312     ) {
4313     if (!FLAG_IS_DEFAULT(UseBiasedLocking) &amp;&amp; UseBiasedLocking) {
4314       // flag set to true on command line; warn the user that they
4315       // can't enable biased locking here
4316       warning("Biased Locking is not supported with locking debug flags"
4317               "; ignoring UseBiasedLocking flag." );
4318     }
4319     UseBiasedLocking = false;
4320   }
4321 
4322 #ifdef CC_INTERP
4323   // Clear flags not supported on zero.
4324   FLAG_SET_DEFAULT(ProfileInterpreter, false);
4325   FLAG_SET_DEFAULT(UseBiasedLocking, false);
4326   LP64_ONLY(FLAG_SET_DEFAULT(UseCompressedOops, false));
4327   LP64_ONLY(FLAG_SET_DEFAULT(UseCompressedClassPointers, false));
4328 #endif // CC_INTERP
4329 
4330 #ifdef COMPILER2
4331   if (!EliminateLocks) {
4332     EliminateNestedLocks = false;
4333   }
4334   if (!Inline) {
4335     IncrementalInline = false;
4336   }
4337 #ifndef PRODUCT
4338   if (!IncrementalInline) {
4339     AlwaysIncrementalInline = false;
4340   }
4341 #endif
4342   if (!UseTypeSpeculation &amp;&amp; FLAG_IS_DEFAULT(TypeProfileLevel)) {
4343     // nothing to use the profiling, turn if off
4344     FLAG_SET_DEFAULT(TypeProfileLevel, 0);
4345   }
4346 #endif
4347 
4348   if (PrintAssembly &amp;&amp; FLAG_IS_DEFAULT(DebugNonSafepoints)) {
4349     warning("PrintAssembly is enabled; turning on DebugNonSafepoints to gain additional output");
4350     DebugNonSafepoints = true;
4351   }
4352 
4353   if (FLAG_IS_CMDLINE(CompressedClassSpaceSize) &amp;&amp; !UseCompressedClassPointers) {
4354     warning("Setting CompressedClassSpaceSize has no effect when compressed class pointers are not used");
4355   }
4356 
4357   if (UseOnStackReplacement &amp;&amp; !UseLoopCounter) {
4358     warning("On-stack-replacement requires loop counters; enabling loop counters");
4359     FLAG_SET_DEFAULT(UseLoopCounter, true);
4360   }
4361 
4362 #ifndef PRODUCT
4363   if (!LogVMOutput &amp;&amp; FLAG_IS_DEFAULT(LogVMOutput)) {
4364     if (use_vm_log()) {
4365       LogVMOutput = true;
4366     }
4367   }
4368 #endif // PRODUCT
4369 
4370   if (PrintCommandLineFlags) {
4371     CommandLineFlags::printSetFlags(tty);
4372   }
4373 
4374   // Apply CPU specific policy for the BiasedLocking
4375   if (UseBiasedLocking) {
4376     if (!VM_Version::use_biased_locking() &amp;&amp;
4377         !(FLAG_IS_CMDLINE(UseBiasedLocking))) {
4378       UseBiasedLocking = false;
4379     }
4380   }
4381 #ifdef COMPILER2
4382   if (!UseBiasedLocking || EmitSync != 0) {
4383     UseOptoBiasInlining = false;
4384   }
4385 #endif
4386 
4387   return JNI_OK;
4388 }
4389 
4390 jint Arguments::adjust_after_os() {
4391   if (UseNUMA) {
4392     if (UseParallelGC || UseParallelOldGC) {
4393       if (FLAG_IS_DEFAULT(MinHeapDeltaBytes)) {
4394          FLAG_SET_DEFAULT(MinHeapDeltaBytes, 64*M);
4395       }
4396     }
4397     // UseNUMAInterleaving is set to ON for all collectors and
4398     // platforms when UseNUMA is set to ON. NUMA-aware collectors
4399     // such as the parallel collector for Linux and Solaris will
4400     // interleave old gen and survivor spaces on top of NUMA
4401     // allocation policy for the eden space.
4402     // Non NUMA-aware collectors such as CMS, G1 and Serial-GC on
4403     // all platforms and ParallelGC on Windows will interleave all
4404     // of the heap spaces across NUMA nodes.
4405     if (FLAG_IS_DEFAULT(UseNUMAInterleaving)) {
4406       FLAG_SET_ERGO(bool, UseNUMAInterleaving, true);
4407     }
4408   }
4409   return JNI_OK;
4410 }
4411 
4412 int Arguments::PropertyList_count(SystemProperty* pl) {
4413   int count = 0;
4414   while(pl != NULL) {
4415     count++;
4416     pl = pl-&gt;next();
4417   }
4418   return count;
4419 }
4420 
4421 const char* Arguments::PropertyList_get_value(SystemProperty *pl, const char* key) {
4422   assert(key != NULL, "just checking");
4423   SystemProperty* prop;
4424   for (prop = pl; prop != NULL; prop = prop-&gt;next()) {
4425     if (strcmp(key, prop-&gt;key()) == 0) return prop-&gt;value();
4426   }
4427   return NULL;
4428 }
4429 
4430 const char* Arguments::PropertyList_get_key_at(SystemProperty *pl, int index) {
4431   int count = 0;
4432   const char* ret_val = NULL;
4433 
4434   while(pl != NULL) {
4435     if(count &gt;= index) {
4436       ret_val = pl-&gt;key();
4437       break;
4438     }
4439     count++;
4440     pl = pl-&gt;next();
4441   }
4442 
4443   return ret_val;
4444 }
4445 
4446 char* Arguments::PropertyList_get_value_at(SystemProperty* pl, int index) {
4447   int count = 0;
4448   char* ret_val = NULL;
4449 
4450   while(pl != NULL) {
4451     if(count &gt;= index) {
4452       ret_val = pl-&gt;value();
4453       break;
4454     }
4455     count++;
4456     pl = pl-&gt;next();
4457   }
4458 
4459   return ret_val;
4460 }
4461 
4462 void Arguments::PropertyList_add(SystemProperty** plist, SystemProperty *new_p) {
4463   SystemProperty* p = *plist;
4464   if (p == NULL) {
4465     *plist = new_p;
4466   } else {
4467     while (p-&gt;next() != NULL) {
4468       p = p-&gt;next();
4469     }
4470     p-&gt;set_next(new_p);
4471   }
4472 }
4473 
4474 void Arguments::PropertyList_add(SystemProperty** plist, const char* k, const char* v) {
4475   if (plist == NULL)
4476     return;
4477 
4478   SystemProperty* new_p = new SystemProperty(k, v, true);
4479   PropertyList_add(plist, new_p);
4480 }
4481 
4482 void Arguments::PropertyList_add(SystemProperty *element) {
4483   PropertyList_add(&amp;_system_properties, element);
4484 }
4485 
4486 // This add maintains unique property key in the list.
4487 void Arguments::PropertyList_unique_add(SystemProperty** plist, const char* k, const char* v, jboolean append) {
4488   if (plist == NULL)
4489     return;
4490 
4491   // If property key exist then update with new value.
4492   SystemProperty* prop;
4493   for (prop = *plist; prop != NULL; prop = prop-&gt;next()) {
4494     if (strcmp(k, prop-&gt;key()) == 0) {
4495       if (append) {
4496         prop-&gt;append_value(v);
4497       } else {
4498         prop-&gt;set_writeable_value(v);
4499       }
4500       return;
4501     }
4502   }
4503 
4504   PropertyList_add(plist, k, v);
4505 }
4506 
4507 // Copies src into buf, replacing "%%" with "%" and "%p" with pid
4508 // Returns true if all of the source pointed by src has been copied over to
4509 // the destination buffer pointed by buf. Otherwise, returns false.
4510 // Notes:
4511 // 1. If the length (buflen) of the destination buffer excluding the
4512 // NULL terminator character is not long enough for holding the expanded
4513 // pid characters, it also returns false instead of returning the partially
4514 // expanded one.
4515 // 2. The passed in "buflen" should be large enough to hold the null terminator.
4516 bool Arguments::copy_expand_pid(const char* src, size_t srclen,
4517                                 char* buf, size_t buflen) {
4518   const char* p = src;
4519   char* b = buf;
4520   const char* src_end = &amp;src[srclen];
4521   char* buf_end = &amp;buf[buflen - 1];
4522 
4523   while (p &lt; src_end &amp;&amp; b &lt; buf_end) {
4524     if (*p == '%') {
4525       switch (*(++p)) {
4526       case '%':         // "%%" ==&gt; "%"
4527         *b++ = *p++;
4528         break;
4529       case 'p':  {       //  "%p" ==&gt; current process id
4530         // buf_end points to the character before the last character so
4531         // that we could write '\0' to the end of the buffer.
4532         size_t buf_sz = buf_end - b + 1;
4533         int ret = jio_snprintf(b, buf_sz, "%d", os::current_process_id());
4534 
4535         // if jio_snprintf fails or the buffer is not long enough to hold
4536         // the expanded pid, returns false.
4537         if (ret &lt; 0 || ret &gt;= (int)buf_sz) {
4538           return false;
4539         } else {
4540           b += ret;
4541           assert(*b == '\0', "fail in copy_expand_pid");
4542           if (p == src_end &amp;&amp; b == buf_end + 1) {
4543             // reach the end of the buffer.
4544             return true;
4545           }
4546         }
4547         p++;
4548         break;
4549       }
4550       default :
4551         *b++ = '%';
4552       }
4553     } else {
4554       *b++ = *p++;
4555     }
4556   }
4557   *b = '\0';
4558   return (p == src_end); // return false if not all of the source was copied
4559 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="2" type="hidden" /></form></body></html>
