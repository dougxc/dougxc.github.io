<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>hotspot Sdiff src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot </title>
</head><body id="SUNWwebrev">
<center><a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotJVMCIRuntime.java.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotReferenceMap.java.sdiff.html' target='_top'>next &gt</a></center>
<h2>src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMethodData.java</h2>
<a class="print" href="javascript:print()">Print this page</a>
<pre></pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
  29 import static jdk.vm.ci.hotspot.UnsafeAccess.UNSAFE;
  30 
  31 import java.util.Arrays;
  32 
  33 import jdk.vm.ci.hotspot.HotSpotMethodDataAccessor.Tag;
  34 import jdk.vm.ci.meta.DeoptimizationReason;
  35 import jdk.vm.ci.meta.JavaMethodProfile;
  36 import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
  37 import jdk.vm.ci.meta.JavaTypeProfile;
  38 import jdk.vm.ci.meta.JavaTypeProfile.ProfiledType;
  39 import jdk.vm.ci.meta.ResolvedJavaMethod;
  40 import jdk.vm.ci.meta.ResolvedJavaType;
  41 import jdk.vm.ci.meta.TriState;
  42 import jdk.internal.misc.Unsafe;
  43 
  44 /**
  45  * Access to a HotSpot MethodData structure (defined in methodData.hpp).
  46  */
  47 public final class HotSpotMethodData {
  48 
<span class="changed">  49     private static final HotSpotVMConfig config = config();</span>
<span class="changed">  50     private static final HotSpotMethodDataAccessor NO_DATA_NO_EXCEPTION_ACCESSOR = new NoMethodData(TriState.FALSE);</span>
<span class="changed">  51     private static final HotSpotMethodDataAccessor NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR = new NoMethodData(TriState.UNKNOWN);</span>




































  52 
  53     // sorted by tag
  54     // @formatter:off
<span class="changed">  55     private static final HotSpotMethodDataAccessor[] PROFILE_DATA_ACCESSORS = {</span>
  56         null,
  57         new BitData(),
  58         new CounterData(),
  59         new JumpData(),
  60         new ReceiverTypeData(),
  61         new VirtualCallData(),
  62         new RetData(),
  63         new BranchData(),
  64         new MultiBranchData(),
  65         new ArgInfoData(),
  66         new UnknownProfileData(Tag.CallTypeData),
  67         new VirtualCallTypeData(),
  68         new UnknownProfileData(Tag.ParametersTypeData),
  69         new UnknownProfileData(Tag.SpeculativeTrapData),
  70     };
  71     // @formatter:on
  72 
  73     /**
  74      * Reference to the C++ MethodData object.
  75      */

</pre><hr></hr><pre>
 252             }
 253         }
 254 
 255         if (hasExtraData()) {
 256             int pos = getExtraDataBeginOffset();
 257             HotSpotMethodDataAccessor data;
 258             while ((data = getExtraData(pos)) != null) {
 259                 if (pos == getExtraDataBeginOffset()) {
 260                     sb.append(nl).append("--- Extra data:");
 261                 }
 262                 int bci = data.getBCI(this, pos);
 263                 sb.append(String.format("%n%-6d bci: %-6d%-20s", pos, bci, data.getClass().getSimpleName()));
 264                 sb.append(data.appendTo(new StringBuilder(), this, pos).toString().replace(nl, nlIndent));
 265                 pos = pos + data.getSize(this, pos);
 266             }
 267 
 268         }
 269         return sb.toString();
 270     }
 271 
<span class="removed"> 272     private abstract static class AbstractMethodData implements HotSpotMethodDataAccessor {</span>
<span class="removed"> 273 </span>
 274         /**
 275          * Corresponds to {@code exception_seen_flag}.
 276          */
<span class="changed"> 277         private static final int EXCEPTIONS_MASK = 1 &lt;&lt; config.bitDataExceptionSeenFlag;</span>



 278 
 279         private final Tag tag;
 280         protected final int staticSize;
 281 
 282         protected AbstractMethodData(Tag tag, int staticSize) {
 283             this.tag = tag;
 284             this.staticSize = staticSize;
 285         }
 286 
 287         public Tag getTag() {
 288             return tag;
 289         }
 290 
 291         public static Tag readTag(HotSpotMethodData data, int position) {
 292             final int tag = data.readUnsignedByte(position, config.dataLayoutTagOffset);
 293             return Tag.getEnum(tag);
 294         }
 295 
 296         @Override
 297         public int getBCI(HotSpotMethodData data, int position) {

</pre><hr></hr><pre>
 340         @Override
 341         public TriState getNullSeen(HotSpotMethodData data, int position) {
 342             return TriState.UNKNOWN;
 343         }
 344 
 345         protected int getFlags(HotSpotMethodData data, int position) {
 346             return data.readUnsignedByte(position, config.dataLayoutFlagsOffset);
 347         }
 348 
 349         /**
 350          * @param data
 351          * @param position
 352          */
 353         protected int getDynamicSize(HotSpotMethodData data, int position) {
 354             return 0;
 355         }
 356 
 357         public abstract StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos);
 358     }
 359 
<span class="changed"> 360     private static class NoMethodData extends AbstractMethodData {</span>
<span class="changed"> 361 </span>
<span class="changed"> 362         private static final int NO_DATA_SIZE = cellIndexToOffset(0);</span>
 363 
 364         private final TriState exceptionSeen;
 365 
 366         protected NoMethodData(TriState exceptionSeen) {
 367             super(Tag.No, NO_DATA_SIZE);
 368             this.exceptionSeen = exceptionSeen;
 369         }
 370 
 371         @Override
 372         public int getBCI(HotSpotMethodData data, int position) {
 373             return -1;
 374         }
 375 
 376         @Override
 377         public TriState getExceptionSeen(HotSpotMethodData data, int position) {
 378             return exceptionSeen;
 379         }
 380 
 381         @Override
 382         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 383             return sb;
 384         }
 385     }
 386 
<span class="changed"> 387     private static class BitData extends AbstractMethodData {</span>
<span class="changed"> 388 </span>
<span class="changed"> 389         private static final int BIT_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="changed"> 390         private static final int BIT_DATA_NULL_SEEN_FLAG = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
 391 
 392         private BitData() {
 393             super(Tag.BitData, BIT_DATA_SIZE);
 394         }
 395 
 396         protected BitData(Tag tag, int staticSize) {
 397             super(tag, staticSize);
 398         }
 399 
 400         @Override
 401         public TriState getNullSeen(HotSpotMethodData data, int position) {
 402             return TriState.get((getFlags(data, position) &amp; BIT_DATA_NULL_SEEN_FLAG) != 0);
 403         }
 404 
 405         @Override
 406         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 407             return sb.append(format("exception_seen(%s)", getExceptionSeen(data, pos)));
 408         }
 409     }
 410 
<span class="changed"> 411     private static class CounterData extends BitData {</span>
<span class="changed"> 412 </span>
<span class="changed"> 413         private static final int COUNTER_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="changed"> 414         private static final int COUNTER_DATA_COUNT_OFFSET = cellIndexToOffset(config.methodDataCountOffset);</span>
 415 
 416         CounterData() {
 417             super(Tag.CounterData, COUNTER_DATA_SIZE);
 418         }
 419 
 420         protected CounterData(Tag tag, int staticSize) {
 421             super(tag, staticSize);
 422         }
 423 
 424         @Override
 425         public int getExecutionCount(HotSpotMethodData data, int position) {
 426             return getCounterValue(data, position);
 427         }
 428 
 429         protected int getCounterValue(HotSpotMethodData data, int position) {
 430             return data.readUnsignedIntAsSignedInt(position, COUNTER_DATA_COUNT_OFFSET);
 431         }
 432 
 433         @Override
 434         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 435             return sb.append(format("count(%d) null_seen(%s) exception_seen(%s)", getCounterValue(data, pos), getNullSeen(data, pos), getExceptionSeen(data, pos)));
 436         }
 437     }
 438 
<span class="changed"> 439     private static class JumpData extends AbstractMethodData {</span>
<span class="changed"> 440 </span>
<span class="changed"> 441         private static final int JUMP_DATA_SIZE = cellIndexToOffset(2);</span>
<span class="changed"> 442         protected static final int TAKEN_COUNT_OFFSET = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="changed"> 443         protected static final int TAKEN_DISPLACEMENT_OFFSET = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
 444 
 445         JumpData() {
 446             super(Tag.JumpData, JUMP_DATA_SIZE);
 447         }
 448 
 449         protected JumpData(Tag tag, int staticSize) {
 450             super(tag, staticSize);
 451         }
 452 
 453         @Override
 454         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
 455             return getExecutionCount(data, position) != 0 ? 1 : 0;
 456         }
 457 
 458         @Override
 459         public int getExecutionCount(HotSpotMethodData data, int position) {
 460             return data.readUnsignedIntAsSignedInt(position, TAKEN_COUNT_OFFSET);
 461         }
 462 
 463         public int getTakenDisplacement(HotSpotMethodData data, int position) {

</pre><hr></hr><pre>
 467         @Override
 468         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 469             return sb.append(format("taken(%d) displacement(%d)", getExecutionCount(data, pos), getTakenDisplacement(data, pos)));
 470         }
 471     }
 472 
 473     static class RawItemProfile&lt;T&gt; {
 474         final int entries;
 475         final T[] items;
 476         final long[] counts;
 477         final long totalCount;
 478 
 479         RawItemProfile(int entries, T[] items, long[] counts, long totalCount) {
 480             this.entries = entries;
 481             this.items = items;
 482             this.counts = counts;
 483             this.totalCount = totalCount;
 484         }
 485     }
 486 
<span class="changed"> 487     private abstract static class AbstractTypeData extends CounterData {</span>
<span class="changed"> 488 </span>
<span class="changed"> 489         protected static final int TYPE_DATA_ROW_SIZE = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
<span class="changed"> 490 </span>
<span class="changed"> 491         protected static final int NONPROFILED_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="changed"> 492         protected static final int TYPE_DATA_FIRST_TYPE_OFFSET = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="changed"> 493         protected static final int TYPE_DATA_FIRST_TYPE_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
 494 
 495         protected AbstractTypeData(Tag tag, int staticSize) {
 496             super(tag, staticSize);
 497         }
 498 
 499         @Override
 500         public JavaTypeProfile getTypeProfile(HotSpotMethodData data, int position) {
 501             return createTypeProfile(getNullSeen(data, position), getRawTypeProfile(data, position));
 502         }
 503 
 504         private RawItemProfile&lt;ResolvedJavaType&gt; getRawTypeProfile(HotSpotMethodData data, int position) {
 505             int typeProfileWidth = config.typeProfileWidth;
 506 
 507             ResolvedJavaType[] types = new ResolvedJavaType[typeProfileWidth];
 508             long[] counts = new long[typeProfileWidth];
 509             long totalCount = 0;
 510             int entries = 0;
 511 
 512             outer: for (int i = 0; i &lt; typeProfileWidth; i++) {
 513                 HotSpotResolvedObjectTypeImpl receiverKlass = data.readKlass(position, getTypeOffset(i));

</pre><hr></hr><pre>
 566 
 567         protected static int getTypeCountOffset(int row) {
 568             return TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;
 569         }
 570 
 571         @Override
 572         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 573             RawItemProfile&lt;ResolvedJavaType&gt; profile = getRawTypeProfile(data, pos);
 574             TriState nullSeen = getNullSeen(data, pos);
 575             TriState exceptionSeen = getExceptionSeen(data, pos);
 576             sb.append(format("count(%d) null_seen(%s) exception_seen(%s) nonprofiled_count(%d) entries(%d)", getCounterValue(data, pos), nullSeen, exceptionSeen,
 577                             getTypesNotRecordedExecutionCount(data, pos), profile.entries));
 578             for (int i = 0; i &lt; profile.entries; i++) {
 579                 long count = profile.counts[i];
 580                 sb.append(format("%n  %s (%d, %4.2f)", profile.items[i].toJavaName(), count, (double) count / profile.totalCount));
 581             }
 582             return sb;
 583         }
 584     }
 585 
<span class="changed"> 586     private static class ReceiverTypeData extends AbstractTypeData {</span>
<span class="changed"> 587 </span>
<span class="changed"> 588         private static final int TYPE_CHECK_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
 589 
 590         ReceiverTypeData() {
 591             super(Tag.ReceiverTypeData, TYPE_CHECK_DATA_SIZE);
 592         }
 593 
 594         protected ReceiverTypeData(Tag tag, int staticSize) {
 595             super(tag, staticSize);
 596         }
 597 
 598         @Override
 599         public int getExecutionCount(HotSpotMethodData data, int position) {
 600             return -1;
 601         }
 602 
 603         @Override
 604         protected long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position) {
 605             return data.readUnsignedIntAsSignedInt(position, NONPROFILED_COUNT_OFFSET);
 606         }
 607     }
 608 
<span class="changed"> 609     private static class VirtualCallData extends ReceiverTypeData {</span>
<span class="changed"> 610 </span>
<span class="changed"> 611         private static final int VIRTUAL_CALL_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="changed"> 612         private static final int VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET = TYPE_DATA_FIRST_TYPE_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="changed"> 613         private static final int VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET = TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
 614 
 615         VirtualCallData() {
 616             super(Tag.VirtualCallData, VIRTUAL_CALL_DATA_SIZE);
 617         }
 618 
 619         protected VirtualCallData(Tag tag, int staticSize) {
 620             super(tag, staticSize);
 621         }
 622 
 623         @Override
 624         public int getExecutionCount(HotSpotMethodData data, int position) {
 625             final int typeProfileWidth = config.typeProfileWidth;
 626 
 627             long total = 0;
 628             for (int i = 0; i &lt; typeProfileWidth; i++) {
 629                 total += data.readUnsignedInt(position, getTypeCountOffset(i));
 630             }
 631 
 632             total += getCounterValue(data, position);
 633             return truncateLongToInt(total);

</pre><hr></hr><pre>
 695         private static int getMethodOffset(int row) {
 696             return VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET + row * TYPE_DATA_ROW_SIZE;
 697         }
 698 
 699         private static int getMethodCountOffset(int row) {
 700             return VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;
 701         }
 702 
 703         @Override
 704         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 705             RawItemProfile&lt;ResolvedJavaMethod&gt; profile = getRawMethodProfile(data, pos);
 706             super.appendTo(sb.append(format("exception_seen(%s) ", getExceptionSeen(data, pos))), data, pos).append(format("%nmethod_entries(%d)", profile.entries));
 707             for (int i = 0; i &lt; profile.entries; i++) {
 708                 long count = profile.counts[i];
 709                 sb.append(format("%n  %s (%d, %4.2f)", profile.items[i].format("%H.%n(%p)"), count, (double) count / profile.totalCount));
 710             }
 711             return sb;
 712         }
 713     }
 714 
<span class="changed"> 715     private static class VirtualCallTypeData extends VirtualCallData {</span>
 716 
 717         VirtualCallTypeData() {
 718             super(Tag.VirtualCallTypeData, 0);
 719         }
 720 
 721         @Override
 722         protected int getDynamicSize(HotSpotMethodData data, int position) {
 723             assert staticSize == 0;
 724             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
 725         }
 726     }
 727 
<span class="changed"> 728     private static class RetData extends CounterData {</span>
<span class="changed"> 729 </span>
<span class="changed"> 730         private static final int RET_DATA_ROW_SIZE = cellsToBytes(3);</span>
<span class="changed"> 731         private static final int RET_DATA_SIZE = cellIndexToOffset(1) + RET_DATA_ROW_SIZE * config.bciProfileWidth;</span>
 732 
 733         RetData() {
 734             super(Tag.RetData, RET_DATA_SIZE);
 735         }
 736     }
 737 
<span class="changed"> 738     private static class BranchData extends JumpData {</span>
<span class="changed"> 739 </span>
<span class="changed"> 740         private static final int BRANCH_DATA_SIZE = cellIndexToOffset(3);</span>
<span class="changed"> 741         private static final int NOT_TAKEN_COUNT_OFFSET = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
 742 
 743         BranchData() {
 744             super(Tag.BranchData, BRANCH_DATA_SIZE);
 745         }
 746 
 747         @Override
 748         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
 749             long takenCount = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET);
 750             long notTakenCount = data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);
 751             long total = takenCount + notTakenCount;
 752 
 753             return total &lt;= 0 ? -1 : takenCount / (double) total;
 754         }
 755 
 756         @Override
 757         public int getExecutionCount(HotSpotMethodData data, int position) {
 758             long count = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET) + data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);
 759             return truncateLongToInt(count);
 760         }
 761 
 762         @Override
 763         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 764             long taken = data.readUnsignedInt(pos, TAKEN_COUNT_OFFSET);
 765             long notTaken = data.readUnsignedInt(pos, NOT_TAKEN_COUNT_OFFSET);
 766             double takenProbability = getBranchTakenProbability(data, pos);
 767             return sb.append(format("taken(%d, %4.2f) not_taken(%d, %4.2f) displacement(%d)", taken, takenProbability, notTaken, 1.0D - takenProbability, getTakenDisplacement(data, pos)));
 768         }
 769     }
 770 
<span class="changed"> 771     private static class ArrayData extends AbstractMethodData {</span>
<span class="changed"> 772 </span>
<span class="changed"> 773         private static final int ARRAY_DATA_LENGTH_OFFSET = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="changed"> 774         protected static final int ARRAY_DATA_START_OFFSET = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
 775 
 776         ArrayData(Tag tag, int staticSize) {
 777             super(tag, staticSize);
 778         }
 779 
 780         @Override
 781         protected int getDynamicSize(HotSpotMethodData data, int position) {
 782             return cellsToBytes(getLength(data, position));
 783         }
 784 
 785         protected static int getLength(HotSpotMethodData data, int position) {
 786             return data.readInt(position, ARRAY_DATA_LENGTH_OFFSET);
 787         }
 788 
 789         @Override
 790         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 791             return sb.append(format("length(%d)", getLength(data, pos)));
 792         }
 793     }
 794 
<span class="changed"> 795     private static class MultiBranchData extends ArrayData {</span>
<span class="changed"> 796 </span>
<span class="changed"> 797         private static final int MULTI_BRANCH_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="changed"> 798         private static final int MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS = config.multiBranchDataPerCaseCellCount;</span>
<span class="changed"> 799         private static final int MULTI_BRANCH_DATA_ROW_SIZE = cellsToBytes(MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS);</span>
<span class="changed"> 800         private static final int MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(0);</span>
<span class="changed"> 801         private static final int MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(1);</span>
 802 
 803         MultiBranchData() {
 804             super(Tag.MultiBranchData, MULTI_BRANCH_DATA_SIZE);
 805         }
 806 
 807         @Override
 808         public double[] getSwitchProbabilities(HotSpotMethodData data, int position) {
 809             int arrayLength = getLength(data, position);
 810             assert arrayLength &gt; 0 : "switch must have at least the default case";
 811             assert arrayLength % MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS == 0 : "array must have full rows";
 812 
 813             int length = arrayLength / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;
 814             long totalCount = 0;
 815             double[] result = new double[length];
 816 
 817             // default case is first in HotSpot but last for the compiler
 818             long count = readCount(data, position, 0);
 819             totalCount += count;
 820             result[length - 1] = count;
 821 

</pre><hr></hr><pre>
 861 
 862         private static int getCountOffset(int index) {
 863             return MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;
 864         }
 865 
 866         private static int getDisplacementOffset(int index) {
 867             return MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;
 868         }
 869 
 870         @Override
 871         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 872             int entries = getLength(data, pos) / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;
 873             sb.append(format("entries(%d)", entries));
 874             for (int i = 0; i &lt; entries; i++) {
 875                 sb.append(format("%n  %d: count(%d) displacement(%d)", i, data.readUnsignedInt(pos, getCountOffset(i)), data.readUnsignedInt(pos, getDisplacementOffset(i))));
 876             }
 877             return sb;
 878         }
 879     }
 880 
<span class="changed"> 881     private static class ArgInfoData extends ArrayData {</span>
<span class="changed"> 882 </span>
<span class="changed"> 883         private static final int ARG_INFO_DATA_SIZE = cellIndexToOffset(1);</span>
 884 
 885         ArgInfoData() {
 886             super(Tag.ArgInfoData, ARG_INFO_DATA_SIZE);
 887         }
 888     }
 889 
<span class="changed"> 890     private static class UnknownProfileData extends AbstractMethodData {</span>
 891         UnknownProfileData(Tag tag) {
 892             super(tag, 0);
 893         }
 894 
 895         @Override
 896         protected int getDynamicSize(HotSpotMethodData data, int position) {
 897             assert staticSize == 0;
 898             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
 899         }
 900 
 901         @Override
 902         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 903             // TODO Auto-generated method stub
 904             return null;
 905         }
 906     }
 907 
 908     public void setCompiledIRSize(int size) {
 909         UNSAFE.putInt(metaspaceMethodData + config.methodDataIRSizeOffset, size);
 910     }
</pre></td><td><pre>

</pre><hr></hr><pre>
  29 import static jdk.vm.ci.hotspot.UnsafeAccess.UNSAFE;
  30 
  31 import java.util.Arrays;
  32 
  33 import jdk.vm.ci.hotspot.HotSpotMethodDataAccessor.Tag;
  34 import jdk.vm.ci.meta.DeoptimizationReason;
  35 import jdk.vm.ci.meta.JavaMethodProfile;
  36 import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
  37 import jdk.vm.ci.meta.JavaTypeProfile;
  38 import jdk.vm.ci.meta.JavaTypeProfile.ProfiledType;
  39 import jdk.vm.ci.meta.ResolvedJavaMethod;
  40 import jdk.vm.ci.meta.ResolvedJavaType;
  41 import jdk.vm.ci.meta.TriState;
  42 import jdk.internal.misc.Unsafe;
  43 
  44 /**
  45  * Access to a HotSpot MethodData structure (defined in methodData.hpp).
  46  */
  47 public final class HotSpotMethodData {
  48 
<span class="changed">  49     static final HotSpotVMConfig config = config();</span>
<span class="changed">  50     static final HotSpotMethodDataAccessor NO_DATA_NO_EXCEPTION_ACCESSOR = new NoMethodData(TriState.FALSE);</span>
<span class="changed">  51     static final HotSpotMethodDataAccessor NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR = new NoMethodData(TriState.UNKNOWN);</span>
<span class="changed">  52 </span>
<span class="changed">  53     static final int BIT_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="changed">  54     static final int BIT_DATA_NULL_SEEN_FLAG = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
<span class="changed">  55 </span>
<span class="changed">  56     static final int BRANCH_DATA_SIZE = cellIndexToOffset(3);</span>
<span class="changed">  57     static final int NOT_TAKEN_COUNT_OFFSET = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
<span class="changed">  58 </span>
<span class="changed">  59     static final int ARG_INFO_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="changed">  60 </span>
<span class="changed">  61     static final int COUNTER_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="changed">  62     static final int COUNTER_DATA_COUNT_OFFSET = cellIndexToOffset(config.methodDataCountOffset);</span>
<span class="changed">  63     static final int JUMP_DATA_SIZE = cellIndexToOffset(2);</span>
<span class="changed">  64     static final int TAKEN_COUNT_OFFSET = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="changed">  65     static final int TAKEN_DISPLACEMENT_OFFSET = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
<span class="changed">  66     static final int TYPE_DATA_ROW_SIZE = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
<span class="changed">  67 </span>
<span class="changed">  68     static final int NONPROFILED_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="changed">  69     static final int TYPE_DATA_FIRST_TYPE_OFFSET = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="changed">  70     static final int TYPE_DATA_FIRST_TYPE_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
<span class="changed">  71     static final int VIRTUAL_CALL_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="changed">  72     static final int VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET = TYPE_DATA_FIRST_TYPE_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="changed">  73     static final int VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET = TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="changed">  74 </span>
<span class="changed">  75     static final int ARRAY_DATA_LENGTH_OFFSET = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="changed">  76     static final int ARRAY_DATA_START_OFFSET = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
<span class="changed">  77 </span>
<span class="changed">  78     static final int TYPE_CHECK_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="changed">  79 </span>
<span class="changed">  80     static final int RET_DATA_ROW_SIZE = cellsToBytes(3);</span>
<span class="changed">  81     static final int RET_DATA_SIZE = cellIndexToOffset(1) + RET_DATA_ROW_SIZE * config.bciProfileWidth;</span>
<span class="changed">  82 </span>
<span class="changed">  83     static final int MULTI_BRANCH_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="changed">  84     static final int MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS = config.multiBranchDataPerCaseCellCount;</span>
<span class="changed">  85     static final int MULTI_BRANCH_DATA_ROW_SIZE = cellsToBytes(MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS);</span>
<span class="changed">  86     static final int MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(0);</span>
<span class="changed">  87     static final int MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(1);</span>
  88 
  89     // sorted by tag
  90     // @formatter:off
<span class="changed">  91     static final HotSpotMethodDataAccessor[] PROFILE_DATA_ACCESSORS = {</span>
  92         null,
  93         new BitData(),
  94         new CounterData(),
  95         new JumpData(),
  96         new ReceiverTypeData(),
  97         new VirtualCallData(),
  98         new RetData(),
  99         new BranchData(),
 100         new MultiBranchData(),
 101         new ArgInfoData(),
 102         new UnknownProfileData(Tag.CallTypeData),
 103         new VirtualCallTypeData(),
 104         new UnknownProfileData(Tag.ParametersTypeData),
 105         new UnknownProfileData(Tag.SpeculativeTrapData),
 106     };
 107     // @formatter:on
 108 
 109     /**
 110      * Reference to the C++ MethodData object.
 111      */

</pre><hr></hr><pre>
 288             }
 289         }
 290 
 291         if (hasExtraData()) {
 292             int pos = getExtraDataBeginOffset();
 293             HotSpotMethodDataAccessor data;
 294             while ((data = getExtraData(pos)) != null) {
 295                 if (pos == getExtraDataBeginOffset()) {
 296                     sb.append(nl).append("--- Extra data:");
 297                 }
 298                 int bci = data.getBCI(this, pos);
 299                 sb.append(String.format("%n%-6d bci: %-6d%-20s", pos, bci, data.getClass().getSimpleName()));
 300                 sb.append(data.appendTo(new StringBuilder(), this, pos).toString().replace(nl, nlIndent));
 301                 pos = pos + data.getSize(this, pos);
 302             }
 303 
 304         }
 305         return sb.toString();
 306     }
 307 


 308     /**
 309      * Corresponds to {@code exception_seen_flag}.
 310      */
<span class="changed"> 311     static final int EXCEPTIONS_MASK = 1 &lt;&lt; config.bitDataExceptionSeenFlag;</span>
<span class="changed"> 312     static final int NO_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="changed"> 313 </span>
<span class="changed"> 314     private abstract static class AbstractMethodData implements HotSpotMethodDataAccessor {</span>
 315 
 316         private final Tag tag;
 317         protected final int staticSize;
 318 
 319         protected AbstractMethodData(Tag tag, int staticSize) {
 320             this.tag = tag;
 321             this.staticSize = staticSize;
 322         }
 323 
 324         public Tag getTag() {
 325             return tag;
 326         }
 327 
 328         public static Tag readTag(HotSpotMethodData data, int position) {
 329             final int tag = data.readUnsignedByte(position, config.dataLayoutTagOffset);
 330             return Tag.getEnum(tag);
 331         }
 332 
 333         @Override
 334         public int getBCI(HotSpotMethodData data, int position) {

</pre><hr></hr><pre>
 377         @Override
 378         public TriState getNullSeen(HotSpotMethodData data, int position) {
 379             return TriState.UNKNOWN;
 380         }
 381 
 382         protected int getFlags(HotSpotMethodData data, int position) {
 383             return data.readUnsignedByte(position, config.dataLayoutFlagsOffset);
 384         }
 385 
 386         /**
 387          * @param data
 388          * @param position
 389          */
 390         protected int getDynamicSize(HotSpotMethodData data, int position) {
 391             return 0;
 392         }
 393 
 394         public abstract StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos);
 395     }
 396 
<span class="changed"> 397     static class NoMethodData extends AbstractMethodData {</span>


 398 
 399         private final TriState exceptionSeen;
 400 
 401         protected NoMethodData(TriState exceptionSeen) {
 402             super(Tag.No, NO_DATA_SIZE);
 403             this.exceptionSeen = exceptionSeen;
 404         }
 405 
 406         @Override
 407         public int getBCI(HotSpotMethodData data, int position) {
 408             return -1;
 409         }
 410 
 411         @Override
 412         public TriState getExceptionSeen(HotSpotMethodData data, int position) {
 413             return exceptionSeen;
 414         }
 415 
 416         @Override
 417         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 418             return sb;
 419         }
 420     }
 421 
<span class="changed"> 422     static class BitData extends AbstractMethodData {</span>



 423 
 424         private BitData() {
 425             super(Tag.BitData, BIT_DATA_SIZE);
 426         }
 427 
 428         protected BitData(Tag tag, int staticSize) {
 429             super(tag, staticSize);
 430         }
 431 
 432         @Override
 433         public TriState getNullSeen(HotSpotMethodData data, int position) {
 434             return TriState.get((getFlags(data, position) &amp; BIT_DATA_NULL_SEEN_FLAG) != 0);
 435         }
 436 
 437         @Override
 438         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 439             return sb.append(format("exception_seen(%s)", getExceptionSeen(data, pos)));
 440         }
 441     }
 442 
<span class="changed"> 443     static class CounterData extends BitData {</span>



 444 
 445         CounterData() {
 446             super(Tag.CounterData, COUNTER_DATA_SIZE);
 447         }
 448 
 449         protected CounterData(Tag tag, int staticSize) {
 450             super(tag, staticSize);
 451         }
 452 
 453         @Override
 454         public int getExecutionCount(HotSpotMethodData data, int position) {
 455             return getCounterValue(data, position);
 456         }
 457 
 458         protected int getCounterValue(HotSpotMethodData data, int position) {
 459             return data.readUnsignedIntAsSignedInt(position, COUNTER_DATA_COUNT_OFFSET);
 460         }
 461 
 462         @Override
 463         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 464             return sb.append(format("count(%d) null_seen(%s) exception_seen(%s)", getCounterValue(data, pos), getNullSeen(data, pos), getExceptionSeen(data, pos)));
 465         }
 466     }
 467 
<span class="changed"> 468     static class JumpData extends AbstractMethodData {</span>




 469 
 470         JumpData() {
 471             super(Tag.JumpData, JUMP_DATA_SIZE);
 472         }
 473 
 474         protected JumpData(Tag tag, int staticSize) {
 475             super(tag, staticSize);
 476         }
 477 
 478         @Override
 479         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
 480             return getExecutionCount(data, position) != 0 ? 1 : 0;
 481         }
 482 
 483         @Override
 484         public int getExecutionCount(HotSpotMethodData data, int position) {
 485             return data.readUnsignedIntAsSignedInt(position, TAKEN_COUNT_OFFSET);
 486         }
 487 
 488         public int getTakenDisplacement(HotSpotMethodData data, int position) {

</pre><hr></hr><pre>
 492         @Override
 493         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 494             return sb.append(format("taken(%d) displacement(%d)", getExecutionCount(data, pos), getTakenDisplacement(data, pos)));
 495         }
 496     }
 497 
 498     static class RawItemProfile&lt;T&gt; {
 499         final int entries;
 500         final T[] items;
 501         final long[] counts;
 502         final long totalCount;
 503 
 504         RawItemProfile(int entries, T[] items, long[] counts, long totalCount) {
 505             this.entries = entries;
 506             this.items = items;
 507             this.counts = counts;
 508             this.totalCount = totalCount;
 509         }
 510     }
 511 
<span class="changed"> 512     abstract static class AbstractTypeData extends CounterData {</span>






 513 
 514         protected AbstractTypeData(Tag tag, int staticSize) {
 515             super(tag, staticSize);
 516         }
 517 
 518         @Override
 519         public JavaTypeProfile getTypeProfile(HotSpotMethodData data, int position) {
 520             return createTypeProfile(getNullSeen(data, position), getRawTypeProfile(data, position));
 521         }
 522 
 523         private RawItemProfile&lt;ResolvedJavaType&gt; getRawTypeProfile(HotSpotMethodData data, int position) {
 524             int typeProfileWidth = config.typeProfileWidth;
 525 
 526             ResolvedJavaType[] types = new ResolvedJavaType[typeProfileWidth];
 527             long[] counts = new long[typeProfileWidth];
 528             long totalCount = 0;
 529             int entries = 0;
 530 
 531             outer: for (int i = 0; i &lt; typeProfileWidth; i++) {
 532                 HotSpotResolvedObjectTypeImpl receiverKlass = data.readKlass(position, getTypeOffset(i));

</pre><hr></hr><pre>
 585 
 586         protected static int getTypeCountOffset(int row) {
 587             return TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;
 588         }
 589 
 590         @Override
 591         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 592             RawItemProfile&lt;ResolvedJavaType&gt; profile = getRawTypeProfile(data, pos);
 593             TriState nullSeen = getNullSeen(data, pos);
 594             TriState exceptionSeen = getExceptionSeen(data, pos);
 595             sb.append(format("count(%d) null_seen(%s) exception_seen(%s) nonprofiled_count(%d) entries(%d)", getCounterValue(data, pos), nullSeen, exceptionSeen,
 596                             getTypesNotRecordedExecutionCount(data, pos), profile.entries));
 597             for (int i = 0; i &lt; profile.entries; i++) {
 598                 long count = profile.counts[i];
 599                 sb.append(format("%n  %s (%d, %4.2f)", profile.items[i].toJavaName(), count, (double) count / profile.totalCount));
 600             }
 601             return sb;
 602         }
 603     }
 604 
<span class="changed"> 605     static class ReceiverTypeData extends AbstractTypeData {</span>


 606 
 607         ReceiverTypeData() {
 608             super(Tag.ReceiverTypeData, TYPE_CHECK_DATA_SIZE);
 609         }
 610 
 611         protected ReceiverTypeData(Tag tag, int staticSize) {
 612             super(tag, staticSize);
 613         }
 614 
 615         @Override
 616         public int getExecutionCount(HotSpotMethodData data, int position) {
 617             return -1;
 618         }
 619 
 620         @Override
 621         protected long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position) {
 622             return data.readUnsignedIntAsSignedInt(position, NONPROFILED_COUNT_OFFSET);
 623         }
 624     }
 625 
<span class="changed"> 626     static class VirtualCallData extends ReceiverTypeData {</span>




 627 
 628         VirtualCallData() {
 629             super(Tag.VirtualCallData, VIRTUAL_CALL_DATA_SIZE);
 630         }
 631 
 632         protected VirtualCallData(Tag tag, int staticSize) {
 633             super(tag, staticSize);
 634         }
 635 
 636         @Override
 637         public int getExecutionCount(HotSpotMethodData data, int position) {
 638             final int typeProfileWidth = config.typeProfileWidth;
 639 
 640             long total = 0;
 641             for (int i = 0; i &lt; typeProfileWidth; i++) {
 642                 total += data.readUnsignedInt(position, getTypeCountOffset(i));
 643             }
 644 
 645             total += getCounterValue(data, position);
 646             return truncateLongToInt(total);

</pre><hr></hr><pre>
 708         private static int getMethodOffset(int row) {
 709             return VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET + row * TYPE_DATA_ROW_SIZE;
 710         }
 711 
 712         private static int getMethodCountOffset(int row) {
 713             return VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;
 714         }
 715 
 716         @Override
 717         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 718             RawItemProfile&lt;ResolvedJavaMethod&gt; profile = getRawMethodProfile(data, pos);
 719             super.appendTo(sb.append(format("exception_seen(%s) ", getExceptionSeen(data, pos))), data, pos).append(format("%nmethod_entries(%d)", profile.entries));
 720             for (int i = 0; i &lt; profile.entries; i++) {
 721                 long count = profile.counts[i];
 722                 sb.append(format("%n  %s (%d, %4.2f)", profile.items[i].format("%H.%n(%p)"), count, (double) count / profile.totalCount));
 723             }
 724             return sb;
 725         }
 726     }
 727 
<span class="changed"> 728     static class VirtualCallTypeData extends VirtualCallData {</span>
 729 
 730         VirtualCallTypeData() {
 731             super(Tag.VirtualCallTypeData, 0);
 732         }
 733 
 734         @Override
 735         protected int getDynamicSize(HotSpotMethodData data, int position) {
 736             assert staticSize == 0;
 737             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
 738         }
 739     }
 740 
<span class="changed"> 741     static class RetData extends CounterData {</span>



 742 
 743         RetData() {
 744             super(Tag.RetData, RET_DATA_SIZE);
 745         }
 746     }
 747 
<span class="changed"> 748     static class BranchData extends JumpData {</span>



 749 
 750         BranchData() {
 751             super(Tag.BranchData, BRANCH_DATA_SIZE);
 752         }
 753 
 754         @Override
 755         public double getBranchTakenProbability(HotSpotMethodData data, int position) {
 756             long takenCount = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET);
 757             long notTakenCount = data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);
 758             long total = takenCount + notTakenCount;
 759 
 760             return total &lt;= 0 ? -1 : takenCount / (double) total;
 761         }
 762 
 763         @Override
 764         public int getExecutionCount(HotSpotMethodData data, int position) {
 765             long count = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET) + data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);
 766             return truncateLongToInt(count);
 767         }
 768 
 769         @Override
 770         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 771             long taken = data.readUnsignedInt(pos, TAKEN_COUNT_OFFSET);
 772             long notTaken = data.readUnsignedInt(pos, NOT_TAKEN_COUNT_OFFSET);
 773             double takenProbability = getBranchTakenProbability(data, pos);
 774             return sb.append(format("taken(%d, %4.2f) not_taken(%d, %4.2f) displacement(%d)", taken, takenProbability, notTaken, 1.0D - takenProbability, getTakenDisplacement(data, pos)));
 775         }
 776     }
 777 
<span class="changed"> 778     static class ArrayData extends AbstractMethodData {</span>



 779 
 780         ArrayData(Tag tag, int staticSize) {
 781             super(tag, staticSize);
 782         }
 783 
 784         @Override
 785         protected int getDynamicSize(HotSpotMethodData data, int position) {
 786             return cellsToBytes(getLength(data, position));
 787         }
 788 
 789         protected static int getLength(HotSpotMethodData data, int position) {
 790             return data.readInt(position, ARRAY_DATA_LENGTH_OFFSET);
 791         }
 792 
 793         @Override
 794         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 795             return sb.append(format("length(%d)", getLength(data, pos)));
 796         }
 797     }
 798 
<span class="changed"> 799     static class MultiBranchData extends ArrayData {</span>






 800 
 801         MultiBranchData() {
 802             super(Tag.MultiBranchData, MULTI_BRANCH_DATA_SIZE);
 803         }
 804 
 805         @Override
 806         public double[] getSwitchProbabilities(HotSpotMethodData data, int position) {
 807             int arrayLength = getLength(data, position);
 808             assert arrayLength &gt; 0 : "switch must have at least the default case";
 809             assert arrayLength % MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS == 0 : "array must have full rows";
 810 
 811             int length = arrayLength / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;
 812             long totalCount = 0;
 813             double[] result = new double[length];
 814 
 815             // default case is first in HotSpot but last for the compiler
 816             long count = readCount(data, position, 0);
 817             totalCount += count;
 818             result[length - 1] = count;
 819 

</pre><hr></hr><pre>
 859 
 860         private static int getCountOffset(int index) {
 861             return MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;
 862         }
 863 
 864         private static int getDisplacementOffset(int index) {
 865             return MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;
 866         }
 867 
 868         @Override
 869         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 870             int entries = getLength(data, pos) / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;
 871             sb.append(format("entries(%d)", entries));
 872             for (int i = 0; i &lt; entries; i++) {
 873                 sb.append(format("%n  %d: count(%d) displacement(%d)", i, data.readUnsignedInt(pos, getCountOffset(i)), data.readUnsignedInt(pos, getDisplacementOffset(i))));
 874             }
 875             return sb;
 876         }
 877     }
 878 
<span class="changed"> 879     static class ArgInfoData extends ArrayData {</span>


 880 
 881         ArgInfoData() {
 882             super(Tag.ArgInfoData, ARG_INFO_DATA_SIZE);
 883         }
 884     }
 885 
<span class="changed"> 886     static class UnknownProfileData extends AbstractMethodData {</span>
 887         UnknownProfileData(Tag tag) {
 888             super(tag, 0);
 889         }
 890 
 891         @Override
 892         protected int getDynamicSize(HotSpotMethodData data, int position) {
 893             assert staticSize == 0;
 894             return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
 895         }
 896 
 897         @Override
 898         public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
 899             // TODO Auto-generated method stub
 900             return null;
 901         }
 902     }
 903 
 904     public void setCompiledIRSize(int size) {
 905         UNSAFE.putInt(metaspaceMethodData + config.methodDataIRSizeOffset, size);
 906     }
</pre></td>
</tr></table>
<center><a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotJVMCIRuntime.java.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../../../../../src/jdk.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotReferenceMap.java.sdiff.html' target='_top'>next &gt</a></center>
</body></html>
