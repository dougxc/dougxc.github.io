<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/utilities/globalDefinitions.hpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_VM_UTILITIES_GLOBALDEFINITIONS_HPP
  26 #define SHARE_VM_UTILITIES_GLOBALDEFINITIONS_HPP
  27 
  28 #ifndef __STDC_FORMAT_MACROS
  29 #define __STDC_FORMAT_MACROS
  30 #endif
  31 
  32 #ifdef TARGET_COMPILER_gcc
  33 # include "utilities/globalDefinitions_gcc.hpp"
  34 #endif
  35 #ifdef TARGET_COMPILER_visCPP
  36 # include "utilities/globalDefinitions_visCPP.hpp"
  37 #endif
  38 #ifdef TARGET_COMPILER_sparcWorks
  39 # include "utilities/globalDefinitions_sparcWorks.hpp"
  40 #endif
  41 #ifdef TARGET_COMPILER_xlc
  42 # include "utilities/globalDefinitions_xlc.hpp"
  43 #endif
  44 
  45 #ifndef NOINLINE
  46 #define NOINLINE
  47 #endif
  48 #ifndef ALWAYSINLINE
  49 #define ALWAYSINLINE inline
  50 #endif
  51 #ifndef PRAGMA_DIAG_PUSH
  52 #define PRAGMA_DIAG_PUSH
  53 #endif
  54 #ifndef PRAGMA_DIAG_POP
  55 #define PRAGMA_DIAG_POP
  56 #endif
  57 #ifndef PRAGMA_FORMAT_NONLITERAL_IGNORED
  58 #define PRAGMA_FORMAT_NONLITERAL_IGNORED
  59 #endif
  60 #ifndef PRAGMA_FORMAT_IGNORED
  61 #define PRAGMA_FORMAT_IGNORED
  62 #endif
  63 #ifndef PRAGMA_FORMAT_NONLITERAL_IGNORED_INTERNAL
  64 #define PRAGMA_FORMAT_NONLITERAL_IGNORED_INTERNAL
  65 #endif
  66 #ifndef PRAGMA_FORMAT_NONLITERAL_IGNORED_EXTERNAL
  67 #define PRAGMA_FORMAT_NONLITERAL_IGNORED_EXTERNAL
  68 #endif
  69 #ifndef ATTRIBUTE_PRINTF
  70 #define ATTRIBUTE_PRINTF(fmt, vargs)
  71 #endif
  72 #ifndef ATTRIBUTE_SCANF
  73 #define ATTRIBUTE_SCANF(fmt, vargs)
  74 #endif
  75 
  76 
  77 #include "utilities/macros.hpp"
  78 
  79 // This file holds all globally used constants &amp; types, class (forward)
  80 // declarations and a few frequently used utility functions.
  81 
  82 //----------------------------------------------------------------------------------------------------
  83 // Constants
  84 
  85 const int LogBytesPerShort   = 1;
  86 const int LogBytesPerInt     = 2;
  87 #ifdef _LP64
  88 const int LogBytesPerWord    = 3;
  89 #else
  90 const int LogBytesPerWord    = 2;
  91 #endif
  92 const int LogBytesPerLong    = 3;
  93 
  94 const int BytesPerShort      = 1 &lt;&lt; LogBytesPerShort;
  95 const int BytesPerInt        = 1 &lt;&lt; LogBytesPerInt;
  96 const int BytesPerWord       = 1 &lt;&lt; LogBytesPerWord;
  97 const int BytesPerLong       = 1 &lt;&lt; LogBytesPerLong;
  98 
  99 const int LogBitsPerByte     = 3;
 100 const int LogBitsPerShort    = LogBitsPerByte + LogBytesPerShort;
 101 const int LogBitsPerInt      = LogBitsPerByte + LogBytesPerInt;
 102 const int LogBitsPerWord     = LogBitsPerByte + LogBytesPerWord;
 103 const int LogBitsPerLong     = LogBitsPerByte + LogBytesPerLong;
 104 
 105 const int BitsPerByte        = 1 &lt;&lt; LogBitsPerByte;
 106 const int BitsPerShort       = 1 &lt;&lt; LogBitsPerShort;
 107 const int BitsPerInt         = 1 &lt;&lt; LogBitsPerInt;
 108 const int BitsPerWord        = 1 &lt;&lt; LogBitsPerWord;
 109 const int BitsPerLong        = 1 &lt;&lt; LogBitsPerLong;
 110 
 111 const int WordAlignmentMask  = (1 &lt;&lt; LogBytesPerWord) - 1;
 112 const int LongAlignmentMask  = (1 &lt;&lt; LogBytesPerLong) - 1;
 113 
 114 const int WordsPerLong       = 2;       // Number of stack entries for longs
 115 
 116 const int oopSize            = sizeof(char*); // Full-width oop
 117 extern int heapOopSize;                       // Oop within a java object
 118 const int wordSize           = sizeof(char*);
 119 const int longSize           = sizeof(jlong);
 120 const int jintSize           = sizeof(jint);
 121 const int size_tSize         = sizeof(size_t);
 122 
 123 const int BytesPerOop        = BytesPerWord;  // Full-width oop
 124 
 125 extern int LogBytesPerHeapOop;                // Oop within a java object
 126 extern int LogBitsPerHeapOop;
 127 extern int BytesPerHeapOop;
 128 extern int BitsPerHeapOop;
 129 
 130 const int BitsPerJavaInteger = 32;
 131 const int BitsPerJavaLong    = 64;
 132 const int BitsPerSize_t      = size_tSize * BitsPerByte;
 133 
 134 // Size of a char[] needed to represent a jint as a string in decimal.
 135 const int jintAsStringSize = 12;
 136 
 137 // In fact this should be
 138 // log2_intptr(sizeof(class JavaThread)) - log2_intptr(64);
 139 // see os::set_memory_serialize_page()
 140 #ifdef _LP64
 141 const int SerializePageShiftCount = 4;
 142 #else
 143 const int SerializePageShiftCount = 3;
 144 #endif
 145 
 146 // An opaque struct of heap-word width, so that HeapWord* can be a generic
 147 // pointer into the heap.  We require that object sizes be measured in
 148 // units of heap words, so that that
 149 //   HeapWord* hw;
 150 //   hw += oop(hw)-&gt;foo();
 151 // works, where foo is a method (like size or scavenge) that returns the
 152 // object size.
 153 class HeapWord {
 154   friend class VMStructs;
 155  private:
 156   char* i;
 157 #ifndef PRODUCT
 158  public:
 159   char* value() { return i; }
 160 #endif
 161 };
 162 
 163 // Analogous opaque struct for metadata allocated from
 164 // metaspaces.
 165 class MetaWord {
 166  private:
 167   char* i;
 168 };
 169 
 170 // HeapWordSize must be 2^LogHeapWordSize.
 171 const int HeapWordSize        = sizeof(HeapWord);
 172 #ifdef _LP64
 173 const int LogHeapWordSize     = 3;
 174 #else
 175 const int LogHeapWordSize     = 2;
 176 #endif
 177 const int HeapWordsPerLong    = BytesPerLong / HeapWordSize;
 178 const int LogHeapWordsPerLong = LogBytesPerLong - LogHeapWordSize;
 179 
 180 // The larger HeapWordSize for 64bit requires larger heaps
 181 // for the same application running in 64bit.  See bug 4967770.
 182 // The minimum alignment to a heap word size is done.  Other
 183 // parts of the memory system may require additional alignment
 184 // and are responsible for those alignments.
 185 #ifdef _LP64
 186 #define ScaleForWordSize(x) align_size_down_((x) * 13 / 10, HeapWordSize)
 187 #else
 188 #define ScaleForWordSize(x) (x)
 189 #endif
 190 
 191 // The minimum number of native machine words necessary to contain "byte_size"
 192 // bytes.
 193 inline size_t heap_word_size(size_t byte_size) {
 194   return (byte_size + (HeapWordSize-1)) &gt;&gt; LogHeapWordSize;
 195 }
 196 
 197 const size_t K                  = 1024;
 198 const size_t M                  = K*K;
 199 const size_t G                  = M*K;
 200 const size_t HWperKB            = K / sizeof(HeapWord);
 201 
 202 // Constants for converting from a base unit to milli-base units.  For
 203 // example from seconds to milliseconds and microseconds
 204 
 205 const int MILLIUNITS    = 1000;         // milli units per base unit
 206 const int MICROUNITS    = 1000000;      // micro units per base unit
 207 const int NANOUNITS     = 1000000000;   // nano units per base unit
 208 
 209 const jlong NANOSECS_PER_SEC      = CONST64(1000000000);
 210 const jint  NANOSECS_PER_MILLISEC = 1000000;
 211 
 212 inline const char* proper_unit_for_byte_size(size_t s) {
 213 #ifdef _LP64
 214   if (s &gt;= 10*G) {
 215     return "G";
 216   }
 217 #endif
 218   if (s &gt;= 10*M) {
 219     return "M";
 220   } else if (s &gt;= 10*K) {
 221     return "K";
 222   } else {
 223     return "B";
 224   }
 225 }
 226 
 227 template &lt;class T&gt;
 228 inline T byte_size_in_proper_unit(T s) {
 229 #ifdef _LP64
 230   if (s &gt;= 10*G) {
 231     return (T)(s/G);
 232   }
 233 #endif
 234   if (s &gt;= 10*M) {
 235     return (T)(s/M);
 236   } else if (s &gt;= 10*K) {
 237     return (T)(s/K);
 238   } else {
 239     return s;
 240   }
 241 }
 242 
 243 inline const char* exact_unit_for_byte_size(size_t s) {
 244 #ifdef _LP64
 245   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 246     return "G";
 247   }
 248 #endif
 249   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 250     return "M";
 251   }
 252   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 253     return "K";
 254   }
 255   return "B";
 256 }
 257 
 258 inline size_t byte_size_in_exact_unit(size_t s) {
 259 #ifdef _LP64
 260   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 261     return s / G;
 262   }
 263 #endif
 264   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 265     return s / M;
 266   }
 267   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 268     return s / K;
 269   }
 270   return s;
 271 }
 272 
 273 //----------------------------------------------------------------------------------------------------
 274 // VM type definitions
 275 
 276 // intx and uintx are the 'extended' int and 'extended' unsigned int types;
 277 // they are 32bit wide on a 32-bit platform, and 64bit wide on a 64bit platform.
 278 
 279 typedef intptr_t  intx;
 280 typedef uintptr_t uintx;
 281 
 282 const intx  min_intx  = (intx)1 &lt;&lt; (sizeof(intx)*BitsPerByte-1);
 283 const intx  max_intx  = (uintx)min_intx - 1;
 284 const uintx max_uintx = (uintx)-1;
 285 
 286 // Table of values:
 287 //      sizeof intx         4               8
 288 // min_intx             0x80000000      0x8000000000000000
 289 // max_intx             0x7FFFFFFF      0x7FFFFFFFFFFFFFFF
 290 // max_uintx            0xFFFFFFFF      0xFFFFFFFFFFFFFFFF
 291 
 292 typedef unsigned int uint;   NEEDS_CLEANUP
 293 
 294 
 295 //----------------------------------------------------------------------------------------------------
 296 // Java type definitions
 297 
 298 // All kinds of 'plain' byte addresses
 299 typedef   signed char s_char;
 300 typedef unsigned char u_char;
 301 typedef u_char*       address;
 302 typedef uintptr_t     address_word; // unsigned integer which will hold a pointer
 303                                     // except for some implementations of a C++
 304                                     // linkage pointer to function. Should never
 305                                     // need one of those to be placed in this
 306                                     // type anyway.
 307 
 308 //  Utility functions to "portably" (?) bit twiddle pointers
 309 //  Where portable means keep ANSI C++ compilers quiet
 310 
 311 inline address       set_address_bits(address x, int m)       { return address(intptr_t(x) | m); }
 312 inline address       clear_address_bits(address x, int m)     { return address(intptr_t(x) &amp; ~m); }
 313 
 314 //  Utility functions to "portably" make cast to/from function pointers.
 315 
 316 inline address_word  mask_address_bits(address x, int m)      { return address_word(x) &amp; m; }
 317 inline address_word  castable_address(address x)              { return address_word(x) ; }
 318 inline address_word  castable_address(void* x)                { return address_word(x) ; }
 319 
 320 // Pointer subtraction.
 321 // The idea here is to avoid ptrdiff_t, which is signed and so doesn't have
 322 // the range we might need to find differences from one end of the heap
 323 // to the other.
 324 // A typical use might be:
 325 //     if (pointer_delta(end(), top()) &gt;= size) {
 326 //       // enough room for an object of size
 327 //       ...
 328 // and then additions like
 329 //       ... top() + size ...
 330 // are safe because we know that top() is at least size below end().
 331 inline size_t pointer_delta(const void* left,
 332                             const void* right,
 333                             size_t element_size) {
 334   return (((uintptr_t) left) - ((uintptr_t) right)) / element_size;
 335 }
 336 // A version specialized for HeapWord*'s.
 337 inline size_t pointer_delta(const HeapWord* left, const HeapWord* right) {
 338   return pointer_delta(left, right, sizeof(HeapWord));
 339 }
 340 // A version specialized for MetaWord*'s.
 341 inline size_t pointer_delta(const MetaWord* left, const MetaWord* right) {
 342   return pointer_delta(left, right, sizeof(MetaWord));
 343 }
 344 
 345 //
 346 // ANSI C++ does not allow casting from one pointer type to a function pointer
 347 // directly without at best a warning. This macro accomplishes it silently
 348 // In every case that is present at this point the value be cast is a pointer
 349 // to a C linkage function. In some case the type used for the cast reflects
 350 // that linkage and a picky compiler would not complain. In other cases because
 351 // there is no convenient place to place a typedef with extern C linkage (i.e
 352 // a platform dependent header file) it doesn't. At this point no compiler seems
 353 // picky enough to catch these instances (which are few). It is possible that
 354 // using templates could fix these for all cases. This use of templates is likely
 355 // so far from the middle of the road that it is likely to be problematic in
 356 // many C++ compilers.
 357 //
 358 #define CAST_TO_FN_PTR(func_type, value) (reinterpret_cast&lt;func_type&gt;(value))
 359 #define CAST_FROM_FN_PTR(new_type, func_ptr) ((new_type)((address_word)(func_ptr)))
 360 
 361 // Unsigned byte types for os and stream.hpp
 362 
 363 // Unsigned one, two, four and eigth byte quantities used for describing
 364 // the .class file format. See JVM book chapter 4.
 365 
 366 typedef jubyte  u1;
 367 typedef jushort u2;
 368 typedef juint   u4;
 369 typedef julong  u8;
 370 
 371 const jubyte  max_jubyte  = (jubyte)-1;  // 0xFF       largest jubyte
 372 const jushort max_jushort = (jushort)-1; // 0xFFFF     largest jushort
 373 const juint   max_juint   = (juint)-1;   // 0xFFFFFFFF largest juint
 374 const julong  max_julong  = (julong)-1;  // 0xFF....FF largest julong
 375 
 376 typedef jbyte  s1;
 377 typedef jshort s2;
 378 typedef jint   s4;
 379 typedef jlong  s8;
 380 
 381 const jbyte min_jbyte = -(1 &lt;&lt; 7);       // smallest jbyte
 382 const jbyte max_jbyte = (1 &lt;&lt; 7) - 1;    // largest jbyte
 383 const jshort min_jshort = -(1 &lt;&lt; 15);    // smallest jshort
 384 const jshort max_jshort = (1 &lt;&lt; 15) - 1; // largest jshort
 385 
 386 const jint min_jint = (jint)1 &lt;&lt; (sizeof(jint)*BitsPerByte-1); // 0x80000000 == smallest jint
 387 const jint max_jint = (juint)min_jint - 1;                     // 0x7FFFFFFF == largest jint
 388 
 389 //----------------------------------------------------------------------------------------------------
 390 // JVM spec restrictions
 391 
 392 const int max_method_code_size = 64*K - 1;  // JVM spec, 2nd ed. section 4.8.1 (p.134)
 393 
 394 // Default ProtectionDomainCacheSize values
 395 
 396 const int defaultProtectionDomainCacheSize = NOT_LP64(137) LP64_ONLY(2017);
 397 
 398 //----------------------------------------------------------------------------------------------------
 399 // Default and minimum StringTableSize values
 400 
 401 const int defaultStringTableSize = NOT_LP64(1009) LP64_ONLY(60013);
 402 const int minimumStringTableSize = 1009;
 403 
 404 const int defaultSymbolTableSize = 20011;
 405 const int minimumSymbolTableSize = 1009;
 406 
 407 
 408 //----------------------------------------------------------------------------------------------------
 409 // HotSwap - for JVMTI   aka Class File Replacement and PopFrame
 410 //
 411 // Determines whether on-the-fly class replacement and frame popping are enabled.
 412 
 413 #define HOTSWAP
 414 
 415 //----------------------------------------------------------------------------------------------------
 416 // Object alignment, in units of HeapWords.
 417 //
 418 // Minimum is max(BytesPerLong, BytesPerDouble, BytesPerOop) / HeapWordSize, so jlong, jdouble and
 419 // reference fields can be naturally aligned.
 420 
 421 extern int MinObjAlignment;
 422 extern int MinObjAlignmentInBytes;
 423 extern int MinObjAlignmentInBytesMask;
 424 
 425 extern int LogMinObjAlignment;
 426 extern int LogMinObjAlignmentInBytes;
 427 
 428 const int LogKlassAlignmentInBytes = 3;
 429 const int LogKlassAlignment        = LogKlassAlignmentInBytes - LogHeapWordSize;
 430 const int KlassAlignmentInBytes    = 1 &lt;&lt; LogKlassAlignmentInBytes;
 431 const int KlassAlignment           = KlassAlignmentInBytes / HeapWordSize;
 432 
 433 // Maximal size of heap where unscaled compression can be used. Also upper bound
 434 // for heap placement: 4GB.
 435 const  uint64_t UnscaledOopHeapMax = (uint64_t(max_juint) + 1);
 436 // Maximal size of heap where compressed oops can be used. Also upper bound for heap
 437 // placement for zero based compression algorithm: UnscaledOopHeapMax &lt;&lt; LogMinObjAlignmentInBytes.
 438 extern uint64_t OopEncodingHeapMax;
 439 
 440 // Maximal size of compressed class space. Above this limit compression is not possible.
 441 // Also upper bound for placement of zero based class space. (Class space is further limited
 442 // to be &lt; 3G, see arguments.cpp.)
 443 const  uint64_t KlassEncodingMetaspaceMax = (uint64_t(max_juint) + 1) &lt;&lt; LogKlassAlignmentInBytes;
 444 
 445 // Machine dependent stuff
 446 
 447 // States of Restricted Transactional Memory usage.
 448 enum RTMState {
 449   NoRTM      = 0x2, // Don't use RTM
 450   UseRTM     = 0x1, // Use RTM
 451   ProfileRTM = 0x0  // Use RTM with abort ratio calculation
 452 };
 453 
 454 // The maximum size of the code cache.  Can be overridden by targets.
 455 #define CODE_CACHE_SIZE_LIMIT (2*G)
 456 // Allow targets to reduce the default size of the code cache.
 457 #define CODE_CACHE_DEFAULT_LIMIT CODE_CACHE_SIZE_LIMIT
 458 
 459 #ifdef TARGET_ARCH_x86
 460 # include "globalDefinitions_x86.hpp"
 461 #endif
 462 #ifdef TARGET_ARCH_sparc
 463 # include "globalDefinitions_sparc.hpp"
 464 #endif
 465 #ifdef TARGET_ARCH_zero
 466 # include "globalDefinitions_zero.hpp"
 467 #endif
 468 #ifdef TARGET_ARCH_arm
 469 # include "globalDefinitions_arm.hpp"
 470 #endif
 471 #ifdef TARGET_ARCH_ppc
 472 # include "globalDefinitions_ppc.hpp"
 473 #endif
 474 #ifdef TARGET_ARCH_aarch64
 475 # include "globalDefinitions_aarch64.hpp"
 476 #endif
 477 
 478 #ifndef INCLUDE_RTM_OPT
 479 #define INCLUDE_RTM_OPT 0
 480 #endif
 481 #if INCLUDE_RTM_OPT
 482 #define RTM_OPT_ONLY(code) code
 483 #else
 484 #define RTM_OPT_ONLY(code)
 485 #endif
 486 
 487 // To assure the IRIW property on processors that are not multiple copy
 488 // atomic, sync instructions must be issued between volatile reads to
 489 // assure their ordering, instead of after volatile stores.
 490 // (See "A Tutorial Introduction to the ARM and POWER Relaxed Memory Models"
 491 // by Luc Maranget, Susmit Sarkar and Peter Sewell, INRIA/Cambridge)
 492 #ifdef CPU_NOT_MULTIPLE_COPY_ATOMIC
 493 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = true;
 494 #else
 495 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = false;
 496 #endif
 497 
 498 // The byte alignment to be used by Arena::Amalloc.  See bugid 4169348.
 499 // Note: this value must be a power of 2
 500 
 501 #define ARENA_AMALLOC_ALIGNMENT (2*BytesPerWord)
 502 
 503 // Signed variants of alignment helpers.  There are two versions of each, a macro
 504 // for use in places like enum definitions that require compile-time constant
 505 // expressions and a function for all other places so as to get type checking.
 506 
 507 #define align_size_up_(size, alignment) (((size) + ((alignment) - 1)) &amp; ~((alignment) - 1))
 508 
 509 inline bool is_size_aligned(size_t size, size_t alignment) {
 510   return align_size_up_(size, alignment) == size;
 511 }
 512 
 513 inline bool is_ptr_aligned(void* ptr, size_t alignment) {
 514   return align_size_up_((intptr_t)ptr, (intptr_t)alignment) == (intptr_t)ptr;
 515 }
 516 
 517 inline intptr_t align_size_up(intptr_t size, intptr_t alignment) {
 518   return align_size_up_(size, alignment);
 519 }
 520 
 521 #define align_size_down_(size, alignment) ((size) &amp; ~((alignment) - 1))
 522 
 523 inline intptr_t align_size_down(intptr_t size, intptr_t alignment) {
 524   return align_size_down_(size, alignment);
 525 }
 526 
 527 #define is_size_aligned_(size, alignment) ((size) == (align_size_up_(size, alignment)))
 528 
 529 inline void* align_ptr_up(const void* ptr, size_t alignment) {
 530   return (void*)align_size_up((intptr_t)ptr, (intptr_t)alignment);
 531 }
 532 
 533 inline void* align_ptr_down(void* ptr, size_t alignment) {
 534   return (void*)align_size_down((intptr_t)ptr, (intptr_t)alignment);
 535 }
 536 
 537 // Align metaspace objects by rounding up to natural word boundary
 538 
 539 inline intptr_t align_metadata_size(intptr_t size) {
 540   return align_size_up(size, 1);
 541 }
 542 
 543 // Align objects in the Java Heap by rounding up their size, in HeapWord units.
 544 // Since the size is given in words this is somewhat of a nop, but
 545 // distinguishes it from align_object_size.
 546 inline intptr_t align_object_size(intptr_t size) {
 547   return align_size_up(size, MinObjAlignment);
 548 }
 549 
 550 inline bool is_object_aligned(intptr_t addr) {
 551   return addr == align_object_size(addr);
 552 }
 553 
 554 // Pad out certain offsets to jlong alignment, in HeapWord units.
 555 
 556 inline intptr_t align_object_offset(intptr_t offset) {
 557   return align_size_up(offset, HeapWordsPerLong);
 558 }
 559 
 560 // Align down with a lower bound. If the aligning results in 0, return 'alignment'.
 561 
 562 inline size_t align_size_down_bounded(size_t size, size_t alignment) {
 563   size_t aligned_size = align_size_down_(size, alignment);
 564   return aligned_size &gt; 0 ? aligned_size : alignment;
 565 }
 566 
 567 // Clamp an address to be within a specific page
 568 // 1. If addr is on the page it is returned as is
 569 // 2. If addr is above the page_address the start of the *next* page will be returned
 570 // 3. Otherwise, if addr is below the page_address the start of the page will be returned
 571 inline address clamp_address_in_page(address addr, address page_address, intptr_t page_size) {
 572   if (align_size_down(intptr_t(addr), page_size) == align_size_down(intptr_t(page_address), page_size)) {
 573     // address is in the specified page, just return it as is
 574     return addr;
 575   } else if (addr &gt; page_address) {
 576     // address is above specified page, return start of next page
 577     return (address)align_size_down(intptr_t(page_address), page_size) + page_size;
 578   } else {
 579     // address is below specified page, return start of page
 580     return (address)align_size_down(intptr_t(page_address), page_size);
 581   }
 582 }
 583 
 584 
 585 // The expected size in bytes of a cache line, used to pad data structures.
 586 #ifndef DEFAULT_CACHE_LINE_SIZE
 587   #define DEFAULT_CACHE_LINE_SIZE 64
 588 #endif
 589 
 590 
 591 //----------------------------------------------------------------------------------------------------
 592 // Utility macros for compilers
 593 // used to silence compiler warnings
 594 
 595 #define Unused_Variable(var) var
 596 
 597 
 598 //----------------------------------------------------------------------------------------------------
 599 // Miscellaneous
 600 
 601 // 6302670 Eliminate Hotspot __fabsf dependency
 602 // All fabs() callers should call this function instead, which will implicitly
 603 // convert the operand to double, avoiding a dependency on __fabsf which
 604 // doesn't exist in early versions of Solaris 8.
 605 inline double fabsd(double value) {
 606   return fabs(value);
 607 }
 608 
 609 // Returns numerator/denominator as percentage value from 0 to 100. If denominator
 610 // is zero, return 0.0.
 611 template&lt;typename T&gt;
 612 inline double percent_of(T numerator, T denominator) {
 613   return denominator != 0 ? (double)numerator / denominator * 100.0 : 0.0;
 614 }
 615 
 616 //----------------------------------------------------------------------------------------------------
 617 // Special casts
 618 // Cast floats into same-size integers and vice-versa w/o changing bit-pattern
 619 typedef union {
 620   jfloat f;
 621   jint i;
 622 } FloatIntConv;
 623 
 624 typedef union {
 625   jdouble d;
 626   jlong l;
 627   julong ul;
 628 } DoubleLongConv;
 629 
 630 inline jint    jint_cast    (jfloat  x)  { return ((FloatIntConv*)&amp;x)-&gt;i; }
 631 inline jfloat  jfloat_cast  (jint    x)  { return ((FloatIntConv*)&amp;x)-&gt;f; }
 632 
 633 inline jlong   jlong_cast   (jdouble x)  { return ((DoubleLongConv*)&amp;x)-&gt;l;  }
 634 inline julong  julong_cast  (jdouble x)  { return ((DoubleLongConv*)&amp;x)-&gt;ul; }
 635 inline jdouble jdouble_cast (jlong   x)  { return ((DoubleLongConv*)&amp;x)-&gt;d;  }
 636 
 637 inline jint low (jlong value)                    { return jint(value); }
 638 inline jint high(jlong value)                    { return jint(value &gt;&gt; 32); }
 639 
 640 // the fancy casts are a hopefully portable way
 641 // to do unsigned 32 to 64 bit type conversion
 642 inline void set_low (jlong* value, jint low )    { *value &amp;= (jlong)0xffffffff &lt;&lt; 32;
 643                                                    *value |= (jlong)(julong)(juint)low; }
 644 
 645 inline void set_high(jlong* value, jint high)    { *value &amp;= (jlong)(julong)(juint)0xffffffff;
 646                                                    *value |= (jlong)high       &lt;&lt; 32; }
 647 
 648 inline jlong jlong_from(jint h, jint l) {
 649   jlong result = 0; // initialization to avoid warning
 650   set_high(&amp;result, h);
 651   set_low(&amp;result,  l);
 652   return result;
 653 }
 654 
 655 union jlong_accessor {
 656   jint  words[2];
 657   jlong long_value;
 658 };
 659 
 660 void basic_types_init(); // cannot define here; uses assert
 661 
 662 
 663 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 664 enum BasicType {
 665   T_BOOLEAN     =  4,
 666   T_CHAR        =  5,
 667   T_FLOAT       =  6,
 668   T_DOUBLE      =  7,
 669   T_BYTE        =  8,
 670   T_SHORT       =  9,
 671   T_INT         = 10,
 672   T_LONG        = 11,
 673   T_OBJECT      = 12,
 674   T_ARRAY       = 13,
 675   T_VOID        = 14,
 676   T_ADDRESS     = 15,
 677   T_NARROWOOP   = 16,
 678   T_METADATA    = 17,
 679   T_NARROWKLASS = 18,
 680   T_CONFLICT    = 19, // for stack value type with conflicting contents
 681   T_ILLEGAL     = 99
 682 };
 683 
 684 inline bool is_java_primitive(BasicType t) {
 685   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_LONG;
 686 }
 687 
 688 inline bool is_subword_type(BasicType t) {
 689   // these guys are processed exactly like T_INT in calling sequences:
 690   return (t == T_BOOLEAN || t == T_CHAR || t == T_BYTE || t == T_SHORT);
 691 }
 692 
 693 inline bool is_signed_subword_type(BasicType t) {
 694   return (t == T_BYTE || t == T_SHORT);
 695 }
 696 
 697 // Convert a char from a classfile signature to a BasicType
 698 inline BasicType char2type(char c) {
 699   switch( c ) {
 700   case 'B': return T_BYTE;
 701   case 'C': return T_CHAR;
 702   case 'D': return T_DOUBLE;
 703   case 'F': return T_FLOAT;
 704   case 'I': return T_INT;
 705   case 'J': return T_LONG;
 706   case 'S': return T_SHORT;
 707   case 'Z': return T_BOOLEAN;
 708   case 'V': return T_VOID;
 709   case 'L': return T_OBJECT;
 710   case '[': return T_ARRAY;
 711   }
 712   return T_ILLEGAL;
 713 }
 714 
 715 extern char type2char_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 716 inline char type2char(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2char_tab[t] : 0; }
 717 extern int type2size[T_CONFLICT+1];         // Map BasicType to result stack elements
 718 extern const char* type2name_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 719 inline const char* type2name(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2name_tab[t] : NULL; }
 720 extern BasicType name2type(const char* name);
 721 
 722 // Auxiliary math routines
 723 // least common multiple
 724 extern size_t lcm(size_t a, size_t b);
 725 
 726 
 727 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 728 enum BasicTypeSize {
 729   T_BOOLEAN_size     = 1,
 730   T_CHAR_size        = 1,
 731   T_FLOAT_size       = 1,
 732   T_DOUBLE_size      = 2,
 733   T_BYTE_size        = 1,
 734   T_SHORT_size       = 1,
 735   T_INT_size         = 1,
 736   T_LONG_size        = 2,
 737   T_OBJECT_size      = 1,
 738   T_ARRAY_size       = 1,
 739   T_NARROWOOP_size   = 1,
 740   T_NARROWKLASS_size = 1,
 741   T_VOID_size        = 0
 742 };
 743 
 744 
 745 // maps a BasicType to its instance field storage type:
 746 // all sub-word integral types are widened to T_INT
 747 extern BasicType type2field[T_CONFLICT+1];
 748 extern BasicType type2wfield[T_CONFLICT+1];
 749 
 750 
 751 // size in bytes
 752 enum ArrayElementSize {
 753   T_BOOLEAN_aelem_bytes     = 1,
 754   T_CHAR_aelem_bytes        = 2,
 755   T_FLOAT_aelem_bytes       = 4,
 756   T_DOUBLE_aelem_bytes      = 8,
 757   T_BYTE_aelem_bytes        = 1,
 758   T_SHORT_aelem_bytes       = 2,
 759   T_INT_aelem_bytes         = 4,
 760   T_LONG_aelem_bytes        = 8,
 761 #ifdef _LP64
 762   T_OBJECT_aelem_bytes      = 8,
 763   T_ARRAY_aelem_bytes       = 8,
 764 #else
 765   T_OBJECT_aelem_bytes      = 4,
 766   T_ARRAY_aelem_bytes       = 4,
 767 #endif
 768   T_NARROWOOP_aelem_bytes   = 4,
 769   T_NARROWKLASS_aelem_bytes = 4,
 770   T_VOID_aelem_bytes        = 0
 771 };
 772 
 773 extern int _type2aelembytes[T_CONFLICT+1]; // maps a BasicType to nof bytes used by its array element
 774 #ifdef ASSERT
 775 extern int type2aelembytes(BasicType t, bool allow_address = false); // asserts
 776 #else
 777 inline int type2aelembytes(BasicType t, bool allow_address = false) { return _type2aelembytes[t]; }
 778 #endif
 779 
 780 
 781 // JavaValue serves as a container for arbitrary Java values.
 782 
 783 class JavaValue {
 784 
 785  public:
 786   typedef union JavaCallValue {
 787     jfloat   f;
 788     jdouble  d;
 789     jint     i;
 790     jlong    l;
 791     jobject  h;
 792   } JavaCallValue;
 793 
 794  private:
 795   BasicType _type;
 796   JavaCallValue _value;
 797 
 798  public:
 799   JavaValue(BasicType t = T_ILLEGAL) { _type = t; }
 800 
 801   JavaValue(jfloat value) {
 802     _type    = T_FLOAT;
 803     _value.f = value;
 804   }
 805 
 806   JavaValue(jdouble value) {
 807     _type    = T_DOUBLE;
 808     _value.d = value;
 809   }
 810 
 811  jfloat get_jfloat() const { return _value.f; }
 812  jdouble get_jdouble() const { return _value.d; }
 813  jint get_jint() const { return _value.i; }
 814  jlong get_jlong() const { return _value.l; }
 815  jobject get_jobject() const { return _value.h; }
 816  JavaCallValue* get_value_addr() { return &amp;_value; }
 817  BasicType get_type() const { return _type; }
 818 
 819  void set_jfloat(jfloat f) { _value.f = f;}
 820  void set_jdouble(jdouble d) { _value.d = d;}
 821  void set_jint(jint i) { _value.i = i;}
 822  void set_jlong(jlong l) { _value.l = l;}
 823  void set_jobject(jobject h) { _value.h = h;}
 824  void set_type(BasicType t) { _type = t; }
 825 
 826  jboolean get_jboolean() const { return (jboolean) (_value.i);}
 827  jbyte get_jbyte() const { return (jbyte) (_value.i);}
 828  jchar get_jchar() const { return (jchar) (_value.i);}
 829  jshort get_jshort() const { return (jshort) (_value.i);}
 830 
 831 };
 832 
 833 
 834 #define STACK_BIAS      0
 835 // V9 Sparc CPU's running in 64 Bit mode use a stack bias of 7ff
 836 // in order to extend the reach of the stack pointer.
 837 #if defined(SPARC) &amp;&amp; defined(_LP64)
 838 #undef STACK_BIAS
 839 #define STACK_BIAS      0x7ff
 840 #endif
 841 
 842 
 843 // TosState describes the top-of-stack state before and after the execution of
 844 // a bytecode or method. The top-of-stack value may be cached in one or more CPU
 845 // registers. The TosState corresponds to the 'machine representation' of this cached
 846 // value. There's 4 states corresponding to the JAVA types int, long, float &amp; double
 847 // as well as a 5th state in case the top-of-stack value is actually on the top
 848 // of stack (in memory) and thus not cached. The atos state corresponds to the itos
 849 // state when it comes to machine representation but is used separately for (oop)
 850 // type specific operations (e.g. verification code).
 851 
 852 enum TosState {         // describes the tos cache contents
 853   btos = 0,             // byte, bool tos cached
 854   ztos = 1,             // byte, bool tos cached
 855   ctos = 2,             // char tos cached
 856   stos = 3,             // short tos cached
 857   itos = 4,             // int tos cached
 858   ltos = 5,             // long tos cached
 859   ftos = 6,             // float tos cached
 860   dtos = 7,             // double tos cached
 861   atos = 8,             // object cached
 862   vtos = 9,             // tos not cached
 863   number_of_states,
 864   ilgl                  // illegal state: should not occur
 865 };
 866 
 867 
 868 inline TosState as_TosState(BasicType type) {
 869   switch (type) {
 870     case T_BYTE   : return btos;
 871     case T_BOOLEAN: return ztos;
 872     case T_CHAR   : return ctos;
 873     case T_SHORT  : return stos;
 874     case T_INT    : return itos;
 875     case T_LONG   : return ltos;
 876     case T_FLOAT  : return ftos;
 877     case T_DOUBLE : return dtos;
 878     case T_VOID   : return vtos;
 879     case T_ARRAY  : // fall through
 880     case T_OBJECT : return atos;
 881   }
 882   return ilgl;
 883 }
 884 
 885 inline BasicType as_BasicType(TosState state) {
 886   switch (state) {
 887     case btos : return T_BYTE;
 888     case ztos : return T_BOOLEAN;
 889     case ctos : return T_CHAR;
 890     case stos : return T_SHORT;
 891     case itos : return T_INT;
 892     case ltos : return T_LONG;
 893     case ftos : return T_FLOAT;
 894     case dtos : return T_DOUBLE;
 895     case atos : return T_OBJECT;
 896     case vtos : return T_VOID;
 897   }
 898   return T_ILLEGAL;
 899 }
 900 
 901 
 902 // Helper function to convert BasicType info into TosState
 903 // Note: Cannot define here as it uses global constant at the time being.
 904 TosState as_TosState(BasicType type);
 905 
 906 
 907 // JavaThreadState keeps track of which part of the code a thread is executing in. This
 908 // information is needed by the safepoint code.
 909 //
 910 // There are 4 essential states:
 911 //
 912 //  _thread_new         : Just started, but not executed init. code yet (most likely still in OS init code)
 913 //  _thread_in_native   : In native code. This is a safepoint region, since all oops will be in jobject handles
 914 //  _thread_in_vm       : Executing in the vm
 915 //  _thread_in_Java     : Executing either interpreted or compiled Java code (or could be in a stub)
 916 //
 917 // Each state has an associated xxxx_trans state, which is an intermediate state used when a thread is in
 918 // a transition from one state to another. These extra states makes it possible for the safepoint code to
 919 // handle certain thread_states without having to suspend the thread - making the safepoint code faster.
 920 //
 921 // Given a state, the xxxx_trans state can always be found by adding 1.
 922 //
 923 enum JavaThreadState {
 924   _thread_uninitialized     =  0, // should never happen (missing initialization)
 925   _thread_new               =  2, // just starting up, i.e., in process of being initialized
 926   _thread_new_trans         =  3, // corresponding transition state (not used, included for completness)
 927   _thread_in_native         =  4, // running in native code
 928   _thread_in_native_trans   =  5, // corresponding transition state
 929   _thread_in_vm             =  6, // running in VM
 930   _thread_in_vm_trans       =  7, // corresponding transition state
 931   _thread_in_Java           =  8, // running in Java or in stub code
 932   _thread_in_Java_trans     =  9, // corresponding transition state (not used, included for completness)
 933   _thread_blocked           = 10, // blocked in vm
 934   _thread_blocked_trans     = 11, // corresponding transition state
 935   _thread_max_state         = 12  // maximum thread state+1 - used for statistics allocation
 936 };
 937 
 938 
 939 // Handy constants for deciding which compiler mode to use.
 940 enum MethodCompilation {
 941   InvocationEntryBci = -1     // i.e., not a on-stack replacement compilation
 942 };
 943 
 944 // Enumeration to distinguish tiers of compilation
 945 enum CompLevel {
 946   CompLevel_any               = -1,
 947   CompLevel_all               = -1,
 948   CompLevel_none              = 0,         // Interpreter
 949   CompLevel_simple            = 1,         // C1
 950   CompLevel_limited_profile   = 2,         // C1, invocation &amp; backedge counters
 951   CompLevel_full_profile      = 3,         // C1, invocation &amp; backedge counters + mdo
 952   CompLevel_full_optimization = 4,         // C2, Shark or JVMCI
 953 
 954 #if defined(COMPILER2) || defined(SHARK)
 955   CompLevel_highest_tier      = CompLevel_full_optimization,  // pure C2 and tiered or JVMCI and tiered
 956 #elif defined(COMPILER1)
 957   CompLevel_highest_tier      = CompLevel_simple,             // pure C1 or JVMCI
 958 #else
 959   CompLevel_highest_tier      = CompLevel_none,
 960 #endif
 961 
 962 #if defined(TIERED)
 963   CompLevel_initial_compile   = CompLevel_full_profile        // tiered
 964 #elif defined(COMPILER1) || INCLUDE_JVMCI
 965   CompLevel_initial_compile   = CompLevel_simple              // pure C1 or JVMCI
 966 #elif defined(COMPILER2) || defined(SHARK)
 967   CompLevel_initial_compile   = CompLevel_full_optimization   // pure C2
 968 #else
 969   CompLevel_initial_compile   = CompLevel_none
 970 #endif
 971 };
 972 
 973 inline bool is_c1_compile(int comp_level) {
 974   return comp_level &gt; CompLevel_none &amp;&amp; comp_level &lt; CompLevel_full_optimization;
 975 }
 976 
 977 inline bool is_c2_compile(int comp_level) {
 978   return comp_level == CompLevel_full_optimization;
 979 }
 980 
 981 inline bool is_highest_tier_compile(int comp_level) {
 982   return comp_level == CompLevel_highest_tier;
 983 }
 984 
 985 inline bool is_compile(int comp_level) {
 986   return is_c1_compile(comp_level) || is_c2_compile(comp_level);
 987 }
 988 
 989 //----------------------------------------------------------------------------------------------------
 990 // 'Forward' declarations of frequently used classes
 991 // (in order to reduce interface dependencies &amp; reduce
 992 // number of unnecessary compilations after changes)
 993 
 994 class ClassFileStream;
 995 
 996 class Event;
 997 
 998 class Thread;
 999 class  VMThread;
1000 class  JavaThread;
1001 class Threads;
1002 
1003 class VM_Operation;
1004 class VMOperationQueue;
1005 
1006 class CodeBlob;
1007 class  CompiledMethod;
1008 class   nmethod;
1009 class RuntimeBlob;
1010 class  OSRAdapter;
1011 class  I2CAdapter;
1012 class  C2IAdapter;
1013 class CompiledIC;
1014 class relocInfo;
1015 class ScopeDesc;
1016 class PcDesc;
1017 
1018 class Recompiler;
1019 class Recompilee;
1020 class RecompilationPolicy;
1021 class RFrame;
1022 class  CompiledRFrame;
1023 class  InterpretedRFrame;
1024 
1025 class frame;
1026 
1027 class vframe;
1028 class   javaVFrame;
1029 class     interpretedVFrame;
1030 class     compiledVFrame;
1031 class     deoptimizedVFrame;
1032 class   externalVFrame;
1033 class     entryVFrame;
1034 
1035 class RegisterMap;
1036 
1037 class Mutex;
1038 class Monitor;
1039 class BasicLock;
1040 class BasicObjectLock;
1041 
1042 class PeriodicTask;
1043 
1044 class JavaCallWrapper;
1045 
1046 class   oopDesc;
1047 class   metaDataOopDesc;
1048 
1049 class NativeCall;
1050 
1051 class zone;
1052 
1053 class StubQueue;
1054 
1055 class outputStream;
1056 
1057 class ResourceArea;
1058 
1059 class DebugInformationRecorder;
1060 class ScopeValue;
1061 class CompressedStream;
1062 class   DebugInfoReadStream;
1063 class   DebugInfoWriteStream;
1064 class LocationValue;
1065 class ConstantValue;
1066 class IllegalValue;
1067 
1068 class PrivilegedElement;
1069 class MonitorArray;
1070 
1071 class MonitorInfo;
1072 
1073 class OffsetClosure;
1074 class OopMapCache;
1075 class InterpreterOopMap;
1076 class OopMapCacheEntry;
1077 class OSThread;
1078 
1079 typedef int (*OSThreadStartFunc)(void*);
1080 
1081 class Space;
1082 
1083 class JavaValue;
1084 class methodHandle;
1085 class JavaCallArguments;
1086 
1087 // Basic support for errors (general debug facilities not defined at this point fo the include phase)
1088 
1089 extern void basic_fatal(const char* msg);
1090 
1091 
1092 //----------------------------------------------------------------------------------------------------
1093 // Special constants for debugging
1094 
1095 const jint     badInt           = -3;                       // generic "bad int" value
1096 const long     badAddressVal    = -2;                       // generic "bad address" value
1097 const long     badOopVal        = -1;                       // generic "bad oop" value
1098 const intptr_t badHeapOopVal    = (intptr_t) CONST64(0x2BAD4B0BBAADBABE); // value used to zap heap after GC
1099 const int      badHandleValue   = 0xBC;                     // value used to zap vm handle area
1100 const int      badResourceValue = 0xAB;                     // value used to zap resource area
1101 const int      freeBlockPad     = 0xBA;                     // value used to pad freed blocks.
1102 const int      uninitBlockPad   = 0xF1;                     // value used to zap newly malloc'd blocks.
1103 const juint    uninitMetaWordVal= 0xf7f7f7f7;               // value used to zap newly allocated metachunk
1104 const intptr_t badJNIHandleVal  = (intptr_t) UCONST64(0xFEFEFEFEFEFEFEFE); // value used to zap jni handle area
1105 const juint    badHeapWordVal   = 0xBAADBABE;               // value used to zap heap after GC
1106 const juint    badMetaWordVal   = 0xBAADFADE;               // value used to zap metadata heap after GC
1107 const int      badCodeHeapNewVal= 0xCC;                     // value used to zap Code heap at allocation
1108 const int      badCodeHeapFreeVal = 0xDD;                   // value used to zap Code heap at deallocation
1109 
1110 
1111 // (These must be implemented as #defines because C++ compilers are
1112 // not obligated to inline non-integral constants!)
1113 #define       badAddress        ((address)::badAddressVal)
1114 #define       badOop            (cast_to_oop(::badOopVal))
1115 #define       badHeapWord       (::badHeapWordVal)
1116 #define       badJNIHandle      (cast_to_oop(::badJNIHandleVal))
1117 
1118 // Default TaskQueue size is 16K (32-bit) or 128K (64-bit)
1119 #define TASKQUEUE_SIZE (NOT_LP64(1&lt;&lt;14) LP64_ONLY(1&lt;&lt;17))
1120 
1121 //----------------------------------------------------------------------------------------------------
1122 // Utility functions for bitfield manipulations
1123 
1124 const intptr_t AllBits    = ~0; // all bits set in a word
1125 const intptr_t NoBits     =  0; // no bits set in a word
1126 const jlong    NoLongBits =  0; // no bits set in a long
1127 const intptr_t OneBit     =  1; // only right_most bit set in a word
1128 
1129 // get a word with the n.th or the right-most or left-most n bits set
1130 // (note: #define used only so that they can be used in enum constant definitions)
1131 #define nth_bit(n)        (((n) &gt;= BitsPerWord) ? 0 : (OneBit &lt;&lt; (n)))
1132 #define right_n_bits(n)   (nth_bit(n) - 1)
1133 #define left_n_bits(n)    (right_n_bits(n) &lt;&lt; (((n) &gt;= BitsPerWord) ? 0 : (BitsPerWord - (n))))
1134 
1135 // bit-operations using a mask m
1136 inline void   set_bits    (intptr_t&amp; x, intptr_t m) { x |= m; }
1137 inline void clear_bits    (intptr_t&amp; x, intptr_t m) { x &amp;= ~m; }
1138 inline intptr_t mask_bits      (intptr_t  x, intptr_t m) { return x &amp; m; }
1139 inline jlong    mask_long_bits (jlong     x, jlong    m) { return x &amp; m; }
1140 inline bool mask_bits_are_true (intptr_t flags, intptr_t mask) { return (flags &amp; mask) == mask; }
1141 
1142 // bit-operations using the n.th bit
1143 inline void    set_nth_bit(intptr_t&amp; x, int n) { set_bits  (x, nth_bit(n)); }
1144 inline void  clear_nth_bit(intptr_t&amp; x, int n) { clear_bits(x, nth_bit(n)); }
1145 inline bool is_set_nth_bit(intptr_t  x, int n) { return mask_bits (x, nth_bit(n)) != NoBits; }
1146 
1147 // returns the bitfield of x starting at start_bit_no with length field_length (no sign-extension!)
1148 inline intptr_t bitfield(intptr_t x, int start_bit_no, int field_length) {
1149   return mask_bits(x &gt;&gt; start_bit_no, right_n_bits(field_length));
1150 }
1151 
1152 
1153 //----------------------------------------------------------------------------------------------------
1154 // Utility functions for integers
1155 
1156 // Avoid use of global min/max macros which may cause unwanted double
1157 // evaluation of arguments.
1158 #ifdef max
1159 #undef max
1160 #endif
1161 
1162 #ifdef min
1163 #undef min
1164 #endif
1165 
1166 #define max(a,b) Do_not_use_max_use_MAX2_instead
1167 #define min(a,b) Do_not_use_min_use_MIN2_instead
1168 
1169 // It is necessary to use templates here. Having normal overloaded
1170 // functions does not work because it is necessary to provide both 32-
1171 // and 64-bit overloaded functions, which does not work, and having
1172 // explicitly-typed versions of these routines (i.e., MAX2I, MAX2L)
1173 // will be even more error-prone than macros.
1174 template&lt;class T&gt; inline T MAX2(T a, T b)           { return (a &gt; b) ? a : b; }
1175 template&lt;class T&gt; inline T MIN2(T a, T b)           { return (a &lt; b) ? a : b; }
1176 template&lt;class T&gt; inline T MAX3(T a, T b, T c)      { return MAX2(MAX2(a, b), c); }
1177 template&lt;class T&gt; inline T MIN3(T a, T b, T c)      { return MIN2(MIN2(a, b), c); }
1178 template&lt;class T&gt; inline T MAX4(T a, T b, T c, T d) { return MAX2(MAX3(a, b, c), d); }
1179 template&lt;class T&gt; inline T MIN4(T a, T b, T c, T d) { return MIN2(MIN3(a, b, c), d); }
1180 
1181 template&lt;class T&gt; inline T ABS(T x)                 { return (x &gt; 0) ? x : -x; }
1182 
1183 // true if x is a power of 2, false otherwise
1184 inline bool is_power_of_2(intptr_t x) {
1185   return ((x != NoBits) &amp;&amp; (mask_bits(x, x - 1) == NoBits));
1186 }
1187 
1188 // long version of is_power_of_2
1189 inline bool is_power_of_2_long(jlong x) {
1190   return ((x != NoLongBits) &amp;&amp; (mask_long_bits(x, x - 1) == NoLongBits));
1191 }
1192 
1193 // Returns largest i such that 2^i &lt;= x.
1194 // If x &lt; 0, the function returns 31 on a 32-bit machine and 63 on a 64-bit machine.
1195 // If x == 0, the function returns -1.
1196 inline int log2_intptr(intptr_t x) {
1197   int i = -1;
1198   uintptr_t p = 1;
1199   while (p != 0 &amp;&amp; p &lt;= (uintptr_t)x) {
1200     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
1201     i++; p *= 2;
1202   }
1203   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
1204   // If p = 0, overflow has occurred and i = 31 or i = 63 (depending on the machine word size).
1205   return i;
1206 }
1207 
1208 //* largest i such that 2^i &lt;= x
1209 //  A negative value of 'x' will return '63'
1210 inline int log2_long(jlong x) {
1211   int i = -1;
1212   julong p =  1;
1213   while (p != 0 &amp;&amp; p &lt;= (julong)x) {
1214     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
1215     i++; p *= 2;
1216   }
1217   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
1218   // (if p = 0 then overflow occurred and i = 63)
1219   return i;
1220 }
1221 
1222 //* the argument must be exactly a power of 2
1223 inline int exact_log2(intptr_t x) {
1224   #ifdef ASSERT
1225     if (!is_power_of_2(x)) basic_fatal("x must be a power of 2");
1226   #endif
1227   return log2_intptr(x);
1228 }
1229 
1230 //* the argument must be exactly a power of 2
1231 inline int exact_log2_long(jlong x) {
1232   #ifdef ASSERT
1233     if (!is_power_of_2_long(x)) basic_fatal("x must be a power of 2");
1234   #endif
1235   return log2_long(x);
1236 }
1237 
1238 
1239 // returns integer round-up to the nearest multiple of s (s must be a power of two)
1240 inline intptr_t round_to(intptr_t x, uintx s) {
1241   #ifdef ASSERT
1242     if (!is_power_of_2(s)) basic_fatal("s must be a power of 2");
1243   #endif
1244   const uintx m = s - 1;
1245   return mask_bits(x + m, ~m);
1246 }
1247 
1248 // returns integer round-down to the nearest multiple of s (s must be a power of two)
1249 inline intptr_t round_down(intptr_t x, uintx s) {
1250   #ifdef ASSERT
1251     if (!is_power_of_2(s)) basic_fatal("s must be a power of 2");
1252   #endif
1253   const uintx m = s - 1;
1254   return mask_bits(x, ~m);
1255 }
1256 
1257 
1258 inline bool is_odd (intx x) { return x &amp; 1;      }
1259 inline bool is_even(intx x) { return !is_odd(x); }
1260 
1261 // "to" should be greater than "from."
1262 inline intx byte_size(void* from, void* to) {
1263   return (address)to - (address)from;
1264 }
1265 
1266 //----------------------------------------------------------------------------------------------------
1267 // Avoid non-portable casts with these routines (DEPRECATED)
1268 
1269 // NOTE: USE Bytes class INSTEAD WHERE POSSIBLE
1270 //       Bytes is optimized machine-specifically and may be much faster then the portable routines below.
1271 
1272 // Given sequence of four bytes, build into a 32-bit word
1273 // following the conventions used in class files.
1274 // On the 386, this could be realized with a simple address cast.
1275 //
1276 
1277 // This routine takes eight bytes:
1278 inline u8 build_u8_from( u1 c1, u1 c2, u1 c3, u1 c4, u1 c5, u1 c6, u1 c7, u1 c8 ) {
1279   return  (( u8(c1) &lt;&lt; 56 )  &amp;  ( u8(0xff) &lt;&lt; 56 ))
1280        |  (( u8(c2) &lt;&lt; 48 )  &amp;  ( u8(0xff) &lt;&lt; 48 ))
1281        |  (( u8(c3) &lt;&lt; 40 )  &amp;  ( u8(0xff) &lt;&lt; 40 ))
1282        |  (( u8(c4) &lt;&lt; 32 )  &amp;  ( u8(0xff) &lt;&lt; 32 ))
1283        |  (( u8(c5) &lt;&lt; 24 )  &amp;  ( u8(0xff) &lt;&lt; 24 ))
1284        |  (( u8(c6) &lt;&lt; 16 )  &amp;  ( u8(0xff) &lt;&lt; 16 ))
1285        |  (( u8(c7) &lt;&lt;  8 )  &amp;  ( u8(0xff) &lt;&lt;  8 ))
1286        |  (( u8(c8) &lt;&lt;  0 )  &amp;  ( u8(0xff) &lt;&lt;  0 ));
1287 }
1288 
1289 // This routine takes four bytes:
1290 inline u4 build_u4_from( u1 c1, u1 c2, u1 c3, u1 c4 ) {
1291   return  (( u4(c1) &lt;&lt; 24 )  &amp;  0xff000000)
1292        |  (( u4(c2) &lt;&lt; 16 )  &amp;  0x00ff0000)
1293        |  (( u4(c3) &lt;&lt;  8 )  &amp;  0x0000ff00)
1294        |  (( u4(c4) &lt;&lt;  0 )  &amp;  0x000000ff);
1295 }
1296 
1297 // And this one works if the four bytes are contiguous in memory:
1298 inline u4 build_u4_from( u1* p ) {
1299   return  build_u4_from( p[0], p[1], p[2], p[3] );
1300 }
1301 
1302 // Ditto for two-byte ints:
1303 inline u2 build_u2_from( u1 c1, u1 c2 ) {
1304   return  u2((( u2(c1) &lt;&lt;  8 )  &amp;  0xff00)
1305           |  (( u2(c2) &lt;&lt;  0 )  &amp;  0x00ff));
1306 }
1307 
1308 // And this one works if the two bytes are contiguous in memory:
1309 inline u2 build_u2_from( u1* p ) {
1310   return  build_u2_from( p[0], p[1] );
1311 }
1312 
1313 // Ditto for floats:
1314 inline jfloat build_float_from( u1 c1, u1 c2, u1 c3, u1 c4 ) {
1315   u4 u = build_u4_from( c1, c2, c3, c4 );
1316   return  *(jfloat*)&amp;u;
1317 }
1318 
1319 inline jfloat build_float_from( u1* p ) {
1320   u4 u = build_u4_from( p );
1321   return  *(jfloat*)&amp;u;
1322 }
1323 
1324 
1325 // now (64-bit) longs
1326 
1327 inline jlong build_long_from( u1 c1, u1 c2, u1 c3, u1 c4, u1 c5, u1 c6, u1 c7, u1 c8 ) {
1328   return  (( jlong(c1) &lt;&lt; 56 )  &amp;  ( jlong(0xff) &lt;&lt; 56 ))
1329        |  (( jlong(c2) &lt;&lt; 48 )  &amp;  ( jlong(0xff) &lt;&lt; 48 ))
1330        |  (( jlong(c3) &lt;&lt; 40 )  &amp;  ( jlong(0xff) &lt;&lt; 40 ))
1331        |  (( jlong(c4) &lt;&lt; 32 )  &amp;  ( jlong(0xff) &lt;&lt; 32 ))
1332        |  (( jlong(c5) &lt;&lt; 24 )  &amp;  ( jlong(0xff) &lt;&lt; 24 ))
1333        |  (( jlong(c6) &lt;&lt; 16 )  &amp;  ( jlong(0xff) &lt;&lt; 16 ))
1334        |  (( jlong(c7) &lt;&lt;  8 )  &amp;  ( jlong(0xff) &lt;&lt;  8 ))
1335        |  (( jlong(c8) &lt;&lt;  0 )  &amp;  ( jlong(0xff) &lt;&lt;  0 ));
1336 }
1337 
1338 inline jlong build_long_from( u1* p ) {
1339   return  build_long_from( p[0], p[1], p[2], p[3], p[4], p[5], p[6], p[7] );
1340 }
1341 
1342 
1343 // Doubles, too!
1344 inline jdouble build_double_from( u1 c1, u1 c2, u1 c3, u1 c4, u1 c5, u1 c6, u1 c7, u1 c8 ) {
1345   jlong u = build_long_from( c1, c2, c3, c4, c5, c6, c7, c8 );
1346   return  *(jdouble*)&amp;u;
1347 }
1348 
1349 inline jdouble build_double_from( u1* p ) {
1350   jlong u = build_long_from( p );
1351   return  *(jdouble*)&amp;u;
1352 }
1353 
1354 
1355 // Portable routines to go the other way:
1356 
1357 inline void explode_short_to( u2 x, u1&amp; c1, u1&amp; c2 ) {
1358   c1 = u1(x &gt;&gt; 8);
1359   c2 = u1(x);
1360 }
1361 
1362 inline void explode_short_to( u2 x, u1* p ) {
1363   explode_short_to( x, p[0], p[1]);
1364 }
1365 
1366 inline void explode_int_to( u4 x, u1&amp; c1, u1&amp; c2, u1&amp; c3, u1&amp; c4 ) {
1367   c1 = u1(x &gt;&gt; 24);
1368   c2 = u1(x &gt;&gt; 16);
1369   c3 = u1(x &gt;&gt;  8);
1370   c4 = u1(x);
1371 }
1372 
1373 inline void explode_int_to( u4 x, u1* p ) {
1374   explode_int_to( x, p[0], p[1], p[2], p[3]);
1375 }
1376 
1377 
1378 // Pack and extract shorts to/from ints:
1379 
1380 inline int extract_low_short_from_int(jint x) {
1381   return x &amp; 0xffff;
1382 }
1383 
1384 inline int extract_high_short_from_int(jint x) {
1385   return (x &gt;&gt; 16) &amp; 0xffff;
1386 }
1387 
1388 inline int build_int_from_shorts( jushort low, jushort high ) {
1389   return ((int)((unsigned int)high &lt;&lt; 16) | (unsigned int)low);
1390 }
1391 
1392 // Convert pointer to intptr_t, for use in printing pointers.
1393 inline intptr_t p2i(const void * p) {
1394   return (intptr_t) p;
1395 }
1396 
1397 // swap a &amp; b
1398 template&lt;class T&gt; static void swap(T&amp; a, T&amp; b) {
1399   T tmp = a;
1400   a = b;
1401   b = tmp;
1402 }
1403 
1404 // Printf-style formatters for fixed- and variable-width types as pointers and
1405 // integers.  These are derived from the definitions in inttypes.h.  If the platform
1406 // doesn't provide appropriate definitions, they should be provided in
1407 // the compiler-specific definitions file (e.g., globalDefinitions_gcc.hpp)
1408 
1409 #define BOOL_TO_STR(_b_) ((_b_) ? "true" : "false")
1410 
1411 // Format 32-bit quantities.
1412 #define INT32_FORMAT           "%" PRId32
1413 #define UINT32_FORMAT          "%" PRIu32
1414 #define INT32_FORMAT_W(width)  "%" #width PRId32
1415 #define UINT32_FORMAT_W(width) "%" #width PRIu32
1416 
1417 #define PTR32_FORMAT           "0x%08" PRIx32
1418 #define PTR32_FORMAT_W(width)  "0x%" #width PRIx32
1419 
1420 // Format 64-bit quantities.
1421 #define INT64_FORMAT           "%" PRId64
1422 #define UINT64_FORMAT          "%" PRIu64
1423 #define UINT64_FORMAT_X        "%" PRIx64
1424 #define INT64_FORMAT_W(width)  "%" #width PRId64
1425 #define UINT64_FORMAT_W(width) "%" #width PRIu64
1426 
1427 #define PTR64_FORMAT           "0x%016" PRIx64
1428 
1429 // Format jlong, if necessary
1430 #ifndef JLONG_FORMAT
1431 #define JLONG_FORMAT           INT64_FORMAT
1432 #endif
1433 #ifndef JULONG_FORMAT
1434 #define JULONG_FORMAT          UINT64_FORMAT
1435 #endif
1436 #ifndef JULONG_FORMAT_X
1437 #define JULONG_FORMAT_X        UINT64_FORMAT_X
1438 #endif
1439 
1440 // Format pointers which change size between 32- and 64-bit.
1441 #ifdef  _LP64
1442 #define INTPTR_FORMAT "0x%016" PRIxPTR
1443 #define PTR_FORMAT    "0x%016" PRIxPTR
1444 #else   // !_LP64
1445 #define INTPTR_FORMAT "0x%08"  PRIxPTR
1446 #define PTR_FORMAT    "0x%08"  PRIxPTR
1447 #endif  // _LP64
1448 
1449 #define INTPTR_FORMAT_W(width)   "%" #width PRIxPTR
1450 
1451 #define SSIZE_FORMAT             "%"   PRIdPTR
1452 #define SIZE_FORMAT              "%"   PRIuPTR
1453 #define SIZE_FORMAT_HEX          "0x%" PRIxPTR
1454 #define SSIZE_FORMAT_W(width)    "%"   #width PRIdPTR
1455 #define SIZE_FORMAT_W(width)     "%"   #width PRIuPTR
1456 #define SIZE_FORMAT_HEX_W(width) "0x%" #width PRIxPTR
1457 
1458 #define INTX_FORMAT           "%" PRIdPTR
1459 #define UINTX_FORMAT          "%" PRIuPTR
1460 #define INTX_FORMAT_W(width)  "%" #width PRIdPTR
1461 #define UINTX_FORMAT_W(width) "%" #width PRIuPTR
1462 
1463 
1464 #define ARRAY_SIZE(array) (sizeof(array)/sizeof((array)[0]))
1465 
1466 //----------------------------------------------------------------------------------------------------
1467 // Sum and product which can never overflow: they wrap, just like the
1468 // Java operations.  Note that we don't intend these to be used for
1469 // general-purpose arithmetic: their purpose is to emulate Java
1470 // operations.
1471 
1472 // The goal of this code to avoid undefined or implementation-defined
1473 // behavior.  The use of an lvalue to reference cast is explicitly
1474 // permitted by Lvalues and rvalues [basic.lval].  [Section 3.10 Para
1475 // 15 in C++03]
1476 #define JAVA_INTEGER_OP(OP, NAME, TYPE, UNSIGNED_TYPE)  \
1477 inline TYPE NAME (TYPE in1, TYPE in2) {                 \
1478   UNSIGNED_TYPE ures = static_cast&lt;UNSIGNED_TYPE&gt;(in1); \
1479   ures OP ## = static_cast&lt;UNSIGNED_TYPE&gt;(in2);         \
1480   return reinterpret_cast&lt;TYPE&amp;&gt;(ures);                 \
1481 }
1482 
1483 JAVA_INTEGER_OP(+, java_add, jint, juint)
1484 JAVA_INTEGER_OP(-, java_subtract, jint, juint)
1485 JAVA_INTEGER_OP(*, java_multiply, jint, juint)
1486 JAVA_INTEGER_OP(+, java_add, jlong, julong)
1487 JAVA_INTEGER_OP(-, java_subtract, jlong, julong)
1488 JAVA_INTEGER_OP(*, java_multiply, jlong, julong)
1489 
1490 #undef JAVA_INTEGER_OP
1491 
1492 // Dereference vptr
1493 // All C++ compilers that we know of have the vtbl pointer in the first
1494 // word.  If there are exceptions, this function needs to be made compiler
1495 // specific.
1496 static inline void* dereference_vptr(const void* addr) {
1497   return *(void**)addr;
1498 }
1499 
1500 #endif // SHARE_VM_UTILITIES_GLOBALDEFINITIONS_HPP
</pre></body></html>
