<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>open Udiff test/hotspot/jtreg/compiler/jvmci/compilerToVM/MaterializeVirtualObjectTest.java</title>

<style type="text/css" media="screen">
span.new {
    color: blue;
    font-weight: normal;
}
</style>

</head>
<body id="SUNWwebrev">
<center><a href='../../../../../../src/hotspot/share/jvmci/jvmciCompilerToVM.cpp.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> next &gt</center>
<h2>test/hotspot/jtreg/compiler/jvmci/compilerToVM/MaterializeVirtualObjectTest.java</h2>
        <a class="print" href="javascript:print()">Print this page</a>
<pre></pre>
        <pre>
</pre><hr /><pre>
<span class="newmarker">@@ -45,10 +45,11 @@</span>
  *                   -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI
  *                   -XX:CompileCommand=exclude,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::check
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame2
  *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::recurse
<span class="new">+ *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame3</span>
  *                   -XX:+DoEscapeAnalysis -XX:-UseCounterDecay
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.materializeFirst=true
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.invalidate=false
  *                   compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest
  * @run main/othervm -Xmixed -Xbatch -Xbootclasspath/a:.
</pre><hr /><pre>
<span class="newmarker">@@ -56,10 +57,11 @@</span>
  *                   -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI
  *                   -XX:CompileCommand=exclude,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::check
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame2
  *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::recurse
<span class="new">+ *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame3</span>
  *                   -XX:+DoEscapeAnalysis -XX:-UseCounterDecay
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.materializeFirst=false
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.invalidate=false
  *                   compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest
  * @run main/othervm -Xmixed -Xbatch -Xbootclasspath/a:.
</pre><hr /><pre>
<span class="newmarker">@@ -67,10 +69,11 @@</span>
  *                   -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI
  *                   -XX:CompileCommand=exclude,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::check
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame2
  *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::recurse
<span class="new">+ *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame3</span>
  *                   -XX:+DoEscapeAnalysis -XX:-UseCounterDecay
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.materializeFirst=true
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.invalidate=true
  *                   compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest
  * @run main/othervm -Xmixed -Xbatch -Xbootclasspath/a:.
</pre><hr /><pre>
<span class="newmarker">@@ -78,10 +81,11 @@</span>
  *                   -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI
  *                   -XX:CompileCommand=exclude,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::check
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame
  *                   -XX:CompileCommand=dontinline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame2
  *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::recurse
<span class="new">+ *                   -XX:CompileCommand=inline,compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest::testFrame3</span>
  *                   -XX:+DoEscapeAnalysis -XX:-UseCounterDecay
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.materializeFirst=false
  *                   -Dcompiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.invalidate=true
  *                   compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest
  */
</pre><hr /><pre>
<span class="newmarker">@@ -105,12 +109,15 @@</span>
     private static final WhiteBox WB;
     private static final boolean INVALIDATE;
     private static final int COMPILE_THRESHOLD;
     private static final Method MATERIALIZED_METHOD;
     private static final Method NOT_MATERIALIZED_METHOD;
<span class="new">+    private static final Method FRAME3_METHOD;</span>
     private static final ResolvedJavaMethod MATERIALIZED_RESOLVED;
     private static final ResolvedJavaMethod NOT_MATERIALIZED_RESOLVED;
<span class="new">+    private static final ResolvedJavaMethod FRAME2_RESOLVED;</span>
<span class="new">+    private static final ResolvedJavaMethod FRAME3_RESOLVED;</span>
     private static final boolean MATERIALIZE_FIRST;
 
     static {
         Method method1;
         Method method2;
</pre><hr /><pre>
<span class="newmarker">@@ -118,26 +125,28 @@</span>
         try {
             method1 = MaterializeVirtualObjectTest.class.getDeclaredMethod("testFrame",
                     String.class, int.class);
             method2 = MaterializeVirtualObjectTest.class.getDeclaredMethod("testFrame2",
                     String.class, int.class);
<span class="new">+            FRAME3_METHOD = MaterializeVirtualObjectTest.class.getDeclaredMethod("testFrame3",</span>
<span class="new">+                    Helper.class, int.class);</span>
         } catch (NoSuchMethodException e) {
             throw new Error("Can't get executable for test method", e);
         }
         ResolvedJavaMethod resolved1;
<span class="removed">-        ResolvedJavaMethod resolved2;</span>
         resolved1 = CTVMUtilities.getResolvedMethod(method1);
<span class="removed">-        resolved2 = CTVMUtilities.getResolvedMethod(method2);</span>
<span class="new">+        FRAME2_RESOLVED = CTVMUtilities.getResolvedMethod(method2);</span>
<span class="new">+        FRAME3_RESOLVED = CTVMUtilities.getResolvedMethod(FRAME3_METHOD);</span>
         INVALIDATE = Boolean.getBoolean(
                 "compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.invalidate");
         COMPILE_THRESHOLD = WB.getBooleanVMFlag("TieredCompilation")
                 ? CompilerWhiteBoxTest.THRESHOLD
                 : CompilerWhiteBoxTest.THRESHOLD * 2;
         MATERIALIZE_FIRST = Boolean.getBoolean(
                 "compiler.jvmci.compilerToVM.MaterializeVirtualObjectTest.materializeFirst");
<span class="removed">-        MATERIALIZED_RESOLVED = MATERIALIZE_FIRST ? resolved1 : resolved2;</span>
<span class="removed">-        NOT_MATERIALIZED_RESOLVED = MATERIALIZE_FIRST ? resolved2 : resolved1;</span>
<span class="new">+        MATERIALIZED_RESOLVED = MATERIALIZE_FIRST ? resolved1 : FRAME2_RESOLVED;</span>
<span class="new">+        NOT_MATERIALIZED_RESOLVED = MATERIALIZE_FIRST ? FRAME2_RESOLVED : resolved1;</span>
         MATERIALIZED_METHOD = MATERIALIZE_FIRST ? method1 : method2;
         NOT_MATERIALIZED_METHOD = MATERIALIZE_FIRST ? method2 : method1;
     }
 
     public static void main(String[] args) {
</pre><hr /><pre>
<span class="newmarker">@@ -169,10 +178,20 @@</span>
         Asserts.assertTrue(WB.isMethodCompiled(MATERIALIZED_METHOD), getName()
                 + " : materialized method not compiled");
         Asserts.assertTrue(WB.isMethodCompiled(NOT_MATERIALIZED_METHOD),
                 getName() + " : not materialized method not compiled");
         testFrame("someString", /* materialize */ CompilerWhiteBoxTest.THRESHOLD);
<span class="new">+</span>
<span class="new">+        // run second test types</span>
<span class="new">+        for (int i = 0; i &lt; CompilerWhiteBoxTest.THRESHOLD; i++) {</span>
<span class="new">+            testFrame("someString", i);</span>
<span class="new">+        }</span>
<span class="new">+        Asserts.assertTrue(WB.isMethodCompiled(MATERIALIZED_METHOD), getName()</span>
<span class="new">+                + " : materialized method not compiled");</span>
<span class="new">+        Asserts.assertTrue(WB.isMethodCompiled(NOT_MATERIALIZED_METHOD),</span>
<span class="new">+                getName() + " : not materialized method not compiled");</span>
<span class="new">+        testFrame("someString", /* materialize */ CompilerWhiteBoxTest.THRESHOLD + 1);</span>
     }
 
     private void testFrame(String str, int iteration) {
         Helper helper = new Helper(str);
         testFrame2(str, iteration);
</pre><hr /><pre>
<span class="newmarker">@@ -180,13 +199,25 @@</span>
                 &amp;&amp; (helper != null), String.format("%s : some locals are null", getName()));
      }
 
     private void testFrame2(String str, int iteration) {
         Helper helper = new Helper(str);
<span class="removed">-        recurse(2, iteration);</span>
<span class="removed">-        Asserts.assertTrue((helper.string != null) &amp;&amp; (this != null)</span>
<span class="new">+        Helper helper2 = new Helper("bar");</span>
<span class="new">+        testFrame3(helper, iteration);</span>
<span class="new">+        Asserts.assertTrue((helper.string != null) &amp;&amp; (this != null) &amp;&amp; helper.string == str</span>
                 &amp;&amp; (helper != null), String.format("%s : some locals are null", getName()));
<span class="new">+        Asserts.assertTrue((helper2.string != null) &amp;&amp; (this != null)</span>
<span class="new">+                &amp;&amp; (helper2 != null), String.format("%s : some locals are null", getName()));</span>
<span class="new">+    }</span>
<span class="new">+</span>
<span class="new">+    private void testFrame3(Helper outerHelper, int iteration) {</span>
<span class="new">+        Helper innerHelper = new Helper("foo");</span>
<span class="new">+        recurse(2, iteration);</span>
<span class="new">+        Asserts.assertTrue((innerHelper.string != null) &amp;&amp; (this != null)</span>
<span class="new">+                &amp;&amp; (innerHelper != null), String.format("%s : some locals are null", getName()));</span>
<span class="new">+        Asserts.assertTrue((outerHelper.string != null) &amp;&amp; (this != null)</span>
<span class="new">+                &amp;&amp; (outerHelper != null), String.format("%s : some locals are null", getName()));</span>
     }
 
     private void recurse(int depth, int iteration) {
         if (depth == 0) {
             check(iteration);
</pre><hr /><pre>
<span class="newmarker">@@ -196,10 +227,52 @@</span>
             Asserts.assertEQ(s.intValue(), depth,
                     String.format("different values: %s != %s", s.intValue(), depth));
         }
     }
 
<span class="new">+    private void checkStructure(boolean materialize) {</span>
<span class="new">+        boolean[] framesSeen = new boolean[2];</span>
<span class="new">+        Object[] helpers = new Object[1];</span>
<span class="new">+        CompilerToVMHelper.iterateFrames(</span>
<span class="new">+            new ResolvedJavaMethod[] {FRAME3_RESOLVED},</span>
<span class="new">+            null, /* any */</span>
<span class="new">+            0,</span>
<span class="new">+            f -&gt; {</span>
<span class="new">+                if (!framesSeen[1]) {</span>
<span class="new">+                    Asserts.assertTrue(f.isMethod(FRAME3_RESOLVED),</span>
<span class="new">+                            "Expected testFrame3 first");</span>
<span class="new">+                    framesSeen[1] = true;</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(0) != null, "this should not be null");</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(1) != null, "outerHelper should not be null");</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(3) != null, "innerHelper should not be null");</span>
<span class="new">+                    Asserts.assertEQ(((Helper) f.getLocal(3)).string, "foo", "innerHelper.string should be foo");</span>
<span class="new">+                    helpers[0] = f.getLocal(1);</span>
<span class="new">+                    if (materialize) {</span>
<span class="new">+                        f.materializeVirtualObjects(false);</span>
<span class="new">+                    }</span>
<span class="new">+                    return null; //continue</span>
<span class="new">+                } else {</span>
<span class="new">+                    Asserts.assertFalse(framesSeen[0], "frame3 can not have been seen");</span>
<span class="new">+                    Asserts.assertTrue(f.isMethod(FRAME2_RESOLVED),</span>
<span class="new">+                            "Expected testFrame2 second");</span>
<span class="new">+                    framesSeen[0] = true;</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(0) != null, "this should not be null");</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(1) != null, "str should not be null");</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(3) != null, "helper should not be null");</span>
<span class="new">+                    Asserts.assertTrue(f.getLocal(4) != null, "helper2 should not be null");</span>
<span class="new">+                    Asserts.assertEQ(((Helper) f.getLocal(3)).string, f.getLocal(1), "helper.string should be the same as str");</span>
<span class="new">+                    Asserts.assertEQ(((Helper) f.getLocal(4)).string, "bar", "helper2.string should be foo");</span>
<span class="new">+                    if (!materialize) {</span>
<span class="new">+                        Asserts.assertEQ(f.getLocal(3), helpers[0], "helper should be the same as frame3's outerHelper");</span>
<span class="new">+                    }</span>
<span class="new">+                    return f; // stop</span>
<span class="new">+                }</span>
<span class="new">+            });</span>
<span class="new">+        Asserts.assertTrue(framesSeen[1], "frame3 should have been seen");</span>
<span class="new">+        Asserts.assertTrue(framesSeen[0], "frame2 should have been seen");</span>
<span class="new">+    }</span>
<span class="new">+</span>
     private void check(int iteration) {
         // Materialize virtual objects on last invocation
         if (iteration == COMPILE_THRESHOLD) {
             // get frames and check not-null
             HotSpotStackFrameReference materialized = CompilerToVMHelper.iterateFrames(
</pre><hr /><pre>
<span class="newmarker">@@ -242,10 +315,13 @@</span>
             Asserts.assertEQ(WB.isMethodCompiled(MATERIALIZED_METHOD), !INVALIDATE, getName()
                     + " : materialized method has unexpected compiled status");
             // check that not materialized frame wasn't deoptimized
             Asserts.assertTrue(WB.isMethodCompiled(NOT_MATERIALIZED_METHOD), getName()
                     + " : not materialized method has unexpected compiled status");
<span class="new">+        } else if (iteration == COMPILE_THRESHOLD + 1) {</span>
<span class="new">+            checkStructure(false);</span>
<span class="new">+            checkStructure(true);</span>
         }
     }
 
     private class Helper {
         public String string;
</pre>
<center><a href='../../../../../../src/hotspot/share/jvmci/jvmciCompilerToVM.cpp.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> next &gt</center>
</body></html>

