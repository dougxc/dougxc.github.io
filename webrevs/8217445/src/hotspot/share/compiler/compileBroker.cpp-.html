<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/hotspot/share/compiler/compileBroker.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "classfile/symbolTable.hpp"
  28 #include "classfile/systemDictionary.hpp"
  29 #include "classfile/vmSymbols.hpp"
  30 #include "code/codeCache.hpp"
  31 #include "code/codeHeapState.hpp"
  32 #include "code/dependencyContext.hpp"
  33 #include "compiler/compileBroker.hpp"
  34 #include "compiler/compileLog.hpp"
  35 #include "compiler/compilerOracle.hpp"
  36 #include "compiler/directivesParser.hpp"
  37 #include "interpreter/linkResolver.hpp"
  38 #include "jfr/jfrEvents.hpp"
  39 #include "logging/log.hpp"
  40 #include "logging/logStream.hpp"
  41 #include "memory/allocation.inline.hpp"
  42 #include "memory/resourceArea.hpp"
  43 #include "oops/methodData.hpp"
  44 #include "oops/method.inline.hpp"
  45 #include "oops/oop.inline.hpp"
  46 #include "prims/nativeLookup.hpp"
  47 #include "prims/whitebox.hpp"
  48 #include "runtime/arguments.hpp"
  49 #include "runtime/atomic.hpp"
  50 #include "runtime/compilationPolicy.hpp"
  51 #include "runtime/init.hpp"
  52 #include "runtime/interfaceSupport.inline.hpp"
  53 #include "runtime/javaCalls.hpp"
  54 #include "runtime/jniHandles.inline.hpp"
  55 #include "runtime/os.hpp"
  56 #include "runtime/safepointVerifiers.hpp"
  57 #include "runtime/sharedRuntime.hpp"
  58 #include "runtime/sweeper.hpp"
  59 #include "runtime/timerTrace.hpp"
  60 #include "runtime/vframe.inline.hpp"
  61 #include "utilities/debug.hpp"
  62 #include "utilities/dtrace.hpp"
  63 #include "utilities/events.hpp"
  64 #include "utilities/formatBuffer.hpp"
  65 #include "utilities/macros.hpp"
  66 #ifdef COMPILER1
  67 #include "c1/c1_Compiler.hpp"
  68 #endif
  69 #if INCLUDE_JVMCI
  70 #include "jvmci/jvmciCompiler.hpp"
  71 #include "jvmci/jvmciRuntime.hpp"
  72 #include "jvmci/jvmciJavaClasses.hpp"
  73 #include "runtime/vframe.hpp"
  74 #endif
  75 #ifdef COMPILER2
  76 #include "opto/c2compiler.hpp"
  77 #endif
  78 
  79 #ifdef DTRACE_ENABLED
  80 
  81 // Only bother with this argument setup if dtrace is available
  82 
  83 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  84   {                                                                      \
  85     Symbol* klass_name = (method)-&gt;klass_name();                         \
  86     Symbol* name = (method)-&gt;name();                                     \
  87     Symbol* signature = (method)-&gt;signature();                           \
  88     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  89       (char *) comp_name, strlen(comp_name),                             \
  90       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  91       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  92       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  93   }
  94 
  95 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  96   {                                                                      \
  97     Symbol* klass_name = (method)-&gt;klass_name();                         \
  98     Symbol* name = (method)-&gt;name();                                     \
  99     Symbol* signature = (method)-&gt;signature();                           \
 100     HOTSPOT_METHOD_COMPILE_END(                                          \
 101       (char *) comp_name, strlen(comp_name),                             \
 102       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
 103       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
 104       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
 105   }
 106 
 107 #else //  ndef DTRACE_ENABLED
 108 
 109 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 110 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 111 
 112 #endif // ndef DTRACE_ENABLED
 113 
 114 bool CompileBroker::_initialized = false;
 115 volatile bool CompileBroker::_should_block = false;
 116 volatile int  CompileBroker::_print_compilation_warning = 0;
 117 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 118 
 119 // The installed compiler(s)
 120 AbstractCompiler* CompileBroker::_compilers[2];
 121 
 122 // The maximum numbers of compiler threads to be determined during startup.
 123 int CompileBroker::_c1_count = 0;
 124 int CompileBroker::_c2_count = 0;
 125 
 126 // An array of compiler names as Java String objects
 127 jobject* CompileBroker::_compiler1_objects = NULL;
 128 jobject* CompileBroker::_compiler2_objects = NULL;
 129 
 130 CompileLog** CompileBroker::_compiler1_logs = NULL;
 131 CompileLog** CompileBroker::_compiler2_logs = NULL;
 132 
 133 // These counters are used to assign an unique ID to each compilation.
 134 volatile jint CompileBroker::_compilation_id     = 0;
 135 volatile jint CompileBroker::_osr_compilation_id = 0;
 136 
 137 // Debugging information
 138 int  CompileBroker::_last_compile_type     = no_compile;
 139 int  CompileBroker::_last_compile_level    = CompLevel_none;
 140 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 141 
 142 // Performance counters
 143 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 144 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 145 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 146 
 147 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 148 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 149 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 150 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 151 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 152 
 153 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 154 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 155 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 156 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 157 
 158 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 159 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 160 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 161 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 162 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 163 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 164 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 165 
 166 // Timers and counters for generating statistics
 167 elapsedTimer CompileBroker::_t_total_compilation;
 168 elapsedTimer CompileBroker::_t_osr_compilation;
 169 elapsedTimer CompileBroker::_t_standard_compilation;
 170 elapsedTimer CompileBroker::_t_invalidated_compilation;
 171 elapsedTimer CompileBroker::_t_bailedout_compilation;
 172 
 173 int CompileBroker::_total_bailout_count            = 0;
 174 int CompileBroker::_total_invalidated_count        = 0;
 175 int CompileBroker::_total_compile_count            = 0;
 176 int CompileBroker::_total_osr_compile_count        = 0;
 177 int CompileBroker::_total_standard_compile_count   = 0;
 178 int CompileBroker::_total_compiler_stopped_count   = 0;
 179 int CompileBroker::_total_compiler_restarted_count = 0;
 180 
 181 int CompileBroker::_sum_osr_bytes_compiled         = 0;
 182 int CompileBroker::_sum_standard_bytes_compiled    = 0;
 183 int CompileBroker::_sum_nmethod_size               = 0;
 184 int CompileBroker::_sum_nmethod_code_size          = 0;
 185 
 186 long CompileBroker::_peak_compilation_time         = 0;
 187 
 188 CompileQueue* CompileBroker::_c2_compile_queue     = NULL;
 189 CompileQueue* CompileBroker::_c1_compile_queue     = NULL;
 190 
 191 
 192 
 193 class CompilationLog : public StringEventLog {
 194  public:
 195   CompilationLog() : StringEventLog("Compilation events") {
 196   }
 197 
 198   void log_compile(JavaThread* thread, CompileTask* task) {
 199     StringLogMessage lm;
 200     stringStream sstr = lm.stream();
 201     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 202     task-&gt;print(&amp;sstr, NULL, true, false);
 203     log(thread, "%s", (const char*)lm);
 204   }
 205 
 206   void log_nmethod(JavaThread* thread, nmethod* nm) {
 207     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 208         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 209         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 210   }
 211 
 212   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 213     StringLogMessage lm;
 214     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 215     if (retry_message != NULL) {
 216       lm.append(" (%s)", retry_message);
 217     }
 218     lm.print("\n");
 219     log(thread, "%s", (const char*)lm);
 220   }
 221 
 222   void log_metaspace_failure(const char* reason) {
 223     ResourceMark rm;
 224     StringLogMessage lm;
 225     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 226     lm.print("\n");
 227     log(JavaThread::current(), "%s", (const char*)lm);
 228   }
 229 };
 230 
 231 static CompilationLog* _compilation_log = NULL;
 232 
 233 bool compileBroker_init() {
 234   if (LogEvents) {
 235     _compilation_log = new CompilationLog();
 236   }
 237 
 238   // init directives stack, adding default directive
 239   DirectivesStack::init();
 240 
 241   if (DirectivesParser::has_file()) {
 242     return DirectivesParser::parse_from_flag();
 243   } else if (CompilerDirectivesPrint) {
 244     // Print default directive even when no other was added
 245     DirectivesStack::print(tty);
 246   }
 247 
 248   return true;
 249 }
 250 
 251 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 252   CompilerThread* thread = CompilerThread::current();
 253   thread-&gt;set_task(task);
 254 #if INCLUDE_JVMCI
 255   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 256     task-&gt;set_jvmci_compiler_thread(thread);
 257   }
 258 #endif
 259   CompileLog*     log  = thread-&gt;log();
 260   if (log != NULL)  task-&gt;log_task_start(log);
 261 }
 262 
 263 CompileTaskWrapper::~CompileTaskWrapper() {
 264   CompilerThread* thread = CompilerThread::current();
 265   CompileTask* task = thread-&gt;task();
 266   CompileLog*  log  = thread-&gt;log();
 267   if (log != NULL)  task-&gt;log_task_done(log);
 268   thread-&gt;set_task(NULL);
 269   task-&gt;set_code_handle(NULL);
 270   thread-&gt;set_env(NULL);
 271   if (task-&gt;is_blocking()) {
 272     bool free_task = false;
 273     {
 274       MutexLocker notifier(task-&gt;lock(), thread);
 275       task-&gt;mark_complete();
 276 #if INCLUDE_JVMCI
 277       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 278         if (!task-&gt;has_waiter()) {
 279           // The waiting thread timed out and thus did not free the task.
 280           free_task = true;
 281         }
 282         task-&gt;set_jvmci_compiler_thread(NULL);
 283       }
 284 #endif
 285       if (!free_task) {
 286         // Notify the waiting thread that the compilation has completed
 287         // so that it can free the task.
 288         task-&gt;lock()-&gt;notify_all();
 289       }
 290     }
 291     if (free_task) {
 292       // The task can only be freed once the task lock is released.
 293       CompileTask::free(task);
 294     }
 295   } else {
 296     task-&gt;mark_complete();
 297 
 298     // By convention, the compiling thread is responsible for
 299     // recycling a non-blocking CompileTask.
 300     CompileTask::free(task);
 301   }
 302 }
 303 
 304 /**
 305  * Check if a CompilerThread can be removed and update count if requested.
 306  */
 307 static bool can_remove(CompilerThread *ct, bool do_it) {
 308   assert(UseDynamicNumberOfCompilerThreads, "or shouldn't be here");
 309   if (!ReduceNumberOfCompilerThreads) return false;
 310 
 311   AbstractCompiler *compiler = ct-&gt;compiler();
 312   int compiler_count = compiler-&gt;num_compiler_threads();
 313   bool c1 = compiler-&gt;is_c1();
 314 
 315   // Keep at least 1 compiler thread of each type.
 316   if (compiler_count &lt; 2) return false;
 317 
 318   // Keep thread alive for at least some time.
 319   if (ct-&gt;idle_time_millis() &lt; (c1 ? 500 : 100)) return false;
 320 
 321   // We only allow the last compiler thread of each type to get removed.
 322   jobject last_compiler = c1 ? CompileBroker::compiler1_object(compiler_count - 1)
 323                              : CompileBroker::compiler2_object(compiler_count - 1);
 324   if (oopDesc::equals(ct-&gt;threadObj(), JNIHandles::resolve_non_null(last_compiler))) {
 325     if (do_it) {
 326       assert_locked_or_safepoint(CompileThread_lock); // Update must be consistent.
 327       compiler-&gt;set_num_compiler_threads(compiler_count - 1);
 328     }
 329     return true;
 330   }
 331   return false;
 332 }
 333 
 334 /**
 335  * Add a CompileTask to a CompileQueue.
 336  */
 337 void CompileQueue::add(CompileTask* task) {
 338   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 339 
 340   task-&gt;set_next(NULL);
 341   task-&gt;set_prev(NULL);
 342 
 343   if (_last == NULL) {
 344     // The compile queue is empty.
 345     assert(_first == NULL, "queue is empty");
 346     _first = task;
 347     _last = task;
 348   } else {
 349     // Append the task to the queue.
 350     assert(_last-&gt;next() == NULL, "not last");
 351     _last-&gt;set_next(task);
 352     task-&gt;set_prev(_last);
 353     _last = task;
 354   }
 355   ++_size;
 356 
 357   // Mark the method as being in the compile queue.
 358   task-&gt;method()-&gt;set_queued_for_compilation();
 359 
 360   if (CIPrintCompileQueue) {
 361     print_tty();
 362   }
 363 
 364   if (LogCompilation &amp;&amp; xtty != NULL) {
 365     task-&gt;log_task_queued();
 366   }
 367 
 368   // Notify CompilerThreads that a task is available.
 369   MethodCompileQueue_lock-&gt;notify_all();
 370 }
 371 
 372 /**
 373  * Empties compilation queue by putting all compilation tasks onto
 374  * a freelist. Furthermore, the method wakes up all threads that are
 375  * waiting on a compilation task to finish. This can happen if background
 376  * compilation is disabled.
 377  */
 378 void CompileQueue::free_all() {
 379   MutexLocker mu(MethodCompileQueue_lock);
 380   CompileTask* next = _first;
 381 
 382   // Iterate over all tasks in the compile queue
 383   while (next != NULL) {
 384     CompileTask* current = next;
 385     next = current-&gt;next();
 386     {
 387       // Wake up thread that blocks on the compile task.
 388       MutexLocker ct_lock(current-&gt;lock());
 389       current-&gt;lock()-&gt;notify();
 390     }
 391     // Put the task back on the freelist.
 392     CompileTask::free(current);
 393   }
 394   _first = NULL;
 395 
 396   // Wake up all threads that block on the queue.
 397   MethodCompileQueue_lock-&gt;notify_all();
 398 }
 399 
 400 /**
 401  * Get the next CompileTask from a CompileQueue
 402  */
 403 CompileTask* CompileQueue::get() {
 404   // save methods from RedefineClasses across safepoint
 405   // across MethodCompileQueue_lock below.
 406   methodHandle save_method;
 407   methodHandle save_hot_method;
 408 
 409   MutexLocker locker(MethodCompileQueue_lock);
 410   // If _first is NULL we have no more compile jobs. There are two reasons for
 411   // having no compile jobs: First, we compiled everything we wanted. Second,
 412   // we ran out of code cache so compilation has been disabled. In the latter
 413   // case we perform code cache sweeps to free memory such that we can re-enable
 414   // compilation.
 415   while (_first == NULL) {
 416     // Exit loop if compilation is disabled forever
 417     if (CompileBroker::is_compilation_disabled_forever()) {
 418       return NULL;
 419     }
 420 
 421     // If there are no compilation tasks and we can compile new jobs
 422     // (i.e., there is enough free space in the code cache) there is
 423     // no need to invoke the sweeper. As a result, the hotness of methods
 424     // remains unchanged. This behavior is desired, since we want to keep
 425     // the stable state, i.e., we do not want to evict methods from the
 426     // code cache if it is unnecessary.
 427     // We need a timed wait here, since compiler threads can exit if compilation
 428     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 429     // is not critical and we do not want idle compiler threads to wake up too often.
 430     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 431 
 432     if (UseDynamicNumberOfCompilerThreads &amp;&amp; _first == NULL) {
 433       // Still nothing to compile. Give caller a chance to stop this thread.
 434       if (can_remove(CompilerThread::current(), false)) return NULL;
 435     }
 436   }
 437 
 438   if (CompileBroker::is_compilation_disabled_forever()) {
 439     return NULL;
 440   }
 441 
 442   CompileTask* task;
 443   {
 444     NoSafepointVerifier nsv;
 445     task = CompilationPolicy::policy()-&gt;select_task(this);
 446   }
 447 
 448   if (task != NULL) {
 449     // Save method pointers across unlock safepoint.  The task is removed from
 450     // the compilation queue, which is walked during RedefineClasses.
 451     save_method = methodHandle(task-&gt;method());
 452     save_hot_method = methodHandle(task-&gt;hot_method());
 453 
 454     remove(task);
 455     purge_stale_tasks(); // may temporarily release MCQ lock
 456   }
 457 
 458   return task;
 459 }
 460 
 461 // Clean &amp; deallocate stale compile tasks.
 462 // Temporarily releases MethodCompileQueue lock.
 463 void CompileQueue::purge_stale_tasks() {
 464   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 465   if (_first_stale != NULL) {
 466     // Stale tasks are purged when MCQ lock is released,
 467     // but _first_stale updates are protected by MCQ lock.
 468     // Once task processing starts and MCQ lock is released,
 469     // other compiler threads can reuse _first_stale.
 470     CompileTask* head = _first_stale;
 471     _first_stale = NULL;
 472     {
 473       MutexUnlocker ul(MethodCompileQueue_lock);
 474       for (CompileTask* task = head; task != NULL; ) {
 475         CompileTask* next_task = task-&gt;next();
 476         CompileTaskWrapper ctw(task); // Frees the task
 477         task-&gt;set_failure_reason("stale task");
 478         task = next_task;
 479       }
 480     }
 481   }
 482 }
 483 
 484 void CompileQueue::remove(CompileTask* task) {
 485    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 486   if (task-&gt;prev() != NULL) {
 487     task-&gt;prev()-&gt;set_next(task-&gt;next());
 488   } else {
 489     // max is the first element
 490     assert(task == _first, "Sanity");
 491     _first = task-&gt;next();
 492   }
 493 
 494   if (task-&gt;next() != NULL) {
 495     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 496   } else {
 497     // max is the last element
 498     assert(task == _last, "Sanity");
 499     _last = task-&gt;prev();
 500   }
 501   --_size;
 502 }
 503 
 504 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 505   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 506   remove(task);
 507 
 508   // Enqueue the task for reclamation (should be done outside MCQ lock)
 509   task-&gt;set_next(_first_stale);
 510   task-&gt;set_prev(NULL);
 511   _first_stale = task;
 512 }
 513 
 514 // methods in the compile queue need to be marked as used on the stack
 515 // so that they don't get reclaimed by Redefine Classes
 516 void CompileQueue::mark_on_stack() {
 517   CompileTask* task = _first;
 518   while (task != NULL) {
 519     task-&gt;mark_on_stack();
 520     task = task-&gt;next();
 521   }
 522 }
 523 
 524 
 525 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 526   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 527   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 528   return NULL;
 529 }
 530 
 531 void CompileBroker::print_compile_queues(outputStream* st) {
 532   st-&gt;print_cr("Current compiles: ");
 533 
 534   char buf[2000];
 535   int buflen = sizeof(buf);
 536   Threads::print_threads_compiling(st, buf, buflen);
 537 
 538   st-&gt;cr();
 539   if (_c1_compile_queue != NULL) {
 540     _c1_compile_queue-&gt;print(st);
 541   }
 542   if (_c2_compile_queue != NULL) {
 543     _c2_compile_queue-&gt;print(st);
 544   }
 545 }
 546 
 547 void CompileQueue::print(outputStream* st) {
 548   assert_locked_or_safepoint(MethodCompileQueue_lock);
 549   st-&gt;print_cr("%s:", name());
 550   CompileTask* task = _first;
 551   if (task == NULL) {
 552     st-&gt;print_cr("Empty");
 553   } else {
 554     while (task != NULL) {
 555       task-&gt;print(st, NULL, true, true);
 556       task = task-&gt;next();
 557     }
 558   }
 559   st-&gt;cr();
 560 }
 561 
 562 void CompileQueue::print_tty() {
 563   ttyLocker ttyl;
 564   print(tty);
 565 }
 566 
 567 CompilerCounters::CompilerCounters() {
 568   _current_method[0] = '\0';
 569   _compile_type = CompileBroker::no_compile;
 570 }
 571 
 572 // ------------------------------------------------------------------
 573 // CompileBroker::compilation_init
 574 //
 575 // Initialize the Compilation object
 576 void CompileBroker::compilation_init_phase1(TRAPS) {
 577   _last_method_compiled[0] = '\0';
 578 
 579   // No need to initialize compilation system if we do not use it.
 580   if (!UseCompiler) {
 581     return;
 582   }
 583   // Set the interface to the current compiler(s).
 584   _c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 585   _c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 586 
 587 #if INCLUDE_JVMCI
 588   if (EnableJVMCI) {
 589     // This is creating a JVMCICompiler singleton.
 590     JVMCICompiler* jvmci = new JVMCICompiler();
 591 
 592     if (UseJVMCICompiler) {
 593       _compilers[1] = jvmci;
 594       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 595         if (BootstrapJVMCI) {
 596           // JVMCI will bootstrap so give it more threads
 597           _c2_count = MIN2(32, os::active_processor_count());
 598         }
 599       } else {
 600         _c2_count = JVMCIThreads;
 601       }
 602       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 603       } else {
 604         _c1_count = JVMCIHostThreads;
 605       }
 606     }
 607   }
 608 #endif // INCLUDE_JVMCI
 609 
 610 #ifdef COMPILER1
 611   if (_c1_count &gt; 0) {
 612     _compilers[0] = new Compiler();
 613   }
 614 #endif // COMPILER1
 615 
 616 #ifdef COMPILER2
 617   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 618     if (_c2_count &gt; 0) {
 619       _compilers[1] = new C2Compiler();
 620     }
 621   }
 622 #endif // COMPILER2
 623 
 624   // Start the compiler thread(s) and the sweeper thread
 625   init_compiler_sweeper_threads();
 626   // totalTime performance counter is always created as it is required
 627   // by the implementation of java.lang.management.CompilationMBean.
 628   {
 629     EXCEPTION_MARK;
 630     _perf_total_compilation =
 631                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 632                                                  PerfData::U_Ticks, CHECK);
 633   }
 634 
 635   if (UsePerfData) {
 636 
 637     EXCEPTION_MARK;
 638 
 639     // create the jvmstat performance counters
 640     _perf_osr_compilation =
 641                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 642                                                  PerfData::U_Ticks, CHECK);
 643 
 644     _perf_standard_compilation =
 645                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 646                                                  PerfData::U_Ticks, CHECK);
 647 
 648     _perf_total_bailout_count =
 649                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 650                                                  PerfData::U_Events, CHECK);
 651 
 652     _perf_total_invalidated_count =
 653                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 654                                                  PerfData::U_Events, CHECK);
 655 
 656     _perf_total_compile_count =
 657                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 658                                                  PerfData::U_Events, CHECK);
 659     _perf_total_osr_compile_count =
 660                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 661                                                  PerfData::U_Events, CHECK);
 662 
 663     _perf_total_standard_compile_count =
 664                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 665                                                  PerfData::U_Events, CHECK);
 666 
 667     _perf_sum_osr_bytes_compiled =
 668                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 669                                                  PerfData::U_Bytes, CHECK);
 670 
 671     _perf_sum_standard_bytes_compiled =
 672                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 673                                                  PerfData::U_Bytes, CHECK);
 674 
 675     _perf_sum_nmethod_size =
 676                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 677                                                  PerfData::U_Bytes, CHECK);
 678 
 679     _perf_sum_nmethod_code_size =
 680                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 681                                                  PerfData::U_Bytes, CHECK);
 682 
 683     _perf_last_method =
 684                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 685                                        CompilerCounters::cmname_buffer_length,
 686                                        "", CHECK);
 687 
 688     _perf_last_failed_method =
 689             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 690                                        CompilerCounters::cmname_buffer_length,
 691                                        "", CHECK);
 692 
 693     _perf_last_invalidated_method =
 694         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 695                                      CompilerCounters::cmname_buffer_length,
 696                                      "", CHECK);
 697 
 698     _perf_last_compile_type =
 699              PerfDataManager::create_variable(SUN_CI, "lastType",
 700                                               PerfData::U_None,
 701                                               (jlong)CompileBroker::no_compile,
 702                                               CHECK);
 703 
 704     _perf_last_compile_size =
 705              PerfDataManager::create_variable(SUN_CI, "lastSize",
 706                                               PerfData::U_Bytes,
 707                                               (jlong)CompileBroker::no_compile,
 708                                               CHECK);
 709 
 710 
 711     _perf_last_failed_type =
 712              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 713                                               PerfData::U_None,
 714                                               (jlong)CompileBroker::no_compile,
 715                                               CHECK);
 716 
 717     _perf_last_invalidated_type =
 718          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 719                                           PerfData::U_None,
 720                                           (jlong)CompileBroker::no_compile,
 721                                           CHECK);
 722   }
 723 }
 724 
 725 // Completes compiler initialization. Compilation requests submitted
 726 // prior to this will be silently ignored.
 727 void CompileBroker::compilation_init_phase2() {
 728   _initialized = true;
 729 }
 730 
 731 Handle CompileBroker::create_thread_oop(const char* name, TRAPS) {
 732   Handle string = java_lang_String::create_from_str(name, CHECK_NH);
 733   Handle thread_group(THREAD, Universe::system_thread_group());
 734   return JavaCalls::construct_new_instance(
 735                        SystemDictionary::Thread_klass(),
 736                        vmSymbols::threadgroup_string_void_signature(),
 737                        thread_group,
 738                        string,
 739                        CHECK_NH);
 740 }
 741 
 742 
 743 JavaThread* CompileBroker::make_thread(jobject thread_handle, CompileQueue* queue, AbstractCompiler* comp, TRAPS) {
 744   JavaThread* thread = NULL;
 745   {
 746     MutexLocker mu(Threads_lock, THREAD);
 747     if (comp != NULL) {
 748       if (!InjectCompilerCreationFailure || comp-&gt;num_compiler_threads() == 0) {
 749         CompilerCounters* counters = new CompilerCounters();
 750         thread = new CompilerThread(queue, counters);
 751       }
 752     } else {
 753       thread = new CodeCacheSweeperThread();
 754     }
 755     // At this point the new CompilerThread data-races with this startup
 756     // thread (which I believe is the primoridal thread and NOT the VM
 757     // thread).  This means Java bytecodes being executed at startup can
 758     // queue compile jobs which will run at whatever default priority the
 759     // newly created CompilerThread runs at.
 760 
 761 
 762     // At this point it may be possible that no osthread was created for the
 763     // JavaThread due to lack of memory. We would have to throw an exception
 764     // in that case. However, since this must work and we do not allow
 765     // exceptions anyway, check and abort if this fails. But first release the
 766     // lock.
 767 
 768     if (thread != NULL &amp;&amp; thread-&gt;osthread() != NULL) {
 769 
 770       java_lang_Thread::set_thread(JNIHandles::resolve_non_null(thread_handle), thread);
 771 
 772       // Note that this only sets the JavaThread _priority field, which by
 773       // definition is limited to Java priorities and not OS priorities.
 774       // The os-priority is set in the CompilerThread startup code itself
 775 
 776       java_lang_Thread::set_priority(JNIHandles::resolve_non_null(thread_handle), NearMaxPriority);
 777 
 778       // Note that we cannot call os::set_priority because it expects Java
 779       // priorities and we are *explicitly* using OS priorities so that it's
 780       // possible to set the compiler thread priority higher than any Java
 781       // thread.
 782 
 783       int native_prio = CompilerThreadPriority;
 784       if (native_prio == -1) {
 785         if (UseCriticalCompilerThreadPriority) {
 786           native_prio = os::java_to_os_priority[CriticalPriority];
 787         } else {
 788           native_prio = os::java_to_os_priority[NearMaxPriority];
 789         }
 790       }
 791       os::set_native_priority(thread, native_prio);
 792 
 793       java_lang_Thread::set_daemon(JNIHandles::resolve_non_null(thread_handle));
 794 
 795       thread-&gt;set_threadObj(JNIHandles::resolve_non_null(thread_handle));
 796       if (comp != NULL) {
 797         thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 798       }
 799       Threads::add(thread);
 800       Thread::start(thread);
 801     }
 802   }
 803 
 804   // First release lock before aborting VM.
 805   if (thread == NULL || thread-&gt;osthread() == NULL) {
 806     if (UseDynamicNumberOfCompilerThreads &amp;&amp; comp != NULL &amp;&amp; comp-&gt;num_compiler_threads() &gt; 0) {
 807       if (thread != NULL) {
 808         thread-&gt;smr_delete();
 809       }
 810       return NULL;
 811     }
 812     vm_exit_during_initialization("java.lang.OutOfMemoryError",
 813                                   os::native_thread_creation_failed_msg());
 814   }
 815 
 816   // Let go of Threads_lock before yielding
 817   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 818 
 819   return thread;
 820 }
 821 
 822 
 823 void CompileBroker::init_compiler_sweeper_threads() {
 824   EXCEPTION_MARK;
 825 #if !defined(ZERO)
 826   assert(_c2_count &gt; 0 || _c1_count &gt; 0, "No compilers?");
 827 #endif // !ZERO
 828   // Initialize the compilation queue
 829   if (_c2_count &gt; 0) {
 830     const char* name = JVMCI_ONLY(UseJVMCICompiler ? "JVMCI compile queue" :) "C2 compile queue";
 831     _c2_compile_queue  = new CompileQueue(name);
 832     _compiler2_objects = NEW_C_HEAP_ARRAY(jobject, _c2_count, mtCompiler);
 833     _compiler2_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c2_count, mtCompiler);
 834   }
 835   if (_c1_count &gt; 0) {
 836     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 837     _compiler1_objects = NEW_C_HEAP_ARRAY(jobject, _c1_count, mtCompiler);
 838     _compiler1_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c1_count, mtCompiler);
 839   }
 840 
 841   char name_buffer[256];
 842 
 843   for (int i = 0; i &lt; _c2_count; i++) {
 844     // Create a name for our thread.
 845     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 846     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 847     jobject thread_handle = JNIHandles::make_global(thread_oop);
 848     _compiler2_objects[i] = thread_handle;
 849     _compiler2_logs[i] = NULL;
 850 
 851     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 852       JavaThread *ct = make_thread(thread_handle, _c2_compile_queue, _compilers[1], CHECK);
 853       assert(ct != NULL, "should have been handled for initial thread");
 854       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 855       if (TraceCompilerThreads) {
 856         ResourceMark rm;
 857         MutexLocker mu(Threads_lock);
 858         tty-&gt;print_cr("Added initial compiler thread %s", ct-&gt;get_thread_name());
 859       }
 860     }
 861   }
 862 
 863   for (int i = 0; i &lt; _c1_count; i++) {
 864     // Create a name for our thread.
 865     sprintf(name_buffer, "C1 CompilerThread%d", i);
 866     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 867     jobject thread_handle = JNIHandles::make_global(thread_oop);
 868     _compiler1_objects[i] = thread_handle;
 869     _compiler1_logs[i] = NULL;
 870 
 871     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 872       JavaThread *ct = make_thread(thread_handle, _c1_compile_queue, _compilers[0], CHECK);
 873       assert(ct != NULL, "should have been handled for initial thread");
 874       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 875       if (TraceCompilerThreads) {
 876         ResourceMark rm;
 877         MutexLocker mu(Threads_lock);
 878         tty-&gt;print_cr("Added initial compiler thread %s", ct-&gt;get_thread_name());
 879       }
 880     }
 881   }
 882 
 883   if (UsePerfData) {
 884     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, _c1_count + _c2_count, CHECK);
 885   }
 886 
 887   if (MethodFlushing) {
 888     // Initialize the sweeper thread
 889     Handle thread_oop = create_thread_oop("Sweeper thread", CHECK);
 890     jobject thread_handle = JNIHandles::make_local(THREAD, thread_oop());
 891     make_thread(thread_handle, NULL, NULL, CHECK);
 892   }
 893 }
 894 
 895 void CompileBroker::possibly_add_compiler_threads() {
 896   EXCEPTION_MARK;
 897 
 898   julong available_memory = os::available_memory();
 899   // If SegmentedCodeCache is off, both values refer to the single heap (with type CodeBlobType::All).
 900   size_t available_cc_np  = CodeCache::unallocated_capacity(CodeBlobType::MethodNonProfiled),
 901          available_cc_p   = CodeCache::unallocated_capacity(CodeBlobType::MethodProfiled);
 902 
 903   // Only do attempt to start additional threads if the lock is free.
 904   if (!CompileThread_lock-&gt;try_lock()) return;
 905 
 906   if (_c2_compile_queue != NULL) {
 907     int old_c2_count = _compilers[1]-&gt;num_compiler_threads();
 908     int new_c2_count = MIN4(_c2_count,
 909         _c2_compile_queue-&gt;size() / 2,
 910         (int)(available_memory / (200*M)),
 911         (int)(available_cc_np / (128*K)));
 912 
 913     for (int i = old_c2_count; i &lt; new_c2_count; i++) {
 914       JavaThread *ct = make_thread(compiler2_object(i), _c2_compile_queue, _compilers[1], CHECK);
 915       if (ct == NULL) break;
 916       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 917       if (TraceCompilerThreads) {
 918         ResourceMark rm;
 919         MutexLocker mu(Threads_lock);
 920         tty-&gt;print_cr("Added compiler thread %s (available memory: %dMB, available non-profiled code cache: %dMB)",
 921                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_np/M));
 922       }
 923     }
 924   }
 925 
 926   if (_c1_compile_queue != NULL) {
 927     int old_c1_count = _compilers[0]-&gt;num_compiler_threads();
 928     int new_c1_count = MIN4(_c1_count,
 929         _c1_compile_queue-&gt;size() / 4,
 930         (int)(available_memory / (100*M)),
 931         (int)(available_cc_p / (128*K)));
 932 
 933     for (int i = old_c1_count; i &lt; new_c1_count; i++) {
 934       JavaThread *ct = make_thread(compiler1_object(i), _c1_compile_queue, _compilers[0], CHECK);
 935       if (ct == NULL) break;
 936       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 937       if (TraceCompilerThreads) {
 938         ResourceMark rm;
 939         MutexLocker mu(Threads_lock);
 940         tty-&gt;print_cr("Added compiler thread %s (available memory: %dMB, available profiled code cache: %dMB)",
 941                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_p/M));
 942       }
 943     }
 944   }
 945 
 946   CompileThread_lock-&gt;unlock();
 947 }
 948 
 949 
 950 /**
 951  * Set the methods on the stack as on_stack so that redefine classes doesn't
 952  * reclaim them. This method is executed at a safepoint.
 953  */
 954 void CompileBroker::mark_on_stack() {
 955   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 956   // Since we are at a safepoint, we do not need a lock to access
 957   // the compile queues.
 958   if (_c2_compile_queue != NULL) {
 959     _c2_compile_queue-&gt;mark_on_stack();
 960   }
 961   if (_c1_compile_queue != NULL) {
 962     _c1_compile_queue-&gt;mark_on_stack();
 963   }
 964 }
 965 
 966 // ------------------------------------------------------------------
 967 // CompileBroker::compile_method
 968 //
 969 // Request compilation of a method.
 970 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 971                                         int osr_bci,
 972                                         int comp_level,
 973                                         const methodHandle&amp; hot_method,
 974                                         int hot_count,
 975                                         CompileTask::CompileReason compile_reason,
 976                                         bool blocking,
 977                                         Thread* thread) {
 978   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 979   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 980          "sanity check");
 981   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 982          "method holder must be initialized");
 983   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 984 
 985   if (CIPrintRequests) {
 986     tty-&gt;print("request: ");
 987     method-&gt;print_short_name(tty);
 988     if (osr_bci != InvocationEntryBci) {
 989       tty-&gt;print(" osr_bci: %d", osr_bci);
 990     }
 991     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, CompileTask::reason_name(compile_reason), hot_count);
 992     if (!hot_method.is_null()) {
 993       tty-&gt;print(" hot: ");
 994       if (hot_method() != method()) {
 995           hot_method-&gt;print_short_name(tty);
 996       } else {
 997         tty-&gt;print("yes");
 998       }
 999     }
1000     tty-&gt;cr();
1001   }
1002 
1003   // A request has been made for compilation.  Before we do any
1004   // real work, check to see if the method has been compiled
1005   // in the meantime with a definitive result.
1006   if (compilation_is_complete(method, osr_bci, comp_level)) {
1007     return;
1008   }
1009 
1010 #ifndef PRODUCT
1011   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
1012     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
1013       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
1014       return;
1015     }
1016   }
1017 #endif
1018 
1019   // If this method is already in the compile queue, then
1020   // we do not block the current thread.
1021   if (compilation_is_in_queue(method)) {
1022     // We may want to decay our counter a bit here to prevent
1023     // multiple denied requests for compilation.  This is an
1024     // open compilation policy issue. Note: The other possibility,
1025     // in the case that this is a blocking compile request, is to have
1026     // all subsequent blocking requesters wait for completion of
1027     // ongoing compiles. Note that in this case we'll need a protocol
1028     // for freeing the associated compile tasks. [Or we could have
1029     // a single static monitor on which all these waiters sleep.]
1030     return;
1031   }
1032 
1033   if (TieredCompilation) {
1034     // Tiered policy requires MethodCounters to exist before adding a method to
1035     // the queue. Create if we don't have them yet.
1036     method-&gt;get_method_counters(thread);
1037   }
1038 
1039   // Outputs from the following MutexLocker block:
1040   CompileTask* task     = NULL;
1041   CompileQueue* queue  = compile_queue(comp_level);
1042 
1043   // Acquire our lock.
1044   {
1045     MutexLocker locker(MethodCompileQueue_lock, thread);
1046 
1047     // Make sure the method has not slipped into the queues since
1048     // last we checked; note that those checks were "fast bail-outs".
1049     // Here we need to be more careful, see 14012000 below.
1050     if (compilation_is_in_queue(method)) {
1051       return;
1052     }
1053 
1054     // We need to check again to see if the compilation has
1055     // completed.  A previous compilation may have registered
1056     // some result.
1057     if (compilation_is_complete(method, osr_bci, comp_level)) {
1058       return;
1059     }
1060 
1061     // We now know that this compilation is not pending, complete,
1062     // or prohibited.  Assign a compile_id to this compilation
1063     // and check to see if it is in our [Start..Stop) range.
1064     int compile_id = assign_compile_id(method, osr_bci);
1065     if (compile_id == 0) {
1066       // The compilation falls outside the allowed range.
1067       return;
1068     }
1069 
1070 #if INCLUDE_JVMCI
1071     if (UseJVMCICompiler) {
1072       if (blocking) {
1073         // Don't allow blocking compiles for requests triggered by JVMCI.
1074         if (thread-&gt;is_Compiler_thread()) {
1075           blocking = false;
1076         }
1077 
1078         // Don't allow blocking compiles if inside a class initializer or while performing class loading
1079         vframeStream vfst((JavaThread*) thread);
1080         for (; !vfst.at_end(); vfst.next()) {
1081           if (vfst.method()-&gt;is_static_initializer() ||
1082               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
1083                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
1084             blocking = false;
1085             break;
1086           }
1087         }
1088 
1089         // Don't allow blocking compilation requests to JVMCI
1090         // if JVMCI itself is not yet initialized
1091         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
1092           blocking = false;
1093         }
1094 
1095         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
1096         // to avoid deadlock between compiler thread(s) and threads run at shutdown
1097         // such as the DestroyJavaVM thread.
1098         if (JVMCIRuntime::shutdown_called()) {
1099           blocking = false;
1100         }
1101       }
1102     }
1103 #endif // INCLUDE_JVMCI
1104 
1105     // We will enter the compilation in the queue.
1106     // 14012000: Note that this sets the queued_for_compile bits in
1107     // the target method. We can now reason that a method cannot be
1108     // queued for compilation more than once, as follows:
1109     // Before a thread queues a task for compilation, it first acquires
1110     // the compile queue lock, then checks if the method's queued bits
1111     // are set or it has already been compiled. Thus there can not be two
1112     // instances of a compilation task for the same method on the
1113     // compilation queue. Consider now the case where the compilation
1114     // thread has already removed a task for that method from the queue
1115     // and is in the midst of compiling it. In this case, the
1116     // queued_for_compile bits must be set in the method (and these
1117     // will be visible to the current thread, since the bits were set
1118     // under protection of the compile queue lock, which we hold now.
1119     // When the compilation completes, the compiler thread first sets
1120     // the compilation result and then clears the queued_for_compile
1121     // bits. Neither of these actions are protected by a barrier (or done
1122     // under the protection of a lock), so the only guarantee we have
1123     // (on machines with TSO (Total Store Order)) is that these values
1124     // will update in that order. As a result, the only combinations of
1125     // these bits that the current thread will see are, in temporal order:
1126     // &lt;RESULT, QUEUE&gt; :
1127     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1128     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1129     //     &lt;1, 0&gt; : compiled and queue bit cleared
1130     // Because we first check the queue bits then check the result bits,
1131     // we are assured that we cannot introduce a duplicate task.
1132     // Note that if we did the tests in the reverse order (i.e. check
1133     // result then check queued bit), we could get the result bit before
1134     // the compilation completed, and the queue bit after the compilation
1135     // completed, and end up introducing a "duplicate" (redundant) task.
1136     // In that case, the compiler thread should first check if a method
1137     // has already been compiled before trying to compile it.
1138     // NOTE: in the event that there are multiple compiler threads and
1139     // there is de-optimization/recompilation, things will get hairy,
1140     // and in that case it's best to protect both the testing (here) of
1141     // these bits, and their updating (here and elsewhere) under a
1142     // common lock.
1143     task = create_compile_task(queue,
1144                                compile_id, method,
1145                                osr_bci, comp_level,
1146                                hot_method, hot_count, compile_reason,
1147                                blocking);
1148   }
1149 
1150   if (blocking) {
1151     wait_for_completion(task);
1152   }
1153 }
1154 
1155 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1156                                        int comp_level,
1157                                        const methodHandle&amp; hot_method, int hot_count,
1158                                        CompileTask::CompileReason compile_reason,
1159                                        Thread* THREAD) {
1160   // Do nothing if compilebroker is not initalized or compiles are submitted on level none
1161   if (!_initialized || comp_level == CompLevel_none) {
1162     return NULL;
1163   }
1164 
1165   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1166   assert(comp != NULL, "Ensure we have a compiler");
1167 
1168   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1169   nmethod* nm = CompileBroker::compile_method(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, directive, THREAD);
1170   DirectivesStack::release(directive);
1171   return nm;
1172 }
1173 
1174 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1175                                          int comp_level,
1176                                          const methodHandle&amp; hot_method, int hot_count,
1177                                          CompileTask::CompileReason compile_reason,
1178                                          DirectiveSet* directive,
1179                                          Thread* THREAD) {
1180 
1181   // make sure arguments make sense
1182   assert(method-&gt;method_holder()-&gt;is_instance_klass(), "not an instance method");
1183   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1184   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1185   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1186   assert(!TieredCompilation || comp_level &lt;= TieredStopAtLevel, "Invalid compilation level");
1187   // allow any levels for WhiteBox
1188   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1189   // return quickly if possible
1190 
1191   // lock, make sure that the compilation
1192   // isn't prohibited in a straightforward way.
1193   AbstractCompiler* comp = CompileBroker::compiler(comp_level);
1194   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1195       compilation_is_prohibited(method, osr_bci, comp_level, directive-&gt;ExcludeOption)) {
1196     return NULL;
1197   }
1198 
1199 #if INCLUDE_JVMCI
1200   if (comp-&gt;is_jvmci() &amp;&amp; !JVMCIRuntime::can_initialize_JVMCI()) {
1201     return NULL;
1202   }
1203 #endif
1204 
1205   if (osr_bci == InvocationEntryBci) {
1206     // standard compilation
1207     CompiledMethod* method_code = method-&gt;code();
1208     if (method_code != NULL &amp;&amp; method_code-&gt;is_nmethod()) {
1209       if (compilation_is_complete(method, osr_bci, comp_level)) {
1210         return (nmethod*) method_code;
1211       }
1212     }
1213     if (method-&gt;is_not_compilable(comp_level)) {
1214       return NULL;
1215     }
1216   } else {
1217     // osr compilation
1218 #ifndef TIERED
1219     // seems like an assert of dubious value
1220     assert(comp_level == CompLevel_highest_tier,
1221            "all OSR compiles are assumed to be at a single compilation level");
1222 #endif // TIERED
1223     // We accept a higher level osr method
1224     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1225     if (nm != NULL) return nm;
1226     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1227   }
1228 
1229   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1230   // some prerequisites that are compiler specific
1231   if (comp-&gt;is_c2()) {
1232     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1233     // Resolve all classes seen in the signature of the method
1234     // we are compiling.
1235     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1236   }
1237 
1238   // If the method is native, do the lookup in the thread requesting
1239   // the compilation. Native lookups can load code, which is not
1240   // permitted during compilation.
1241   //
1242   // Note: A native method implies non-osr compilation which is
1243   //       checked with an assertion at the entry of this method.
1244   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1245     bool in_base_library;
1246     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1247     if (HAS_PENDING_EXCEPTION) {
1248       // In case of an exception looking up the method, we just forget
1249       // about it. The interpreter will kick-in and throw the exception.
1250       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1251       CLEAR_PENDING_EXCEPTION;
1252       return NULL;
1253     }
1254     assert(method-&gt;has_native_function(), "must have native code by now");
1255   }
1256 
1257   // RedefineClasses() has replaced this method; just return
1258   if (method-&gt;is_old()) {
1259     return NULL;
1260   }
1261 
1262   // JVMTI -- post_compile_event requires jmethod_id() that may require
1263   // a lock the compiling thread can not acquire. Prefetch it here.
1264   if (JvmtiExport::should_post_compiled_method_load()) {
1265     method-&gt;jmethod_id();
1266   }
1267 
1268   // do the compilation
1269   if (method-&gt;is_native()) {
1270     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1271       // The following native methods:
1272       //
1273       // java.lang.Float.intBitsToFloat
1274       // java.lang.Float.floatToRawIntBits
1275       // java.lang.Double.longBitsToDouble
1276       // java.lang.Double.doubleToRawLongBits
1277       //
1278       // are called through the interpreter even if interpreter native stubs
1279       // are not preferred (i.e., calling through adapter handlers is preferred).
1280       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1281       // if the version of the methods from the native libraries is called.
1282       // As the interpreter and the C2-intrinsified version of the methods preserves
1283       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1284       if ((UseSSE &gt;= 1 &amp;&amp;
1285           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1286            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1287           (UseSSE &gt;= 2 &amp;&amp;
1288            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1289             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1290         return NULL;
1291       }
1292 
1293       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1294       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1295       //
1296       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1297       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1298       AdapterHandlerLibrary::create_native_wrapper(method);
1299     } else {
1300       return NULL;
1301     }
1302   } else {
1303     // If the compiler is shut off due to code cache getting full
1304     // fail out now so blocking compiles dont hang the java thread
1305     if (!should_compile_new_jobs()) {
1306       CompilationPolicy::policy()-&gt;delay_compilation(method());
1307       return NULL;
1308     }
1309     bool is_blocking = !directive-&gt;BackgroundCompilationOption || ReplayCompiles;
1310     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, is_blocking, THREAD);
1311   }
1312 
1313   // return requested nmethod
1314   // We accept a higher level osr method
1315   if (osr_bci == InvocationEntryBci) {
1316     CompiledMethod* code = method-&gt;code();
1317     if (code == NULL) {
1318       return (nmethod*) code;
1319     } else {
1320       return code-&gt;as_nmethod_or_null();
1321     }
1322   }
1323   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1324 }
1325 
1326 
1327 // ------------------------------------------------------------------
1328 // CompileBroker::compilation_is_complete
1329 //
1330 // See if compilation of this method is already complete.
1331 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1332                                             int                 osr_bci,
1333                                             int                 comp_level) {
1334   bool is_osr = (osr_bci != standard_entry_bci);
1335   if (is_osr) {
1336     if (method-&gt;is_not_osr_compilable(comp_level)) {
1337       return true;
1338     } else {
1339       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1340       return (result != NULL);
1341     }
1342   } else {
1343     if (method-&gt;is_not_compilable(comp_level)) {
1344       return true;
1345     } else {
1346       CompiledMethod* result = method-&gt;code();
1347       if (result == NULL) return false;
1348       return comp_level == result-&gt;comp_level();
1349     }
1350   }
1351 }
1352 
1353 
1354 /**
1355  * See if this compilation is already requested.
1356  *
1357  * Implementation note: there is only a single "is in queue" bit
1358  * for each method.  This means that the check below is overly
1359  * conservative in the sense that an osr compilation in the queue
1360  * will block a normal compilation from entering the queue (and vice
1361  * versa).  This can be remedied by a full queue search to disambiguate
1362  * cases.  If it is deemed profitable, this may be done.
1363  */
1364 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1365   return method-&gt;queued_for_compilation();
1366 }
1367 
1368 // ------------------------------------------------------------------
1369 // CompileBroker::compilation_is_prohibited
1370 //
1371 // See if this compilation is not allowed.
1372 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded) {
1373   bool is_native = method-&gt;is_native();
1374   // Some compilers may not support the compilation of natives.
1375   AbstractCompiler *comp = compiler(comp_level);
1376   if (is_native &amp;&amp;
1377       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1378     method-&gt;set_not_compilable_quietly(comp_level);
1379     return true;
1380   }
1381 
1382   bool is_osr = (osr_bci != standard_entry_bci);
1383   // Some compilers may not support on stack replacement.
1384   if (is_osr &amp;&amp;
1385       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1386     method-&gt;set_not_osr_compilable(comp_level);
1387     return true;
1388   }
1389 
1390   // The method may be explicitly excluded by the user.
1391   double scale;
1392   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1393     bool quietly = CompilerOracle::should_exclude_quietly();
1394     if (PrintCompilation &amp;&amp; !quietly) {
1395       // This does not happen quietly...
1396       ResourceMark rm;
1397       tty-&gt;print("### Excluding %s:%s",
1398                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1399                  (method-&gt;is_static() ? " static" : ""));
1400       method-&gt;print_short_name(tty);
1401       tty-&gt;cr();
1402     }
1403     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1404   }
1405 
1406   return false;
1407 }
1408 
1409 /**
1410  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1411  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1412  * The function also allows to generate separate compilation IDs for OSR compilations.
1413  */
1414 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1415 #ifdef ASSERT
1416   bool is_osr = (osr_bci != standard_entry_bci);
1417   int id;
1418   if (method-&gt;is_native()) {
1419     assert(!is_osr, "can't be osr");
1420     // Adapters, native wrappers and method handle intrinsics
1421     // should be generated always.
1422     return Atomic::add(1, &amp;_compilation_id);
1423   } else if (CICountOSR &amp;&amp; is_osr) {
1424     id = Atomic::add(1, &amp;_osr_compilation_id);
1425     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1426       return id;
1427     }
1428   } else {
1429     id = Atomic::add(1, &amp;_compilation_id);
1430     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1431       return id;
1432     }
1433   }
1434 
1435   // Method was not in the appropriate compilation range.
1436   method-&gt;set_not_compilable_quietly();
1437   return 0;
1438 #else
1439   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1440   // only _compilation_id is incremented.
1441   return Atomic::add(1, &amp;_compilation_id);
1442 #endif
1443 }
1444 
1445 // ------------------------------------------------------------------
1446 // CompileBroker::assign_compile_id_unlocked
1447 //
1448 // Public wrapper for assign_compile_id that acquires the needed locks
1449 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1450   MutexLocker locker(MethodCompileQueue_lock, thread);
1451   return assign_compile_id(method, osr_bci);
1452 }
1453 
1454 // ------------------------------------------------------------------
1455 // CompileBroker::preload_classes
1456 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {
1457   // Move this code over from c1_Compiler.cpp
1458   ShouldNotReachHere();
1459 }
1460 
1461 
1462 // ------------------------------------------------------------------
1463 // CompileBroker::create_compile_task
1464 //
1465 // Create a CompileTask object representing the current request for
1466 // compilation.  Add this task to the queue.
1467 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1468                                                 int                 compile_id,
1469                                                 const methodHandle&amp; method,
1470                                                 int                 osr_bci,
1471                                                 int                 comp_level,
1472                                                 const methodHandle&amp; hot_method,
1473                                                 int                 hot_count,
1474                                                 CompileTask::CompileReason compile_reason,
1475                                                 bool                blocking) {
1476   CompileTask* new_task = CompileTask::allocate();
1477   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1478                        hot_method, hot_count, compile_reason,
1479                        blocking);
1480   queue-&gt;add(new_task);
1481   return new_task;
1482 }
1483 
1484 #if INCLUDE_JVMCI
1485 // The number of milliseconds to wait before checking if
1486 // JVMCI compilation has made progress.
1487 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 1000;
1488 
1489 // The number of JVMCI compilation progress checks that must fail
1490 // before unblocking a thread waiting for a blocking compilation.
1491 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 10;
1492 
1493 /**
1494  * Waits for a JVMCI compiler to complete a given task. This thread
1495  * waits until either the task completes or it sees no JVMCI compilation
1496  * progress for N consecutive milliseconds where N is
1497  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1498  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1499  *
1500  * @return true if this thread needs to free/recycle the task
1501  */
1502 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1503   MutexLocker waiter(task-&gt;lock(), thread);
1504   int progress_wait_attempts = 0;
1505   int methods_compiled = jvmci-&gt;methods_compiled();
1506   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1507          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1508     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1509 
1510     bool progress;
1511     if (jvmci_compiler_thread != NULL) {
1512       // If the JVMCI compiler thread is not blocked or suspended, we deem it to be making progress.
1513       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked &amp;&amp;
1514         !jvmci_compiler_thread-&gt;is_external_suspend();
1515     } else {
1516       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1517       // that all JVMCI compiler threads are blocked on. We use the counter for
1518       // successful JVMCI compilations to determine whether JVMCI compilation
1519       // is still making progress through the JVMCI compiler queue.
1520       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1521     }
1522 
1523     if (!progress) {
1524       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1525         if (PrintCompilation) {
1526           task-&gt;print(tty, "wait for blocking compilation timed out");
1527         }
1528         break;
1529       }
1530     } else {
1531       progress_wait_attempts = 0;
1532       if (jvmci_compiler_thread == NULL) {
1533         methods_compiled = jvmci-&gt;methods_compiled();
1534       }
1535     }
1536   }
1537   task-&gt;clear_waiter();
1538   return task-&gt;is_complete();
1539 }
1540 #endif
1541 
1542 /**
1543  *  Wait for the compilation task to complete.
1544  */
1545 void CompileBroker::wait_for_completion(CompileTask* task) {
1546   if (CIPrintCompileQueue) {
1547     ttyLocker ttyl;
1548     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1549   }
1550 
1551   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1552 
1553   JavaThread* thread = JavaThread::current();
1554   thread-&gt;set_blocked_on_compilation(true);
1555 
1556   methodHandle method(thread, task-&gt;method());
1557   bool free_task;
1558 #if INCLUDE_JVMCI
1559   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1560   if (comp-&gt;is_jvmci()) {
1561     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1562   } else
1563 #endif
1564   {
1565     MutexLocker waiter(task-&gt;lock(), thread);
1566     free_task = true;
1567     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1568       task-&gt;lock()-&gt;wait();
1569     }
1570   }
1571 
1572   thread-&gt;set_blocked_on_compilation(false);
1573   if (free_task) {
1574     if (is_compilation_disabled_forever()) {
1575       CompileTask::free(task);
1576       return;
1577     }
1578 
1579     // It is harmless to check this status without the lock, because
1580     // completion is a stable property (until the task object is recycled).
1581     assert(task-&gt;is_complete(), "Compilation should have completed");
1582     assert(task-&gt;code_handle() == NULL, "must be reset");
1583 
1584     // By convention, the waiter is responsible for recycling a
1585     // blocking CompileTask. Since there is only one waiter ever
1586     // waiting on a CompileTask, we know that no one else will
1587     // be using this CompileTask; we can free it.
1588     CompileTask::free(task);
1589   }
1590 }
1591 
1592 /**
1593  * Initialize compiler thread(s) + compiler object(s). The postcondition
1594  * of this function is that the compiler runtimes are initialized and that
1595  * compiler threads can start compiling.
1596  */
1597 bool CompileBroker::init_compiler_runtime() {
1598   CompilerThread* thread = CompilerThread::current();
1599   AbstractCompiler* comp = thread-&gt;compiler();
1600   // Final sanity check - the compiler object must exist
1601   guarantee(comp != NULL, "Compiler object must exist");
1602 
1603   int system_dictionary_modification_counter;
1604   {
1605     MutexLocker locker(Compile_lock, thread);
1606     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1607   }
1608 
1609   {
1610     // Must switch to native to allocate ci_env
1611     ThreadToNativeFromVM ttn(thread);
1612     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1613     // Cache Jvmti state
1614     ci_env.cache_jvmti_state();
1615     // Cache DTrace flags
1616     ci_env.cache_dtrace_flags();
1617 
1618     // Switch back to VM state to do compiler initialization
1619     ThreadInVMfromNative tv(thread);
1620     ResetNoHandleMark rnhm;
1621 
1622     // Perform per-thread and global initializations
1623     comp-&gt;initialize();
1624   }
1625 
1626   if (comp-&gt;is_failed()) {
1627     disable_compilation_forever();
1628     // If compiler initialization failed, no compiler thread that is specific to a
1629     // particular compiler runtime will ever start to compile methods.
1630     shutdown_compiler_runtime(comp, thread);
1631     return false;
1632   }
1633 
1634   // C1 specific check
1635   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1636     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1637     return false;
1638   }
1639 
1640   return true;
1641 }
1642 
1643 /**
1644  * If C1 and/or C2 initialization failed, we shut down all compilation.
1645  * We do this to keep things simple. This can be changed if it ever turns
1646  * out to be a problem.
1647  */
1648 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1649   // Free buffer blob, if allocated
1650   if (thread-&gt;get_buffer_blob() != NULL) {
1651     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1652     CodeCache::free(thread-&gt;get_buffer_blob());
1653   }
1654 
1655   if (comp-&gt;should_perform_shutdown()) {
1656     // There are two reasons for shutting down the compiler
1657     // 1) compiler runtime initialization failed
1658     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1659     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1660 
1661     // Only one thread per compiler runtime object enters here
1662     // Set state to shut down
1663     comp-&gt;set_shut_down();
1664 
1665     // Delete all queued compilation tasks to make compiler threads exit faster.
1666     if (_c1_compile_queue != NULL) {
1667       _c1_compile_queue-&gt;free_all();
1668     }
1669 
1670     if (_c2_compile_queue != NULL) {
1671       _c2_compile_queue-&gt;free_all();
1672     }
1673 
1674     // Set flags so that we continue execution with using interpreter only.
1675     UseCompiler    = false;
1676     UseInterpreter = true;
1677 
1678     // We could delete compiler runtimes also. However, there are references to
1679     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1680     // fail. This can be done later if necessary.
1681   }
1682 }
1683 
1684 /**
1685  * Helper function to create new or reuse old CompileLog.
1686  */
1687 CompileLog* CompileBroker::get_log(CompilerThread* ct) {
1688   if (!LogCompilation) return NULL;
1689 
1690   AbstractCompiler *compiler = ct-&gt;compiler();
1691   bool c1 = compiler-&gt;is_c1();
1692   jobject* compiler_objects = c1 ? _compiler1_objects : _compiler2_objects;
1693   assert(compiler_objects != NULL, "must be initialized at this point");
1694   CompileLog** logs = c1 ? _compiler1_logs : _compiler2_logs;
1695   assert(logs != NULL, "must be initialized at this point");
1696   int count = c1 ? _c1_count : _c2_count;
1697 
1698   // Find Compiler number by its threadObj.
1699   oop compiler_obj = ct-&gt;threadObj();
1700   int compiler_number = 0;
1701   bool found = false;
1702   for (; compiler_number &lt; count; compiler_number++) {
1703     if (oopDesc::equals(JNIHandles::resolve_non_null(compiler_objects[compiler_number]), compiler_obj)) {
1704       found = true;
1705       break;
1706     }
1707   }
1708   assert(found, "Compiler must exist at this point");
1709 
1710   // Determine pointer for this thread's log.
1711   CompileLog** log_ptr = &amp;logs[compiler_number];
1712 
1713   // Return old one if it exists.
1714   CompileLog* log = *log_ptr;
1715   if (log != NULL) {
1716     ct-&gt;init_log(log);
1717     return log;
1718   }
1719 
1720   // Create a new one and remember it.
1721   init_compiler_thread_log();
1722   log = ct-&gt;log();
1723   *log_ptr = log;
1724   return log;
1725 }
1726 
1727 // ------------------------------------------------------------------
1728 // CompileBroker::compiler_thread_loop
1729 //
1730 // The main loop run by a CompilerThread.
1731 void CompileBroker::compiler_thread_loop() {
1732   CompilerThread* thread = CompilerThread::current();
1733   CompileQueue* queue = thread-&gt;queue();
1734   // For the thread that initializes the ciObjectFactory
1735   // this resource mark holds all the shared objects
1736   ResourceMark rm;
1737 
1738   // First thread to get here will initialize the compiler interface
1739 
1740   {
1741     ASSERT_IN_VM;
1742     MutexLocker only_one (CompileThread_lock, thread);
1743     if (!ciObjectFactory::is_initialized()) {
1744       ciObjectFactory::initialize();
1745     }
1746   }
1747 
1748   // Open a log.
1749   CompileLog* log = get_log(thread);
1750   if (log != NULL) {
1751     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1752                     thread-&gt;name(),
1753                     os::current_thread_id(),
1754                     os::current_process_id());
1755     log-&gt;stamp();
1756     log-&gt;end_elem();
1757   }
1758 
1759   // If compiler thread/runtime initialization fails, exit the compiler thread
1760   if (!init_compiler_runtime()) {
1761     return;
1762   }
1763 
1764   thread-&gt;start_idle_timer();
1765 
1766   // Poll for new compilation tasks as long as the JVM runs. Compilation
1767   // should only be disabled if something went wrong while initializing the
1768   // compiler runtimes. This, in turn, should not happen. The only known case
1769   // when compiler runtime initialization fails is if there is not enough free
1770   // space in the code cache to generate the necessary stubs, etc.
1771   while (!is_compilation_disabled_forever()) {
1772     // We need this HandleMark to avoid leaking VM handles.
1773     HandleMark hm(thread);
1774 
1775     CompileTask* task = queue-&gt;get();
1776     if (task == NULL) {
1777       if (UseDynamicNumberOfCompilerThreads) {
1778         // Access compiler_count under lock to enforce consistency.
1779         MutexLocker only_one(CompileThread_lock);
1780         if (can_remove(thread, true)) {
1781           if (TraceCompilerThreads) {
1782             tty-&gt;print_cr("Removing compiler thread %s after " JLONG_FORMAT " ms idle time",
1783                           thread-&gt;name(), thread-&gt;idle_time_millis());
1784           }
1785           // Free buffer blob, if allocated
1786           if (thread-&gt;get_buffer_blob() != NULL) {
1787             MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1788             CodeCache::free(thread-&gt;get_buffer_blob());
1789           }
1790           return; // Stop this thread.
1791         }
1792       }
1793     } else {
1794       // Assign the task to the current thread.  Mark this compilation
1795       // thread as active for the profiler.
1796       // CompileTaskWrapper also keeps the Method* from being deallocated if redefinition
1797       // occurs after fetching the compile task off the queue.
1798       CompileTaskWrapper ctw(task);
1799       nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1800       task-&gt;set_code_handle(&amp;result_handle);
1801       methodHandle method(thread, task-&gt;method());
1802 
1803       // Never compile a method if breakpoints are present in it
1804       if (method()-&gt;number_of_breakpoints() == 0) {
1805         // Compile the method.
1806         if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1807           invoke_compiler_on_method(task);
1808           thread-&gt;start_idle_timer();
1809         } else {
1810           // After compilation is disabled, remove remaining methods from queue
1811           method-&gt;clear_queued_for_compilation();
1812           task-&gt;set_failure_reason("compilation is disabled");
1813         }
1814       }
1815 
1816       if (UseDynamicNumberOfCompilerThreads) {
1817         possibly_add_compiler_threads();
1818       }
1819     }
1820   }
1821 
1822   // Shut down compiler runtime
1823   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1824 }
1825 
1826 // ------------------------------------------------------------------
1827 // CompileBroker::init_compiler_thread_log
1828 //
1829 // Set up state required by +LogCompilation.
1830 void CompileBroker::init_compiler_thread_log() {
1831     CompilerThread* thread = CompilerThread::current();
1832     char  file_name[4*K];
1833     FILE* fp = NULL;
1834     intx thread_id = os::current_thread_id();
1835     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1836       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1837       if (dir == NULL) {
1838         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1839                      thread_id, os::current_process_id());
1840       } else {
1841         jio_snprintf(file_name, sizeof(file_name),
1842                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1843                      os::file_separator(), thread_id, os::current_process_id());
1844       }
1845 
1846       fp = fopen(file_name, "wt");
1847       if (fp != NULL) {
1848         if (LogCompilation &amp;&amp; Verbose) {
1849           tty-&gt;print_cr("Opening compilation log %s", file_name);
1850         }
1851         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1852         if (log == NULL) {
1853           fclose(fp);
1854           return;
1855         }
1856         thread-&gt;init_log(log);
1857 
1858         if (xtty != NULL) {
1859           ttyLocker ttyl;
1860           // Record any per thread log files
1861           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1862         }
1863         return;
1864       }
1865     }
1866     warning("Cannot open log file: %s", file_name);
1867 }
1868 
1869 void CompileBroker::log_metaspace_failure() {
1870   const char* message = "some methods may not be compiled because metaspace "
1871                         "is out of memory";
1872   if (_compilation_log != NULL) {
1873     _compilation_log-&gt;log_metaspace_failure(message);
1874   }
1875   if (PrintCompilation) {
1876     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1877   }
1878 }
1879 
1880 
1881 // ------------------------------------------------------------------
1882 // CompileBroker::set_should_block
1883 //
1884 // Set _should_block.
1885 // Call this from the VM, with Threads_lock held and a safepoint requested.
1886 void CompileBroker::set_should_block() {
1887   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1888   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1889 #ifndef PRODUCT
1890   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1891     tty-&gt;print_cr("notifying compiler thread pool to block");
1892 #endif
1893   _should_block = true;
1894 }
1895 
1896 // ------------------------------------------------------------------
1897 // CompileBroker::maybe_block
1898 //
1899 // Call this from the compiler at convenient points, to poll for _should_block.
1900 void CompileBroker::maybe_block() {
1901   if (_should_block) {
1902 #ifndef PRODUCT
1903     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1904       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1905 #endif
1906     ThreadInVMfromNative tivfn(JavaThread::current());
1907   }
1908 }
1909 
1910 // wrapper for CodeCache::print_summary()
1911 static void codecache_print(bool detailed)
1912 {
1913   ResourceMark rm;
1914   stringStream s;
1915   // Dump code cache  into a buffer before locking the tty,
1916   {
1917     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1918     CodeCache::print_summary(&amp;s, detailed);
1919   }
1920   ttyLocker ttyl;
1921   tty-&gt;print("%s", s.as_string());
1922 }
1923 
1924 // wrapper for CodeCache::print_summary() using outputStream
1925 static void codecache_print(outputStream* out, bool detailed) {
1926   ResourceMark rm;
1927   stringStream s;
1928 
1929   // Dump code cache into a buffer
1930   {
1931     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1932     CodeCache::print_summary(&amp;s, detailed);
1933   }
1934 
1935   char* remaining_log = s.as_string();
1936   while (*remaining_log != '\0') {
1937     char* eol = strchr(remaining_log, '\n');
1938     if (eol == NULL) {
1939       out-&gt;print_cr("%s", remaining_log);
1940       remaining_log = remaining_log + strlen(remaining_log);
1941     } else {
1942       *eol = '\0';
1943       out-&gt;print_cr("%s", remaining_log);
1944       remaining_log = eol + 1;
1945     }
1946   }
1947 }
1948 
1949 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, bool success, ciEnv* ci_env,
1950                                  int compilable, const char* failure_reason) {
1951   if (success) {
1952     task-&gt;mark_success();
1953     if (ci_env != NULL) {
1954       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1955     }
1956     if (_compilation_log != NULL) {
1957       nmethod* code = task-&gt;code();
1958       if (code != NULL) {
1959         _compilation_log-&gt;log_nmethod(thread, code);
1960       }
1961     }
1962   } else if (AbortVMOnCompilationFailure) {
1963     if (compilable == ciEnv::MethodCompilable_not_at_tier) {
1964       fatal("Not compilable at tier %d: %s", task-&gt;comp_level(), failure_reason);
1965     }
1966     if (compilable == ciEnv::MethodCompilable_never) {
1967       fatal("Never compilable: %s", failure_reason);
1968     }
1969   }
1970   // simulate crash during compilation
1971   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1972 }
1973 
1974 static void post_compilation_event(EventCompilation* event, CompileTask* task) {
1975   assert(event != NULL, "invariant");
1976   assert(event-&gt;should_commit(), "invariant");
1977   event-&gt;set_method(task-&gt;method());
1978   event-&gt;set_compileId(task-&gt;compile_id());
1979   event-&gt;set_compileLevel(task-&gt;comp_level());
1980   event-&gt;set_succeded(task-&gt;is_success());
1981   event-&gt;set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1982   event-&gt;set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1983   event-&gt;set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1984   event-&gt;commit();
1985 }
1986 
1987 int DirectivesStack::_depth = 0;
1988 CompilerDirectives* DirectivesStack::_top = NULL;
1989 CompilerDirectives* DirectivesStack::_bottom = NULL;
1990 
1991 // ------------------------------------------------------------------
1992 // CompileBroker::invoke_compiler_on_method
1993 //
1994 // Compile a method.
1995 //
1996 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1997   task-&gt;print_ul();
1998   if (PrintCompilation) {
1999     ResourceMark rm;
2000     task-&gt;print_tty();
2001   }
2002   elapsedTimer time;
2003 
2004   CompilerThread* thread = CompilerThread::current();
2005   ResourceMark rm(thread);
2006 
2007   if (LogEvents) {
2008     _compilation_log-&gt;log_compile(thread, task);
2009   }
2010 
2011   // Common flags.
2012   uint compile_id = task-&gt;compile_id();
2013   int osr_bci = task-&gt;osr_bci();
2014   bool is_osr = (osr_bci != standard_entry_bci);
2015   bool should_log = (thread-&gt;log() != NULL);
2016   bool should_break = false;
2017   const int task_level = task-&gt;comp_level();
2018   AbstractCompiler* comp = task-&gt;compiler();
2019 
2020   DirectiveSet* directive;
2021   {
2022     // create the handle inside it's own block so it can't
2023     // accidentally be referenced once the thread transitions to
2024     // native.  The NoHandleMark before the transition should catch
2025     // any cases where this occurs in the future.
2026     methodHandle method(thread, task-&gt;method());
2027     assert(!method-&gt;is_native(), "no longer compile natives");
2028 
2029     // Look up matching directives
2030     directive = DirectivesStack::getMatchingDirective(method, comp);
2031 
2032     // Save information about this method in case of failure.
2033     set_last_compile(thread, method, is_osr, task_level);
2034 
2035     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
2036   }
2037 
2038   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
2039   if (should_log &amp;&amp; !directive-&gt;LogOption) {
2040     should_log = false;
2041   }
2042 
2043   // Allocate a new set of JNI handles.
2044   push_jni_handle_block();
2045   Method* target_handle = task-&gt;method();
2046   int compilable = ciEnv::MethodCompilable;
2047   const char* failure_reason = NULL;
2048   const char* retry_message = NULL;
2049 
2050   int system_dictionary_modification_counter;
2051   {
2052     MutexLocker locker(Compile_lock, thread);
2053     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
2054   }
2055 
2056 #if INCLUDE_JVMCI
2057   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
2058     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
2059 
2060     TraceTime t1("compilation", &amp;time);
2061     EventCompilation event;
2062 
2063     // Skip redefined methods
2064     if (target_handle-&gt;is_old()) {
2065         failure_reason = "redefined method";
2066         retry_message = "not retryable";
2067         compilable = ciEnv::MethodCompilable_never;
2068     } else {
2069         JVMCIEnv env(task, system_dictionary_modification_counter);
2070         methodHandle method(thread, target_handle);
2071         jvmci-&gt;compile_method(method, osr_bci, &amp;env);
2072 
2073         failure_reason = env.failure_reason();
2074         if (!env.retryable()) {
2075           retry_message = "not retryable";
2076           compilable = ciEnv::MethodCompilable_not_at_tier;
2077         }
2078     }
2079     post_compile(thread, task, task-&gt;code() != NULL, NULL, compilable, failure_reason);
2080     if (event.should_commit()) {
2081       post_compilation_event(&amp;event, task);
2082     }
2083 
2084   } else
2085 #endif // INCLUDE_JVMCI
2086   {
2087     NoHandleMark  nhm;
2088     ThreadToNativeFromVM ttn(thread);
2089 
2090     ciEnv ci_env(task, system_dictionary_modification_counter);
2091     if (should_break) {
2092       ci_env.set_break_at_compile(true);
2093     }
2094     if (should_log) {
2095       ci_env.set_log(thread-&gt;log());
2096     }
2097     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
2098     // The thread-env() field is cleared in ~CompileTaskWrapper.
2099 
2100     // Cache Jvmti state
2101     ci_env.cache_jvmti_state();
2102 
2103     // Cache DTrace flags
2104     ci_env.cache_dtrace_flags();
2105 
2106     ciMethod* target = ci_env.get_method_from_handle(target_handle);
2107 
2108     TraceTime t1("compilation", &amp;time);
2109     EventCompilation event;
2110 
2111     if (comp == NULL) {
2112       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
2113     } else {
2114       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
2115         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
2116         while (WhiteBox::compilation_locked) {
2117           locker.wait(Mutex::_no_safepoint_check_flag);
2118         }
2119       }
2120       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
2121     }
2122 
2123     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
2124       //assert(false, "compiler should always document failure");
2125       // The compiler elected, without comment, not to register a result.
2126       // Do not attempt further compilations of this method.
2127       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
2128     }
2129 
2130     // Copy this bit to the enclosing block:
2131     compilable = ci_env.compilable();
2132 
2133     if (ci_env.failing()) {
2134       failure_reason = ci_env.failure_reason();
2135       retry_message = ci_env.retry_message();
2136       ci_env.report_failure(failure_reason);
2137     }
2138 
2139     post_compile(thread, task, !ci_env.failing(), &amp;ci_env, compilable, failure_reason);
2140     if (event.should_commit()) {
2141       post_compilation_event(&amp;event, task);
2142     }
2143   }
2144   // Remove the JNI handle block after the ciEnv destructor has run in
2145   // the previous block.
2146   pop_jni_handle_block();
2147 
2148   if (failure_reason != NULL) {
2149     task-&gt;set_failure_reason(failure_reason);
2150     if (_compilation_log != NULL) {
2151       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
2152     }
2153     if (PrintCompilation) {
2154       FormatBufferResource msg = retry_message != NULL ?
2155         FormatBufferResource("COMPILE SKIPPED: %s (%s)", failure_reason, retry_message) :
2156         FormatBufferResource("COMPILE SKIPPED: %s",      failure_reason);
2157       task-&gt;print(tty, msg);
2158     }
2159   }
2160 
2161   methodHandle method(thread, task-&gt;method());
2162 
2163   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
2164 
2165   collect_statistics(thread, time, task);
2166 
2167   nmethod* nm = task-&gt;code();
2168   if (nm != NULL) {
2169     nm-&gt;maybe_print_nmethod(directive);
2170   }
2171   DirectivesStack::release(directive);
2172 
2173   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2174     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2175     tty-&gt;print("%4d ", compile_id);    // print compilation number
2176     tty-&gt;print("%s ", (is_osr ? "%" : " "));
2177     if (task-&gt;code() != NULL) {
2178       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2179     }
2180     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2181   }
2182 
2183   Log(compilation, codecache) log;
2184   if (log.is_debug()) {
2185     LogStream ls(log.debug());
2186     codecache_print(&amp;ls, /* detailed= */ false);
2187   }
2188   if (PrintCodeCacheOnCompilation) {
2189     codecache_print(/* detailed= */ false);
2190   }
2191   // Disable compilation, if required.
2192   switch (compilable) {
2193   case ciEnv::MethodCompilable_never:
2194     if (is_osr)
2195       method-&gt;set_not_osr_compilable_quietly();
2196     else
2197       method-&gt;set_not_compilable_quietly();
2198     break;
2199   case ciEnv::MethodCompilable_not_at_tier:
2200     if (is_osr)
2201       method-&gt;set_not_osr_compilable_quietly(task_level);
2202     else
2203       method-&gt;set_not_compilable_quietly(task_level);
2204     break;
2205   }
2206 
2207   // Note that the queued_for_compilation bits are cleared without
2208   // protection of a mutex. [They were set by the requester thread,
2209   // when adding the task to the compile queue -- at which time the
2210   // compile queue lock was held. Subsequently, we acquired the compile
2211   // queue lock to get this task off the compile queue; thus (to belabour
2212   // the point somewhat) our clearing of the bits must be occurring
2213   // only after the setting of the bits. See also 14012000 above.
2214   method-&gt;clear_queued_for_compilation();
2215 }
2216 
2217 /**
2218  * The CodeCache is full. Print warning and disable compilation.
2219  * Schedule code cache cleaning so compilation can continue later.
2220  * This function needs to be called only from CodeCache::allocate(),
2221  * since we currently handle a full code cache uniformly.
2222  */
2223 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2224   UseInterpreter = true;
2225   if (UseCompiler || AlwaysCompileLoopMethods ) {
2226     if (xtty != NULL) {
2227       ResourceMark rm;
2228       stringStream s;
2229       // Dump code cache state into a buffer before locking the tty,
2230       // because log_state() will use locks causing lock conflicts.
2231       CodeCache::log_state(&amp;s);
2232       // Lock to prevent tearing
2233       ttyLocker ttyl;
2234       xtty-&gt;begin_elem("code_cache_full");
2235       xtty-&gt;print("%s", s.as_string());
2236       xtty-&gt;stamp();
2237       xtty-&gt;end_elem();
2238     }
2239 
2240 #ifndef PRODUCT
2241     if (ExitOnFullCodeCache) {
2242       codecache_print(/* detailed= */ true);
2243       before_exit(JavaThread::current());
2244       exit_globals(); // will delete tty
2245       vm_direct_exit(1);
2246     }
2247 #endif
2248     if (UseCodeCacheFlushing) {
2249       // Since code cache is full, immediately stop new compiles
2250       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2251         NMethodSweeper::log_sweep("disable_compiler");
2252       }
2253     } else {
2254       disable_compilation_forever();
2255     }
2256 
2257     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2258   }
2259 }
2260 
2261 // ------------------------------------------------------------------
2262 // CompileBroker::set_last_compile
2263 //
2264 // Record this compilation for debugging purposes.
2265 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {
2266   ResourceMark rm;
2267   char* method_name = method-&gt;name()-&gt;as_C_string();
2268   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
2269   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
2270   char current_method[CompilerCounters::cmname_buffer_length];
2271   size_t maxLen = CompilerCounters::cmname_buffer_length;
2272 
2273   if (UsePerfData) {
2274     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2275 
2276     size_t s1len = strlen(class_name);
2277     size_t s2len = strlen(method_name);
2278 
2279     // check if we need to truncate the string
2280     if (s1len + s2len + 2 &gt; maxLen) {
2281 
2282       // the strategy is to lop off the leading characters of the
2283       // class name and the trailing characters of the method name.
2284 
2285       if (s2len + 2 &gt; maxLen) {
2286         // lop of the entire class name string, let snprintf handle
2287         // truncation of the method name.
2288         class_name += s1len; // null string
2289       }
2290       else {
2291         // lop off the extra characters from the front of the class name
2292         class_name += ((s1len + s2len + 2) - maxLen);
2293       }
2294     }
2295 
2296     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
2297   }
2298 
2299   if (CICountOSR &amp;&amp; is_osr) {
2300     _last_compile_type = osr_compile;
2301   } else {
2302     _last_compile_type = normal_compile;
2303   }
2304   _last_compile_level = comp_level;
2305 
2306   if (UsePerfData) {
2307     CompilerCounters* counters = thread-&gt;counters();
2308     counters-&gt;set_current_method(current_method);
2309     counters-&gt;set_compile_type((jlong)_last_compile_type);
2310   }
2311 }
2312 
2313 
2314 // ------------------------------------------------------------------
2315 // CompileBroker::push_jni_handle_block
2316 //
2317 // Push on a new block of JNI handles.
2318 void CompileBroker::push_jni_handle_block() {
2319   JavaThread* thread = JavaThread::current();
2320 
2321   // Allocate a new block for JNI handles.
2322   // Inlined code from jni_PushLocalFrame()
2323   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2324   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2325   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
2326   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
2327   thread-&gt;set_active_handles(compile_handles);
2328 }
2329 
2330 
2331 // ------------------------------------------------------------------
2332 // CompileBroker::pop_jni_handle_block
2333 //
2334 // Pop off the current block of JNI handles.
2335 void CompileBroker::pop_jni_handle_block() {
2336   JavaThread* thread = JavaThread::current();
2337 
2338   // Release our JNI handle block
2339   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2340   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2341   thread-&gt;set_active_handles(java_handles);
2342   compile_handles-&gt;set_pop_frame_link(NULL);
2343   JNIHandleBlock::release_block(compile_handles, thread); // may block
2344 }
2345 
2346 // ------------------------------------------------------------------
2347 // CompileBroker::collect_statistics
2348 //
2349 // Collect statistics about the compilation.
2350 
2351 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2352   bool success = task-&gt;is_success();
2353   methodHandle method (thread, task-&gt;method());
2354   uint compile_id = task-&gt;compile_id();
2355   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2356   nmethod* code = task-&gt;code();
2357   CompilerCounters* counters = thread-&gt;counters();
2358 
2359   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2360   MutexLocker locker(CompileStatistics_lock);
2361 
2362   // _perf variables are production performance counters which are
2363   // updated regardless of the setting of the CITime and CITimeEach flags
2364   //
2365 
2366   // account all time, including bailouts and failures in this counter;
2367   // C1 and C2 counters are counting both successful and unsuccessful compiles
2368   _t_total_compilation.add(time);
2369 
2370   if (!success) {
2371     _total_bailout_count++;
2372     if (UsePerfData) {
2373       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2374       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2375       _perf_total_bailout_count-&gt;inc();
2376     }
2377     _t_bailedout_compilation.add(time);
2378   } else if (code == NULL) {
2379     if (UsePerfData) {
2380       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2381       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2382       _perf_total_invalidated_count-&gt;inc();
2383     }
2384     _total_invalidated_count++;
2385     _t_invalidated_compilation.add(time);
2386   } else {
2387     // Compilation succeeded
2388 
2389     // update compilation ticks - used by the implementation of
2390     // java.lang.management.CompilationMBean
2391     _perf_total_compilation-&gt;inc(time.ticks());
2392     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2393 
2394     if (CITime) {
2395       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2396       if (is_osr) {
2397         _t_osr_compilation.add(time);
2398         _sum_osr_bytes_compiled += bytes_compiled;
2399       } else {
2400         _t_standard_compilation.add(time);
2401         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2402       }
2403 
2404 #if INCLUDE_JVMCI
2405       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2406       if (comp) {
2407         CompilerStatistics* stats = comp-&gt;stats();
2408         if (stats) {
2409           if (is_osr) {
2410             stats-&gt;_osr.update(time, bytes_compiled);
2411           } else {
2412             stats-&gt;_standard.update(time, bytes_compiled);
2413           }
2414           stats-&gt;_nmethods_size += code-&gt;total_size();
2415           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2416         } else { // if (!stats)
2417           assert(false, "Compiler statistics object must exist");
2418         }
2419       } else { // if (!comp)
2420         assert(false, "Compiler object must exist");
2421       }
2422 #endif // INCLUDE_JVMCI
2423     }
2424 
2425     if (UsePerfData) {
2426       // save the name of the last method compiled
2427       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2428       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2429       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2430                                          task-&gt;num_inlined_bytecodes());
2431       if (is_osr) {
2432         _perf_osr_compilation-&gt;inc(time.ticks());
2433         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2434       } else {
2435         _perf_standard_compilation-&gt;inc(time.ticks());
2436         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2437       }
2438     }
2439 
2440     if (CITimeEach) {
2441       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2442       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2443                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2444     }
2445 
2446     // Collect counts of successful compilations
2447     _sum_nmethod_size      += code-&gt;total_size();
2448     _sum_nmethod_code_size += code-&gt;insts_size();
2449     _total_compile_count++;
2450 
2451     if (UsePerfData) {
2452       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2453       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2454       _perf_total_compile_count-&gt;inc();
2455     }
2456 
2457     if (is_osr) {
2458       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2459       _total_osr_compile_count++;
2460     } else {
2461       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2462       _total_standard_compile_count++;
2463     }
2464   }
2465   // set the current method for the thread to null
2466   if (UsePerfData) counters-&gt;set_current_method("");
2467 }
2468 
2469 const char* CompileBroker::compiler_name(int comp_level) {
2470   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2471   if (comp == NULL) {
2472     return "no compiler";
2473   } else {
2474     return (comp-&gt;name());
2475   }
2476 }
2477 
2478 #if INCLUDE_JVMCI
2479 void CompileBroker::print_times(AbstractCompiler* comp) {
2480   CompilerStatistics* stats = comp-&gt;stats();
2481   if (stats) {
2482     tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2483                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2484                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2485                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2486                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2487   } else { // if (!stats)
2488     assert(false, "Compiler statistics object must exist");
2489   }
2490   comp-&gt;print_timers();
2491 }
2492 #endif // INCLUDE_JVMCI
2493 
2494 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2495 #if INCLUDE_JVMCI
2496   elapsedTimer standard_compilation;
2497   elapsedTimer total_compilation;
2498   elapsedTimer osr_compilation;
2499 
2500   int standard_bytes_compiled = 0;
2501   int osr_bytes_compiled = 0;
2502 
2503   int standard_compile_count = 0;
2504   int osr_compile_count = 0;
2505   int total_compile_count = 0;
2506 
2507   int nmethods_size = 0;
2508   int nmethods_code_size = 0;
2509   bool printedHeader = false;
2510 
2511   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2512     AbstractCompiler* comp = _compilers[i];
2513     if (comp != NULL) {
2514       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2515         printedHeader = true;
2516         tty-&gt;cr();
2517         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2518         tty-&gt;print_cr("------------------------------------------------");
2519         tty-&gt;cr();
2520       }
2521       CompilerStatistics* stats = comp-&gt;stats();
2522 
2523       if (stats) {
2524         standard_compilation.add(stats-&gt;_standard._time);
2525         osr_compilation.add(stats-&gt;_osr._time);
2526 
2527         standard_bytes_compiled += stats-&gt;_standard._bytes;
2528         osr_bytes_compiled += stats-&gt;_osr._bytes;
2529 
2530         standard_compile_count += stats-&gt;_standard._count;
2531         osr_compile_count += stats-&gt;_osr._count;
2532 
2533         nmethods_size += stats-&gt;_nmethods_size;
2534         nmethods_code_size += stats-&gt;_nmethods_code_size;
2535       } else { // if (!stats)
2536         assert(false, "Compiler statistics object must exist");
2537       }
2538 
2539       if (per_compiler) {
2540         print_times(comp);
2541       }
2542     }
2543   }
2544   total_compile_count = osr_compile_count + standard_compile_count;
2545   total_compilation.add(osr_compilation);
2546   total_compilation.add(standard_compilation);
2547 
2548   // In hosted mode, print the JVMCI compiler specific counters manually.
2549   if (!UseJVMCICompiler) {
2550     JVMCICompiler::print_compilation_timers();
2551   }
2552 #else // INCLUDE_JVMCI
2553   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2554   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2555   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2556 
2557   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2558   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2559 
2560   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2561   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2562   int total_compile_count = CompileBroker::_total_compile_count;
2563 
2564   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2565   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2566 #endif // INCLUDE_JVMCI
2567 
2568   if (!aggregate) {
2569     return;
2570   }
2571   tty-&gt;cr();
2572   tty-&gt;print_cr("Accumulated compiler times");
2573   tty-&gt;print_cr("----------------------------------------------------------");
2574                //0000000000111111111122222222223333333333444444444455555555556666666666
2575                //0123456789012345678901234567890123456789012345678901234567890123456789
2576   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2577   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2578                 standard_compilation.seconds(),
2579                 standard_compilation.seconds() / standard_compile_count);
2580   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2581                 CompileBroker::_t_bailedout_compilation.seconds(),
2582                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2583   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2584                 osr_compilation.seconds(),
2585                 osr_compilation.seconds() / osr_compile_count);
2586   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2587                 CompileBroker::_t_invalidated_compilation.seconds(),
2588                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2589 
2590   AbstractCompiler *comp = compiler(CompLevel_simple);
2591   if (comp != NULL) {
2592     tty-&gt;cr();
2593     comp-&gt;print_timers();
2594   }
2595   comp = compiler(CompLevel_full_optimization);
2596   if (comp != NULL) {
2597     tty-&gt;cr();
2598     comp-&gt;print_timers();
2599   }
2600   tty-&gt;cr();
2601   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2602   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2603   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2604   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2605   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2606   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2607   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2608   double tcs = total_compilation.seconds();
2609   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2610   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2611   tty-&gt;cr();
2612   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2613   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2614 }
2615 
2616 // Debugging output for failure
2617 void CompileBroker::print_last_compile() {
2618   if (_last_compile_level != CompLevel_none &amp;&amp;
2619       compiler(_last_compile_level) != NULL &amp;&amp;
2620       _last_compile_type != no_compile) {
2621     if (_last_compile_type == osr_compile) {
2622       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2623                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2624     } else {
2625       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2626                     _compilation_id, _last_compile_level, _last_method_compiled);
2627     }
2628   }
2629 }
2630 
2631 // Print general/accumulated JIT information.
2632 void CompileBroker::print_info(outputStream *out) {
2633   if (out == NULL) out = tty;
2634   out-&gt;cr();
2635   out-&gt;print_cr("======================");
2636   out-&gt;print_cr("   General JIT info   ");
2637   out-&gt;print_cr("======================");
2638   out-&gt;cr();
2639   out-&gt;print_cr("            JIT is : %7s",     should_compile_new_jobs() ? "on" : "off");
2640   out-&gt;print_cr("  Compiler threads : %7d",     (int)CICompilerCount);
2641   out-&gt;cr();
2642   out-&gt;print_cr("CodeCache overview");
2643   out-&gt;print_cr("--------------------------------------------------------");
2644   out-&gt;cr();
2645   out-&gt;print_cr("         Reserved size : " SIZE_FORMAT_W(7) " KB", CodeCache::max_capacity() / K);
2646   out-&gt;print_cr("        Committed size : " SIZE_FORMAT_W(7) " KB", CodeCache::capacity() / K);
2647   out-&gt;print_cr("  Unallocated capacity : " SIZE_FORMAT_W(7) " KB", CodeCache::unallocated_capacity() / K);
2648   out-&gt;cr();
2649 
2650   out-&gt;cr();
2651   out-&gt;print_cr("CodeCache cleaning overview");
2652   out-&gt;print_cr("--------------------------------------------------------");
2653   out-&gt;cr();
2654   NMethodSweeper::print(out);
2655   out-&gt;print_cr("--------------------------------------------------------");
2656   out-&gt;cr();
2657 }
2658 
2659 // Note: tty_lock must not be held upon entry to this function.
2660 //       Print functions called from herein do "micro-locking" on tty_lock.
2661 //       That's a tradeoff which keeps together important blocks of output.
2662 //       At the same time, continuous tty_lock hold time is kept in check,
2663 //       preventing concurrently printing threads from stalling a long time.
2664 void CompileBroker::print_heapinfo(outputStream* out, const char* function, const char* granularity) {
2665   TimeStamp ts_total;
2666   TimeStamp ts_global;
2667   TimeStamp ts;
2668 
2669   bool allFun = !strcmp(function, "all");
2670   bool aggregate = !strcmp(function, "aggregate") || !strcmp(function, "analyze") || allFun;
2671   bool usedSpace = !strcmp(function, "UsedSpace") || allFun;
2672   bool freeSpace = !strcmp(function, "FreeSpace") || allFun;
2673   bool methodCount = !strcmp(function, "MethodCount") || allFun;
2674   bool methodSpace = !strcmp(function, "MethodSpace") || allFun;
2675   bool methodAge = !strcmp(function, "MethodAge") || allFun;
2676   bool methodNames = !strcmp(function, "MethodNames") || allFun;
2677   bool discard = !strcmp(function, "discard") || allFun;
2678 
2679   if (out == NULL) {
2680     out = tty;
2681   }
2682 
2683   if (!(aggregate || usedSpace || freeSpace || methodCount || methodSpace || methodAge || methodNames || discard)) {
2684     out-&gt;print_cr("\n__ CodeHeapStateAnalytics: Function %s is not supported", function);
2685     out-&gt;cr();
2686     return;
2687   }
2688 
2689   ts_total.update(); // record starting point
2690 
2691   if (aggregate) {
2692     print_info(out);
2693   }
2694 
2695   // We hold the CodeHeapStateAnalytics_lock all the time, from here until we leave this function.
2696   // That prevents another thread from destroying our view on the CodeHeap.
2697   // When we request individual parts of the analysis via the jcmd interface, it is possible
2698   // that in between another thread (another jcmd user or the vm running into CodeCache OOM)
2699   // updated the aggregated data. That's a tolerable tradeoff because we can't hold a lock
2700   // across user interaction.
2701   // Acquire this lock before acquiring the CodeCache_lock.
2702   // CodeHeapStateAnalytics_lock could be held by a concurrent thread for a long time,
2703   // leading to an unnecessarily long hold time of the CodeCache_lock.
2704   ts.update(); // record starting point
2705   MutexLockerEx mu1(CodeHeapStateAnalytics_lock, Mutex::_no_safepoint_check_flag);
2706   out-&gt;print_cr("\n__ CodeHeapStateAnalytics lock wait took %10.3f seconds _________\n", ts.seconds());
2707 
2708   // If we serve an "allFun" call, it is beneficial to hold the CodeCache_lock
2709   // for the entire duration of aggregation and printing. That makes sure
2710   // we see a consistent picture and do not run into issues caused by
2711   // the CodeHeap being altered concurrently.
2712   Monitor* global_lock   = allFun ? CodeCache_lock : NULL;
2713   Monitor* function_lock = allFun ? NULL : CodeCache_lock;
2714   ts_global.update(); // record starting point
2715   MutexLockerEx mu2(global_lock, Mutex::_no_safepoint_check_flag);
2716   if (global_lock != NULL) {
2717     out-&gt;print_cr("\n__ CodeCache (global) lock wait took %10.3f seconds _________\n", ts_global.seconds());
2718     ts_global.update(); // record starting point
2719   }
2720 
2721   if (aggregate) {
2722     ts.update(); // record starting point
2723     MutexLockerEx mu3(function_lock, Mutex::_no_safepoint_check_flag);
2724     if (function_lock != NULL) {
2725       out-&gt;print_cr("\n__ CodeCache (function) lock wait took %10.3f seconds _________\n", ts.seconds());
2726     }
2727 
2728     ts.update(); // record starting point
2729     CodeCache::aggregate(out, granularity);
2730     if (function_lock != NULL) {
2731       out-&gt;print_cr("\n__ CodeCache (function) lock hold took %10.3f seconds _________\n", ts.seconds());
2732     }
2733   }
2734 
2735   if (usedSpace) CodeCache::print_usedSpace(out);
2736   if (freeSpace) CodeCache::print_freeSpace(out);
2737   if (methodCount) CodeCache::print_count(out);
2738   if (methodSpace) CodeCache::print_space(out);
2739   if (methodAge) CodeCache::print_age(out);
2740   if (methodNames) {
2741     // print_names() has shown to be sensitive to concurrent CodeHeap modifications.
2742     // Therefore, request  the CodeCache_lock before calling...
2743     MutexLockerEx mu3(function_lock, Mutex::_no_safepoint_check_flag);
2744     CodeCache::print_names(out);
2745   }
2746   if (discard) CodeCache::discard(out);
2747 
2748   if (global_lock != NULL) {
2749     out-&gt;print_cr("\n__ CodeCache (global) lock hold took %10.3f seconds _________\n", ts_global.seconds());
2750   }
2751   out-&gt;print_cr("\n__ CodeHeapStateAnalytics total duration %10.3f seconds _________\n", ts_total.seconds());
2752 }
</pre></body></html>
