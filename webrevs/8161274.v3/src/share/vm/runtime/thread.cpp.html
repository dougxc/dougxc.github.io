<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaClasses.hpp"
  28 #include "classfile/moduleEntry.hpp"
  29 #include "classfile/systemDictionary.hpp"
  30 #include "classfile/vmSymbols.hpp"
  31 #include "code/codeCache.hpp"
  32 #include "code/codeCacheExtensions.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/gcId.hpp"
  37 #include "gc/shared/gcLocker.inline.hpp"
  38 #include "gc/shared/referencePendingListLocker.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jvmtifiles/jvmtiEnv.hpp"
  44 #include "logging/log.hpp"
  45 #include "logging/logConfiguration.hpp"
  46 #include "memory/metaspaceShared.hpp"
  47 #include "memory/oopFactory.hpp"
  48 #include "memory/resourceArea.hpp"
  49 #include "memory/universe.inline.hpp"
  50 #include "oops/instanceKlass.hpp"
  51 #include "oops/objArrayOop.hpp"
  52 #include "oops/oop.inline.hpp"
  53 #include "oops/symbol.hpp"
  54 #include "oops/verifyOopClosure.hpp"
  55 #include "prims/jvm_misc.hpp"
  56 #include "prims/jvmtiExport.hpp"
  57 #include "prims/jvmtiThreadState.hpp"
  58 #include "prims/privilegedStack.hpp"
  59 #include "runtime/arguments.hpp"
  60 #include "runtime/atomic.inline.hpp"
  61 #include "runtime/biasedLocking.hpp"
  62 #include "runtime/commandLineFlagConstraintList.hpp"
  63 #include "runtime/commandLineFlagWriteableList.hpp"
  64 #include "runtime/commandLineFlagRangeList.hpp"
  65 #include "runtime/deoptimization.hpp"
  66 #include "runtime/fprofiler.hpp"
  67 #include "runtime/frame.inline.hpp"
  68 #include "runtime/globals.hpp"
  69 #include "runtime/init.hpp"
  70 #include "runtime/interfaceSupport.hpp"
  71 #include "runtime/java.hpp"
  72 #include "runtime/javaCalls.hpp"
  73 #include "runtime/jniPeriodicChecker.hpp"
  74 #include "runtime/timerTrace.hpp"
  75 #include "runtime/memprofiler.hpp"
  76 #include "runtime/mutexLocker.hpp"
  77 #include "runtime/objectMonitor.hpp"
  78 #include "runtime/orderAccess.inline.hpp"
  79 #include "runtime/osThread.hpp"
  80 #include "runtime/safepoint.hpp"
  81 #include "runtime/sharedRuntime.hpp"
  82 #include "runtime/statSampler.hpp"
  83 #include "runtime/stubRoutines.hpp"
  84 #include "runtime/sweeper.hpp"
  85 #include "runtime/task.hpp"
  86 #include "runtime/thread.inline.hpp"
  87 #include "runtime/threadCritical.hpp"
  88 #include "runtime/vframe.hpp"
  89 #include "runtime/vframeArray.hpp"
  90 #include "runtime/vframe_hp.hpp"
  91 #include "runtime/vmThread.hpp"
  92 #include "runtime/vm_operations.hpp"
  93 #include "runtime/vm_version.hpp"
  94 #include "services/attachListener.hpp"
  95 #include "services/management.hpp"
  96 #include "services/memTracker.hpp"
  97 #include "services/threadService.hpp"
  98 #include "trace/traceMacros.hpp"
  99 #include "trace/tracing.hpp"
 100 #include "utilities/defaultStream.hpp"
 101 #include "utilities/dtrace.hpp"
 102 #include "utilities/events.hpp"
 103 #include "utilities/macros.hpp"
 104 #include "utilities/preserveException.hpp"
 105 #if INCLUDE_ALL_GCS
 106 #include "gc/cms/concurrentMarkSweepThread.hpp"
 107 #include "gc/g1/concurrentMarkThread.inline.hpp"
 108 #include "gc/parallel/pcTasks.hpp"
 109 #endif // INCLUDE_ALL_GCS
 110 #if INCLUDE_JVMCI
 111 #include "jvmci/jvmciCompiler.hpp"
 112 #include "jvmci/jvmciRuntime.hpp"
 113 #endif
 114 #ifdef COMPILER1
 115 #include "c1/c1_Compiler.hpp"
 116 #endif
 117 #ifdef COMPILER2
 118 #include "opto/c2compiler.hpp"
 119 #include "opto/idealGraphPrinter.hpp"
 120 #endif
 121 #if INCLUDE_RTM_OPT
 122 #include "runtime/rtmLocking.hpp"
 123 #endif
 124 
 125 // Initialization after module runtime initialization
 126 void universe_post_module_init();  // must happen after call_initPhase2
 127 
 128 #ifdef DTRACE_ENABLED
 129 
 130 // Only bother with this argument setup if dtrace is available
 131 
 132   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 133   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 134 
 135   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 136     {                                                                      \
 137       ResourceMark rm(this);                                               \
 138       int len = 0;                                                         \
 139       const char* name = (javathread)-&gt;get_thread_name();                  \
 140       len = strlen(name);                                                  \
 141       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 142         (char *) name, len,                                                \
 143         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 144         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 145         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 146     }
 147 
 148 #else //  ndef DTRACE_ENABLED
 149 
 150   #define DTRACE_THREAD_PROBE(probe, javathread)
 151 
 152 #endif // ndef DTRACE_ENABLED
 153 
 154 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 155 // Current thread is maintained as a thread-local variable
 156 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 157 #endif
 158 // Class hierarchy
 159 // - Thread
 160 //   - VMThread
 161 //   - WatcherThread
 162 //   - ConcurrentMarkSweepThread
 163 //   - JavaThread
 164 //     - CompilerThread
 165 
 166 // ======= Thread ========
 167 // Support for forcing alignment of thread objects for biased locking
 168 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 169   if (UseBiasedLocking) {
 170     const int alignment = markOopDesc::biased_lock_alignment;
 171     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 172     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 173                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 174                                                          AllocFailStrategy::RETURN_NULL);
 175     void* aligned_addr     = (void*) align_size_up((intptr_t) real_malloc_addr, alignment);
 176     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 177            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 178            "JavaThread alignment code overflowed allocated storage");
 179     if (aligned_addr != real_malloc_addr) {
 180       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 181                               p2i(real_malloc_addr),
 182                               p2i(aligned_addr));
 183     }
 184     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 185     return aligned_addr;
 186   } else {
 187     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 188                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 189   }
 190 }
 191 
 192 void Thread::operator delete(void* p) {
 193   if (UseBiasedLocking) {
 194     void* real_malloc_addr = ((Thread*) p)-&gt;_real_malloc_address;
 195     FreeHeap(real_malloc_addr);
 196   } else {
 197     FreeHeap(p);
 198   }
 199 }
 200 
 201 
 202 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 203 // JavaThread
 204 
 205 
 206 Thread::Thread() {
 207   // stack and get_thread
 208   set_stack_base(NULL);
 209   set_stack_size(0);
 210   set_self_raw_id(0);
 211   set_lgrp_id(-1);
 212   DEBUG_ONLY(clear_suspendible_thread();)
 213 
 214   // allocated data structures
 215   set_osthread(NULL);
 216   set_resource_area(new (mtThread)ResourceArea());
 217   DEBUG_ONLY(_current_resource_mark = NULL;)
 218   set_handle_area(new (mtThread) HandleArea(NULL));
 219   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 220   set_active_handles(NULL);
 221   set_free_handle_block(NULL);
 222   set_last_handle_mark(NULL);
 223 
 224   // This initial value ==&gt; never claimed.
 225   _oops_do_parity = 0;
 226 
 227   // the handle mark links itself to last_handle_mark
 228   new HandleMark(this);
 229 
 230   // plain initialization
 231   debug_only(_owned_locks = NULL;)
 232   debug_only(_allow_allocation_count = 0;)
 233   NOT_PRODUCT(_allow_safepoint_count = 0;)
 234   NOT_PRODUCT(_skip_gcalot = false;)
 235   _jvmti_env_iteration_count = 0;
 236   set_allocated_bytes(0);
 237   _vm_operation_started_count = 0;
 238   _vm_operation_completed_count = 0;
 239   _current_pending_monitor = NULL;
 240   _current_pending_monitor_is_from_java = true;
 241   _current_waiting_monitor = NULL;
 242   _num_nested_signal = 0;
 243   omFreeList = NULL;
 244   omFreeCount = 0;
 245   omFreeProvision = 32;
 246   omInUseList = NULL;
 247   omInUseCount = 0;
 248 
 249 #ifdef ASSERT
 250   _visited_for_critical_count = false;
 251 #endif
 252 
 253   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 254                          Monitor::_safepoint_check_sometimes);
 255   _suspend_flags = 0;
 256 
 257   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 258   _hashStateX = os::random();
 259   _hashStateY = 842502087;
 260   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 261   _hashStateW = 273326509;
 262 
 263   _OnTrap   = 0;
 264   _schedctl = NULL;
 265   _Stalled  = 0;
 266   _TypeTag  = 0x2BAD;
 267 
 268   // Many of the following fields are effectively final - immutable
 269   // Note that nascent threads can't use the Native Monitor-Mutex
 270   // construct until the _MutexEvent is initialized ...
 271   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 272   // we might instead use a stack of ParkEvents that we could provision on-demand.
 273   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 274   // and ::Release()
 275   _ParkEvent   = ParkEvent::Allocate(this);
 276   _SleepEvent  = ParkEvent::Allocate(this);
 277   _MutexEvent  = ParkEvent::Allocate(this);
 278   _MuxEvent    = ParkEvent::Allocate(this);
 279 
 280 #ifdef CHECK_UNHANDLED_OOPS
 281   if (CheckUnhandledOops) {
 282     _unhandled_oops = new UnhandledOops(this);
 283   }
 284 #endif // CHECK_UNHANDLED_OOPS
 285 #ifdef ASSERT
 286   if (UseBiasedLocking) {
 287     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 288     assert(this == _real_malloc_address ||
 289            this == (void*) align_size_up((intptr_t) _real_malloc_address, markOopDesc::biased_lock_alignment),
 290            "bug in forced alignment of thread objects");
 291   }
 292 #endif // ASSERT
 293 }
 294 
 295 void Thread::initialize_thread_current() {
 296 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 297   assert(_thr_current == NULL, "Thread::current already initialized");
 298   _thr_current = this;
 299 #endif
 300   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 301   ThreadLocalStorage::set_thread(this);
 302   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 303 }
 304 
 305 void Thread::clear_thread_current() {
 306   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 307 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 308   _thr_current = NULL;
 309 #endif
 310   ThreadLocalStorage::set_thread(NULL);
 311 }
 312 
 313 void Thread::record_stack_base_and_size() {
 314   set_stack_base(os::current_stack_base());
 315   set_stack_size(os::current_stack_size());
 316   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 317   // in initialize_thread(). Without the adjustment, stack size is
 318   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 319   // So far, only Solaris has real implementation of initialize_thread().
 320   //
 321   // set up any platform-specific state.
 322   os::initialize_thread(this);
 323 
 324   // Set stack limits after thread is initialized.
 325   if (is_Java_thread()) {
 326     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 327     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 328   }
 329 #if INCLUDE_NMT
 330   // record thread's native stack, stack grows downward
 331   MemTracker::record_thread_stack(stack_end(), stack_size());
 332 #endif // INCLUDE_NMT
 333   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 334     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 335     os::current_thread_id(), p2i(stack_base() - stack_size()),
 336     p2i(stack_base()), stack_size()/1024);
 337 }
 338 
 339 
 340 Thread::~Thread() {
 341   // Reclaim the objectmonitors from the omFreeList of the moribund thread.
 342   ObjectSynchronizer::omFlush(this);
 343 
 344   EVENT_THREAD_DESTRUCT(this);
 345 
 346   // stack_base can be NULL if the thread is never started or exited before
 347   // record_stack_base_and_size called. Although, we would like to ensure
 348   // that all started threads do call record_stack_base_and_size(), there is
 349   // not proper way to enforce that.
 350 #if INCLUDE_NMT
 351   if (_stack_base != NULL) {
 352     MemTracker::release_thread_stack(stack_end(), stack_size());
 353 #ifdef ASSERT
 354     set_stack_base(NULL);
 355 #endif
 356   }
 357 #endif // INCLUDE_NMT
 358 
 359   // deallocate data structures
 360   delete resource_area();
 361   // since the handle marks are using the handle area, we have to deallocated the root
 362   // handle mark before deallocating the thread's handle area,
 363   assert(last_handle_mark() != NULL, "check we have an element");
 364   delete last_handle_mark();
 365   assert(last_handle_mark() == NULL, "check we have reached the end");
 366 
 367   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 368   // We NULL out the fields for good hygiene.
 369   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 370   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 371   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 372   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 373 
 374   delete handle_area();
 375   delete metadata_handles();
 376 
 377   // osthread() can be NULL, if creation of thread failed.
 378   if (osthread() != NULL) os::free_thread(osthread());
 379 
 380   delete _SR_lock;
 381 
 382   // clear Thread::current if thread is deleting itself.
 383   // Needed to ensure JNI correctly detects non-attached threads.
 384   if (this == Thread::current()) {
 385     clear_thread_current();
 386   }
 387 
 388   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 389 }
 390 
 391 // NOTE: dummy function for assertion purpose.
 392 void Thread::run() {
 393   ShouldNotReachHere();
 394 }
 395 
 396 #ifdef ASSERT
 397 // Private method to check for dangling thread pointer
 398 void check_for_dangling_thread_pointer(Thread *thread) {
 399   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread || Threads_lock-&gt;owned_by_self(),
 400          "possibility of dangling Thread pointer");
 401 }
 402 #endif
 403 
 404 ThreadPriority Thread::get_priority(const Thread* const thread) {
 405   ThreadPriority priority;
 406   // Can return an error!
 407   (void)os::get_priority(thread, priority);
 408   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 409   return priority;
 410 }
 411 
 412 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 413   debug_only(check_for_dangling_thread_pointer(thread);)
 414   // Can return an error!
 415   (void)os::set_priority(thread, priority);
 416 }
 417 
 418 
 419 void Thread::start(Thread* thread) {
 420   // Start is different from resume in that its safety is guaranteed by context or
 421   // being called from a Java method synchronized on the Thread object.
 422   if (!DisableStartThread) {
 423     if (thread-&gt;is_Java_thread()) {
 424       // Initialize the thread state to RUNNABLE before starting this thread.
 425       // Can not set it after the thread started because we do not know the
 426       // exact thread state at that time. It could be in MONITOR_WAIT or
 427       // in SLEEPING or some other state.
 428       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 429                                           java_lang_Thread::RUNNABLE);
 430     }
 431     os::start_thread(thread);
 432   }
 433 }
 434 
 435 // Enqueue a VM_Operation to do the job for us - sometime later
 436 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 437   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 438   VMThread::execute(vm_stop);
 439 }
 440 
 441 
 442 // Check if an external suspend request has completed (or has been
 443 // cancelled). Returns true if the thread is externally suspended and
 444 // false otherwise.
 445 //
 446 // The bits parameter returns information about the code path through
 447 // the routine. Useful for debugging:
 448 //
 449 // set in is_ext_suspend_completed():
 450 // 0x00000001 - routine was entered
 451 // 0x00000010 - routine return false at end
 452 // 0x00000100 - thread exited (return false)
 453 // 0x00000200 - suspend request cancelled (return false)
 454 // 0x00000400 - thread suspended (return true)
 455 // 0x00001000 - thread is in a suspend equivalent state (return true)
 456 // 0x00002000 - thread is native and walkable (return true)
 457 // 0x00004000 - thread is native_trans and walkable (needed retry)
 458 //
 459 // set in wait_for_ext_suspend_completion():
 460 // 0x00010000 - routine was entered
 461 // 0x00020000 - suspend request cancelled before loop (return false)
 462 // 0x00040000 - thread suspended before loop (return true)
 463 // 0x00080000 - suspend request cancelled in loop (return false)
 464 // 0x00100000 - thread suspended in loop (return true)
 465 // 0x00200000 - suspend not completed during retry loop (return false)
 466 
 467 // Helper class for tracing suspend wait debug bits.
 468 //
 469 // 0x00000100 indicates that the target thread exited before it could
 470 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 471 // 0x00080000 each indicate a cancelled suspend request so they don't
 472 // count as wait failures either.
 473 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 474 
 475 class TraceSuspendDebugBits : public StackObj {
 476  private:
 477   JavaThread * jt;
 478   bool         is_wait;
 479   bool         called_by_wait;  // meaningful when !is_wait
 480   uint32_t *   bits;
 481 
 482  public:
 483   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 484                         uint32_t *_bits) {
 485     jt             = _jt;
 486     is_wait        = _is_wait;
 487     called_by_wait = _called_by_wait;
 488     bits           = _bits;
 489   }
 490 
 491   ~TraceSuspendDebugBits() {
 492     if (!is_wait) {
 493 #if 1
 494       // By default, don't trace bits for is_ext_suspend_completed() calls.
 495       // That trace is very chatty.
 496       return;
 497 #else
 498       if (!called_by_wait) {
 499         // If tracing for is_ext_suspend_completed() is enabled, then only
 500         // trace calls to it from wait_for_ext_suspend_completion()
 501         return;
 502       }
 503 #endif
 504     }
 505 
 506     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 507       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 508         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 509         ResourceMark rm;
 510 
 511         tty-&gt;print_cr(
 512                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 513                       jt-&gt;get_thread_name(), *bits);
 514 
 515         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 516       }
 517     }
 518   }
 519 };
 520 #undef DEBUG_FALSE_BITS
 521 
 522 
 523 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 524                                           uint32_t *bits) {
 525   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 526 
 527   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 528   bool do_trans_retry;           // flag to force the retry
 529 
 530   *bits |= 0x00000001;
 531 
 532   do {
 533     do_trans_retry = false;
 534 
 535     if (is_exiting()) {
 536       // Thread is in the process of exiting. This is always checked
 537       // first to reduce the risk of dereferencing a freed JavaThread.
 538       *bits |= 0x00000100;
 539       return false;
 540     }
 541 
 542     if (!is_external_suspend()) {
 543       // Suspend request is cancelled. This is always checked before
 544       // is_ext_suspended() to reduce the risk of a rogue resume
 545       // confusing the thread that made the suspend request.
 546       *bits |= 0x00000200;
 547       return false;
 548     }
 549 
 550     if (is_ext_suspended()) {
 551       // thread is suspended
 552       *bits |= 0x00000400;
 553       return true;
 554     }
 555 
 556     // Now that we no longer do hard suspends of threads running
 557     // native code, the target thread can be changing thread state
 558     // while we are in this routine:
 559     //
 560     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 561     //
 562     // We save a copy of the thread state as observed at this moment
 563     // and make our decision about suspend completeness based on the
 564     // copy. This closes the race where the thread state is seen as
 565     // _thread_in_native_trans in the if-thread_blocked check, but is
 566     // seen as _thread_blocked in if-thread_in_native_trans check.
 567     JavaThreadState save_state = thread_state();
 568 
 569     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 570       // If the thread's state is _thread_blocked and this blocking
 571       // condition is known to be equivalent to a suspend, then we can
 572       // consider the thread to be externally suspended. This means that
 573       // the code that sets _thread_blocked has been modified to do
 574       // self-suspension if the blocking condition releases. We also
 575       // used to check for CONDVAR_WAIT here, but that is now covered by
 576       // the _thread_blocked with self-suspension check.
 577       //
 578       // Return true since we wouldn't be here unless there was still an
 579       // external suspend request.
 580       *bits |= 0x00001000;
 581       return true;
 582     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 583       // Threads running native code will self-suspend on native==&gt;VM/Java
 584       // transitions. If its stack is walkable (should always be the case
 585       // unless this function is called before the actual java_suspend()
 586       // call), then the wait is done.
 587       *bits |= 0x00002000;
 588       return true;
 589     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 590                save_state == _thread_in_native_trans &amp;&amp;
 591                frame_anchor()-&gt;walkable()) {
 592       // The thread is transitioning from thread_in_native to another
 593       // thread state. check_safepoint_and_suspend_for_native_trans()
 594       // will force the thread to self-suspend. If it hasn't gotten
 595       // there yet we may have caught the thread in-between the native
 596       // code check above and the self-suspend. Lucky us. If we were
 597       // called by wait_for_ext_suspend_completion(), then it
 598       // will be doing the retries so we don't have to.
 599       //
 600       // Since we use the saved thread state in the if-statement above,
 601       // there is a chance that the thread has already transitioned to
 602       // _thread_blocked by the time we get here. In that case, we will
 603       // make a single unnecessary pass through the logic below. This
 604       // doesn't hurt anything since we still do the trans retry.
 605 
 606       *bits |= 0x00004000;
 607 
 608       // Once the thread leaves thread_in_native_trans for another
 609       // thread state, we break out of this retry loop. We shouldn't
 610       // need this flag to prevent us from getting back here, but
 611       // sometimes paranoia is good.
 612       did_trans_retry = true;
 613 
 614       // We wait for the thread to transition to a more usable state.
 615       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 616         // We used to do an "os::yield_all(i)" call here with the intention
 617         // that yielding would increase on each retry. However, the parameter
 618         // is ignored on Linux which means the yield didn't scale up. Waiting
 619         // on the SR_lock below provides a much more predictable scale up for
 620         // the delay. It also provides a simple/direct point to check for any
 621         // safepoint requests from the VMThread
 622 
 623         // temporarily drops SR_lock while doing wait with safepoint check
 624         // (if we're a JavaThread - the WatcherThread can also call this)
 625         // and increase delay with each retry
 626         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 627 
 628         // check the actual thread state instead of what we saved above
 629         if (thread_state() != _thread_in_native_trans) {
 630           // the thread has transitioned to another thread state so
 631           // try all the checks (except this one) one more time.
 632           do_trans_retry = true;
 633           break;
 634         }
 635       } // end retry loop
 636 
 637 
 638     }
 639   } while (do_trans_retry);
 640 
 641   *bits |= 0x00000010;
 642   return false;
 643 }
 644 
 645 // Wait for an external suspend request to complete (or be cancelled).
 646 // Returns true if the thread is externally suspended and false otherwise.
 647 //
 648 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 649                                                  uint32_t *bits) {
 650   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 651                              false /* !called_by_wait */, bits);
 652 
 653   // local flag copies to minimize SR_lock hold time
 654   bool is_suspended;
 655   bool pending;
 656   uint32_t reset_bits;
 657 
 658   // set a marker so is_ext_suspend_completed() knows we are the caller
 659   *bits |= 0x00010000;
 660 
 661   // We use reset_bits to reinitialize the bits value at the top of
 662   // each retry loop. This allows the caller to make use of any
 663   // unused bits for their own marking purposes.
 664   reset_bits = *bits;
 665 
 666   {
 667     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 668     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 669                                             delay, bits);
 670     pending = is_external_suspend();
 671   }
 672   // must release SR_lock to allow suspension to complete
 673 
 674   if (!pending) {
 675     // A cancelled suspend request is the only false return from
 676     // is_ext_suspend_completed() that keeps us from entering the
 677     // retry loop.
 678     *bits |= 0x00020000;
 679     return false;
 680   }
 681 
 682   if (is_suspended) {
 683     *bits |= 0x00040000;
 684     return true;
 685   }
 686 
 687   for (int i = 1; i &lt;= retries; i++) {
 688     *bits = reset_bits;  // reinit to only track last retry
 689 
 690     // We used to do an "os::yield_all(i)" call here with the intention
 691     // that yielding would increase on each retry. However, the parameter
 692     // is ignored on Linux which means the yield didn't scale up. Waiting
 693     // on the SR_lock below provides a much more predictable scale up for
 694     // the delay. It also provides a simple/direct point to check for any
 695     // safepoint requests from the VMThread
 696 
 697     {
 698       MutexLocker ml(SR_lock());
 699       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 700       // can also call this)  and increase delay with each retry
 701       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 702 
 703       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 704                                               delay, bits);
 705 
 706       // It is possible for the external suspend request to be cancelled
 707       // (by a resume) before the actual suspend operation is completed.
 708       // Refresh our local copy to see if we still need to wait.
 709       pending = is_external_suspend();
 710     }
 711 
 712     if (!pending) {
 713       // A cancelled suspend request is the only false return from
 714       // is_ext_suspend_completed() that keeps us from staying in the
 715       // retry loop.
 716       *bits |= 0x00080000;
 717       return false;
 718     }
 719 
 720     if (is_suspended) {
 721       *bits |= 0x00100000;
 722       return true;
 723     }
 724   } // end retry loop
 725 
 726   // thread did not suspend after all our retries
 727   *bits |= 0x00200000;
 728   return false;
 729 }
 730 
 731 #ifndef PRODUCT
 732 void JavaThread::record_jump(address target, address instr, const char* file,
 733                              int line) {
 734 
 735   // This should not need to be atomic as the only way for simultaneous
 736   // updates is via interrupts. Even then this should be rare or non-existent
 737   // and we don't care that much anyway.
 738 
 739   int index = _jmp_ring_index;
 740   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 741   _jmp_ring[index]._target = (intptr_t) target;
 742   _jmp_ring[index]._instruction = (intptr_t) instr;
 743   _jmp_ring[index]._file = file;
 744   _jmp_ring[index]._line = line;
 745 }
 746 #endif // PRODUCT
 747 
 748 // Called by flat profiler
 749 // Callers have already called wait_for_ext_suspend_completion
 750 // The assertion for that is currently too complex to put here:
 751 bool JavaThread::profile_last_Java_frame(frame* _fr) {
 752   bool gotframe = false;
 753   // self suspension saves needed state.
 754   if (has_last_Java_frame() &amp;&amp; _anchor.walkable()) {
 755     *_fr = pd_last_frame();
 756     gotframe = true;
 757   }
 758   return gotframe;
 759 }
 760 
 761 void Thread::interrupt(Thread* thread) {
 762   debug_only(check_for_dangling_thread_pointer(thread);)
 763   os::interrupt(thread);
 764 }
 765 
 766 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 767   debug_only(check_for_dangling_thread_pointer(thread);)
 768   // Note:  If clear_interrupted==false, this simply fetches and
 769   // returns the value of the field osthread()-&gt;interrupted().
 770   return os::is_interrupted(thread, clear_interrupted);
 771 }
 772 
 773 
 774 // GC Support
 775 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 776   jint thread_parity = _oops_do_parity;
 777   if (thread_parity != strong_roots_parity) {
 778     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 779     if (res == thread_parity) {
 780       return true;
 781     } else {
 782       guarantee(res == strong_roots_parity, "Or else what?");
 783       return false;
 784     }
 785   }
 786   return false;
 787 }
 788 
 789 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 790   active_handles()-&gt;oops_do(f);
 791   // Do oop for ThreadShadow
 792   f-&gt;do_oop((oop*)&amp;_pending_exception);
 793   handle_area()-&gt;oops_do(f);
 794 }
 795 
 796 void Thread::metadata_handles_do(void f(Metadata*)) {
 797   // Only walk the Handles in Thread.
 798   if (metadata_handles() != NULL) {
 799     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 800       f(metadata_handles()-&gt;at(i));
 801     }
 802   }
 803 }
 804 
 805 void Thread::print_on(outputStream* st) const {
 806   // get_priority assumes osthread initialized
 807   if (osthread() != NULL) {
 808     int os_prio;
 809     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 810       st-&gt;print("os_prio=%d ", os_prio);
 811     }
 812     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 813     ext().print_on(st);
 814     osthread()-&gt;print_on(st);
 815   }
 816   debug_only(if (WizardMode) print_owned_locks_on(st);)
 817 }
 818 
 819 // Thread::print_on_error() is called by fatal error handler. Don't use
 820 // any lock or allocate memory.
 821 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 822   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 823 
 824   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 825   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 826   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 827   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 828   else                                { st-&gt;print("Thread"); }
 829 
 830   if (is_Named_thread()) {
 831     st-&gt;print(" \"%s\"", name());
 832   }
 833 
 834   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 835             p2i(stack_end()), p2i(stack_base()));
 836 
 837   if (osthread()) {
 838     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 839   }
 840 }
 841 
 842 #ifdef ASSERT
 843 void Thread::print_owned_locks_on(outputStream* st) const {
 844   Monitor *cur = _owned_locks;
 845   if (cur == NULL) {
 846     st-&gt;print(" (no locks) ");
 847   } else {
 848     st-&gt;print_cr(" Locks owned:");
 849     while (cur) {
 850       cur-&gt;print_on(st);
 851       cur = cur-&gt;next();
 852     }
 853   }
 854 }
 855 
 856 static int ref_use_count  = 0;
 857 
 858 bool Thread::owns_locks_but_compiled_lock() const {
 859   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 860     if (cur != Compile_lock) return true;
 861   }
 862   return false;
 863 }
 864 
 865 
 866 #endif
 867 
 868 #ifndef PRODUCT
 869 
 870 // The flag: potential_vm_operation notifies if this particular safepoint state could potential
 871 // invoke the vm-thread (i.e., and oop allocation). In that case, we also have to make sure that
 872 // no threads which allow_vm_block's are held
 873 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 874   // Check if current thread is allowed to block at a safepoint
 875   if (!(_allow_safepoint_count == 0)) {
 876     fatal("Possible safepoint reached by thread that does not allow it");
 877   }
 878   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 879     fatal("LEAF method calling lock?");
 880   }
 881 
 882 #ifdef ASSERT
 883   if (potential_vm_operation &amp;&amp; is_Java_thread()
 884       &amp;&amp; !Universe::is_bootstrapping()) {
 885     // Make sure we do not hold any locks that the VM thread also uses.
 886     // This could potentially lead to deadlocks
 887     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 888       // Threads_lock is special, since the safepoint synchronization will not start before this is
 889       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 890       // since it is used to transfer control between JavaThreads and the VMThread
 891       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 892       if ((cur-&gt;allow_vm_block() &amp;&amp;
 893            cur != Threads_lock &amp;&amp;
 894            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 895            cur != VMOperationRequest_lock &amp;&amp;
 896            cur != VMOperationQueue_lock) ||
 897            cur-&gt;rank() == Mutex::special) {
 898         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 899       }
 900     }
 901   }
 902 
 903   if (GCALotAtAllSafepoints) {
 904     // We could enter a safepoint here and thus have a gc
 905     InterfaceSupport::check_gc_alot();
 906   }
 907 #endif
 908 }
 909 #endif
 910 
 911 bool Thread::is_in_stack(address adr) const {
 912   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
 913   address end = os::current_stack_pointer();
 914   // Allow non Java threads to call this without stack_base
 915   if (_stack_base == NULL) return true;
 916   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
 917 
 918   return false;
 919 }
 920 
 921 bool Thread::is_in_usable_stack(address adr) const {
 922   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
 923   size_t usable_stack_size = _stack_size - stack_guard_size;
 924 
 925   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
 926 }
 927 
 928 
 929 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
 930 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
 931 // used for compilation in the future. If that change is made, the need for these methods
 932 // should be revisited, and they should be removed if possible.
 933 
 934 bool Thread::is_lock_owned(address adr) const {
 935   return on_local_stack(adr);
 936 }
 937 
 938 bool Thread::set_as_starting_thread() {
 939   // NOTE: this must be called inside the main thread.
 940   return os::create_main_thread((JavaThread*)this);
 941 }
 942 
 943 static void initialize_class(Symbol* class_name, TRAPS) {
 944   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
 945   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
 946 }
 947 
 948 
 949 // Creates the initial ThreadGroup
 950 static Handle create_initial_thread_group(TRAPS) {
 951   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_ThreadGroup(), true, CHECK_NH);
 952   instanceKlassHandle klass (THREAD, k);
 953 
 954   Handle system_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 955   {
 956     JavaValue result(T_VOID);
 957     JavaCalls::call_special(&amp;result,
 958                             system_instance,
 959                             klass,
 960                             vmSymbols::object_initializer_name(),
 961                             vmSymbols::void_method_signature(),
 962                             CHECK_NH);
 963   }
 964   Universe::set_system_thread_group(system_instance());
 965 
 966   Handle main_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 967   {
 968     JavaValue result(T_VOID);
 969     Handle string = java_lang_String::create_from_str("main", CHECK_NH);
 970     JavaCalls::call_special(&amp;result,
 971                             main_instance,
 972                             klass,
 973                             vmSymbols::object_initializer_name(),
 974                             vmSymbols::threadgroup_string_void_signature(),
 975                             system_instance,
 976                             string,
 977                             CHECK_NH);
 978   }
 979   return main_instance;
 980 }
 981 
 982 // Creates the initial Thread
 983 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
 984                                  TRAPS) {
 985   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_NULL);
 986   instanceKlassHandle klass (THREAD, k);
 987   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_NULL);
 988 
 989   java_lang_Thread::set_thread(thread_oop(), thread);
 990   java_lang_Thread::set_priority(thread_oop(), NormPriority);
 991   thread-&gt;set_threadObj(thread_oop());
 992 
 993   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
 994 
 995   JavaValue result(T_VOID);
 996   JavaCalls::call_special(&amp;result, thread_oop,
 997                           klass,
 998                           vmSymbols::object_initializer_name(),
 999                           vmSymbols::threadgroup_string_void_signature(),
1000                           thread_group,
1001                           string,
1002                           CHECK_NULL);
1003   return thread_oop();
1004 }
1005 
1006 char java_runtime_name[128] = "";
1007 char java_runtime_version[128] = "";
1008 
1009 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1010 static const char* get_java_runtime_name(TRAPS) {
1011   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1012                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1013   fieldDescriptor fd;
1014   bool found = k != NULL &amp;&amp;
1015                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1016                                                         vmSymbols::string_signature(), &amp;fd);
1017   if (found) {
1018     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1019     if (name_oop == NULL) {
1020       return NULL;
1021     }
1022     const char* name = java_lang_String::as_utf8_string(name_oop,
1023                                                         java_runtime_name,
1024                                                         sizeof(java_runtime_name));
1025     return name;
1026   } else {
1027     return NULL;
1028   }
1029 }
1030 
1031 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1032 static const char* get_java_runtime_version(TRAPS) {
1033   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1034                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1035   fieldDescriptor fd;
1036   bool found = k != NULL &amp;&amp;
1037                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1038                                                         vmSymbols::string_signature(), &amp;fd);
1039   if (found) {
1040     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1041     if (name_oop == NULL) {
1042       return NULL;
1043     }
1044     const char* name = java_lang_String::as_utf8_string(name_oop,
1045                                                         java_runtime_version,
1046                                                         sizeof(java_runtime_version));
1047     return name;
1048   } else {
1049     return NULL;
1050   }
1051 }
1052 
1053 // General purpose hook into Java code, run once when the VM is initialized.
1054 // The Java library method itself may be changed independently from the VM.
1055 static void call_postVMInitHook(TRAPS) {
1056   Klass* k = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1057   instanceKlassHandle klass (THREAD, k);
1058   if (klass.not_null()) {
1059     JavaValue result(T_VOID);
1060     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1061                            vmSymbols::void_method_signature(),
1062                            CHECK);
1063   }
1064 }
1065 
1066 static void reset_vm_info_property(TRAPS) {
1067   // the vm info string
1068   ResourceMark rm(THREAD);
1069   const char *vm_info = VM_Version::vm_info_string();
1070 
1071   // java.lang.System class
1072   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
1073   instanceKlassHandle klass (THREAD, k);
1074 
1075   // setProperty arguments
1076   Handle key_str    = java_lang_String::create_from_str("java.vm.info", CHECK);
1077   Handle value_str  = java_lang_String::create_from_str(vm_info, CHECK);
1078 
1079   // return value
1080   JavaValue r(T_OBJECT);
1081 
1082   // public static String setProperty(String key, String value);
1083   JavaCalls::call_static(&amp;r,
1084                          klass,
1085                          vmSymbols::setProperty_name(),
1086                          vmSymbols::string_string_string_signature(),
1087                          key_str,
1088                          value_str,
1089                          CHECK);
1090 }
1091 
1092 
1093 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1094                                     bool daemon, TRAPS) {
1095   assert(thread_group.not_null(), "thread group should be specified");
1096   assert(threadObj() == NULL, "should only create Java thread object once");
1097 
1098   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK);
1099   instanceKlassHandle klass (THREAD, k);
1100   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK);
1101 
1102   java_lang_Thread::set_thread(thread_oop(), this);
1103   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1104   set_threadObj(thread_oop());
1105 
1106   JavaValue result(T_VOID);
1107   if (thread_name != NULL) {
1108     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1109     // Thread gets assigned specified name and null target
1110     JavaCalls::call_special(&amp;result,
1111                             thread_oop,
1112                             klass,
1113                             vmSymbols::object_initializer_name(),
1114                             vmSymbols::threadgroup_string_void_signature(),
1115                             thread_group, // Argument 1
1116                             name,         // Argument 2
1117                             THREAD);
1118   } else {
1119     // Thread gets assigned name "Thread-nnn" and null target
1120     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1121     JavaCalls::call_special(&amp;result,
1122                             thread_oop,
1123                             klass,
1124                             vmSymbols::object_initializer_name(),
1125                             vmSymbols::threadgroup_runnable_void_signature(),
1126                             thread_group, // Argument 1
1127                             Handle(),     // Argument 2
1128                             THREAD);
1129   }
1130 
1131 
1132   if (daemon) {
1133     java_lang_Thread::set_daemon(thread_oop());
1134   }
1135 
1136   if (HAS_PENDING_EXCEPTION) {
1137     return;
1138   }
1139 
1140   KlassHandle group(THREAD, SystemDictionary::ThreadGroup_klass());
1141   Handle threadObj(THREAD, this-&gt;threadObj());
1142 
1143   JavaCalls::call_special(&amp;result,
1144                           thread_group,
1145                           group,
1146                           vmSymbols::add_method_name(),
1147                           vmSymbols::thread_void_signature(),
1148                           threadObj,          // Arg 1
1149                           THREAD);
1150 }
1151 
1152 // NamedThread --  non-JavaThread subclasses with multiple
1153 // uniquely named instances should derive from this.
1154 NamedThread::NamedThread() : Thread() {
1155   _name = NULL;
1156   _processed_thread = NULL;
1157   _gc_id = GCId::undefined();
1158 }
1159 
1160 NamedThread::~NamedThread() {
1161   if (_name != NULL) {
1162     FREE_C_HEAP_ARRAY(char, _name);
1163     _name = NULL;
1164   }
1165 }
1166 
1167 void NamedThread::set_name(const char* format, ...) {
1168   guarantee(_name == NULL, "Only get to set name once.");
1169   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1170   guarantee(_name != NULL, "alloc failure");
1171   va_list ap;
1172   va_start(ap, format);
1173   jio_vsnprintf(_name, max_name_len, format, ap);
1174   va_end(ap);
1175 }
1176 
1177 void NamedThread::initialize_named_thread() {
1178   set_native_thread_name(name());
1179 }
1180 
1181 void NamedThread::print_on(outputStream* st) const {
1182   st-&gt;print("\"%s\" ", name());
1183   Thread::print_on(st);
1184   st-&gt;cr();
1185 }
1186 
1187 
1188 // ======= WatcherThread ========
1189 
1190 // The watcher thread exists to simulate timer interrupts.  It should
1191 // be replaced by an abstraction over whatever native support for
1192 // timer interrupts exists on the platform.
1193 
1194 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1195 bool WatcherThread::_startable = false;
1196 volatile bool  WatcherThread::_should_terminate = false;
1197 
1198 WatcherThread::WatcherThread() : Thread(), _crash_protection(NULL) {
1199   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1200   if (os::create_thread(this, os::watcher_thread)) {
1201     _watcher_thread = this;
1202 
1203     // Set the watcher thread to the highest OS priority which should not be
1204     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1205     // is created. The only normal thread using this priority is the reference
1206     // handler thread, which runs for very short intervals only.
1207     // If the VMThread's priority is not lower than the WatcherThread profiling
1208     // will be inaccurate.
1209     os::set_priority(this, MaxPriority);
1210     if (!DisableStartThread) {
1211       os::start_thread(this);
1212     }
1213   }
1214 }
1215 
1216 int WatcherThread::sleep() const {
1217   // The WatcherThread does not participate in the safepoint protocol
1218   // for the PeriodicTask_lock because it is not a JavaThread.
1219   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1220 
1221   if (_should_terminate) {
1222     // check for termination before we do any housekeeping or wait
1223     return 0;  // we did not sleep.
1224   }
1225 
1226   // remaining will be zero if there are no tasks,
1227   // causing the WatcherThread to sleep until a task is
1228   // enrolled
1229   int remaining = PeriodicTask::time_to_wait();
1230   int time_slept = 0;
1231 
1232   // we expect this to timeout - we only ever get unparked when
1233   // we should terminate or when a new task has been enrolled
1234   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1235 
1236   jlong time_before_loop = os::javaTimeNanos();
1237 
1238   while (true) {
1239     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1240                                             remaining);
1241     jlong now = os::javaTimeNanos();
1242 
1243     if (remaining == 0) {
1244       // if we didn't have any tasks we could have waited for a long time
1245       // consider the time_slept zero and reset time_before_loop
1246       time_slept = 0;
1247       time_before_loop = now;
1248     } else {
1249       // need to recalculate since we might have new tasks in _tasks
1250       time_slept = (int) ((now - time_before_loop) / 1000000);
1251     }
1252 
1253     // Change to task list or spurious wakeup of some kind
1254     if (timedout || _should_terminate) {
1255       break;
1256     }
1257 
1258     remaining = PeriodicTask::time_to_wait();
1259     if (remaining == 0) {
1260       // Last task was just disenrolled so loop around and wait until
1261       // another task gets enrolled
1262       continue;
1263     }
1264 
1265     remaining -= time_slept;
1266     if (remaining &lt;= 0) {
1267       break;
1268     }
1269   }
1270 
1271   return time_slept;
1272 }
1273 
1274 void WatcherThread::run() {
1275   assert(this == watcher_thread(), "just checking");
1276 
1277   this-&gt;record_stack_base_and_size();
1278   this-&gt;set_native_thread_name(this-&gt;name());
1279   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1280   while (true) {
1281     assert(watcher_thread() == Thread::current(), "thread consistency check");
1282     assert(watcher_thread() == this, "thread consistency check");
1283 
1284     // Calculate how long it'll be until the next PeriodicTask work
1285     // should be done, and sleep that amount of time.
1286     int time_waited = sleep();
1287 
1288     if (is_error_reported()) {
1289       // A fatal error has happened, the error handler(VMError::report_and_die)
1290       // should abort JVM after creating an error log file. However in some
1291       // rare cases, the error handler itself might deadlock. Here we try to
1292       // kill JVM if the fatal error handler fails to abort in 2 minutes.
1293       //
1294       // This code is in WatcherThread because WatcherThread wakes up
1295       // periodically so the fatal error handler doesn't need to do anything;
1296       // also because the WatcherThread is less likely to crash than other
1297       // threads.
1298 
1299       for (;;) {
1300         if (!ShowMessageBoxOnError
1301             &amp;&amp; (OnError == NULL || OnError[0] == '\0')
1302             &amp;&amp; Arguments::abort_hook() == NULL) {
1303           os::sleep(this, (jlong)ErrorLogTimeout * 1000, false); // in seconds
1304           fdStream err(defaultStream::output_fd());
1305           err.print_raw_cr("# [ timer expired, abort... ]");
1306           // skip atexit/vm_exit/vm_abort hooks
1307           os::die();
1308         }
1309 
1310         // Wake up 5 seconds later, the fatal handler may reset OnError or
1311         // ShowMessageBoxOnError when it is ready to abort.
1312         os::sleep(this, 5 * 1000, false);
1313       }
1314     }
1315 
1316     if (_should_terminate) {
1317       // check for termination before posting the next tick
1318       break;
1319     }
1320 
1321     PeriodicTask::real_time_tick(time_waited);
1322   }
1323 
1324   // Signal that it is terminated
1325   {
1326     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1327     _watcher_thread = NULL;
1328     Terminator_lock-&gt;notify();
1329   }
1330 }
1331 
1332 void WatcherThread::start() {
1333   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1334 
1335   if (watcher_thread() == NULL &amp;&amp; _startable) {
1336     _should_terminate = false;
1337     // Create the single instance of WatcherThread
1338     new WatcherThread();
1339   }
1340 }
1341 
1342 void WatcherThread::make_startable() {
1343   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1344   _startable = true;
1345 }
1346 
1347 void WatcherThread::stop() {
1348   {
1349     // Follow normal safepoint aware lock enter protocol since the
1350     // WatcherThread is stopped by another JavaThread.
1351     MutexLocker ml(PeriodicTask_lock);
1352     _should_terminate = true;
1353 
1354     WatcherThread* watcher = watcher_thread();
1355     if (watcher != NULL) {
1356       // unpark the WatcherThread so it can see that it should terminate
1357       watcher-&gt;unpark();
1358     }
1359   }
1360 
1361   MutexLocker mu(Terminator_lock);
1362 
1363   while (watcher_thread() != NULL) {
1364     // This wait should make safepoint checks, wait without a timeout,
1365     // and wait as a suspend-equivalent condition.
1366     //
1367     // Note: If the FlatProfiler is running, then this thread is waiting
1368     // for the WatcherThread to terminate and the WatcherThread, via the
1369     // FlatProfiler task, is waiting for the external suspend request on
1370     // this thread to complete. wait_for_ext_suspend_completion() will
1371     // eventually timeout, but that takes time. Making this wait a
1372     // suspend-equivalent condition solves that timeout problem.
1373     //
1374     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1375                           Mutex::_as_suspend_equivalent_flag);
1376   }
1377 }
1378 
1379 void WatcherThread::unpark() {
1380   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1381   PeriodicTask_lock-&gt;notify();
1382 }
1383 
1384 void WatcherThread::print_on(outputStream* st) const {
1385   st-&gt;print("\"%s\" ", name());
1386   Thread::print_on(st);
1387   st-&gt;cr();
1388 }
1389 
1390 // ======= JavaThread ========
1391 
1392 #if INCLUDE_JVMCI
1393 
1394 jlong* JavaThread::_jvmci_old_thread_counters;
1395 
1396 bool jvmci_counters_include(JavaThread* thread) {
1397   oop threadObj = thread-&gt;threadObj();
1398   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1399 }
1400 
1401 void JavaThread::collect_counters(typeArrayOop array) {
1402   if (JVMCICounterSize &gt; 0) {
1403     MutexLocker tl(Threads_lock);
1404     for (int i = 0; i &lt; array-&gt;length(); i++) {
1405       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1406     }
1407     for (JavaThread* tp = Threads::first(); tp != NULL; tp = tp-&gt;next()) {
1408       if (jvmci_counters_include(tp)) {
1409         for (int i = 0; i &lt; array-&gt;length(); i++) {
1410           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1411         }
1412       }
1413     }
1414   }
1415 }
1416 
1417 #endif // INCLUDE_JVMCI
1418 
1419 // A JavaThread is a normal Java thread
1420 
1421 void JavaThread::initialize() {
1422   // Initialize fields
1423 
1424   set_saved_exception_pc(NULL);
1425   set_threadObj(NULL);
1426   _anchor.clear();
1427   set_entry_point(NULL);
1428   set_jni_functions(jni_functions());
1429   set_callee_target(NULL);
1430   set_vm_result(NULL);
1431   set_vm_result_2(NULL);
1432   set_vframe_array_head(NULL);
1433   set_vframe_array_last(NULL);
1434   set_deferred_locals(NULL);
1435   set_deopt_mark(NULL);
1436   set_deopt_compiled_method(NULL);
1437   clear_must_deopt_id();
1438   set_monitor_chunks(NULL);
1439   set_next(NULL);
1440   set_thread_state(_thread_new);
1441   _terminated = _not_terminated;
1442   _privileged_stack_top = NULL;
1443   _array_for_gc = NULL;
1444   _suspend_equivalent = false;
1445   _in_deopt_handler = 0;
1446   _doing_unsafe_access = false;
1447   _stack_guard_state = stack_guard_unused;
1448 #if INCLUDE_JVMCI
1449   _pending_monitorenter = false;
1450   _pending_deoptimization = -1;
1451   _pending_failed_speculation = NULL;
1452   _pending_transfer_to_interpreter = false;
1453   _adjusting_comp_level = false;
1454   _jvmci._alternate_call_target = NULL;
1455   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1456   if (JVMCICounterSize &gt; 0) {
1457     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1458     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1459   } else {
1460     _jvmci_counters = NULL;
1461   }
1462 #endif // INCLUDE_JVMCI
1463   _reserved_stack_activation = NULL;  // stack base not known yet
1464   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1465   _exception_pc  = 0;
1466   _exception_handler_pc = 0;
1467   _is_method_handle_return = 0;
1468   _jvmti_thread_state= NULL;
1469   _should_post_on_exceptions_flag = JNI_FALSE;
1470   _jvmti_get_loaded_classes_closure = NULL;
1471   _interp_only_mode    = 0;
1472   _special_runtime_exit_condition = _no_async_condition;
1473   _pending_async_exception = NULL;
1474   _thread_stat = NULL;
1475   _thread_stat = new ThreadStatistics();
1476   _blocked_on_compilation = false;
1477   _jni_active_critical = 0;
1478   _pending_jni_exception_check_fn = NULL;
1479   _do_not_unlock_if_synchronized = false;
1480   _cached_monitor_info = NULL;
1481   _parker = Parker::Allocate(this);
1482 
1483 #ifndef PRODUCT
1484   _jmp_ring_index = 0;
1485   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1486     record_jump(NULL, NULL, NULL, 0);
1487   }
1488 #endif // PRODUCT
1489 
1490   set_thread_profiler(NULL);
1491   if (FlatProfiler::is_active()) {
1492     // This is where we would decide to either give each thread it's own profiler
1493     // or use one global one from FlatProfiler,
1494     // or up to some count of the number of profiled threads, etc.
1495     ThreadProfiler* pp = new ThreadProfiler();
1496     pp-&gt;engage();
1497     set_thread_profiler(pp);
1498   }
1499 
1500   // Setup safepoint state info for this thread
1501   ThreadSafepointState::create(this);
1502 
1503   debug_only(_java_call_counter = 0);
1504 
1505   // JVMTI PopFrame support
1506   _popframe_condition = popframe_inactive;
1507   _popframe_preserved_args = NULL;
1508   _popframe_preserved_args_size = 0;
1509   _frames_to_pop_failed_realloc = 0;
1510 
1511   pd_initialize();
1512 }
1513 
1514 #if INCLUDE_ALL_GCS
1515 SATBMarkQueueSet JavaThread::_satb_mark_queue_set;
1516 DirtyCardQueueSet JavaThread::_dirty_card_queue_set;
1517 #endif // INCLUDE_ALL_GCS
1518 
1519 JavaThread::JavaThread(bool is_attaching_via_jni) :
1520                        Thread()
1521 #if INCLUDE_ALL_GCS
1522                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1523                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1524 #endif // INCLUDE_ALL_GCS
1525 {
1526   initialize();
1527   if (is_attaching_via_jni) {
1528     _jni_attach_state = _attaching_via_jni;
1529   } else {
1530     _jni_attach_state = _not_attaching_via_jni;
1531   }
1532   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1533 }
1534 
1535 bool JavaThread::reguard_stack(address cur_sp) {
1536   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1537       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1538     return true; // Stack already guarded or guard pages not needed.
1539   }
1540 
1541   if (register_stack_overflow()) {
1542     // For those architectures which have separate register and
1543     // memory stacks, we must check the register stack to see if
1544     // it has overflowed.
1545     return false;
1546   }
1547 
1548   // Java code never executes within the yellow zone: the latter is only
1549   // there to provoke an exception during stack banging.  If java code
1550   // is executing there, either StackShadowPages should be larger, or
1551   // some exception code in c1, c2 or the interpreter isn't unwinding
1552   // when it should.
1553   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1554             "not enough space to reguard - increase StackShadowPages");
1555   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1556     enable_stack_yellow_reserved_zone();
1557     if (reserved_stack_activation() != stack_base()) {
1558       set_reserved_stack_activation(stack_base());
1559     }
1560   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1561     set_reserved_stack_activation(stack_base());
1562     enable_stack_reserved_zone();
1563   }
1564   return true;
1565 }
1566 
1567 bool JavaThread::reguard_stack(void) {
1568   return reguard_stack(os::current_stack_pointer());
1569 }
1570 
1571 
1572 void JavaThread::block_if_vm_exited() {
1573   if (_terminated == _vm_exited) {
1574     // _vm_exited is set at safepoint, and Threads_lock is never released
1575     // we will block here forever
1576     Threads_lock-&gt;lock_without_safepoint_check();
1577     ShouldNotReachHere();
1578   }
1579 }
1580 
1581 
1582 // Remove this ifdef when C1 is ported to the compiler interface.
1583 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1584 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1585 
1586 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1587                        Thread()
1588 #if INCLUDE_ALL_GCS
1589                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1590                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1591 #endif // INCLUDE_ALL_GCS
1592 {
1593   initialize();
1594   _jni_attach_state = _not_attaching_via_jni;
1595   set_entry_point(entry_point);
1596   // Create the native thread itself.
1597   // %note runtime_23
1598   os::ThreadType thr_type = os::java_thread;
1599   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1600                                                      os::java_thread;
1601   os::create_thread(this, thr_type, stack_sz);
1602   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1603   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1604   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1605   // the exception consists of creating the exception object &amp; initializing it, initialization
1606   // will leave the VM via a JavaCall and then all locks must be unlocked).
1607   //
1608   // The thread is still suspended when we reach here. Thread must be explicit started
1609   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1610   // by calling Threads:add. The reason why this is not done here, is because the thread
1611   // object must be fully initialized (take a look at JVM_Start)
1612 }
1613 
1614 JavaThread::~JavaThread() {
1615 
1616   // JSR166 -- return the parker to the free list
1617   Parker::Release(_parker);
1618   _parker = NULL;
1619 
1620   // Free any remaining  previous UnrollBlock
1621   vframeArray* old_array = vframe_array_last();
1622 
1623   if (old_array != NULL) {
1624     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1625     old_array-&gt;set_unroll_block(NULL);
1626     delete old_info;
1627     delete old_array;
1628   }
1629 
1630   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1631   if (deferred != NULL) {
1632     // This can only happen if thread is destroyed before deoptimization occurs.
1633     assert(deferred-&gt;length() != 0, "empty array!");
1634     do {
1635       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1636       deferred-&gt;remove_at(0);
1637       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1638       delete dlv;
1639     } while (deferred-&gt;length() != 0);
1640     delete deferred;
1641   }
1642 
1643   // All Java related clean up happens in exit
1644   ThreadSafepointState::destroy(this);
1645   if (_thread_profiler != NULL) delete _thread_profiler;
1646   if (_thread_stat != NULL) delete _thread_stat;
1647 
1648 #if INCLUDE_JVMCI
1649   if (JVMCICounterSize &gt; 0) {
1650     if (jvmci_counters_include(this)) {
1651       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1652         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1653       }
1654     }
1655     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1656   }
1657 #endif // INCLUDE_JVMCI
1658 }
1659 
1660 
1661 // The first routine called by a new Java thread
1662 void JavaThread::run() {
1663   // initialize thread-local alloc buffer related fields
1664   this-&gt;initialize_tlab();
1665 
1666   // used to test validity of stack trace backs
1667   this-&gt;record_base_of_stack_pointer();
1668 
1669   // Record real stack base and size.
1670   this-&gt;record_stack_base_and_size();
1671 
1672   this-&gt;create_stack_guard_pages();
1673 
1674   this-&gt;cache_global_variables();
1675 
1676   // Thread is now sufficient initialized to be handled by the safepoint code as being
1677   // in the VM. Change thread state from _thread_new to _thread_in_vm
1678   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1679 
1680   assert(JavaThread::current() == this, "sanity check");
1681   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1682 
1683   DTRACE_THREAD_PROBE(start, this);
1684 
1685   // This operation might block. We call that after all safepoint checks for a new thread has
1686   // been completed.
1687   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1688 
1689   if (JvmtiExport::should_post_thread_life()) {
1690     JvmtiExport::post_thread_start(this);
1691   }
1692 
1693   EventThreadStart event;
1694   if (event.should_commit()) {
1695     event.set_thread(THREAD_TRACE_ID(this));
1696     event.commit();
1697   }
1698 
1699   // We call another function to do the rest so we are sure that the stack addresses used
1700   // from there will be lower than the stack base just computed
1701   thread_main_inner();
1702 
1703   // Note, thread is no longer valid at this point!
1704 }
1705 
1706 
1707 void JavaThread::thread_main_inner() {
1708   assert(JavaThread::current() == this, "sanity check");
1709   assert(this-&gt;threadObj() != NULL, "just checking");
1710 
1711   // Execute thread entry point unless this thread has a pending exception
1712   // or has been stopped before starting.
1713   // Note: Due to JVM_StopThread we can have pending exceptions already!
1714   if (!this-&gt;has_pending_exception() &amp;&amp;
1715       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1716     {
1717       ResourceMark rm(this);
1718       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1719     }
1720     HandleMark hm(this);
1721     this-&gt;entry_point()(this, this);
1722   }
1723 
1724   DTRACE_THREAD_PROBE(stop, this);
1725 
1726   this-&gt;exit(false);
1727   delete this;
1728 }
1729 
1730 
1731 static void ensure_join(JavaThread* thread) {
1732   // We do not need to grap the Threads_lock, since we are operating on ourself.
1733   Handle threadObj(thread, thread-&gt;threadObj());
1734   assert(threadObj.not_null(), "java thread object must exist");
1735   ObjectLocker lock(threadObj, thread);
1736   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1737   thread-&gt;clear_pending_exception();
1738   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1739   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1740   // Clear the native thread instance - this makes isAlive return false and allows the join()
1741   // to complete once we've done the notify_all below
1742   java_lang_Thread::set_thread(threadObj(), NULL);
1743   lock.notify_all(thread);
1744   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1745   thread-&gt;clear_pending_exception();
1746 }
1747 
1748 
1749 // For any new cleanup additions, please check to see if they need to be applied to
1750 // cleanup_failed_attach_current_thread as well.
1751 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1752   assert(this == JavaThread::current(), "thread consistency check");
1753 
1754   HandleMark hm(this);
1755   Handle uncaught_exception(this, this-&gt;pending_exception());
1756   this-&gt;clear_pending_exception();
1757   Handle threadObj(this, this-&gt;threadObj());
1758   assert(threadObj.not_null(), "Java thread object should be created");
1759 
1760   if (get_thread_profiler() != NULL) {
1761     get_thread_profiler()-&gt;disengage();
1762     ResourceMark rm;
1763     get_thread_profiler()-&gt;print(get_thread_name());
1764   }
1765 
1766 
1767   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1768   {
1769     EXCEPTION_MARK;
1770 
1771     CLEAR_PENDING_EXCEPTION;
1772   }
1773   if (!destroy_vm) {
1774     if (uncaught_exception.not_null()) {
1775       EXCEPTION_MARK;
1776       // Call method Thread.dispatchUncaughtException().
1777       KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1778       JavaValue result(T_VOID);
1779       JavaCalls::call_virtual(&amp;result,
1780                               threadObj, thread_klass,
1781                               vmSymbols::dispatchUncaughtException_name(),
1782                               vmSymbols::throwable_void_signature(),
1783                               uncaught_exception,
1784                               THREAD);
1785       if (HAS_PENDING_EXCEPTION) {
1786         ResourceMark rm(this);
1787         jio_fprintf(defaultStream::error_stream(),
1788                     "\nException: %s thrown from the UncaughtExceptionHandler"
1789                     " in thread \"%s\"\n",
1790                     pending_exception()-&gt;klass()-&gt;external_name(),
1791                     get_thread_name());
1792         CLEAR_PENDING_EXCEPTION;
1793       }
1794     }
1795 
1796     // Called before the java thread exit since we want to read info
1797     // from java_lang_Thread object
1798     EventThreadEnd event;
1799     if (event.should_commit()) {
1800       event.set_thread(THREAD_TRACE_ID(this));
1801       event.commit();
1802     }
1803 
1804     // Call after last event on thread
1805     EVENT_THREAD_EXIT(this);
1806 
1807     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1808     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1809     // is deprecated anyhow.
1810     if (!is_Compiler_thread()) {
1811       int count = 3;
1812       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1813         EXCEPTION_MARK;
1814         JavaValue result(T_VOID);
1815         KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1816         JavaCalls::call_virtual(&amp;result,
1817                                 threadObj, thread_klass,
1818                                 vmSymbols::exit_method_name(),
1819                                 vmSymbols::void_method_signature(),
1820                                 THREAD);
1821         CLEAR_PENDING_EXCEPTION;
1822       }
1823     }
1824     // notify JVMTI
1825     if (JvmtiExport::should_post_thread_life()) {
1826       JvmtiExport::post_thread_end(this);
1827     }
1828 
1829     // We have notified the agents that we are exiting, before we go on,
1830     // we must check for a pending external suspend request and honor it
1831     // in order to not surprise the thread that made the suspend request.
1832     while (true) {
1833       {
1834         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1835         if (!is_external_suspend()) {
1836           set_terminated(_thread_exiting);
1837           ThreadService::current_thread_exiting(this);
1838           break;
1839         }
1840         // Implied else:
1841         // Things get a little tricky here. We have a pending external
1842         // suspend request, but we are holding the SR_lock so we
1843         // can't just self-suspend. So we temporarily drop the lock
1844         // and then self-suspend.
1845       }
1846 
1847       ThreadBlockInVM tbivm(this);
1848       java_suspend_self();
1849 
1850       // We're done with this suspend request, but we have to loop around
1851       // and check again. Eventually we will get SR_lock without a pending
1852       // external suspend request and will be able to mark ourselves as
1853       // exiting.
1854     }
1855     // no more external suspends are allowed at this point
1856   } else {
1857     // before_exit() has already posted JVMTI THREAD_END events
1858   }
1859 
1860   // Notify waiters on thread object. This has to be done after exit() is called
1861   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1862   // group should have the destroyed bit set before waiters are notified).
1863   ensure_join(this);
1864   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1865 
1866   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1867   // held by this thread must be released. The spec does not distinguish
1868   // between JNI-acquired and regular Java monitors. We can only see
1869   // regular Java monitors here if monitor enter-exit matching is broken.
1870   //
1871   // Optionally release any monitors for regular JavaThread exits. This
1872   // is provided as a work around for any bugs in monitor enter-exit
1873   // matching. This can be expensive so it is not enabled by default.
1874   //
1875   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1876   // ObjectSynchronizer::release_monitors_owned_by_thread().
1877   if (exit_type == jni_detach || ObjectMonitor::Knob_ExitRelease) {
1878     // Sanity check even though JNI DetachCurrentThread() would have
1879     // returned JNI_ERR if there was a Java frame. JavaThread exit
1880     // should be done executing Java code by the time we get here.
1881     assert(!this-&gt;has_last_Java_frame(),
1882            "should not have a Java frame when detaching or exiting");
1883     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1884     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1885   }
1886 
1887   // These things needs to be done while we are still a Java Thread. Make sure that thread
1888   // is in a consistent state, in case GC happens
1889   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1890 
1891   if (active_handles() != NULL) {
1892     JNIHandleBlock* block = active_handles();
1893     set_active_handles(NULL);
1894     JNIHandleBlock::release_block(block);
1895   }
1896 
1897   if (free_handle_block() != NULL) {
1898     JNIHandleBlock* block = free_handle_block();
1899     set_free_handle_block(NULL);
1900     JNIHandleBlock::release_block(block);
1901   }
1902 
1903   // These have to be removed while this is still a valid thread.
1904   remove_stack_guard_pages();
1905 
1906   if (UseTLAB) {
1907     tlab().make_parsable(true);  // retire TLAB
1908   }
1909 
1910   if (JvmtiEnv::environments_might_exist()) {
1911     JvmtiExport::cleanup_thread(this);
1912   }
1913 
1914   // We must flush any deferred card marks before removing a thread from
1915   // the list of active threads.
1916   Universe::heap()-&gt;flush_deferred_store_barrier(this);
1917   assert(deferred_card_mark().is_empty(), "Should have been flushed");
1918 
1919 #if INCLUDE_ALL_GCS
1920   // We must flush the G1-related buffers before removing a thread
1921   // from the list of active threads. We must do this after any deferred
1922   // card marks have been flushed (above) so that any entries that are
1923   // added to the thread's dirty card queue as a result are not lost.
1924   if (UseG1GC) {
1925     flush_barrier_queues();
1926   }
1927 #endif // INCLUDE_ALL_GCS
1928 
1929   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
1930     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
1931     os::current_thread_id());
1932 
1933   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
1934   Threads::remove(this);
1935 }
1936 
1937 #if INCLUDE_ALL_GCS
1938 // Flush G1-related queues.
1939 void JavaThread::flush_barrier_queues() {
1940   satb_mark_queue().flush();
1941   dirty_card_queue().flush();
1942 }
1943 
1944 void JavaThread::initialize_queues() {
1945   assert(!SafepointSynchronize::is_at_safepoint(),
1946          "we should not be at a safepoint");
1947 
1948   SATBMarkQueue&amp; satb_queue = satb_mark_queue();
1949   SATBMarkQueueSet&amp; satb_queue_set = satb_mark_queue_set();
1950   // The SATB queue should have been constructed with its active
1951   // field set to false.
1952   assert(!satb_queue.is_active(), "SATB queue should not be active");
1953   assert(satb_queue.is_empty(), "SATB queue should be empty");
1954   // If we are creating the thread during a marking cycle, we should
1955   // set the active field of the SATB queue to true.
1956   if (satb_queue_set.is_active()) {
1957     satb_queue.set_active(true);
1958   }
1959 
1960   DirtyCardQueue&amp; dirty_queue = dirty_card_queue();
1961   // The dirty card queue should have been constructed with its
1962   // active field set to true.
1963   assert(dirty_queue.is_active(), "dirty card queue should be active");
1964 }
1965 #endif // INCLUDE_ALL_GCS
1966 
1967 void JavaThread::cleanup_failed_attach_current_thread() {
1968   if (get_thread_profiler() != NULL) {
1969     get_thread_profiler()-&gt;disengage();
1970     ResourceMark rm;
1971     get_thread_profiler()-&gt;print(get_thread_name());
1972   }
1973 
1974   if (active_handles() != NULL) {
1975     JNIHandleBlock* block = active_handles();
1976     set_active_handles(NULL);
1977     JNIHandleBlock::release_block(block);
1978   }
1979 
1980   if (free_handle_block() != NULL) {
1981     JNIHandleBlock* block = free_handle_block();
1982     set_free_handle_block(NULL);
1983     JNIHandleBlock::release_block(block);
1984   }
1985 
1986   // These have to be removed while this is still a valid thread.
1987   remove_stack_guard_pages();
1988 
1989   if (UseTLAB) {
1990     tlab().make_parsable(true);  // retire TLAB, if any
1991   }
1992 
1993 #if INCLUDE_ALL_GCS
1994   if (UseG1GC) {
1995     flush_barrier_queues();
1996   }
1997 #endif // INCLUDE_ALL_GCS
1998 
1999   Threads::remove(this);
2000   delete this;
2001 }
2002 
2003 
2004 
2005 
2006 JavaThread* JavaThread::active() {
2007   Thread* thread = Thread::current();
2008   if (thread-&gt;is_Java_thread()) {
2009     return (JavaThread*) thread;
2010   } else {
2011     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2012     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2013     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2014     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2015     return ret;
2016   }
2017 }
2018 
2019 bool JavaThread::is_lock_owned(address adr) const {
2020   if (Thread::is_lock_owned(adr)) return true;
2021 
2022   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2023     if (chunk-&gt;contains(adr)) return true;
2024   }
2025 
2026   return false;
2027 }
2028 
2029 
2030 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2031   chunk-&gt;set_next(monitor_chunks());
2032   set_monitor_chunks(chunk);
2033 }
2034 
2035 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2036   guarantee(monitor_chunks() != NULL, "must be non empty");
2037   if (monitor_chunks() == chunk) {
2038     set_monitor_chunks(chunk-&gt;next());
2039   } else {
2040     MonitorChunk* prev = monitor_chunks();
2041     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2042     prev-&gt;set_next(chunk-&gt;next());
2043   }
2044 }
2045 
2046 // JVM support.
2047 
2048 // Note: this function shouldn't block if it's called in
2049 // _thread_in_native_trans state (such as from
2050 // check_special_condition_for_native_trans()).
2051 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2052 
2053   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2054     // If we are at a polling page safepoint (not a poll return)
2055     // then we must defer async exception because live registers
2056     // will be clobbered by the exception path. Poll return is
2057     // ok because the call we a returning from already collides
2058     // with exception handling registers and so there is no issue.
2059     // (The exception handling path kills call result registers but
2060     //  this is ok since the exception kills the result anyway).
2061 
2062     if (is_at_poll_safepoint()) {
2063       // if the code we are returning to has deoptimized we must defer
2064       // the exception otherwise live registers get clobbered on the
2065       // exception path before deoptimization is able to retrieve them.
2066       //
2067       RegisterMap map(this, false);
2068       frame caller_fr = last_frame().sender(&amp;map);
2069       assert(caller_fr.is_compiled_frame(), "what?");
2070       if (caller_fr.is_deoptimized_frame()) {
2071         log_info(exceptions)("deferred async exception at compiled safepoint");
2072         return;
2073       }
2074     }
2075   }
2076 
2077   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2078   if (condition == _no_async_condition) {
2079     // Conditions have changed since has_special_runtime_exit_condition()
2080     // was called:
2081     // - if we were here only because of an external suspend request,
2082     //   then that was taken care of above (or cancelled) so we are done
2083     // - if we were here because of another async request, then it has
2084     //   been cleared between the has_special_runtime_exit_condition()
2085     //   and now so again we are done
2086     return;
2087   }
2088 
2089   // Check for pending async. exception
2090   if (_pending_async_exception != NULL) {
2091     // Only overwrite an already pending exception, if it is not a threadDeath.
2092     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2093 
2094       // We cannot call Exceptions::_throw(...) here because we cannot block
2095       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2096 
2097       if (log_is_enabled(Info, exceptions)) {
2098         ResourceMark rm;
2099         outputStream* logstream = Log(exceptions)::info_stream();
2100         logstream-&gt;print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2101           if (has_last_Java_frame()) {
2102             frame f = last_frame();
2103            logstream-&gt;print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2104           }
2105         logstream-&gt;print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2106       }
2107       _pending_async_exception = NULL;
2108       clear_has_async_exception();
2109     }
2110   }
2111 
2112   if (check_unsafe_error &amp;&amp;
2113       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2114     condition = _no_async_condition;  // done
2115     switch (thread_state()) {
2116     case _thread_in_vm: {
2117       JavaThread* THREAD = this;
2118       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2119     }
2120     case _thread_in_native: {
2121       ThreadInVMfromNative tiv(this);
2122       JavaThread* THREAD = this;
2123       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2124     }
2125     case _thread_in_Java: {
2126       ThreadInVMfromJava tiv(this);
2127       JavaThread* THREAD = this;
2128       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2129     }
2130     default:
2131       ShouldNotReachHere();
2132     }
2133   }
2134 
2135   assert(condition == _no_async_condition || has_pending_exception() ||
2136          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2137          "must have handled the async condition, if no exception");
2138 }
2139 
2140 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2141   //
2142   // Check for pending external suspend. Internal suspend requests do
2143   // not use handle_special_runtime_exit_condition().
2144   // If JNIEnv proxies are allowed, don't self-suspend if the target
2145   // thread is not the current thread. In older versions of jdbx, jdbx
2146   // threads could call into the VM with another thread's JNIEnv so we
2147   // can be here operating on behalf of a suspended thread (4432884).
2148   bool do_self_suspend = is_external_suspend_with_lock();
2149   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2150     //
2151     // Because thread is external suspended the safepoint code will count
2152     // thread as at a safepoint. This can be odd because we can be here
2153     // as _thread_in_Java which would normally transition to _thread_blocked
2154     // at a safepoint. We would like to mark the thread as _thread_blocked
2155     // before calling java_suspend_self like all other callers of it but
2156     // we must then observe proper safepoint protocol. (We can't leave
2157     // _thread_blocked with a safepoint in progress). However we can be
2158     // here as _thread_in_native_trans so we can't use a normal transition
2159     // constructor/destructor pair because they assert on that type of
2160     // transition. We could do something like:
2161     //
2162     // JavaThreadState state = thread_state();
2163     // set_thread_state(_thread_in_vm);
2164     // {
2165     //   ThreadBlockInVM tbivm(this);
2166     //   java_suspend_self()
2167     // }
2168     // set_thread_state(_thread_in_vm_trans);
2169     // if (safepoint) block;
2170     // set_thread_state(state);
2171     //
2172     // but that is pretty messy. Instead we just go with the way the
2173     // code has worked before and note that this is the only path to
2174     // java_suspend_self that doesn't put the thread in _thread_blocked
2175     // mode.
2176 
2177     frame_anchor()-&gt;make_walkable(this);
2178     java_suspend_self();
2179 
2180     // We might be here for reasons in addition to the self-suspend request
2181     // so check for other async requests.
2182   }
2183 
2184   if (check_asyncs) {
2185     check_and_handle_async_exceptions();
2186   }
2187 }
2188 
2189 void JavaThread::send_thread_stop(oop java_throwable)  {
2190   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2191   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2192   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2193 
2194   // Do not throw asynchronous exceptions against the compiler thread
2195   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2196   if (!can_call_java()) return;
2197 
2198   {
2199     // Actually throw the Throwable against the target Thread - however
2200     // only if there is no thread death exception installed already.
2201     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2202       // If the topmost frame is a runtime stub, then we are calling into
2203       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2204       // must deoptimize the caller before continuing, as the compiled  exception handler table
2205       // may not be valid
2206       if (has_last_Java_frame()) {
2207         frame f = last_frame();
2208         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2209           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2210           RegisterMap reg_map(this, UseBiasedLocking);
2211           frame compiled_frame = f.sender(&amp;reg_map);
2212           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2213             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2214           }
2215         }
2216       }
2217 
2218       // Set async. pending exception in thread.
2219       set_pending_async_exception(java_throwable);
2220 
2221       if (log_is_enabled(Info, exceptions)) {
2222          ResourceMark rm;
2223         log_info(exceptions)("Pending Async. exception installed of type: %s",
2224                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2225       }
2226       // for AbortVMOnException flag
2227       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2228     }
2229   }
2230 
2231 
2232   // Interrupt thread so it will wake up from a potential wait()
2233   Thread::interrupt(this);
2234 }
2235 
2236 // External suspension mechanism.
2237 //
2238 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2239 // to any VM_locks and it is at a transition
2240 // Self-suspension will happen on the transition out of the vm.
2241 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2242 //
2243 // Guarantees on return:
2244 //   + Target thread will not execute any new bytecode (that's why we need to
2245 //     force a safepoint)
2246 //   + Target thread will not enter any new monitors
2247 //
2248 void JavaThread::java_suspend() {
2249   { MutexLocker mu(Threads_lock);
2250     if (!Threads::includes(this) || is_exiting() || this-&gt;threadObj() == NULL) {
2251       return;
2252     }
2253   }
2254 
2255   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2256     if (!is_external_suspend()) {
2257       // a racing resume has cancelled us; bail out now
2258       return;
2259     }
2260 
2261     // suspend is done
2262     uint32_t debug_bits = 0;
2263     // Warning: is_ext_suspend_completed() may temporarily drop the
2264     // SR_lock to allow the thread to reach a stable thread state if
2265     // it is currently in a transient thread state.
2266     if (is_ext_suspend_completed(false /* !called_by_wait */,
2267                                  SuspendRetryDelay, &amp;debug_bits)) {
2268       return;
2269     }
2270   }
2271 
2272   VM_ForceSafepoint vm_suspend;
2273   VMThread::execute(&amp;vm_suspend);
2274 }
2275 
2276 // Part II of external suspension.
2277 // A JavaThread self suspends when it detects a pending external suspend
2278 // request. This is usually on transitions. It is also done in places
2279 // where continuing to the next transition would surprise the caller,
2280 // e.g., monitor entry.
2281 //
2282 // Returns the number of times that the thread self-suspended.
2283 //
2284 // Note: DO NOT call java_suspend_self() when you just want to block current
2285 //       thread. java_suspend_self() is the second stage of cooperative
2286 //       suspension for external suspend requests and should only be used
2287 //       to complete an external suspend request.
2288 //
2289 int JavaThread::java_suspend_self() {
2290   int ret = 0;
2291 
2292   // we are in the process of exiting so don't suspend
2293   if (is_exiting()) {
2294     clear_external_suspend();
2295     return ret;
2296   }
2297 
2298   assert(_anchor.walkable() ||
2299          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2300          "must have walkable stack");
2301 
2302   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2303 
2304   assert(!this-&gt;is_ext_suspended(),
2305          "a thread trying to self-suspend should not already be suspended");
2306 
2307   if (this-&gt;is_suspend_equivalent()) {
2308     // If we are self-suspending as a result of the lifting of a
2309     // suspend equivalent condition, then the suspend_equivalent
2310     // flag is not cleared until we set the ext_suspended flag so
2311     // that wait_for_ext_suspend_completion() returns consistent
2312     // results.
2313     this-&gt;clear_suspend_equivalent();
2314   }
2315 
2316   // A racing resume may have cancelled us before we grabbed SR_lock
2317   // above. Or another external suspend request could be waiting for us
2318   // by the time we return from SR_lock()-&gt;wait(). The thread
2319   // that requested the suspension may already be trying to walk our
2320   // stack and if we return now, we can change the stack out from under
2321   // it. This would be a "bad thing (TM)" and cause the stack walker
2322   // to crash. We stay self-suspended until there are no more pending
2323   // external suspend requests.
2324   while (is_external_suspend()) {
2325     ret++;
2326     this-&gt;set_ext_suspended();
2327 
2328     // _ext_suspended flag is cleared by java_resume()
2329     while (is_ext_suspended()) {
2330       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2331     }
2332   }
2333 
2334   return ret;
2335 }
2336 
2337 #ifdef ASSERT
2338 // verify the JavaThread has not yet been published in the Threads::list, and
2339 // hence doesn't need protection from concurrent access at this stage
2340 void JavaThread::verify_not_published() {
2341   if (!Threads_lock-&gt;owned_by_self()) {
2342     MutexLockerEx ml(Threads_lock,  Mutex::_no_safepoint_check_flag);
2343     assert(!Threads::includes(this),
2344            "java thread shouldn't have been published yet!");
2345   } else {
2346     assert(!Threads::includes(this),
2347            "java thread shouldn't have been published yet!");
2348   }
2349 }
2350 #endif
2351 
2352 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2353 // progress or when _suspend_flags is non-zero.
2354 // Current thread needs to self-suspend if there is a suspend request and/or
2355 // block if a safepoint is in progress.
2356 // Async exception ISN'T checked.
2357 // Note only the ThreadInVMfromNative transition can call this function
2358 // directly and when thread state is _thread_in_native_trans
2359 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2360   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2361 
2362   JavaThread *curJT = JavaThread::current();
2363   bool do_self_suspend = thread-&gt;is_external_suspend();
2364 
2365   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2366 
2367   // If JNIEnv proxies are allowed, don't self-suspend if the target
2368   // thread is not the current thread. In older versions of jdbx, jdbx
2369   // threads could call into the VM with another thread's JNIEnv so we
2370   // can be here operating on behalf of a suspended thread (4432884).
2371   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2372     JavaThreadState state = thread-&gt;thread_state();
2373 
2374     // We mark this thread_blocked state as a suspend-equivalent so
2375     // that a caller to is_ext_suspend_completed() won't be confused.
2376     // The suspend-equivalent state is cleared by java_suspend_self().
2377     thread-&gt;set_suspend_equivalent();
2378 
2379     // If the safepoint code sees the _thread_in_native_trans state, it will
2380     // wait until the thread changes to other thread state. There is no
2381     // guarantee on how soon we can obtain the SR_lock and complete the
2382     // self-suspend request. It would be a bad idea to let safepoint wait for
2383     // too long. Temporarily change the state to _thread_blocked to
2384     // let the VM thread know that this thread is ready for GC. The problem
2385     // of changing thread state is that safepoint could happen just after
2386     // java_suspend_self() returns after being resumed, and VM thread will
2387     // see the _thread_blocked state. We must check for safepoint
2388     // after restoring the state and make sure we won't leave while a safepoint
2389     // is in progress.
2390     thread-&gt;set_thread_state(_thread_blocked);
2391     thread-&gt;java_suspend_self();
2392     thread-&gt;set_thread_state(state);
2393     // Make sure new state is seen by VM thread
2394     if (os::is_MP()) {
2395       if (UseMembar) {
2396         // Force a fence between the write above and read below
2397         OrderAccess::fence();
2398       } else {
2399         // Must use this rather than serialization page in particular on Windows
2400         InterfaceSupport::serialize_memory(thread);
2401       }
2402     }
2403   }
2404 
2405   if (SafepointSynchronize::do_call_back()) {
2406     // If we are safepointing, then block the caller which may not be
2407     // the same as the target thread (see above).
2408     SafepointSynchronize::block(curJT);
2409   }
2410 
2411   if (thread-&gt;is_deopt_suspend()) {
2412     thread-&gt;clear_deopt_suspend();
2413     RegisterMap map(thread, false);
2414     frame f = thread-&gt;last_frame();
2415     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2416       f = f.sender(&amp;map);
2417     }
2418     if (f.id() == thread-&gt;must_deopt_id()) {
2419       thread-&gt;clear_must_deopt_id();
2420       f.deoptimize(thread);
2421     } else {
2422       fatal("missed deoptimization!");
2423     }
2424   }
2425 }
2426 
2427 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2428 // progress or when _suspend_flags is non-zero.
2429 // Current thread needs to self-suspend if there is a suspend request and/or
2430 // block if a safepoint is in progress.
2431 // Also check for pending async exception (not including unsafe access error).
2432 // Note only the native==&gt;VM/Java barriers can call this function and when
2433 // thread state is _thread_in_native_trans.
2434 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2435   check_safepoint_and_suspend_for_native_trans(thread);
2436 
2437   if (thread-&gt;has_async_exception()) {
2438     // We are in _thread_in_native_trans state, don't handle unsafe
2439     // access error since that may block.
2440     thread-&gt;check_and_handle_async_exceptions(false);
2441   }
2442 }
2443 
2444 // This is a variant of the normal
2445 // check_special_condition_for_native_trans with slightly different
2446 // semantics for use by critical native wrappers.  It does all the
2447 // normal checks but also performs the transition back into
2448 // thread_in_Java state.  This is required so that critical natives
2449 // can potentially block and perform a GC if they are the last thread
2450 // exiting the GCLocker.
2451 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2452   check_special_condition_for_native_trans(thread);
2453 
2454   // Finish the transition
2455   thread-&gt;set_thread_state(_thread_in_Java);
2456 
2457   if (thread-&gt;do_critical_native_unlock()) {
2458     ThreadInVMfromJavaNoAsyncException tiv(thread);
2459     GCLocker::unlock_critical(thread);
2460     thread-&gt;clear_critical_native_unlock();
2461   }
2462 }
2463 
2464 // We need to guarantee the Threads_lock here, since resumes are not
2465 // allowed during safepoint synchronization
2466 // Can only resume from an external suspension
2467 void JavaThread::java_resume() {
2468   assert_locked_or_safepoint(Threads_lock);
2469 
2470   // Sanity check: thread is gone, has started exiting or the thread
2471   // was not externally suspended.
2472   if (!Threads::includes(this) || is_exiting() || !is_external_suspend()) {
2473     return;
2474   }
2475 
2476   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2477 
2478   clear_external_suspend();
2479 
2480   if (is_ext_suspended()) {
2481     clear_ext_suspended();
2482     SR_lock()-&gt;notify_all();
2483   }
2484 }
2485 
2486 size_t JavaThread::_stack_red_zone_size = 0;
2487 size_t JavaThread::_stack_yellow_zone_size = 0;
2488 size_t JavaThread::_stack_reserved_zone_size = 0;
2489 size_t JavaThread::_stack_shadow_zone_size = 0;
2490 
2491 void JavaThread::create_stack_guard_pages() {
2492   if (!os::uses_stack_guard_pages() || _stack_guard_state != stack_guard_unused) { return; }
2493   address low_addr = stack_end();
2494   size_t len = stack_guard_zone_size();
2495 
2496   int must_commit = os::must_commit_stack_guard_pages();
2497   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2498 
2499   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2500     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2501     return;
2502   }
2503 
2504   if (os::guard_memory((char *) low_addr, len)) {
2505     _stack_guard_state = stack_guard_enabled;
2506   } else {
2507     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2508       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2509     if (os::uncommit_memory((char *) low_addr, len)) {
2510       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2511     }
2512     return;
2513   }
2514 
2515   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2516     PTR_FORMAT "-" PTR_FORMAT ".",
2517     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2518 }
2519 
2520 void JavaThread::remove_stack_guard_pages() {
2521   assert(Thread::current() == this, "from different thread");
2522   if (_stack_guard_state == stack_guard_unused) return;
2523   address low_addr = stack_end();
2524   size_t len = stack_guard_zone_size();
2525 
2526   if (os::must_commit_stack_guard_pages()) {
2527     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2528       _stack_guard_state = stack_guard_unused;
2529     } else {
2530       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2531         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2532       return;
2533     }
2534   } else {
2535     if (_stack_guard_state == stack_guard_unused) return;
2536     if (os::unguard_memory((char *) low_addr, len)) {
2537       _stack_guard_state = stack_guard_unused;
2538     } else {
2539       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2540         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2541       return;
2542     }
2543   }
2544 
2545   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2546     PTR_FORMAT "-" PTR_FORMAT ".",
2547     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2548 }
2549 
2550 void JavaThread::enable_stack_reserved_zone() {
2551   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2552   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2553 
2554   // The base notation is from the stack's point of view, growing downward.
2555   // We need to adjust it to work correctly with guard_memory()
2556   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2557 
2558   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2559   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2560 
2561   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2562     _stack_guard_state = stack_guard_enabled;
2563   } else {
2564     warning("Attempt to guard stack reserved zone failed.");
2565   }
2566   enable_register_stack_guard();
2567 }
2568 
2569 void JavaThread::disable_stack_reserved_zone() {
2570   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2571   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2572 
2573   // Simply return if called for a thread that does not use guard pages.
2574   if (_stack_guard_state == stack_guard_unused) return;
2575 
2576   // The base notation is from the stack's point of view, growing downward.
2577   // We need to adjust it to work correctly with guard_memory()
2578   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2579 
2580   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2581     _stack_guard_state = stack_guard_reserved_disabled;
2582   } else {
2583     warning("Attempt to unguard stack reserved zone failed.");
2584   }
2585   disable_register_stack_guard();
2586 }
2587 
2588 void JavaThread::enable_stack_yellow_reserved_zone() {
2589   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2590   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2591 
2592   // The base notation is from the stacks point of view, growing downward.
2593   // We need to adjust it to work correctly with guard_memory()
2594   address base = stack_red_zone_base();
2595 
2596   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2597   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2598 
2599   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2600     _stack_guard_state = stack_guard_enabled;
2601   } else {
2602     warning("Attempt to guard stack yellow zone failed.");
2603   }
2604   enable_register_stack_guard();
2605 }
2606 
2607 void JavaThread::disable_stack_yellow_reserved_zone() {
2608   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2609   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2610 
2611   // Simply return if called for a thread that does not use guard pages.
2612   if (_stack_guard_state == stack_guard_unused) return;
2613 
2614   // The base notation is from the stacks point of view, growing downward.
2615   // We need to adjust it to work correctly with guard_memory()
2616   address base = stack_red_zone_base();
2617 
2618   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2619     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2620   } else {
2621     warning("Attempt to unguard stack yellow zone failed.");
2622   }
2623   disable_register_stack_guard();
2624 }
2625 
2626 void JavaThread::enable_stack_red_zone() {
2627   // The base notation is from the stacks point of view, growing downward.
2628   // We need to adjust it to work correctly with guard_memory()
2629   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2630   address base = stack_red_zone_base() - stack_red_zone_size();
2631 
2632   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2633   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2634 
2635   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2636     warning("Attempt to guard stack red zone failed.");
2637   }
2638 }
2639 
2640 void JavaThread::disable_stack_red_zone() {
2641   // The base notation is from the stacks point of view, growing downward.
2642   // We need to adjust it to work correctly with guard_memory()
2643   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2644   address base = stack_red_zone_base() - stack_red_zone_size();
2645   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2646     warning("Attempt to unguard stack red zone failed.");
2647   }
2648 }
2649 
2650 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2651   // ignore is there is no stack
2652   if (!has_last_Java_frame()) return;
2653   // traverse the stack frames. Starts from top frame.
2654   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2655     frame* fr = fst.current();
2656     f(fr, fst.register_map());
2657   }
2658 }
2659 
2660 
2661 #ifndef PRODUCT
2662 // Deoptimization
2663 // Function for testing deoptimization
2664 void JavaThread::deoptimize() {
2665   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2666   StackFrameStream fst(this, UseBiasedLocking);
2667   bool deopt = false;           // Dump stack only if a deopt actually happens.
2668   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2669   // Iterate over all frames in the thread and deoptimize
2670   for (; !fst.is_done(); fst.next()) {
2671     if (fst.current()-&gt;can_be_deoptimized()) {
2672 
2673       if (only_at) {
2674         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2675         // consists of comma or carriage return separated numbers so
2676         // search for the current bci in that string.
2677         address pc = fst.current()-&gt;pc();
2678         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2679         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2680         char buffer[8];
2681         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2682         size_t len = strlen(buffer);
2683         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2684         while (found != NULL) {
2685           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2686               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2687             // Check that the bci found is bracketed by terminators.
2688             break;
2689           }
2690           found = strstr(found + 1, buffer);
2691         }
2692         if (!found) {
2693           continue;
2694         }
2695       }
2696 
2697       if (DebugDeoptimization &amp;&amp; !deopt) {
2698         deopt = true; // One-time only print before deopt
2699         tty-&gt;print_cr("[BEFORE Deoptimization]");
2700         trace_frames();
2701         trace_stack();
2702       }
2703       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2704     }
2705   }
2706 
2707   if (DebugDeoptimization &amp;&amp; deopt) {
2708     tty-&gt;print_cr("[AFTER Deoptimization]");
2709     trace_frames();
2710   }
2711 }
2712 
2713 
2714 // Make zombies
2715 void JavaThread::make_zombies() {
2716   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2717     if (fst.current()-&gt;can_be_deoptimized()) {
2718       // it is a Java nmethod
2719       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2720       nm-&gt;make_not_entrant();
2721     }
2722   }
2723 }
2724 #endif // PRODUCT
2725 
2726 
2727 void JavaThread::deoptimized_wrt_marked_nmethods() {
2728   if (!has_last_Java_frame()) return;
2729   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2730   StackFrameStream fst(this, UseBiasedLocking);
2731   for (; !fst.is_done(); fst.next()) {
2732     if (fst.current()-&gt;should_be_deoptimized()) {
2733       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2734     }
2735   }
2736 }
2737 
2738 
2739 // If the caller is a NamedThread, then remember, in the current scope,
2740 // the given JavaThread in its _processed_thread field.
2741 class RememberProcessedThread: public StackObj {
2742   NamedThread* _cur_thr;
2743  public:
2744   RememberProcessedThread(JavaThread* jthr) {
2745     Thread* thread = Thread::current();
2746     if (thread-&gt;is_Named_thread()) {
2747       _cur_thr = (NamedThread *)thread;
2748       _cur_thr-&gt;set_processed_thread(jthr);
2749     } else {
2750       _cur_thr = NULL;
2751     }
2752   }
2753 
2754   ~RememberProcessedThread() {
2755     if (_cur_thr) {
2756       _cur_thr-&gt;set_processed_thread(NULL);
2757     }
2758   }
2759 };
2760 
2761 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2762   // Verify that the deferred card marks have been flushed.
2763   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2764 
2765   // The ThreadProfiler oops_do is done from FlatProfiler::oops_do
2766   // since there may be more than one thread using each ThreadProfiler.
2767 
2768   // Traverse the GCHandles
2769   Thread::oops_do(f, cf);
2770 
2771   JVMCI_ONLY(f-&gt;do_oop((oop*)&amp;_pending_failed_speculation);)
2772 
2773   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2774          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2775 
2776   if (has_last_Java_frame()) {
2777     // Record JavaThread to GC thread
2778     RememberProcessedThread rpt(this);
2779 
2780     // Traverse the privileged stack
2781     if (_privileged_stack_top != NULL) {
2782       _privileged_stack_top-&gt;oops_do(f);
2783     }
2784 
2785     // traverse the registered growable array
2786     if (_array_for_gc != NULL) {
2787       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2788         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2789       }
2790     }
2791 
2792     // Traverse the monitor chunks
2793     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2794       chunk-&gt;oops_do(f);
2795     }
2796 
2797     // Traverse the execution stack
2798     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2799       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2800     }
2801   }
2802 
2803   // callee_target is never live across a gc point so NULL it here should
2804   // it still contain a methdOop.
2805 
2806   set_callee_target(NULL);
2807 
2808   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2809   // If we have deferred set_locals there might be oops waiting to be
2810   // written
2811   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2812   if (list != NULL) {
2813     for (int i = 0; i &lt; list-&gt;length(); i++) {
2814       list-&gt;at(i)-&gt;oops_do(f);
2815     }
2816   }
2817 
2818   // Traverse instance variables at the end since the GC may be moving things
2819   // around using this function
2820   f-&gt;do_oop((oop*) &amp;_threadObj);
2821   f-&gt;do_oop((oop*) &amp;_vm_result);
2822   f-&gt;do_oop((oop*) &amp;_exception_oop);
2823   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2824 
2825   if (jvmti_thread_state() != NULL) {
2826     jvmti_thread_state()-&gt;oops_do(f);
2827   }
2828 }
2829 
2830 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2831   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2832          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2833 
2834   if (has_last_Java_frame()) {
2835     // Traverse the execution stack
2836     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2837       fst.current()-&gt;nmethods_do(cf);
2838     }
2839   }
2840 }
2841 
2842 void JavaThread::metadata_do(void f(Metadata*)) {
2843   if (has_last_Java_frame()) {
2844     // Traverse the execution stack to call f() on the methods in the stack
2845     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2846       fst.current()-&gt;metadata_do(f);
2847     }
2848   } else if (is_Compiler_thread()) {
2849     // need to walk ciMetadata in current compile tasks to keep alive.
2850     CompilerThread* ct = (CompilerThread*)this;
2851     if (ct-&gt;env() != NULL) {
2852       ct-&gt;env()-&gt;metadata_do(f);
2853     }
2854     if (ct-&gt;task() != NULL) {
2855       ct-&gt;task()-&gt;metadata_do(f);
2856     }
2857   }
2858 }
2859 
2860 // Printing
2861 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2862   switch (_thread_state) {
2863   case _thread_uninitialized:     return "_thread_uninitialized";
2864   case _thread_new:               return "_thread_new";
2865   case _thread_new_trans:         return "_thread_new_trans";
2866   case _thread_in_native:         return "_thread_in_native";
2867   case _thread_in_native_trans:   return "_thread_in_native_trans";
2868   case _thread_in_vm:             return "_thread_in_vm";
2869   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2870   case _thread_in_Java:           return "_thread_in_Java";
2871   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2872   case _thread_blocked:           return "_thread_blocked";
2873   case _thread_blocked_trans:     return "_thread_blocked_trans";
2874   default:                        return "unknown thread state";
2875   }
2876 }
2877 
2878 #ifndef PRODUCT
2879 void JavaThread::print_thread_state_on(outputStream *st) const {
2880   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2881 };
2882 void JavaThread::print_thread_state() const {
2883   print_thread_state_on(tty);
2884 }
2885 #endif // PRODUCT
2886 
2887 // Called by Threads::print() for VM_PrintThreads operation
2888 void JavaThread::print_on(outputStream *st) const {
2889   st-&gt;print_raw("\"");
2890   st-&gt;print_raw(get_thread_name());
2891   st-&gt;print_raw("\" ");
2892   oop thread_oop = threadObj();
2893   if (thread_oop != NULL) {
2894     st-&gt;print("#" INT64_FORMAT " ", java_lang_Thread::thread_id(thread_oop));
2895     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2896     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2897   }
2898   Thread::print_on(st);
2899   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2900   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2901   if (thread_oop != NULL) {
2902     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2903   }
2904 #ifndef PRODUCT
2905   print_thread_state_on(st);
2906   _safepoint_state-&gt;print_on(st);
2907 #endif // PRODUCT
2908   if (is_Compiler_thread()) {
2909     CompilerThread* ct = (CompilerThread*)this;
2910     if (ct-&gt;task() != NULL) {
2911       st-&gt;print("   Compiling: ");
2912       ct-&gt;task()-&gt;print(st, NULL, true, false);
2913     } else {
2914       st-&gt;print("   No compile task");
2915     }
2916     st-&gt;cr();
2917   }
2918 }
2919 
2920 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2921   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2922 }
2923 
2924 // Called by fatal error handler. The difference between this and
2925 // JavaThread::print() is that we can't grab lock or allocate memory.
2926 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2927   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2928   oop thread_obj = threadObj();
2929   if (thread_obj != NULL) {
2930     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2931   }
2932   st-&gt;print(" [");
2933   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2934   if (osthread()) {
2935     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2936   }
2937   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2938             p2i(stack_end()), p2i(stack_base()));
2939   st-&gt;print("]");
2940   return;
2941 }
2942 
2943 // Verification
2944 
2945 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2946 
2947 void JavaThread::verify() {
2948   // Verify oops in the thread.
2949   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2950 
2951   // Verify the stack frames.
2952   frames_do(frame_verify);
2953 }
2954 
2955 // CR 6300358 (sub-CR 2137150)
2956 // Most callers of this method assume that it can't return NULL but a
2957 // thread may not have a name whilst it is in the process of attaching to
2958 // the VM - see CR 6412693, and there are places where a JavaThread can be
2959 // seen prior to having it's threadObj set (eg JNI attaching threads and
2960 // if vm exit occurs during initialization). These cases can all be accounted
2961 // for such that this method never returns NULL.
2962 const char* JavaThread::get_thread_name() const {
2963 #ifdef ASSERT
2964   // early safepoints can hit while current thread does not yet have TLS
2965   if (!SafepointSynchronize::is_at_safepoint()) {
2966     Thread *cur = Thread::current();
2967     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
2968       // Current JavaThreads are allowed to get their own name without
2969       // the Threads_lock.
2970       assert_locked_or_safepoint(Threads_lock);
2971     }
2972   }
2973 #endif // ASSERT
2974   return get_thread_name_string();
2975 }
2976 
2977 // Returns a non-NULL representation of this thread's name, or a suitable
2978 // descriptive string if there is no set name
2979 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
2980   const char* name_str;
2981   oop thread_obj = threadObj();
2982   if (thread_obj != NULL) {
2983     oop name = java_lang_Thread::name(thread_obj);
2984     if (name != NULL) {
2985       if (buf == NULL) {
2986         name_str = java_lang_String::as_utf8_string(name);
2987       } else {
2988         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
2989       }
2990     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
2991       name_str = "&lt;no-name - thread is attaching&gt;";
2992     } else {
2993       name_str = Thread::name();
2994     }
2995   } else {
2996     name_str = Thread::name();
2997   }
2998   assert(name_str != NULL, "unexpected NULL thread name");
2999   return name_str;
3000 }
3001 
3002 
3003 const char* JavaThread::get_threadgroup_name() const {
3004   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3005   oop thread_obj = threadObj();
3006   if (thread_obj != NULL) {
3007     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3008     if (thread_group != NULL) {
3009       // ThreadGroup.name can be null
3010       return java_lang_ThreadGroup::name(thread_group);
3011     }
3012   }
3013   return NULL;
3014 }
3015 
3016 const char* JavaThread::get_parent_name() const {
3017   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3018   oop thread_obj = threadObj();
3019   if (thread_obj != NULL) {
3020     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3021     if (thread_group != NULL) {
3022       oop parent = java_lang_ThreadGroup::parent(thread_group);
3023       if (parent != NULL) {
3024         // ThreadGroup.name can be null
3025         return java_lang_ThreadGroup::name(parent);
3026       }
3027     }
3028   }
3029   return NULL;
3030 }
3031 
3032 ThreadPriority JavaThread::java_priority() const {
3033   oop thr_oop = threadObj();
3034   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3035   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3036   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3037   return priority;
3038 }
3039 
3040 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3041 
3042   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3043   // Link Java Thread object &lt;-&gt; C++ Thread
3044 
3045   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3046   // and put it into a new Handle.  The Handle "thread_oop" can then
3047   // be used to pass the C++ thread object to other methods.
3048 
3049   // Set the Java level thread object (jthread) field of the
3050   // new thread (a JavaThread *) to C++ thread object using the
3051   // "thread_oop" handle.
3052 
3053   // Set the thread field (a JavaThread *) of the
3054   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3055 
3056   Handle thread_oop(Thread::current(),
3057                     JNIHandles::resolve_non_null(jni_thread));
3058   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3059          "must be initialized");
3060   set_threadObj(thread_oop());
3061   java_lang_Thread::set_thread(thread_oop(), this);
3062 
3063   if (prio == NoPriority) {
3064     prio = java_lang_Thread::priority(thread_oop());
3065     assert(prio != NoPriority, "A valid priority should be present");
3066   }
3067 
3068   // Push the Java priority down to the native thread; needs Threads_lock
3069   Thread::set_priority(this, prio);
3070 
3071   prepare_ext();
3072 
3073   // Add the new thread to the Threads list and set it in motion.
3074   // We must have threads lock in order to call Threads::add.
3075   // It is crucial that we do not block before the thread is
3076   // added to the Threads list for if a GC happens, then the java_thread oop
3077   // will not be visited by GC.
3078   Threads::add(this);
3079 }
3080 
3081 oop JavaThread::current_park_blocker() {
3082   // Support for JSR-166 locks
3083   oop thread_oop = threadObj();
3084   if (thread_oop != NULL &amp;&amp;
3085       JDK_Version::current().supports_thread_park_blocker()) {
3086     return java_lang_Thread::park_blocker(thread_oop);
3087   }
3088   return NULL;
3089 }
3090 
3091 
3092 void JavaThread::print_stack_on(outputStream* st) {
3093   if (!has_last_Java_frame()) return;
3094   ResourceMark rm;
3095   HandleMark   hm;
3096 
3097   RegisterMap reg_map(this);
3098   vframe* start_vf = last_java_vframe(&amp;reg_map);
3099   int count = 0;
3100   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3101     if (f-&gt;is_java_frame()) {
3102       javaVFrame* jvf = javaVFrame::cast(f);
3103       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3104 
3105       // Print out lock information
3106       if (JavaMonitorsInStackTrace) {
3107         jvf-&gt;print_lock_info_on(st, count);
3108       }
3109     } else {
3110       // Ignore non-Java frames
3111     }
3112 
3113     // Bail-out case for too deep stacks
3114     count++;
3115     if (MaxJavaStackTraceDepth == count) return;
3116   }
3117 }
3118 
3119 
3120 // JVMTI PopFrame support
3121 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3122   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3123   if (in_bytes(size_in_bytes) != 0) {
3124     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3125     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3126     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3127   }
3128 }
3129 
3130 void* JavaThread::popframe_preserved_args() {
3131   return _popframe_preserved_args;
3132 }
3133 
3134 ByteSize JavaThread::popframe_preserved_args_size() {
3135   return in_ByteSize(_popframe_preserved_args_size);
3136 }
3137 
3138 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3139   int sz = in_bytes(popframe_preserved_args_size());
3140   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3141   return in_WordSize(sz / wordSize);
3142 }
3143 
3144 void JavaThread::popframe_free_preserved_args() {
3145   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3146   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3147   _popframe_preserved_args = NULL;
3148   _popframe_preserved_args_size = 0;
3149 }
3150 
3151 #ifndef PRODUCT
3152 
3153 void JavaThread::trace_frames() {
3154   tty-&gt;print_cr("[Describe stack]");
3155   int frame_no = 1;
3156   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3157     tty-&gt;print("  %d. ", frame_no++);
3158     fst.current()-&gt;print_value_on(tty, this);
3159     tty-&gt;cr();
3160   }
3161 }
3162 
3163 class PrintAndVerifyOopClosure: public OopClosure {
3164  protected:
3165   template &lt;class T&gt; inline void do_oop_work(T* p) {
3166     oop obj = oopDesc::load_decode_heap_oop(p);
3167     if (obj == NULL) return;
3168     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3169     if (obj-&gt;is_oop_or_null()) {
3170       if (obj-&gt;is_objArray()) {
3171         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3172       } else {
3173         obj-&gt;print();
3174       }
3175     } else {
3176       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3177     }
3178     tty-&gt;cr();
3179   }
3180  public:
3181   virtual void do_oop(oop* p) { do_oop_work(p); }
3182   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3183 };
3184 
3185 
3186 static void oops_print(frame* f, const RegisterMap *map) {
3187   PrintAndVerifyOopClosure print;
3188   f-&gt;print_value();
3189   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3190 }
3191 
3192 // Print our all the locations that contain oops and whether they are
3193 // valid or not.  This useful when trying to find the oldest frame
3194 // where an oop has gone bad since the frame walk is from youngest to
3195 // oldest.
3196 void JavaThread::trace_oops() {
3197   tty-&gt;print_cr("[Trace oops]");
3198   frames_do(oops_print);
3199 }
3200 
3201 
3202 #ifdef ASSERT
3203 // Print or validate the layout of stack frames
3204 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3205   ResourceMark rm;
3206   PRESERVE_EXCEPTION_MARK;
3207   FrameValues values;
3208   int frame_no = 0;
3209   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3210     fst.current()-&gt;describe(values, ++frame_no);
3211     if (depth == frame_no) break;
3212   }
3213   if (validate_only) {
3214     values.validate();
3215   } else {
3216     tty-&gt;print_cr("[Describe stack layout]");
3217     values.print(this);
3218   }
3219 }
3220 #endif
3221 
3222 void JavaThread::trace_stack_from(vframe* start_vf) {
3223   ResourceMark rm;
3224   int vframe_no = 1;
3225   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3226     if (f-&gt;is_java_frame()) {
3227       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3228     } else {
3229       f-&gt;print();
3230     }
3231     if (vframe_no &gt; StackPrintLimit) {
3232       tty-&gt;print_cr("...&lt;more frames&gt;...");
3233       return;
3234     }
3235   }
3236 }
3237 
3238 
3239 void JavaThread::trace_stack() {
3240   if (!has_last_Java_frame()) return;
3241   ResourceMark rm;
3242   HandleMark   hm;
3243   RegisterMap reg_map(this);
3244   trace_stack_from(last_java_vframe(&amp;reg_map));
3245 }
3246 
3247 
3248 #endif // PRODUCT
3249 
3250 
3251 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3252   assert(reg_map != NULL, "a map must be given");
3253   frame f = last_frame();
3254   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3255     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3256   }
3257   return NULL;
3258 }
3259 
3260 
3261 Klass* JavaThread::security_get_caller_class(int depth) {
3262   vframeStream vfst(this);
3263   vfst.security_get_caller_frame(depth);
3264   if (!vfst.at_end()) {
3265     return vfst.method()-&gt;method_holder();
3266   }
3267   return NULL;
3268 }
3269 
3270 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3271   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3272   CompileBroker::compiler_thread_loop();
3273 }
3274 
3275 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3276   NMethodSweeper::sweeper_loop();
3277 }
3278 
3279 // Create a CompilerThread
3280 CompilerThread::CompilerThread(CompileQueue* queue,
3281                                CompilerCounters* counters)
3282                                : JavaThread(&amp;compiler_thread_entry) {
3283   _env   = NULL;
3284   _log   = NULL;
3285   _task  = NULL;
3286   _queue = queue;
3287   _counters = counters;
3288   _buffer_blob = NULL;
3289   _compiler = NULL;
3290 
3291 #ifndef PRODUCT
3292   _ideal_graph_printer = NULL;
3293 #endif
3294 }
3295 
3296 bool CompilerThread::can_call_java() const {
3297   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3298 }
3299 
3300 // Create sweeper thread
3301 CodeCacheSweeperThread::CodeCacheSweeperThread()
3302 : JavaThread(&amp;sweeper_thread_entry) {
3303   _scanned_compiled_method = NULL;
3304 }
3305 
3306 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3307   JavaThread::oops_do(f, cf);
3308   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3309     // Safepoints can occur when the sweeper is scanning an nmethod so
3310     // process it here to make sure it isn't unloaded in the middle of
3311     // a scan.
3312     cf-&gt;do_code_blob(_scanned_compiled_method);
3313   }
3314 }
3315 
3316 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3317   JavaThread::nmethods_do(cf);
3318   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3319     // Safepoints can occur when the sweeper is scanning an nmethod so
3320     // process it here to make sure it isn't unloaded in the middle of
3321     // a scan.
3322     cf-&gt;do_code_blob(_scanned_compiled_method);
3323   }
3324 }
3325 
3326 
3327 // ======= Threads ========
3328 
3329 // The Threads class links together all active threads, and provides
3330 // operations over all threads.  It is protected by its own Mutex
3331 // lock, which is also used in other contexts to protect thread
3332 // operations from having the thread being operated on from exiting
3333 // and going away unexpectedly (e.g., safepoint synchronization)
3334 
3335 JavaThread* Threads::_thread_list = NULL;
3336 int         Threads::_number_of_threads = 0;
3337 int         Threads::_number_of_non_daemon_threads = 0;
3338 int         Threads::_return_code = 0;
3339 int         Threads::_thread_claim_parity = 0;
3340 size_t      JavaThread::_stack_size_at_create = 0;
3341 #ifdef ASSERT
3342 bool        Threads::_vm_complete = false;
3343 #endif
3344 
3345 // All JavaThreads
3346 #define ALL_JAVA_THREADS(X) for (JavaThread* X = _thread_list; X; X = X-&gt;next())
3347 
3348 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system)
3349 void Threads::threads_do(ThreadClosure* tc) {
3350   assert_locked_or_safepoint(Threads_lock);
3351   // ALL_JAVA_THREADS iterates through all JavaThreads
3352   ALL_JAVA_THREADS(p) {
3353     tc-&gt;do_thread(p);
3354   }
3355   // Someday we could have a table or list of all non-JavaThreads.
3356   // For now, just manually iterate through them.
3357   tc-&gt;do_thread(VMThread::vm_thread());
3358   Universe::heap()-&gt;gc_threads_do(tc);
3359   WatcherThread *wt = WatcherThread::watcher_thread();
3360   // Strictly speaking, the following NULL check isn't sufficient to make sure
3361   // the data for WatcherThread is still valid upon being examined. However,
3362   // considering that WatchThread terminates when the VM is on the way to
3363   // exit at safepoint, the chance of the above is extremely small. The right
3364   // way to prevent termination of WatcherThread would be to acquire
3365   // Terminator_lock, but we can't do that without violating the lock rank
3366   // checking in some cases.
3367   if (wt != NULL) {
3368     tc-&gt;do_thread(wt);
3369   }
3370 
3371   // If CompilerThreads ever become non-JavaThreads, add them here
3372 }
3373 
3374 // The system initialization in the library has three phases.
3375 //
3376 // Phase 1: java.lang.System class initialization
3377 //     java.lang.System is a primordial class loaded and initialized
3378 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3379 //     only does registerNatives and keeps the rest of the class
3380 //     initialization work later until thread initialization completes.
3381 //
3382 //     System.initPhase1 initializes the system properties, the static
3383 //     fields in, out, and err. Set up java signal handlers, OS-specific
3384 //     system settings, and thread group of the main thread.
3385 static void call_initPhase1(TRAPS) {
3386   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3387   instanceKlassHandle klass (THREAD, k);
3388 
3389   JavaValue result(T_VOID);
3390   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3391                                          vmSymbols::void_method_signature(), CHECK);
3392 }
3393 
3394 // Phase 2. Module system initialization
3395 //     This will initialize the module system.  Only java.base classes
3396 //     can be loaded until phase 2 completes.
3397 //
3398 //     Call System.initPhase2 after the compiler initialization and jsr292
3399 //     classes get initialized because module initialization runs a lot of java
3400 //     code, that for performance reasons, should be compiled.  Also, this will
3401 //     enable the startup code to use lambda and other language features in this
3402 //     phase and onward.
3403 //
3404 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3405 static void call_initPhase2(TRAPS) {
3406   TraceTime timer("Phase2 initialization", TRACETIME_LOG(Info, modules, startuptime));
3407 
3408   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3409   instanceKlassHandle klass (THREAD, k);
3410 
3411   JavaValue result(T_VOID);
3412   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3413                                          vmSymbols::void_method_signature(), CHECK);
3414   universe_post_module_init();
3415 }
3416 
3417 // Phase 3. final setup - set security manager, system class loader and TCCL
3418 //
3419 //     This will instantiate and set the security manager, set the system class
3420 //     loader as well as the thread context class loader.  The security manager
3421 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3422 //     other modules or the application's classpath.
3423 static void call_initPhase3(TRAPS) {
3424   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3425   instanceKlassHandle klass (THREAD, k);
3426 
3427   JavaValue result(T_VOID);
3428   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3429                                          vmSymbols::void_method_signature(), CHECK);
3430 }
3431 
3432 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3433   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3434 
3435   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3436     create_vm_init_libraries();
3437   }
3438 
3439   initialize_class(vmSymbols::java_lang_String(), CHECK);
3440 
3441   // Inject CompactStrings value after the static initializers for String ran.
3442   java_lang_String::set_compact_strings(CompactStrings);
3443 
3444   // Initialize java_lang.System (needed before creating the thread)
3445   initialize_class(vmSymbols::java_lang_System(), CHECK);
3446   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3447   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3448   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3449   Handle thread_group = create_initial_thread_group(CHECK);
3450   Universe::set_main_thread_group(thread_group());
3451   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3452   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3453   main_thread-&gt;set_threadObj(thread_object);
3454   // Set thread status to running since main thread has
3455   // been started and running.
3456   java_lang_Thread::set_thread_status(thread_object,
3457                                       java_lang_Thread::RUNNABLE);
3458 
3459   // The VM creates objects of this class.
3460   initialize_class(vmSymbols::java_lang_reflect_Module(), CHECK);
3461 
3462   // The VM preresolves methods to these classes. Make sure that they get initialized
3463   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3464   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3465 
3466   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3467   call_initPhase1(CHECK);
3468 
3469   // get the Java runtime name after java.lang.System is initialized
3470   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3471   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3472 
3473   // an instance of OutOfMemory exception has been allocated earlier
3474   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3475   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3476   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3477   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3478   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3479   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3480   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3481   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3482 }
3483 
3484 void Threads::initialize_jsr292_core_classes(TRAPS) {
3485   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3486 
3487   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3488   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3489   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3490 }
3491 
3492 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3493   extern void JDK_Version_init();
3494 
3495   // Preinitialize version info.
3496   VM_Version::early_initialize();
3497 
3498   // Check version
3499   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3500 
3501   // Initialize library-based TLS
3502   ThreadLocalStorage::init();
3503 
3504   // Initialize the output stream module
3505   ostream_init();
3506 
3507   // Process java launcher properties.
3508   Arguments::process_sun_java_launcher_properties(args);
3509 
3510   // Initialize the os module
3511   os::init();
3512 
3513   // Record VM creation timing statistics
3514   TraceVmCreationTime create_vm_timer;
3515   create_vm_timer.start();
3516 
3517   // Initialize system properties.
3518   Arguments::init_system_properties();
3519 
3520   // So that JDK version can be used as a discriminator when parsing arguments
3521   JDK_Version_init();
3522 
3523   // Update/Initialize System properties after JDK version number is known
3524   Arguments::init_version_specific_system_properties();
3525 
3526   // Make sure to initialize log configuration *before* parsing arguments
3527   LogConfiguration::initialize(create_vm_timer.begin_time());
3528 
3529   // Parse arguments
3530   jint parse_result = Arguments::parse(args);
3531   if (parse_result != JNI_OK) return parse_result;
3532 
3533   os::init_before_ergo();
3534 
3535   jint ergo_result = Arguments::apply_ergo();
3536   if (ergo_result != JNI_OK) return ergo_result;
3537 
3538   // Final check of all ranges after ergonomics which may change values.
3539   if (!CommandLineFlagRangeList::check_ranges()) {
3540     return JNI_EINVAL;
3541   }
3542 
3543   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3544   bool constraint_result = CommandLineFlagConstraintList::check_constraints(CommandLineFlagConstraint::AfterErgo);
3545   if (!constraint_result) {
3546     return JNI_EINVAL;
3547   }
3548 
3549   CommandLineFlagWriteableList::mark_startup();
3550 
3551   if (PauseAtStartup) {
3552     os::pause();
3553   }
3554 
3555   HOTSPOT_VM_INIT_BEGIN();
3556 
3557   // Timing (must come after argument parsing)
3558   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3559 
3560   // Initialize the os module after parsing the args
3561   jint os_init_2_result = os::init_2();
3562   if (os_init_2_result != JNI_OK) return os_init_2_result;
3563 
3564   jint adjust_after_os_result = Arguments::adjust_after_os();
3565   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3566 
3567   // Initialize output stream logging
3568   ostream_init_log();
3569 
3570   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3571   // Must be before create_vm_init_agents()
3572   if (Arguments::init_libraries_at_startup()) {
3573     convert_vm_init_libraries_to_agents();
3574   }
3575 
3576   // Launch -agentlib/-agentpath and converted -Xrun agents
3577   if (Arguments::init_agents_at_startup()) {
3578     create_vm_init_agents();
3579   }
3580 
3581   // Initialize Threads state
3582   _thread_list = NULL;
3583   _number_of_threads = 0;
3584   _number_of_non_daemon_threads = 0;
3585 
3586   // Initialize global data structures and create system classes in heap
3587   vm_init_globals();
3588 
3589 #if INCLUDE_JVMCI
3590   if (JVMCICounterSize &gt; 0) {
3591     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3592     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3593   } else {
3594     JavaThread::_jvmci_old_thread_counters = NULL;
3595   }
3596 #endif // INCLUDE_JVMCI
3597 
3598   // Attach the main thread to this os thread
3599   JavaThread* main_thread = new JavaThread();
3600   main_thread-&gt;set_thread_state(_thread_in_vm);
3601   main_thread-&gt;initialize_thread_current();
3602   // must do this before set_active_handles
3603   main_thread-&gt;record_stack_base_and_size();
3604   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3605 
3606   if (!main_thread-&gt;set_as_starting_thread()) {
3607     vm_shutdown_during_initialization(
3608                                       "Failed necessary internal allocation. Out of swap space");
3609     delete main_thread;
3610     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3611     return JNI_ENOMEM;
3612   }
3613 
3614   // Enable guard page *after* os::create_main_thread(), otherwise it would
3615   // crash Linux VM, see notes in os_linux.cpp.
3616   main_thread-&gt;create_stack_guard_pages();
3617 
3618   // Initialize Java-Level synchronization subsystem
3619   ObjectMonitor::Initialize();
3620 
3621   // Initialize global modules
3622   jint status = init_globals();
3623   if (status != JNI_OK) {
3624     delete main_thread;
3625     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3626     return status;
3627   }
3628 
3629   if (TRACE_INITIALIZE() != JNI_OK) {
3630     vm_exit_during_initialization("Failed to initialize tracing backend");
3631   }
3632 
3633   // Should be done after the heap is fully created
3634   main_thread-&gt;cache_global_variables();
3635 
3636   HandleMark hm;
3637 
3638   { MutexLocker mu(Threads_lock);
3639     Threads::add(main_thread);
3640   }
3641 
3642   // Any JVMTI raw monitors entered in onload will transition into
3643   // real raw monitor. VM is setup enough here for raw monitor enter.
3644   JvmtiExport::transition_pending_onload_raw_monitors();
3645 
3646   // Create the VMThread
3647   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3648 
3649   VMThread::create();
3650     Thread* vmthread = VMThread::vm_thread();
3651 
3652     if (!os::create_thread(vmthread, os::vm_thread)) {
3653       vm_exit_during_initialization("Cannot create VM thread. "
3654                                     "Out of system resources.");
3655     }
3656 
3657     // Wait for the VM thread to become ready, and VMThread::run to initialize
3658     // Monitors can have spurious returns, must always check another state flag
3659     {
3660       MutexLocker ml(Notify_lock);
3661       os::start_thread(vmthread);
3662       while (vmthread-&gt;active_handles() == NULL) {
3663         Notify_lock-&gt;wait();
3664       }
3665     }
3666   }
3667 
3668   assert(Universe::is_fully_initialized(), "not initialized");
3669   if (VerifyDuringStartup) {
3670     // Make sure we're starting with a clean slate.
3671     VM_Verify verify_op;
3672     VMThread::execute(&amp;verify_op);
3673   }
3674 
3675   Thread* THREAD = Thread::current();
3676 
3677   // At this point, the Universe is initialized, but we have not executed
3678   // any byte code.  Now is a good time (the only time) to dump out the
3679   // internal state of the JVM for sharing.
3680   if (DumpSharedSpaces) {
3681     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3682     ShouldNotReachHere();
3683   }
3684 
3685   // Always call even when there are not JVMTI environments yet, since environments
3686   // may be attached late and JVMTI must track phases of VM execution
3687   JvmtiExport::enter_early_start_phase();
3688 
3689   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3690   JvmtiExport::post_early_vm_start();
3691 
3692   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3693 
3694   // We need this for ClassDataSharing - the initial vm.info property is set
3695   // with the default value of CDS "sharing" which may be reset through
3696   // command line options.
3697   reset_vm_info_property(CHECK_JNI_ERR);
3698 
3699   quicken_jni_functions();
3700 
3701   // No more stub generation allowed after that point.
3702   StubCodeDesc::freeze();
3703 
3704   // Set flag that basic initialization has completed. Used by exceptions and various
3705   // debug stuff, that does not work until all basic classes have been initialized.
3706   set_init_completed();
3707 
3708   LogConfiguration::post_initialize();
3709   Metaspace::post_initialize();
3710 
3711   HOTSPOT_VM_INIT_END();
3712 
3713   // record VM initialization completion time
3714 #if INCLUDE_MANAGEMENT
3715   Management::record_vm_init_completed();
3716 #endif // INCLUDE_MANAGEMENT
3717 
3718   // Note that we do not use CHECK_0 here since we are inside an EXCEPTION_MARK and
3719   // set_init_completed has just been called, causing exceptions not to be shortcut
3720   // anymore. We call vm_exit_during_initialization directly instead.
3721 
3722   // Initialize reference pending list locker
3723   bool needs_locker_thread = Universe::heap()-&gt;needs_reference_pending_list_locker_thread();
3724   ReferencePendingListLocker::initialize(needs_locker_thread, CHECK_JNI_ERR);
3725 
3726   // Signal Dispatcher needs to be started before VMInit event is posted
3727   os::signal_init();
3728 
3729   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3730   if (!DisableAttachMechanism) {
3731     AttachListener::vm_start();
3732     if (StartAttachListener || AttachListener::init_at_startup()) {
3733       AttachListener::init();
3734     }
3735   }
3736 
3737   // Launch -Xrun agents
3738   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3739   // back-end can launch with -Xdebug -Xrunjdwp.
3740   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3741     create_vm_init_libraries();
3742   }
3743 
3744   if (CleanChunkPoolAsync) {
3745     Chunk::start_chunk_pool_cleaner_task();
3746   }
3747 
3748   // initialize compiler(s)
3749 #if defined(COMPILER1) || defined(COMPILER2) || defined(SHARK) || INCLUDE_JVMCI
3750   CompileBroker::compilation_init(CHECK_JNI_ERR);
3751 #endif
3752 
3753   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3754   // It is done after compilers are initialized, because otherwise compilations of
3755   // signature polymorphic MH intrinsics can be missed
3756   // (see SystemDictionary::find_method_handle_intrinsic).
3757   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3758 
3759   // This will initialize the module system.  Only java.base classes can be
3760   // loaded until phase 2 completes
3761   call_initPhase2(CHECK_JNI_ERR);
3762 
3763   // Always call even when there are not JVMTI environments yet, since environments
3764   // may be attached late and JVMTI must track phases of VM execution
3765   JvmtiExport::enter_start_phase();
3766 
3767   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3768   JvmtiExport::post_vm_start();
3769 
3770   // Final system initialization including security manager and system class loader
3771   call_initPhase3(CHECK_JNI_ERR);
3772 
3773   // cache the system class loader
3774   SystemDictionary::compute_java_system_loader(CHECK_(JNI_ERR));
3775 
3776 #if INCLUDE_JVMCI
3777   if (EnableJVMCI &amp;&amp; UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation)) {
3778     // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3779     // compilations via JVMCI will not actually block until JVMCI is initialized.
3780     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3781   }
3782 #endif
3783 
3784   // Always call even when there are not JVMTI environments yet, since environments
3785   // may be attached late and JVMTI must track phases of VM execution
3786   JvmtiExport::enter_live_phase();
3787 
3788   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3789   JvmtiExport::post_vm_initialized();
3790 
3791   if (TRACE_START() != JNI_OK) {
3792     vm_exit_during_initialization("Failed to start tracing backend.");
3793   }
3794 
3795 #if INCLUDE_MANAGEMENT
3796   Management::initialize(THREAD);
3797 
3798   if (HAS_PENDING_EXCEPTION) {
3799     // management agent fails to start possibly due to
3800     // configuration problem and is responsible for printing
3801     // stack trace if appropriate. Simply exit VM.
3802     vm_exit(1);
3803   }
3804 #endif // INCLUDE_MANAGEMENT
3805 
3806   if (Arguments::has_profile())       FlatProfiler::engage(main_thread, true);
3807   if (MemProfiling)                   MemProfiler::engage();
3808   StatSampler::engage();
3809   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3810 
3811   BiasedLocking::init();
3812 
3813 #if INCLUDE_RTM_OPT
3814   RTMLockingCounters::init();
3815 #endif
3816 
3817   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3818     call_postVMInitHook(THREAD);
3819     // The Java side of PostVMInitHook.run must deal with all
3820     // exceptions and provide means of diagnosis.
3821     if (HAS_PENDING_EXCEPTION) {
3822       CLEAR_PENDING_EXCEPTION;
3823     }
3824   }
3825 
3826   {
3827     MutexLocker ml(PeriodicTask_lock);
3828     // Make sure the WatcherThread can be started by WatcherThread::start()
3829     // or by dynamic enrollment.
3830     WatcherThread::make_startable();
3831     // Start up the WatcherThread if there are any periodic tasks
3832     // NOTE:  All PeriodicTasks should be registered by now. If they
3833     //   aren't, late joiners might appear to start slowly (we might
3834     //   take a while to process their first tick).
3835     if (PeriodicTask::num_tasks() &gt; 0) {
3836       WatcherThread::start();
3837     }
3838   }
3839 
3840   CodeCacheExtensions::complete_step(CodeCacheExtensionsSteps::CreateVM);
3841 
3842   create_vm_timer.end();
3843 #ifdef ASSERT
3844   _vm_complete = true;
3845 #endif
3846   return JNI_OK;
3847 }
3848 
3849 // type for the Agent_OnLoad and JVM_OnLoad entry points
3850 extern "C" {
3851   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3852 }
3853 // Find a command line agent library and return its entry point for
3854 //         -agentlib:  -agentpath:   -Xrun
3855 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3856 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3857                                     const char *on_load_symbols[],
3858                                     size_t num_symbol_entries) {
3859   OnLoadEntry_t on_load_entry = NULL;
3860   void *library = NULL;
3861 
3862   if (!agent-&gt;valid()) {
3863     char buffer[JVM_MAXPATHLEN];
3864     char ebuf[1024] = "";
3865     const char *name = agent-&gt;name();
3866     const char *msg = "Could not find agent library ";
3867 
3868     // First check to see if agent is statically linked into executable
3869     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3870       library = agent-&gt;os_lib();
3871     } else if (agent-&gt;is_absolute_path()) {
3872       library = os::dll_load(name, ebuf, sizeof ebuf);
3873       if (library == NULL) {
3874         const char *sub_msg = " in absolute path, with error: ";
3875         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3876         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3877         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3878         // If we can't find the agent, exit.
3879         vm_exit_during_initialization(buf, NULL);
3880         FREE_C_HEAP_ARRAY(char, buf);
3881       }
3882     } else {
3883       // Try to load the agent from the standard dll directory
3884       if (os::dll_build_name(buffer, sizeof(buffer), Arguments::get_dll_dir(),
3885                              name)) {
3886         library = os::dll_load(buffer, ebuf, sizeof ebuf);
3887       }
3888       if (library == NULL) { // Try the local directory
3889         char ns[1] = {0};
3890         if (os::dll_build_name(buffer, sizeof(buffer), ns, name)) {
3891           library = os::dll_load(buffer, ebuf, sizeof ebuf);
3892         }
3893         if (library == NULL) {
3894           const char *sub_msg = " on the library path, with error: ";
3895           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3896           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3897           jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3898           // If we can't find the agent, exit.
3899           vm_exit_during_initialization(buf, NULL);
3900           FREE_C_HEAP_ARRAY(char, buf);
3901         }
3902       }
3903     }
3904     agent-&gt;set_os_lib(library);
3905     agent-&gt;set_valid();
3906   }
3907 
3908   // Find the OnLoad function.
3909   on_load_entry =
3910     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
3911                                                           false,
3912                                                           on_load_symbols,
3913                                                           num_symbol_entries));
3914   return on_load_entry;
3915 }
3916 
3917 // Find the JVM_OnLoad entry point
3918 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
3919   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
3920   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3921 }
3922 
3923 // Find the Agent_OnLoad entry point
3924 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
3925   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
3926   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3927 }
3928 
3929 // For backwards compatibility with -Xrun
3930 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
3931 // treated like -agentpath:
3932 // Must be called before agent libraries are created
3933 void Threads::convert_vm_init_libraries_to_agents() {
3934   AgentLibrary* agent;
3935   AgentLibrary* next;
3936 
3937   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
3938     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
3939     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
3940 
3941     // If there is an JVM_OnLoad function it will get called later,
3942     // otherwise see if there is an Agent_OnLoad
3943     if (on_load_entry == NULL) {
3944       on_load_entry = lookup_agent_on_load(agent);
3945       if (on_load_entry != NULL) {
3946         // switch it to the agent list -- so that Agent_OnLoad will be called,
3947         // JVM_OnLoad won't be attempted and Agent_OnUnload will
3948         Arguments::convert_library_to_agent(agent);
3949       } else {
3950         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
3951       }
3952     }
3953   }
3954 }
3955 
3956 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
3957 // Invokes Agent_OnLoad
3958 // Called very early -- before JavaThreads exist
3959 void Threads::create_vm_init_agents() {
3960   extern struct JavaVM_ main_vm;
3961   AgentLibrary* agent;
3962 
3963   JvmtiExport::enter_onload_phase();
3964 
3965   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3966     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
3967 
3968     if (on_load_entry != NULL) {
3969       // Invoke the Agent_OnLoad function
3970       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
3971       if (err != JNI_OK) {
3972         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
3973       }
3974     } else {
3975       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
3976     }
3977   }
3978   JvmtiExport::enter_primordial_phase();
3979 }
3980 
3981 extern "C" {
3982   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
3983 }
3984 
3985 void Threads::shutdown_vm_agents() {
3986   // Send any Agent_OnUnload notifications
3987   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
3988   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
3989   extern struct JavaVM_ main_vm;
3990   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3991 
3992     // Find the Agent_OnUnload function.
3993     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
3994                                                    os::find_agent_function(agent,
3995                                                    false,
3996                                                    on_unload_symbols,
3997                                                    num_symbol_entries));
3998 
3999     // Invoke the Agent_OnUnload function
4000     if (unload_entry != NULL) {
4001       JavaThread* thread = JavaThread::current();
4002       ThreadToNativeFromVM ttn(thread);
4003       HandleMark hm(thread);
4004       (*unload_entry)(&amp;main_vm);
4005     }
4006   }
4007 }
4008 
4009 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4010 // Invokes JVM_OnLoad
4011 void Threads::create_vm_init_libraries() {
4012   extern struct JavaVM_ main_vm;
4013   AgentLibrary* agent;
4014 
4015   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4016     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4017 
4018     if (on_load_entry != NULL) {
4019       // Invoke the JVM_OnLoad function
4020       JavaThread* thread = JavaThread::current();
4021       ThreadToNativeFromVM ttn(thread);
4022       HandleMark hm(thread);
4023       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4024       if (err != JNI_OK) {
4025         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4026       }
4027     } else {
4028       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4029     }
4030   }
4031 }
4032 
4033 JavaThread* Threads::find_java_thread_from_java_tid(jlong java_tid) {
4034   assert(Threads_lock-&gt;owned_by_self(), "Must hold Threads_lock");
4035 
4036   JavaThread* java_thread = NULL;
4037   // Sequential search for now.  Need to do better optimization later.
4038   for (JavaThread* thread = Threads::first(); thread != NULL; thread = thread-&gt;next()) {
4039     oop tobj = thread-&gt;threadObj();
4040     if (!thread-&gt;is_exiting() &amp;&amp;
4041         tobj != NULL &amp;&amp;
4042         java_tid == java_lang_Thread::thread_id(tobj)) {
4043       java_thread = thread;
4044       break;
4045     }
4046   }
4047   return java_thread;
4048 }
4049 
4050 
4051 // Last thread running calls java.lang.Shutdown.shutdown()
4052 void JavaThread::invoke_shutdown_hooks() {
4053   HandleMark hm(this);
4054 
4055   // We could get here with a pending exception, if so clear it now.
4056   if (this-&gt;has_pending_exception()) {
4057     this-&gt;clear_pending_exception();
4058   }
4059 
4060   EXCEPTION_MARK;
4061   Klass* k =
4062     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4063                                       THREAD);
4064   if (k != NULL) {
4065     // SystemDictionary::resolve_or_null will return null if there was
4066     // an exception.  If we cannot load the Shutdown class, just don't
4067     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4068     // and finalizers (if runFinalizersOnExit is set) won't be run.
4069     // Note that if a shutdown hook was registered or runFinalizersOnExit
4070     // was called, the Shutdown class would have already been loaded
4071     // (Runtime.addShutdownHook and runFinalizersOnExit will load it).
4072     instanceKlassHandle shutdown_klass (THREAD, k);
4073     JavaValue result(T_VOID);
4074     JavaCalls::call_static(&amp;result,
4075                            shutdown_klass,
4076                            vmSymbols::shutdown_method_name(),
4077                            vmSymbols::void_method_signature(),
4078                            THREAD);
4079   }
4080   CLEAR_PENDING_EXCEPTION;
4081 }
4082 
4083 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4084 // the program falls off the end of main(). Another VM exit path is through
4085 // vm_exit() when the program calls System.exit() to return a value or when
4086 // there is a serious error in VM. The two shutdown paths are not exactly
4087 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4088 // and VM_Exit op at VM level.
4089 //
4090 // Shutdown sequence:
4091 //   + Shutdown native memory tracking if it is on
4092 //   + Wait until we are the last non-daemon thread to execute
4093 //     &lt;-- every thing is still working at this moment --&gt;
4094 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4095 //        shutdown hooks, run finalizers if finalization-on-exit
4096 //   + Call before_exit(), prepare for VM exit
4097 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4098 //        currently the only user of this mechanism is File.deleteOnExit())
4099 //      &gt; stop flat profiler, StatSampler, watcher thread, CMS threads,
4100 //        post thread end and vm death events to JVMTI,
4101 //        stop signal thread
4102 //   + Call JavaThread::exit(), it will:
4103 //      &gt; release JNI handle blocks, remove stack guard pages
4104 //      &gt; remove this thread from Threads list
4105 //     &lt;-- no more Java code from this thread after this point --&gt;
4106 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4107 //     the compiler threads at safepoint
4108 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4109 //   + Disable tracing at JNI/JVM barriers
4110 //   + Set _vm_exited flag for threads that are still running native code
4111 //   + Delete this thread
4112 //   + Call exit_globals()
4113 //      &gt; deletes tty
4114 //      &gt; deletes PerfMemory resources
4115 //   + Return to caller
4116 
4117 bool Threads::destroy_vm() {
4118   JavaThread* thread = JavaThread::current();
4119 
4120 #ifdef ASSERT
4121   _vm_complete = false;
4122 #endif
4123   // Wait until we are the last non-daemon thread to execute
4124   { MutexLocker nu(Threads_lock);
4125     while (Threads::number_of_non_daemon_threads() &gt; 1)
4126       // This wait should make safepoint checks, wait without a timeout,
4127       // and wait as a suspend-equivalent condition.
4128       //
4129       // Note: If the FlatProfiler is running and this thread is waiting
4130       // for another non-daemon thread to finish, then the FlatProfiler
4131       // is waiting for the external suspend request on this thread to
4132       // complete. wait_for_ext_suspend_completion() will eventually
4133       // timeout, but that takes time. Making this wait a suspend-
4134       // equivalent condition solves that timeout problem.
4135       //
4136       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4137                          Mutex::_as_suspend_equivalent_flag);
4138   }
4139 
4140   // Hang forever on exit if we are reporting an error.
4141   if (ShowMessageBoxOnError &amp;&amp; is_error_reported()) {
4142     os::infinite_sleep();
4143   }
4144   os::wait_for_keypress_at_exit();
4145 
4146   // run Java level shutdown hooks
4147   thread-&gt;invoke_shutdown_hooks();
4148 
4149   before_exit(thread);
4150 
4151   thread-&gt;exit(true);
4152 
4153   // Stop VM thread.
4154   {
4155     // 4945125 The vm thread comes to a safepoint during exit.
4156     // GC vm_operations can get caught at the safepoint, and the
4157     // heap is unparseable if they are caught. Grab the Heap_lock
4158     // to prevent this. The GC vm_operations will not be able to
4159     // queue until after the vm thread is dead. After this point,
4160     // we'll never emerge out of the safepoint before the VM exits.
4161 
4162     MutexLocker ml(Heap_lock);
4163 
4164     VMThread::wait_for_vm_thread_exit();
4165     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4166     VMThread::destroy();
4167   }
4168 
4169   // clean up ideal graph printers
4170 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4171   IdealGraphPrinter::clean_up();
4172 #endif
4173 
4174   // Now, all Java threads are gone except daemon threads. Daemon threads
4175   // running Java code or in VM are stopped by the Safepoint. However,
4176   // daemon threads executing native code are still running.  But they
4177   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4178   // simply kill or suspend them, as it is inherently deadlock-prone.
4179 
4180   VM_Exit::set_vm_exited();
4181 
4182   notify_vm_shutdown();
4183 
4184   delete thread;
4185 
4186 #if INCLUDE_JVMCI
4187   if (JVMCICounterSize &gt; 0) {
4188     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4189   }
4190 #endif
4191 
4192   // exit_globals() will delete tty
4193   exit_globals();
4194 
4195   LogConfiguration::finalize();
4196 
4197   return true;
4198 }
4199 
4200 
4201 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4202   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4203   return is_supported_jni_version(version);
4204 }
4205 
4206 
4207 jboolean Threads::is_supported_jni_version(jint version) {
4208   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4209   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4210   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4211   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4212   if (version == JNI_VERSION_9) return JNI_TRUE;
4213   return JNI_FALSE;
4214 }
4215 
4216 
4217 void Threads::add(JavaThread* p, bool force_daemon) {
4218   // The threads lock must be owned at this point
4219   assert_locked_or_safepoint(Threads_lock);
4220 
4221   // See the comment for this method in thread.hpp for its purpose and
4222   // why it is called here.
4223   p-&gt;initialize_queues();
4224   p-&gt;set_next(_thread_list);
4225   _thread_list = p;
4226   _number_of_threads++;
4227   oop threadObj = p-&gt;threadObj();
4228   bool daemon = true;
4229   // Bootstrapping problem: threadObj can be null for initial
4230   // JavaThread (or for threads attached via JNI)
4231   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4232     _number_of_non_daemon_threads++;
4233     daemon = false;
4234   }
4235 
4236   ThreadService::add_thread(p, daemon);
4237 
4238   // Possible GC point.
4239   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4240 }
4241 
4242 void Threads::remove(JavaThread* p) {
4243   // Extra scope needed for Thread_lock, so we can check
4244   // that we do not remove thread without safepoint code notice
4245   { MutexLocker ml(Threads_lock);
4246 
4247     assert(includes(p), "p must be present");
4248 
4249     JavaThread* current = _thread_list;
4250     JavaThread* prev    = NULL;
4251 
4252     while (current != p) {
4253       prev    = current;
4254       current = current-&gt;next();
4255     }
4256 
4257     if (prev) {
4258       prev-&gt;set_next(current-&gt;next());
4259     } else {
4260       _thread_list = p-&gt;next();
4261     }
4262     _number_of_threads--;
4263     oop threadObj = p-&gt;threadObj();
4264     bool daemon = true;
4265     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4266       _number_of_non_daemon_threads--;
4267       daemon = false;
4268 
4269       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4270       // on destroy_vm will wake up.
4271       if (number_of_non_daemon_threads() == 1) {
4272         Threads_lock-&gt;notify_all();
4273       }
4274     }
4275     ThreadService::remove_thread(p, daemon);
4276 
4277     // Make sure that safepoint code disregard this thread. This is needed since
4278     // the thread might mess around with locks after this point. This can cause it
4279     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4280     // of this thread since it is removed from the queue.
4281     p-&gt;set_terminated_value();
4282   } // unlock Threads_lock
4283 
4284   // Since Events::log uses a lock, we grab it outside the Threads_lock
4285   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4286 }
4287 
4288 // Threads_lock must be held when this is called (or must be called during a safepoint)
4289 bool Threads::includes(JavaThread* p) {
4290   assert(Threads_lock-&gt;is_locked(), "sanity check");
4291   ALL_JAVA_THREADS(q) {
4292     if (q == p) {
4293       return true;
4294     }
4295   }
4296   return false;
4297 }
4298 
4299 // Operations on the Threads list for GC.  These are not explicitly locked,
4300 // but the garbage collector must provide a safe context for them to run.
4301 // In particular, these things should never be called when the Threads_lock
4302 // is held by some other thread. (Note: the Safepoint abstraction also
4303 // uses the Threads_lock to guarantee this property. It also makes sure that
4304 // all threads gets blocked when exiting or starting).
4305 
4306 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4307   ALL_JAVA_THREADS(p) {
4308     p-&gt;oops_do(f, cf);
4309   }
4310   VMThread::vm_thread()-&gt;oops_do(f, cf);
4311 }
4312 
4313 void Threads::change_thread_claim_parity() {
4314   // Set the new claim parity.
4315   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4316          "Not in range.");
4317   _thread_claim_parity++;
4318   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4319   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4320          "Not in range.");
4321 }
4322 
4323 #ifdef ASSERT
4324 void Threads::assert_all_threads_claimed() {
4325   ALL_JAVA_THREADS(p) {
4326     const int thread_parity = p-&gt;oops_do_parity();
4327     assert((thread_parity == _thread_claim_parity),
4328            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4329   }
4330 }
4331 #endif // ASSERT
4332 
4333 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4334   int cp = Threads::thread_claim_parity();
4335   ALL_JAVA_THREADS(p) {
4336     if (p-&gt;claim_oops_do(is_par, cp)) {
4337       p-&gt;oops_do(f, cf);
4338     }
4339   }
4340   VMThread* vmt = VMThread::vm_thread();
4341   if (vmt-&gt;claim_oops_do(is_par, cp)) {
4342     vmt-&gt;oops_do(f, cf);
4343   }
4344 }
4345 
4346 #if INCLUDE_ALL_GCS
4347 // Used by ParallelScavenge
4348 void Threads::create_thread_roots_tasks(GCTaskQueue* q) {
4349   ALL_JAVA_THREADS(p) {
4350     q-&gt;enqueue(new ThreadRootsTask(p));
4351   }
4352   q-&gt;enqueue(new ThreadRootsTask(VMThread::vm_thread()));
4353 }
4354 
4355 // Used by Parallel Old
4356 void Threads::create_thread_roots_marking_tasks(GCTaskQueue* q) {
4357   ALL_JAVA_THREADS(p) {
4358     q-&gt;enqueue(new ThreadRootsMarkingTask(p));
4359   }
4360   q-&gt;enqueue(new ThreadRootsMarkingTask(VMThread::vm_thread()));
4361 }
4362 #endif // INCLUDE_ALL_GCS
4363 
4364 void Threads::nmethods_do(CodeBlobClosure* cf) {
4365   ALL_JAVA_THREADS(p) {
4366     // This is used by the code cache sweeper to mark nmethods that are active
4367     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4368     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4369     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4370       p-&gt;nmethods_do(cf);
4371     }
4372   }
4373 }
4374 
4375 void Threads::metadata_do(void f(Metadata*)) {
4376   ALL_JAVA_THREADS(p) {
4377     p-&gt;metadata_do(f);
4378   }
4379 }
4380 
4381 class ThreadHandlesClosure : public ThreadClosure {
4382   void (*_f)(Metadata*);
4383  public:
4384   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4385   virtual void do_thread(Thread* thread) {
4386     thread-&gt;metadata_handles_do(_f);
4387   }
4388 };
4389 
4390 void Threads::metadata_handles_do(void f(Metadata*)) {
4391   // Only walk the Handles in Thread.
4392   ThreadHandlesClosure handles_closure(f);
4393   threads_do(&amp;handles_closure);
4394 }
4395 
4396 void Threads::deoptimized_wrt_marked_nmethods() {
4397   ALL_JAVA_THREADS(p) {
4398     p-&gt;deoptimized_wrt_marked_nmethods();
4399   }
4400 }
4401 
4402 
4403 // Get count Java threads that are waiting to enter the specified monitor.
4404 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(int count,
4405                                                          address monitor,
4406                                                          bool doLock) {
4407   assert(doLock || SafepointSynchronize::is_at_safepoint(),
4408          "must grab Threads_lock or be at safepoint");
4409   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4410 
4411   int i = 0;
4412   {
4413     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4414     ALL_JAVA_THREADS(p) {
4415       if (!p-&gt;can_call_java()) continue;
4416 
4417       address pending = (address)p-&gt;current_pending_monitor();
4418       if (pending == monitor) {             // found a match
4419         if (i &lt; count) result-&gt;append(p);   // save the first count matches
4420         i++;
4421       }
4422     }
4423   }
4424   return result;
4425 }
4426 
4427 
4428 JavaThread *Threads::owning_thread_from_monitor_owner(address owner,
4429                                                       bool doLock) {
4430   assert(doLock ||
4431          Threads_lock-&gt;owned_by_self() ||
4432          SafepointSynchronize::is_at_safepoint(),
4433          "must grab Threads_lock or be at safepoint");
4434 
4435   // NULL owner means not locked so we can skip the search
4436   if (owner == NULL) return NULL;
4437 
4438   {
4439     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4440     ALL_JAVA_THREADS(p) {
4441       // first, see if owner is the address of a Java thread
4442       if (owner == (address)p) return p;
4443     }
4444   }
4445   // Cannot assert on lack of success here since this function may be
4446   // used by code that is trying to report useful problem information
4447   // like deadlock detection.
4448   if (UseHeavyMonitors) return NULL;
4449 
4450   // If we didn't find a matching Java thread and we didn't force use of
4451   // heavyweight monitors, then the owner is the stack address of the
4452   // Lock Word in the owning Java thread's stack.
4453   //
4454   JavaThread* the_owner = NULL;
4455   {
4456     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4457     ALL_JAVA_THREADS(q) {
4458       if (q-&gt;is_lock_owned(owner)) {
4459         the_owner = q;
4460         break;
4461       }
4462     }
4463   }
4464   // cannot assert on lack of success here; see above comment
4465   return the_owner;
4466 }
4467 
4468 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4469 void Threads::print_on(outputStream* st, bool print_stacks,
4470                        bool internal_format, bool print_concurrent_locks) {
4471   char buf[32];
4472   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4473 
4474   st-&gt;print_cr("Full thread dump %s (%s %s):",
4475                Abstract_VM_Version::vm_name(),
4476                Abstract_VM_Version::vm_release(),
4477                Abstract_VM_Version::vm_info_string());
4478   st-&gt;cr();
4479 
4480 #if INCLUDE_SERVICES
4481   // Dump concurrent locks
4482   ConcurrentLocksDump concurrent_locks;
4483   if (print_concurrent_locks) {
4484     concurrent_locks.dump_at_safepoint();
4485   }
4486 #endif // INCLUDE_SERVICES
4487 
4488   ALL_JAVA_THREADS(p) {
4489     ResourceMark rm;
4490     p-&gt;print_on(st);
4491     if (print_stacks) {
4492       if (internal_format) {
4493         p-&gt;trace_stack();
4494       } else {
4495         p-&gt;print_stack_on(st);
4496       }
4497     }
4498     st-&gt;cr();
4499 #if INCLUDE_SERVICES
4500     if (print_concurrent_locks) {
4501       concurrent_locks.print_locks_on(p, st);
4502     }
4503 #endif // INCLUDE_SERVICES
4504   }
4505 
4506   VMThread::vm_thread()-&gt;print_on(st);
4507   st-&gt;cr();
4508   Universe::heap()-&gt;print_gc_threads_on(st);
4509   WatcherThread* wt = WatcherThread::watcher_thread();
4510   if (wt != NULL) {
4511     wt-&gt;print_on(st);
4512     st-&gt;cr();
4513   }
4514   st-&gt;flush();
4515 }
4516 
4517 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4518                              int buflen, bool* found_current) {
4519   if (this_thread != NULL) {
4520     bool is_current = (current == this_thread);
4521     *found_current = *found_current || is_current;
4522     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4523 
4524     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4525     st-&gt;print(" ");
4526     this_thread-&gt;print_on_error(st, buf, buflen);
4527     st-&gt;cr();
4528   }
4529 }
4530 
4531 class PrintOnErrorClosure : public ThreadClosure {
4532   outputStream* _st;
4533   Thread* _current;
4534   char* _buf;
4535   int _buflen;
4536   bool* _found_current;
4537  public:
4538   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4539                       int buflen, bool* found_current) :
4540    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4541 
4542   virtual void do_thread(Thread* thread) {
4543     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4544   }
4545 };
4546 
4547 // Threads::print_on_error() is called by fatal error handler. It's possible
4548 // that VM is not at safepoint and/or current thread is inside signal handler.
4549 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4550 // memory (even in resource area), it might deadlock the error handler.
4551 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4552                              int buflen) {
4553   bool found_current = false;
4554   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4555   ALL_JAVA_THREADS(thread) {
4556     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4557   }
4558   st-&gt;cr();
4559 
4560   st-&gt;print_cr("Other Threads:");
4561   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4562   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4563 
4564   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4565   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4566 
4567   if (!found_current) {
4568     st-&gt;cr();
4569     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4570     current-&gt;print_on_error(st, buf, buflen);
4571     st-&gt;cr();
4572   }
4573   st-&gt;cr();
4574   st-&gt;print_cr("Threads with active compile tasks:");
4575   print_threads_compiling(st, buf, buflen);
4576 }
4577 
4578 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4579   ALL_JAVA_THREADS(thread) {
4580     if (thread-&gt;is_Compiler_thread()) {
4581       CompilerThread* ct = (CompilerThread*) thread;
4582       if (ct-&gt;task() != NULL) {
4583         thread-&gt;print_name_on_error(st, buf, buflen);
4584         ct-&gt;task()-&gt;print(st, NULL, true, true);
4585       }
4586     }
4587   }
4588 }
4589 
4590 
4591 // Internal SpinLock and Mutex
4592 // Based on ParkEvent
4593 
4594 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4595 //
4596 // We employ SpinLocks _only for low-contention, fixed-length
4597 // short-duration critical sections where we're concerned
4598 // about native mutex_t or HotSpot Mutex:: latency.
4599 // The mux construct provides a spin-then-block mutual exclusion
4600 // mechanism.
4601 //
4602 // Testing has shown that contention on the ListLock guarding gFreeList
4603 // is common.  If we implement ListLock as a simple SpinLock it's common
4604 // for the JVM to devolve to yielding with little progress.  This is true
4605 // despite the fact that the critical sections protected by ListLock are
4606 // extremely short.
4607 //
4608 // TODO-FIXME: ListLock should be of type SpinLock.
4609 // We should make this a 1st-class type, integrated into the lock
4610 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4611 // should have sufficient padding to avoid false-sharing and excessive
4612 // cache-coherency traffic.
4613 
4614 
4615 typedef volatile int SpinLockT;
4616 
4617 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4618   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4619     return;   // normal fast-path return
4620   }
4621 
4622   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4623   TEVENT(SpinAcquire - ctx);
4624   int ctr = 0;
4625   int Yields = 0;
4626   for (;;) {
4627     while (*adr != 0) {
4628       ++ctr;
4629       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4630         if (Yields &gt; 5) {
4631           os::naked_short_sleep(1);
4632         } else {
4633           os::naked_yield();
4634           ++Yields;
4635         }
4636       } else {
4637         SpinPause();
4638       }
4639     }
4640     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4641   }
4642 }
4643 
4644 void Thread::SpinRelease(volatile int * adr) {
4645   assert(*adr != 0, "invariant");
4646   OrderAccess::fence();      // guarantee at least release consistency.
4647   // Roach-motel semantics.
4648   // It's safe if subsequent LDs and STs float "up" into the critical section,
4649   // but prior LDs and STs within the critical section can't be allowed
4650   // to reorder or float past the ST that releases the lock.
4651   // Loads and stores in the critical section - which appear in program
4652   // order before the store that releases the lock - must also appear
4653   // before the store that releases the lock in memory visibility order.
4654   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4655   // the ST of 0 into the lock-word which releases the lock, so fence
4656   // more than covers this on all platforms.
4657   *adr = 0;
4658 }
4659 
4660 // muxAcquire and muxRelease:
4661 //
4662 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4663 //    The LSB of the word is set IFF the lock is held.
4664 //    The remainder of the word points to the head of a singly-linked list
4665 //    of threads blocked on the lock.
4666 //
4667 // *  The current implementation of muxAcquire-muxRelease uses its own
4668 //    dedicated Thread._MuxEvent instance.  If we're interested in
4669 //    minimizing the peak number of extant ParkEvent instances then
4670 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4671 //    as certain invariants were satisfied.  Specifically, care would need
4672 //    to be taken with regards to consuming unpark() "permits".
4673 //    A safe rule of thumb is that a thread would never call muxAcquire()
4674 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4675 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4676 //    consume an unpark() permit intended for monitorenter, for instance.
4677 //    One way around this would be to widen the restricted-range semaphore
4678 //    implemented in park().  Another alternative would be to provide
4679 //    multiple instances of the PlatformEvent() for each thread.  One
4680 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4681 //
4682 // *  Usage:
4683 //    -- Only as leaf locks
4684 //    -- for short-term locking only as muxAcquire does not perform
4685 //       thread state transitions.
4686 //
4687 // Alternatives:
4688 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4689 //    but with parking or spin-then-park instead of pure spinning.
4690 // *  Use Taura-Oyama-Yonenzawa locks.
4691 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4692 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4693 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4694 //    acquiring threads use timers (ParkTimed) to detect and recover from
4695 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4696 //    boundaries by using placement-new.
4697 // *  Augment MCS with advisory back-link fields maintained with CAS().
4698 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4699 //    The validity of the backlinks must be ratified before we trust the value.
4700 //    If the backlinks are invalid the exiting thread must back-track through the
4701 //    the forward links, which are always trustworthy.
4702 // *  Add a successor indication.  The LockWord is currently encoded as
4703 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4704 //    to provide the usual futile-wakeup optimization.
4705 //    See RTStt for details.
4706 // *  Consider schedctl.sc_nopreempt to cover the critical section.
4707 //
4708 
4709 
4710 typedef volatile intptr_t MutexT;      // Mux Lock-word
4711 enum MuxBits { LOCKBIT = 1 };
4712 
4713 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4714   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4715   if (w == 0) return;
4716   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4717     return;
4718   }
4719 
4720   TEVENT(muxAcquire - Contention);
4721   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4722   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4723   for (;;) {
4724     int its = (os::is_MP() ? 100 : 0) + 1;
4725 
4726     // Optional spin phase: spin-then-park strategy
4727     while (--its &gt;= 0) {
4728       w = *Lock;
4729       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4730         return;
4731       }
4732     }
4733 
4734     Self-&gt;reset();
4735     Self-&gt;OnList = intptr_t(Lock);
4736     // The following fence() isn't _strictly necessary as the subsequent
4737     // CAS() both serializes execution and ratifies the fetched *Lock value.
4738     OrderAccess::fence();
4739     for (;;) {
4740       w = *Lock;
4741       if ((w &amp; LOCKBIT) == 0) {
4742         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4743           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4744           return;
4745         }
4746         continue;      // Interference -- *Lock changed -- Just retry
4747       }
4748       assert(w &amp; LOCKBIT, "invariant");
4749       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4750       if (Atomic::cmpxchg_ptr(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4751     }
4752 
4753     while (Self-&gt;OnList != 0) {
4754       Self-&gt;park();
4755     }
4756   }
4757 }
4758 
4759 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4760   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4761   if (w == 0) return;
4762   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4763     return;
4764   }
4765 
4766   TEVENT(muxAcquire - Contention);
4767   ParkEvent * ReleaseAfter = NULL;
4768   if (ev == NULL) {
4769     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4770   }
4771   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4772   for (;;) {
4773     guarantee(ev-&gt;OnList == 0, "invariant");
4774     int its = (os::is_MP() ? 100 : 0) + 1;
4775 
4776     // Optional spin phase: spin-then-park strategy
4777     while (--its &gt;= 0) {
4778       w = *Lock;
4779       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4780         if (ReleaseAfter != NULL) {
4781           ParkEvent::Release(ReleaseAfter);
4782         }
4783         return;
4784       }
4785     }
4786 
4787     ev-&gt;reset();
4788     ev-&gt;OnList = intptr_t(Lock);
4789     // The following fence() isn't _strictly necessary as the subsequent
4790     // CAS() both serializes execution and ratifies the fetched *Lock value.
4791     OrderAccess::fence();
4792     for (;;) {
4793       w = *Lock;
4794       if ((w &amp; LOCKBIT) == 0) {
4795         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4796           ev-&gt;OnList = 0;
4797           // We call ::Release while holding the outer lock, thus
4798           // artificially lengthening the critical section.
4799           // Consider deferring the ::Release() until the subsequent unlock(),
4800           // after we've dropped the outer lock.
4801           if (ReleaseAfter != NULL) {
4802             ParkEvent::Release(ReleaseAfter);
4803           }
4804           return;
4805         }
4806         continue;      // Interference -- *Lock changed -- Just retry
4807       }
4808       assert(w &amp; LOCKBIT, "invariant");
4809       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4810       if (Atomic::cmpxchg_ptr(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4811     }
4812 
4813     while (ev-&gt;OnList != 0) {
4814       ev-&gt;park();
4815     }
4816   }
4817 }
4818 
4819 // Release() must extract a successor from the list and then wake that thread.
4820 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4821 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4822 // Release() would :
4823 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4824 // (B) Extract a successor from the private list "in-hand"
4825 // (C) attempt to CAS() the residual back into *Lock over null.
4826 //     If there were any newly arrived threads and the CAS() would fail.
4827 //     In that case Release() would detach the RATs, re-merge the list in-hand
4828 //     with the RATs and repeat as needed.  Alternately, Release() might
4829 //     detach and extract a successor, but then pass the residual list to the wakee.
4830 //     The wakee would be responsible for reattaching and remerging before it
4831 //     competed for the lock.
4832 //
4833 // Both "pop" and DMR are immune from ABA corruption -- there can be
4834 // multiple concurrent pushers, but only one popper or detacher.
4835 // This implementation pops from the head of the list.  This is unfair,
4836 // but tends to provide excellent throughput as hot threads remain hot.
4837 // (We wake recently run threads first).
4838 //
4839 // All paths through muxRelease() will execute a CAS.
4840 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4841 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4842 // executed within the critical section are complete and globally visible before the
4843 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4844 void Thread::muxRelease(volatile intptr_t * Lock)  {
4845   for (;;) {
4846     const intptr_t w = Atomic::cmpxchg_ptr(0, Lock, LOCKBIT);
4847     assert(w &amp; LOCKBIT, "invariant");
4848     if (w == LOCKBIT) return;
4849     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4850     assert(List != NULL, "invariant");
4851     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4852     ParkEvent * const nxt = List-&gt;ListNext;
4853     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4854 
4855     // The following CAS() releases the lock and pops the head element.
4856     // The CAS() also ratifies the previously fetched lock-word value.
4857     if (Atomic::cmpxchg_ptr (intptr_t(nxt), Lock, w) != w) {
4858       continue;
4859     }
4860     List-&gt;OnList = 0;
4861     OrderAccess::fence();
4862     List-&gt;unpark();
4863     return;
4864   }
4865 }
4866 
4867 
4868 void Threads::verify() {
4869   ALL_JAVA_THREADS(p) {
4870     p-&gt;verify();
4871   }
4872   VMThread* thread = VMThread::vm_thread();
4873   if (thread != NULL) thread-&gt;verify();
4874 }
</pre></body></html>
