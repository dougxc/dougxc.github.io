<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2015, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaClasses.hpp"
  28 #include "classfile/systemDictionary.hpp"
  29 #include "classfile/vmSymbols.hpp"
  30 #include "code/codeCache.hpp"
  31 #include "code/codeCacheExtensions.hpp"
  32 #include "code/scopeDesc.hpp"
  33 #include "compiler/compileBroker.hpp"
  34 #include "gc/shared/gcId.hpp"
  35 #include "gc/shared/gcLocker.inline.hpp"
  36 #include "gc/shared/workgroup.hpp"
  37 #include "interpreter/interpreter.hpp"
  38 #include "interpreter/linkResolver.hpp"
  39 #include "interpreter/oopMapCache.hpp"
  40 #include "jvmtifiles/jvmtiEnv.hpp"
  41 #include "logging/logConfiguration.hpp"
  42 #include "memory/metaspaceShared.hpp"
  43 #include "memory/oopFactory.hpp"
  44 #include "memory/universe.inline.hpp"
  45 #include "oops/instanceKlass.hpp"
  46 #include "oops/objArrayOop.hpp"
  47 #include "oops/oop.inline.hpp"
  48 #include "oops/symbol.hpp"
  49 #include "oops/verifyOopClosure.hpp"
  50 #include "prims/jvm_misc.hpp"
  51 #include "prims/jvmtiExport.hpp"
  52 #include "prims/jvmtiThreadState.hpp"
  53 #include "prims/privilegedStack.hpp"
  54 #include "runtime/arguments.hpp"
  55 #include "runtime/atomic.inline.hpp"
  56 #include "runtime/biasedLocking.hpp"
  57 #include "runtime/commandLineFlagConstraintList.hpp"
  58 #include "runtime/commandLineFlagRangeList.hpp"
  59 #include "runtime/deoptimization.hpp"
  60 #include "runtime/fprofiler.hpp"
  61 #include "runtime/frame.inline.hpp"
  62 #include "runtime/globals.hpp"
  63 #include "runtime/init.hpp"
  64 #include "runtime/interfaceSupport.hpp"
  65 #include "runtime/java.hpp"
  66 #include "runtime/javaCalls.hpp"
  67 #include "runtime/jniPeriodicChecker.hpp"
  68 #include "runtime/memprofiler.hpp"
  69 #include "runtime/mutexLocker.hpp"
  70 #include "runtime/objectMonitor.hpp"
  71 #include "runtime/orderAccess.inline.hpp"
  72 #include "runtime/osThread.hpp"
  73 #include "runtime/safepoint.hpp"
  74 #include "runtime/sharedRuntime.hpp"
  75 #include "runtime/statSampler.hpp"
  76 #include "runtime/stubRoutines.hpp"
  77 #include "runtime/sweeper.hpp"
  78 #include "runtime/task.hpp"
  79 #include "runtime/thread.inline.hpp"
  80 #include "runtime/threadCritical.hpp"
  81 #include "runtime/vframe.hpp"
  82 #include "runtime/vframeArray.hpp"
  83 #include "runtime/vframe_hp.hpp"
  84 #include "runtime/vmThread.hpp"
  85 #include "runtime/vm_operations.hpp"
  86 #include "runtime/vm_version.hpp"
  87 #include "services/attachListener.hpp"
  88 #include "services/management.hpp"
  89 #include "services/memTracker.hpp"
  90 #include "services/threadService.hpp"
  91 #include "trace/traceMacros.hpp"
  92 #include "trace/tracing.hpp"
  93 #include "utilities/defaultStream.hpp"
  94 #include "utilities/dtrace.hpp"
  95 #include "utilities/events.hpp"
  96 #include "utilities/macros.hpp"
  97 #include "utilities/preserveException.hpp"
  98 #if INCLUDE_ALL_GCS
  99 #include "gc/cms/concurrentMarkSweepThread.hpp"
 100 #include "gc/g1/concurrentMarkThread.inline.hpp"
 101 #include "gc/parallel/pcTasks.hpp"
 102 #endif // INCLUDE_ALL_GCS
 103 #if INCLUDE_JVMCI
 104 #include "jvmci/jvmciCompiler.hpp"
 105 #include "jvmci/jvmciRuntime.hpp"
 106 #endif
 107 #ifdef COMPILER1
 108 #include "c1/c1_Compiler.hpp"
 109 #endif
 110 #ifdef COMPILER2
 111 #include "opto/c2compiler.hpp"
 112 #include "opto/idealGraphPrinter.hpp"
 113 #endif
 114 #if INCLUDE_RTM_OPT
 115 #include "runtime/rtmLocking.hpp"
 116 #endif
 117 
 118 #ifdef DTRACE_ENABLED
 119 
 120 // Only bother with this argument setup if dtrace is available
 121 
 122   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 123   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 124 
 125   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 126     {                                                                      \
 127       ResourceMark rm(this);                                               \
 128       int len = 0;                                                         \
 129       const char* name = (javathread)-&gt;get_thread_name();                  \
 130       len = strlen(name);                                                  \
 131       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 132         (char *) name, len,                                                \
 133         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 134         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 135         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 136     }
 137 
 138 #else //  ndef DTRACE_ENABLED
 139 
 140   #define DTRACE_THREAD_PROBE(probe, javathread)
 141 
 142 #endif // ndef DTRACE_ENABLED
 143 
 144 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 145 // Current thread is maintained as a thread-local variable
 146 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 147 #endif
 148 
 149 // Class hierarchy
 150 // - Thread
 151 //   - VMThread
 152 //   - WatcherThread
 153 //   - ConcurrentMarkSweepThread
 154 //   - JavaThread
 155 //     - CompilerThread
 156 
 157 // ======= Thread ========
 158 // Support for forcing alignment of thread objects for biased locking
 159 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 160   if (UseBiasedLocking) {
 161     const int alignment = markOopDesc::biased_lock_alignment;
 162     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 163     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 164                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 165                                                          AllocFailStrategy::RETURN_NULL);
 166     void* aligned_addr     = (void*) align_size_up((intptr_t) real_malloc_addr, alignment);
 167     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 168            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 169            "JavaThread alignment code overflowed allocated storage");
 170     if (TraceBiasedLocking) {
 171       if (aligned_addr != real_malloc_addr) {
 172         tty-&gt;print_cr("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 173                       p2i(real_malloc_addr), p2i(aligned_addr));
 174       }
 175     }
 176     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 177     return aligned_addr;
 178   } else {
 179     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 180                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 181   }
 182 }
 183 
 184 void Thread::operator delete(void* p) {
 185   if (UseBiasedLocking) {
 186     void* real_malloc_addr = ((Thread*) p)-&gt;_real_malloc_address;
 187     FreeHeap(real_malloc_addr);
 188   } else {
 189     FreeHeap(p);
 190   }
 191 }
 192 
 193 
 194 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 195 // JavaThread
 196 
 197 
 198 Thread::Thread() {
 199   // stack and get_thread
 200   set_stack_base(NULL);
 201   set_stack_size(0);
 202   set_self_raw_id(0);
 203   set_lgrp_id(-1);
 204   DEBUG_ONLY(clear_suspendible_thread();)
 205 
 206   // allocated data structures
 207   set_osthread(NULL);
 208   set_resource_area(new (mtThread)ResourceArea());
 209   DEBUG_ONLY(_current_resource_mark = NULL;)
 210   set_handle_area(new (mtThread) HandleArea(NULL));
 211   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 212   set_active_handles(NULL);
 213   set_free_handle_block(NULL);
 214   set_last_handle_mark(NULL);
 215 
 216   // This initial value ==&gt; never claimed.
 217   _oops_do_parity = 0;
 218 
 219   // the handle mark links itself to last_handle_mark
 220   new HandleMark(this);
 221 
 222   // plain initialization
 223   debug_only(_owned_locks = NULL;)
 224   debug_only(_allow_allocation_count = 0;)
 225   NOT_PRODUCT(_allow_safepoint_count = 0;)
 226   NOT_PRODUCT(_skip_gcalot = false;)
 227   _jvmti_env_iteration_count = 0;
 228   set_allocated_bytes(0);
 229   _vm_operation_started_count = 0;
 230   _vm_operation_completed_count = 0;
 231   _current_pending_monitor = NULL;
 232   _current_pending_monitor_is_from_java = true;
 233   _current_waiting_monitor = NULL;
 234   _num_nested_signal = 0;
 235   omFreeList = NULL;
 236   omFreeCount = 0;
 237   omFreeProvision = 32;
 238   omInUseList = NULL;
 239   omInUseCount = 0;
 240 
 241 #ifdef ASSERT
 242   _visited_for_critical_count = false;
 243 #endif
 244 
 245   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 246                          Monitor::_safepoint_check_sometimes);
 247   _suspend_flags = 0;
 248 
 249   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 250   _hashStateX = os::random();
 251   _hashStateY = 842502087;
 252   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 253   _hashStateW = 273326509;
 254 
 255   _OnTrap   = 0;
 256   _schedctl = NULL;
 257   _Stalled  = 0;
 258   _TypeTag  = 0x2BAD;
 259 
 260   // Many of the following fields are effectively final - immutable
 261   // Note that nascent threads can't use the Native Monitor-Mutex
 262   // construct until the _MutexEvent is initialized ...
 263   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 264   // we might instead use a stack of ParkEvents that we could provision on-demand.
 265   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 266   // and ::Release()
 267   _ParkEvent   = ParkEvent::Allocate(this);
 268   _SleepEvent  = ParkEvent::Allocate(this);
 269   _MutexEvent  = ParkEvent::Allocate(this);
 270   _MuxEvent    = ParkEvent::Allocate(this);
 271 
 272 #ifdef CHECK_UNHANDLED_OOPS
 273   if (CheckUnhandledOops) {
 274     _unhandled_oops = new UnhandledOops(this);
 275   }
 276 #endif // CHECK_UNHANDLED_OOPS
 277 #ifdef ASSERT
 278   if (UseBiasedLocking) {
 279     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 280     assert(this == _real_malloc_address ||
 281            this == (void*) align_size_up((intptr_t) _real_malloc_address, markOopDesc::biased_lock_alignment),
 282            "bug in forced alignment of thread objects");
 283   }
 284 #endif // ASSERT
 285 }
 286 
 287 void Thread::initialize_thread_current() {
 288 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 289   assert(_thr_current == NULL, "Thread::current already initialized");
 290   _thr_current = this;
 291 #endif
 292   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 293   ThreadLocalStorage::set_thread(this);
 294   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 295 }
 296 
 297 void Thread::clear_thread_current() {
 298   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 299 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 300   _thr_current = NULL;
 301 #endif
 302   ThreadLocalStorage::set_thread(NULL);
 303 }
 304 
 305 void Thread::record_stack_base_and_size() {
 306   set_stack_base(os::current_stack_base());
 307   set_stack_size(os::current_stack_size());
 308   if (is_Java_thread()) {
 309     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 310     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 311   }
 312   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 313   // in initialize_thread(). Without the adjustment, stack size is
 314   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 315   // So far, only Solaris has real implementation of initialize_thread().
 316   //
 317   // set up any platform-specific state.
 318   os::initialize_thread(this);
 319 
 320 #if INCLUDE_NMT
 321   // record thread's native stack, stack grows downward
 322   address stack_low_addr = stack_base() - stack_size();
 323   MemTracker::record_thread_stack(stack_low_addr, stack_size());
 324 #endif // INCLUDE_NMT
 325 }
 326 
 327 
 328 Thread::~Thread() {
 329   // Reclaim the objectmonitors from the omFreeList of the moribund thread.
 330   ObjectSynchronizer::omFlush(this);
 331 
 332   EVENT_THREAD_DESTRUCT(this);
 333 
 334   // stack_base can be NULL if the thread is never started or exited before
 335   // record_stack_base_and_size called. Although, we would like to ensure
 336   // that all started threads do call record_stack_base_and_size(), there is
 337   // not proper way to enforce that.
 338 #if INCLUDE_NMT
 339   if (_stack_base != NULL) {
 340     address low_stack_addr = stack_base() - stack_size();
 341     MemTracker::release_thread_stack(low_stack_addr, stack_size());
 342 #ifdef ASSERT
 343     set_stack_base(NULL);
 344 #endif
 345   }
 346 #endif // INCLUDE_NMT
 347 
 348   // deallocate data structures
 349   delete resource_area();
 350   // since the handle marks are using the handle area, we have to deallocated the root
 351   // handle mark before deallocating the thread's handle area,
 352   assert(last_handle_mark() != NULL, "check we have an element");
 353   delete last_handle_mark();
 354   assert(last_handle_mark() == NULL, "check we have reached the end");
 355 
 356   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 357   // We NULL out the fields for good hygiene.
 358   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 359   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 360   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 361   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 362 
 363   delete handle_area();
 364   delete metadata_handles();
 365 
 366   // osthread() can be NULL, if creation of thread failed.
 367   if (osthread() != NULL) os::free_thread(osthread());
 368 
 369   delete _SR_lock;
 370 
 371   // clear Thread::current if thread is deleting itself.
 372   // Needed to ensure JNI correctly detects non-attached threads.
 373   if (this == Thread::current()) {
 374     clear_thread_current();
 375   }
 376 
 377   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 378 }
 379 
 380 // NOTE: dummy function for assertion purpose.
 381 void Thread::run() {
 382   ShouldNotReachHere();
 383 }
 384 
 385 #ifdef ASSERT
 386 // Private method to check for dangling thread pointer
 387 void check_for_dangling_thread_pointer(Thread *thread) {
 388   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread || Threads_lock-&gt;owned_by_self(),
 389          "possibility of dangling Thread pointer");
 390 }
 391 #endif
 392 
 393 ThreadPriority Thread::get_priority(const Thread* const thread) {
 394   ThreadPriority priority;
 395   // Can return an error!
 396   (void)os::get_priority(thread, priority);
 397   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 398   return priority;
 399 }
 400 
 401 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 402   debug_only(check_for_dangling_thread_pointer(thread);)
 403   // Can return an error!
 404   (void)os::set_priority(thread, priority);
 405 }
 406 
 407 
 408 void Thread::start(Thread* thread) {
 409   // Start is different from resume in that its safety is guaranteed by context or
 410   // being called from a Java method synchronized on the Thread object.
 411   if (!DisableStartThread) {
 412     if (thread-&gt;is_Java_thread()) {
 413       // Initialize the thread state to RUNNABLE before starting this thread.
 414       // Can not set it after the thread started because we do not know the
 415       // exact thread state at that time. It could be in MONITOR_WAIT or
 416       // in SLEEPING or some other state.
 417       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 418                                           java_lang_Thread::RUNNABLE);
 419     }
 420     os::start_thread(thread);
 421   }
 422 }
 423 
 424 // Enqueue a VM_Operation to do the job for us - sometime later
 425 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 426   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 427   VMThread::execute(vm_stop);
 428 }
 429 
 430 
 431 // Check if an external suspend request has completed (or has been
 432 // cancelled). Returns true if the thread is externally suspended and
 433 // false otherwise.
 434 //
 435 // The bits parameter returns information about the code path through
 436 // the routine. Useful for debugging:
 437 //
 438 // set in is_ext_suspend_completed():
 439 // 0x00000001 - routine was entered
 440 // 0x00000010 - routine return false at end
 441 // 0x00000100 - thread exited (return false)
 442 // 0x00000200 - suspend request cancelled (return false)
 443 // 0x00000400 - thread suspended (return true)
 444 // 0x00001000 - thread is in a suspend equivalent state (return true)
 445 // 0x00002000 - thread is native and walkable (return true)
 446 // 0x00004000 - thread is native_trans and walkable (needed retry)
 447 //
 448 // set in wait_for_ext_suspend_completion():
 449 // 0x00010000 - routine was entered
 450 // 0x00020000 - suspend request cancelled before loop (return false)
 451 // 0x00040000 - thread suspended before loop (return true)
 452 // 0x00080000 - suspend request cancelled in loop (return false)
 453 // 0x00100000 - thread suspended in loop (return true)
 454 // 0x00200000 - suspend not completed during retry loop (return false)
 455 
 456 // Helper class for tracing suspend wait debug bits.
 457 //
 458 // 0x00000100 indicates that the target thread exited before it could
 459 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 460 // 0x00080000 each indicate a cancelled suspend request so they don't
 461 // count as wait failures either.
 462 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 463 
 464 class TraceSuspendDebugBits : public StackObj {
 465  private:
 466   JavaThread * jt;
 467   bool         is_wait;
 468   bool         called_by_wait;  // meaningful when !is_wait
 469   uint32_t *   bits;
 470 
 471  public:
 472   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 473                         uint32_t *_bits) {
 474     jt             = _jt;
 475     is_wait        = _is_wait;
 476     called_by_wait = _called_by_wait;
 477     bits           = _bits;
 478   }
 479 
 480   ~TraceSuspendDebugBits() {
 481     if (!is_wait) {
 482 #if 1
 483       // By default, don't trace bits for is_ext_suspend_completed() calls.
 484       // That trace is very chatty.
 485       return;
 486 #else
 487       if (!called_by_wait) {
 488         // If tracing for is_ext_suspend_completed() is enabled, then only
 489         // trace calls to it from wait_for_ext_suspend_completion()
 490         return;
 491       }
 492 #endif
 493     }
 494 
 495     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 496       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 497         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 498         ResourceMark rm;
 499 
 500         tty-&gt;print_cr(
 501                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 502                       jt-&gt;get_thread_name(), *bits);
 503 
 504         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 505       }
 506     }
 507   }
 508 };
 509 #undef DEBUG_FALSE_BITS
 510 
 511 
 512 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 513                                           uint32_t *bits) {
 514   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 515 
 516   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 517   bool do_trans_retry;           // flag to force the retry
 518 
 519   *bits |= 0x00000001;
 520 
 521   do {
 522     do_trans_retry = false;
 523 
 524     if (is_exiting()) {
 525       // Thread is in the process of exiting. This is always checked
 526       // first to reduce the risk of dereferencing a freed JavaThread.
 527       *bits |= 0x00000100;
 528       return false;
 529     }
 530 
 531     if (!is_external_suspend()) {
 532       // Suspend request is cancelled. This is always checked before
 533       // is_ext_suspended() to reduce the risk of a rogue resume
 534       // confusing the thread that made the suspend request.
 535       *bits |= 0x00000200;
 536       return false;
 537     }
 538 
 539     if (is_ext_suspended()) {
 540       // thread is suspended
 541       *bits |= 0x00000400;
 542       return true;
 543     }
 544 
 545     // Now that we no longer do hard suspends of threads running
 546     // native code, the target thread can be changing thread state
 547     // while we are in this routine:
 548     //
 549     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 550     //
 551     // We save a copy of the thread state as observed at this moment
 552     // and make our decision about suspend completeness based on the
 553     // copy. This closes the race where the thread state is seen as
 554     // _thread_in_native_trans in the if-thread_blocked check, but is
 555     // seen as _thread_blocked in if-thread_in_native_trans check.
 556     JavaThreadState save_state = thread_state();
 557 
 558     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 559       // If the thread's state is _thread_blocked and this blocking
 560       // condition is known to be equivalent to a suspend, then we can
 561       // consider the thread to be externally suspended. This means that
 562       // the code that sets _thread_blocked has been modified to do
 563       // self-suspension if the blocking condition releases. We also
 564       // used to check for CONDVAR_WAIT here, but that is now covered by
 565       // the _thread_blocked with self-suspension check.
 566       //
 567       // Return true since we wouldn't be here unless there was still an
 568       // external suspend request.
 569       *bits |= 0x00001000;
 570       return true;
 571     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 572       // Threads running native code will self-suspend on native==&gt;VM/Java
 573       // transitions. If its stack is walkable (should always be the case
 574       // unless this function is called before the actual java_suspend()
 575       // call), then the wait is done.
 576       *bits |= 0x00002000;
 577       return true;
 578     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 579                save_state == _thread_in_native_trans &amp;&amp;
 580                frame_anchor()-&gt;walkable()) {
 581       // The thread is transitioning from thread_in_native to another
 582       // thread state. check_safepoint_and_suspend_for_native_trans()
 583       // will force the thread to self-suspend. If it hasn't gotten
 584       // there yet we may have caught the thread in-between the native
 585       // code check above and the self-suspend. Lucky us. If we were
 586       // called by wait_for_ext_suspend_completion(), then it
 587       // will be doing the retries so we don't have to.
 588       //
 589       // Since we use the saved thread state in the if-statement above,
 590       // there is a chance that the thread has already transitioned to
 591       // _thread_blocked by the time we get here. In that case, we will
 592       // make a single unnecessary pass through the logic below. This
 593       // doesn't hurt anything since we still do the trans retry.
 594 
 595       *bits |= 0x00004000;
 596 
 597       // Once the thread leaves thread_in_native_trans for another
 598       // thread state, we break out of this retry loop. We shouldn't
 599       // need this flag to prevent us from getting back here, but
 600       // sometimes paranoia is good.
 601       did_trans_retry = true;
 602 
 603       // We wait for the thread to transition to a more usable state.
 604       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 605         // We used to do an "os::yield_all(i)" call here with the intention
 606         // that yielding would increase on each retry. However, the parameter
 607         // is ignored on Linux which means the yield didn't scale up. Waiting
 608         // on the SR_lock below provides a much more predictable scale up for
 609         // the delay. It also provides a simple/direct point to check for any
 610         // safepoint requests from the VMThread
 611 
 612         // temporarily drops SR_lock while doing wait with safepoint check
 613         // (if we're a JavaThread - the WatcherThread can also call this)
 614         // and increase delay with each retry
 615         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 616 
 617         // check the actual thread state instead of what we saved above
 618         if (thread_state() != _thread_in_native_trans) {
 619           // the thread has transitioned to another thread state so
 620           // try all the checks (except this one) one more time.
 621           do_trans_retry = true;
 622           break;
 623         }
 624       } // end retry loop
 625 
 626 
 627     }
 628   } while (do_trans_retry);
 629 
 630   *bits |= 0x00000010;
 631   return false;
 632 }
 633 
 634 // Wait for an external suspend request to complete (or be cancelled).
 635 // Returns true if the thread is externally suspended and false otherwise.
 636 //
 637 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 638                                                  uint32_t *bits) {
 639   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 640                              false /* !called_by_wait */, bits);
 641 
 642   // local flag copies to minimize SR_lock hold time
 643   bool is_suspended;
 644   bool pending;
 645   uint32_t reset_bits;
 646 
 647   // set a marker so is_ext_suspend_completed() knows we are the caller
 648   *bits |= 0x00010000;
 649 
 650   // We use reset_bits to reinitialize the bits value at the top of
 651   // each retry loop. This allows the caller to make use of any
 652   // unused bits for their own marking purposes.
 653   reset_bits = *bits;
 654 
 655   {
 656     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 657     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 658                                             delay, bits);
 659     pending = is_external_suspend();
 660   }
 661   // must release SR_lock to allow suspension to complete
 662 
 663   if (!pending) {
 664     // A cancelled suspend request is the only false return from
 665     // is_ext_suspend_completed() that keeps us from entering the
 666     // retry loop.
 667     *bits |= 0x00020000;
 668     return false;
 669   }
 670 
 671   if (is_suspended) {
 672     *bits |= 0x00040000;
 673     return true;
 674   }
 675 
 676   for (int i = 1; i &lt;= retries; i++) {
 677     *bits = reset_bits;  // reinit to only track last retry
 678 
 679     // We used to do an "os::yield_all(i)" call here with the intention
 680     // that yielding would increase on each retry. However, the parameter
 681     // is ignored on Linux which means the yield didn't scale up. Waiting
 682     // on the SR_lock below provides a much more predictable scale up for
 683     // the delay. It also provides a simple/direct point to check for any
 684     // safepoint requests from the VMThread
 685 
 686     {
 687       MutexLocker ml(SR_lock());
 688       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 689       // can also call this)  and increase delay with each retry
 690       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 691 
 692       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 693                                               delay, bits);
 694 
 695       // It is possible for the external suspend request to be cancelled
 696       // (by a resume) before the actual suspend operation is completed.
 697       // Refresh our local copy to see if we still need to wait.
 698       pending = is_external_suspend();
 699     }
 700 
 701     if (!pending) {
 702       // A cancelled suspend request is the only false return from
 703       // is_ext_suspend_completed() that keeps us from staying in the
 704       // retry loop.
 705       *bits |= 0x00080000;
 706       return false;
 707     }
 708 
 709     if (is_suspended) {
 710       *bits |= 0x00100000;
 711       return true;
 712     }
 713   } // end retry loop
 714 
 715   // thread did not suspend after all our retries
 716   *bits |= 0x00200000;
 717   return false;
 718 }
 719 
 720 #ifndef PRODUCT
 721 void JavaThread::record_jump(address target, address instr, const char* file,
 722                              int line) {
 723 
 724   // This should not need to be atomic as the only way for simultaneous
 725   // updates is via interrupts. Even then this should be rare or non-existent
 726   // and we don't care that much anyway.
 727 
 728   int index = _jmp_ring_index;
 729   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 730   _jmp_ring[index]._target = (intptr_t) target;
 731   _jmp_ring[index]._instruction = (intptr_t) instr;
 732   _jmp_ring[index]._file = file;
 733   _jmp_ring[index]._line = line;
 734 }
 735 #endif // PRODUCT
 736 
 737 // Called by flat profiler
 738 // Callers have already called wait_for_ext_suspend_completion
 739 // The assertion for that is currently too complex to put here:
 740 bool JavaThread::profile_last_Java_frame(frame* _fr) {
 741   bool gotframe = false;
 742   // self suspension saves needed state.
 743   if (has_last_Java_frame() &amp;&amp; _anchor.walkable()) {
 744     *_fr = pd_last_frame();
 745     gotframe = true;
 746   }
 747   return gotframe;
 748 }
 749 
 750 void Thread::interrupt(Thread* thread) {
 751   debug_only(check_for_dangling_thread_pointer(thread);)
 752   os::interrupt(thread);
 753 }
 754 
 755 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 756   debug_only(check_for_dangling_thread_pointer(thread);)
 757   // Note:  If clear_interrupted==false, this simply fetches and
 758   // returns the value of the field osthread()-&gt;interrupted().
 759   return os::is_interrupted(thread, clear_interrupted);
 760 }
 761 
 762 
 763 // GC Support
 764 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 765   jint thread_parity = _oops_do_parity;
 766   if (thread_parity != strong_roots_parity) {
 767     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 768     if (res == thread_parity) {
 769       return true;
 770     } else {
 771       guarantee(res == strong_roots_parity, "Or else what?");
 772       return false;
 773     }
 774   }
 775   return false;
 776 }
 777 
 778 void Thread::oops_do(OopClosure* f, CLDClosure* cld_f, CodeBlobClosure* cf) {
 779   active_handles()-&gt;oops_do(f);
 780   // Do oop for ThreadShadow
 781   f-&gt;do_oop((oop*)&amp;_pending_exception);
 782   handle_area()-&gt;oops_do(f);
 783 }
 784 
 785 void Thread::nmethods_do(CodeBlobClosure* cf) {
 786   // no nmethods in a generic thread...
 787 }
 788 
 789 void Thread::metadata_handles_do(void f(Metadata*)) {
 790   // Only walk the Handles in Thread.
 791   if (metadata_handles() != NULL) {
 792     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 793       f(metadata_handles()-&gt;at(i));
 794     }
 795   }
 796 }
 797 
 798 void Thread::print_on(outputStream* st) const {
 799   // get_priority assumes osthread initialized
 800   if (osthread() != NULL) {
 801     int os_prio;
 802     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 803       st-&gt;print("os_prio=%d ", os_prio);
 804     }
 805     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 806     ext().print_on(st);
 807     osthread()-&gt;print_on(st);
 808   }
 809   debug_only(if (WizardMode) print_owned_locks_on(st);)
 810 }
 811 
 812 // Thread::print_on_error() is called by fatal error handler. Don't use
 813 // any lock or allocate memory.
 814 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 815   if (is_VM_thread())                 st-&gt;print("VMThread");
 816   else if (is_Compiler_thread())      st-&gt;print("CompilerThread");
 817   else if (is_Java_thread())          st-&gt;print("JavaThread");
 818   else if (is_GC_task_thread())       st-&gt;print("GCTaskThread");
 819   else if (is_Watcher_thread())       st-&gt;print("WatcherThread");
 820   else if (is_ConcurrentGC_thread())  st-&gt;print("ConcurrentGCThread");
 821   else                                st-&gt;print("Thread");
 822 
 823   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 824             p2i(_stack_base - _stack_size), p2i(_stack_base));
 825 
 826   if (osthread()) {
 827     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 828   }
 829 }
 830 
 831 #ifdef ASSERT
 832 void Thread::print_owned_locks_on(outputStream* st) const {
 833   Monitor *cur = _owned_locks;
 834   if (cur == NULL) {
 835     st-&gt;print(" (no locks) ");
 836   } else {
 837     st-&gt;print_cr(" Locks owned:");
 838     while (cur) {
 839       cur-&gt;print_on(st);
 840       cur = cur-&gt;next();
 841     }
 842   }
 843 }
 844 
 845 static int ref_use_count  = 0;
 846 
 847 bool Thread::owns_locks_but_compiled_lock() const {
 848   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 849     if (cur != Compile_lock) return true;
 850   }
 851   return false;
 852 }
 853 
 854 
 855 #endif
 856 
 857 #ifndef PRODUCT
 858 
 859 // The flag: potential_vm_operation notifies if this particular safepoint state could potential
 860 // invoke the vm-thread (i.e., and oop allocation). In that case, we also have to make sure that
 861 // no threads which allow_vm_block's are held
 862 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 863   // Check if current thread is allowed to block at a safepoint
 864   if (!(_allow_safepoint_count == 0)) {
 865     fatal("Possible safepoint reached by thread that does not allow it");
 866   }
 867   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 868     fatal("LEAF method calling lock?");
 869   }
 870 
 871 #ifdef ASSERT
 872   if (potential_vm_operation &amp;&amp; is_Java_thread()
 873       &amp;&amp; !Universe::is_bootstrapping()) {
 874     // Make sure we do not hold any locks that the VM thread also uses.
 875     // This could potentially lead to deadlocks
 876     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 877       // Threads_lock is special, since the safepoint synchronization will not start before this is
 878       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 879       // since it is used to transfer control between JavaThreads and the VMThread
 880       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 881       if ((cur-&gt;allow_vm_block() &amp;&amp;
 882            cur != Threads_lock &amp;&amp;
 883            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 884            cur != VMOperationRequest_lock &amp;&amp;
 885            cur != VMOperationQueue_lock) ||
 886            cur-&gt;rank() == Mutex::special) {
 887         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 888       }
 889     }
 890   }
 891 
 892   if (GCALotAtAllSafepoints) {
 893     // We could enter a safepoint here and thus have a gc
 894     InterfaceSupport::check_gc_alot();
 895   }
 896 #endif
 897 }
 898 #endif
 899 
 900 bool Thread::is_in_stack(address adr) const {
 901   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
 902   address end = os::current_stack_pointer();
 903   // Allow non Java threads to call this without stack_base
 904   if (_stack_base == NULL) return true;
 905   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
 906 
 907   return false;
 908 }
 909 
 910 
 911 bool Thread::is_in_usable_stack(address adr) const {
 912   size_t stack_guard_size = os::uses_stack_guard_pages() ? (StackReservedPages + StackYellowPages + StackRedPages) * os::vm_page_size() : 0;
 913   size_t usable_stack_size = _stack_size - stack_guard_size;
 914 
 915   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
 916 }
 917 
 918 
 919 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
 920 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
 921 // used for compilation in the future. If that change is made, the need for these methods
 922 // should be revisited, and they should be removed if possible.
 923 
 924 bool Thread::is_lock_owned(address adr) const {
 925   return on_local_stack(adr);
 926 }
 927 
 928 bool Thread::set_as_starting_thread() {
 929   // NOTE: this must be called inside the main thread.
 930   return os::create_main_thread((JavaThread*)this);
 931 }
 932 
 933 static void initialize_class(Symbol* class_name, TRAPS) {
 934   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
 935   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
 936 }
 937 
 938 
 939 // Creates the initial ThreadGroup
 940 static Handle create_initial_thread_group(TRAPS) {
 941   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_ThreadGroup(), true, CHECK_NH);
 942   instanceKlassHandle klass (THREAD, k);
 943 
 944   Handle system_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 945   {
 946     JavaValue result(T_VOID);
 947     JavaCalls::call_special(&amp;result,
 948                             system_instance,
 949                             klass,
 950                             vmSymbols::object_initializer_name(),
 951                             vmSymbols::void_method_signature(),
 952                             CHECK_NH);
 953   }
 954   Universe::set_system_thread_group(system_instance());
 955 
 956   Handle main_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 957   {
 958     JavaValue result(T_VOID);
 959     Handle string = java_lang_String::create_from_str("main", CHECK_NH);
 960     JavaCalls::call_special(&amp;result,
 961                             main_instance,
 962                             klass,
 963                             vmSymbols::object_initializer_name(),
 964                             vmSymbols::threadgroup_string_void_signature(),
 965                             system_instance,
 966                             string,
 967                             CHECK_NH);
 968   }
 969   return main_instance;
 970 }
 971 
 972 // Creates the initial Thread
 973 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
 974                                  TRAPS) {
 975   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_NULL);
 976   instanceKlassHandle klass (THREAD, k);
 977   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_NULL);
 978 
 979   java_lang_Thread::set_thread(thread_oop(), thread);
 980   java_lang_Thread::set_priority(thread_oop(), NormPriority);
 981   thread-&gt;set_threadObj(thread_oop());
 982 
 983   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
 984 
 985   JavaValue result(T_VOID);
 986   JavaCalls::call_special(&amp;result, thread_oop,
 987                           klass,
 988                           vmSymbols::object_initializer_name(),
 989                           vmSymbols::threadgroup_string_void_signature(),
 990                           thread_group,
 991                           string,
 992                           CHECK_NULL);
 993   return thread_oop();
 994 }
 995 
 996 static void call_initializeSystemClass(TRAPS) {
 997   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
 998   instanceKlassHandle klass (THREAD, k);
 999 
1000   JavaValue result(T_VOID);
1001   JavaCalls::call_static(&amp;result, klass, vmSymbols::initializeSystemClass_name(),
1002                          vmSymbols::void_method_signature(), CHECK);
1003 }
1004 
1005 char java_runtime_name[128] = "";
1006 char java_runtime_version[128] = "";
1007 
1008 // extract the JRE name from sun.misc.Version.java_runtime_name
1009 static const char* get_java_runtime_name(TRAPS) {
1010   Klass* k = SystemDictionary::find(vmSymbols::sun_misc_Version(),
1011                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1012   fieldDescriptor fd;
1013   bool found = k != NULL &amp;&amp;
1014                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1015                                                         vmSymbols::string_signature(), &amp;fd);
1016   if (found) {
1017     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1018     if (name_oop == NULL) {
1019       return NULL;
1020     }
1021     const char* name = java_lang_String::as_utf8_string(name_oop,
1022                                                         java_runtime_name,
1023                                                         sizeof(java_runtime_name));
1024     return name;
1025   } else {
1026     return NULL;
1027   }
1028 }
1029 
1030 // extract the JRE version from sun.misc.Version.java_runtime_version
1031 static const char* get_java_runtime_version(TRAPS) {
1032   Klass* k = SystemDictionary::find(vmSymbols::sun_misc_Version(),
1033                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1034   fieldDescriptor fd;
1035   bool found = k != NULL &amp;&amp;
1036                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1037                                                         vmSymbols::string_signature(), &amp;fd);
1038   if (found) {
1039     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1040     if (name_oop == NULL) {
1041       return NULL;
1042     }
1043     const char* name = java_lang_String::as_utf8_string(name_oop,
1044                                                         java_runtime_version,
1045                                                         sizeof(java_runtime_version));
1046     return name;
1047   } else {
1048     return NULL;
1049   }
1050 }
1051 
1052 // General purpose hook into Java code, run once when the VM is initialized.
1053 // The Java library method itself may be changed independently from the VM.
1054 static void call_postVMInitHook(TRAPS) {
1055   Klass* k = SystemDictionary::resolve_or_null(vmSymbols::sun_misc_PostVMInitHook(), THREAD);
1056   instanceKlassHandle klass (THREAD, k);
1057   if (klass.not_null()) {
1058     JavaValue result(T_VOID);
1059     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1060                            vmSymbols::void_method_signature(),
1061                            CHECK);
1062   }
1063 }
1064 
1065 static void reset_vm_info_property(TRAPS) {
1066   // the vm info string
1067   ResourceMark rm(THREAD);
1068   const char *vm_info = VM_Version::vm_info_string();
1069 
1070   // java.lang.System class
1071   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
1072   instanceKlassHandle klass (THREAD, k);
1073 
1074   // setProperty arguments
1075   Handle key_str    = java_lang_String::create_from_str("java.vm.info", CHECK);
1076   Handle value_str  = java_lang_String::create_from_str(vm_info, CHECK);
1077 
1078   // return value
1079   JavaValue r(T_OBJECT);
1080 
1081   // public static String setProperty(String key, String value);
1082   JavaCalls::call_static(&amp;r,
1083                          klass,
1084                          vmSymbols::setProperty_name(),
1085                          vmSymbols::string_string_string_signature(),
1086                          key_str,
1087                          value_str,
1088                          CHECK);
1089 }
1090 
1091 
1092 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1093                                     bool daemon, TRAPS) {
1094   assert(thread_group.not_null(), "thread group should be specified");
1095   assert(threadObj() == NULL, "should only create Java thread object once");
1096 
1097   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK);
1098   instanceKlassHandle klass (THREAD, k);
1099   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK);
1100 
1101   java_lang_Thread::set_thread(thread_oop(), this);
1102   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1103   set_threadObj(thread_oop());
1104 
1105   JavaValue result(T_VOID);
1106   if (thread_name != NULL) {
1107     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1108     // Thread gets assigned specified name and null target
1109     JavaCalls::call_special(&amp;result,
1110                             thread_oop,
1111                             klass,
1112                             vmSymbols::object_initializer_name(),
1113                             vmSymbols::threadgroup_string_void_signature(),
1114                             thread_group, // Argument 1
1115                             name,         // Argument 2
1116                             THREAD);
1117   } else {
1118     // Thread gets assigned name "Thread-nnn" and null target
1119     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1120     JavaCalls::call_special(&amp;result,
1121                             thread_oop,
1122                             klass,
1123                             vmSymbols::object_initializer_name(),
1124                             vmSymbols::threadgroup_runnable_void_signature(),
1125                             thread_group, // Argument 1
1126                             Handle(),     // Argument 2
1127                             THREAD);
1128   }
1129 
1130 
1131   if (daemon) {
1132     java_lang_Thread::set_daemon(thread_oop());
1133   }
1134 
1135   if (HAS_PENDING_EXCEPTION) {
1136     return;
1137   }
1138 
1139   KlassHandle group(THREAD, SystemDictionary::ThreadGroup_klass());
1140   Handle threadObj(THREAD, this-&gt;threadObj());
1141 
1142   JavaCalls::call_special(&amp;result,
1143                           thread_group,
1144                           group,
1145                           vmSymbols::add_method_name(),
1146                           vmSymbols::thread_void_signature(),
1147                           threadObj,          // Arg 1
1148                           THREAD);
1149 }
1150 
1151 // NamedThread --  non-JavaThread subclasses with multiple
1152 // uniquely named instances should derive from this.
1153 NamedThread::NamedThread() : Thread() {
1154   _name = NULL;
1155   _processed_thread = NULL;
1156   _gc_id = GCId::undefined();
1157 }
1158 
1159 NamedThread::~NamedThread() {
1160   if (_name != NULL) {
1161     FREE_C_HEAP_ARRAY(char, _name);
1162     _name = NULL;
1163   }
1164 }
1165 
1166 void NamedThread::set_name(const char* format, ...) {
1167   guarantee(_name == NULL, "Only get to set name once.");
1168   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1169   guarantee(_name != NULL, "alloc failure");
1170   va_list ap;
1171   va_start(ap, format);
1172   jio_vsnprintf(_name, max_name_len, format, ap);
1173   va_end(ap);
1174 }
1175 
1176 void NamedThread::initialize_named_thread() {
1177   set_native_thread_name(name());
1178 }
1179 
1180 void NamedThread::print_on(outputStream* st) const {
1181   st-&gt;print("\"%s\" ", name());
1182   Thread::print_on(st);
1183   st-&gt;cr();
1184 }
1185 
1186 
1187 // ======= WatcherThread ========
1188 
1189 // The watcher thread exists to simulate timer interrupts.  It should
1190 // be replaced by an abstraction over whatever native support for
1191 // timer interrupts exists on the platform.
1192 
1193 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1194 bool WatcherThread::_startable = false;
1195 volatile bool  WatcherThread::_should_terminate = false;
1196 
1197 WatcherThread::WatcherThread() : Thread(), _crash_protection(NULL) {
1198   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1199   if (os::create_thread(this, os::watcher_thread)) {
1200     _watcher_thread = this;
1201 
1202     // Set the watcher thread to the highest OS priority which should not be
1203     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1204     // is created. The only normal thread using this priority is the reference
1205     // handler thread, which runs for very short intervals only.
1206     // If the VMThread's priority is not lower than the WatcherThread profiling
1207     // will be inaccurate.
1208     os::set_priority(this, MaxPriority);
1209     if (!DisableStartThread) {
1210       os::start_thread(this);
1211     }
1212   }
1213 }
1214 
1215 int WatcherThread::sleep() const {
1216   // The WatcherThread does not participate in the safepoint protocol
1217   // for the PeriodicTask_lock because it is not a JavaThread.
1218   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1219 
1220   if (_should_terminate) {
1221     // check for termination before we do any housekeeping or wait
1222     return 0;  // we did not sleep.
1223   }
1224 
1225   // remaining will be zero if there are no tasks,
1226   // causing the WatcherThread to sleep until a task is
1227   // enrolled
1228   int remaining = PeriodicTask::time_to_wait();
1229   int time_slept = 0;
1230 
1231   // we expect this to timeout - we only ever get unparked when
1232   // we should terminate or when a new task has been enrolled
1233   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1234 
1235   jlong time_before_loop = os::javaTimeNanos();
1236 
1237   while (true) {
1238     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1239                                             remaining);
1240     jlong now = os::javaTimeNanos();
1241 
1242     if (remaining == 0) {
1243       // if we didn't have any tasks we could have waited for a long time
1244       // consider the time_slept zero and reset time_before_loop
1245       time_slept = 0;
1246       time_before_loop = now;
1247     } else {
1248       // need to recalculate since we might have new tasks in _tasks
1249       time_slept = (int) ((now - time_before_loop) / 1000000);
1250     }
1251 
1252     // Change to task list or spurious wakeup of some kind
1253     if (timedout || _should_terminate) {
1254       break;
1255     }
1256 
1257     remaining = PeriodicTask::time_to_wait();
1258     if (remaining == 0) {
1259       // Last task was just disenrolled so loop around and wait until
1260       // another task gets enrolled
1261       continue;
1262     }
1263 
1264     remaining -= time_slept;
1265     if (remaining &lt;= 0) {
1266       break;
1267     }
1268   }
1269 
1270   return time_slept;
1271 }
1272 
1273 void WatcherThread::run() {
1274   assert(this == watcher_thread(), "just checking");
1275 
1276   this-&gt;record_stack_base_and_size();
1277   this-&gt;set_native_thread_name(this-&gt;name());
1278   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1279   while (true) {
1280     assert(watcher_thread() == Thread::current(), "thread consistency check");
1281     assert(watcher_thread() == this, "thread consistency check");
1282 
1283     // Calculate how long it'll be until the next PeriodicTask work
1284     // should be done, and sleep that amount of time.
1285     int time_waited = sleep();
1286 
1287     if (is_error_reported()) {
1288       // A fatal error has happened, the error handler(VMError::report_and_die)
1289       // should abort JVM after creating an error log file. However in some
1290       // rare cases, the error handler itself might deadlock. Here we try to
1291       // kill JVM if the fatal error handler fails to abort in 2 minutes.
1292       //
1293       // This code is in WatcherThread because WatcherThread wakes up
1294       // periodically so the fatal error handler doesn't need to do anything;
1295       // also because the WatcherThread is less likely to crash than other
1296       // threads.
1297 
1298       for (;;) {
1299         if (!ShowMessageBoxOnError
1300             &amp;&amp; (OnError == NULL || OnError[0] == '\0')
1301             &amp;&amp; Arguments::abort_hook() == NULL) {
1302           os::sleep(this, (jlong)ErrorLogTimeout * 1000, false); // in seconds
1303           fdStream err(defaultStream::output_fd());
1304           err.print_raw_cr("# [ timer expired, abort... ]");
1305           // skip atexit/vm_exit/vm_abort hooks
1306           os::die();
1307         }
1308 
1309         // Wake up 5 seconds later, the fatal handler may reset OnError or
1310         // ShowMessageBoxOnError when it is ready to abort.
1311         os::sleep(this, 5 * 1000, false);
1312       }
1313     }
1314 
1315     if (_should_terminate) {
1316       // check for termination before posting the next tick
1317       break;
1318     }
1319 
1320     PeriodicTask::real_time_tick(time_waited);
1321   }
1322 
1323   // Signal that it is terminated
1324   {
1325     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1326     _watcher_thread = NULL;
1327     Terminator_lock-&gt;notify();
1328   }
1329 }
1330 
1331 void WatcherThread::start() {
1332   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1333 
1334   if (watcher_thread() == NULL &amp;&amp; _startable) {
1335     _should_terminate = false;
1336     // Create the single instance of WatcherThread
1337     new WatcherThread();
1338   }
1339 }
1340 
1341 void WatcherThread::make_startable() {
1342   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1343   _startable = true;
1344 }
1345 
1346 void WatcherThread::stop() {
1347   {
1348     // Follow normal safepoint aware lock enter protocol since the
1349     // WatcherThread is stopped by another JavaThread.
1350     MutexLocker ml(PeriodicTask_lock);
1351     _should_terminate = true;
1352 
1353     WatcherThread* watcher = watcher_thread();
1354     if (watcher != NULL) {
1355       // unpark the WatcherThread so it can see that it should terminate
1356       watcher-&gt;unpark();
1357     }
1358   }
1359 
1360   MutexLocker mu(Terminator_lock);
1361 
1362   while (watcher_thread() != NULL) {
1363     // This wait should make safepoint checks, wait without a timeout,
1364     // and wait as a suspend-equivalent condition.
1365     //
1366     // Note: If the FlatProfiler is running, then this thread is waiting
1367     // for the WatcherThread to terminate and the WatcherThread, via the
1368     // FlatProfiler task, is waiting for the external suspend request on
1369     // this thread to complete. wait_for_ext_suspend_completion() will
1370     // eventually timeout, but that takes time. Making this wait a
1371     // suspend-equivalent condition solves that timeout problem.
1372     //
1373     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1374                           Mutex::_as_suspend_equivalent_flag);
1375   }
1376 }
1377 
1378 void WatcherThread::unpark() {
1379   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1380   PeriodicTask_lock-&gt;notify();
1381 }
1382 
1383 void WatcherThread::print_on(outputStream* st) const {
1384   st-&gt;print("\"%s\" ", name());
1385   Thread::print_on(st);
1386   st-&gt;cr();
1387 }
1388 
1389 // ======= JavaThread ========
1390 
1391 #if INCLUDE_JVMCI
1392 
1393 jlong* JavaThread::_jvmci_old_thread_counters;
1394 
1395 bool jvmci_counters_include(JavaThread* thread) {
1396   oop threadObj = thread-&gt;threadObj();
1397   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1398 }
1399 
1400 void JavaThread::collect_counters(typeArrayOop array) {
1401   if (JVMCICounterSize &gt; 0) {
1402     MutexLocker tl(Threads_lock);
1403     for (int i = 0; i &lt; array-&gt;length(); i++) {
1404       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1405     }
1406     for (JavaThread* tp = Threads::first(); tp != NULL; tp = tp-&gt;next()) {
1407       if (jvmci_counters_include(tp)) {
1408         for (int i = 0; i &lt; array-&gt;length(); i++) {
1409           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1410         }
1411       }
1412     }
1413   }
1414 }
1415 
1416 #endif // INCLUDE_JVMCI
1417 
1418 // A JavaThread is a normal Java thread
1419 
1420 void JavaThread::initialize() {
1421   // Initialize fields
1422 
1423   // Set the claimed par_id to UINT_MAX (ie not claiming any par_ids)
1424   set_claimed_par_id(UINT_MAX);
1425 
1426   set_saved_exception_pc(NULL);
1427   set_threadObj(NULL);
1428   _anchor.clear();
1429   set_entry_point(NULL);
1430   set_jni_functions(jni_functions());
1431   set_callee_target(NULL);
1432   set_vm_result(NULL);
1433   set_vm_result_2(NULL);
1434   set_vframe_array_head(NULL);
1435   set_vframe_array_last(NULL);
1436   set_deferred_locals(NULL);
1437   set_deopt_mark(NULL);
1438   set_deopt_nmethod(NULL);
1439   clear_must_deopt_id();
1440   set_monitor_chunks(NULL);
1441   set_next(NULL);
1442   set_thread_state(_thread_new);
1443   _terminated = _not_terminated;
1444   _privileged_stack_top = NULL;
1445   _array_for_gc = NULL;
1446   _suspend_equivalent = false;
1447   _in_deopt_handler = 0;
1448   _doing_unsafe_access = false;
1449   _stack_guard_state = stack_guard_unused;
1450 #if INCLUDE_JVMCI
1451   _pending_monitorenter = false;
1452   _pending_deoptimization = -1;
1453   _pending_failed_speculation = NULL;
1454   _pending_transfer_to_interpreter = false;
1455   _jvmci._alternate_call_target = NULL;
1456   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1457   if (JVMCICounterSize &gt; 0) {
1458     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1459     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1460   } else {
1461     _jvmci_counters = NULL;
1462   }
1463 #endif // INCLUDE_JVMCI
1464   _reserved_stack_activation = NULL;  // stack base not known yet
1465   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1466   _exception_pc  = 0;
1467   _exception_handler_pc = 0;
1468   _is_method_handle_return = 0;
1469   _jvmti_thread_state= NULL;
1470   _should_post_on_exceptions_flag = JNI_FALSE;
1471   _jvmti_get_loaded_classes_closure = NULL;
1472   _interp_only_mode    = 0;
1473   _special_runtime_exit_condition = _no_async_condition;
1474   _pending_async_exception = NULL;
1475   _thread_stat = NULL;
1476   _thread_stat = new ThreadStatistics();
1477   _blocked_on_compilation = false;
1478   _jni_active_critical = 0;
1479   _pending_jni_exception_check_fn = NULL;
1480   _do_not_unlock_if_synchronized = false;
1481   _cached_monitor_info = NULL;
1482   _parker = Parker::Allocate(this);
1483 
1484 #ifndef PRODUCT
1485   _jmp_ring_index = 0;
1486   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1487     record_jump(NULL, NULL, NULL, 0);
1488   }
1489 #endif // PRODUCT
1490 
1491   set_thread_profiler(NULL);
1492   if (FlatProfiler::is_active()) {
1493     // This is where we would decide to either give each thread it's own profiler
1494     // or use one global one from FlatProfiler,
1495     // or up to some count of the number of profiled threads, etc.
1496     ThreadProfiler* pp = new ThreadProfiler();
1497     pp-&gt;engage();
1498     set_thread_profiler(pp);
1499   }
1500 
1501   // Setup safepoint state info for this thread
1502   ThreadSafepointState::create(this);
1503 
1504   debug_only(_java_call_counter = 0);
1505 
1506   // JVMTI PopFrame support
1507   _popframe_condition = popframe_inactive;
1508   _popframe_preserved_args = NULL;
1509   _popframe_preserved_args_size = 0;
1510   _frames_to_pop_failed_realloc = 0;
1511 
1512   pd_initialize();
1513 }
1514 
1515 #if INCLUDE_ALL_GCS
1516 SATBMarkQueueSet JavaThread::_satb_mark_queue_set;
1517 DirtyCardQueueSet JavaThread::_dirty_card_queue_set;
1518 #endif // INCLUDE_ALL_GCS
1519 
1520 JavaThread::JavaThread(bool is_attaching_via_jni) :
1521                        Thread()
1522 #if INCLUDE_ALL_GCS
1523                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1524                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1525 #endif // INCLUDE_ALL_GCS
1526 {
1527   initialize();
1528   if (is_attaching_via_jni) {
1529     _jni_attach_state = _attaching_via_jni;
1530   } else {
1531     _jni_attach_state = _not_attaching_via_jni;
1532   }
1533   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1534 }
1535 
1536 bool JavaThread::reguard_stack(address cur_sp) {
1537   if (_stack_guard_state != stack_guard_yellow_disabled
1538       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1539     return true; // Stack already guarded or guard pages not needed.
1540   }
1541 
1542   if (register_stack_overflow()) {
1543     // For those architectures which have separate register and
1544     // memory stacks, we must check the register stack to see if
1545     // it has overflowed.
1546     return false;
1547   }
1548 
1549   // Java code never executes within the yellow zone: the latter is only
1550   // there to provoke an exception during stack banging.  If java code
1551   // is executing there, either StackShadowPages should be larger, or
1552   // some exception code in c1, c2 or the interpreter isn't unwinding
1553   // when it should.
1554   guarantee(cur_sp &gt; stack_yellow_zone_base(), "not enough space to reguard - increase StackShadowPages");
1555   if (_stack_guard_state == stack_guard_yellow_disabled) {
1556     enable_stack_yellow_zone();
1557     if (reserved_stack_activation() != stack_base()) {
1558       set_reserved_stack_activation(stack_base());
1559     }
1560   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1561     set_reserved_stack_activation(stack_base());
1562     enable_stack_reserved_zone();
1563   }
1564   return true;
1565 }
1566 
1567 bool JavaThread::reguard_stack(void) {
1568   return reguard_stack(os::current_stack_pointer());
1569 }
1570 
1571 
1572 void JavaThread::block_if_vm_exited() {
1573   if (_terminated == _vm_exited) {
1574     // _vm_exited is set at safepoint, and Threads_lock is never released
1575     // we will block here forever
1576     Threads_lock-&gt;lock_without_safepoint_check();
1577     ShouldNotReachHere();
1578   }
1579 }
1580 
1581 
1582 // Remove this ifdef when C1 is ported to the compiler interface.
1583 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1584 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1585 
1586 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1587                        Thread()
1588 #if INCLUDE_ALL_GCS
1589                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1590                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1591 #endif // INCLUDE_ALL_GCS
1592 {
1593   initialize();
1594   _jni_attach_state = _not_attaching_via_jni;
1595   set_entry_point(entry_point);
1596   // Create the native thread itself.
1597   // %note runtime_23
1598   os::ThreadType thr_type = os::java_thread;
1599   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1600                                                      os::java_thread;
1601   os::create_thread(this, thr_type, stack_sz);
1602   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1603   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1604   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1605   // the exception consists of creating the exception object &amp; initializing it, initialization
1606   // will leave the VM via a JavaCall and then all locks must be unlocked).
1607   //
1608   // The thread is still suspended when we reach here. Thread must be explicit started
1609   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1610   // by calling Threads:add. The reason why this is not done here, is because the thread
1611   // object must be fully initialized (take a look at JVM_Start)
1612 }
1613 
1614 JavaThread::~JavaThread() {
1615 
1616   // JSR166 -- return the parker to the free list
1617   Parker::Release(_parker);
1618   _parker = NULL;
1619 
1620   // Free any remaining  previous UnrollBlock
1621   vframeArray* old_array = vframe_array_last();
1622 
1623   if (old_array != NULL) {
1624     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1625     old_array-&gt;set_unroll_block(NULL);
1626     delete old_info;
1627     delete old_array;
1628   }
1629 
1630   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1631   if (deferred != NULL) {
1632     // This can only happen if thread is destroyed before deoptimization occurs.
1633     assert(deferred-&gt;length() != 0, "empty array!");
1634     do {
1635       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1636       deferred-&gt;remove_at(0);
1637       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1638       delete dlv;
1639     } while (deferred-&gt;length() != 0);
1640     delete deferred;
1641   }
1642 
1643   // All Java related clean up happens in exit
1644   ThreadSafepointState::destroy(this);
1645   if (_thread_profiler != NULL) delete _thread_profiler;
1646   if (_thread_stat != NULL) delete _thread_stat;
1647 
1648 #if INCLUDE_JVMCI
1649   if (JVMCICounterSize &gt; 0) {
1650     if (jvmci_counters_include(this)) {
1651       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1652         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1653       }
1654     }
1655     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1656   }
1657 #endif // INCLUDE_JVMCI
1658 }
1659 
1660 
1661 // The first routine called by a new Java thread
1662 void JavaThread::run() {
1663   // initialize thread-local alloc buffer related fields
1664   this-&gt;initialize_tlab();
1665 
1666   // used to test validity of stack trace backs
1667   this-&gt;record_base_of_stack_pointer();
1668 
1669   // Record real stack base and size.
1670   this-&gt;record_stack_base_and_size();
1671 
1672   this-&gt;create_stack_guard_pages();
1673 
1674   this-&gt;cache_global_variables();
1675 
1676   // Thread is now sufficient initialized to be handled by the safepoint code as being
1677   // in the VM. Change thread state from _thread_new to _thread_in_vm
1678   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1679 
1680   assert(JavaThread::current() == this, "sanity check");
1681   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1682 
1683   DTRACE_THREAD_PROBE(start, this);
1684 
1685   // This operation might block. We call that after all safepoint checks for a new thread has
1686   // been completed.
1687   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1688 
1689   if (JvmtiExport::should_post_thread_life()) {
1690     JvmtiExport::post_thread_start(this);
1691   }
1692 
1693   EventThreadStart event;
1694   if (event.should_commit()) {
1695     event.set_javalangthread(java_lang_Thread::thread_id(this-&gt;threadObj()));
1696     event.commit();
1697   }
1698 
1699   // We call another function to do the rest so we are sure that the stack addresses used
1700   // from there will be lower than the stack base just computed
1701   thread_main_inner();
1702 
1703   // Note, thread is no longer valid at this point!
1704 }
1705 
1706 
1707 void JavaThread::thread_main_inner() {
1708   assert(JavaThread::current() == this, "sanity check");
1709   assert(this-&gt;threadObj() != NULL, "just checking");
1710 
1711   // Execute thread entry point unless this thread has a pending exception
1712   // or has been stopped before starting.
1713   // Note: Due to JVM_StopThread we can have pending exceptions already!
1714   if (!this-&gt;has_pending_exception() &amp;&amp;
1715       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1716     {
1717       ResourceMark rm(this);
1718       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1719     }
1720     HandleMark hm(this);
1721     this-&gt;entry_point()(this, this);
1722   }
1723 
1724   DTRACE_THREAD_PROBE(stop, this);
1725 
1726   this-&gt;exit(false);
1727   delete this;
1728 }
1729 
1730 
1731 static void ensure_join(JavaThread* thread) {
1732   // We do not need to grap the Threads_lock, since we are operating on ourself.
1733   Handle threadObj(thread, thread-&gt;threadObj());
1734   assert(threadObj.not_null(), "java thread object must exist");
1735   ObjectLocker lock(threadObj, thread);
1736   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1737   thread-&gt;clear_pending_exception();
1738   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1739   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1740   // Clear the native thread instance - this makes isAlive return false and allows the join()
1741   // to complete once we've done the notify_all below
1742   java_lang_Thread::set_thread(threadObj(), NULL);
1743   lock.notify_all(thread);
1744   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1745   thread-&gt;clear_pending_exception();
1746 }
1747 
1748 
1749 // For any new cleanup additions, please check to see if they need to be applied to
1750 // cleanup_failed_attach_current_thread as well.
1751 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1752   assert(this == JavaThread::current(), "thread consistency check");
1753 
1754   HandleMark hm(this);
1755   Handle uncaught_exception(this, this-&gt;pending_exception());
1756   this-&gt;clear_pending_exception();
1757   Handle threadObj(this, this-&gt;threadObj());
1758   assert(threadObj.not_null(), "Java thread object should be created");
1759 
1760   if (get_thread_profiler() != NULL) {
1761     get_thread_profiler()-&gt;disengage();
1762     ResourceMark rm;
1763     get_thread_profiler()-&gt;print(get_thread_name());
1764   }
1765 
1766 
1767   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1768   {
1769     EXCEPTION_MARK;
1770 
1771     CLEAR_PENDING_EXCEPTION;
1772   }
1773   if (!destroy_vm) {
1774     if (uncaught_exception.not_null()) {
1775       EXCEPTION_MARK;
1776       // Call method Thread.dispatchUncaughtException().
1777       KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1778       JavaValue result(T_VOID);
1779       JavaCalls::call_virtual(&amp;result,
1780                               threadObj, thread_klass,
1781                               vmSymbols::dispatchUncaughtException_name(),
1782                               vmSymbols::throwable_void_signature(),
1783                               uncaught_exception,
1784                               THREAD);
1785       if (HAS_PENDING_EXCEPTION) {
1786         ResourceMark rm(this);
1787         jio_fprintf(defaultStream::error_stream(),
1788                     "\nException: %s thrown from the UncaughtExceptionHandler"
1789                     " in thread \"%s\"\n",
1790                     pending_exception()-&gt;klass()-&gt;external_name(),
1791                     get_thread_name());
1792         CLEAR_PENDING_EXCEPTION;
1793       }
1794     }
1795 
1796     // Called before the java thread exit since we want to read info
1797     // from java_lang_Thread object
1798     EventThreadEnd event;
1799     if (event.should_commit()) {
1800       event.set_javalangthread(java_lang_Thread::thread_id(this-&gt;threadObj()));
1801       event.commit();
1802     }
1803 
1804     // Call after last event on thread
1805     EVENT_THREAD_EXIT(this);
1806 
1807     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1808     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1809     // is deprecated anyhow.
1810     if (!is_Compiler_thread()) {
1811       int count = 3;
1812       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1813         EXCEPTION_MARK;
1814         JavaValue result(T_VOID);
1815         KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1816         JavaCalls::call_virtual(&amp;result,
1817                                 threadObj, thread_klass,
1818                                 vmSymbols::exit_method_name(),
1819                                 vmSymbols::void_method_signature(),
1820                                 THREAD);
1821         CLEAR_PENDING_EXCEPTION;
1822       }
1823     }
1824     // notify JVMTI
1825     if (JvmtiExport::should_post_thread_life()) {
1826       JvmtiExport::post_thread_end(this);
1827     }
1828 
1829     // We have notified the agents that we are exiting, before we go on,
1830     // we must check for a pending external suspend request and honor it
1831     // in order to not surprise the thread that made the suspend request.
1832     while (true) {
1833       {
1834         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1835         if (!is_external_suspend()) {
1836           set_terminated(_thread_exiting);
1837           ThreadService::current_thread_exiting(this);
1838           break;
1839         }
1840         // Implied else:
1841         // Things get a little tricky here. We have a pending external
1842         // suspend request, but we are holding the SR_lock so we
1843         // can't just self-suspend. So we temporarily drop the lock
1844         // and then self-suspend.
1845       }
1846 
1847       ThreadBlockInVM tbivm(this);
1848       java_suspend_self();
1849 
1850       // We're done with this suspend request, but we have to loop around
1851       // and check again. Eventually we will get SR_lock without a pending
1852       // external suspend request and will be able to mark ourselves as
1853       // exiting.
1854     }
1855     // no more external suspends are allowed at this point
1856   } else {
1857     // before_exit() has already posted JVMTI THREAD_END events
1858   }
1859 
1860   // Notify waiters on thread object. This has to be done after exit() is called
1861   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1862   // group should have the destroyed bit set before waiters are notified).
1863   ensure_join(this);
1864   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1865 
1866   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1867   // held by this thread must be released. The spec does not distinguish
1868   // between JNI-acquired and regular Java monitors. We can only see
1869   // regular Java monitors here if monitor enter-exit matching is broken.
1870   //
1871   // Optionally release any monitors for regular JavaThread exits. This
1872   // is provided as a work around for any bugs in monitor enter-exit
1873   // matching. This can be expensive so it is not enabled by default.
1874   //
1875   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1876   // ObjectSynchronizer::release_monitors_owned_by_thread().
1877   if (exit_type == jni_detach || ObjectMonitor::Knob_ExitRelease) {
1878     // Sanity check even though JNI DetachCurrentThread() would have
1879     // returned JNI_ERR if there was a Java frame. JavaThread exit
1880     // should be done executing Java code by the time we get here.
1881     assert(!this-&gt;has_last_Java_frame(),
1882            "should not have a Java frame when detaching or exiting");
1883     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1884     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1885   }
1886 
1887   // These things needs to be done while we are still a Java Thread. Make sure that thread
1888   // is in a consistent state, in case GC happens
1889   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1890 
1891   if (active_handles() != NULL) {
1892     JNIHandleBlock* block = active_handles();
1893     set_active_handles(NULL);
1894     JNIHandleBlock::release_block(block);
1895   }
1896 
1897   if (free_handle_block() != NULL) {
1898     JNIHandleBlock* block = free_handle_block();
1899     set_free_handle_block(NULL);
1900     JNIHandleBlock::release_block(block);
1901   }
1902 
1903   // These have to be removed while this is still a valid thread.
1904   remove_stack_guard_pages();
1905 
1906   if (UseTLAB) {
1907     tlab().make_parsable(true);  // retire TLAB
1908   }
1909 
1910   if (JvmtiEnv::environments_might_exist()) {
1911     JvmtiExport::cleanup_thread(this);
1912   }
1913 
1914   // We must flush any deferred card marks before removing a thread from
1915   // the list of active threads.
1916   Universe::heap()-&gt;flush_deferred_store_barrier(this);
1917   assert(deferred_card_mark().is_empty(), "Should have been flushed");
1918 
1919 #if INCLUDE_ALL_GCS
1920   // We must flush the G1-related buffers before removing a thread
1921   // from the list of active threads. We must do this after any deferred
1922   // card marks have been flushed (above) so that any entries that are
1923   // added to the thread's dirty card queue as a result are not lost.
1924   if (UseG1GC) {
1925     flush_barrier_queues();
1926   }
1927 #endif // INCLUDE_ALL_GCS
1928 
1929   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
1930   Threads::remove(this);
1931 }
1932 
1933 #if INCLUDE_ALL_GCS
1934 // Flush G1-related queues.
1935 void JavaThread::flush_barrier_queues() {
1936   satb_mark_queue().flush();
1937   dirty_card_queue().flush();
1938 }
1939 
1940 void JavaThread::initialize_queues() {
1941   assert(!SafepointSynchronize::is_at_safepoint(),
1942          "we should not be at a safepoint");
1943 
1944   SATBMarkQueue&amp; satb_queue = satb_mark_queue();
1945   SATBMarkQueueSet&amp; satb_queue_set = satb_mark_queue_set();
1946   // The SATB queue should have been constructed with its active
1947   // field set to false.
1948   assert(!satb_queue.is_active(), "SATB queue should not be active");
1949   assert(satb_queue.is_empty(), "SATB queue should be empty");
1950   // If we are creating the thread during a marking cycle, we should
1951   // set the active field of the SATB queue to true.
1952   if (satb_queue_set.is_active()) {
1953     satb_queue.set_active(true);
1954   }
1955 
1956   DirtyCardQueue&amp; dirty_queue = dirty_card_queue();
1957   // The dirty card queue should have been constructed with its
1958   // active field set to true.
1959   assert(dirty_queue.is_active(), "dirty card queue should be active");
1960 }
1961 #endif // INCLUDE_ALL_GCS
1962 
1963 void JavaThread::cleanup_failed_attach_current_thread() {
1964   if (get_thread_profiler() != NULL) {
1965     get_thread_profiler()-&gt;disengage();
1966     ResourceMark rm;
1967     get_thread_profiler()-&gt;print(get_thread_name());
1968   }
1969 
1970   if (active_handles() != NULL) {
1971     JNIHandleBlock* block = active_handles();
1972     set_active_handles(NULL);
1973     JNIHandleBlock::release_block(block);
1974   }
1975 
1976   if (free_handle_block() != NULL) {
1977     JNIHandleBlock* block = free_handle_block();
1978     set_free_handle_block(NULL);
1979     JNIHandleBlock::release_block(block);
1980   }
1981 
1982   // These have to be removed while this is still a valid thread.
1983   remove_stack_guard_pages();
1984 
1985   if (UseTLAB) {
1986     tlab().make_parsable(true);  // retire TLAB, if any
1987   }
1988 
1989 #if INCLUDE_ALL_GCS
1990   if (UseG1GC) {
1991     flush_barrier_queues();
1992   }
1993 #endif // INCLUDE_ALL_GCS
1994 
1995   Threads::remove(this);
1996   delete this;
1997 }
1998 
1999 
2000 
2001 
2002 JavaThread* JavaThread::active() {
2003   Thread* thread = Thread::current();
2004   if (thread-&gt;is_Java_thread()) {
2005     return (JavaThread*) thread;
2006   } else {
2007     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2008     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2009     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2010     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2011     return ret;
2012   }
2013 }
2014 
2015 bool JavaThread::is_lock_owned(address adr) const {
2016   if (Thread::is_lock_owned(adr)) return true;
2017 
2018   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2019     if (chunk-&gt;contains(adr)) return true;
2020   }
2021 
2022   return false;
2023 }
2024 
2025 
2026 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2027   chunk-&gt;set_next(monitor_chunks());
2028   set_monitor_chunks(chunk);
2029 }
2030 
2031 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2032   guarantee(monitor_chunks() != NULL, "must be non empty");
2033   if (monitor_chunks() == chunk) {
2034     set_monitor_chunks(chunk-&gt;next());
2035   } else {
2036     MonitorChunk* prev = monitor_chunks();
2037     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2038     prev-&gt;set_next(chunk-&gt;next());
2039   }
2040 }
2041 
2042 // JVM support.
2043 
2044 // Note: this function shouldn't block if it's called in
2045 // _thread_in_native_trans state (such as from
2046 // check_special_condition_for_native_trans()).
2047 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2048 
2049   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2050     // If we are at a polling page safepoint (not a poll return)
2051     // then we must defer async exception because live registers
2052     // will be clobbered by the exception path. Poll return is
2053     // ok because the call we a returning from already collides
2054     // with exception handling registers and so there is no issue.
2055     // (The exception handling path kills call result registers but
2056     //  this is ok since the exception kills the result anyway).
2057 
2058     if (is_at_poll_safepoint()) {
2059       // if the code we are returning to has deoptimized we must defer
2060       // the exception otherwise live registers get clobbered on the
2061       // exception path before deoptimization is able to retrieve them.
2062       //
2063       RegisterMap map(this, false);
2064       frame caller_fr = last_frame().sender(&amp;map);
2065       assert(caller_fr.is_compiled_frame(), "what?");
2066       if (caller_fr.is_deoptimized_frame()) {
2067         if (TraceExceptions) {
2068           ResourceMark rm;
2069           tty-&gt;print_cr("deferred async exception at compiled safepoint");
2070         }
2071         return;
2072       }
2073     }
2074   }
2075 
2076   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2077   if (condition == _no_async_condition) {
2078     // Conditions have changed since has_special_runtime_exit_condition()
2079     // was called:
2080     // - if we were here only because of an external suspend request,
2081     //   then that was taken care of above (or cancelled) so we are done
2082     // - if we were here because of another async request, then it has
2083     //   been cleared between the has_special_runtime_exit_condition()
2084     //   and now so again we are done
2085     return;
2086   }
2087 
2088   // Check for pending async. exception
2089   if (_pending_async_exception != NULL) {
2090     // Only overwrite an already pending exception, if it is not a threadDeath.
2091     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2092 
2093       // We cannot call Exceptions::_throw(...) here because we cannot block
2094       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2095 
2096       if (TraceExceptions) {
2097         ResourceMark rm;
2098         tty-&gt;print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2099         if (has_last_Java_frame()) {
2100           frame f = last_frame();
2101           tty-&gt;print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2102         }
2103         tty-&gt;print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2104       }
2105       _pending_async_exception = NULL;
2106       clear_has_async_exception();
2107     }
2108   }
2109 
2110   if (check_unsafe_error &amp;&amp;
2111       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2112     condition = _no_async_condition;  // done
2113     switch (thread_state()) {
2114     case _thread_in_vm: {
2115       JavaThread* THREAD = this;
2116       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2117     }
2118     case _thread_in_native: {
2119       ThreadInVMfromNative tiv(this);
2120       JavaThread* THREAD = this;
2121       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2122     }
2123     case _thread_in_Java: {
2124       ThreadInVMfromJava tiv(this);
2125       JavaThread* THREAD = this;
2126       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2127     }
2128     default:
2129       ShouldNotReachHere();
2130     }
2131   }
2132 
2133   assert(condition == _no_async_condition || has_pending_exception() ||
2134          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2135          "must have handled the async condition, if no exception");
2136 }
2137 
2138 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2139   //
2140   // Check for pending external suspend. Internal suspend requests do
2141   // not use handle_special_runtime_exit_condition().
2142   // If JNIEnv proxies are allowed, don't self-suspend if the target
2143   // thread is not the current thread. In older versions of jdbx, jdbx
2144   // threads could call into the VM with another thread's JNIEnv so we
2145   // can be here operating on behalf of a suspended thread (4432884).
2146   bool do_self_suspend = is_external_suspend_with_lock();
2147   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2148     //
2149     // Because thread is external suspended the safepoint code will count
2150     // thread as at a safepoint. This can be odd because we can be here
2151     // as _thread_in_Java which would normally transition to _thread_blocked
2152     // at a safepoint. We would like to mark the thread as _thread_blocked
2153     // before calling java_suspend_self like all other callers of it but
2154     // we must then observe proper safepoint protocol. (We can't leave
2155     // _thread_blocked with a safepoint in progress). However we can be
2156     // here as _thread_in_native_trans so we can't use a normal transition
2157     // constructor/destructor pair because they assert on that type of
2158     // transition. We could do something like:
2159     //
2160     // JavaThreadState state = thread_state();
2161     // set_thread_state(_thread_in_vm);
2162     // {
2163     //   ThreadBlockInVM tbivm(this);
2164     //   java_suspend_self()
2165     // }
2166     // set_thread_state(_thread_in_vm_trans);
2167     // if (safepoint) block;
2168     // set_thread_state(state);
2169     //
2170     // but that is pretty messy. Instead we just go with the way the
2171     // code has worked before and note that this is the only path to
2172     // java_suspend_self that doesn't put the thread in _thread_blocked
2173     // mode.
2174 
2175     frame_anchor()-&gt;make_walkable(this);
2176     java_suspend_self();
2177 
2178     // We might be here for reasons in addition to the self-suspend request
2179     // so check for other async requests.
2180   }
2181 
2182   if (check_asyncs) {
2183     check_and_handle_async_exceptions();
2184   }
2185 }
2186 
2187 void JavaThread::send_thread_stop(oop java_throwable)  {
2188   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2189   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2190   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2191 
2192   // Do not throw asynchronous exceptions against the compiler thread
2193   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2194   if (!can_call_java()) return;
2195 
2196   {
2197     // Actually throw the Throwable against the target Thread - however
2198     // only if there is no thread death exception installed already.
2199     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2200       // If the topmost frame is a runtime stub, then we are calling into
2201       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2202       // must deoptimize the caller before continuing, as the compiled  exception handler table
2203       // may not be valid
2204       if (has_last_Java_frame()) {
2205         frame f = last_frame();
2206         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2207           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2208           RegisterMap reg_map(this, UseBiasedLocking);
2209           frame compiled_frame = f.sender(&amp;reg_map);
2210           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2211             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2212           }
2213         }
2214       }
2215 
2216       // Set async. pending exception in thread.
2217       set_pending_async_exception(java_throwable);
2218 
2219       if (TraceExceptions) {
2220         ResourceMark rm;
2221         tty-&gt;print_cr("Pending Async. exception installed of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2222       }
2223       // for AbortVMOnException flag
2224       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2225     }
2226   }
2227 
2228 
2229   // Interrupt thread so it will wake up from a potential wait()
2230   Thread::interrupt(this);
2231 }
2232 
2233 // External suspension mechanism.
2234 //
2235 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2236 // to any VM_locks and it is at a transition
2237 // Self-suspension will happen on the transition out of the vm.
2238 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2239 //
2240 // Guarantees on return:
2241 //   + Target thread will not execute any new bytecode (that's why we need to
2242 //     force a safepoint)
2243 //   + Target thread will not enter any new monitors
2244 //
2245 void JavaThread::java_suspend() {
2246   { MutexLocker mu(Threads_lock);
2247     if (!Threads::includes(this) || is_exiting() || this-&gt;threadObj() == NULL) {
2248       return;
2249     }
2250   }
2251 
2252   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2253     if (!is_external_suspend()) {
2254       // a racing resume has cancelled us; bail out now
2255       return;
2256     }
2257 
2258     // suspend is done
2259     uint32_t debug_bits = 0;
2260     // Warning: is_ext_suspend_completed() may temporarily drop the
2261     // SR_lock to allow the thread to reach a stable thread state if
2262     // it is currently in a transient thread state.
2263     if (is_ext_suspend_completed(false /* !called_by_wait */,
2264                                  SuspendRetryDelay, &amp;debug_bits)) {
2265       return;
2266     }
2267   }
2268 
2269   VM_ForceSafepoint vm_suspend;
2270   VMThread::execute(&amp;vm_suspend);
2271 }
2272 
2273 // Part II of external suspension.
2274 // A JavaThread self suspends when it detects a pending external suspend
2275 // request. This is usually on transitions. It is also done in places
2276 // where continuing to the next transition would surprise the caller,
2277 // e.g., monitor entry.
2278 //
2279 // Returns the number of times that the thread self-suspended.
2280 //
2281 // Note: DO NOT call java_suspend_self() when you just want to block current
2282 //       thread. java_suspend_self() is the second stage of cooperative
2283 //       suspension for external suspend requests and should only be used
2284 //       to complete an external suspend request.
2285 //
2286 int JavaThread::java_suspend_self() {
2287   int ret = 0;
2288 
2289   // we are in the process of exiting so don't suspend
2290   if (is_exiting()) {
2291     clear_external_suspend();
2292     return ret;
2293   }
2294 
2295   assert(_anchor.walkable() ||
2296          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2297          "must have walkable stack");
2298 
2299   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2300 
2301   assert(!this-&gt;is_ext_suspended(),
2302          "a thread trying to self-suspend should not already be suspended");
2303 
2304   if (this-&gt;is_suspend_equivalent()) {
2305     // If we are self-suspending as a result of the lifting of a
2306     // suspend equivalent condition, then the suspend_equivalent
2307     // flag is not cleared until we set the ext_suspended flag so
2308     // that wait_for_ext_suspend_completion() returns consistent
2309     // results.
2310     this-&gt;clear_suspend_equivalent();
2311   }
2312 
2313   // A racing resume may have cancelled us before we grabbed SR_lock
2314   // above. Or another external suspend request could be waiting for us
2315   // by the time we return from SR_lock()-&gt;wait(). The thread
2316   // that requested the suspension may already be trying to walk our
2317   // stack and if we return now, we can change the stack out from under
2318   // it. This would be a "bad thing (TM)" and cause the stack walker
2319   // to crash. We stay self-suspended until there are no more pending
2320   // external suspend requests.
2321   while (is_external_suspend()) {
2322     ret++;
2323     this-&gt;set_ext_suspended();
2324 
2325     // _ext_suspended flag is cleared by java_resume()
2326     while (is_ext_suspended()) {
2327       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2328     }
2329   }
2330 
2331   return ret;
2332 }
2333 
2334 #ifdef ASSERT
2335 // verify the JavaThread has not yet been published in the Threads::list, and
2336 // hence doesn't need protection from concurrent access at this stage
2337 void JavaThread::verify_not_published() {
2338   if (!Threads_lock-&gt;owned_by_self()) {
2339     MutexLockerEx ml(Threads_lock,  Mutex::_no_safepoint_check_flag);
2340     assert(!Threads::includes(this),
2341            "java thread shouldn't have been published yet!");
2342   } else {
2343     assert(!Threads::includes(this),
2344            "java thread shouldn't have been published yet!");
2345   }
2346 }
2347 #endif
2348 
2349 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2350 // progress or when _suspend_flags is non-zero.
2351 // Current thread needs to self-suspend if there is a suspend request and/or
2352 // block if a safepoint is in progress.
2353 // Async exception ISN'T checked.
2354 // Note only the ThreadInVMfromNative transition can call this function
2355 // directly and when thread state is _thread_in_native_trans
2356 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2357   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2358 
2359   JavaThread *curJT = JavaThread::current();
2360   bool do_self_suspend = thread-&gt;is_external_suspend();
2361 
2362   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2363 
2364   // If JNIEnv proxies are allowed, don't self-suspend if the target
2365   // thread is not the current thread. In older versions of jdbx, jdbx
2366   // threads could call into the VM with another thread's JNIEnv so we
2367   // can be here operating on behalf of a suspended thread (4432884).
2368   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2369     JavaThreadState state = thread-&gt;thread_state();
2370 
2371     // We mark this thread_blocked state as a suspend-equivalent so
2372     // that a caller to is_ext_suspend_completed() won't be confused.
2373     // The suspend-equivalent state is cleared by java_suspend_self().
2374     thread-&gt;set_suspend_equivalent();
2375 
2376     // If the safepoint code sees the _thread_in_native_trans state, it will
2377     // wait until the thread changes to other thread state. There is no
2378     // guarantee on how soon we can obtain the SR_lock and complete the
2379     // self-suspend request. It would be a bad idea to let safepoint wait for
2380     // too long. Temporarily change the state to _thread_blocked to
2381     // let the VM thread know that this thread is ready for GC. The problem
2382     // of changing thread state is that safepoint could happen just after
2383     // java_suspend_self() returns after being resumed, and VM thread will
2384     // see the _thread_blocked state. We must check for safepoint
2385     // after restoring the state and make sure we won't leave while a safepoint
2386     // is in progress.
2387     thread-&gt;set_thread_state(_thread_blocked);
2388     thread-&gt;java_suspend_self();
2389     thread-&gt;set_thread_state(state);
2390     // Make sure new state is seen by VM thread
2391     if (os::is_MP()) {
2392       if (UseMembar) {
2393         // Force a fence between the write above and read below
2394         OrderAccess::fence();
2395       } else {
2396         // Must use this rather than serialization page in particular on Windows
2397         InterfaceSupport::serialize_memory(thread);
2398       }
2399     }
2400   }
2401 
2402   if (SafepointSynchronize::do_call_back()) {
2403     // If we are safepointing, then block the caller which may not be
2404     // the same as the target thread (see above).
2405     SafepointSynchronize::block(curJT);
2406   }
2407 
2408   if (thread-&gt;is_deopt_suspend()) {
2409     thread-&gt;clear_deopt_suspend();
2410     RegisterMap map(thread, false);
2411     frame f = thread-&gt;last_frame();
2412     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2413       f = f.sender(&amp;map);
2414     }
2415     if (f.id() == thread-&gt;must_deopt_id()) {
2416       thread-&gt;clear_must_deopt_id();
2417       f.deoptimize(thread);
2418     } else {
2419       fatal("missed deoptimization!");
2420     }
2421   }
2422 }
2423 
2424 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2425 // progress or when _suspend_flags is non-zero.
2426 // Current thread needs to self-suspend if there is a suspend request and/or
2427 // block if a safepoint is in progress.
2428 // Also check for pending async exception (not including unsafe access error).
2429 // Note only the native==&gt;VM/Java barriers can call this function and when
2430 // thread state is _thread_in_native_trans.
2431 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2432   check_safepoint_and_suspend_for_native_trans(thread);
2433 
2434   if (thread-&gt;has_async_exception()) {
2435     // We are in _thread_in_native_trans state, don't handle unsafe
2436     // access error since that may block.
2437     thread-&gt;check_and_handle_async_exceptions(false);
2438   }
2439 }
2440 
2441 // This is a variant of the normal
2442 // check_special_condition_for_native_trans with slightly different
2443 // semantics for use by critical native wrappers.  It does all the
2444 // normal checks but also performs the transition back into
2445 // thread_in_Java state.  This is required so that critical natives
2446 // can potentially block and perform a GC if they are the last thread
2447 // exiting the GC_locker.
2448 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2449   check_special_condition_for_native_trans(thread);
2450 
2451   // Finish the transition
2452   thread-&gt;set_thread_state(_thread_in_Java);
2453 
2454   if (thread-&gt;do_critical_native_unlock()) {
2455     ThreadInVMfromJavaNoAsyncException tiv(thread);
2456     GC_locker::unlock_critical(thread);
2457     thread-&gt;clear_critical_native_unlock();
2458   }
2459 }
2460 
2461 // We need to guarantee the Threads_lock here, since resumes are not
2462 // allowed during safepoint synchronization
2463 // Can only resume from an external suspension
2464 void JavaThread::java_resume() {
2465   assert_locked_or_safepoint(Threads_lock);
2466 
2467   // Sanity check: thread is gone, has started exiting or the thread
2468   // was not externally suspended.
2469   if (!Threads::includes(this) || is_exiting() || !is_external_suspend()) {
2470     return;
2471   }
2472 
2473   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2474 
2475   clear_external_suspend();
2476 
2477   if (is_ext_suspended()) {
2478     clear_ext_suspended();
2479     SR_lock()-&gt;notify_all();
2480   }
2481 }
2482 
2483 void JavaThread::create_stack_guard_pages() {
2484   if (! os::uses_stack_guard_pages() || _stack_guard_state != stack_guard_unused) return;
2485   address low_addr = stack_base() - stack_size();
2486   size_t len = (StackReservedPages + StackYellowPages + StackRedPages) * os::vm_page_size();
2487 
2488   int allocate = os::allocate_stack_guard_pages();
2489   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2490 
2491   if (allocate &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2492     warning("Attempt to allocate stack guard pages failed.");
2493     return;
2494   }
2495 
2496   if (os::guard_memory((char *) low_addr, len)) {
2497     _stack_guard_state = stack_guard_enabled;
2498   } else {
2499     warning("Attempt to protect stack guard pages failed.");
2500     if (os::uncommit_memory((char *) low_addr, len)) {
2501       warning("Attempt to deallocate stack guard pages failed.");
2502     }
2503   }
2504 }
2505 
2506 void JavaThread::remove_stack_guard_pages() {
2507   assert(Thread::current() == this, "from different thread");
2508   if (_stack_guard_state == stack_guard_unused) return;
2509   address low_addr = stack_base() - stack_size();
2510   size_t len = (StackReservedPages + StackYellowPages + StackRedPages) * os::vm_page_size();
2511 
2512   if (os::allocate_stack_guard_pages()) {
2513     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2514       _stack_guard_state = stack_guard_unused;
2515     } else {
2516       warning("Attempt to deallocate stack guard pages failed.");
2517     }
2518   } else {
2519     if (_stack_guard_state == stack_guard_unused) return;
2520     if (os::unguard_memory((char *) low_addr, len)) {
2521       _stack_guard_state = stack_guard_unused;
2522     } else {
2523       warning("Attempt to unprotect stack guard pages failed.");
2524     }
2525   }
2526 }
2527 
2528 void JavaThread::enable_stack_reserved_zone() {
2529   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2530   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2531 
2532   // The base notation is from the stack's point of view, growing downward.
2533   // We need to adjust it to work correctly with guard_memory()
2534   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2535 
2536   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2537   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2538 
2539   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2540     _stack_guard_state = stack_guard_enabled;
2541   } else {
2542     warning("Attempt to guard stack reserved zone failed.");
2543   }
2544   enable_register_stack_guard();
2545 }
2546 
2547 void JavaThread::disable_stack_reserved_zone() {
2548   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2549   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2550 
2551   // Simply return if called for a thread that does not use guard pages.
2552   if (_stack_guard_state == stack_guard_unused) return;
2553 
2554   // The base notation is from the stack's point of view, growing downward.
2555   // We need to adjust it to work correctly with guard_memory()
2556   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2557 
2558   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2559     _stack_guard_state = stack_guard_reserved_disabled;
2560   } else {
2561     warning("Attempt to unguard stack reserved zone failed.");
2562   }
2563   disable_register_stack_guard();
2564 }
2565 
2566 void JavaThread::enable_stack_yellow_zone() {
2567   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2568   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2569 
2570   // The base notation is from the stacks point of view, growing downward.
2571   // We need to adjust it to work correctly with guard_memory()
2572   address base = stack_yellow_zone_base() - stack_yellow_zone_size();
2573 
2574   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2575   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2576 
2577   if (os::guard_memory((char *) base, stack_yellow_zone_size())) {
2578     _stack_guard_state = stack_guard_enabled;
2579   } else {
2580     warning("Attempt to guard stack yellow zone failed.");
2581   }
2582   enable_register_stack_guard();
2583 }
2584 
2585 void JavaThread::disable_stack_yellow_zone() {
2586   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2587   assert(_stack_guard_state != stack_guard_yellow_disabled, "already disabled");
2588 
2589   // Simply return if called for a thread that does not use guard pages.
2590   if (_stack_guard_state == stack_guard_unused) return;
2591 
2592   // The base notation is from the stacks point of view, growing downward.
2593   // We need to adjust it to work correctly with guard_memory()
2594   address base = stack_yellow_zone_base() - stack_yellow_zone_size();
2595 
2596   if (os::unguard_memory((char *)base, stack_yellow_zone_size())) {
2597     _stack_guard_state = stack_guard_yellow_disabled;
2598   } else {
2599     warning("Attempt to unguard stack yellow zone failed.");
2600   }
2601   disable_register_stack_guard();
2602 }
2603 
2604 void JavaThread::enable_stack_red_zone() {
2605   // The base notation is from the stacks point of view, growing downward.
2606   // We need to adjust it to work correctly with guard_memory()
2607   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2608   address base = stack_red_zone_base() - stack_red_zone_size();
2609 
2610   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2611   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2612 
2613   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2614     warning("Attempt to guard stack red zone failed.");
2615   }
2616 }
2617 
2618 void JavaThread::disable_stack_red_zone() {
2619   // The base notation is from the stacks point of view, growing downward.
2620   // We need to adjust it to work correctly with guard_memory()
2621   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2622   address base = stack_red_zone_base() - stack_red_zone_size();
2623   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2624     warning("Attempt to unguard stack red zone failed.");
2625   }
2626 }
2627 
2628 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2629   // ignore is there is no stack
2630   if (!has_last_Java_frame()) return;
2631   // traverse the stack frames. Starts from top frame.
2632   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2633     frame* fr = fst.current();
2634     f(fr, fst.register_map());
2635   }
2636 }
2637 
2638 
2639 #ifndef PRODUCT
2640 // Deoptimization
2641 // Function for testing deoptimization
2642 void JavaThread::deoptimize() {
2643   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2644   StackFrameStream fst(this, UseBiasedLocking);
2645   bool deopt = false;           // Dump stack only if a deopt actually happens.
2646   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2647   // Iterate over all frames in the thread and deoptimize
2648   for (; !fst.is_done(); fst.next()) {
2649     if (fst.current()-&gt;can_be_deoptimized()) {
2650 
2651       if (only_at) {
2652         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2653         // consists of comma or carriage return separated numbers so
2654         // search for the current bci in that string.
2655         address pc = fst.current()-&gt;pc();
2656         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2657         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2658         char buffer[8];
2659         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2660         size_t len = strlen(buffer);
2661         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2662         while (found != NULL) {
2663           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2664               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2665             // Check that the bci found is bracketed by terminators.
2666             break;
2667           }
2668           found = strstr(found + 1, buffer);
2669         }
2670         if (!found) {
2671           continue;
2672         }
2673       }
2674 
2675       if (DebugDeoptimization &amp;&amp; !deopt) {
2676         deopt = true; // One-time only print before deopt
2677         tty-&gt;print_cr("[BEFORE Deoptimization]");
2678         trace_frames();
2679         trace_stack();
2680       }
2681       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2682     }
2683   }
2684 
2685   if (DebugDeoptimization &amp;&amp; deopt) {
2686     tty-&gt;print_cr("[AFTER Deoptimization]");
2687     trace_frames();
2688   }
2689 }
2690 
2691 
2692 // Make zombies
2693 void JavaThread::make_zombies() {
2694   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2695     if (fst.current()-&gt;can_be_deoptimized()) {
2696       // it is a Java nmethod
2697       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2698       nm-&gt;make_not_entrant();
2699     }
2700   }
2701 }
2702 #endif // PRODUCT
2703 
2704 
2705 void JavaThread::deoptimized_wrt_marked_nmethods() {
2706   if (!has_last_Java_frame()) return;
2707   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2708   StackFrameStream fst(this, UseBiasedLocking);
2709   for (; !fst.is_done(); fst.next()) {
2710     if (fst.current()-&gt;should_be_deoptimized()) {
2711       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2712     }
2713   }
2714 }
2715 
2716 
2717 // If the caller is a NamedThread, then remember, in the current scope,
2718 // the given JavaThread in its _processed_thread field.
2719 class RememberProcessedThread: public StackObj {
2720   NamedThread* _cur_thr;
2721  public:
2722   RememberProcessedThread(JavaThread* jthr) {
2723     Thread* thread = Thread::current();
2724     if (thread-&gt;is_Named_thread()) {
2725       _cur_thr = (NamedThread *)thread;
2726       _cur_thr-&gt;set_processed_thread(jthr);
2727     } else {
2728       _cur_thr = NULL;
2729     }
2730   }
2731 
2732   ~RememberProcessedThread() {
2733     if (_cur_thr) {
2734       _cur_thr-&gt;set_processed_thread(NULL);
2735     }
2736   }
2737 };
2738 
2739 void JavaThread::oops_do(OopClosure* f, CLDClosure* cld_f, CodeBlobClosure* cf) {
2740   // Verify that the deferred card marks have been flushed.
2741   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2742 
2743   // The ThreadProfiler oops_do is done from FlatProfiler::oops_do
2744   // since there may be more than one thread using each ThreadProfiler.
2745 
2746   // Traverse the GCHandles
2747   Thread::oops_do(f, cld_f, cf);
2748 
2749   JVMCI_ONLY(f-&gt;do_oop((oop*)&amp;_pending_failed_speculation);)
2750 
2751   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2752          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2753 
2754   if (has_last_Java_frame()) {
2755     // Record JavaThread to GC thread
2756     RememberProcessedThread rpt(this);
2757 
2758     // Traverse the privileged stack
2759     if (_privileged_stack_top != NULL) {
2760       _privileged_stack_top-&gt;oops_do(f);
2761     }
2762 
2763     // traverse the registered growable array
2764     if (_array_for_gc != NULL) {
2765       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2766         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2767       }
2768     }
2769 
2770     // Traverse the monitor chunks
2771     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2772       chunk-&gt;oops_do(f);
2773     }
2774 
2775     // Traverse the execution stack
2776     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2777       fst.current()-&gt;oops_do(f, cld_f, cf, fst.register_map());
2778     }
2779   }
2780 
2781   // callee_target is never live across a gc point so NULL it here should
2782   // it still contain a methdOop.
2783 
2784   set_callee_target(NULL);
2785 
2786   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2787   // If we have deferred set_locals there might be oops waiting to be
2788   // written
2789   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2790   if (list != NULL) {
2791     for (int i = 0; i &lt; list-&gt;length(); i++) {
2792       list-&gt;at(i)-&gt;oops_do(f);
2793     }
2794   }
2795 
2796   // Traverse instance variables at the end since the GC may be moving things
2797   // around using this function
2798   f-&gt;do_oop((oop*) &amp;_threadObj);
2799   f-&gt;do_oop((oop*) &amp;_vm_result);
2800   f-&gt;do_oop((oop*) &amp;_exception_oop);
2801   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2802 
2803   if (jvmti_thread_state() != NULL) {
2804     jvmti_thread_state()-&gt;oops_do(f);
2805   }
2806 }
2807 
2808 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2809   Thread::nmethods_do(cf);  // (super method is a no-op)
2810 
2811   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2812          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2813 
2814   if (has_last_Java_frame()) {
2815     // Traverse the execution stack
2816     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2817       fst.current()-&gt;nmethods_do(cf);
2818     }
2819   }
2820 }
2821 
2822 void JavaThread::metadata_do(void f(Metadata*)) {
2823   if (has_last_Java_frame()) {
2824     // Traverse the execution stack to call f() on the methods in the stack
2825     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2826       fst.current()-&gt;metadata_do(f);
2827     }
2828   } else if (is_Compiler_thread()) {
2829     // need to walk ciMetadata in current compile tasks to keep alive.
2830     CompilerThread* ct = (CompilerThread*)this;
2831     if (ct-&gt;env() != NULL) {
2832       ct-&gt;env()-&gt;metadata_do(f);
2833     }
2834     if (ct-&gt;task() != NULL) {
2835       ct-&gt;task()-&gt;metadata_do(f);
2836     }
2837   }
2838 }
2839 
2840 // Printing
2841 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2842   switch (_thread_state) {
2843   case _thread_uninitialized:     return "_thread_uninitialized";
2844   case _thread_new:               return "_thread_new";
2845   case _thread_new_trans:         return "_thread_new_trans";
2846   case _thread_in_native:         return "_thread_in_native";
2847   case _thread_in_native_trans:   return "_thread_in_native_trans";
2848   case _thread_in_vm:             return "_thread_in_vm";
2849   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2850   case _thread_in_Java:           return "_thread_in_Java";
2851   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2852   case _thread_blocked:           return "_thread_blocked";
2853   case _thread_blocked_trans:     return "_thread_blocked_trans";
2854   default:                        return "unknown thread state";
2855   }
2856 }
2857 
2858 #ifndef PRODUCT
2859 void JavaThread::print_thread_state_on(outputStream *st) const {
2860   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2861 };
2862 void JavaThread::print_thread_state() const {
2863   print_thread_state_on(tty);
2864 }
2865 #endif // PRODUCT
2866 
2867 // Called by Threads::print() for VM_PrintThreads operation
2868 void JavaThread::print_on(outputStream *st) const {
2869   st-&gt;print("\"%s\" ", get_thread_name());
2870   oop thread_oop = threadObj();
2871   if (thread_oop != NULL) {
2872     st-&gt;print("#" INT64_FORMAT " ", java_lang_Thread::thread_id(thread_oop));
2873     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2874     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2875   }
2876   Thread::print_on(st);
2877   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2878   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2879   if (thread_oop != NULL) {
2880     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2881   }
2882 #ifndef PRODUCT
2883   print_thread_state_on(st);
2884   _safepoint_state-&gt;print_on(st);
2885 #endif // PRODUCT
2886 }
2887 
2888 // Called by fatal error handler. The difference between this and
2889 // JavaThread::print() is that we can't grab lock or allocate memory.
2890 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2891   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2892   oop thread_obj = threadObj();
2893   if (thread_obj != NULL) {
2894     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2895   }
2896   st-&gt;print(" [");
2897   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2898   if (osthread()) {
2899     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2900   }
2901   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2902             p2i(_stack_base - _stack_size), p2i(_stack_base));
2903   st-&gt;print("]");
2904   return;
2905 }
2906 
2907 // Verification
2908 
2909 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2910 
2911 void JavaThread::verify() {
2912   // Verify oops in the thread.
2913   oops_do(&amp;VerifyOopClosure::verify_oop, NULL, NULL);
2914 
2915   // Verify the stack frames.
2916   frames_do(frame_verify);
2917 }
2918 
2919 // CR 6300358 (sub-CR 2137150)
2920 // Most callers of this method assume that it can't return NULL but a
2921 // thread may not have a name whilst it is in the process of attaching to
2922 // the VM - see CR 6412693, and there are places where a JavaThread can be
2923 // seen prior to having it's threadObj set (eg JNI attaching threads and
2924 // if vm exit occurs during initialization). These cases can all be accounted
2925 // for such that this method never returns NULL.
2926 const char* JavaThread::get_thread_name() const {
2927 #ifdef ASSERT
2928   // early safepoints can hit while current thread does not yet have TLS
2929   if (!SafepointSynchronize::is_at_safepoint()) {
2930     Thread *cur = Thread::current();
2931     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
2932       // Current JavaThreads are allowed to get their own name without
2933       // the Threads_lock.
2934       assert_locked_or_safepoint(Threads_lock);
2935     }
2936   }
2937 #endif // ASSERT
2938   return get_thread_name_string();
2939 }
2940 
2941 // Returns a non-NULL representation of this thread's name, or a suitable
2942 // descriptive string if there is no set name
2943 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
2944   const char* name_str;
2945   oop thread_obj = threadObj();
2946   if (thread_obj != NULL) {
2947     oop name = java_lang_Thread::name(thread_obj);
2948     if (name != NULL) {
2949       if (buf == NULL) {
2950         name_str = java_lang_String::as_utf8_string(name);
2951       } else {
2952         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
2953       }
2954     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
2955       name_str = "&lt;no-name - thread is attaching&gt;";
2956     } else {
2957       name_str = Thread::name();
2958     }
2959   } else {
2960     name_str = Thread::name();
2961   }
2962   assert(name_str != NULL, "unexpected NULL thread name");
2963   return name_str;
2964 }
2965 
2966 
2967 const char* JavaThread::get_threadgroup_name() const {
2968   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
2969   oop thread_obj = threadObj();
2970   if (thread_obj != NULL) {
2971     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
2972     if (thread_group != NULL) {
2973       // ThreadGroup.name can be null
2974       return java_lang_ThreadGroup::name(thread_group);
2975     }
2976   }
2977   return NULL;
2978 }
2979 
2980 const char* JavaThread::get_parent_name() const {
2981   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
2982   oop thread_obj = threadObj();
2983   if (thread_obj != NULL) {
2984     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
2985     if (thread_group != NULL) {
2986       oop parent = java_lang_ThreadGroup::parent(thread_group);
2987       if (parent != NULL) {
2988         // ThreadGroup.name can be null
2989         return java_lang_ThreadGroup::name(parent);
2990       }
2991     }
2992   }
2993   return NULL;
2994 }
2995 
2996 ThreadPriority JavaThread::java_priority() const {
2997   oop thr_oop = threadObj();
2998   if (thr_oop == NULL) return NormPriority; // Bootstrapping
2999   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3000   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3001   return priority;
3002 }
3003 
3004 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3005 
3006   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3007   // Link Java Thread object &lt;-&gt; C++ Thread
3008 
3009   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3010   // and put it into a new Handle.  The Handle "thread_oop" can then
3011   // be used to pass the C++ thread object to other methods.
3012 
3013   // Set the Java level thread object (jthread) field of the
3014   // new thread (a JavaThread *) to C++ thread object using the
3015   // "thread_oop" handle.
3016 
3017   // Set the thread field (a JavaThread *) of the
3018   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3019 
3020   Handle thread_oop(Thread::current(),
3021                     JNIHandles::resolve_non_null(jni_thread));
3022   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3023          "must be initialized");
3024   set_threadObj(thread_oop());
3025   java_lang_Thread::set_thread(thread_oop(), this);
3026 
3027   if (prio == NoPriority) {
3028     prio = java_lang_Thread::priority(thread_oop());
3029     assert(prio != NoPriority, "A valid priority should be present");
3030   }
3031 
3032   // Push the Java priority down to the native thread; needs Threads_lock
3033   Thread::set_priority(this, prio);
3034 
3035   prepare_ext();
3036 
3037   // Add the new thread to the Threads list and set it in motion.
3038   // We must have threads lock in order to call Threads::add.
3039   // It is crucial that we do not block before the thread is
3040   // added to the Threads list for if a GC happens, then the java_thread oop
3041   // will not be visited by GC.
3042   Threads::add(this);
3043 }
3044 
3045 oop JavaThread::current_park_blocker() {
3046   // Support for JSR-166 locks
3047   oop thread_oop = threadObj();
3048   if (thread_oop != NULL &amp;&amp;
3049       JDK_Version::current().supports_thread_park_blocker()) {
3050     return java_lang_Thread::park_blocker(thread_oop);
3051   }
3052   return NULL;
3053 }
3054 
3055 
3056 void JavaThread::print_stack_on(outputStream* st) {
3057   if (!has_last_Java_frame()) return;
3058   ResourceMark rm;
3059   HandleMark   hm;
3060 
3061   RegisterMap reg_map(this);
3062   vframe* start_vf = last_java_vframe(&amp;reg_map);
3063   int count = 0;
3064   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3065     if (f-&gt;is_java_frame()) {
3066       javaVFrame* jvf = javaVFrame::cast(f);
3067       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3068 
3069       // Print out lock information
3070       if (JavaMonitorsInStackTrace) {
3071         jvf-&gt;print_lock_info_on(st, count);
3072       }
3073     } else {
3074       // Ignore non-Java frames
3075     }
3076 
3077     // Bail-out case for too deep stacks
3078     count++;
3079     if (MaxJavaStackTraceDepth == count) return;
3080   }
3081 }
3082 
3083 
3084 // JVMTI PopFrame support
3085 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3086   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3087   if (in_bytes(size_in_bytes) != 0) {
3088     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3089     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3090     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3091   }
3092 }
3093 
3094 void* JavaThread::popframe_preserved_args() {
3095   return _popframe_preserved_args;
3096 }
3097 
3098 ByteSize JavaThread::popframe_preserved_args_size() {
3099   return in_ByteSize(_popframe_preserved_args_size);
3100 }
3101 
3102 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3103   int sz = in_bytes(popframe_preserved_args_size());
3104   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3105   return in_WordSize(sz / wordSize);
3106 }
3107 
3108 void JavaThread::popframe_free_preserved_args() {
3109   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3110   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3111   _popframe_preserved_args = NULL;
3112   _popframe_preserved_args_size = 0;
3113 }
3114 
3115 #ifndef PRODUCT
3116 
3117 void JavaThread::trace_frames() {
3118   tty-&gt;print_cr("[Describe stack]");
3119   int frame_no = 1;
3120   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3121     tty-&gt;print("  %d. ", frame_no++);
3122     fst.current()-&gt;print_value_on(tty, this);
3123     tty-&gt;cr();
3124   }
3125 }
3126 
3127 class PrintAndVerifyOopClosure: public OopClosure {
3128  protected:
3129   template &lt;class T&gt; inline void do_oop_work(T* p) {
3130     oop obj = oopDesc::load_decode_heap_oop(p);
3131     if (obj == NULL) return;
3132     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3133     if (obj-&gt;is_oop_or_null()) {
3134       if (obj-&gt;is_objArray()) {
3135         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3136       } else {
3137         obj-&gt;print();
3138       }
3139     } else {
3140       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3141     }
3142     tty-&gt;cr();
3143   }
3144  public:
3145   virtual void do_oop(oop* p) { do_oop_work(p); }
3146   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3147 };
3148 
3149 
3150 static void oops_print(frame* f, const RegisterMap *map) {
3151   PrintAndVerifyOopClosure print;
3152   f-&gt;print_value();
3153   f-&gt;oops_do(&amp;print, NULL, NULL, (RegisterMap*)map);
3154 }
3155 
3156 // Print our all the locations that contain oops and whether they are
3157 // valid or not.  This useful when trying to find the oldest frame
3158 // where an oop has gone bad since the frame walk is from youngest to
3159 // oldest.
3160 void JavaThread::trace_oops() {
3161   tty-&gt;print_cr("[Trace oops]");
3162   frames_do(oops_print);
3163 }
3164 
3165 
3166 #ifdef ASSERT
3167 // Print or validate the layout of stack frames
3168 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3169   ResourceMark rm;
3170   PRESERVE_EXCEPTION_MARK;
3171   FrameValues values;
3172   int frame_no = 0;
3173   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3174     fst.current()-&gt;describe(values, ++frame_no);
3175     if (depth == frame_no) break;
3176   }
3177   if (validate_only) {
3178     values.validate();
3179   } else {
3180     tty-&gt;print_cr("[Describe stack layout]");
3181     values.print(this);
3182   }
3183 }
3184 #endif
3185 
3186 void JavaThread::trace_stack_from(vframe* start_vf) {
3187   ResourceMark rm;
3188   int vframe_no = 1;
3189   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3190     if (f-&gt;is_java_frame()) {
3191       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3192     } else {
3193       f-&gt;print();
3194     }
3195     if (vframe_no &gt; StackPrintLimit) {
3196       tty-&gt;print_cr("...&lt;more frames&gt;...");
3197       return;
3198     }
3199   }
3200 }
3201 
3202 
3203 void JavaThread::trace_stack() {
3204   if (!has_last_Java_frame()) return;
3205   ResourceMark rm;
3206   HandleMark   hm;
3207   RegisterMap reg_map(this);
3208   trace_stack_from(last_java_vframe(&amp;reg_map));
3209 }
3210 
3211 
3212 #endif // PRODUCT
3213 
3214 
3215 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3216   assert(reg_map != NULL, "a map must be given");
3217   frame f = last_frame();
3218   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3219     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3220   }
3221   return NULL;
3222 }
3223 
3224 
3225 Klass* JavaThread::security_get_caller_class(int depth) {
3226   vframeStream vfst(this);
3227   vfst.security_get_caller_frame(depth);
3228   if (!vfst.at_end()) {
3229     return vfst.method()-&gt;method_holder();
3230   }
3231   return NULL;
3232 }
3233 
3234 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3235   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3236   CompileBroker::compiler_thread_loop();
3237 }
3238 
3239 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3240   NMethodSweeper::sweeper_loop();
3241 }
3242 
3243 // Create a CompilerThread
3244 CompilerThread::CompilerThread(CompileQueue* queue,
3245                                CompilerCounters* counters)
3246                                : JavaThread(&amp;compiler_thread_entry) {
3247   _env   = NULL;
3248   _log   = NULL;
3249   _task  = NULL;
3250   _queue = queue;
3251   _counters = counters;
3252   _buffer_blob = NULL;
3253   _compiler = NULL;
3254 
3255 #ifndef PRODUCT
3256   _ideal_graph_printer = NULL;
3257 #endif
3258 }
3259 
3260 bool CompilerThread::can_call_java() const {
3261   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3262 }
3263 
3264 // Create sweeper thread
3265 CodeCacheSweeperThread::CodeCacheSweeperThread()
3266 : JavaThread(&amp;sweeper_thread_entry) {
3267   _scanned_nmethod = NULL;
3268 }
3269 void CodeCacheSweeperThread::oops_do(OopClosure* f, CLDClosure* cld_f, CodeBlobClosure* cf) {
3270   JavaThread::oops_do(f, cld_f, cf);
3271   if (_scanned_nmethod != NULL &amp;&amp; cf != NULL) {
3272     // Safepoints can occur when the sweeper is scanning an nmethod so
3273     // process it here to make sure it isn't unloaded in the middle of
3274     // a scan.
3275     cf-&gt;do_code_blob(_scanned_nmethod);
3276   }
3277 }
3278 
3279 
3280 // ======= Threads ========
3281 
3282 // The Threads class links together all active threads, and provides
3283 // operations over all threads.  It is protected by its own Mutex
3284 // lock, which is also used in other contexts to protect thread
3285 // operations from having the thread being operated on from exiting
3286 // and going away unexpectedly (e.g., safepoint synchronization)
3287 
3288 JavaThread* Threads::_thread_list = NULL;
3289 int         Threads::_number_of_threads = 0;
3290 int         Threads::_number_of_non_daemon_threads = 0;
3291 int         Threads::_return_code = 0;
3292 int         Threads::_thread_claim_parity = 0;
3293 size_t      JavaThread::_stack_size_at_create = 0;
3294 #ifdef ASSERT
3295 bool        Threads::_vm_complete = false;
3296 #endif
3297 
3298 // All JavaThreads
3299 #define ALL_JAVA_THREADS(X) for (JavaThread* X = _thread_list; X; X = X-&gt;next())
3300 
3301 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system)
3302 void Threads::threads_do(ThreadClosure* tc) {
3303   assert_locked_or_safepoint(Threads_lock);
3304   // ALL_JAVA_THREADS iterates through all JavaThreads
3305   ALL_JAVA_THREADS(p) {
3306     tc-&gt;do_thread(p);
3307   }
3308   // Someday we could have a table or list of all non-JavaThreads.
3309   // For now, just manually iterate through them.
3310   tc-&gt;do_thread(VMThread::vm_thread());
3311   Universe::heap()-&gt;gc_threads_do(tc);
3312   WatcherThread *wt = WatcherThread::watcher_thread();
3313   // Strictly speaking, the following NULL check isn't sufficient to make sure
3314   // the data for WatcherThread is still valid upon being examined. However,
3315   // considering that WatchThread terminates when the VM is on the way to
3316   // exit at safepoint, the chance of the above is extremely small. The right
3317   // way to prevent termination of WatcherThread would be to acquire
3318   // Terminator_lock, but we can't do that without violating the lock rank
3319   // checking in some cases.
3320   if (wt != NULL) {
3321     tc-&gt;do_thread(wt);
3322   }
3323 
3324   // If CompilerThreads ever become non-JavaThreads, add them here
3325 }
3326 
3327 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3328   TraceTime timer("Initialize java.lang classes", TraceStartupTime);
3329 
3330   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3331     create_vm_init_libraries();
3332   }
3333 
3334   initialize_class(vmSymbols::java_lang_String(), CHECK);
3335 
3336   // Inject CompactStrings value after the static initializers for String ran.
3337   java_lang_String::set_compact_strings(CompactStrings);
3338 
3339   // Initialize java_lang.System (needed before creating the thread)
3340   initialize_class(vmSymbols::java_lang_System(), CHECK);
3341   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3342   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3343   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3344   Handle thread_group = create_initial_thread_group(CHECK);
3345   Universe::set_main_thread_group(thread_group());
3346   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3347   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3348   main_thread-&gt;set_threadObj(thread_object);
3349   // Set thread status to running since main thread has
3350   // been started and running.
3351   java_lang_Thread::set_thread_status(thread_object,
3352                                       java_lang_Thread::RUNNABLE);
3353 
3354   // The VM preresolves methods to these classes. Make sure that they get initialized
3355   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3356   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3357   call_initializeSystemClass(CHECK);
3358 
3359   // get the Java runtime name after java.lang.System is initialized
3360   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3361   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3362 
3363   // an instance of OutOfMemory exception has been allocated earlier
3364   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3365   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3366   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3367   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3368   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3369   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3370   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3371   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3372 }
3373 
3374 void Threads::initialize_jsr292_core_classes(TRAPS) {
3375   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3376   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3377   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3378 }
3379 
3380 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3381   extern void JDK_Version_init();
3382 
3383   // Preinitialize version info.
3384   VM_Version::early_initialize();
3385 
3386   // Check version
3387   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3388 
3389   // Initialize the output stream module
3390   ostream_init();
3391 
3392   // Process java launcher properties.
3393   Arguments::process_sun_java_launcher_properties(args);
3394 
3395   // Initialize the os module before using TLS
3396   os::init();
3397 
3398   // Record VM creation timing statistics
3399   TraceVmCreationTime create_vm_timer;
3400   create_vm_timer.start();
3401 
3402   // Initialize system properties.
3403   Arguments::init_system_properties();
3404 
3405   // So that JDK version can be used as a discriminator when parsing arguments
3406   JDK_Version_init();
3407 
3408   // Update/Initialize System properties after JDK version number is known
3409   Arguments::init_version_specific_system_properties();
3410 
3411   // Make sure to initialize log configuration *before* parsing arguments
3412   LogConfiguration::initialize(create_vm_timer.begin_time());
3413 
3414   // Parse arguments
3415   jint parse_result = Arguments::parse(args);
3416   if (parse_result != JNI_OK) return parse_result;
3417 
3418   os::init_before_ergo();
3419 
3420   jint ergo_result = Arguments::apply_ergo();
3421   if (ergo_result != JNI_OK) return ergo_result;
3422 
3423   // Final check of all ranges after ergonomics which may change values.
3424   if (!CommandLineFlagRangeList::check_ranges()) {
3425     return JNI_EINVAL;
3426   }
3427 
3428   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3429   bool constraint_result = CommandLineFlagConstraintList::check_constraints(CommandLineFlagConstraint::AfterErgo);
3430   if (!constraint_result) {
3431     return JNI_EINVAL;
3432   }
3433 
3434   if (PauseAtStartup) {
3435     os::pause();
3436   }
3437 
3438   HOTSPOT_VM_INIT_BEGIN();
3439 
3440   // Timing (must come after argument parsing)
3441   TraceTime timer("Create VM", TraceStartupTime);
3442 
3443   // Initialize the os module after parsing the args
3444   jint os_init_2_result = os::init_2();
3445   if (os_init_2_result != JNI_OK) return os_init_2_result;
3446 
3447   jint adjust_after_os_result = Arguments::adjust_after_os();
3448   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3449 
3450   // Initialize library-based TLS
3451   ThreadLocalStorage::init();
3452 
3453   // Initialize output stream logging
3454   ostream_init_log();
3455 
3456   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3457   // Must be before create_vm_init_agents()
3458   if (Arguments::init_libraries_at_startup()) {
3459     convert_vm_init_libraries_to_agents();
3460   }
3461 
3462   // Launch -agentlib/-agentpath and converted -Xrun agents
3463   if (Arguments::init_agents_at_startup()) {
3464     create_vm_init_agents();
3465   }
3466 
3467   // Initialize Threads state
3468   _thread_list = NULL;
3469   _number_of_threads = 0;
3470   _number_of_non_daemon_threads = 0;
3471 
3472   // Initialize global data structures and create system classes in heap
3473   vm_init_globals();
3474 
3475 #if INCLUDE_JVMCI
3476   if (JVMCICounterSize &gt; 0) {
3477     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3478     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3479   } else {
3480     JavaThread::_jvmci_old_thread_counters = NULL;
3481   }
3482 #endif // INCLUDE_JVMCI
3483 
3484   // Attach the main thread to this os thread
3485   JavaThread* main_thread = new JavaThread();
3486   main_thread-&gt;set_thread_state(_thread_in_vm);
3487   main_thread-&gt;initialize_thread_current();
3488   // must do this before set_active_handles
3489   main_thread-&gt;record_stack_base_and_size();
3490   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3491 
3492   if (!main_thread-&gt;set_as_starting_thread()) {
3493     vm_shutdown_during_initialization(
3494                                       "Failed necessary internal allocation. Out of swap space");
3495     delete main_thread;
3496     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3497     return JNI_ENOMEM;
3498   }
3499 
3500   // Enable guard page *after* os::create_main_thread(), otherwise it would
3501   // crash Linux VM, see notes in os_linux.cpp.
3502   main_thread-&gt;create_stack_guard_pages();
3503 
3504   // Initialize Java-Level synchronization subsystem
3505   ObjectMonitor::Initialize();
3506 
3507   // Initialize global modules
3508   jint status = init_globals();
3509   if (status != JNI_OK) {
3510     delete main_thread;
3511     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3512     return status;
3513   }
3514 
3515   // Should be done after the heap is fully created
3516   main_thread-&gt;cache_global_variables();
3517 
3518   HandleMark hm;
3519 
3520   { MutexLocker mu(Threads_lock);
3521     Threads::add(main_thread);
3522   }
3523 
3524   // Any JVMTI raw monitors entered in onload will transition into
3525   // real raw monitor. VM is setup enough here for raw monitor enter.
3526   JvmtiExport::transition_pending_onload_raw_monitors();
3527 
3528   // Create the VMThread
3529   { TraceTime timer("Start VMThread", TraceStartupTime);
3530     VMThread::create();
3531     Thread* vmthread = VMThread::vm_thread();
3532 
3533     if (!os::create_thread(vmthread, os::vm_thread)) {
3534       vm_exit_during_initialization("Cannot create VM thread. "
3535                                     "Out of system resources.");
3536     }
3537 
3538     // Wait for the VM thread to become ready, and VMThread::run to initialize
3539     // Monitors can have spurious returns, must always check another state flag
3540     {
3541       MutexLocker ml(Notify_lock);
3542       os::start_thread(vmthread);
3543       while (vmthread-&gt;active_handles() == NULL) {
3544         Notify_lock-&gt;wait();
3545       }
3546     }
3547   }
3548 
3549   assert(Universe::is_fully_initialized(), "not initialized");
3550   if (VerifyDuringStartup) {
3551     // Make sure we're starting with a clean slate.
3552     VM_Verify verify_op;
3553     VMThread::execute(&amp;verify_op);
3554   }
3555 
3556   Thread* THREAD = Thread::current();
3557 
3558   // At this point, the Universe is initialized, but we have not executed
3559   // any byte code.  Now is a good time (the only time) to dump out the
3560   // internal state of the JVM for sharing.
3561   if (DumpSharedSpaces) {
3562     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3563     ShouldNotReachHere();
3564   }
3565 
3566   // Always call even when there are not JVMTI environments yet, since environments
3567   // may be attached late and JVMTI must track phases of VM execution
3568   JvmtiExport::enter_start_phase();
3569 
3570   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3571   JvmtiExport::post_vm_start();
3572 
3573   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3574 
3575   // We need this for ClassDataSharing - the initial vm.info property is set
3576   // with the default value of CDS "sharing" which may be reset through
3577   // command line options.
3578   reset_vm_info_property(CHECK_JNI_ERR);
3579 
3580   quicken_jni_functions();
3581 
3582   // Must be run after init_ft which initializes ft_enabled
3583   if (TRACE_INITIALIZE() != JNI_OK) {
3584     vm_exit_during_initialization("Failed to initialize tracing backend");
3585   }
3586 
3587   // Set flag that basic initialization has completed. Used by exceptions and various
3588   // debug stuff, that does not work until all basic classes have been initialized.
3589   set_init_completed();
3590 
3591   LogConfiguration::post_initialize();
3592   Metaspace::post_initialize();
3593 
3594   HOTSPOT_VM_INIT_END();
3595 
3596   // record VM initialization completion time
3597 #if INCLUDE_MANAGEMENT
3598   Management::record_vm_init_completed();
3599 #endif // INCLUDE_MANAGEMENT
3600 
3601   // Compute system loader. Note that this has to occur after set_init_completed, since
3602   // valid exceptions may be thrown in the process.
3603   // Note that we do not use CHECK_0 here since we are inside an EXCEPTION_MARK and
3604   // set_init_completed has just been called, causing exceptions not to be shortcut
3605   // anymore. We call vm_exit_during_initialization directly instead.
3606   SystemDictionary::compute_java_system_loader(CHECK_(JNI_ERR));
3607 
3608 #if INCLUDE_ALL_GCS
3609   // Support for ConcurrentMarkSweep. This should be cleaned up
3610   // and better encapsulated. The ugly nested if test would go away
3611   // once things are properly refactored. XXX YSR
3612   if (UseConcMarkSweepGC || UseG1GC) {
3613     if (UseConcMarkSweepGC) {
3614       ConcurrentMarkSweepThread::makeSurrogateLockerThread(CHECK_JNI_ERR);
3615     } else {
3616       ConcurrentMarkThread::makeSurrogateLockerThread(CHECK_JNI_ERR);
3617     }
3618   }
3619 #endif // INCLUDE_ALL_GCS
3620 
3621   // Always call even when there are not JVMTI environments yet, since environments
3622   // may be attached late and JVMTI must track phases of VM execution
3623   JvmtiExport::enter_live_phase();
3624 
3625   // Signal Dispatcher needs to be started before VMInit event is posted
3626   os::signal_init();
3627 
3628   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3629   if (!DisableAttachMechanism) {
3630     AttachListener::vm_start();
3631     if (StartAttachListener || AttachListener::init_at_startup()) {
3632       AttachListener::init();
3633     }
3634   }
3635 
3636   // Launch -Xrun agents
3637   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3638   // back-end can launch with -Xdebug -Xrunjdwp.
3639   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3640     create_vm_init_libraries();
3641   }
3642 
3643   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3644   JvmtiExport::post_vm_initialized();
3645 
3646   if (TRACE_START() != JNI_OK) {
3647     vm_exit_during_initialization("Failed to start tracing backend.");
3648   }
3649 
3650   if (CleanChunkPoolAsync) {
3651     Chunk::start_chunk_pool_cleaner_task();
3652   }
3653 
3654 #if INCLUDE_JVMCI
3655   if (EnableJVMCI) {
3656     const char* jvmciCompiler = Arguments::PropertyList_get_value(Arguments::system_properties(), "jvmci.compiler");
3657     if (jvmciCompiler != NULL) {
3658       JVMCIRuntime::save_compiler(jvmciCompiler);
3659     }
3660   }
3661 #endif // INCLUDE_JVMCI
3662 
3663   // initialize compiler(s)
3664 #if defined(COMPILER1) || defined(COMPILER2) || defined(SHARK) || INCLUDE_JVMCI
3665   CompileBroker::compilation_init(CHECK_JNI_ERR);
3666 #endif
3667 
3668   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3669   // It is done after compilers are initialized, because otherwise compilations of
3670   // signature polymorphic MH intrinsics can be missed
3671   // (see SystemDictionary::find_method_handle_intrinsic).
3672   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3673 
3674 #if INCLUDE_MANAGEMENT
3675   Management::initialize(THREAD);
3676 
3677   if (HAS_PENDING_EXCEPTION) {
3678     // management agent fails to start possibly due to
3679     // configuration problem and is responsible for printing
3680     // stack trace if appropriate. Simply exit VM.
3681     vm_exit(1);
3682   }
3683 #endif // INCLUDE_MANAGEMENT
3684 
3685   if (Arguments::has_profile())       FlatProfiler::engage(main_thread, true);
3686   if (MemProfiling)                   MemProfiler::engage();
3687   StatSampler::engage();
3688   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3689 
3690   BiasedLocking::init();
3691 
3692 #if INCLUDE_RTM_OPT
3693   RTMLockingCounters::init();
3694 #endif
3695 
3696   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3697     call_postVMInitHook(THREAD);
3698     // The Java side of PostVMInitHook.run must deal with all
3699     // exceptions and provide means of diagnosis.
3700     if (HAS_PENDING_EXCEPTION) {
3701       CLEAR_PENDING_EXCEPTION;
3702     }
3703   }
3704 
3705   {
3706     MutexLocker ml(PeriodicTask_lock);
3707     // Make sure the WatcherThread can be started by WatcherThread::start()
3708     // or by dynamic enrollment.
3709     WatcherThread::make_startable();
3710     // Start up the WatcherThread if there are any periodic tasks
3711     // NOTE:  All PeriodicTasks should be registered by now. If they
3712     //   aren't, late joiners might appear to start slowly (we might
3713     //   take a while to process their first tick).
3714     if (PeriodicTask::num_tasks() &gt; 0) {
3715       WatcherThread::start();
3716     }
3717   }
3718 
3719   CodeCacheExtensions::complete_step(CodeCacheExtensionsSteps::CreateVM);
3720 
3721   create_vm_timer.end();
3722 #ifdef ASSERT
3723   _vm_complete = true;
3724 #endif
3725   return JNI_OK;
3726 }
3727 
3728 // type for the Agent_OnLoad and JVM_OnLoad entry points
3729 extern "C" {
3730   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3731 }
3732 // Find a command line agent library and return its entry point for
3733 //         -agentlib:  -agentpath:   -Xrun
3734 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3735 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3736                                     const char *on_load_symbols[],
3737                                     size_t num_symbol_entries) {
3738   OnLoadEntry_t on_load_entry = NULL;
3739   void *library = NULL;
3740 
3741   if (!agent-&gt;valid()) {
3742     char buffer[JVM_MAXPATHLEN];
3743     char ebuf[1024] = "";
3744     const char *name = agent-&gt;name();
3745     const char *msg = "Could not find agent library ";
3746 
3747     // First check to see if agent is statically linked into executable
3748     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3749       library = agent-&gt;os_lib();
3750     } else if (agent-&gt;is_absolute_path()) {
3751       library = os::dll_load(name, ebuf, sizeof ebuf);
3752       if (library == NULL) {
3753         const char *sub_msg = " in absolute path, with error: ";
3754         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3755         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3756         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3757         // If we can't find the agent, exit.
3758         vm_exit_during_initialization(buf, NULL);
3759         FREE_C_HEAP_ARRAY(char, buf);
3760       }
3761     } else {
3762       // Try to load the agent from the standard dll directory
3763       if (os::dll_build_name(buffer, sizeof(buffer), Arguments::get_dll_dir(),
3764                              name)) {
3765         library = os::dll_load(buffer, ebuf, sizeof ebuf);
3766       }
3767       if (library == NULL) { // Try the local directory
3768         char ns[1] = {0};
3769         if (os::dll_build_name(buffer, sizeof(buffer), ns, name)) {
3770           library = os::dll_load(buffer, ebuf, sizeof ebuf);
3771         }
3772         if (library == NULL) {
3773           const char *sub_msg = " on the library path, with error: ";
3774           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3775           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3776           jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3777           // If we can't find the agent, exit.
3778           vm_exit_during_initialization(buf, NULL);
3779           FREE_C_HEAP_ARRAY(char, buf);
3780         }
3781       }
3782     }
3783     agent-&gt;set_os_lib(library);
3784     agent-&gt;set_valid();
3785   }
3786 
3787   // Find the OnLoad function.
3788   on_load_entry =
3789     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
3790                                                           false,
3791                                                           on_load_symbols,
3792                                                           num_symbol_entries));
3793   return on_load_entry;
3794 }
3795 
3796 // Find the JVM_OnLoad entry point
3797 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
3798   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
3799   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3800 }
3801 
3802 // Find the Agent_OnLoad entry point
3803 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
3804   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
3805   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3806 }
3807 
3808 // For backwards compatibility with -Xrun
3809 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
3810 // treated like -agentpath:
3811 // Must be called before agent libraries are created
3812 void Threads::convert_vm_init_libraries_to_agents() {
3813   AgentLibrary* agent;
3814   AgentLibrary* next;
3815 
3816   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
3817     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
3818     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
3819 
3820     // If there is an JVM_OnLoad function it will get called later,
3821     // otherwise see if there is an Agent_OnLoad
3822     if (on_load_entry == NULL) {
3823       on_load_entry = lookup_agent_on_load(agent);
3824       if (on_load_entry != NULL) {
3825         // switch it to the agent list -- so that Agent_OnLoad will be called,
3826         // JVM_OnLoad won't be attempted and Agent_OnUnload will
3827         Arguments::convert_library_to_agent(agent);
3828       } else {
3829         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
3830       }
3831     }
3832   }
3833 }
3834 
3835 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
3836 // Invokes Agent_OnLoad
3837 // Called very early -- before JavaThreads exist
3838 void Threads::create_vm_init_agents() {
3839   extern struct JavaVM_ main_vm;
3840   AgentLibrary* agent;
3841 
3842   JvmtiExport::enter_onload_phase();
3843 
3844   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3845     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
3846 
3847     if (on_load_entry != NULL) {
3848       // Invoke the Agent_OnLoad function
3849       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
3850       if (err != JNI_OK) {
3851         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
3852       }
3853     } else {
3854       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
3855     }
3856   }
3857   JvmtiExport::enter_primordial_phase();
3858 }
3859 
3860 extern "C" {
3861   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
3862 }
3863 
3864 void Threads::shutdown_vm_agents() {
3865   // Send any Agent_OnUnload notifications
3866   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
3867   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
3868   extern struct JavaVM_ main_vm;
3869   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3870 
3871     // Find the Agent_OnUnload function.
3872     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
3873                                                    os::find_agent_function(agent,
3874                                                    false,
3875                                                    on_unload_symbols,
3876                                                    num_symbol_entries));
3877 
3878     // Invoke the Agent_OnUnload function
3879     if (unload_entry != NULL) {
3880       JavaThread* thread = JavaThread::current();
3881       ThreadToNativeFromVM ttn(thread);
3882       HandleMark hm(thread);
3883       (*unload_entry)(&amp;main_vm);
3884     }
3885   }
3886 }
3887 
3888 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
3889 // Invokes JVM_OnLoad
3890 void Threads::create_vm_init_libraries() {
3891   extern struct JavaVM_ main_vm;
3892   AgentLibrary* agent;
3893 
3894   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
3895     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
3896 
3897     if (on_load_entry != NULL) {
3898       // Invoke the JVM_OnLoad function
3899       JavaThread* thread = JavaThread::current();
3900       ThreadToNativeFromVM ttn(thread);
3901       HandleMark hm(thread);
3902       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
3903       if (err != JNI_OK) {
3904         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
3905       }
3906     } else {
3907       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
3908     }
3909   }
3910 }
3911 
3912 JavaThread* Threads::find_java_thread_from_java_tid(jlong java_tid) {
3913   assert(Threads_lock-&gt;owned_by_self(), "Must hold Threads_lock");
3914 
3915   JavaThread* java_thread = NULL;
3916   // Sequential search for now.  Need to do better optimization later.
3917   for (JavaThread* thread = Threads::first(); thread != NULL; thread = thread-&gt;next()) {
3918     oop tobj = thread-&gt;threadObj();
3919     if (!thread-&gt;is_exiting() &amp;&amp;
3920         tobj != NULL &amp;&amp;
3921         java_tid == java_lang_Thread::thread_id(tobj)) {
3922       java_thread = thread;
3923       break;
3924     }
3925   }
3926   return java_thread;
3927 }
3928 
3929 
3930 // Last thread running calls java.lang.Shutdown.shutdown()
3931 void JavaThread::invoke_shutdown_hooks() {
3932   HandleMark hm(this);
3933 
3934   // We could get here with a pending exception, if so clear it now.
3935   if (this-&gt;has_pending_exception()) {
3936     this-&gt;clear_pending_exception();
3937   }
3938 
3939   EXCEPTION_MARK;
3940   Klass* k =
3941     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
3942                                       THREAD);
3943   if (k != NULL) {
3944     // SystemDictionary::resolve_or_null will return null if there was
3945     // an exception.  If we cannot load the Shutdown class, just don't
3946     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
3947     // and finalizers (if runFinalizersOnExit is set) won't be run.
3948     // Note that if a shutdown hook was registered or runFinalizersOnExit
3949     // was called, the Shutdown class would have already been loaded
3950     // (Runtime.addShutdownHook and runFinalizersOnExit will load it).
3951     instanceKlassHandle shutdown_klass (THREAD, k);
3952     JavaValue result(T_VOID);
3953     JavaCalls::call_static(&amp;result,
3954                            shutdown_klass,
3955                            vmSymbols::shutdown_method_name(),
3956                            vmSymbols::void_method_signature(),
3957                            THREAD);
3958   }
3959   CLEAR_PENDING_EXCEPTION;
3960 }
3961 
3962 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
3963 // the program falls off the end of main(). Another VM exit path is through
3964 // vm_exit() when the program calls System.exit() to return a value or when
3965 // there is a serious error in VM. The two shutdown paths are not exactly
3966 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
3967 // and VM_Exit op at VM level.
3968 //
3969 // Shutdown sequence:
3970 //   + Shutdown native memory tracking if it is on
3971 //   + Wait until we are the last non-daemon thread to execute
3972 //     &lt;-- every thing is still working at this moment --&gt;
3973 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
3974 //        shutdown hooks, run finalizers if finalization-on-exit
3975 //   + Call before_exit(), prepare for VM exit
3976 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
3977 //        currently the only user of this mechanism is File.deleteOnExit())
3978 //      &gt; stop flat profiler, StatSampler, watcher thread, CMS threads,
3979 //        post thread end and vm death events to JVMTI,
3980 //        stop signal thread
3981 //   + Call JavaThread::exit(), it will:
3982 //      &gt; release JNI handle blocks, remove stack guard pages
3983 //      &gt; remove this thread from Threads list
3984 //     &lt;-- no more Java code from this thread after this point --&gt;
3985 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
3986 //     the compiler threads at safepoint
3987 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
3988 //   + Disable tracing at JNI/JVM barriers
3989 //   + Set _vm_exited flag for threads that are still running native code
3990 //   + Delete this thread
3991 //   + Call exit_globals()
3992 //      &gt; deletes tty
3993 //      &gt; deletes PerfMemory resources
3994 //   + Return to caller
3995 
3996 bool Threads::destroy_vm() {
3997   JavaThread* thread = JavaThread::current();
3998 
3999 #ifdef ASSERT
4000   _vm_complete = false;
4001 #endif
4002   // Wait until we are the last non-daemon thread to execute
4003   { MutexLocker nu(Threads_lock);
4004     while (Threads::number_of_non_daemon_threads() &gt; 1)
4005       // This wait should make safepoint checks, wait without a timeout,
4006       // and wait as a suspend-equivalent condition.
4007       //
4008       // Note: If the FlatProfiler is running and this thread is waiting
4009       // for another non-daemon thread to finish, then the FlatProfiler
4010       // is waiting for the external suspend request on this thread to
4011       // complete. wait_for_ext_suspend_completion() will eventually
4012       // timeout, but that takes time. Making this wait a suspend-
4013       // equivalent condition solves that timeout problem.
4014       //
4015       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4016                          Mutex::_as_suspend_equivalent_flag);
4017   }
4018 
4019   // Hang forever on exit if we are reporting an error.
4020   if (ShowMessageBoxOnError &amp;&amp; is_error_reported()) {
4021     os::infinite_sleep();
4022   }
4023   os::wait_for_keypress_at_exit();
4024 
4025   // run Java level shutdown hooks
4026   thread-&gt;invoke_shutdown_hooks();
4027 
4028   before_exit(thread);
4029 
4030   thread-&gt;exit(true);
4031 
4032   // Stop VM thread.
4033   {
4034     // 4945125 The vm thread comes to a safepoint during exit.
4035     // GC vm_operations can get caught at the safepoint, and the
4036     // heap is unparseable if they are caught. Grab the Heap_lock
4037     // to prevent this. The GC vm_operations will not be able to
4038     // queue until after the vm thread is dead. After this point,
4039     // we'll never emerge out of the safepoint before the VM exits.
4040 
4041     MutexLocker ml(Heap_lock);
4042 
4043     VMThread::wait_for_vm_thread_exit();
4044     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4045     VMThread::destroy();
4046   }
4047 
4048   // clean up ideal graph printers
4049 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4050   IdealGraphPrinter::clean_up();
4051 #endif
4052 
4053   // Now, all Java threads are gone except daemon threads. Daemon threads
4054   // running Java code or in VM are stopped by the Safepoint. However,
4055   // daemon threads executing native code are still running.  But they
4056   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4057   // simply kill or suspend them, as it is inherently deadlock-prone.
4058 
4059   VM_Exit::set_vm_exited();
4060 
4061   notify_vm_shutdown();
4062 
4063   delete thread;
4064 
4065 #if INCLUDE_JVMCI
4066   if (JVMCICounterSize &gt; 0) {
4067     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4068   }
4069 #endif
4070 
4071   // exit_globals() will delete tty
4072   exit_globals();
4073 
4074   LogConfiguration::finalize();
4075 
4076   return true;
4077 }
4078 
4079 
4080 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4081   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4082   return is_supported_jni_version(version);
4083 }
4084 
4085 
4086 jboolean Threads::is_supported_jni_version(jint version) {
4087   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4088   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4089   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4090   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4091   return JNI_FALSE;
4092 }
4093 
4094 
4095 void Threads::add(JavaThread* p, bool force_daemon) {
4096   // The threads lock must be owned at this point
4097   assert_locked_or_safepoint(Threads_lock);
4098 
4099   // See the comment for this method in thread.hpp for its purpose and
4100   // why it is called here.
4101   p-&gt;initialize_queues();
4102   p-&gt;set_next(_thread_list);
4103   _thread_list = p;
4104   _number_of_threads++;
4105   oop threadObj = p-&gt;threadObj();
4106   bool daemon = true;
4107   // Bootstrapping problem: threadObj can be null for initial
4108   // JavaThread (or for threads attached via JNI)
4109   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4110     _number_of_non_daemon_threads++;
4111     daemon = false;
4112   }
4113 
4114   ThreadService::add_thread(p, daemon);
4115 
4116   // Possible GC point.
4117   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4118 }
4119 
4120 void Threads::remove(JavaThread* p) {
4121   // Extra scope needed for Thread_lock, so we can check
4122   // that we do not remove thread without safepoint code notice
4123   { MutexLocker ml(Threads_lock);
4124 
4125     assert(includes(p), "p must be present");
4126 
4127     JavaThread* current = _thread_list;
4128     JavaThread* prev    = NULL;
4129 
4130     while (current != p) {
4131       prev    = current;
4132       current = current-&gt;next();
4133     }
4134 
4135     if (prev) {
4136       prev-&gt;set_next(current-&gt;next());
4137     } else {
4138       _thread_list = p-&gt;next();
4139     }
4140     _number_of_threads--;
4141     oop threadObj = p-&gt;threadObj();
4142     bool daemon = true;
4143     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4144       _number_of_non_daemon_threads--;
4145       daemon = false;
4146 
4147       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4148       // on destroy_vm will wake up.
4149       if (number_of_non_daemon_threads() == 1) {
4150         Threads_lock-&gt;notify_all();
4151       }
4152     }
4153     ThreadService::remove_thread(p, daemon);
4154 
4155     // Make sure that safepoint code disregard this thread. This is needed since
4156     // the thread might mess around with locks after this point. This can cause it
4157     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4158     // of this thread since it is removed from the queue.
4159     p-&gt;set_terminated_value();
4160   } // unlock Threads_lock
4161 
4162   // Since Events::log uses a lock, we grab it outside the Threads_lock
4163   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4164 }
4165 
4166 // Threads_lock must be held when this is called (or must be called during a safepoint)
4167 bool Threads::includes(JavaThread* p) {
4168   assert(Threads_lock-&gt;is_locked(), "sanity check");
4169   ALL_JAVA_THREADS(q) {
4170     if (q == p) {
4171       return true;
4172     }
4173   }
4174   return false;
4175 }
4176 
4177 // Operations on the Threads list for GC.  These are not explicitly locked,
4178 // but the garbage collector must provide a safe context for them to run.
4179 // In particular, these things should never be called when the Threads_lock
4180 // is held by some other thread. (Note: the Safepoint abstraction also
4181 // uses the Threads_lock to guarantee this property. It also makes sure that
4182 // all threads gets blocked when exiting or starting).
4183 
4184 void Threads::oops_do(OopClosure* f, CLDClosure* cld_f, CodeBlobClosure* cf) {
4185   ALL_JAVA_THREADS(p) {
4186     p-&gt;oops_do(f, cld_f, cf);
4187   }
4188   VMThread::vm_thread()-&gt;oops_do(f, cld_f, cf);
4189 }
4190 
4191 void Threads::change_thread_claim_parity() {
4192   // Set the new claim parity.
4193   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4194          "Not in range.");
4195   _thread_claim_parity++;
4196   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4197   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4198          "Not in range.");
4199 }
4200 
4201 #ifdef ASSERT
4202 void Threads::assert_all_threads_claimed() {
4203   ALL_JAVA_THREADS(p) {
4204     const int thread_parity = p-&gt;oops_do_parity();
4205     assert((thread_parity == _thread_claim_parity),
4206            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4207   }
4208 }
4209 #endif // ASSERT
4210 
4211 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CLDClosure* cld_f, CodeBlobClosure* cf) {
4212   int cp = Threads::thread_claim_parity();
4213   ALL_JAVA_THREADS(p) {
4214     if (p-&gt;claim_oops_do(is_par, cp)) {
4215       p-&gt;oops_do(f, cld_f, cf);
4216     }
4217   }
4218   VMThread* vmt = VMThread::vm_thread();
4219   if (vmt-&gt;claim_oops_do(is_par, cp)) {
4220     vmt-&gt;oops_do(f, cld_f, cf);
4221   }
4222 }
4223 
4224 #if INCLUDE_ALL_GCS
4225 // Used by ParallelScavenge
4226 void Threads::create_thread_roots_tasks(GCTaskQueue* q) {
4227   ALL_JAVA_THREADS(p) {
4228     q-&gt;enqueue(new ThreadRootsTask(p));
4229   }
4230   q-&gt;enqueue(new ThreadRootsTask(VMThread::vm_thread()));
4231 }
4232 
4233 // Used by Parallel Old
4234 void Threads::create_thread_roots_marking_tasks(GCTaskQueue* q) {
4235   ALL_JAVA_THREADS(p) {
4236     q-&gt;enqueue(new ThreadRootsMarkingTask(p));
4237   }
4238   q-&gt;enqueue(new ThreadRootsMarkingTask(VMThread::vm_thread()));
4239 }
4240 #endif // INCLUDE_ALL_GCS
4241 
4242 void Threads::nmethods_do(CodeBlobClosure* cf) {
4243   ALL_JAVA_THREADS(p) {
4244     p-&gt;nmethods_do(cf);
4245   }
4246   VMThread::vm_thread()-&gt;nmethods_do(cf);
4247 }
4248 
4249 void Threads::metadata_do(void f(Metadata*)) {
4250   ALL_JAVA_THREADS(p) {
4251     p-&gt;metadata_do(f);
4252   }
4253 }
4254 
4255 class ThreadHandlesClosure : public ThreadClosure {
4256   void (*_f)(Metadata*);
4257  public:
4258   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4259   virtual void do_thread(Thread* thread) {
4260     thread-&gt;metadata_handles_do(_f);
4261   }
4262 };
4263 
4264 void Threads::metadata_handles_do(void f(Metadata*)) {
4265   // Only walk the Handles in Thread.
4266   ThreadHandlesClosure handles_closure(f);
4267   threads_do(&amp;handles_closure);
4268 }
4269 
4270 void Threads::deoptimized_wrt_marked_nmethods() {
4271   ALL_JAVA_THREADS(p) {
4272     p-&gt;deoptimized_wrt_marked_nmethods();
4273   }
4274 }
4275 
4276 
4277 // Get count Java threads that are waiting to enter the specified monitor.
4278 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(int count,
4279                                                          address monitor,
4280                                                          bool doLock) {
4281   assert(doLock || SafepointSynchronize::is_at_safepoint(),
4282          "must grab Threads_lock or be at safepoint");
4283   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4284 
4285   int i = 0;
4286   {
4287     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4288     ALL_JAVA_THREADS(p) {
4289       if (!p-&gt;can_call_java()) continue;
4290 
4291       address pending = (address)p-&gt;current_pending_monitor();
4292       if (pending == monitor) {             // found a match
4293         if (i &lt; count) result-&gt;append(p);   // save the first count matches
4294         i++;
4295       }
4296     }
4297   }
4298   return result;
4299 }
4300 
4301 
4302 JavaThread *Threads::owning_thread_from_monitor_owner(address owner,
4303                                                       bool doLock) {
4304   assert(doLock ||
4305          Threads_lock-&gt;owned_by_self() ||
4306          SafepointSynchronize::is_at_safepoint(),
4307          "must grab Threads_lock or be at safepoint");
4308 
4309   // NULL owner means not locked so we can skip the search
4310   if (owner == NULL) return NULL;
4311 
4312   {
4313     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4314     ALL_JAVA_THREADS(p) {
4315       // first, see if owner is the address of a Java thread
4316       if (owner == (address)p) return p;
4317     }
4318   }
4319   // Cannot assert on lack of success here since this function may be
4320   // used by code that is trying to report useful problem information
4321   // like deadlock detection.
4322   if (UseHeavyMonitors) return NULL;
4323 
4324   // If we didn't find a matching Java thread and we didn't force use of
4325   // heavyweight monitors, then the owner is the stack address of the
4326   // Lock Word in the owning Java thread's stack.
4327   //
4328   JavaThread* the_owner = NULL;
4329   {
4330     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4331     ALL_JAVA_THREADS(q) {
4332       if (q-&gt;is_lock_owned(owner)) {
4333         the_owner = q;
4334         break;
4335       }
4336     }
4337   }
4338   // cannot assert on lack of success here; see above comment
4339   return the_owner;
4340 }
4341 
4342 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4343 void Threads::print_on(outputStream* st, bool print_stacks,
4344                        bool internal_format, bool print_concurrent_locks) {
4345   char buf[32];
4346   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4347 
4348   st-&gt;print_cr("Full thread dump %s (%s %s):",
4349                Abstract_VM_Version::vm_name(),
4350                Abstract_VM_Version::vm_release(),
4351                Abstract_VM_Version::vm_info_string());
4352   st-&gt;cr();
4353 
4354 #if INCLUDE_SERVICES
4355   // Dump concurrent locks
4356   ConcurrentLocksDump concurrent_locks;
4357   if (print_concurrent_locks) {
4358     concurrent_locks.dump_at_safepoint();
4359   }
4360 #endif // INCLUDE_SERVICES
4361 
4362   ALL_JAVA_THREADS(p) {
4363     ResourceMark rm;
4364     p-&gt;print_on(st);
4365     if (print_stacks) {
4366       if (internal_format) {
4367         p-&gt;trace_stack();
4368       } else {
4369         p-&gt;print_stack_on(st);
4370       }
4371     }
4372     st-&gt;cr();
4373 #if INCLUDE_SERVICES
4374     if (print_concurrent_locks) {
4375       concurrent_locks.print_locks_on(p, st);
4376     }
4377 #endif // INCLUDE_SERVICES
4378   }
4379 
4380   VMThread::vm_thread()-&gt;print_on(st);
4381   st-&gt;cr();
4382   Universe::heap()-&gt;print_gc_threads_on(st);
4383   WatcherThread* wt = WatcherThread::watcher_thread();
4384   if (wt != NULL) {
4385     wt-&gt;print_on(st);
4386     st-&gt;cr();
4387   }
4388   CompileBroker::print_compiler_threads_on(st);
4389   st-&gt;flush();
4390 }
4391 
4392 // Threads::print_on_error() is called by fatal error handler. It's possible
4393 // that VM is not at safepoint and/or current thread is inside signal handler.
4394 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4395 // memory (even in resource area), it might deadlock the error handler.
4396 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4397                              int buflen) {
4398   bool found_current = false;
4399   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4400   ALL_JAVA_THREADS(thread) {
4401     bool is_current = (current == thread);
4402     found_current = found_current || is_current;
4403 
4404     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4405 
4406     st-&gt;print(PTR_FORMAT, p2i(thread));
4407     st-&gt;print(" ");
4408     thread-&gt;print_on_error(st, buf, buflen);
4409     st-&gt;cr();
4410   }
4411   st-&gt;cr();
4412 
4413   st-&gt;print_cr("Other Threads:");
4414   if (VMThread::vm_thread()) {
4415     bool is_current = (current == VMThread::vm_thread());
4416     found_current = found_current || is_current;
4417     st-&gt;print("%s", current == VMThread::vm_thread() ? "=&gt;" : "  ");
4418 
4419     st-&gt;print(PTR_FORMAT, p2i(VMThread::vm_thread()));
4420     st-&gt;print(" ");
4421     VMThread::vm_thread()-&gt;print_on_error(st, buf, buflen);
4422     st-&gt;cr();
4423   }
4424   WatcherThread* wt = WatcherThread::watcher_thread();
4425   if (wt != NULL) {
4426     bool is_current = (current == wt);
4427     found_current = found_current || is_current;
4428     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4429 
4430     st-&gt;print(PTR_FORMAT, p2i(wt));
4431     st-&gt;print(" ");
4432     wt-&gt;print_on_error(st, buf, buflen);
4433     st-&gt;cr();
4434   }
4435   if (!found_current) {
4436     st-&gt;cr();
4437     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4438     current-&gt;print_on_error(st, buf, buflen);
4439     st-&gt;cr();
4440   }
4441 }
4442 
4443 // Internal SpinLock and Mutex
4444 // Based on ParkEvent
4445 
4446 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4447 //
4448 // We employ SpinLocks _only for low-contention, fixed-length
4449 // short-duration critical sections where we're concerned
4450 // about native mutex_t or HotSpot Mutex:: latency.
4451 // The mux construct provides a spin-then-block mutual exclusion
4452 // mechanism.
4453 //
4454 // Testing has shown that contention on the ListLock guarding gFreeList
4455 // is common.  If we implement ListLock as a simple SpinLock it's common
4456 // for the JVM to devolve to yielding with little progress.  This is true
4457 // despite the fact that the critical sections protected by ListLock are
4458 // extremely short.
4459 //
4460 // TODO-FIXME: ListLock should be of type SpinLock.
4461 // We should make this a 1st-class type, integrated into the lock
4462 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4463 // should have sufficient padding to avoid false-sharing and excessive
4464 // cache-coherency traffic.
4465 
4466 
4467 typedef volatile int SpinLockT;
4468 
4469 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4470   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4471     return;   // normal fast-path return
4472   }
4473 
4474   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4475   TEVENT(SpinAcquire - ctx);
4476   int ctr = 0;
4477   int Yields = 0;
4478   for (;;) {
4479     while (*adr != 0) {
4480       ++ctr;
4481       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4482         if (Yields &gt; 5) {
4483           os::naked_short_sleep(1);
4484         } else {
4485           os::naked_yield();
4486           ++Yields;
4487         }
4488       } else {
4489         SpinPause();
4490       }
4491     }
4492     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4493   }
4494 }
4495 
4496 void Thread::SpinRelease(volatile int * adr) {
4497   assert(*adr != 0, "invariant");
4498   OrderAccess::fence();      // guarantee at least release consistency.
4499   // Roach-motel semantics.
4500   // It's safe if subsequent LDs and STs float "up" into the critical section,
4501   // but prior LDs and STs within the critical section can't be allowed
4502   // to reorder or float past the ST that releases the lock.
4503   // Loads and stores in the critical section - which appear in program
4504   // order before the store that releases the lock - must also appear
4505   // before the store that releases the lock in memory visibility order.
4506   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4507   // the ST of 0 into the lock-word which releases the lock, so fence
4508   // more than covers this on all platforms.
4509   *adr = 0;
4510 }
4511 
4512 // muxAcquire and muxRelease:
4513 //
4514 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4515 //    The LSB of the word is set IFF the lock is held.
4516 //    The remainder of the word points to the head of a singly-linked list
4517 //    of threads blocked on the lock.
4518 //
4519 // *  The current implementation of muxAcquire-muxRelease uses its own
4520 //    dedicated Thread._MuxEvent instance.  If we're interested in
4521 //    minimizing the peak number of extant ParkEvent instances then
4522 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4523 //    as certain invariants were satisfied.  Specifically, care would need
4524 //    to be taken with regards to consuming unpark() "permits".
4525 //    A safe rule of thumb is that a thread would never call muxAcquire()
4526 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4527 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4528 //    consume an unpark() permit intended for monitorenter, for instance.
4529 //    One way around this would be to widen the restricted-range semaphore
4530 //    implemented in park().  Another alternative would be to provide
4531 //    multiple instances of the PlatformEvent() for each thread.  One
4532 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4533 //
4534 // *  Usage:
4535 //    -- Only as leaf locks
4536 //    -- for short-term locking only as muxAcquire does not perform
4537 //       thread state transitions.
4538 //
4539 // Alternatives:
4540 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4541 //    but with parking or spin-then-park instead of pure spinning.
4542 // *  Use Taura-Oyama-Yonenzawa locks.
4543 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4544 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4545 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4546 //    acquiring threads use timers (ParkTimed) to detect and recover from
4547 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4548 //    boundaries by using placement-new.
4549 // *  Augment MCS with advisory back-link fields maintained with CAS().
4550 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4551 //    The validity of the backlinks must be ratified before we trust the value.
4552 //    If the backlinks are invalid the exiting thread must back-track through the
4553 //    the forward links, which are always trustworthy.
4554 // *  Add a successor indication.  The LockWord is currently encoded as
4555 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4556 //    to provide the usual futile-wakeup optimization.
4557 //    See RTStt for details.
4558 // *  Consider schedctl.sc_nopreempt to cover the critical section.
4559 //
4560 
4561 
4562 typedef volatile intptr_t MutexT;      // Mux Lock-word
4563 enum MuxBits { LOCKBIT = 1 };
4564 
4565 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4566   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4567   if (w == 0) return;
4568   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4569     return;
4570   }
4571 
4572   TEVENT(muxAcquire - Contention);
4573   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4574   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4575   for (;;) {
4576     int its = (os::is_MP() ? 100 : 0) + 1;
4577 
4578     // Optional spin phase: spin-then-park strategy
4579     while (--its &gt;= 0) {
4580       w = *Lock;
4581       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4582         return;
4583       }
4584     }
4585 
4586     Self-&gt;reset();
4587     Self-&gt;OnList = intptr_t(Lock);
4588     // The following fence() isn't _strictly necessary as the subsequent
4589     // CAS() both serializes execution and ratifies the fetched *Lock value.
4590     OrderAccess::fence();
4591     for (;;) {
4592       w = *Lock;
4593       if ((w &amp; LOCKBIT) == 0) {
4594         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4595           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4596           return;
4597         }
4598         continue;      // Interference -- *Lock changed -- Just retry
4599       }
4600       assert(w &amp; LOCKBIT, "invariant");
4601       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4602       if (Atomic::cmpxchg_ptr(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4603     }
4604 
4605     while (Self-&gt;OnList != 0) {
4606       Self-&gt;park();
4607     }
4608   }
4609 }
4610 
4611 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4612   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4613   if (w == 0) return;
4614   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4615     return;
4616   }
4617 
4618   TEVENT(muxAcquire - Contention);
4619   ParkEvent * ReleaseAfter = NULL;
4620   if (ev == NULL) {
4621     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4622   }
4623   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4624   for (;;) {
4625     guarantee(ev-&gt;OnList == 0, "invariant");
4626     int its = (os::is_MP() ? 100 : 0) + 1;
4627 
4628     // Optional spin phase: spin-then-park strategy
4629     while (--its &gt;= 0) {
4630       w = *Lock;
4631       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4632         if (ReleaseAfter != NULL) {
4633           ParkEvent::Release(ReleaseAfter);
4634         }
4635         return;
4636       }
4637     }
4638 
4639     ev-&gt;reset();
4640     ev-&gt;OnList = intptr_t(Lock);
4641     // The following fence() isn't _strictly necessary as the subsequent
4642     // CAS() both serializes execution and ratifies the fetched *Lock value.
4643     OrderAccess::fence();
4644     for (;;) {
4645       w = *Lock;
4646       if ((w &amp; LOCKBIT) == 0) {
4647         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4648           ev-&gt;OnList = 0;
4649           // We call ::Release while holding the outer lock, thus
4650           // artificially lengthening the critical section.
4651           // Consider deferring the ::Release() until the subsequent unlock(),
4652           // after we've dropped the outer lock.
4653           if (ReleaseAfter != NULL) {
4654             ParkEvent::Release(ReleaseAfter);
4655           }
4656           return;
4657         }
4658         continue;      // Interference -- *Lock changed -- Just retry
4659       }
4660       assert(w &amp; LOCKBIT, "invariant");
4661       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4662       if (Atomic::cmpxchg_ptr(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4663     }
4664 
4665     while (ev-&gt;OnList != 0) {
4666       ev-&gt;park();
4667     }
4668   }
4669 }
4670 
4671 // Release() must extract a successor from the list and then wake that thread.
4672 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4673 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4674 // Release() would :
4675 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4676 // (B) Extract a successor from the private list "in-hand"
4677 // (C) attempt to CAS() the residual back into *Lock over null.
4678 //     If there were any newly arrived threads and the CAS() would fail.
4679 //     In that case Release() would detach the RATs, re-merge the list in-hand
4680 //     with the RATs and repeat as needed.  Alternately, Release() might
4681 //     detach and extract a successor, but then pass the residual list to the wakee.
4682 //     The wakee would be responsible for reattaching and remerging before it
4683 //     competed for the lock.
4684 //
4685 // Both "pop" and DMR are immune from ABA corruption -- there can be
4686 // multiple concurrent pushers, but only one popper or detacher.
4687 // This implementation pops from the head of the list.  This is unfair,
4688 // but tends to provide excellent throughput as hot threads remain hot.
4689 // (We wake recently run threads first).
4690 //
4691 // All paths through muxRelease() will execute a CAS.
4692 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4693 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4694 // executed within the critical section are complete and globally visible before the
4695 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4696 void Thread::muxRelease(volatile intptr_t * Lock)  {
4697   for (;;) {
4698     const intptr_t w = Atomic::cmpxchg_ptr(0, Lock, LOCKBIT);
4699     assert(w &amp; LOCKBIT, "invariant");
4700     if (w == LOCKBIT) return;
4701     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4702     assert(List != NULL, "invariant");
4703     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4704     ParkEvent * const nxt = List-&gt;ListNext;
4705     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4706 
4707     // The following CAS() releases the lock and pops the head element.
4708     // The CAS() also ratifies the previously fetched lock-word value.
4709     if (Atomic::cmpxchg_ptr (intptr_t(nxt), Lock, w) != w) {
4710       continue;
4711     }
4712     List-&gt;OnList = 0;
4713     OrderAccess::fence();
4714     List-&gt;unpark();
4715     return;
4716   }
4717 }
4718 
4719 
4720 void Threads::verify() {
4721   ALL_JAVA_THREADS(p) {
4722     p-&gt;verify();
4723   }
4724   VMThread* thread = VMThread::vm_thread();
4725   if (thread != NULL) thread-&gt;verify();
4726 }
</pre></body></html>
