<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/code/dependencies.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "ci/ciArrayKlass.hpp"
  27 #include "ci/ciEnv.hpp"
  28 #include "ci/ciKlass.hpp"
  29 #include "ci/ciMethod.hpp"
  30 #include "code/dependencies.hpp"
  31 #include "compiler/compileLog.hpp"
  32 #include "oops/oop.inline.hpp"
  33 #include "oops/objArrayKlass.hpp"
  34 #include "runtime/handles.hpp"
  35 #include "runtime/handles.inline.hpp"
  36 #include "utilities/copy.hpp"
  37 
  38 
  39 #ifdef ASSERT
  40 static bool must_be_in_vm() {
  41   Thread* thread = Thread::current();
  42   if (thread-&gt;is_Java_thread())
  43     return ((JavaThread*)thread)-&gt;thread_state() == _thread_in_vm;
  44   else
  45     return true;  //something like this: thread-&gt;is_VM_thread();
  46 }
  47 #endif //ASSERT
  48 
  49 void Dependencies::initialize(ciEnv* env) {
  50   Arena* arena = env-&gt;arena();
  51   _oop_recorder = env-&gt;oop_recorder();
  52   _log = env-&gt;log();
  53   _dep_seen = new(arena) GrowableArray&lt;int&gt;(arena, 500, 0, 0);
  54   DEBUG_ONLY(_deps[end_marker] = NULL);
  55   for (int i = (int)FIRST_TYPE; i &lt; (int)TYPE_LIMIT; i++) {
  56     _deps[i] = new(arena) GrowableArray&lt;DepValue&gt;(arena, 10, 0, DepValue());
  57   }
  58   _content_bytes = NULL;
  59   _size_in_bytes = (size_t)-1;
  60 
  61   assert(TYPE_LIMIT &lt;= (1&lt;&lt;LG2_TYPE_LIMIT), "sanity");
  62 }
  63 
  64 void Dependencies::assert_evol_method(Method* m) {
  65   assert_common_1(evol_method, DepValue(_oop_recorder, m));
  66 }
  67 
  68 void Dependencies::assert_leaf_type(Klass* ctxk) {
  69   if (ctxk-&gt;oop_is_array()) {
  70     // As a special case, support this assertion on an array type,
  71     // which reduces to an assertion on its element type.
  72     // Note that this cannot be done with assertions that
  73     // relate to concreteness or abstractness.
  74     BasicType elemt = ArrayKlass::cast(ctxk)-&gt;element_type();
  75     if (is_java_primitive(elemt))  return;   // Ex:  int[][]
  76     ctxk = ObjArrayKlass::cast(ctxk)-&gt;bottom_klass();
  77     //if (ctxk-&gt;is_final())  return;            // Ex:  String[][]
  78   }
  79   check_ctxk(ctxk);
  80   assert_common_1(leaf_type, DepValue(_oop_recorder, ctxk));
  81 }
  82 
  83 void Dependencies::assert_abstract_with_unique_concrete_subtype(Klass* ctxk, Klass* conck) {
  84   check_ctxk_abstract(ctxk);
  85   DepValue ctxk_dv(_oop_recorder, ctxk);
  86   assert_common_2(abstract_with_unique_concrete_subtype, ctxk_dv, DepValue(_oop_recorder, conck, &amp;ctxk_dv));
  87 }
  88 
  89 void Dependencies::assert_abstract_with_no_concrete_subtype(Klass* ctxk) {
  90   check_ctxk_abstract(ctxk);
  91   assert_common_1(abstract_with_no_concrete_subtype, DepValue(_oop_recorder, ctxk));
  92 }
  93 
  94 void Dependencies::assert_concrete_with_no_concrete_subtype(Klass* ctxk) {
  95   check_ctxk_concrete(ctxk);
  96   assert_common_1(concrete_with_no_concrete_subtype, DepValue(_oop_recorder, ctxk));
  97 }
  98 
  99 void Dependencies::assert_unique_concrete_method(Klass* ctxk, Method* uniqm) {
 100   check_ctxk(ctxk);
 101   assert_common_2(unique_concrete_method, DepValue(_oop_recorder, ctxk), DepValue(_oop_recorder, uniqm));
 102 }
 103 
 104 void Dependencies::assert_abstract_with_exclusive_concrete_subtypes(Klass* ctxk, Klass* k1, Klass* k2) {
 105   check_ctxk(ctxk);
 106   DepValue k1_dv(_oop_recorder, k1);
 107   assert_common_3(abstract_with_exclusive_concrete_subtypes_2, ctxk, k1_dv, DepValue(_oop_recorder, k2, &amp;k1_dv));
 108 }
 109 
 110 void Dependencies::assert_exclusive_concrete_methods(Klass* ctxk, Method* m1, Method* m2) {
 111   check_ctxk(ctxk);
 112   DepValue m1_dv(_oop_recorder, m1);
 113   assert_common_3(exclusive_concrete_methods_2, ctxk, m1_dv, DepValue(_oop_recorder, m2, &amp;m1_dv));
 114 }
 115 
 116 void Dependencies::assert_has_no_finalizable_subclasses(Klass* ctxk) {
 117   check_ctxk(ctxk);
 118   assert_common_1(no_finalizable_subclasses, DepValue(_oop_recorder, ctxk));
 119 }
 120 
 121 void Dependencies::assert_call_site_target_value(jobject call_site, jobject method_handle) {
 122   Klass* ctxk = JNIHandles::resolve(call_site)-&gt;klass();
 123   check_ctxk(ctxk);
 124   assert_common_2(call_site_target_value, DepValue(_oop_recorder, call_site), DepValue(_oop_recorder, method_handle));
 125 }
 126 
 127 // Helper function.  If we are adding a new dep. under ctxk2,
 128 // try to find an old dep. under a broader* ctxk1.  If there is
 129 //
 130 bool Dependencies::maybe_merge_ctxk(GrowableArray&lt;DepValue&gt;* deps,
 131                                     int ctxk_i, Klass* ctxk2) {
 132   Klass* ctxk1 = deps-&gt;at(ctxk_i).as_klass(_oop_recorder);
 133   if (ctxk2-&gt;is_subtype_of(ctxk1)) {
 134     return true;  // success, and no need to change
 135   } else if (ctxk1-&gt;is_subtype_of(ctxk2)) {
 136     // new context class fully subsumes previous one
 137     deps-&gt;at_put(ctxk_i, DepValue(_oop_recorder, ctxk2));
 138     return true;
 139   } else {
 140     return false;
 141   }
 142 }
 143 
 144 void Dependencies::assert_common_1(DepType dept, DepValue x) {
 145   assert(dep_args(dept) == 1, "sanity");
 146   log_dependency(dept, x);
 147   GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 148 
 149   // see if the same (or a similar) dep is already recorded
 150   if (note_dep_seen(dept, x)) {
 151     assert(deps-&gt;find(x) &gt;= 0, "sanity");
 152   } else {
 153     deps-&gt;append(x);
 154   }
 155 }
 156 
 157 void Dependencies::assert_common_2(DepType dept,
 158                                    DepValue x0, DepValue x1) {
 159   assert(dep_args(dept) == 2, "sanity");
 160   log_dependency(dept, x0, x1);
 161   GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 162 
 163   // see if the same (or a similar) dep is already recorded
 164   bool has_ctxk = has_explicit_context_arg(dept);
 165   if (has_ctxk) {
 166     assert(dep_context_arg(dept) == 0, "sanity");
 167     if (note_dep_seen(dept, x1)) {
 168       // look in this bucket for redundant assertions
 169       const int stride = 2;
 170       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 171         DepValue y1 = deps-&gt;at(i+1);
 172         if (x1 == y1) {  // same subject; check the context
 173           if (maybe_merge_ctxk(deps, i+0, x0.as_klass(_oop_recorder))) {
 174             return;
 175           }
 176         }
 177       }
 178     }
 179   } else {
 180     assert(dep_implicit_context_arg(dept) == 0, "sanity");
 181     if (note_dep_seen(dept, x0) &amp;&amp; note_dep_seen(dept, x1)) {
 182       // look in this bucket for redundant assertions
 183       const int stride = 2;
 184       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 185         DepValue y0 = deps-&gt;at(i+0);
 186         DepValue y1 = deps-&gt;at(i+1);
 187         if (x0 == y0 &amp;&amp; x1 == y1) {
 188           return;
 189         }
 190       }
 191     }
 192   }
 193 
 194   // append the assertion in the correct bucket:
 195   deps-&gt;append(x0);
 196   deps-&gt;append(x1);
 197 }
 198 
 199 void Dependencies::assert_common_3(DepType dept,
 200                                    Klass* ctxk, DepValue x, DepValue x2) {
 201   assert(dep_context_arg(dept) == 0, "sanity");
 202   assert(dep_args(dept) == 3, "sanity");
 203   log_dependency(dept, DepValue(_oop_recorder, ctxk), x, x2);
 204   GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 205 
 206   // try to normalize an unordered pair:
 207   bool swap = false;
 208   switch (dept) {
 209   case abstract_with_exclusive_concrete_subtypes_2:
 210     swap = (x.index() &gt; x2.index() &amp;&amp; x.as_klass(_oop_recorder) != ctxk);
 211     break;
 212   case exclusive_concrete_methods_2:
 213     swap = (x.index() &gt; x2.index() &amp;&amp; x.as_method(_oop_recorder)-&gt;method_holder() != ctxk);
 214     break;
 215   }
 216   if (swap) { DepValue t = x; x = x2; x2 = t; }
 217 
 218   // see if the same (or a similar) dep is already recorded
 219   if (note_dep_seen(dept, x) &amp;&amp; note_dep_seen(dept, x2)) {
 220     // look in this bucket for redundant assertions
 221     const int stride = 3;
 222     for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 223       DepValue y  = deps-&gt;at(i+1);
 224       DepValue y2 = deps-&gt;at(i+2);
 225       if (x == y &amp;&amp; x2 == y2) {  // same subjects; check the context
 226         if (maybe_merge_ctxk(deps, i+0, ctxk)) {
 227           return;
 228         }
 229       }
 230     }
 231   }
 232   // append the assertion in the correct bucket:
 233   deps-&gt;append(DepValue(_oop_recorder, ctxk));
 234   deps-&gt;append(x);
 235   deps-&gt;append(x2);
 236 }
 237 
 238 /// Support for encoding dependencies into an nmethod:
 239 
 240 void Dependencies::copy_to(nmethod* nm) {
 241   address beg = nm-&gt;dependencies_begin();
 242   address end = nm-&gt;dependencies_end();
 243   guarantee(end - beg &gt;= (ptrdiff_t) size_in_bytes(), "bad sizing");
 244   Copy::disjoint_words((HeapWord*) content_bytes(),
 245                        (HeapWord*) beg,
 246                        size_in_bytes() / sizeof(HeapWord));
 247   assert(size_in_bytes() % sizeof(HeapWord) == 0, "copy by words");
 248 }
 249 
 250 static int sort_dep(Dependencies::DepValue* p1, Dependencies::DepValue* p2, int narg) {
 251   for (int i = 0; i &lt; narg; i++) {
 252     int diff = p1[i].sort_key() - p2[i].sort_key();
 253     if (diff != 0)  return diff;
 254   }
 255   return 0;
 256 }
 257 static int sort_dep_arg_1(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 258 { return sort_dep(p1, p2, 1); }
 259 static int sort_dep_arg_2(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 260 { return sort_dep(p1, p2, 2); }
 261 static int sort_dep_arg_3(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 262 { return sort_dep(p1, p2, 3); }
 263 
 264 void Dependencies::sort_all_deps() {
 265   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 266     DepType dept = (DepType)deptv;
 267     GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 268     if (deps-&gt;length() &lt;= 1)  continue;
 269     switch (dep_args(dept)) {
 270     case 1: deps-&gt;sort(sort_dep_arg_1, 1); break;
 271     case 2: deps-&gt;sort(sort_dep_arg_2, 2); break;
 272     case 3: deps-&gt;sort(sort_dep_arg_3, 3); break;
 273     default: ShouldNotReachHere();
 274     }
 275   }
 276 }
 277 
 278 size_t Dependencies::estimate_size_in_bytes() {
 279   size_t est_size = 100;
 280   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 281     DepType dept = (DepType)deptv;
 282     GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 283     est_size += deps-&gt;length()*2;  // tags and argument(s)
 284   }
 285   return est_size;
 286 }
 287 
 288 Klass* Dependencies::ctxk_encoded_as_null(OopRecorder* oop_recorder, DepType dept, DepValue x) {
 289   switch (dept) {
 290   case abstract_with_exclusive_concrete_subtypes_2:
 291     return x.as_klass(oop_recorder);
 292   case unique_concrete_method:
 293   case exclusive_concrete_methods_2:
 294     return x.as_method(oop_recorder)-&gt;method_holder();
 295   }
 296   return NULL;  // let NULL be NULL
 297 }
 298 
 299 Klass* Dependencies::ctxk_encoded_as_null(DepType dept, Metadata* x) {
 300   assert(must_be_in_vm(), "raw oops here");
 301   switch (dept) {
 302   case abstract_with_exclusive_concrete_subtypes_2:
 303     assert(x-&gt;is_klass(), "sanity");
 304     return (Klass*) x;
 305   case unique_concrete_method:
 306   case exclusive_concrete_methods_2:
 307     assert(x-&gt;is_method(), "sanity");
 308     return ((Method*)x)-&gt;method_holder();
 309   }
 310   return NULL;  // let NULL be NULL
 311 }
 312 
 313 void Dependencies::encode_content_bytes() {
 314   sort_all_deps();
 315 
 316   // cast is safe, no deps can overflow INT_MAX
 317   CompressedWriteStream bytes((int)estimate_size_in_bytes());
 318 
 319   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 320     DepType dept = (DepType)deptv;
 321     GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 322     if (deps-&gt;length() == 0)  continue;
 323     int stride = dep_args(dept);
 324     int ctxkj  = dep_context_arg(dept);  // -1 if no context arg
 325     assert(stride &gt; 0, "sanity");
 326     for (int i = 0; i &lt; deps-&gt;length(); i += stride) {
 327       jbyte code_byte = (jbyte)dept;
 328       int skipj = -1;
 329       if (ctxkj &gt;= 0 &amp;&amp; ctxkj+1 &lt; stride) {
 330         Klass*  ctxk = deps-&gt;at(i+ctxkj+0).as_klass(_oop_recorder);
 331         DepValue x     = deps-&gt;at(i+ctxkj+1);  // following argument
 332         if (ctxk == ctxk_encoded_as_null(_oop_recorder, dept, x)) {
 333           skipj = ctxkj;  // we win:  maybe one less oop to keep track of
 334           code_byte |= default_context_type_bit;
 335         }
 336       }
 337       bytes.write_byte(code_byte);
 338       for (int j = 0; j &lt; stride; j++) {
 339         if (j == skipj)  continue;
 340         DepValue v = deps-&gt;at(i+j);
 341         int idx = v.index();
 342         bytes.write_int(idx);
 343       }
 344     }
 345   }
 346 
 347   // write a sentinel byte to mark the end
 348   bytes.write_byte(end_marker);
 349 
 350   // round it out to a word boundary
 351   while (bytes.position() % sizeof(HeapWord) != 0) {
 352     bytes.write_byte(end_marker);
 353   }
 354 
 355   // check whether the dept byte encoding really works
 356   assert((jbyte)default_context_type_bit != 0, "byte overflow");
 357 
 358   _content_bytes = bytes.buffer();
 359   _size_in_bytes = bytes.position();
 360 }
 361 
 362 
 363 const char* Dependencies::_dep_name[TYPE_LIMIT] = {
 364   "end_marker",
 365   "evol_method",
 366   "leaf_type",
 367   "abstract_with_unique_concrete_subtype",
 368   "abstract_with_no_concrete_subtype",
 369   "concrete_with_no_concrete_subtype",
 370   "unique_concrete_method",
 371   "abstract_with_exclusive_concrete_subtypes_2",
 372   "exclusive_concrete_methods_2",
 373   "no_finalizable_subclasses",
 374   "call_site_target_value"
 375 };
 376 
 377 int Dependencies::_dep_args[TYPE_LIMIT] = {
 378   -1,// end_marker
 379   1, // evol_method m
 380   1, // leaf_type ctxk
 381   2, // abstract_with_unique_concrete_subtype ctxk, k
 382   1, // abstract_with_no_concrete_subtype ctxk
 383   1, // concrete_with_no_concrete_subtype ctxk
 384   2, // unique_concrete_method ctxk, m
 385   3, // unique_concrete_subtypes_2 ctxk, k1, k2
 386   3, // unique_concrete_methods_2 ctxk, m1, m2
 387   1, // no_finalizable_subclasses ctxk
 388   2  // call_site_target_value call_site, method_handle
 389 };
 390 
 391 const char* Dependencies::dep_name(Dependencies::DepType dept) {
 392   if (!dept_in_mask(dept, all_types))  return "?bad-dep?";
 393   return _dep_name[dept];
 394 }
 395 
 396 int Dependencies::dep_args(Dependencies::DepType dept) {
 397   if (!dept_in_mask(dept, all_types))  return -1;
 398   return _dep_args[dept];
 399 }
 400 
 401 void Dependencies::check_valid_dependency_type(DepType dept) {
 402   guarantee(FIRST_TYPE &lt;= dept &amp;&amp; dept &lt; TYPE_LIMIT, err_msg("invalid dependency type: %d", (int) dept));
 403 }
 404 
 405 // for the sake of the compiler log, print out current dependencies:
 406 void Dependencies::log_all_dependencies() {
 407   if (log() == NULL)  return;
 408   DepValue args[max_arg_count];
 409   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 410     DepType dept = (DepType)deptv;
 411     GrowableArray&lt;DepValue&gt;* deps = _deps[dept];
 412     if (deps-&gt;length() == 0)  continue;
 413     int stride = dep_args(dept);
 414     for (int i = 0; i &lt; deps-&gt;length(); i += stride) {
 415       for (int j = 0; j &lt; stride; j++) {
 416         // flush out the identities before printing
 417         args[j] = deps-&gt;at(i+j);
 418       }
 419       write_dependency_to(log(), dept, stride, args);
 420     }
 421   }
 422 }
 423 
 424 void Dependencies::write_dependency_to(CompileLog* log,
 425                                        DepType dept,
 426                                        int nargs, DepValue args[],
 427                                        Klass* witness) {
 428   if (log == NULL) {
 429     return;
 430   }
 431   ciEnv* env = ciEnv::current();
 432   ciBaseObject* ciargs[max_arg_count];
 433   assert(nargs &lt;= max_arg_count, "oob");
 434   for (int j = 0; j &lt; nargs; j++) {
 435     if (args[j].is_object()) {
 436       ciargs[j] = env-&gt;get_object(JNIHandles::resolve(args[j].as_object(_oop_recorder)));
 437     } else {
 438       ciargs[j] = env-&gt;get_metadata(args[j].as_metadata(_oop_recorder));
 439     }
 440   }
 441   Dependencies::write_dependency_to(log, dept, nargs, ciargs, witness);
 442 }
 443 
 444 void Dependencies::write_dependency_to(CompileLog* log,
 445                                        DepType dept,
 446                                        int nargs, DepArgument args[],
 447                                        Klass* witness) {
 448   if (log == NULL) {
 449     return;
 450   }
 451   ciEnv* env = ciEnv::current();
 452   ciBaseObject* ciargs[max_arg_count];
 453   assert(nargs &lt;= max_arg_count, "oob");
 454   for (int j = 0; j &lt; nargs; j++) {
 455     if (args[j].is_oop()) {
 456       ciargs[j] = env-&gt;get_object(args[j].oop_value());
 457     } else {
 458       ciargs[j] = env-&gt;get_metadata(args[j].metadata_value());
 459     }
 460   }
 461   Dependencies::write_dependency_to(log, dept, nargs, ciargs, witness);
 462 }
 463 
 464 void Dependencies::write_dependency_to(CompileLog* log,
 465                                        DepType dept,
 466                                        int nargs, ciBaseObject* args[],
 467                                        Klass* witness) {
 468   if (log == NULL)  return;
 469   assert(nargs &lt;= max_arg_count, "oob");
 470   int argids[max_arg_count];
 471   int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 472   int j;
 473   for (j = 0; j &lt; nargs; j++) {
 474     if (args[j]-&gt;is_object()) {
 475       argids[j] = log-&gt;identify(args[j]-&gt;as_object());
 476     } else {
 477       argids[j] = log-&gt;identify(args[j]-&gt;as_metadata());
 478     }
 479   }
 480   if (witness != NULL) {
 481     log-&gt;begin_elem("dependency_failed");
 482   } else {
 483     log-&gt;begin_elem("dependency");
 484   }
 485   log-&gt;print(" type='%s'", dep_name(dept));
 486   if (ctxkj &gt;= 0) {
 487     log-&gt;print(" ctxk='%d'", argids[ctxkj]);
 488   }
 489   // write remaining arguments, if any.
 490   for (j = 0; j &lt; nargs; j++) {
 491     if (j == ctxkj)  continue;  // already logged
 492     if (j == 1) {
 493       log-&gt;print(  " x='%d'",    argids[j]);
 494     } else {
 495       log-&gt;print(" x%d='%d'", j, argids[j]);
 496     }
 497   }
 498   if (witness != NULL) {
 499     log-&gt;object("witness", witness);
 500     log-&gt;stamp();
 501   }
 502   log-&gt;end_elem();
 503 }
 504 
 505 void Dependencies::write_dependency_to(xmlStream* xtty,
 506                                        DepType dept,
 507                                        int nargs, DepArgument args[],
 508                                        Klass* witness) {
 509   if (xtty == NULL)  return;
 510   ttyLocker ttyl;
 511   int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 512   if (witness != NULL) {
 513     xtty-&gt;begin_elem("dependency_failed");
 514   } else {
 515     xtty-&gt;begin_elem("dependency");
 516   }
 517   xtty-&gt;print(" type='%s'", dep_name(dept));
 518   if (ctxkj &gt;= 0) {
 519     xtty-&gt;object("ctxk", args[ctxkj].metadata_value());
 520   }
 521   // write remaining arguments, if any.
 522   for (int j = 0; j &lt; nargs; j++) {
 523     if (j == ctxkj)  continue;  // already logged
 524     if (j == 1) {
 525       if (args[j].is_oop()) {
 526         xtty-&gt;object("x", args[j].oop_value());
 527       } else {
 528         xtty-&gt;object("x", args[j].metadata_value());
 529       }
 530     } else {
 531       char xn[10]; sprintf(xn, "x%d", j);
 532       if (args[j].is_oop()) {
 533         xtty-&gt;object(xn, args[j].oop_value());
 534       } else {
 535         xtty-&gt;object(xn, args[j].metadata_value());
 536       }
 537     }
 538   }
 539   if (witness != NULL) {
 540     xtty-&gt;object("witness", witness);
 541     xtty-&gt;stamp();
 542   }
 543   xtty-&gt;end_elem();
 544 }
 545 
 546 void Dependencies::print_dependency(DepType dept, int nargs, DepArgument args[],
 547                                     Klass* witness) {
 548   ResourceMark rm;
 549   ttyLocker ttyl;   // keep the following output all in one block
 550   tty-&gt;print_cr("%s of type %s",
 551                 (witness == NULL)? "Dependency": "Failed dependency",
 552                 dep_name(dept));
 553   // print arguments
 554   int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 555   for (int j = 0; j &lt; nargs; j++) {
 556     DepArgument arg = args[j];
 557     bool put_star = false;
 558     if (arg.is_null())  continue;
 559     const char* what;
 560     if (j == ctxkj) {
 561       assert(arg.is_metadata(), "must be");
 562       what = "context";
 563       put_star = !Dependencies::is_concrete_klass((Klass*)arg.metadata_value());
 564     } else if (arg.is_method()) {
 565       what = "method ";
 566       put_star = !Dependencies::is_concrete_method((Method*)arg.metadata_value());
 567     } else if (arg.is_klass()) {
 568       what = "class  ";
 569     } else {
 570       what = "object ";
 571     }
 572     tty-&gt;print("  %s = %s", what, (put_star? "*": ""));
 573     if (arg.is_klass())
 574       tty-&gt;print("%s", ((Klass*)arg.metadata_value())-&gt;external_name());
 575     else if (arg.is_method())
 576       ((Method*)arg.metadata_value())-&gt;print_value();
 577     else
 578       ShouldNotReachHere(); // Provide impl for this type.
 579     tty-&gt;cr();
 580   }
 581   if (witness != NULL) {
 582     bool put_star = !Dependencies::is_concrete_klass(witness);
 583     tty-&gt;print_cr("  witness = %s%s",
 584                   (put_star? "*": ""),
 585                   witness-&gt;external_name());
 586   }
 587 }
 588 
 589 void Dependencies::DepStream::log_dependency(Klass* witness) {
 590   if (_deps == NULL &amp;&amp; xtty == NULL)  return;  // fast cutout for runtime
 591   ResourceMark rm;
 592   int nargs = argument_count();
 593   DepArgument args[max_arg_count];
 594   for (int j = 0; j &lt; nargs; j++) {
 595     if (type() == call_site_target_value) {
 596       args[j] = argument_oop(j);
 597     } else {
 598       args[j] = argument(j);
 599     }
 600   }
 601   if (_deps != NULL &amp;&amp; _deps-&gt;log() != NULL) {
 602     Dependencies::write_dependency_to(_deps-&gt;log(),
 603                                       type(), nargs, args, witness);
 604   } else {
 605     Dependencies::write_dependency_to(xtty,
 606                                       type(), nargs, args, witness);
 607   }
 608 }
 609 
 610 void Dependencies::DepStream::print_dependency(Klass* witness, bool verbose) {
 611   int nargs = argument_count();
 612   DepArgument args[max_arg_count];
 613   for (int j = 0; j &lt; nargs; j++) {
 614     args[j] = argument(j);
 615   }
 616   Dependencies::print_dependency(type(), nargs, args, witness);
 617   if (verbose) {
 618     if (_code != NULL) {
 619       tty-&gt;print("  code: ");
 620       _code-&gt;print_value_on(tty);
 621       tty-&gt;cr();
 622     }
 623   }
 624 }
 625 
 626 
 627 /// Dependency stream support (decodes dependencies from an nmethod):
 628 
 629 #ifdef ASSERT
 630 void Dependencies::DepStream::initial_asserts(size_t byte_limit) {
 631   assert(must_be_in_vm(), "raw oops here");
 632   _byte_limit = byte_limit;
 633   _type       = (DepType)(end_marker-1);  // defeat "already at end" assert
 634   assert((_code!=NULL) + (_deps!=NULL) == 1, "one or t'other");
 635 }
 636 #endif //ASSERT
 637 
 638 bool Dependencies::DepStream::next() {
 639   assert(_type != end_marker, "already at end");
 640   if (_bytes.position() == 0 &amp;&amp; _code != NULL
 641       &amp;&amp; _code-&gt;dependencies_size() == 0) {
 642     // Method has no dependencies at all.
 643     return false;
 644   }
 645   int code_byte = (_bytes.read_byte() &amp; 0xFF);
 646   if (code_byte == end_marker) {
 647     DEBUG_ONLY(_type = end_marker);
 648     return false;
 649   } else {
 650     int ctxk_bit = (code_byte &amp; Dependencies::default_context_type_bit);
 651     code_byte -= ctxk_bit;
 652     DepType dept = (DepType)code_byte;
 653     _type = dept;
 654     Dependencies::check_valid_dependency_type(dept);
 655     int stride = _dep_args[dept];
 656     assert(stride == dep_args(dept), "sanity");
 657     int skipj = -1;
 658     if (ctxk_bit != 0) {
 659       skipj = 0;  // currently the only context argument is at zero
 660       assert(skipj == dep_context_arg(dept), "zero arg always ctxk");
 661     }
 662     for (int j = 0; j &lt; stride; j++) {
 663       _xi[j] = (j == skipj)? 0: _bytes.read_int();
 664     }
 665     DEBUG_ONLY(_xi[stride] = -1);   // help detect overruns
 666     return true;
 667   }
 668 }
 669 
 670 inline Metadata* Dependencies::DepStream::recorded_metadata_at(int i) {
 671   Metadata* o = NULL;
 672   if (_code != NULL) {
 673     o = _code-&gt;metadata_at(i);
 674   } else {
 675     o = _deps-&gt;oop_recorder()-&gt;metadata_at(i);
 676   }
 677   assert(o == NULL || o-&gt;is_metaspace_object(),
 678          err_msg("Should be metadata " PTR_FORMAT, o));
 679   return o;
 680 }
 681 
 682 inline oop Dependencies::DepStream::recorded_oop_at(int i) {
 683   return (_code != NULL)
 684          ? _code-&gt;oop_at(i)
 685     : JNIHandles::resolve(_deps-&gt;oop_recorder()-&gt;oop_at(i));
 686 }
 687 
 688 Metadata* Dependencies::DepStream::argument(int i) {
 689   Metadata* result = recorded_metadata_at(argument_index(i));
 690 
 691   if (result == NULL) { // Explicit context argument can be compressed
 692     int ctxkj = dep_context_arg(type());  // -1 if no explicit context arg
 693     if (ctxkj &gt;= 0 &amp;&amp; i == ctxkj &amp;&amp; ctxkj+1 &lt; argument_count()) {
 694       result = ctxk_encoded_as_null(type(), argument(ctxkj+1));
 695     }
 696   }
 697 
 698   assert(result == NULL || result-&gt;is_klass() || result-&gt;is_method(), "must be");
 699   return result;
 700 }
 701 
 702 oop Dependencies::DepStream::argument_oop(int i) {
 703   oop result = recorded_oop_at(argument_index(i));
 704   assert(result == NULL || result-&gt;is_oop(), "must be");
 705   return result;
 706 }
 707 
 708 Klass* Dependencies::DepStream::context_type() {
 709   assert(must_be_in_vm(), "raw oops here");
 710 
 711   // Most dependencies have an explicit context type argument.
 712   {
 713     int ctxkj = dep_context_arg(type());  // -1 if no explicit context arg
 714     if (ctxkj &gt;= 0) {
 715       Metadata* k = argument(ctxkj);
 716       assert(k != NULL &amp;&amp; k-&gt;is_klass(), "type check");
 717       return (Klass*)k;
 718     }
 719   }
 720 
 721   // Some dependencies are using the klass of the first object
 722   // argument as implicit context type (e.g. call_site_target_value).
 723   {
 724     int ctxkj = dep_implicit_context_arg(type());
 725     if (ctxkj &gt;= 0) {
 726       Klass* k = argument_oop(ctxkj)-&gt;klass();
 727       assert(k != NULL &amp;&amp; k-&gt;is_klass(), "type check");
 728       return (Klass*) k;
 729     }
 730   }
 731 
 732   // And some dependencies don't have a context type at all,
 733   // e.g. evol_method.
 734   return NULL;
 735 }
 736 
 737 /// Checking dependencies:
 738 
 739 // This hierarchy walker inspects subtypes of a given type,
 740 // trying to find a "bad" class which breaks a dependency.
 741 // Such a class is called a "witness" to the broken dependency.
 742 // While searching around, we ignore "participants", which
 743 // are already known to the dependency.
 744 class ClassHierarchyWalker {
 745  public:
 746   enum { PARTICIPANT_LIMIT = 3 };
 747 
 748  private:
 749   // optional method descriptor to check for:
 750   Symbol* _name;
 751   Symbol* _signature;
 752 
 753   // special classes which are not allowed to be witnesses:
 754   Klass*    _participants[PARTICIPANT_LIMIT+1];
 755   int       _num_participants;
 756 
 757   // cache of method lookups
 758   Method* _found_methods[PARTICIPANT_LIMIT+1];
 759 
 760   // if non-zero, tells how many witnesses to convert to participants
 761   int       _record_witnesses;
 762 
 763   void initialize(Klass* participant) {
 764     _record_witnesses = 0;
 765     _participants[0]  = participant;
 766     _found_methods[0] = NULL;
 767     _num_participants = 0;
 768     if (participant != NULL) {
 769       // Terminating NULL.
 770       _participants[1] = NULL;
 771       _found_methods[1] = NULL;
 772       _num_participants = 1;
 773     }
 774   }
 775 
 776   void initialize_from_method(Method* m) {
 777     assert(m != NULL &amp;&amp; m-&gt;is_method(), "sanity");
 778     _name      = m-&gt;name();
 779     _signature = m-&gt;signature();
 780   }
 781 
 782  public:
 783   // The walker is initialized to recognize certain methods and/or types
 784   // as friendly participants.
 785   ClassHierarchyWalker(Klass* participant, Method* m) {
 786     initialize_from_method(m);
 787     initialize(participant);
 788   }
 789   ClassHierarchyWalker(Method* m) {
 790     initialize_from_method(m);
 791     initialize(NULL);
 792   }
 793   ClassHierarchyWalker(Klass* participant = NULL) {
 794     _name      = NULL;
 795     _signature = NULL;
 796     initialize(participant);
 797   }
 798 
 799   // This is common code for two searches:  One for concrete subtypes,
 800   // the other for concrete method implementations and overrides.
 801   bool doing_subtype_search() {
 802     return _name == NULL;
 803   }
 804 
 805   int num_participants() { return _num_participants; }
 806   Klass* participant(int n) {
 807     assert((uint)n &lt;= (uint)_num_participants, "oob");
 808     return _participants[n];
 809   }
 810 
 811   // Note:  If n==num_participants, returns NULL.
 812   Method* found_method(int n) {
 813     assert((uint)n &lt;= (uint)_num_participants, "oob");
 814     Method* fm = _found_methods[n];
 815     assert(n == _num_participants || fm != NULL, "proper usage");
 816     assert(fm == NULL || fm-&gt;method_holder() == _participants[n], "sanity");
 817     return fm;
 818   }
 819 
 820 #ifdef ASSERT
 821   // Assert that m is inherited into ctxk, without intervening overrides.
 822   // (May return true even if this is not true, in corner cases where we punt.)
 823   bool check_method_context(Klass* ctxk, Method* m) {
 824     if (m-&gt;method_holder() == ctxk)
 825       return true;  // Quick win.
 826     if (m-&gt;is_private())
 827       return false; // Quick lose.  Should not happen.
 828     if (!(m-&gt;is_public() || m-&gt;is_protected()))
 829       // The override story is complex when packages get involved.
 830       return true;  // Must punt the assertion to true.
 831     Klass* k = ctxk;
 832     Method* lm = k-&gt;lookup_method(m-&gt;name(), m-&gt;signature());
 833     if (lm == NULL &amp;&amp; k-&gt;oop_is_instance()) {
 834       // It might be an interface method
 835         lm = ((InstanceKlass*)k)-&gt;lookup_method_in_ordered_interfaces(m-&gt;name(),
 836                                                                 m-&gt;signature());
 837     }
 838     if (lm == m)
 839       // Method m is inherited into ctxk.
 840       return true;
 841     if (lm != NULL) {
 842       if (!(lm-&gt;is_public() || lm-&gt;is_protected())) {
 843         // Method is [package-]private, so the override story is complex.
 844         return true;  // Must punt the assertion to true.
 845       }
 846       if (lm-&gt;is_static()) {
 847         // Static methods don't override non-static so punt
 848         return true;
 849       }
 850       if (   !Dependencies::is_concrete_method(lm)
 851           &amp;&amp; !Dependencies::is_concrete_method(m)
 852           &amp;&amp; lm-&gt;method_holder()-&gt;is_subtype_of(m-&gt;method_holder()))
 853         // Method m is overridden by lm, but both are non-concrete.
 854         return true;
 855     }
 856     ResourceMark rm;
 857     tty-&gt;print_cr("Dependency method not found in the associated context:");
 858     tty-&gt;print_cr("  context = %s", ctxk-&gt;external_name());
 859     tty-&gt;print(   "  method = "); m-&gt;print_short_name(tty); tty-&gt;cr();
 860     if (lm != NULL) {
 861       tty-&gt;print( "  found = "); lm-&gt;print_short_name(tty); tty-&gt;cr();
 862     }
 863     return false;
 864   }
 865 #endif
 866 
 867   void add_participant(Klass* participant) {
 868     assert(_num_participants + _record_witnesses &lt; PARTICIPANT_LIMIT, "oob");
 869     int np = _num_participants++;
 870     _participants[np] = participant;
 871     _participants[np+1] = NULL;
 872     _found_methods[np+1] = NULL;
 873   }
 874 
 875   void record_witnesses(int add) {
 876     if (add &gt; PARTICIPANT_LIMIT)  add = PARTICIPANT_LIMIT;
 877     assert(_num_participants + add &lt; PARTICIPANT_LIMIT, "oob");
 878     _record_witnesses = add;
 879   }
 880 
 881   bool is_witness(Klass* k) {
 882     if (doing_subtype_search()) {
 883       return Dependencies::is_concrete_klass(k);
 884     } else {
 885       Method* m = InstanceKlass::cast(k)-&gt;find_method(_name, _signature);
 886       if (m == NULL || !Dependencies::is_concrete_method(m))  return false;
 887       _found_methods[_num_participants] = m;
 888       // Note:  If add_participant(k) is called,
 889       // the method m will already be memoized for it.
 890       return true;
 891     }
 892   }
 893 
 894   bool is_participant(Klass* k) {
 895     if (k == _participants[0]) {
 896       return true;
 897     } else if (_num_participants &lt;= 1) {
 898       return false;
 899     } else {
 900       return in_list(k, &amp;_participants[1]);
 901     }
 902   }
 903   bool ignore_witness(Klass* witness) {
 904     if (_record_witnesses == 0) {
 905       return false;
 906     } else {
 907       --_record_witnesses;
 908       add_participant(witness);
 909       return true;
 910     }
 911   }
 912   static bool in_list(Klass* x, Klass** list) {
 913     for (int i = 0; ; i++) {
 914       Klass* y = list[i];
 915       if (y == NULL)  break;
 916       if (y == x)  return true;
 917     }
 918     return false;  // not in list
 919   }
 920 
 921  private:
 922   // the actual search method:
 923   Klass* find_witness_anywhere(Klass* context_type,
 924                                  bool participants_hide_witnesses,
 925                                  bool top_level_call = true);
 926   // the spot-checking version:
 927   Klass* find_witness_in(KlassDepChange&amp; changes,
 928                          Klass* context_type,
 929                            bool participants_hide_witnesses);
 930  public:
 931   Klass* find_witness_subtype(Klass* context_type, KlassDepChange* changes = NULL) {
 932     assert(doing_subtype_search(), "must set up a subtype search");
 933     // When looking for unexpected concrete types,
 934     // do not look beneath expected ones.
 935     const bool participants_hide_witnesses = true;
 936     // CX &gt; CC &gt; C' is OK, even if C' is new.
 937     // CX &gt; { CC,  C' } is not OK if C' is new, and C' is the witness.
 938     if (changes != NULL) {
 939       return find_witness_in(*changes, context_type, participants_hide_witnesses);
 940     } else {
 941       return find_witness_anywhere(context_type, participants_hide_witnesses);
 942     }
 943   }
 944   Klass* find_witness_definer(Klass* context_type, KlassDepChange* changes = NULL) {
 945     assert(!doing_subtype_search(), "must set up a method definer search");
 946     // When looking for unexpected concrete methods,
 947     // look beneath expected ones, to see if there are overrides.
 948     const bool participants_hide_witnesses = true;
 949     // CX.m &gt; CC.m &gt; C'.m is not OK, if C'.m is new, and C' is the witness.
 950     if (changes != NULL) {
 951       return find_witness_in(*changes, context_type, !participants_hide_witnesses);
 952     } else {
 953       return find_witness_anywhere(context_type, !participants_hide_witnesses);
 954     }
 955   }
 956 };
 957 
 958 #ifndef PRODUCT
 959 static int deps_find_witness_calls = 0;
 960 static int deps_find_witness_steps = 0;
 961 static int deps_find_witness_recursions = 0;
 962 static int deps_find_witness_singles = 0;
 963 static int deps_find_witness_print = 0; // set to -1 to force a final print
 964 static bool count_find_witness_calls() {
 965   if (TraceDependencies || LogCompilation) {
 966     int pcount = deps_find_witness_print + 1;
 967     bool final_stats      = (pcount == 0);
 968     bool initial_call     = (pcount == 1);
 969     bool occasional_print = ((pcount &amp; ((1&lt;&lt;10) - 1)) == 0);
 970     if (pcount &lt; 0)  pcount = 1; // crude overflow protection
 971     deps_find_witness_print = pcount;
 972     if (VerifyDependencies &amp;&amp; initial_call) {
 973       tty-&gt;print_cr("Warning:  TraceDependencies results may be inflated by VerifyDependencies");
 974     }
 975     if (occasional_print || final_stats) {
 976       // Every now and then dump a little info about dependency searching.
 977       if (xtty != NULL) {
 978        ttyLocker ttyl;
 979        xtty-&gt;elem("deps_find_witness calls='%d' steps='%d' recursions='%d' singles='%d'",
 980                    deps_find_witness_calls,
 981                    deps_find_witness_steps,
 982                    deps_find_witness_recursions,
 983                    deps_find_witness_singles);
 984       }
 985       if (final_stats || (TraceDependencies &amp;&amp; WizardMode)) {
 986         ttyLocker ttyl;
 987         tty-&gt;print_cr("Dependency check (find_witness) "
 988                       "calls=%d, steps=%d (avg=%.1f), recursions=%d, singles=%d",
 989                       deps_find_witness_calls,
 990                       deps_find_witness_steps,
 991                       (double)deps_find_witness_steps / deps_find_witness_calls,
 992                       deps_find_witness_recursions,
 993                       deps_find_witness_singles);
 994       }
 995     }
 996     return true;
 997   }
 998   return false;
 999 }
1000 #else
1001 #define count_find_witness_calls() (0)
1002 #endif //PRODUCT
1003 
1004 
1005 Klass* ClassHierarchyWalker::find_witness_in(KlassDepChange&amp; changes,
1006                                                Klass* context_type,
1007                                                bool participants_hide_witnesses) {
1008   assert(changes.involves_context(context_type), "irrelevant dependency");
1009   Klass* new_type = changes.new_type();
1010 
1011   (void)count_find_witness_calls();
1012   NOT_PRODUCT(deps_find_witness_singles++);
1013 
1014   // Current thread must be in VM (not native mode, as in CI):
1015   assert(must_be_in_vm(), "raw oops here");
1016   // Must not move the class hierarchy during this check:
1017   assert_locked_or_safepoint(Compile_lock);
1018 
1019   int nof_impls = InstanceKlass::cast(context_type)-&gt;nof_implementors();
1020   if (nof_impls &gt; 1) {
1021     // Avoid this case: *I.m &gt; { A.m, C }; B.m &gt; C
1022     // %%% Until this is fixed more systematically, bail out.
1023     // See corresponding comment in find_witness_anywhere.
1024     return context_type;
1025   }
1026 
1027   assert(!is_participant(new_type), "only old classes are participants");
1028   if (participants_hide_witnesses) {
1029     // If the new type is a subtype of a participant, we are done.
1030     for (int i = 0; i &lt; num_participants(); i++) {
1031       Klass* part = participant(i);
1032       if (part == NULL)  continue;
1033       assert(changes.involves_context(part) == new_type-&gt;is_subtype_of(part),
1034              "correct marking of participants, b/c new_type is unique");
1035       if (changes.involves_context(part)) {
1036         // new guy is protected from this check by previous participant
1037         return NULL;
1038       }
1039     }
1040   }
1041 
1042   if (is_witness(new_type) &amp;&amp;
1043       !ignore_witness(new_type)) {
1044     return new_type;
1045   }
1046 
1047   return NULL;
1048 }
1049 
1050 
1051 // Walk hierarchy under a context type, looking for unexpected types.
1052 // Do not report participant types, and recursively walk beneath
1053 // them only if participants_hide_witnesses is false.
1054 // If top_level_call is false, skip testing the context type,
1055 // because the caller has already considered it.
1056 Klass* ClassHierarchyWalker::find_witness_anywhere(Klass* context_type,
1057                                                      bool participants_hide_witnesses,
1058                                                      bool top_level_call) {
1059   // Current thread must be in VM (not native mode, as in CI):
1060   assert(must_be_in_vm(), "raw oops here");
1061   // Must not move the class hierarchy during this check:
1062   assert_locked_or_safepoint(Compile_lock);
1063 
1064   bool do_counts = count_find_witness_calls();
1065 
1066   // Check the root of the sub-hierarchy first.
1067   if (top_level_call) {
1068     if (do_counts) {
1069       NOT_PRODUCT(deps_find_witness_calls++);
1070       NOT_PRODUCT(deps_find_witness_steps++);
1071     }
1072     if (is_participant(context_type)) {
1073       if (participants_hide_witnesses)  return NULL;
1074       // else fall through to search loop...
1075     } else if (is_witness(context_type) &amp;&amp; !ignore_witness(context_type)) {
1076       // The context is an abstract class or interface, to start with.
1077       return context_type;
1078     }
1079   }
1080 
1081   // Now we must check each implementor and each subclass.
1082   // Use a short worklist to avoid blowing the stack.
1083   // Each worklist entry is a *chain* of subklass siblings to process.
1084   const int CHAINMAX = 100;  // &gt;= 1 + InstanceKlass::implementors_limit
1085   Klass* chains[CHAINMAX];
1086   int    chaini = 0;  // index into worklist
1087   Klass* chain;       // scratch variable
1088 #define ADD_SUBCLASS_CHAIN(k)                     {  \
1089     assert(chaini &lt; CHAINMAX, "oob");                \
1090     chain = InstanceKlass::cast(k)-&gt;subklass();      \
1091     if (chain != NULL)  chains[chaini++] = chain;    }
1092 
1093   // Look for non-abstract subclasses.
1094   // (Note:  Interfaces do not have subclasses.)
1095   ADD_SUBCLASS_CHAIN(context_type);
1096 
1097   // If it is an interface, search its direct implementors.
1098   // (Their subclasses are additional indirect implementors.
1099   // See InstanceKlass::add_implementor.)
1100   // (Note:  nof_implementors is always zero for non-interfaces.)
1101   int nof_impls = InstanceKlass::cast(context_type)-&gt;nof_implementors();
1102   if (nof_impls &gt; 1) {
1103     // Avoid this case: *I.m &gt; { A.m, C }; B.m &gt; C
1104     // Here, I.m has 2 concrete implementations, but m appears unique
1105     // as A.m, because the search misses B.m when checking C.
1106     // The inherited method B.m was getting missed by the walker
1107     // when interface 'I' was the starting point.
1108     // %%% Until this is fixed more systematically, bail out.
1109     // (Old CHA had the same limitation.)
1110     return context_type;
1111   }
1112   if (nof_impls &gt; 0) {
1113     Klass* impl = InstanceKlass::cast(context_type)-&gt;implementor();
1114     assert(impl != NULL, "just checking");
1115     // If impl is the same as the context_type, then more than one
1116     // implementor has seen. No exact info in this case.
1117     if (impl == context_type) {
1118       return context_type;  // report an inexact witness to this sad affair
1119     }
1120     if (do_counts)
1121       { NOT_PRODUCT(deps_find_witness_steps++); }
1122     if (is_participant(impl)) {
1123       if (!participants_hide_witnesses) {
1124         ADD_SUBCLASS_CHAIN(impl);
1125       }
1126     } else if (is_witness(impl) &amp;&amp; !ignore_witness(impl)) {
1127       return impl;
1128     } else {
1129       ADD_SUBCLASS_CHAIN(impl);
1130     }
1131   }
1132 
1133   // Recursively process each non-trivial sibling chain.
1134   while (chaini &gt; 0) {
1135     Klass* chain = chains[--chaini];
1136     for (Klass* sub = chain; sub != NULL; sub = sub-&gt;next_sibling()) {
1137       if (do_counts) { NOT_PRODUCT(deps_find_witness_steps++); }
1138       if (is_participant(sub)) {
1139         if (participants_hide_witnesses)  continue;
1140         // else fall through to process this guy's subclasses
1141       } else if (is_witness(sub) &amp;&amp; !ignore_witness(sub)) {
1142         return sub;
1143       }
1144       if (chaini &lt; (VerifyDependencies? 2: CHAINMAX)) {
1145         // Fast path.  (Partially disabled if VerifyDependencies.)
1146         ADD_SUBCLASS_CHAIN(sub);
1147       } else {
1148         // Worklist overflow.  Do a recursive call.  Should be rare.
1149         // The recursive call will have its own worklist, of course.
1150         // (Note that sub has already been tested, so that there is
1151         // no need for the recursive call to re-test.  That's handy,
1152         // since the recursive call sees sub as the context_type.)
1153         if (do_counts) { NOT_PRODUCT(deps_find_witness_recursions++); }
1154         Klass* witness = find_witness_anywhere(sub,
1155                                                  participants_hide_witnesses,
1156                                                  /*top_level_call=*/ false);
1157         if (witness != NULL)  return witness;
1158       }
1159     }
1160   }
1161 
1162   // No witness found.  The dependency remains unbroken.
1163   return NULL;
1164 #undef ADD_SUBCLASS_CHAIN
1165 }
1166 
1167 
1168 bool Dependencies::is_concrete_klass(Klass* k) {
1169   if (k-&gt;is_abstract())  return false;
1170   // %%% We could treat classes which are concrete but
1171   // have not yet been instantiated as virtually abstract.
1172   // This would require a deoptimization barrier on first instantiation.
1173   //if (k-&gt;is_not_instantiated())  return false;
1174   return true;
1175 }
1176 
1177 bool Dependencies::is_concrete_method(Method* m) {
1178   // Statics are irrelevant to virtual call sites.
1179   if (m-&gt;is_static())  return false;
1180 
1181   // We could also return false if m does not yet appear to be
1182   // executed, if the VM version supports this distinction also.
1183   return !m-&gt;is_abstract() &amp;&amp;
1184          !InstanceKlass::cast(m-&gt;method_holder())-&gt;is_interface();
1185          // TODO: investigate whether default methods should be
1186          // considered as "concrete" in this situation.  For now they
1187          // are not.
1188 }
1189 
1190 
1191 Klass* Dependencies::find_finalizable_subclass(Klass* k) {
1192   if (k-&gt;is_interface())  return NULL;
1193   if (k-&gt;has_finalizer()) return k;
1194   k = k-&gt;subklass();
1195   while (k != NULL) {
1196     Klass* result = find_finalizable_subclass(k);
1197     if (result != NULL) return result;
1198     k = k-&gt;next_sibling();
1199   }
1200   return NULL;
1201 }
1202 
1203 
1204 bool Dependencies::is_concrete_klass(ciInstanceKlass* k) {
1205   if (k-&gt;is_abstract())  return false;
1206   // We could also return false if k does not yet appear to be
1207   // instantiated, if the VM version supports this distinction also.
1208   //if (k-&gt;is_not_instantiated())  return false;
1209   return true;
1210 }
1211 
1212 bool Dependencies::is_concrete_method(ciMethod* m) {
1213   // Statics are irrelevant to virtual call sites.
1214   if (m-&gt;is_static())  return false;
1215 
1216   // We could also return false if m does not yet appear to be
1217   // executed, if the VM version supports this distinction also.
1218   return !m-&gt;is_abstract();
1219 }
1220 
1221 
1222 bool Dependencies::has_finalizable_subclass(ciInstanceKlass* k) {
1223   return k-&gt;has_finalizable_subclass();
1224 }
1225 
1226 
1227 // Any use of the contents (bytecodes) of a method must be
1228 // marked by an "evol_method" dependency, if those contents
1229 // can change.  (Note: A method is always dependent on itself.)
1230 Klass* Dependencies::check_evol_method(Method* m) {
1231   assert(must_be_in_vm(), "raw oops here");
1232   // Did somebody do a JVMTI RedefineClasses while our backs were turned?
1233   // Or is there a now a breakpoint?
1234   // (Assumes compiled code cannot handle bkpts; change if UseFastBreakpoints.)
1235   if (m-&gt;is_old()
1236       || m-&gt;number_of_breakpoints() &gt; 0) {
1237     return m-&gt;method_holder();
1238   } else {
1239     return NULL;
1240   }
1241 }
1242 
1243 // This is a strong assertion:  It is that the given type
1244 // has no subtypes whatever.  It is most useful for
1245 // optimizing checks on reflected types or on array types.
1246 // (Checks on types which are derived from real instances
1247 // can be optimized more strongly than this, because we
1248 // know that the checked type comes from a concrete type,
1249 // and therefore we can disregard abstract types.)
1250 Klass* Dependencies::check_leaf_type(Klass* ctxk) {
1251   assert(must_be_in_vm(), "raw oops here");
1252   assert_locked_or_safepoint(Compile_lock);
1253   InstanceKlass* ctx = InstanceKlass::cast(ctxk);
1254   Klass* sub = ctx-&gt;subklass();
1255   if (sub != NULL) {
1256     return sub;
1257   } else if (ctx-&gt;nof_implementors() != 0) {
1258     // if it is an interface, it must be unimplemented
1259     // (if it is not an interface, nof_implementors is always zero)
1260     Klass* impl = ctx-&gt;implementor();
1261     assert(impl != NULL, "must be set");
1262     return impl;
1263   } else {
1264     return NULL;
1265   }
1266 }
1267 
1268 // Test the assertion that conck is the only concrete subtype* of ctxk.
1269 // The type conck itself is allowed to have have further concrete subtypes.
1270 // This allows the compiler to narrow occurrences of ctxk by conck,
1271 // when dealing with the types of actual instances.
1272 Klass* Dependencies::check_abstract_with_unique_concrete_subtype(Klass* ctxk,
1273                                                                    Klass* conck,
1274                                                                    KlassDepChange* changes) {
1275   ClassHierarchyWalker wf(conck);
1276   return wf.find_witness_subtype(ctxk, changes);
1277 }
1278 
1279 // If a non-concrete class has no concrete subtypes, it is not (yet)
1280 // instantiatable.  This can allow the compiler to make some paths go
1281 // dead, if they are gated by a test of the type.
1282 Klass* Dependencies::check_abstract_with_no_concrete_subtype(Klass* ctxk,
1283                                                                KlassDepChange* changes) {
1284   // Find any concrete subtype, with no participants:
1285   ClassHierarchyWalker wf;
1286   return wf.find_witness_subtype(ctxk, changes);
1287 }
1288 
1289 
1290 // If a concrete class has no concrete subtypes, it can always be
1291 // exactly typed.  This allows the use of a cheaper type test.
1292 Klass* Dependencies::check_concrete_with_no_concrete_subtype(Klass* ctxk,
1293                                                                KlassDepChange* changes) {
1294   // Find any concrete subtype, with only the ctxk as participant:
1295   ClassHierarchyWalker wf(ctxk);
1296   return wf.find_witness_subtype(ctxk, changes);
1297 }
1298 
1299 
1300 // Find the unique concrete proper subtype of ctxk, or NULL if there
1301 // is more than one concrete proper subtype.  If there are no concrete
1302 // proper subtypes, return ctxk itself, whether it is concrete or not.
1303 // The returned subtype is allowed to have have further concrete subtypes.
1304 // That is, return CC1 for CX &gt; CC1 &gt; CC2, but NULL for CX &gt; { CC1, CC2 }.
1305 Klass* Dependencies::find_unique_concrete_subtype(Klass* ctxk) {
1306   ClassHierarchyWalker wf(ctxk);   // Ignore ctxk when walking.
1307   wf.record_witnesses(1);          // Record one other witness when walking.
1308   Klass* wit = wf.find_witness_subtype(ctxk);
1309   if (wit != NULL)  return NULL;   // Too many witnesses.
1310   Klass* conck = wf.participant(0);
1311   if (conck == NULL) {
1312 #ifndef PRODUCT
1313     // Make sure the dependency mechanism will pass this discovery:
1314     if (VerifyDependencies) {
1315       // Turn off dependency tracing while actually testing deps.
1316       FlagSetting fs(TraceDependencies, false);
1317       if (!Dependencies::is_concrete_klass(ctxk)) {
1318         guarantee(NULL ==
1319                   (void *)check_abstract_with_no_concrete_subtype(ctxk),
1320                   "verify dep.");
1321       } else {
1322         guarantee(NULL ==
1323                   (void *)check_concrete_with_no_concrete_subtype(ctxk),
1324                   "verify dep.");
1325       }
1326     }
1327 #endif //PRODUCT
1328     return ctxk;                   // Return ctxk as a flag for "no subtypes".
1329   } else {
1330 #ifndef PRODUCT
1331     // Make sure the dependency mechanism will pass this discovery:
1332     if (VerifyDependencies) {
1333       // Turn off dependency tracing while actually testing deps.
1334       FlagSetting fs(TraceDependencies, false);
1335       if (!Dependencies::is_concrete_klass(ctxk)) {
1336         guarantee(NULL == (void *)
1337                   check_abstract_with_unique_concrete_subtype(ctxk, conck),
1338                   "verify dep.");
1339       }
1340     }
1341 #endif //PRODUCT
1342     return conck;
1343   }
1344 }
1345 
1346 // Test the assertion that the k[12] are the only concrete subtypes of ctxk,
1347 // except possibly for further subtypes of k[12] themselves.
1348 // The context type must be abstract.  The types k1 and k2 are themselves
1349 // allowed to have further concrete subtypes.
1350 Klass* Dependencies::check_abstract_with_exclusive_concrete_subtypes(
1351                                                 Klass* ctxk,
1352                                                 Klass* k1,
1353                                                 Klass* k2,
1354                                                 KlassDepChange* changes) {
1355   ClassHierarchyWalker wf;
1356   wf.add_participant(k1);
1357   wf.add_participant(k2);
1358   return wf.find_witness_subtype(ctxk, changes);
1359 }
1360 
1361 // Search ctxk for concrete implementations.  If there are klen or fewer,
1362 // pack them into the given array and return the number.
1363 // Otherwise, return -1, meaning the given array would overflow.
1364 // (Note that a return of 0 means there are exactly no concrete subtypes.)
1365 // In this search, if ctxk is concrete, it will be reported alone.
1366 // For any type CC reported, no proper subtypes of CC will be reported.
1367 int Dependencies::find_exclusive_concrete_subtypes(Klass* ctxk,
1368                                                    int klen,
1369                                                    Klass* karray[]) {
1370   ClassHierarchyWalker wf;
1371   wf.record_witnesses(klen);
1372   Klass* wit = wf.find_witness_subtype(ctxk);
1373   if (wit != NULL)  return -1;  // Too many witnesses.
1374   int num = wf.num_participants();
1375   assert(num &lt;= klen, "oob");
1376   // Pack the result array with the good news.
1377   for (int i = 0; i &lt; num; i++)
1378     karray[i] = wf.participant(i);
1379 #ifndef PRODUCT
1380   // Make sure the dependency mechanism will pass this discovery:
1381   if (VerifyDependencies) {
1382     // Turn off dependency tracing while actually testing deps.
1383     FlagSetting fs(TraceDependencies, false);
1384     switch (Dependencies::is_concrete_klass(ctxk)? -1: num) {
1385     case -1: // ctxk was itself concrete
1386       guarantee(num == 1 &amp;&amp; karray[0] == ctxk, "verify dep.");
1387       break;
1388     case 0:
1389       guarantee(NULL == (void *)check_abstract_with_no_concrete_subtype(ctxk),
1390                 "verify dep.");
1391       break;
1392     case 1:
1393       guarantee(NULL == (void *)
1394                 check_abstract_with_unique_concrete_subtype(ctxk, karray[0]),
1395                 "verify dep.");
1396       break;
1397     case 2:
1398       guarantee(NULL == (void *)
1399                 check_abstract_with_exclusive_concrete_subtypes(ctxk,
1400                                                                 karray[0],
1401                                                                 karray[1]),
1402                 "verify dep.");
1403       break;
1404     default:
1405       ShouldNotReachHere();  // klen &gt; 2 yet supported
1406     }
1407   }
1408 #endif //PRODUCT
1409   return num;
1410 }
1411 
1412 // If a class (or interface) has a unique concrete method uniqm, return NULL.
1413 // Otherwise, return a class that contains an interfering method.
1414 Klass* Dependencies::check_unique_concrete_method(Klass* ctxk, Method* uniqm,
1415                                                     KlassDepChange* changes) {
1416   // Here is a missing optimization:  If uniqm-&gt;is_final(),
1417   // we don't really need to search beneath it for overrides.
1418   // This is probably not important, since we don't use dependencies
1419   // to track final methods.  (They can't be "definalized".)
1420   ClassHierarchyWalker wf(uniqm-&gt;method_holder(), uniqm);
1421   return wf.find_witness_definer(ctxk, changes);
1422 }
1423 
1424 // Find the set of all non-abstract methods under ctxk that match m.
1425 // (The method m must be defined or inherited in ctxk.)
1426 // Include m itself in the set, unless it is abstract.
1427 // If this set has exactly one element, return that element.
1428 Method* Dependencies::find_unique_concrete_method(Klass* ctxk, Method* m) {
1429   ClassHierarchyWalker wf(m);
1430   assert(wf.check_method_context(ctxk, m), "proper context");
1431   wf.record_witnesses(1);
1432   Klass* wit = wf.find_witness_definer(ctxk);
1433   if (wit != NULL)  return NULL;  // Too many witnesses.
1434   Method* fm = wf.found_method(0);  // Will be NULL if num_parts == 0.
1435   if (Dependencies::is_concrete_method(m)) {
1436     if (fm == NULL) {
1437       // It turns out that m was always the only implementation.
1438       fm = m;
1439     } else if (fm != m) {
1440       // Two conflicting implementations after all.
1441       // (This can happen if m is inherited into ctxk and fm overrides it.)
1442       return NULL;
1443     }
1444   }
1445 #ifndef PRODUCT
1446   // Make sure the dependency mechanism will pass this discovery:
1447   if (VerifyDependencies &amp;&amp; fm != NULL) {
1448     guarantee(NULL == (void *)check_unique_concrete_method(ctxk, fm),
1449               "verify dep.");
1450   }
1451 #endif //PRODUCT
1452   return fm;
1453 }
1454 
1455 Klass* Dependencies::check_exclusive_concrete_methods(Klass* ctxk,
1456                                                         Method* m1,
1457                                                         Method* m2,
1458                                                         KlassDepChange* changes) {
1459   ClassHierarchyWalker wf(m1);
1460   wf.add_participant(m1-&gt;method_holder());
1461   wf.add_participant(m2-&gt;method_holder());
1462   return wf.find_witness_definer(ctxk, changes);
1463 }
1464 
1465 // Find the set of all non-abstract methods under ctxk that match m[0].
1466 // (The method m[0] must be defined or inherited in ctxk.)
1467 // Include m itself in the set, unless it is abstract.
1468 // Fill the given array m[0..(mlen-1)] with this set, and return the length.
1469 // (The length may be zero if no concrete methods are found anywhere.)
1470 // If there are too many concrete methods to fit in marray, return -1.
1471 int Dependencies::find_exclusive_concrete_methods(Klass* ctxk,
1472                                                   int mlen,
1473                                                   Method* marray[]) {
1474   Method* m0 = marray[0];
1475   ClassHierarchyWalker wf(m0);
1476   assert(wf.check_method_context(ctxk, m0), "proper context");
1477   wf.record_witnesses(mlen);
1478   bool participants_hide_witnesses = true;
1479   Klass* wit = wf.find_witness_definer(ctxk);
1480   if (wit != NULL)  return -1;  // Too many witnesses.
1481   int num = wf.num_participants();
1482   assert(num &lt;= mlen, "oob");
1483   // Keep track of whether m is also part of the result set.
1484   int mfill = 0;
1485   assert(marray[mfill] == m0, "sanity");
1486   if (Dependencies::is_concrete_method(m0))
1487     mfill++;  // keep m0 as marray[0], the first result
1488   for (int i = 0; i &lt; num; i++) {
1489     Method* fm = wf.found_method(i);
1490     if (fm == m0)  continue;  // Already put this guy in the list.
1491     if (mfill == mlen) {
1492       return -1;              // Oops.  Too many methods after all!
1493     }
1494     marray[mfill++] = fm;
1495   }
1496 #ifndef PRODUCT
1497   // Make sure the dependency mechanism will pass this discovery:
1498   if (VerifyDependencies) {
1499     // Turn off dependency tracing while actually testing deps.
1500     FlagSetting fs(TraceDependencies, false);
1501     switch (mfill) {
1502     case 1:
1503       guarantee(NULL == (void *)check_unique_concrete_method(ctxk, marray[0]),
1504                 "verify dep.");
1505       break;
1506     case 2:
1507       guarantee(NULL == (void *)
1508                 check_exclusive_concrete_methods(ctxk, marray[0], marray[1]),
1509                 "verify dep.");
1510       break;
1511     default:
1512       ShouldNotReachHere();  // mlen &gt; 2 yet supported
1513     }
1514   }
1515 #endif //PRODUCT
1516   return mfill;
1517 }
1518 
1519 
1520 Klass* Dependencies::check_has_no_finalizable_subclasses(Klass* ctxk, KlassDepChange* changes) {
1521   Klass* search_at = ctxk;
1522   if (changes != NULL)
1523     search_at = changes-&gt;new_type(); // just look at the new bit
1524   return find_finalizable_subclass(search_at);
1525 }
1526 
1527 
1528 Klass* Dependencies::check_call_site_target_value(oop call_site, oop method_handle, CallSiteDepChange* changes) {
1529   assert(call_site    -&gt;is_a(SystemDictionary::CallSite_klass()),     "sanity");
1530   assert(method_handle-&gt;is_a(SystemDictionary::MethodHandle_klass()), "sanity");
1531   if (changes == NULL) {
1532     // Validate all CallSites
1533     if (java_lang_invoke_CallSite::target(call_site) != method_handle)
1534       return call_site-&gt;klass();  // assertion failed
1535   } else {
1536     // Validate the given CallSite
1537     if (call_site == changes-&gt;call_site() &amp;&amp; java_lang_invoke_CallSite::target(call_site) != changes-&gt;method_handle()) {
1538       assert(method_handle != changes-&gt;method_handle(), "must be");
1539       return call_site-&gt;klass();  // assertion failed
1540     }
1541   }
1542   return NULL;  // assertion still valid
1543 }
1544 
1545 
1546 void Dependencies::DepStream::trace_and_log_witness(Klass* witness) {
1547   if (witness != NULL) {
1548     if (TraceDependencies) {
1549       print_dependency(witness, /*verbose=*/ true);
1550     }
1551     // The following is a no-op unless logging is enabled:
1552     log_dependency(witness);
1553   }
1554 }
1555 
1556 
1557 Klass* Dependencies::DepStream::check_klass_dependency(KlassDepChange* changes) {
1558   assert_locked_or_safepoint(Compile_lock);
1559   Dependencies::check_valid_dependency_type(type());
1560 
1561   Klass* witness = NULL;
1562   switch (type()) {
1563   case evol_method:
1564     witness = check_evol_method(method_argument(0));
1565     break;
1566   case leaf_type:
1567     witness = check_leaf_type(context_type());
1568     break;
1569   case abstract_with_unique_concrete_subtype:
1570     witness = check_abstract_with_unique_concrete_subtype(context_type(), type_argument(1), changes);
1571     break;
1572   case abstract_with_no_concrete_subtype:
1573     witness = check_abstract_with_no_concrete_subtype(context_type(), changes);
1574     break;
1575   case concrete_with_no_concrete_subtype:
1576     witness = check_concrete_with_no_concrete_subtype(context_type(), changes);
1577     break;
1578   case unique_concrete_method:
1579     witness = check_unique_concrete_method(context_type(), method_argument(1), changes);
1580     break;
1581   case abstract_with_exclusive_concrete_subtypes_2:
1582     witness = check_abstract_with_exclusive_concrete_subtypes(context_type(), type_argument(1), type_argument(2), changes);
1583     break;
1584   case exclusive_concrete_methods_2:
1585     witness = check_exclusive_concrete_methods(context_type(), method_argument(1), method_argument(2), changes);
1586     break;
1587   case no_finalizable_subclasses:
1588     witness = check_has_no_finalizable_subclasses(context_type(), changes);
1589     break;
1590   default:
1591     witness = NULL;
1592     break;
1593   }
1594   trace_and_log_witness(witness);
1595   return witness;
1596 }
1597 
1598 
1599 Klass* Dependencies::DepStream::check_call_site_dependency(CallSiteDepChange* changes) {
1600   assert_locked_or_safepoint(Compile_lock);
1601   Dependencies::check_valid_dependency_type(type());
1602 
1603   Klass* witness = NULL;
1604   switch (type()) {
1605   case call_site_target_value:
1606     witness = check_call_site_target_value(argument_oop(0), argument_oop(1), changes);
1607     break;
1608   default:
1609     witness = NULL;
1610     break;
1611   }
1612   trace_and_log_witness(witness);
1613   return witness;
1614 }
1615 
1616 
1617 Klass* Dependencies::DepStream::spot_check_dependency_at(DepChange&amp; changes) {
1618   // Handle klass dependency
1619   if (changes.is_klass_change() &amp;&amp; changes.as_klass_change()-&gt;involves_context(context_type()))
1620     return check_klass_dependency(changes.as_klass_change());
1621 
1622   // Handle CallSite dependency
1623   if (changes.is_call_site_change())
1624     return check_call_site_dependency(changes.as_call_site_change());
1625 
1626   // irrelevant dependency; skip it
1627   return NULL;
1628 }
1629 
1630 
1631 void DepChange::print() {
1632   int nsup = 0, nint = 0;
1633   for (ContextStream str(*this); str.next(); ) {
1634     Klass* k = str.klass();
1635     switch (str.change_type()) {
1636     case Change_new_type:
1637       tty-&gt;print_cr("  dependee = %s", InstanceKlass::cast(k)-&gt;external_name());
1638       break;
1639     case Change_new_sub:
1640       if (!WizardMode) {
1641         ++nsup;
1642       } else {
1643         tty-&gt;print_cr("  context super = %s", InstanceKlass::cast(k)-&gt;external_name());
1644       }
1645       break;
1646     case Change_new_impl:
1647       if (!WizardMode) {
1648         ++nint;
1649       } else {
1650         tty-&gt;print_cr("  context interface = %s", InstanceKlass::cast(k)-&gt;external_name());
1651       }
1652       break;
1653     }
1654   }
1655   if (nsup + nint != 0) {
1656     tty-&gt;print_cr("  context supers = %d, interfaces = %d", nsup, nint);
1657   }
1658 }
1659 
1660 void DepChange::ContextStream::start() {
1661   Klass* new_type = _changes.is_klass_change() ? _changes.as_klass_change()-&gt;new_type() : (Klass*) NULL;
1662   _change_type = (new_type == NULL ? NO_CHANGE : Start_Klass);
1663   _klass = new_type;
1664   _ti_base = NULL;
1665   _ti_index = 0;
1666   _ti_limit = 0;
1667 }
1668 
1669 bool DepChange::ContextStream::next() {
1670   switch (_change_type) {
1671   case Start_Klass:             // initial state; _klass is the new type
1672     _ti_base = InstanceKlass::cast(_klass)-&gt;transitive_interfaces();
1673     _ti_index = 0;
1674     _change_type = Change_new_type;
1675     return true;
1676   case Change_new_type:
1677     // fall through:
1678     _change_type = Change_new_sub;
1679   case Change_new_sub:
1680     // 6598190: brackets workaround Sun Studio C++ compiler bug 6629277
1681     {
1682       _klass = InstanceKlass::cast(_klass)-&gt;super();
1683       if (_klass != NULL) {
1684         return true;
1685       }
1686     }
1687     // else set up _ti_limit and fall through:
1688     _ti_limit = (_ti_base == NULL) ? 0 : _ti_base-&gt;length();
1689     _change_type = Change_new_impl;
1690   case Change_new_impl:
1691     if (_ti_index &lt; _ti_limit) {
1692       _klass = _ti_base-&gt;at(_ti_index++);
1693       return true;
1694     }
1695     // fall through:
1696     _change_type = NO_CHANGE;  // iterator is exhausted
1697   case NO_CHANGE:
1698     break;
1699   default:
1700     ShouldNotReachHere();
1701   }
1702   return false;
1703 }
1704 
1705 void KlassDepChange::initialize() {
1706   // entire transaction must be under this lock:
1707   assert_lock_strong(Compile_lock);
1708 
1709   // Mark all dependee and all its superclasses
1710   // Mark transitive interfaces
1711   for (ContextStream str(*this); str.next(); ) {
1712     Klass* d = str.klass();
1713     assert(!InstanceKlass::cast(d)-&gt;is_marked_dependent(), "checking");
1714     InstanceKlass::cast(d)-&gt;set_is_marked_dependent(true);
1715   }
1716 }
1717 
1718 KlassDepChange::~KlassDepChange() {
1719   // Unmark all dependee and all its superclasses
1720   // Unmark transitive interfaces
1721   for (ContextStream str(*this); str.next(); ) {
1722     Klass* d = str.klass();
1723     InstanceKlass::cast(d)-&gt;set_is_marked_dependent(false);
1724   }
1725 }
1726 
1727 bool KlassDepChange::involves_context(Klass* k) {
1728   if (k == NULL || !k-&gt;oop_is_instance()) {
1729     return false;
1730   }
1731   InstanceKlass* ik = InstanceKlass::cast(k);
1732   bool is_contained = ik-&gt;is_marked_dependent();
1733   assert(is_contained == new_type()-&gt;is_subtype_of(k),
1734          "correct marking of potential context types");
1735   return is_contained;
1736 }
1737 
1738 #ifndef PRODUCT
1739 void Dependencies::print_statistics() {
1740   if (deps_find_witness_print != 0) {
1741     // Call one final time, to flush out the data.
1742     deps_find_witness_print = -1;
1743     count_find_witness_calls();
1744   }
1745 }
1746 #endif
</pre></body></html>
