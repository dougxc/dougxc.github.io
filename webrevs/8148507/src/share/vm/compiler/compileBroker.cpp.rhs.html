<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre></pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 1999, 2015, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/symbolTable.hpp"
  27 #include "classfile/systemDictionary.hpp"
  28 #include "classfile/vmSymbols.hpp"
  29 #include "code/codeCache.hpp"
  30 #include "code/dependencyContext.hpp"
  31 #include "compiler/compileBroker.hpp"
  32 #include "compiler/compileLog.hpp"
  33 #include "compiler/compilerOracle.hpp"
  34 #include "compiler/directivesParser.hpp"
  35 #include "interpreter/linkResolver.hpp"
  36 #include "memory/allocation.inline.hpp"
  37 #include "oops/methodData.hpp"
  38 #include "oops/method.hpp"
  39 #include "oops/oop.inline.hpp"
  40 #include "prims/nativeLookup.hpp"
  41 #include "prims/whitebox.hpp"
  42 #include "runtime/arguments.hpp"
  43 #include "runtime/atomic.inline.hpp"
  44 #include "runtime/compilationPolicy.hpp"
  45 #include "runtime/init.hpp"
  46 #include "runtime/interfaceSupport.hpp"
  47 #include "runtime/javaCalls.hpp"
  48 #include "runtime/os.hpp"
  49 #include "runtime/sharedRuntime.hpp"
  50 #include "runtime/sweeper.hpp"
  51 #include "trace/tracing.hpp"
  52 #include "utilities/dtrace.hpp"
  53 #include "utilities/events.hpp"
  54 #ifdef COMPILER1
  55 #include "c1/c1_Compiler.hpp"
  56 #endif
  57 #if INCLUDE_JVMCI
  58 #include "jvmci/jvmciCompiler.hpp"
  59 #include "jvmci/jvmciRuntime.hpp"
  60 #include "jvmci/jvmciJavaClasses.hpp"
  61 #include "runtime/vframe.hpp"
  62 #endif
  63 #ifdef COMPILER2
  64 #include "opto/c2compiler.hpp"
  65 #endif
  66 #ifdef SHARK
  67 #include "shark/sharkCompiler.hpp"
  68 #endif
  69 
  70 #ifdef DTRACE_ENABLED
  71 
  72 // Only bother with this argument setup if dtrace is available
  73 
  74 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  75   {                                                                      \
  76     Symbol* klass_name = (method)-&gt;klass_name();                         \
  77     Symbol* name = (method)-&gt;name();                                     \
  78     Symbol* signature = (method)-&gt;signature();                           \
  79     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  80       (char *) comp_name, strlen(comp_name),                             \
  81       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  82       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  83       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  84   }
  85 
  86 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  87   {                                                                      \
  88     Symbol* klass_name = (method)-&gt;klass_name();                         \
  89     Symbol* name = (method)-&gt;name();                                     \
  90     Symbol* signature = (method)-&gt;signature();                           \
  91     HOTSPOT_METHOD_COMPILE_END(                                          \
  92       (char *) comp_name, strlen(comp_name),                             \
  93       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  94       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  95       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
  96   }
  97 
  98 #else //  ndef DTRACE_ENABLED
  99 
 100 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 101 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 102 
 103 #endif // ndef DTRACE_ENABLED
 104 
 105 bool CompileBroker::_initialized = false;
 106 volatile bool CompileBroker::_should_block = false;
 107 volatile jint CompileBroker::_print_compilation_warning = 0;
 108 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 109 
 110 // The installed compiler(s)
 111 AbstractCompiler* CompileBroker::_compilers[2];
 112 
 113 // These counters are used to assign an unique ID to each compilation.
 114 volatile jint CompileBroker::_compilation_id     = 0;
 115 volatile jint CompileBroker::_osr_compilation_id = 0;
 116 
 117 // Debugging information
 118 int  CompileBroker::_last_compile_type     = no_compile;
 119 int  CompileBroker::_last_compile_level    = CompLevel_none;
 120 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 121 
 122 // Performance counters
 123 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 124 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 125 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 126 
 127 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 128 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 129 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 130 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 131 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 132 
 133 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 134 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 135 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 136 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 137 
 138 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 139 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 140 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 141 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 142 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 143 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 144 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 145 
 146 // Timers and counters for generating statistics
 147 elapsedTimer CompileBroker::_t_total_compilation;
 148 elapsedTimer CompileBroker::_t_osr_compilation;
 149 elapsedTimer CompileBroker::_t_standard_compilation;
 150 elapsedTimer CompileBroker::_t_invalidated_compilation;
 151 elapsedTimer CompileBroker::_t_bailedout_compilation;
 152 
 153 int CompileBroker::_total_bailout_count          = 0;
 154 int CompileBroker::_total_invalidated_count      = 0;
 155 int CompileBroker::_total_compile_count          = 0;
 156 int CompileBroker::_total_osr_compile_count      = 0;
 157 int CompileBroker::_total_standard_compile_count = 0;
 158 
 159 int CompileBroker::_sum_osr_bytes_compiled       = 0;
 160 int CompileBroker::_sum_standard_bytes_compiled  = 0;
 161 int CompileBroker::_sum_nmethod_size             = 0;
 162 int CompileBroker::_sum_nmethod_code_size        = 0;
 163 
 164 long CompileBroker::_peak_compilation_time       = 0;
 165 
 166 CompileQueue* CompileBroker::_c2_compile_queue   = NULL;
 167 CompileQueue* CompileBroker::_c1_compile_queue   = NULL;
 168 
 169 class CompilationLog : public StringEventLog {
 170  public:
 171   CompilationLog() : StringEventLog("Compilation events") {
 172   }
 173 
 174   void log_compile(JavaThread* thread, CompileTask* task) {
 175     StringLogMessage lm;
 176     stringStream sstr = lm.stream();
 177     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 178     task-&gt;print(&amp;sstr, NULL, true, false);
 179     log(thread, "%s", (const char*)lm);
 180   }
 181 
 182   void log_nmethod(JavaThread* thread, nmethod* nm) {
 183     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 184         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 185         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 186   }
 187 
 188   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 189     StringLogMessage lm;
 190     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 191     if (retry_message != NULL) {
 192       lm.append(" (%s)", retry_message);
 193     }
 194     lm.print("\n");
 195     log(thread, "%s", (const char*)lm);
 196   }
 197 
 198   void log_metaspace_failure(const char* reason) {
 199     ResourceMark rm;
 200     StringLogMessage lm;
 201     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 202     lm.print("\n");
 203     log(JavaThread::current(), "%s", (const char*)lm);
 204   }
 205 };
 206 
 207 static CompilationLog* _compilation_log = NULL;
 208 
 209 bool compileBroker_init() {
 210   if (LogEvents) {
 211     _compilation_log = new CompilationLog();
 212   }
 213 
 214   // init directives stack, adding default directive
 215   DirectivesStack::init();
 216 
 217   if (DirectivesParser::has_file()) {
 218     return DirectivesParser::parse_from_flag();
 219   } else if (CompilerDirectivesPrint) {
 220     // Print default directive even when no other was added
 221     DirectivesStack::print(tty);
 222   }
 223 
 224   return true;
 225 }
 226 
 227 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 228   CompilerThread* thread = CompilerThread::current();
 229   thread-&gt;set_task(task);
 230 #if INCLUDE_JVMCI
 231   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 232     task-&gt;set_jvmci_compiler_thread(thread);
 233   }
 234 #endif
 235   CompileLog*     log  = thread-&gt;log();
 236   if (log != NULL)  task-&gt;log_task_start(log);
 237 }
 238 
 239 CompileTaskWrapper::~CompileTaskWrapper() {
 240   CompilerThread* thread = CompilerThread::current();
 241   CompileTask* task = thread-&gt;task();
 242   CompileLog*  log  = thread-&gt;log();
 243   if (log != NULL)  task-&gt;log_task_done(log);
 244   thread-&gt;set_task(NULL);
 245   task-&gt;set_code_handle(NULL);
 246   thread-&gt;set_env(NULL);
 247   if (task-&gt;is_blocking()) {
 248     bool free_task = false;
 249     {
 250       MutexLocker notifier(task-&gt;lock(), thread);
 251       task-&gt;mark_complete();
 252 #if INCLUDE_JVMCI
 253       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 254         if (!task-&gt;has_waiter()) {
 255           // The waiting thread timed out and thus did not free the task.
 256           free_task = true;
 257         }
 258         task-&gt;set_jvmci_compiler_thread(NULL);
 259       }
 260 #endif
 261       if (!free_task) {
 262         // Notify the waiting thread that the compilation has completed
 263         // so that it can free the task.
 264         task-&gt;lock()-&gt;notify_all();
 265       }
 266     }
 267     if (free_task) {
 268       // The task can only be freed once the task lock is released.
 269       CompileTask::free(task);
 270     }
 271   } else {
 272     task-&gt;mark_complete();
 273 
 274     // By convention, the compiling thread is responsible for
 275     // recycling a non-blocking CompileTask.
 276     CompileTask::free(task);
 277   }
 278 }
 279 
 280 /**
 281  * Add a CompileTask to a CompileQueue.
 282  */
 283 void CompileQueue::add(CompileTask* task) {
 284   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 285 
 286   task-&gt;set_next(NULL);
 287   task-&gt;set_prev(NULL);
 288 
 289   if (_last == NULL) {
 290     // The compile queue is empty.
 291     assert(_first == NULL, "queue is empty");
 292     _first = task;
 293     _last = task;
 294   } else {
 295     // Append the task to the queue.
 296     assert(_last-&gt;next() == NULL, "not last");
 297     _last-&gt;set_next(task);
 298     task-&gt;set_prev(_last);
 299     _last = task;
 300   }
 301   ++_size;
 302 
 303   // Mark the method as being in the compile queue.
 304   task-&gt;method()-&gt;set_queued_for_compilation();
 305 
 306   if (CIPrintCompileQueue) {
 307     print_tty();
 308   }
 309 
 310   if (LogCompilation &amp;&amp; xtty != NULL) {
 311     task-&gt;log_task_queued();
 312   }
 313 
 314   // Notify CompilerThreads that a task is available.
 315   MethodCompileQueue_lock-&gt;notify_all();
 316 }
 317 
 318 /**
 319  * Empties compilation queue by putting all compilation tasks onto
 320  * a freelist. Furthermore, the method wakes up all threads that are
 321  * waiting on a compilation task to finish. This can happen if background
 322  * compilation is disabled.
 323  */
 324 void CompileQueue::free_all() {
 325   MutexLocker mu(MethodCompileQueue_lock);
 326   CompileTask* next = _first;
 327 
 328   // Iterate over all tasks in the compile queue
 329   while (next != NULL) {
 330     CompileTask* current = next;
 331     next = current-&gt;next();
 332     {
 333       // Wake up thread that blocks on the compile task.
 334       MutexLocker ct_lock(current-&gt;lock());
 335       current-&gt;lock()-&gt;notify();
 336     }
 337     // Put the task back on the freelist.
 338     CompileTask::free(current);
 339   }
 340   _first = NULL;
 341 
 342   // Wake up all threads that block on the queue.
 343   MethodCompileQueue_lock-&gt;notify_all();
 344 }
 345 
 346 /**
 347  * Get the next CompileTask from a CompileQueue
 348  */
 349 CompileTask* CompileQueue::get() {
 350   // save methods from RedefineClasses across safepoint
 351   // across MethodCompileQueue_lock below.
 352   methodHandle save_method;
 353   methodHandle save_hot_method;
 354 
 355   MutexLocker locker(MethodCompileQueue_lock);
 356   // If _first is NULL we have no more compile jobs. There are two reasons for
 357   // having no compile jobs: First, we compiled everything we wanted. Second,
 358   // we ran out of code cache so compilation has been disabled. In the latter
 359   // case we perform code cache sweeps to free memory such that we can re-enable
 360   // compilation.
 361   while (_first == NULL) {
 362     // Exit loop if compilation is disabled forever
 363     if (CompileBroker::is_compilation_disabled_forever()) {
 364       return NULL;
 365     }
 366 
 367     // If there are no compilation tasks and we can compile new jobs
 368     // (i.e., there is enough free space in the code cache) there is
 369     // no need to invoke the sweeper. As a result, the hotness of methods
 370     // remains unchanged. This behavior is desired, since we want to keep
 371     // the stable state, i.e., we do not want to evict methods from the
 372     // code cache if it is unnecessary.
 373     // We need a timed wait here, since compiler threads can exit if compilation
 374     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 375     // is not critical and we do not want idle compiler threads to wake up too often.
 376     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 377   }
 378 
 379   if (CompileBroker::is_compilation_disabled_forever()) {
 380     return NULL;
 381   }
 382 
 383   CompileTask* task;
 384   {
 385     NoSafepointVerifier nsv;
 386     task = CompilationPolicy::policy()-&gt;select_task(this);
 387   }
 388 
 389   // Save method pointers across unlock safepoint.  The task is removed from
 390   // the compilation queue, which is walked during RedefineClasses.
 391   save_method = methodHandle(task-&gt;method());
 392   save_hot_method = methodHandle(task-&gt;hot_method());
 393 
 394   remove(task);
 395   purge_stale_tasks(); // may temporarily release MCQ lock
 396   return task;
 397 }
 398 
 399 // Clean &amp; deallocate stale compile tasks.
 400 // Temporarily releases MethodCompileQueue lock.
 401 void CompileQueue::purge_stale_tasks() {
 402   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 403   if (_first_stale != NULL) {
 404     // Stale tasks are purged when MCQ lock is released,
 405     // but _first_stale updates are protected by MCQ lock.
 406     // Once task processing starts and MCQ lock is released,
 407     // other compiler threads can reuse _first_stale.
 408     CompileTask* head = _first_stale;
 409     _first_stale = NULL;
 410     {
 411       MutexUnlocker ul(MethodCompileQueue_lock);
 412       for (CompileTask* task = head; task != NULL; ) {
 413         CompileTask* next_task = task-&gt;next();
 414         CompileTaskWrapper ctw(task); // Frees the task
 415         task-&gt;set_failure_reason("stale task");
 416         task = next_task;
 417       }
 418     }
 419   }
 420 }
 421 
 422 void CompileQueue::remove(CompileTask* task) {
 423    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 424   if (task-&gt;prev() != NULL) {
 425     task-&gt;prev()-&gt;set_next(task-&gt;next());
 426   } else {
 427     // max is the first element
 428     assert(task == _first, "Sanity");
 429     _first = task-&gt;next();
 430   }
 431 
 432   if (task-&gt;next() != NULL) {
 433     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 434   } else {
 435     // max is the last element
 436     assert(task == _last, "Sanity");
 437     _last = task-&gt;prev();
 438   }
 439   --_size;
 440 }
 441 
 442 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 443   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 444   remove(task);
 445 
 446   // Enqueue the task for reclamation (should be done outside MCQ lock)
 447   task-&gt;set_next(_first_stale);
 448   task-&gt;set_prev(NULL);
 449   _first_stale = task;
 450 }
 451 
 452 // methods in the compile queue need to be marked as used on the stack
 453 // so that they don't get reclaimed by Redefine Classes
 454 void CompileQueue::mark_on_stack() {
 455   CompileTask* task = _first;
 456   while (task != NULL) {
 457     task-&gt;mark_on_stack();
 458     task = task-&gt;next();
 459   }
 460 }
 461 
 462 
 463 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 464   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 465   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 466   return NULL;
 467 }
 468 
 469 
 470 void CompileBroker::print_compile_queues(outputStream* st) {
 471   MutexLocker locker(MethodCompileQueue_lock);
 472   if (_c1_compile_queue != NULL) {
 473     _c1_compile_queue-&gt;print(st);
 474   }
 475   if (_c2_compile_queue != NULL) {
 476     _c2_compile_queue-&gt;print(st);
 477   }
 478 }
 479 
 480 void CompileQueue::print(outputStream* st) {
 481   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 482   st-&gt;print_cr("Contents of %s", name());
 483   st-&gt;print_cr("----------------------------");
 484   CompileTask* task = _first;
 485   if (task == NULL) {
 486     st-&gt;print_cr("Empty");
 487   } else {
 488     while (task != NULL) {
 489       task-&gt;print(st, NULL, true, true);
 490       task = task-&gt;next();
 491     }
 492   }
 493   st-&gt;print_cr("----------------------------");
 494 }
 495 
 496 void CompileQueue::print_tty() {
 497   ttyLocker ttyl;
 498   print(tty);
 499 }
 500 
 501 CompilerCounters::CompilerCounters() {
 502   _current_method[0] = '\0';
 503   _compile_type = CompileBroker::no_compile;
 504 }
 505 
 506 // ------------------------------------------------------------------
 507 // CompileBroker::compilation_init
 508 //
 509 // Initialize the Compilation object
 510 void CompileBroker::compilation_init(TRAPS) {
 511   _last_method_compiled[0] = '\0';
 512 
 513   // No need to initialize compilation system if we do not use it.
 514   if (!UseCompiler) {
 515     return;
 516   }
 517 #ifndef SHARK
 518   // Set the interface to the current compiler(s).
 519   int c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 520   int c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 521 
 522 #if INCLUDE_JVMCI
 523   if (EnableJVMCI) {
 524     // This is creating a JVMCICompiler singleton.
 525     JVMCICompiler* jvmci = new JVMCICompiler();
 526 
 527     if (UseJVMCICompiler) {
 528       _compilers[1] = jvmci;
 529       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 530         if (BootstrapJVMCI) {
 531           // JVMCI will bootstrap so give it more threads
 532           c2_count = MIN2(32, os::active_processor_count());
 533         }
 534       } else {
 535         c2_count = JVMCIThreads;
 536       }
 537       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 538       } else {
 539         c1_count = JVMCIHostThreads;
 540       }
 541 
<a name="1" id="anc1"></a><span class="changed"> 542       if (!UseInterpreter || !BackgroundCompilation) {</span>
 543         // Force initialization of JVMCI compiler otherwise JVMCI
 544         // compilations will not block until JVMCI is initialized
 545         ResourceMark rm;
 546         TempNewSymbol getCompiler = SymbolTable::new_symbol("getCompiler", CHECK);
 547         TempNewSymbol sig = SymbolTable::new_symbol("()Ljdk/vm/ci/runtime/JVMCICompiler;", CHECK);
 548         Handle jvmciRuntime = JVMCIRuntime::get_HotSpotJVMCIRuntime(CHECK);
 549         JavaValue result(T_OBJECT);
 550         JavaCalls::call_virtual(&amp;result, jvmciRuntime, HotSpotJVMCIRuntime::klass(), getCompiler, sig, CHECK);
 551       }
 552     }
 553   }
 554 #endif // INCLUDE_JVMCI
 555 
 556 #ifdef COMPILER1
 557   if (c1_count &gt; 0) {
 558     _compilers[0] = new Compiler();
 559   }
 560 #endif // COMPILER1
 561 
 562 #ifdef COMPILER2
 563   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 564     if (c2_count &gt; 0) {
 565       _compilers[1] = new C2Compiler();
 566     }
 567   }
 568 #endif // COMPILER2
 569 
 570 #else // SHARK
 571   int c1_count = 0;
 572   int c2_count = 1;
 573 
 574   _compilers[1] = new SharkCompiler();
 575 #endif // SHARK
 576 
 577   // Start the compiler thread(s) and the sweeper thread
 578   init_compiler_sweeper_threads(c1_count, c2_count);
 579   // totalTime performance counter is always created as it is required
 580   // by the implementation of java.lang.management.CompilationMBean.
 581   {
 582     EXCEPTION_MARK;
 583     _perf_total_compilation =
 584                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 585                                                  PerfData::U_Ticks, CHECK);
 586   }
 587 
 588   if (UsePerfData) {
 589 
 590     EXCEPTION_MARK;
 591 
 592     // create the jvmstat performance counters
 593     _perf_osr_compilation =
 594                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 595                                                  PerfData::U_Ticks, CHECK);
 596 
 597     _perf_standard_compilation =
 598                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 599                                                  PerfData::U_Ticks, CHECK);
 600 
 601     _perf_total_bailout_count =
 602                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 603                                                  PerfData::U_Events, CHECK);
 604 
 605     _perf_total_invalidated_count =
 606                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 607                                                  PerfData::U_Events, CHECK);
 608 
 609     _perf_total_compile_count =
 610                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 611                                                  PerfData::U_Events, CHECK);
 612     _perf_total_osr_compile_count =
 613                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 614                                                  PerfData::U_Events, CHECK);
 615 
 616     _perf_total_standard_compile_count =
 617                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 618                                                  PerfData::U_Events, CHECK);
 619 
 620     _perf_sum_osr_bytes_compiled =
 621                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 622                                                  PerfData::U_Bytes, CHECK);
 623 
 624     _perf_sum_standard_bytes_compiled =
 625                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 626                                                  PerfData::U_Bytes, CHECK);
 627 
 628     _perf_sum_nmethod_size =
 629                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 630                                                  PerfData::U_Bytes, CHECK);
 631 
 632     _perf_sum_nmethod_code_size =
 633                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 634                                                  PerfData::U_Bytes, CHECK);
 635 
 636     _perf_last_method =
 637                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 638                                        CompilerCounters::cmname_buffer_length,
 639                                        "", CHECK);
 640 
 641     _perf_last_failed_method =
 642             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 643                                        CompilerCounters::cmname_buffer_length,
 644                                        "", CHECK);
 645 
 646     _perf_last_invalidated_method =
 647         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 648                                      CompilerCounters::cmname_buffer_length,
 649                                      "", CHECK);
 650 
 651     _perf_last_compile_type =
 652              PerfDataManager::create_variable(SUN_CI, "lastType",
 653                                               PerfData::U_None,
 654                                               (jlong)CompileBroker::no_compile,
 655                                               CHECK);
 656 
 657     _perf_last_compile_size =
 658              PerfDataManager::create_variable(SUN_CI, "lastSize",
 659                                               PerfData::U_Bytes,
 660                                               (jlong)CompileBroker::no_compile,
 661                                               CHECK);
 662 
 663 
 664     _perf_last_failed_type =
 665              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 666                                               PerfData::U_None,
 667                                               (jlong)CompileBroker::no_compile,
 668                                               CHECK);
 669 
 670     _perf_last_invalidated_type =
 671          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 672                                           PerfData::U_None,
 673                                           (jlong)CompileBroker::no_compile,
 674                                           CHECK);
 675   }
 676 
 677   _initialized = true;
 678 }
 679 
 680 
 681 JavaThread* CompileBroker::make_thread(const char* name, CompileQueue* queue, CompilerCounters* counters,
 682                                        AbstractCompiler* comp, bool compiler_thread, TRAPS) {
 683   JavaThread* thread = NULL;
 684   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_0);
 685   instanceKlassHandle klass (THREAD, k);
 686   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_0);
 687   Handle string = java_lang_String::create_from_str(name, CHECK_0);
 688 
 689   // Initialize thread_oop to put it into the system threadGroup
 690   Handle thread_group (THREAD,  Universe::system_thread_group());
 691   JavaValue result(T_VOID);
 692   JavaCalls::call_special(&amp;result, thread_oop,
 693                        klass,
 694                        vmSymbols::object_initializer_name(),
 695                        vmSymbols::threadgroup_string_void_signature(),
 696                        thread_group,
 697                        string,
 698                        CHECK_0);
 699 
 700   {
 701     MutexLocker mu(Threads_lock, THREAD);
 702     if (compiler_thread) {
 703       thread = new CompilerThread(queue, counters);
 704     } else {
 705       thread = new CodeCacheSweeperThread();
 706     }
 707     // At this point the new CompilerThread data-races with this startup
 708     // thread (which I believe is the primoridal thread and NOT the VM
 709     // thread).  This means Java bytecodes being executed at startup can
 710     // queue compile jobs which will run at whatever default priority the
 711     // newly created CompilerThread runs at.
 712 
 713 
 714     // At this point it may be possible that no osthread was created for the
 715     // JavaThread due to lack of memory. We would have to throw an exception
 716     // in that case. However, since this must work and we do not allow
 717     // exceptions anyway, check and abort if this fails.
 718 
 719     if (thread == NULL || thread-&gt;osthread() == NULL) {
 720       vm_exit_during_initialization("java.lang.OutOfMemoryError",
 721                                     os::native_thread_creation_failed_msg());
 722     }
 723 
 724     java_lang_Thread::set_thread(thread_oop(), thread);
 725 
 726     // Note that this only sets the JavaThread _priority field, which by
 727     // definition is limited to Java priorities and not OS priorities.
 728     // The os-priority is set in the CompilerThread startup code itself
 729 
 730     java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 731 
 732     // Note that we cannot call os::set_priority because it expects Java
 733     // priorities and we are *explicitly* using OS priorities so that it's
 734     // possible to set the compiler thread priority higher than any Java
 735     // thread.
 736 
 737     int native_prio = CompilerThreadPriority;
 738     if (native_prio == -1) {
 739       if (UseCriticalCompilerThreadPriority) {
 740         native_prio = os::java_to_os_priority[CriticalPriority];
 741       } else {
 742         native_prio = os::java_to_os_priority[NearMaxPriority];
 743       }
 744     }
 745     os::set_native_priority(thread, native_prio);
 746 
 747     java_lang_Thread::set_daemon(thread_oop());
 748 
 749     thread-&gt;set_threadObj(thread_oop());
 750     if (compiler_thread) {
 751       thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 752     }
 753     Threads::add(thread);
 754     Thread::start(thread);
 755   }
 756 
 757   // Let go of Threads_lock before yielding
 758   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 759 
 760   return thread;
 761 }
 762 
 763 
 764 void CompileBroker::init_compiler_sweeper_threads(int c1_compiler_count, int c2_compiler_count) {
 765   EXCEPTION_MARK;
 766 #if !defined(ZERO) &amp;&amp; !defined(SHARK)
 767   assert(c2_compiler_count &gt; 0 || c1_compiler_count &gt; 0, "No compilers?");
 768 #endif // !ZERO &amp;&amp; !SHARK
 769   // Initialize the compilation queue
 770   if (c2_compiler_count &gt; 0) {
 771     _c2_compile_queue  = new CompileQueue("C2 compile queue");
 772     _compilers[1]-&gt;set_num_compiler_threads(c2_compiler_count);
 773   }
 774   if (c1_compiler_count &gt; 0) {
 775     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 776     _compilers[0]-&gt;set_num_compiler_threads(c1_compiler_count);
 777   }
 778 
 779   int compiler_count = c1_compiler_count + c2_compiler_count;
 780 
 781   char name_buffer[256];
 782   const bool compiler_thread = true;
 783   for (int i = 0; i &lt; c2_compiler_count; i++) {
 784     // Create a name for our thread.
 785     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 786     CompilerCounters* counters = new CompilerCounters();
 787     // Shark and C2
 788     make_thread(name_buffer, _c2_compile_queue, counters, _compilers[1], compiler_thread, CHECK);
 789   }
 790 
 791   for (int i = c2_compiler_count; i &lt; compiler_count; i++) {
 792     // Create a name for our thread.
 793     sprintf(name_buffer, "C1 CompilerThread%d", i);
 794     CompilerCounters* counters = new CompilerCounters();
 795     // C1
 796     make_thread(name_buffer, _c1_compile_queue, counters, _compilers[0], compiler_thread, CHECK);
 797   }
 798 
 799   if (UsePerfData) {
 800     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, compiler_count, CHECK);
 801   }
 802 
 803   if (MethodFlushing) {
 804     // Initialize the sweeper thread
 805     make_thread("Sweeper thread", NULL, NULL, NULL, false, CHECK);
 806   }
 807 }
 808 
 809 
 810 /**
 811  * Set the methods on the stack as on_stack so that redefine classes doesn't
 812  * reclaim them. This method is executed at a safepoint.
 813  */
 814 void CompileBroker::mark_on_stack() {
 815   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 816   // Since we are at a safepoint, we do not need a lock to access
 817   // the compile queues.
 818   if (_c2_compile_queue != NULL) {
 819     _c2_compile_queue-&gt;mark_on_stack();
 820   }
 821   if (_c1_compile_queue != NULL) {
 822     _c1_compile_queue-&gt;mark_on_stack();
 823   }
 824 }
 825 
 826 // ------------------------------------------------------------------
 827 // CompileBroker::compile_method
 828 //
 829 // Request compilation of a method.
 830 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 831                                         int osr_bci,
 832                                         int comp_level,
 833                                         const methodHandle&amp; hot_method,
 834                                         int hot_count,
 835                                         const char* comment,
 836                                         Thread* thread) {
 837   // do nothing if compiler thread(s) is not available
 838   if (!_initialized) {
 839     return;
 840   }
 841 
 842   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 843   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 844          "sanity check");
 845   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 846          "method holder must be initialized");
 847   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 848 
 849   if (CIPrintRequests) {
 850     tty-&gt;print("request: ");
 851     method-&gt;print_short_name(tty);
 852     if (osr_bci != InvocationEntryBci) {
 853       tty-&gt;print(" osr_bci: %d", osr_bci);
 854     }
 855     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, comment, hot_count);
 856     if (!hot_method.is_null()) {
 857       tty-&gt;print(" hot: ");
 858       if (hot_method() != method()) {
 859           hot_method-&gt;print_short_name(tty);
 860       } else {
 861         tty-&gt;print("yes");
 862       }
 863     }
 864     tty-&gt;cr();
 865   }
 866 
 867   // A request has been made for compilation.  Before we do any
 868   // real work, check to see if the method has been compiled
 869   // in the meantime with a definitive result.
 870   if (compilation_is_complete(method, osr_bci, comp_level)) {
 871     return;
 872   }
 873 
 874 #ifndef PRODUCT
 875   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
 876     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
 877       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
 878       return;
 879     }
 880   }
 881 #endif
 882 
 883   // If this method is already in the compile queue, then
 884   // we do not block the current thread.
 885   if (compilation_is_in_queue(method)) {
 886     // We may want to decay our counter a bit here to prevent
 887     // multiple denied requests for compilation.  This is an
 888     // open compilation policy issue. Note: The other possibility,
 889     // in the case that this is a blocking compile request, is to have
 890     // all subsequent blocking requesters wait for completion of
 891     // ongoing compiles. Note that in this case we'll need a protocol
 892     // for freeing the associated compile tasks. [Or we could have
 893     // a single static monitor on which all these waiters sleep.]
 894     return;
 895   }
 896 
 897   // If the requesting thread is holding the pending list lock
 898   // then we just return. We can't risk blocking while holding
 899   // the pending list lock or a 3-way deadlock may occur
 900   // between the reference handler thread, a GC (instigated
 901   // by a compiler thread), and compiled method registration.
 902   if (InstanceRefKlass::owns_pending_list_lock(JavaThread::current())) {
 903     return;
 904   }
 905 
 906   if (TieredCompilation) {
 907     // Tiered policy requires MethodCounters to exist before adding a method to
 908     // the queue. Create if we don't have them yet.
 909     method-&gt;get_method_counters(thread);
 910   }
 911 
 912   // Outputs from the following MutexLocker block:
 913   CompileTask* task     = NULL;
 914   bool         blocking = false;
 915   CompileQueue* queue  = compile_queue(comp_level);
 916 
 917   // Acquire our lock.
 918   {
 919     MutexLocker locker(MethodCompileQueue_lock, thread);
 920 
 921     // Make sure the method has not slipped into the queues since
 922     // last we checked; note that those checks were "fast bail-outs".
 923     // Here we need to be more careful, see 14012000 below.
 924     if (compilation_is_in_queue(method)) {
 925       return;
 926     }
 927 
 928     // We need to check again to see if the compilation has
 929     // completed.  A previous compilation may have registered
 930     // some result.
 931     if (compilation_is_complete(method, osr_bci, comp_level)) {
 932       return;
 933     }
 934 
 935     // We now know that this compilation is not pending, complete,
 936     // or prohibited.  Assign a compile_id to this compilation
 937     // and check to see if it is in our [Start..Stop) range.
 938     int compile_id = assign_compile_id(method, osr_bci);
 939     if (compile_id == 0) {
 940       // The compilation falls outside the allowed range.
 941       return;
 942     }
 943 
 944     // Should this thread wait for completion of the compile?
 945     blocking = is_compile_blocking();
 946 
 947 #if INCLUDE_JVMCI
 948     if (UseJVMCICompiler) {
 949       if (blocking) {
 950         // Don't allow blocking compiles for requests triggered by JVMCI.
 951         if (thread-&gt;is_Compiler_thread()) {
 952           blocking = false;
 953         }
 954 
 955         // Don't allow blocking compiles if inside a class initializer or while performing class loading
 956         vframeStream vfst((JavaThread*) thread);
 957         for (; !vfst.at_end(); vfst.next()) {
 958           if (vfst.method()-&gt;is_static_initializer() ||
 959               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
 960                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
 961             blocking = false;
 962             break;
 963           }
 964         }
 965 
 966         // Don't allow blocking compilation requests to JVMCI
 967         // if JVMCI itself is not yet initialized
 968         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
 969           blocking = false;
 970         }
 971 
 972         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
 973         // to avoid deadlock between compiler thread(s) and threads run at shutdown
 974         // such as the DestroyJavaVM thread.
 975         if (JVMCIRuntime::shutdown_called()) {
 976           blocking = false;
 977         }
 978       }
 979     }
 980 #endif // INCLUDE_JVMCI
 981 
 982     // We will enter the compilation in the queue.
 983     // 14012000: Note that this sets the queued_for_compile bits in
 984     // the target method. We can now reason that a method cannot be
 985     // queued for compilation more than once, as follows:
 986     // Before a thread queues a task for compilation, it first acquires
 987     // the compile queue lock, then checks if the method's queued bits
 988     // are set or it has already been compiled. Thus there can not be two
 989     // instances of a compilation task for the same method on the
 990     // compilation queue. Consider now the case where the compilation
 991     // thread has already removed a task for that method from the queue
 992     // and is in the midst of compiling it. In this case, the
 993     // queued_for_compile bits must be set in the method (and these
 994     // will be visible to the current thread, since the bits were set
 995     // under protection of the compile queue lock, which we hold now.
 996     // When the compilation completes, the compiler thread first sets
 997     // the compilation result and then clears the queued_for_compile
 998     // bits. Neither of these actions are protected by a barrier (or done
 999     // under the protection of a lock), so the only guarantee we have
1000     // (on machines with TSO (Total Store Order)) is that these values
1001     // will update in that order. As a result, the only combinations of
1002     // these bits that the current thread will see are, in temporal order:
1003     // &lt;RESULT, QUEUE&gt; :
1004     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1005     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1006     //     &lt;1, 0&gt; : compiled and queue bit cleared
1007     // Because we first check the queue bits then check the result bits,
1008     // we are assured that we cannot introduce a duplicate task.
1009     // Note that if we did the tests in the reverse order (i.e. check
1010     // result then check queued bit), we could get the result bit before
1011     // the compilation completed, and the queue bit after the compilation
1012     // completed, and end up introducing a "duplicate" (redundant) task.
1013     // In that case, the compiler thread should first check if a method
1014     // has already been compiled before trying to compile it.
1015     // NOTE: in the event that there are multiple compiler threads and
1016     // there is de-optimization/recompilation, things will get hairy,
1017     // and in that case it's best to protect both the testing (here) of
1018     // these bits, and their updating (here and elsewhere) under a
1019     // common lock.
1020     task = create_compile_task(queue,
1021                                compile_id, method,
1022                                osr_bci, comp_level,
1023                                hot_method, hot_count, comment,
1024                                blocking);
1025   }
1026 
1027   if (blocking) {
1028     wait_for_completion(task);
1029   }
1030 }
1031 
1032 
1033 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1034                                        int comp_level,
1035                                        const methodHandle&amp; hot_method, int hot_count,
1036                                        const char* comment, Thread* THREAD) {
1037   // make sure arguments make sense
1038   assert(method-&gt;method_holder()-&gt;is_instance_klass(), "not an instance method");
1039   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1040   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1041   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1042   // allow any levels for WhiteBox
1043   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1044   // return quickly if possible
1045 
1046   // lock, make sure that the compilation
1047   // isn't prohibited in a straightforward way.
1048   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1049   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1050       compilation_is_prohibited(method, osr_bci, comp_level)) {
1051     return NULL;
1052   }
1053 
1054   if (osr_bci == InvocationEntryBci) {
1055     // standard compilation
1056     nmethod* method_code = method-&gt;code();
1057     if (method_code != NULL) {
1058       if (compilation_is_complete(method, osr_bci, comp_level)) {
1059         return method_code;
1060       }
1061     }
1062     if (method-&gt;is_not_compilable(comp_level)) {
1063       return NULL;
1064     }
1065   } else {
1066     // osr compilation
1067 #ifndef TIERED
1068     // seems like an assert of dubious value
1069     assert(comp_level == CompLevel_highest_tier,
1070            "all OSR compiles are assumed to be at a single compilation level");
1071 #endif // TIERED
1072     // We accept a higher level osr method
1073     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1074     if (nm != NULL) return nm;
1075     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1076   }
1077 
1078   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1079   // some prerequisites that are compiler specific
1080   if (comp-&gt;is_c2() || comp-&gt;is_shark()) {
1081     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1082     // Resolve all classes seen in the signature of the method
1083     // we are compiling.
1084     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1085   }
1086 
1087   // If the method is native, do the lookup in the thread requesting
1088   // the compilation. Native lookups can load code, which is not
1089   // permitted during compilation.
1090   //
1091   // Note: A native method implies non-osr compilation which is
1092   //       checked with an assertion at the entry of this method.
1093   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1094     bool in_base_library;
1095     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1096     if (HAS_PENDING_EXCEPTION) {
1097       // In case of an exception looking up the method, we just forget
1098       // about it. The interpreter will kick-in and throw the exception.
1099       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1100       CLEAR_PENDING_EXCEPTION;
1101       return NULL;
1102     }
1103     assert(method-&gt;has_native_function(), "must have native code by now");
1104   }
1105 
1106   // RedefineClasses() has replaced this method; just return
1107   if (method-&gt;is_old()) {
1108     return NULL;
1109   }
1110 
1111   // JVMTI -- post_compile_event requires jmethod_id() that may require
1112   // a lock the compiling thread can not acquire. Prefetch it here.
1113   if (JvmtiExport::should_post_compiled_method_load()) {
1114     method-&gt;jmethod_id();
1115   }
1116 
1117   // do the compilation
1118   if (method-&gt;is_native()) {
1119     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1120       // The following native methods:
1121       //
1122       // java.lang.Float.intBitsToFloat
1123       // java.lang.Float.floatToRawIntBits
1124       // java.lang.Double.longBitsToDouble
1125       // java.lang.Double.doubleToRawLongBits
1126       //
1127       // are called through the interpreter even if interpreter native stubs
1128       // are not preferred (i.e., calling through adapter handlers is preferred).
1129       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1130       // if the version of the methods from the native libraries is called.
1131       // As the interpreter and the C2-intrinsified version of the methods preserves
1132       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1133       if ((UseSSE &gt;= 1 &amp;&amp;
1134           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1135            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1136           (UseSSE &gt;= 2 &amp;&amp;
1137            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1138             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1139         return NULL;
1140       }
1141 
1142       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1143       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1144       //
1145       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1146       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1147       AdapterHandlerLibrary::create_native_wrapper(method);
1148     } else {
1149       return NULL;
1150     }
1151   } else {
1152     // If the compiler is shut off due to code cache getting full
1153     // fail out now so blocking compiles dont hang the java thread
1154     if (!should_compile_new_jobs()) {
1155       CompilationPolicy::policy()-&gt;delay_compilation(method());
1156       return NULL;
1157     }
1158     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, comment, THREAD);
1159   }
1160 
1161   // return requested nmethod
1162   // We accept a higher level osr method
1163   if (osr_bci == InvocationEntryBci) {
1164     return method-&gt;code();
1165   }
1166   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1167 }
1168 
1169 
1170 // ------------------------------------------------------------------
1171 // CompileBroker::compilation_is_complete
1172 //
1173 // See if compilation of this method is already complete.
1174 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1175                                             int                 osr_bci,
1176                                             int                 comp_level) {
1177   bool is_osr = (osr_bci != standard_entry_bci);
1178   if (is_osr) {
1179     if (method-&gt;is_not_osr_compilable(comp_level)) {
1180       return true;
1181     } else {
1182       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1183       return (result != NULL);
1184     }
1185   } else {
1186     if (method-&gt;is_not_compilable(comp_level)) {
1187       return true;
1188     } else {
1189       nmethod* result = method-&gt;code();
1190       if (result == NULL) return false;
1191       return comp_level == result-&gt;comp_level();
1192     }
1193   }
1194 }
1195 
1196 
1197 /**
1198  * See if this compilation is already requested.
1199  *
1200  * Implementation note: there is only a single "is in queue" bit
1201  * for each method.  This means that the check below is overly
1202  * conservative in the sense that an osr compilation in the queue
1203  * will block a normal compilation from entering the queue (and vice
1204  * versa).  This can be remedied by a full queue search to disambiguate
1205  * cases.  If it is deemed profitable, this may be done.
1206  */
1207 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1208   return method-&gt;queued_for_compilation();
1209 }
1210 
1211 // ------------------------------------------------------------------
1212 // CompileBroker::compilation_is_prohibited
1213 //
1214 // See if this compilation is not allowed.
1215 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level) {
1216   bool is_native = method-&gt;is_native();
1217   // Some compilers may not support the compilation of natives.
1218   AbstractCompiler *comp = compiler(comp_level);
1219   if (is_native &amp;&amp;
1220       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1221     method-&gt;set_not_compilable_quietly(comp_level);
1222     return true;
1223   }
1224 
1225   bool is_osr = (osr_bci != standard_entry_bci);
1226   // Some compilers may not support on stack replacement.
1227   if (is_osr &amp;&amp;
1228       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1229     method-&gt;set_not_osr_compilable(comp_level);
1230     return true;
1231   }
1232 
1233   // Breaking the abstraction - directives are only used inside a compilation otherwise.
1234   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1235   bool excluded = directive-&gt;ExcludeOption;
1236   DirectivesStack::release(directive);
1237 
1238   // The method may be explicitly excluded by the user.
1239   double scale;
1240   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1241     bool quietly = CompilerOracle::should_exclude_quietly();
1242     if (PrintCompilation &amp;&amp; !quietly) {
1243       // This does not happen quietly...
1244       ResourceMark rm;
1245       tty-&gt;print("### Excluding %s:%s",
1246                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1247                  (method-&gt;is_static() ? " static" : ""));
1248       method-&gt;print_short_name(tty);
1249       tty-&gt;cr();
1250     }
1251     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1252   }
1253 
1254   return false;
1255 }
1256 
1257 /**
1258  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1259  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1260  * The function also allows to generate separate compilation IDs for OSR compilations.
1261  */
1262 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1263 #ifdef ASSERT
1264   bool is_osr = (osr_bci != standard_entry_bci);
1265   int id;
1266   if (method-&gt;is_native()) {
1267     assert(!is_osr, "can't be osr");
1268     // Adapters, native wrappers and method handle intrinsics
1269     // should be generated always.
1270     return Atomic::add(1, &amp;_compilation_id);
1271   } else if (CICountOSR &amp;&amp; is_osr) {
1272     id = Atomic::add(1, &amp;_osr_compilation_id);
1273     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1274       return id;
1275     }
1276   } else {
1277     id = Atomic::add(1, &amp;_compilation_id);
1278     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1279       return id;
1280     }
1281   }
1282 
1283   // Method was not in the appropriate compilation range.
1284   method-&gt;set_not_compilable_quietly();
1285   return 0;
1286 #else
1287   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1288   // only _compilation_id is incremented.
1289   return Atomic::add(1, &amp;_compilation_id);
1290 #endif
1291 }
1292 
1293 // ------------------------------------------------------------------
1294 // CompileBroker::assign_compile_id_unlocked
1295 //
1296 // Public wrapper for assign_compile_id that acquires the needed locks
1297 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1298   MutexLocker locker(MethodCompileQueue_lock, thread);
1299   return assign_compile_id(method, osr_bci);
1300 }
1301 
1302 /**
1303  * Should the current thread block until this compilation request
1304  * has been fulfilled?
1305  */
1306 bool CompileBroker::is_compile_blocking() {
1307   assert(!InstanceRefKlass::owns_pending_list_lock(JavaThread::current()), "possible deadlock");
1308   return !BackgroundCompilation;
1309 }
1310 
1311 
1312 // ------------------------------------------------------------------
1313 // CompileBroker::preload_classes
1314 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {
1315   // Move this code over from c1_Compiler.cpp
1316   ShouldNotReachHere();
1317 }
1318 
1319 
1320 // ------------------------------------------------------------------
1321 // CompileBroker::create_compile_task
1322 //
1323 // Create a CompileTask object representing the current request for
1324 // compilation.  Add this task to the queue.
1325 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1326                                                 int                 compile_id,
1327                                                 const methodHandle&amp; method,
1328                                                 int                 osr_bci,
1329                                                 int                 comp_level,
1330                                                 const methodHandle&amp; hot_method,
1331                                                 int                 hot_count,
1332                                                 const char*         comment,
1333                                                 bool                blocking) {
1334   CompileTask* new_task = CompileTask::allocate();
1335   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1336                        hot_method, hot_count, comment,
1337                        blocking);
1338   queue-&gt;add(new_task);
1339   return new_task;
1340 }
1341 
1342 #if INCLUDE_JVMCI
<a name="2" id="anc2"></a><span class="changed">1343 // The number of milliseconds to wait before checking if</span>
<span class="changed">1344 // JVMCI compilation has made progress.</span>
<span class="changed">1345 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 500;</span>
<span class="changed">1346 </span>
<span class="changed">1347 // The number of JVMCI compilation progress checks that must fail</span>
<span class="changed">1348 // before unblocking a thread waiting for a blocking compilation.</span>
<span class="changed">1349 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 5;</span>

1350 
1351 /**
1352  * Waits for a JVMCI compiler to complete a given task. This thread
<a name="3" id="anc3"></a><span class="changed">1353  * waits until either the task completes or it sees no JVMCI compilation</span>
<span class="changed">1354  * progress for N consecutive milliseconds where N is</span>
<span class="changed">1355  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *</span>
<span class="changed">1356  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.</span>
1357  *
1358  * @return true if this thread needs to free/recycle the task
1359  */
<a name="4" id="anc4"></a><span class="changed">1360 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {</span>
1361   MutexLocker waiter(task-&gt;lock(), thread);
<a name="5" id="anc5"></a><span class="changed">1362   int progress_wait_attempts = 0;</span>
<span class="changed">1363   int methods_compiled = jvmci-&gt;methods_compiled();</span>
<span class="changed">1364   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;</span>
<span class="changed">1365          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {</span>
1366     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
<a name="6" id="anc6"></a><span class="new">1367 </span>
<span class="new">1368     bool progress;</span>
1369     if (jvmci_compiler_thread != NULL) {
<a name="7" id="anc7"></a><span class="changed">1370       // If the JVMCI compiler thread is not blocked, we deem it to be making progress.</span>
<span class="changed">1371       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked;</span>
<span class="changed">1372     } else {</span>
<span class="changed">1373       // Still waiting on JVMCI compiler queue. This thread may be holding a lock</span>
<span class="changed">1374       // that all JVMCI compiler threads are blocked on. We use the counter for</span>
<span class="changed">1375       // successful JVMCI compilations to determine whether JVMCI compilation</span>
<span class="changed">1376       // is still making progress through the JVMCI compiler queue.</span>
<span class="changed">1377       progress = jvmci-&gt;methods_compiled() != methods_compiled;</span>
1378     }
<a name="8" id="anc8"></a><span class="changed">1379 </span>
<span class="changed">1380     if (!progress) {</span>
<span class="changed">1381       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {</span>
1382         if (PrintCompilation) {
1383           task-&gt;print(tty, "wait for blocking compilation timed out");
1384         }
1385         break;
1386       }
1387     } else {
<a name="9" id="anc9"></a><span class="changed">1388       progress_wait_attempts = 0;</span>
<span class="changed">1389       if (jvmci_compiler_thread == NULL) {</span>
<span class="changed">1390         methods_compiled = jvmci-&gt;methods_compiled();</span>
1391       }
<a name="10" id="anc10"></a>

1392     }
1393   }
1394   task-&gt;clear_waiter();
1395   return task-&gt;is_complete();
1396 }
1397 #endif
1398 
1399 /**
1400  *  Wait for the compilation task to complete.
1401  */
1402 void CompileBroker::wait_for_completion(CompileTask* task) {
1403   if (CIPrintCompileQueue) {
1404     ttyLocker ttyl;
1405     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1406   }
1407 
1408   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1409 
1410   JavaThread* thread = JavaThread::current();
1411   thread-&gt;set_blocked_on_compilation(true);
1412 
1413   methodHandle method(thread, task-&gt;method());
1414   bool free_task;
1415 #if INCLUDE_JVMCI
<a name="11" id="anc11"></a><span class="changed">1416   AbstractCompiler* comp = compiler(task-&gt;comp_level());</span>
<span class="changed">1417   if (comp-&gt;is_jvmci()) {</span>
<span class="changed">1418     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);</span>
1419   } else
1420 #endif
1421   {
1422     MutexLocker waiter(task-&gt;lock(), thread);
1423     free_task = true;
1424     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1425       task-&gt;lock()-&gt;wait();
1426     }
1427   }
1428 
1429   thread-&gt;set_blocked_on_compilation(false);
1430   if (free_task) {
1431     if (is_compilation_disabled_forever()) {
1432       CompileTask::free(task);
1433       return;
1434     }
1435 
1436     // It is harmless to check this status without the lock, because
1437     // completion is a stable property (until the task object is recycled).
1438     assert(task-&gt;is_complete(), "Compilation should have completed");
1439     assert(task-&gt;code_handle() == NULL, "must be reset");
1440 
1441     // By convention, the waiter is responsible for recycling a
1442     // blocking CompileTask. Since there is only one waiter ever
1443     // waiting on a CompileTask, we know that no one else will
1444     // be using this CompileTask; we can free it.
1445     CompileTask::free(task);
1446   }
1447 }
1448 
1449 /**
1450  * Initialize compiler thread(s) + compiler object(s). The postcondition
1451  * of this function is that the compiler runtimes are initialized and that
1452  * compiler threads can start compiling.
1453  */
1454 bool CompileBroker::init_compiler_runtime() {
1455   CompilerThread* thread = CompilerThread::current();
1456   AbstractCompiler* comp = thread-&gt;compiler();
1457   // Final sanity check - the compiler object must exist
1458   guarantee(comp != NULL, "Compiler object must exist");
1459 
1460   int system_dictionary_modification_counter;
1461   {
1462     MutexLocker locker(Compile_lock, thread);
1463     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1464   }
1465 
1466   {
1467     // Must switch to native to allocate ci_env
1468     ThreadToNativeFromVM ttn(thread);
1469     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1470     // Cache Jvmti state
1471     ci_env.cache_jvmti_state();
1472     // Cache DTrace flags
1473     ci_env.cache_dtrace_flags();
1474 
1475     // Switch back to VM state to do compiler initialization
1476     ThreadInVMfromNative tv(thread);
1477     ResetNoHandleMark rnhm;
1478 
1479     if (!comp-&gt;is_shark()) {
1480       // Perform per-thread and global initializations
1481       comp-&gt;initialize();
1482     }
1483   }
1484 
1485   if (comp-&gt;is_failed()) {
1486     disable_compilation_forever();
1487     // If compiler initialization failed, no compiler thread that is specific to a
1488     // particular compiler runtime will ever start to compile methods.
1489     shutdown_compiler_runtime(comp, thread);
1490     return false;
1491   }
1492 
1493   // C1 specific check
1494   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1495     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1496     return false;
1497   }
1498 
1499   return true;
1500 }
1501 
1502 /**
1503  * If C1 and/or C2 initialization failed, we shut down all compilation.
1504  * We do this to keep things simple. This can be changed if it ever turns
1505  * out to be a problem.
1506  */
1507 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1508   // Free buffer blob, if allocated
1509   if (thread-&gt;get_buffer_blob() != NULL) {
1510     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1511     CodeCache::free(thread-&gt;get_buffer_blob());
1512   }
1513 
1514   if (comp-&gt;should_perform_shutdown()) {
1515     // There are two reasons for shutting down the compiler
1516     // 1) compiler runtime initialization failed
1517     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1518     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1519 
1520     // Only one thread per compiler runtime object enters here
1521     // Set state to shut down
1522     comp-&gt;set_shut_down();
1523 
1524     // Delete all queued compilation tasks to make compiler threads exit faster.
1525     if (_c1_compile_queue != NULL) {
1526       _c1_compile_queue-&gt;free_all();
1527     }
1528 
1529     if (_c2_compile_queue != NULL) {
1530       _c2_compile_queue-&gt;free_all();
1531     }
1532 
1533     // Set flags so that we continue execution with using interpreter only.
1534     UseCompiler    = false;
1535     UseInterpreter = true;
1536 
1537     // We could delete compiler runtimes also. However, there are references to
1538     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1539     // fail. This can be done later if necessary.
1540   }
1541 }
1542 
1543 // ------------------------------------------------------------------
1544 // CompileBroker::compiler_thread_loop
1545 //
1546 // The main loop run by a CompilerThread.
1547 void CompileBroker::compiler_thread_loop() {
1548   CompilerThread* thread = CompilerThread::current();
1549   CompileQueue* queue = thread-&gt;queue();
1550   // For the thread that initializes the ciObjectFactory
1551   // this resource mark holds all the shared objects
1552   ResourceMark rm;
1553 
1554   // First thread to get here will initialize the compiler interface
1555 
1556   if (!ciObjectFactory::is_initialized()) {
1557     ASSERT_IN_VM;
1558     MutexLocker only_one (CompileThread_lock, thread);
1559     if (!ciObjectFactory::is_initialized()) {
1560       ciObjectFactory::initialize();
1561     }
1562   }
1563 
1564   // Open a log.
1565   if (LogCompilation) {
1566     init_compiler_thread_log();
1567   }
1568   CompileLog* log = thread-&gt;log();
1569   if (log != NULL) {
1570     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1571                     thread-&gt;name(),
1572                     os::current_thread_id(),
1573                     os::current_process_id());
1574     log-&gt;stamp();
1575     log-&gt;end_elem();
1576   }
1577 
1578   // If compiler thread/runtime initialization fails, exit the compiler thread
1579   if (!init_compiler_runtime()) {
1580     return;
1581   }
1582 
1583   // Poll for new compilation tasks as long as the JVM runs. Compilation
1584   // should only be disabled if something went wrong while initializing the
1585   // compiler runtimes. This, in turn, should not happen. The only known case
1586   // when compiler runtime initialization fails is if there is not enough free
1587   // space in the code cache to generate the necessary stubs, etc.
1588   while (!is_compilation_disabled_forever()) {
1589     // We need this HandleMark to avoid leaking VM handles.
1590     HandleMark hm(thread);
1591 
1592     CompileTask* task = queue-&gt;get();
1593     if (task == NULL) {
1594       continue;
1595     }
1596 
1597     // Give compiler threads an extra quanta.  They tend to be bursty and
1598     // this helps the compiler to finish up the job.
1599     if (CompilerThreadHintNoPreempt) {
1600       os::hint_no_preempt();
1601     }
1602 
1603     // Assign the task to the current thread.  Mark this compilation
1604     // thread as active for the profiler.
1605     CompileTaskWrapper ctw(task);
1606     nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1607     task-&gt;set_code_handle(&amp;result_handle);
1608     methodHandle method(thread, task-&gt;method());
1609 
1610     // Never compile a method if breakpoints are present in it
1611     if (method()-&gt;number_of_breakpoints() == 0) {
1612       // Compile the method.
1613       if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1614         invoke_compiler_on_method(task);
1615       } else {
1616         // After compilation is disabled, remove remaining methods from queue
1617         method-&gt;clear_queued_for_compilation();
1618         task-&gt;set_failure_reason("compilation is disabled");
1619       }
1620     }
1621   }
1622 
1623   // Shut down compiler runtime
1624   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1625 }
1626 
1627 // ------------------------------------------------------------------
1628 // CompileBroker::init_compiler_thread_log
1629 //
1630 // Set up state required by +LogCompilation.
1631 void CompileBroker::init_compiler_thread_log() {
1632     CompilerThread* thread = CompilerThread::current();
1633     char  file_name[4*K];
1634     FILE* fp = NULL;
1635     intx thread_id = os::current_thread_id();
1636     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1637       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1638       if (dir == NULL) {
1639         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1640                      thread_id, os::current_process_id());
1641       } else {
1642         jio_snprintf(file_name, sizeof(file_name),
1643                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1644                      os::file_separator(), thread_id, os::current_process_id());
1645       }
1646 
1647       fp = fopen(file_name, "wt");
1648       if (fp != NULL) {
1649         if (LogCompilation &amp;&amp; Verbose) {
1650           tty-&gt;print_cr("Opening compilation log %s", file_name);
1651         }
1652         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1653         thread-&gt;init_log(log);
1654 
1655         if (xtty != NULL) {
1656           ttyLocker ttyl;
1657           // Record any per thread log files
1658           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1659         }
1660         return;
1661       }
1662     }
1663     warning("Cannot open log file: %s", file_name);
1664 }
1665 
1666 void CompileBroker::log_metaspace_failure() {
1667   const char* message = "some methods may not be compiled because metaspace "
1668                         "is out of memory";
1669   if (_compilation_log != NULL) {
1670     _compilation_log-&gt;log_metaspace_failure(message);
1671   }
1672   if (PrintCompilation) {
1673     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1674   }
1675 }
1676 
1677 
1678 // ------------------------------------------------------------------
1679 // CompileBroker::set_should_block
1680 //
1681 // Set _should_block.
1682 // Call this from the VM, with Threads_lock held and a safepoint requested.
1683 void CompileBroker::set_should_block() {
1684   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1685   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1686 #ifndef PRODUCT
1687   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1688     tty-&gt;print_cr("notifying compiler thread pool to block");
1689 #endif
1690   _should_block = true;
1691 }
1692 
1693 // ------------------------------------------------------------------
1694 // CompileBroker::maybe_block
1695 //
1696 // Call this from the compiler at convenient points, to poll for _should_block.
1697 void CompileBroker::maybe_block() {
1698   if (_should_block) {
1699 #ifndef PRODUCT
1700     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1701       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1702 #endif
1703     ThreadInVMfromNative tivfn(JavaThread::current());
1704   }
1705 }
1706 
1707 // wrapper for CodeCache::print_summary()
1708 static void codecache_print(bool detailed)
1709 {
1710   ResourceMark rm;
1711   stringStream s;
1712   // Dump code cache  into a buffer before locking the tty,
1713   {
1714     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1715     CodeCache::print_summary(&amp;s, detailed);
1716   }
1717   ttyLocker ttyl;
1718   tty-&gt;print("%s", s.as_string());
1719 }
1720 
1721 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, EventCompilation&amp; event, bool success, ciEnv* ci_env) {
1722 
1723   if (success) {
1724     task-&gt;mark_success();
1725     if (ci_env != NULL) {
1726       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1727     }
1728     if (_compilation_log != NULL) {
1729       nmethod* code = task-&gt;code();
1730       if (code != NULL) {
1731         _compilation_log-&gt;log_nmethod(thread, code);
1732       }
1733     }
1734   }
1735 
1736   // simulate crash during compilation
1737   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1738   if (event.should_commit()) {
1739     event.set_method(task-&gt;method());
1740     event.set_compileID(task-&gt;compile_id());
1741     event.set_compileLevel(task-&gt;comp_level());
1742     event.set_succeded(task-&gt;is_success());
1743     event.set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1744     event.set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1745     event.set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1746     event.commit();
1747   }
1748 }
1749 
1750 int DirectivesStack::_depth = 0;
1751 CompilerDirectives* DirectivesStack::_top = NULL;
1752 CompilerDirectives* DirectivesStack::_bottom = NULL;
1753 
1754 // ------------------------------------------------------------------
1755 // CompileBroker::invoke_compiler_on_method
1756 //
1757 // Compile a method.
1758 //
1759 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1760   if (PrintCompilation) {
1761     ResourceMark rm;
1762     task-&gt;print_tty();
1763   }
1764   elapsedTimer time;
1765 
1766   CompilerThread* thread = CompilerThread::current();
1767   ResourceMark rm(thread);
1768 
1769   if (LogEvents) {
1770     _compilation_log-&gt;log_compile(thread, task);
1771   }
1772 
1773   // Common flags.
1774   uint compile_id = task-&gt;compile_id();
1775   int osr_bci = task-&gt;osr_bci();
1776   bool is_osr = (osr_bci != standard_entry_bci);
1777   bool should_log = (thread-&gt;log() != NULL);
1778   bool should_break = false;
1779   int task_level = task-&gt;comp_level();
1780 
1781   DirectiveSet* directive;
1782   {
1783     // create the handle inside it's own block so it can't
1784     // accidentally be referenced once the thread transitions to
1785     // native.  The NoHandleMark before the transition should catch
1786     // any cases where this occurs in the future.
1787     methodHandle method(thread, task-&gt;method());
1788     assert(!method-&gt;is_native(), "no longer compile natives");
1789 
1790     // Look up matching directives
1791     directive = DirectivesStack::getMatchingDirective(method, compiler(task_level));
1792 
1793     // Save information about this method in case of failure.
1794     set_last_compile(thread, method, is_osr, task_level);
1795 
1796     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
1797   }
1798 
1799   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
1800   if (should_log &amp;&amp; !directive-&gt;LogOption) {
1801     should_log = false;
1802   }
1803 
1804   // Allocate a new set of JNI handles.
1805   push_jni_handle_block();
1806   Method* target_handle = task-&gt;method();
1807   int compilable = ciEnv::MethodCompilable;
1808   const char* failure_reason = NULL;
1809   const char* retry_message = NULL;
1810   AbstractCompiler *comp = compiler(task_level);
1811 
1812   int system_dictionary_modification_counter;
1813   {
1814     MutexLocker locker(Compile_lock, thread);
1815     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1816   }
1817 #if INCLUDE_JVMCI
1818   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
1819     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
1820 
1821     TraceTime t1("compilation", &amp;time);
1822     EventCompilation event;
1823 
1824     JVMCIEnv env(task, system_dictionary_modification_counter);
1825     methodHandle method(thread, target_handle);
1826     jvmci-&gt;compile_method(method, osr_bci, &amp;env);
1827 
1828     post_compile(thread, task, event, task-&gt;code() != NULL, NULL);
1829 
1830     failure_reason = env.failure_reason();
1831     if (!env.retryable()) {
1832       retry_message = "not retryable";
1833       compilable = ciEnv::MethodCompilable_not_at_tier;
1834     }
1835 
1836   } else
1837 #endif // INCLUDE_JVMCI
1838   {
1839     NoHandleMark  nhm;
1840     ThreadToNativeFromVM ttn(thread);
1841 
1842     ciEnv ci_env(task, system_dictionary_modification_counter);
1843     if (should_break) {
1844       ci_env.set_break_at_compile(true);
1845     }
1846     if (should_log) {
1847       ci_env.set_log(thread-&gt;log());
1848     }
1849     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
1850     // The thread-env() field is cleared in ~CompileTaskWrapper.
1851 
1852     // Cache Jvmti state
1853     ci_env.cache_jvmti_state();
1854 
1855     // Cache DTrace flags
1856     ci_env.cache_dtrace_flags();
1857 
1858     ciMethod* target = ci_env.get_method_from_handle(target_handle);
1859 
1860     TraceTime t1("compilation", &amp;time);
1861     EventCompilation event;
1862 
1863     if (comp == NULL) {
1864       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
1865     } else {
1866       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
1867         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
1868         while (WhiteBox::compilation_locked) {
1869           locker.wait(Mutex::_no_safepoint_check_flag);
1870         }
1871       }
1872       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
1873     }
1874 
1875     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
1876       //assert(false, "compiler should always document failure");
1877       // The compiler elected, without comment, not to register a result.
1878       // Do not attempt further compilations of this method.
1879       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
1880     }
1881 
1882     // Copy this bit to the enclosing block:
1883     compilable = ci_env.compilable();
1884 
1885     if (ci_env.failing()) {
1886       failure_reason = ci_env.failure_reason();
1887       retry_message = ci_env.retry_message();
1888       ci_env.report_failure(failure_reason);
1889     }
1890 
1891     post_compile(thread, task, event, !ci_env.failing(), &amp;ci_env);
1892   }
1893   // Remove the JNI handle block after the ciEnv destructor has run in
1894   // the previous block.
1895   pop_jni_handle_block();
1896 
1897   if (failure_reason != NULL) {
1898     task-&gt;set_failure_reason(failure_reason);
1899     if (_compilation_log != NULL) {
1900       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
1901     }
1902     if (PrintCompilation) {
1903       FormatBufferResource msg = retry_message != NULL ?
1904         FormatBufferResource("COMPILE SKIPPED: %s (%s)", failure_reason, retry_message) :
1905         FormatBufferResource("COMPILE SKIPPED: %s",      failure_reason);
1906       task-&gt;print(tty, msg);
1907     }
1908   }
1909 
1910   methodHandle method(thread, task-&gt;method());
1911 
1912   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
1913 
1914   collect_statistics(thread, time, task);
1915 
1916   bool printnmethods = directive-&gt;PrintAssemblyOption || directive-&gt;PrintNMethodsOption;
1917   if (printnmethods || PrintDebugInfo || PrintRelocations || PrintDependencies || PrintExceptionHandlers) {
1918     nmethod* nm = task-&gt;code();
1919     if (nm != NULL) {
1920       nm-&gt;print_nmethod(printnmethods);
1921     }
1922   }
1923   DirectivesStack::release(directive);
1924 
1925   if (PrintCompilation &amp;&amp; PrintCompilation2) {
1926     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
1927     tty-&gt;print("%4d ", compile_id);    // print compilation number
1928     tty-&gt;print("%s ", (is_osr ? "%" : " "));
1929     if (task-&gt;code() != NULL) {
1930       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
1931     }
1932     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
1933   }
1934 
1935   if (PrintCodeCacheOnCompilation)
1936     codecache_print(/* detailed= */ false);
1937 
1938   // Disable compilation, if required.
1939   switch (compilable) {
1940   case ciEnv::MethodCompilable_never:
1941     if (is_osr)
1942       method-&gt;set_not_osr_compilable_quietly();
1943     else
1944       method-&gt;set_not_compilable_quietly();
1945     break;
1946   case ciEnv::MethodCompilable_not_at_tier:
1947     if (is_osr)
1948       method-&gt;set_not_osr_compilable_quietly(task_level);
1949     else
1950       method-&gt;set_not_compilable_quietly(task_level);
1951     break;
1952   }
1953 
1954   // Note that the queued_for_compilation bits are cleared without
1955   // protection of a mutex. [They were set by the requester thread,
1956   // when adding the task to the compile queue -- at which time the
1957   // compile queue lock was held. Subsequently, we acquired the compile
1958   // queue lock to get this task off the compile queue; thus (to belabour
1959   // the point somewhat) our clearing of the bits must be occurring
1960   // only after the setting of the bits. See also 14012000 above.
1961   method-&gt;clear_queued_for_compilation();
1962 
1963 #ifdef ASSERT
1964   if (CollectedHeap::fired_fake_oom()) {
1965     // The current compile received a fake OOM during compilation so
1966     // go ahead and exit the VM since the test apparently succeeded
1967     tty-&gt;print_cr("*** Shutting down VM after successful fake OOM");
1968     vm_exit(0);
1969   }
1970 #endif
1971 }
1972 
1973 /**
1974  * The CodeCache is full. Print warning and disable compilation.
1975  * Schedule code cache cleaning so compilation can continue later.
1976  * This function needs to be called only from CodeCache::allocate(),
1977  * since we currently handle a full code cache uniformly.
1978  */
1979 void CompileBroker::handle_full_code_cache(int code_blob_type) {
1980   UseInterpreter = true;
1981   if (UseCompiler || AlwaysCompileLoopMethods ) {
1982     if (xtty != NULL) {
1983       ResourceMark rm;
1984       stringStream s;
1985       // Dump code cache state into a buffer before locking the tty,
1986       // because log_state() will use locks causing lock conflicts.
1987       CodeCache::log_state(&amp;s);
1988       // Lock to prevent tearing
1989       ttyLocker ttyl;
1990       xtty-&gt;begin_elem("code_cache_full");
1991       xtty-&gt;print("%s", s.as_string());
1992       xtty-&gt;stamp();
1993       xtty-&gt;end_elem();
1994     }
1995 
1996 #ifndef PRODUCT
1997     if (CompileTheWorld || ExitOnFullCodeCache) {
1998       codecache_print(/* detailed= */ true);
1999       before_exit(JavaThread::current());
2000       exit_globals(); // will delete tty
2001       vm_direct_exit(CompileTheWorld ? 0 : 1);
2002     }
2003 #endif
2004     if (UseCodeCacheFlushing) {
2005       // Since code cache is full, immediately stop new compiles
2006       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2007         NMethodSweeper::log_sweep("disable_compiler");
2008       }
2009     } else {
2010       disable_compilation_forever();
2011     }
2012 
2013     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2014   }
2015 }
2016 
2017 // ------------------------------------------------------------------
2018 // CompileBroker::set_last_compile
2019 //
2020 // Record this compilation for debugging purposes.
2021 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {
2022   ResourceMark rm;
2023   char* method_name = method-&gt;name()-&gt;as_C_string();
2024   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
2025   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
2026   char current_method[CompilerCounters::cmname_buffer_length];
2027   size_t maxLen = CompilerCounters::cmname_buffer_length;
2028 
2029   if (UsePerfData) {
2030     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2031 
2032     size_t s1len = strlen(class_name);
2033     size_t s2len = strlen(method_name);
2034 
2035     // check if we need to truncate the string
2036     if (s1len + s2len + 2 &gt; maxLen) {
2037 
2038       // the strategy is to lop off the leading characters of the
2039       // class name and the trailing characters of the method name.
2040 
2041       if (s2len + 2 &gt; maxLen) {
2042         // lop of the entire class name string, let snprintf handle
2043         // truncation of the method name.
2044         class_name += s1len; // null string
2045       }
2046       else {
2047         // lop off the extra characters from the front of the class name
2048         class_name += ((s1len + s2len + 2) - maxLen);
2049       }
2050     }
2051 
2052     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
2053   }
2054 
2055   if (CICountOSR &amp;&amp; is_osr) {
2056     _last_compile_type = osr_compile;
2057   } else {
2058     _last_compile_type = normal_compile;
2059   }
2060   _last_compile_level = comp_level;
2061 
2062   if (UsePerfData) {
2063     CompilerCounters* counters = thread-&gt;counters();
2064     counters-&gt;set_current_method(current_method);
2065     counters-&gt;set_compile_type((jlong)_last_compile_type);
2066   }
2067 }
2068 
2069 
2070 // ------------------------------------------------------------------
2071 // CompileBroker::push_jni_handle_block
2072 //
2073 // Push on a new block of JNI handles.
2074 void CompileBroker::push_jni_handle_block() {
2075   JavaThread* thread = JavaThread::current();
2076 
2077   // Allocate a new block for JNI handles.
2078   // Inlined code from jni_PushLocalFrame()
2079   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2080   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2081   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
2082   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
2083   thread-&gt;set_active_handles(compile_handles);
2084 }
2085 
2086 
2087 // ------------------------------------------------------------------
2088 // CompileBroker::pop_jni_handle_block
2089 //
2090 // Pop off the current block of JNI handles.
2091 void CompileBroker::pop_jni_handle_block() {
2092   JavaThread* thread = JavaThread::current();
2093 
2094   // Release our JNI handle block
2095   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2096   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2097   thread-&gt;set_active_handles(java_handles);
2098   compile_handles-&gt;set_pop_frame_link(NULL);
2099   JNIHandleBlock::release_block(compile_handles, thread); // may block
2100 }
2101 
2102 // ------------------------------------------------------------------
2103 // CompileBroker::collect_statistics
2104 //
2105 // Collect statistics about the compilation.
2106 
2107 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2108   bool success = task-&gt;is_success();
2109   methodHandle method (thread, task-&gt;method());
2110   uint compile_id = task-&gt;compile_id();
2111   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2112   nmethod* code = task-&gt;code();
2113   CompilerCounters* counters = thread-&gt;counters();
2114 
2115   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2116   MutexLocker locker(CompileStatistics_lock);
2117 
2118   // _perf variables are production performance counters which are
2119   // updated regardless of the setting of the CITime and CITimeEach flags
2120   //
2121 
2122   // account all time, including bailouts and failures in this counter;
2123   // C1 and C2 counters are counting both successful and unsuccessful compiles
2124   _t_total_compilation.add(time);
2125 
2126   if (!success) {
2127     _total_bailout_count++;
2128     if (UsePerfData) {
2129       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2130       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2131       _perf_total_bailout_count-&gt;inc();
2132     }
2133     _t_bailedout_compilation.add(time);
2134   } else if (code == NULL) {
2135     if (UsePerfData) {
2136       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2137       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2138       _perf_total_invalidated_count-&gt;inc();
2139     }
2140     _total_invalidated_count++;
2141     _t_invalidated_compilation.add(time);
2142   } else {
2143     // Compilation succeeded
2144 
2145     // update compilation ticks - used by the implementation of
2146     // java.lang.management.CompilationMBean
2147     _perf_total_compilation-&gt;inc(time.ticks());
2148     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2149 
2150     if (CITime) {
2151       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2152       JVMCI_ONLY(CompilerStatistics* stats = compiler(task-&gt;comp_level())-&gt;stats();)
2153       if (is_osr) {
2154         _t_osr_compilation.add(time);
2155         _sum_osr_bytes_compiled += bytes_compiled;
2156         JVMCI_ONLY(stats-&gt;_osr.update(time, bytes_compiled);)
2157       } else {
2158         _t_standard_compilation.add(time);
2159         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2160         JVMCI_ONLY(stats-&gt;_standard.update(time, bytes_compiled);)
2161       }
2162       JVMCI_ONLY(stats-&gt;_nmethods_size += code-&gt;total_size();)
2163       JVMCI_ONLY(stats-&gt;_nmethods_code_size += code-&gt;insts_size();)
2164     }
2165 
2166     if (UsePerfData) {
2167       // save the name of the last method compiled
2168       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2169       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2170       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2171                                          task-&gt;num_inlined_bytecodes());
2172       if (is_osr) {
2173         _perf_osr_compilation-&gt;inc(time.ticks());
2174         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2175       } else {
2176         _perf_standard_compilation-&gt;inc(time.ticks());
2177         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2178       }
2179     }
2180 
2181     if (CITimeEach) {
2182       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2183       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2184                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2185     }
2186 
2187     // Collect counts of successful compilations
2188     _sum_nmethod_size      += code-&gt;total_size();
2189     _sum_nmethod_code_size += code-&gt;insts_size();
2190     _total_compile_count++;
2191 
2192     if (UsePerfData) {
2193       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2194       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2195       _perf_total_compile_count-&gt;inc();
2196     }
2197 
2198     if (is_osr) {
2199       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2200       _total_osr_compile_count++;
2201     } else {
2202       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2203       _total_standard_compile_count++;
2204     }
2205   }
2206   // set the current method for the thread to null
2207   if (UsePerfData) counters-&gt;set_current_method("");
2208 }
2209 
2210 const char* CompileBroker::compiler_name(int comp_level) {
2211   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2212   if (comp == NULL) {
2213     return "no compiler";
2214   } else {
2215     return (comp-&gt;name());
2216   }
2217 }
2218 
2219 #if INCLUDE_JVMCI
2220 void CompileBroker::print_times(AbstractCompiler* comp) {
2221   CompilerStatistics* stats = comp-&gt;stats();
2222   tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2223                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2224                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2225                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2226                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2227   comp-&gt;print_timers();
2228 }
2229 #endif // INCLUDE_JVMCI
2230 
2231 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2232 #if INCLUDE_JVMCI
2233   elapsedTimer standard_compilation;
2234   elapsedTimer total_compilation;
2235   elapsedTimer osr_compilation;
2236 
2237   int standard_bytes_compiled = 0;
2238   int osr_bytes_compiled = 0;
2239 
2240   int standard_compile_count = 0;
2241   int osr_compile_count = 0;
2242   int total_compile_count = 0;
2243 
2244   int nmethods_size = 0;
2245   int nmethods_code_size = 0;
2246   bool printedHeader = false;
2247 
2248   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2249     AbstractCompiler* comp = _compilers[i];
2250     if (comp != NULL) {
2251       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2252         printedHeader = true;
2253         tty-&gt;cr();
2254         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2255         tty-&gt;print_cr("------------------------------------------------");
2256         tty-&gt;cr();
2257       }
2258       CompilerStatistics* stats = comp-&gt;stats();
2259 
2260       standard_compilation.add(stats-&gt;_standard._time);
2261       osr_compilation.add(stats-&gt;_osr._time);
2262 
2263       standard_bytes_compiled += stats-&gt;_standard._bytes;
2264       osr_bytes_compiled += stats-&gt;_osr._bytes;
2265 
2266       standard_compile_count += stats-&gt;_standard._count;
2267       osr_compile_count += stats-&gt;_osr._count;
2268 
2269       nmethods_size += stats-&gt;_nmethods_size;
2270       nmethods_code_size += stats-&gt;_nmethods_code_size;
2271 
2272       if (per_compiler) {
2273         print_times(comp);
2274       }
2275     }
2276   }
2277   total_compile_count = osr_compile_count + standard_compile_count;
2278   total_compilation.add(osr_compilation);
2279   total_compilation.add(standard_compilation);
2280 
2281   // In hosted mode, print the JVMCI compiler specific counters manually.
2282   if (!UseJVMCICompiler) {
2283     JVMCICompiler::print_compilation_timers();
2284   }
2285 #else // INCLUDE_JVMCI
2286   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2287   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2288   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2289 
2290   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2291   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2292 
2293   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2294   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2295   int total_compile_count = CompileBroker::_total_compile_count;
2296 
2297   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2298   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2299 #endif // INCLUDE_JVMCI
2300 
2301   if (!aggregate) {
2302     return;
2303   }
2304   tty-&gt;cr();
2305   tty-&gt;print_cr("Accumulated compiler times");
2306   tty-&gt;print_cr("----------------------------------------------------------");
2307                //0000000000111111111122222222223333333333444444444455555555556666666666
2308                //0123456789012345678901234567890123456789012345678901234567890123456789
2309   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2310   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2311                 standard_compilation.seconds(),
2312                 standard_compilation.seconds() / standard_compile_count);
2313   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2314                 CompileBroker::_t_bailedout_compilation.seconds(),
2315                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2316   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2317                 osr_compilation.seconds(),
2318                 osr_compilation.seconds() / osr_compile_count);
2319   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2320                 CompileBroker::_t_invalidated_compilation.seconds(),
2321                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2322 
2323   AbstractCompiler *comp = compiler(CompLevel_simple);
2324   if (comp != NULL) {
2325     tty-&gt;cr();
2326     comp-&gt;print_timers();
2327   }
2328   comp = compiler(CompLevel_full_optimization);
2329   if (comp != NULL) {
2330     tty-&gt;cr();
2331     comp-&gt;print_timers();
2332   }
2333   tty-&gt;cr();
2334   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2335   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2336   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2337   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2338   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2339   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2340   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2341   double tcs = total_compilation.seconds();
2342   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2343   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2344   tty-&gt;cr();
2345   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2346   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2347 }
2348 
2349 // Debugging output for failure
2350 void CompileBroker::print_last_compile() {
2351   if ( _last_compile_level != CompLevel_none &amp;&amp;
2352        compiler(_last_compile_level) != NULL &amp;&amp;
2353        _last_method_compiled != NULL &amp;&amp;
2354        _last_compile_type != no_compile) {
2355     if (_last_compile_type == osr_compile) {
2356       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2357                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2358     } else {
2359       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2360                     _compilation_id, _last_compile_level, _last_method_compiled);
2361     }
2362   }
2363 }
2364 
2365 
2366 void CompileBroker::print_compiler_threads_on(outputStream* st) {
2367 #ifndef PRODUCT
2368   st-&gt;print_cr("Compiler thread printing unimplemented.");
2369   st-&gt;cr();
2370 #endif
2371 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="12" type="hidden" /></form></body></html>
