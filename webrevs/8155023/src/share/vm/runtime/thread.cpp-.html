<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/share/vm/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/classLoader.hpp"
  27 #include "classfile/javaClasses.hpp"
  28 #include "classfile/moduleEntry.hpp"
  29 #include "classfile/systemDictionary.hpp"
  30 #include "classfile/vmSymbols.hpp"
  31 #include "code/codeCache.hpp"
  32 #include "code/codeCacheExtensions.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/gcId.hpp"
  37 #include "gc/shared/gcLocker.inline.hpp"
  38 #include "gc/shared/referencePendingListLocker.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jvmtifiles/jvmtiEnv.hpp"
  44 #include "logging/log.hpp"
  45 #include "logging/logConfiguration.hpp"
  46 #include "memory/metaspaceShared.hpp"
  47 #include "memory/oopFactory.hpp"
  48 #include "memory/resourceArea.hpp"
  49 #include "memory/universe.inline.hpp"
  50 #include "oops/instanceKlass.hpp"
  51 #include "oops/objArrayOop.hpp"
  52 #include "oops/oop.inline.hpp"
  53 #include "oops/symbol.hpp"
  54 #include "oops/verifyOopClosure.hpp"
  55 #include "prims/jvm_misc.hpp"
  56 #include "prims/jvmtiExport.hpp"
  57 #include "prims/jvmtiThreadState.hpp"
  58 #include "prims/privilegedStack.hpp"
  59 #include "runtime/arguments.hpp"
  60 #include "runtime/atomic.inline.hpp"
  61 #include "runtime/biasedLocking.hpp"
  62 #include "runtime/commandLineFlagConstraintList.hpp"
  63 #include "runtime/commandLineFlagRangeList.hpp"
  64 #include "runtime/deoptimization.hpp"
  65 #include "runtime/fprofiler.hpp"
  66 #include "runtime/frame.inline.hpp"
  67 #include "runtime/globals.hpp"
  68 #include "runtime/init.hpp"
  69 #include "runtime/interfaceSupport.hpp"
  70 #include "runtime/java.hpp"
  71 #include "runtime/javaCalls.hpp"
  72 #include "runtime/jniPeriodicChecker.hpp"
  73 #include "runtime/timerTrace.hpp"
  74 #include "runtime/memprofiler.hpp"
  75 #include "runtime/mutexLocker.hpp"
  76 #include "runtime/objectMonitor.hpp"
  77 #include "runtime/orderAccess.inline.hpp"
  78 #include "runtime/osThread.hpp"
  79 #include "runtime/safepoint.hpp"
  80 #include "runtime/sharedRuntime.hpp"
  81 #include "runtime/statSampler.hpp"
  82 #include "runtime/stubRoutines.hpp"
  83 #include "runtime/sweeper.hpp"
  84 #include "runtime/task.hpp"
  85 #include "runtime/thread.inline.hpp"
  86 #include "runtime/threadCritical.hpp"
  87 #include "runtime/vframe.hpp"
  88 #include "runtime/vframeArray.hpp"
  89 #include "runtime/vframe_hp.hpp"
  90 #include "runtime/vmThread.hpp"
  91 #include "runtime/vm_operations.hpp"
  92 #include "runtime/vm_version.hpp"
  93 #include "services/attachListener.hpp"
  94 #include "services/management.hpp"
  95 #include "services/memTracker.hpp"
  96 #include "services/threadService.hpp"
  97 #include "trace/traceMacros.hpp"
  98 #include "trace/tracing.hpp"
  99 #include "utilities/defaultStream.hpp"
 100 #include "utilities/dtrace.hpp"
 101 #include "utilities/events.hpp"
 102 #include "utilities/macros.hpp"
 103 #include "utilities/preserveException.hpp"
 104 #if INCLUDE_ALL_GCS
 105 #include "gc/cms/concurrentMarkSweepThread.hpp"
 106 #include "gc/g1/concurrentMarkThread.inline.hpp"
 107 #include "gc/parallel/pcTasks.hpp"
 108 #endif // INCLUDE_ALL_GCS
 109 #if INCLUDE_JVMCI
 110 #include "jvmci/jvmciCompiler.hpp"
 111 #include "jvmci/jvmciRuntime.hpp"
 112 #endif
 113 #ifdef COMPILER1
 114 #include "c1/c1_Compiler.hpp"
 115 #endif
 116 #ifdef COMPILER2
 117 #include "opto/c2compiler.hpp"
 118 #include "opto/idealGraphPrinter.hpp"
 119 #endif
 120 #if INCLUDE_RTM_OPT
 121 #include "runtime/rtmLocking.hpp"
 122 #endif
 123 
 124 // Initialization after module runtime initialization
 125 void universe_post_module_init();  // must happen after call_initPhase2
 126 
 127 #ifdef DTRACE_ENABLED
 128 
 129 // Only bother with this argument setup if dtrace is available
 130 
 131   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 132   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 133 
 134   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 135     {                                                                      \
 136       ResourceMark rm(this);                                               \
 137       int len = 0;                                                         \
 138       const char* name = (javathread)-&gt;get_thread_name();                  \
 139       len = strlen(name);                                                  \
 140       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 141         (char *) name, len,                                                \
 142         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 143         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 144         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 145     }
 146 
 147 #else //  ndef DTRACE_ENABLED
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)
 150 
 151 #endif // ndef DTRACE_ENABLED
 152 
 153 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 154 // Current thread is maintained as a thread-local variable
 155 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 156 #endif
 157 // Class hierarchy
 158 // - Thread
 159 //   - VMThread
 160 //   - WatcherThread
 161 //   - ConcurrentMarkSweepThread
 162 //   - JavaThread
 163 //     - CompilerThread
 164 
 165 // ======= Thread ========
 166 // Support for forcing alignment of thread objects for biased locking
 167 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 168   if (UseBiasedLocking) {
 169     const int alignment = markOopDesc::biased_lock_alignment;
 170     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 171     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 172                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 173                                                          AllocFailStrategy::RETURN_NULL);
 174     void* aligned_addr     = (void*) align_size_up((intptr_t) real_malloc_addr, alignment);
 175     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 176            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 177            "JavaThread alignment code overflowed allocated storage");
 178     if (aligned_addr != real_malloc_addr) {
 179       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 180                               p2i(real_malloc_addr),
 181                               p2i(aligned_addr));
 182     }
 183     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 184     return aligned_addr;
 185   } else {
 186     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 187                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 188   }
 189 }
 190 
 191 void Thread::operator delete(void* p) {
 192   if (UseBiasedLocking) {
 193     void* real_malloc_addr = ((Thread*) p)-&gt;_real_malloc_address;
 194     FreeHeap(real_malloc_addr);
 195   } else {
 196     FreeHeap(p);
 197   }
 198 }
 199 
 200 
 201 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 202 // JavaThread
 203 
 204 
 205 Thread::Thread() {
 206   // stack and get_thread
 207   set_stack_base(NULL);
 208   set_stack_size(0);
 209   set_self_raw_id(0);
 210   set_lgrp_id(-1);
 211   DEBUG_ONLY(clear_suspendible_thread();)
 212 
 213   // allocated data structures
 214   set_osthread(NULL);
 215   set_resource_area(new (mtThread)ResourceArea());
 216   DEBUG_ONLY(_current_resource_mark = NULL;)
 217   set_handle_area(new (mtThread) HandleArea(NULL));
 218   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 219   set_active_handles(NULL);
 220   set_free_handle_block(NULL);
 221   set_last_handle_mark(NULL);
 222 
 223   // This initial value ==&gt; never claimed.
 224   _oops_do_parity = 0;
 225 
 226   // the handle mark links itself to last_handle_mark
 227   new HandleMark(this);
 228 
 229   // plain initialization
 230   debug_only(_owned_locks = NULL;)
 231   debug_only(_allow_allocation_count = 0;)
 232   NOT_PRODUCT(_allow_safepoint_count = 0;)
 233   NOT_PRODUCT(_skip_gcalot = false;)
 234   _jvmti_env_iteration_count = 0;
 235   set_allocated_bytes(0);
 236   _vm_operation_started_count = 0;
 237   _vm_operation_completed_count = 0;
 238   _current_pending_monitor = NULL;
 239   _current_pending_monitor_is_from_java = true;
 240   _current_waiting_monitor = NULL;
 241   _num_nested_signal = 0;
 242   omFreeList = NULL;
 243   omFreeCount = 0;
 244   omFreeProvision = 32;
 245   omInUseList = NULL;
 246   omInUseCount = 0;
 247 
 248 #ifdef ASSERT
 249   _visited_for_critical_count = false;
 250 #endif
 251 
 252   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 253                          Monitor::_safepoint_check_sometimes);
 254   _suspend_flags = 0;
 255 
 256   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 257   _hashStateX = os::random();
 258   _hashStateY = 842502087;
 259   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 260   _hashStateW = 273326509;
 261 
 262   _OnTrap   = 0;
 263   _schedctl = NULL;
 264   _Stalled  = 0;
 265   _TypeTag  = 0x2BAD;
 266 
 267   // Many of the following fields are effectively final - immutable
 268   // Note that nascent threads can't use the Native Monitor-Mutex
 269   // construct until the _MutexEvent is initialized ...
 270   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 271   // we might instead use a stack of ParkEvents that we could provision on-demand.
 272   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 273   // and ::Release()
 274   _ParkEvent   = ParkEvent::Allocate(this);
 275   _SleepEvent  = ParkEvent::Allocate(this);
 276   _MutexEvent  = ParkEvent::Allocate(this);
 277   _MuxEvent    = ParkEvent::Allocate(this);
 278 
 279 #ifdef CHECK_UNHANDLED_OOPS
 280   if (CheckUnhandledOops) {
 281     _unhandled_oops = new UnhandledOops(this);
 282   }
 283 #endif // CHECK_UNHANDLED_OOPS
 284 #ifdef ASSERT
 285   if (UseBiasedLocking) {
 286     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 287     assert(this == _real_malloc_address ||
 288            this == (void*) align_size_up((intptr_t) _real_malloc_address, markOopDesc::biased_lock_alignment),
 289            "bug in forced alignment of thread objects");
 290   }
 291 #endif // ASSERT
 292 }
 293 
 294 void Thread::initialize_thread_current() {
 295 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 296   assert(_thr_current == NULL, "Thread::current already initialized");
 297   _thr_current = this;
 298 #endif
 299   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 300   ThreadLocalStorage::set_thread(this);
 301   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 302 }
 303 
 304 void Thread::clear_thread_current() {
 305   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 306 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 307   _thr_current = NULL;
 308 #endif
 309   ThreadLocalStorage::set_thread(NULL);
 310 }
 311 
 312 void Thread::record_stack_base_and_size() {
 313   set_stack_base(os::current_stack_base());
 314   set_stack_size(os::current_stack_size());
 315   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 316   // in initialize_thread(). Without the adjustment, stack size is
 317   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 318   // So far, only Solaris has real implementation of initialize_thread().
 319   //
 320   // set up any platform-specific state.
 321   os::initialize_thread(this);
 322 
 323   // Set stack limits after thread is initialized.
 324   if (is_Java_thread()) {
 325     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 326     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 327   }
 328 #if INCLUDE_NMT
 329   // record thread's native stack, stack grows downward
 330   MemTracker::record_thread_stack(stack_end(), stack_size());
 331 #endif // INCLUDE_NMT
 332   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 333     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 334     os::current_thread_id(), p2i(stack_base() - stack_size()),
 335     p2i(stack_base()), stack_size()/1024);
 336 }
 337 
 338 
 339 Thread::~Thread() {
 340   // Reclaim the objectmonitors from the omFreeList of the moribund thread.
 341   ObjectSynchronizer::omFlush(this);
 342 
 343   EVENT_THREAD_DESTRUCT(this);
 344 
 345   // stack_base can be NULL if the thread is never started or exited before
 346   // record_stack_base_and_size called. Although, we would like to ensure
 347   // that all started threads do call record_stack_base_and_size(), there is
 348   // not proper way to enforce that.
 349 #if INCLUDE_NMT
 350   if (_stack_base != NULL) {
 351     MemTracker::release_thread_stack(stack_end(), stack_size());
 352 #ifdef ASSERT
 353     set_stack_base(NULL);
 354 #endif
 355   }
 356 #endif // INCLUDE_NMT
 357 
 358   // deallocate data structures
 359   delete resource_area();
 360   // since the handle marks are using the handle area, we have to deallocated the root
 361   // handle mark before deallocating the thread's handle area,
 362   assert(last_handle_mark() != NULL, "check we have an element");
 363   delete last_handle_mark();
 364   assert(last_handle_mark() == NULL, "check we have reached the end");
 365 
 366   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 367   // We NULL out the fields for good hygiene.
 368   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 369   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 370   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 371   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 372 
 373   delete handle_area();
 374   delete metadata_handles();
 375 
 376   // osthread() can be NULL, if creation of thread failed.
 377   if (osthread() != NULL) os::free_thread(osthread());
 378 
 379   delete _SR_lock;
 380 
 381   // clear Thread::current if thread is deleting itself.
 382   // Needed to ensure JNI correctly detects non-attached threads.
 383   if (this == Thread::current()) {
 384     clear_thread_current();
 385   }
 386 
 387   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 388 }
 389 
 390 // NOTE: dummy function for assertion purpose.
 391 void Thread::run() {
 392   ShouldNotReachHere();
 393 }
 394 
 395 #ifdef ASSERT
 396 // Private method to check for dangling thread pointer
 397 void check_for_dangling_thread_pointer(Thread *thread) {
 398   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread || Threads_lock-&gt;owned_by_self(),
 399          "possibility of dangling Thread pointer");
 400 }
 401 #endif
 402 
 403 ThreadPriority Thread::get_priority(const Thread* const thread) {
 404   ThreadPriority priority;
 405   // Can return an error!
 406   (void)os::get_priority(thread, priority);
 407   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 408   return priority;
 409 }
 410 
 411 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 412   debug_only(check_for_dangling_thread_pointer(thread);)
 413   // Can return an error!
 414   (void)os::set_priority(thread, priority);
 415 }
 416 
 417 
 418 void Thread::start(Thread* thread) {
 419   // Start is different from resume in that its safety is guaranteed by context or
 420   // being called from a Java method synchronized on the Thread object.
 421   if (!DisableStartThread) {
 422     if (thread-&gt;is_Java_thread()) {
 423       // Initialize the thread state to RUNNABLE before starting this thread.
 424       // Can not set it after the thread started because we do not know the
 425       // exact thread state at that time. It could be in MONITOR_WAIT or
 426       // in SLEEPING or some other state.
 427       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 428                                           java_lang_Thread::RUNNABLE);
 429     }
 430     os::start_thread(thread);
 431   }
 432 }
 433 
 434 // Enqueue a VM_Operation to do the job for us - sometime later
 435 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 436   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 437   VMThread::execute(vm_stop);
 438 }
 439 
 440 
 441 // Check if an external suspend request has completed (or has been
 442 // cancelled). Returns true if the thread is externally suspended and
 443 // false otherwise.
 444 //
 445 // The bits parameter returns information about the code path through
 446 // the routine. Useful for debugging:
 447 //
 448 // set in is_ext_suspend_completed():
 449 // 0x00000001 - routine was entered
 450 // 0x00000010 - routine return false at end
 451 // 0x00000100 - thread exited (return false)
 452 // 0x00000200 - suspend request cancelled (return false)
 453 // 0x00000400 - thread suspended (return true)
 454 // 0x00001000 - thread is in a suspend equivalent state (return true)
 455 // 0x00002000 - thread is native and walkable (return true)
 456 // 0x00004000 - thread is native_trans and walkable (needed retry)
 457 //
 458 // set in wait_for_ext_suspend_completion():
 459 // 0x00010000 - routine was entered
 460 // 0x00020000 - suspend request cancelled before loop (return false)
 461 // 0x00040000 - thread suspended before loop (return true)
 462 // 0x00080000 - suspend request cancelled in loop (return false)
 463 // 0x00100000 - thread suspended in loop (return true)
 464 // 0x00200000 - suspend not completed during retry loop (return false)
 465 
 466 // Helper class for tracing suspend wait debug bits.
 467 //
 468 // 0x00000100 indicates that the target thread exited before it could
 469 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 470 // 0x00080000 each indicate a cancelled suspend request so they don't
 471 // count as wait failures either.
 472 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 473 
 474 class TraceSuspendDebugBits : public StackObj {
 475  private:
 476   JavaThread * jt;
 477   bool         is_wait;
 478   bool         called_by_wait;  // meaningful when !is_wait
 479   uint32_t *   bits;
 480 
 481  public:
 482   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 483                         uint32_t *_bits) {
 484     jt             = _jt;
 485     is_wait        = _is_wait;
 486     called_by_wait = _called_by_wait;
 487     bits           = _bits;
 488   }
 489 
 490   ~TraceSuspendDebugBits() {
 491     if (!is_wait) {
 492 #if 1
 493       // By default, don't trace bits for is_ext_suspend_completed() calls.
 494       // That trace is very chatty.
 495       return;
 496 #else
 497       if (!called_by_wait) {
 498         // If tracing for is_ext_suspend_completed() is enabled, then only
 499         // trace calls to it from wait_for_ext_suspend_completion()
 500         return;
 501       }
 502 #endif
 503     }
 504 
 505     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 506       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 507         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 508         ResourceMark rm;
 509 
 510         tty-&gt;print_cr(
 511                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 512                       jt-&gt;get_thread_name(), *bits);
 513 
 514         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 515       }
 516     }
 517   }
 518 };
 519 #undef DEBUG_FALSE_BITS
 520 
 521 
 522 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 523                                           uint32_t *bits) {
 524   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 525 
 526   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 527   bool do_trans_retry;           // flag to force the retry
 528 
 529   *bits |= 0x00000001;
 530 
 531   do {
 532     do_trans_retry = false;
 533 
 534     if (is_exiting()) {
 535       // Thread is in the process of exiting. This is always checked
 536       // first to reduce the risk of dereferencing a freed JavaThread.
 537       *bits |= 0x00000100;
 538       return false;
 539     }
 540 
 541     if (!is_external_suspend()) {
 542       // Suspend request is cancelled. This is always checked before
 543       // is_ext_suspended() to reduce the risk of a rogue resume
 544       // confusing the thread that made the suspend request.
 545       *bits |= 0x00000200;
 546       return false;
 547     }
 548 
 549     if (is_ext_suspended()) {
 550       // thread is suspended
 551       *bits |= 0x00000400;
 552       return true;
 553     }
 554 
 555     // Now that we no longer do hard suspends of threads running
 556     // native code, the target thread can be changing thread state
 557     // while we are in this routine:
 558     //
 559     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 560     //
 561     // We save a copy of the thread state as observed at this moment
 562     // and make our decision about suspend completeness based on the
 563     // copy. This closes the race where the thread state is seen as
 564     // _thread_in_native_trans in the if-thread_blocked check, but is
 565     // seen as _thread_blocked in if-thread_in_native_trans check.
 566     JavaThreadState save_state = thread_state();
 567 
 568     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 569       // If the thread's state is _thread_blocked and this blocking
 570       // condition is known to be equivalent to a suspend, then we can
 571       // consider the thread to be externally suspended. This means that
 572       // the code that sets _thread_blocked has been modified to do
 573       // self-suspension if the blocking condition releases. We also
 574       // used to check for CONDVAR_WAIT here, but that is now covered by
 575       // the _thread_blocked with self-suspension check.
 576       //
 577       // Return true since we wouldn't be here unless there was still an
 578       // external suspend request.
 579       *bits |= 0x00001000;
 580       return true;
 581     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 582       // Threads running native code will self-suspend on native==&gt;VM/Java
 583       // transitions. If its stack is walkable (should always be the case
 584       // unless this function is called before the actual java_suspend()
 585       // call), then the wait is done.
 586       *bits |= 0x00002000;
 587       return true;
 588     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 589                save_state == _thread_in_native_trans &amp;&amp;
 590                frame_anchor()-&gt;walkable()) {
 591       // The thread is transitioning from thread_in_native to another
 592       // thread state. check_safepoint_and_suspend_for_native_trans()
 593       // will force the thread to self-suspend. If it hasn't gotten
 594       // there yet we may have caught the thread in-between the native
 595       // code check above and the self-suspend. Lucky us. If we were
 596       // called by wait_for_ext_suspend_completion(), then it
 597       // will be doing the retries so we don't have to.
 598       //
 599       // Since we use the saved thread state in the if-statement above,
 600       // there is a chance that the thread has already transitioned to
 601       // _thread_blocked by the time we get here. In that case, we will
 602       // make a single unnecessary pass through the logic below. This
 603       // doesn't hurt anything since we still do the trans retry.
 604 
 605       *bits |= 0x00004000;
 606 
 607       // Once the thread leaves thread_in_native_trans for another
 608       // thread state, we break out of this retry loop. We shouldn't
 609       // need this flag to prevent us from getting back here, but
 610       // sometimes paranoia is good.
 611       did_trans_retry = true;
 612 
 613       // We wait for the thread to transition to a more usable state.
 614       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 615         // We used to do an "os::yield_all(i)" call here with the intention
 616         // that yielding would increase on each retry. However, the parameter
 617         // is ignored on Linux which means the yield didn't scale up. Waiting
 618         // on the SR_lock below provides a much more predictable scale up for
 619         // the delay. It also provides a simple/direct point to check for any
 620         // safepoint requests from the VMThread
 621 
 622         // temporarily drops SR_lock while doing wait with safepoint check
 623         // (if we're a JavaThread - the WatcherThread can also call this)
 624         // and increase delay with each retry
 625         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 626 
 627         // check the actual thread state instead of what we saved above
 628         if (thread_state() != _thread_in_native_trans) {
 629           // the thread has transitioned to another thread state so
 630           // try all the checks (except this one) one more time.
 631           do_trans_retry = true;
 632           break;
 633         }
 634       } // end retry loop
 635 
 636 
 637     }
 638   } while (do_trans_retry);
 639 
 640   *bits |= 0x00000010;
 641   return false;
 642 }
 643 
 644 // Wait for an external suspend request to complete (or be cancelled).
 645 // Returns true if the thread is externally suspended and false otherwise.
 646 //
 647 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 648                                                  uint32_t *bits) {
 649   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 650                              false /* !called_by_wait */, bits);
 651 
 652   // local flag copies to minimize SR_lock hold time
 653   bool is_suspended;
 654   bool pending;
 655   uint32_t reset_bits;
 656 
 657   // set a marker so is_ext_suspend_completed() knows we are the caller
 658   *bits |= 0x00010000;
 659 
 660   // We use reset_bits to reinitialize the bits value at the top of
 661   // each retry loop. This allows the caller to make use of any
 662   // unused bits for their own marking purposes.
 663   reset_bits = *bits;
 664 
 665   {
 666     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 667     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 668                                             delay, bits);
 669     pending = is_external_suspend();
 670   }
 671   // must release SR_lock to allow suspension to complete
 672 
 673   if (!pending) {
 674     // A cancelled suspend request is the only false return from
 675     // is_ext_suspend_completed() that keeps us from entering the
 676     // retry loop.
 677     *bits |= 0x00020000;
 678     return false;
 679   }
 680 
 681   if (is_suspended) {
 682     *bits |= 0x00040000;
 683     return true;
 684   }
 685 
 686   for (int i = 1; i &lt;= retries; i++) {
 687     *bits = reset_bits;  // reinit to only track last retry
 688 
 689     // We used to do an "os::yield_all(i)" call here with the intention
 690     // that yielding would increase on each retry. However, the parameter
 691     // is ignored on Linux which means the yield didn't scale up. Waiting
 692     // on the SR_lock below provides a much more predictable scale up for
 693     // the delay. It also provides a simple/direct point to check for any
 694     // safepoint requests from the VMThread
 695 
 696     {
 697       MutexLocker ml(SR_lock());
 698       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 699       // can also call this)  and increase delay with each retry
 700       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 701 
 702       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 703                                               delay, bits);
 704 
 705       // It is possible for the external suspend request to be cancelled
 706       // (by a resume) before the actual suspend operation is completed.
 707       // Refresh our local copy to see if we still need to wait.
 708       pending = is_external_suspend();
 709     }
 710 
 711     if (!pending) {
 712       // A cancelled suspend request is the only false return from
 713       // is_ext_suspend_completed() that keeps us from staying in the
 714       // retry loop.
 715       *bits |= 0x00080000;
 716       return false;
 717     }
 718 
 719     if (is_suspended) {
 720       *bits |= 0x00100000;
 721       return true;
 722     }
 723   } // end retry loop
 724 
 725   // thread did not suspend after all our retries
 726   *bits |= 0x00200000;
 727   return false;
 728 }
 729 
 730 #ifndef PRODUCT
 731 void JavaThread::record_jump(address target, address instr, const char* file,
 732                              int line) {
 733 
 734   // This should not need to be atomic as the only way for simultaneous
 735   // updates is via interrupts. Even then this should be rare or non-existent
 736   // and we don't care that much anyway.
 737 
 738   int index = _jmp_ring_index;
 739   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 740   _jmp_ring[index]._target = (intptr_t) target;
 741   _jmp_ring[index]._instruction = (intptr_t) instr;
 742   _jmp_ring[index]._file = file;
 743   _jmp_ring[index]._line = line;
 744 }
 745 #endif // PRODUCT
 746 
 747 // Called by flat profiler
 748 // Callers have already called wait_for_ext_suspend_completion
 749 // The assertion for that is currently too complex to put here:
 750 bool JavaThread::profile_last_Java_frame(frame* _fr) {
 751   bool gotframe = false;
 752   // self suspension saves needed state.
 753   if (has_last_Java_frame() &amp;&amp; _anchor.walkable()) {
 754     *_fr = pd_last_frame();
 755     gotframe = true;
 756   }
 757   return gotframe;
 758 }
 759 
 760 void Thread::interrupt(Thread* thread) {
 761   debug_only(check_for_dangling_thread_pointer(thread);)
 762   os::interrupt(thread);
 763 }
 764 
 765 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 766   debug_only(check_for_dangling_thread_pointer(thread);)
 767   // Note:  If clear_interrupted==false, this simply fetches and
 768   // returns the value of the field osthread()-&gt;interrupted().
 769   return os::is_interrupted(thread, clear_interrupted);
 770 }
 771 
 772 
 773 // GC Support
 774 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 775   jint thread_parity = _oops_do_parity;
 776   if (thread_parity != strong_roots_parity) {
 777     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 778     if (res == thread_parity) {
 779       return true;
 780     } else {
 781       guarantee(res == strong_roots_parity, "Or else what?");
 782       return false;
 783     }
 784   }
 785   return false;
 786 }
 787 
 788 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 789   active_handles()-&gt;oops_do(f);
 790   // Do oop for ThreadShadow
 791   f-&gt;do_oop((oop*)&amp;_pending_exception);
 792   handle_area()-&gt;oops_do(f);
 793 }
 794 
 795 void Thread::metadata_handles_do(void f(Metadata*)) {
 796   // Only walk the Handles in Thread.
 797   if (metadata_handles() != NULL) {
 798     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 799       f(metadata_handles()-&gt;at(i));
 800     }
 801   }
 802 }
 803 
 804 void Thread::print_on(outputStream* st) const {
 805   // get_priority assumes osthread initialized
 806   if (osthread() != NULL) {
 807     int os_prio;
 808     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 809       st-&gt;print("os_prio=%d ", os_prio);
 810     }
 811     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 812     ext().print_on(st);
 813     osthread()-&gt;print_on(st);
 814   }
 815   debug_only(if (WizardMode) print_owned_locks_on(st);)
 816 }
 817 
 818 // Thread::print_on_error() is called by fatal error handler. Don't use
 819 // any lock or allocate memory.
 820 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 821   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 822 
 823   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 824   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 825   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 826   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 827   else                                { st-&gt;print("Thread"); }
 828 
 829   if (is_Named_thread()) {
 830     st-&gt;print(" \"%s\"", name());
 831   }
 832 
 833   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 834             p2i(stack_end()), p2i(stack_base()));
 835 
 836   if (osthread()) {
 837     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 838   }
 839 }
 840 
 841 #ifdef ASSERT
 842 void Thread::print_owned_locks_on(outputStream* st) const {
 843   Monitor *cur = _owned_locks;
 844   if (cur == NULL) {
 845     st-&gt;print(" (no locks) ");
 846   } else {
 847     st-&gt;print_cr(" Locks owned:");
 848     while (cur) {
 849       cur-&gt;print_on(st);
 850       cur = cur-&gt;next();
 851     }
 852   }
 853 }
 854 
 855 static int ref_use_count  = 0;
 856 
 857 bool Thread::owns_locks_but_compiled_lock() const {
 858   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 859     if (cur != Compile_lock) return true;
 860   }
 861   return false;
 862 }
 863 
 864 
 865 #endif
 866 
 867 #ifndef PRODUCT
 868 
 869 // The flag: potential_vm_operation notifies if this particular safepoint state could potential
 870 // invoke the vm-thread (i.e., and oop allocation). In that case, we also have to make sure that
 871 // no threads which allow_vm_block's are held
 872 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 873   // Check if current thread is allowed to block at a safepoint
 874   if (!(_allow_safepoint_count == 0)) {
 875     fatal("Possible safepoint reached by thread that does not allow it");
 876   }
 877   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 878     fatal("LEAF method calling lock?");
 879   }
 880 
 881 #ifdef ASSERT
 882   if (potential_vm_operation &amp;&amp; is_Java_thread()
 883       &amp;&amp; !Universe::is_bootstrapping()) {
 884     // Make sure we do not hold any locks that the VM thread also uses.
 885     // This could potentially lead to deadlocks
 886     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 887       // Threads_lock is special, since the safepoint synchronization will not start before this is
 888       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 889       // since it is used to transfer control between JavaThreads and the VMThread
 890       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 891       if ((cur-&gt;allow_vm_block() &amp;&amp;
 892            cur != Threads_lock &amp;&amp;
 893            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 894            cur != VMOperationRequest_lock &amp;&amp;
 895            cur != VMOperationQueue_lock) ||
 896            cur-&gt;rank() == Mutex::special) {
 897         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 898       }
 899     }
 900   }
 901 
 902   if (GCALotAtAllSafepoints) {
 903     // We could enter a safepoint here and thus have a gc
 904     InterfaceSupport::check_gc_alot();
 905   }
 906 #endif
 907 }
 908 #endif
 909 
 910 bool Thread::is_in_stack(address adr) const {
 911   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
 912   address end = os::current_stack_pointer();
 913   // Allow non Java threads to call this without stack_base
 914   if (_stack_base == NULL) return true;
 915   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
 916 
 917   return false;
 918 }
 919 
 920 bool Thread::is_in_usable_stack(address adr) const {
 921   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
 922   size_t usable_stack_size = _stack_size - stack_guard_size;
 923 
 924   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
 925 }
 926 
 927 
 928 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
 929 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
 930 // used for compilation in the future. If that change is made, the need for these methods
 931 // should be revisited, and they should be removed if possible.
 932 
 933 bool Thread::is_lock_owned(address adr) const {
 934   return on_local_stack(adr);
 935 }
 936 
 937 bool Thread::set_as_starting_thread() {
 938   // NOTE: this must be called inside the main thread.
 939   return os::create_main_thread((JavaThread*)this);
 940 }
 941 
 942 static void initialize_class(Symbol* class_name, TRAPS) {
 943   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
 944   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
 945 }
 946 
 947 
 948 // Creates the initial ThreadGroup
 949 static Handle create_initial_thread_group(TRAPS) {
 950   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_ThreadGroup(), true, CHECK_NH);
 951   instanceKlassHandle klass (THREAD, k);
 952 
 953   Handle system_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 954   {
 955     JavaValue result(T_VOID);
 956     JavaCalls::call_special(&amp;result,
 957                             system_instance,
 958                             klass,
 959                             vmSymbols::object_initializer_name(),
 960                             vmSymbols::void_method_signature(),
 961                             CHECK_NH);
 962   }
 963   Universe::set_system_thread_group(system_instance());
 964 
 965   Handle main_instance = klass-&gt;allocate_instance_handle(CHECK_NH);
 966   {
 967     JavaValue result(T_VOID);
 968     Handle string = java_lang_String::create_from_str("main", CHECK_NH);
 969     JavaCalls::call_special(&amp;result,
 970                             main_instance,
 971                             klass,
 972                             vmSymbols::object_initializer_name(),
 973                             vmSymbols::threadgroup_string_void_signature(),
 974                             system_instance,
 975                             string,
 976                             CHECK_NH);
 977   }
 978   return main_instance;
 979 }
 980 
 981 // Creates the initial Thread
 982 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
 983                                  TRAPS) {
 984   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_NULL);
 985   instanceKlassHandle klass (THREAD, k);
 986   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_NULL);
 987 
 988   java_lang_Thread::set_thread(thread_oop(), thread);
 989   java_lang_Thread::set_priority(thread_oop(), NormPriority);
 990   thread-&gt;set_threadObj(thread_oop());
 991 
 992   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
 993 
 994   JavaValue result(T_VOID);
 995   JavaCalls::call_special(&amp;result, thread_oop,
 996                           klass,
 997                           vmSymbols::object_initializer_name(),
 998                           vmSymbols::threadgroup_string_void_signature(),
 999                           thread_group,
1000                           string,
1001                           CHECK_NULL);
1002   return thread_oop();
1003 }
1004 
1005 char java_runtime_name[128] = "";
1006 char java_runtime_version[128] = "";
1007 
1008 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1009 static const char* get_java_runtime_name(TRAPS) {
1010   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1011                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1012   fieldDescriptor fd;
1013   bool found = k != NULL &amp;&amp;
1014                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1015                                                         vmSymbols::string_signature(), &amp;fd);
1016   if (found) {
1017     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1018     if (name_oop == NULL) {
1019       return NULL;
1020     }
1021     const char* name = java_lang_String::as_utf8_string(name_oop,
1022                                                         java_runtime_name,
1023                                                         sizeof(java_runtime_name));
1024     return name;
1025   } else {
1026     return NULL;
1027   }
1028 }
1029 
1030 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1031 static const char* get_java_runtime_version(TRAPS) {
1032   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1033                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1034   fieldDescriptor fd;
1035   bool found = k != NULL &amp;&amp;
1036                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1037                                                         vmSymbols::string_signature(), &amp;fd);
1038   if (found) {
1039     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1040     if (name_oop == NULL) {
1041       return NULL;
1042     }
1043     const char* name = java_lang_String::as_utf8_string(name_oop,
1044                                                         java_runtime_version,
1045                                                         sizeof(java_runtime_version));
1046     return name;
1047   } else {
1048     return NULL;
1049   }
1050 }
1051 
1052 // General purpose hook into Java code, run once when the VM is initialized.
1053 // The Java library method itself may be changed independently from the VM.
1054 static void call_postVMInitHook(TRAPS) {
1055   Klass* k = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1056   instanceKlassHandle klass (THREAD, k);
1057   if (klass.not_null()) {
1058     JavaValue result(T_VOID);
1059     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1060                            vmSymbols::void_method_signature(),
1061                            CHECK);
1062   }
1063 }
1064 
1065 static void reset_vm_info_property(TRAPS) {
1066   // the vm info string
1067   ResourceMark rm(THREAD);
1068   const char *vm_info = VM_Version::vm_info_string();
1069 
1070   // java.lang.System class
1071   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
1072   instanceKlassHandle klass (THREAD, k);
1073 
1074   // setProperty arguments
1075   Handle key_str    = java_lang_String::create_from_str("java.vm.info", CHECK);
1076   Handle value_str  = java_lang_String::create_from_str(vm_info, CHECK);
1077 
1078   // return value
1079   JavaValue r(T_OBJECT);
1080 
1081   // public static String setProperty(String key, String value);
1082   JavaCalls::call_static(&amp;r,
1083                          klass,
1084                          vmSymbols::setProperty_name(),
1085                          vmSymbols::string_string_string_signature(),
1086                          key_str,
1087                          value_str,
1088                          CHECK);
1089 }
1090 
1091 
1092 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1093                                     bool daemon, TRAPS) {
1094   assert(thread_group.not_null(), "thread group should be specified");
1095   assert(threadObj() == NULL, "should only create Java thread object once");
1096 
1097   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK);
1098   instanceKlassHandle klass (THREAD, k);
1099   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK);
1100 
1101   java_lang_Thread::set_thread(thread_oop(), this);
1102   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1103   set_threadObj(thread_oop());
1104 
1105   JavaValue result(T_VOID);
1106   if (thread_name != NULL) {
1107     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1108     // Thread gets assigned specified name and null target
1109     JavaCalls::call_special(&amp;result,
1110                             thread_oop,
1111                             klass,
1112                             vmSymbols::object_initializer_name(),
1113                             vmSymbols::threadgroup_string_void_signature(),
1114                             thread_group, // Argument 1
1115                             name,         // Argument 2
1116                             THREAD);
1117   } else {
1118     // Thread gets assigned name "Thread-nnn" and null target
1119     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1120     JavaCalls::call_special(&amp;result,
1121                             thread_oop,
1122                             klass,
1123                             vmSymbols::object_initializer_name(),
1124                             vmSymbols::threadgroup_runnable_void_signature(),
1125                             thread_group, // Argument 1
1126                             Handle(),     // Argument 2
1127                             THREAD);
1128   }
1129 
1130 
1131   if (daemon) {
1132     java_lang_Thread::set_daemon(thread_oop());
1133   }
1134 
1135   if (HAS_PENDING_EXCEPTION) {
1136     return;
1137   }
1138 
1139   KlassHandle group(THREAD, SystemDictionary::ThreadGroup_klass());
1140   Handle threadObj(THREAD, this-&gt;threadObj());
1141 
1142   JavaCalls::call_special(&amp;result,
1143                           thread_group,
1144                           group,
1145                           vmSymbols::add_method_name(),
1146                           vmSymbols::thread_void_signature(),
1147                           threadObj,          // Arg 1
1148                           THREAD);
1149 }
1150 
1151 // NamedThread --  non-JavaThread subclasses with multiple
1152 // uniquely named instances should derive from this.
1153 NamedThread::NamedThread() : Thread() {
1154   _name = NULL;
1155   _processed_thread = NULL;
1156   _gc_id = GCId::undefined();
1157 }
1158 
1159 NamedThread::~NamedThread() {
1160   if (_name != NULL) {
1161     FREE_C_HEAP_ARRAY(char, _name);
1162     _name = NULL;
1163   }
1164 }
1165 
1166 void NamedThread::set_name(const char* format, ...) {
1167   guarantee(_name == NULL, "Only get to set name once.");
1168   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1169   guarantee(_name != NULL, "alloc failure");
1170   va_list ap;
1171   va_start(ap, format);
1172   jio_vsnprintf(_name, max_name_len, format, ap);
1173   va_end(ap);
1174 }
1175 
1176 void NamedThread::initialize_named_thread() {
1177   set_native_thread_name(name());
1178 }
1179 
1180 void NamedThread::print_on(outputStream* st) const {
1181   st-&gt;print("\"%s\" ", name());
1182   Thread::print_on(st);
1183   st-&gt;cr();
1184 }
1185 
1186 
1187 // ======= WatcherThread ========
1188 
1189 // The watcher thread exists to simulate timer interrupts.  It should
1190 // be replaced by an abstraction over whatever native support for
1191 // timer interrupts exists on the platform.
1192 
1193 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1194 bool WatcherThread::_startable = false;
1195 volatile bool  WatcherThread::_should_terminate = false;
1196 
1197 WatcherThread::WatcherThread() : Thread(), _crash_protection(NULL) {
1198   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1199   if (os::create_thread(this, os::watcher_thread)) {
1200     _watcher_thread = this;
1201 
1202     // Set the watcher thread to the highest OS priority which should not be
1203     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1204     // is created. The only normal thread using this priority is the reference
1205     // handler thread, which runs for very short intervals only.
1206     // If the VMThread's priority is not lower than the WatcherThread profiling
1207     // will be inaccurate.
1208     os::set_priority(this, MaxPriority);
1209     if (!DisableStartThread) {
1210       os::start_thread(this);
1211     }
1212   }
1213 }
1214 
1215 int WatcherThread::sleep() const {
1216   // The WatcherThread does not participate in the safepoint protocol
1217   // for the PeriodicTask_lock because it is not a JavaThread.
1218   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1219 
1220   if (_should_terminate) {
1221     // check for termination before we do any housekeeping or wait
1222     return 0;  // we did not sleep.
1223   }
1224 
1225   // remaining will be zero if there are no tasks,
1226   // causing the WatcherThread to sleep until a task is
1227   // enrolled
1228   int remaining = PeriodicTask::time_to_wait();
1229   int time_slept = 0;
1230 
1231   // we expect this to timeout - we only ever get unparked when
1232   // we should terminate or when a new task has been enrolled
1233   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1234 
1235   jlong time_before_loop = os::javaTimeNanos();
1236 
1237   while (true) {
1238     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1239                                             remaining);
1240     jlong now = os::javaTimeNanos();
1241 
1242     if (remaining == 0) {
1243       // if we didn't have any tasks we could have waited for a long time
1244       // consider the time_slept zero and reset time_before_loop
1245       time_slept = 0;
1246       time_before_loop = now;
1247     } else {
1248       // need to recalculate since we might have new tasks in _tasks
1249       time_slept = (int) ((now - time_before_loop) / 1000000);
1250     }
1251 
1252     // Change to task list or spurious wakeup of some kind
1253     if (timedout || _should_terminate) {
1254       break;
1255     }
1256 
1257     remaining = PeriodicTask::time_to_wait();
1258     if (remaining == 0) {
1259       // Last task was just disenrolled so loop around and wait until
1260       // another task gets enrolled
1261       continue;
1262     }
1263 
1264     remaining -= time_slept;
1265     if (remaining &lt;= 0) {
1266       break;
1267     }
1268   }
1269 
1270   return time_slept;
1271 }
1272 
1273 void WatcherThread::run() {
1274   assert(this == watcher_thread(), "just checking");
1275 
1276   this-&gt;record_stack_base_and_size();
1277   this-&gt;set_native_thread_name(this-&gt;name());
1278   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1279   while (true) {
1280     assert(watcher_thread() == Thread::current(), "thread consistency check");
1281     assert(watcher_thread() == this, "thread consistency check");
1282 
1283     // Calculate how long it'll be until the next PeriodicTask work
1284     // should be done, and sleep that amount of time.
1285     int time_waited = sleep();
1286 
1287     if (is_error_reported()) {
1288       // A fatal error has happened, the error handler(VMError::report_and_die)
1289       // should abort JVM after creating an error log file. However in some
1290       // rare cases, the error handler itself might deadlock. Here we try to
1291       // kill JVM if the fatal error handler fails to abort in 2 minutes.
1292       //
1293       // This code is in WatcherThread because WatcherThread wakes up
1294       // periodically so the fatal error handler doesn't need to do anything;
1295       // also because the WatcherThread is less likely to crash than other
1296       // threads.
1297 
1298       for (;;) {
1299         if (!ShowMessageBoxOnError
1300             &amp;&amp; (OnError == NULL || OnError[0] == '\0')
1301             &amp;&amp; Arguments::abort_hook() == NULL) {
1302           os::sleep(this, (jlong)ErrorLogTimeout * 1000, false); // in seconds
1303           fdStream err(defaultStream::output_fd());
1304           err.print_raw_cr("# [ timer expired, abort... ]");
1305           // skip atexit/vm_exit/vm_abort hooks
1306           os::die();
1307         }
1308 
1309         // Wake up 5 seconds later, the fatal handler may reset OnError or
1310         // ShowMessageBoxOnError when it is ready to abort.
1311         os::sleep(this, 5 * 1000, false);
1312       }
1313     }
1314 
1315     if (_should_terminate) {
1316       // check for termination before posting the next tick
1317       break;
1318     }
1319 
1320     PeriodicTask::real_time_tick(time_waited);
1321   }
1322 
1323   // Signal that it is terminated
1324   {
1325     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1326     _watcher_thread = NULL;
1327     Terminator_lock-&gt;notify();
1328   }
1329 }
1330 
1331 void WatcherThread::start() {
1332   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1333 
1334   if (watcher_thread() == NULL &amp;&amp; _startable) {
1335     _should_terminate = false;
1336     // Create the single instance of WatcherThread
1337     new WatcherThread();
1338   }
1339 }
1340 
1341 void WatcherThread::make_startable() {
1342   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1343   _startable = true;
1344 }
1345 
1346 void WatcherThread::stop() {
1347   {
1348     // Follow normal safepoint aware lock enter protocol since the
1349     // WatcherThread is stopped by another JavaThread.
1350     MutexLocker ml(PeriodicTask_lock);
1351     _should_terminate = true;
1352 
1353     WatcherThread* watcher = watcher_thread();
1354     if (watcher != NULL) {
1355       // unpark the WatcherThread so it can see that it should terminate
1356       watcher-&gt;unpark();
1357     }
1358   }
1359 
1360   MutexLocker mu(Terminator_lock);
1361 
1362   while (watcher_thread() != NULL) {
1363     // This wait should make safepoint checks, wait without a timeout,
1364     // and wait as a suspend-equivalent condition.
1365     //
1366     // Note: If the FlatProfiler is running, then this thread is waiting
1367     // for the WatcherThread to terminate and the WatcherThread, via the
1368     // FlatProfiler task, is waiting for the external suspend request on
1369     // this thread to complete. wait_for_ext_suspend_completion() will
1370     // eventually timeout, but that takes time. Making this wait a
1371     // suspend-equivalent condition solves that timeout problem.
1372     //
1373     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1374                           Mutex::_as_suspend_equivalent_flag);
1375   }
1376 }
1377 
1378 void WatcherThread::unpark() {
1379   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1380   PeriodicTask_lock-&gt;notify();
1381 }
1382 
1383 void WatcherThread::print_on(outputStream* st) const {
1384   st-&gt;print("\"%s\" ", name());
1385   Thread::print_on(st);
1386   st-&gt;cr();
1387 }
1388 
1389 // ======= JavaThread ========
1390 
1391 #if INCLUDE_JVMCI
1392 
1393 jlong* JavaThread::_jvmci_old_thread_counters;
1394 
1395 bool jvmci_counters_include(JavaThread* thread) {
1396   oop threadObj = thread-&gt;threadObj();
1397   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1398 }
1399 
1400 void JavaThread::collect_counters(typeArrayOop array) {
1401   if (JVMCICounterSize &gt; 0) {
1402     MutexLocker tl(Threads_lock);
1403     for (int i = 0; i &lt; array-&gt;length(); i++) {
1404       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1405     }
1406     for (JavaThread* tp = Threads::first(); tp != NULL; tp = tp-&gt;next()) {
1407       if (jvmci_counters_include(tp)) {
1408         for (int i = 0; i &lt; array-&gt;length(); i++) {
1409           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1410         }
1411       }
1412     }
1413   }
1414 }
1415 
1416 #endif // INCLUDE_JVMCI
1417 
1418 // A JavaThread is a normal Java thread
1419 
1420 void JavaThread::initialize() {
1421   // Initialize fields
1422 
1423   set_saved_exception_pc(NULL);
1424   set_threadObj(NULL);
1425   _anchor.clear();
1426   set_entry_point(NULL);
1427   set_jni_functions(jni_functions());
1428   set_callee_target(NULL);
1429   set_vm_result(NULL);
1430   set_vm_result_2(NULL);
1431   set_vframe_array_head(NULL);
1432   set_vframe_array_last(NULL);
1433   set_deferred_locals(NULL);
1434   set_deopt_mark(NULL);
1435   set_deopt_compiled_method(NULL);
1436   clear_must_deopt_id();
1437   set_monitor_chunks(NULL);
1438   set_next(NULL);
1439   set_thread_state(_thread_new);
1440   _terminated = _not_terminated;
1441   _privileged_stack_top = NULL;
1442   _array_for_gc = NULL;
1443   _suspend_equivalent = false;
1444   _in_deopt_handler = 0;
1445   _doing_unsafe_access = false;
1446   _stack_guard_state = stack_guard_unused;
1447 #if INCLUDE_JVMCI
1448   _pending_monitorenter = false;
1449   _pending_deoptimization = -1;
1450   _pending_failed_speculation = NULL;
1451   _pending_transfer_to_interpreter = false;
1452   _jvmci._alternate_call_target = NULL;
1453   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1454   if (JVMCICounterSize &gt; 0) {
1455     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1456     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1457   } else {
1458     _jvmci_counters = NULL;
1459   }
1460 #endif // INCLUDE_JVMCI
1461   _reserved_stack_activation = NULL;  // stack base not known yet
1462   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1463   _exception_pc  = 0;
1464   _exception_handler_pc = 0;
1465   _is_method_handle_return = 0;
1466   _jvmti_thread_state= NULL;
1467   _should_post_on_exceptions_flag = JNI_FALSE;
1468   _jvmti_get_loaded_classes_closure = NULL;
1469   _interp_only_mode    = 0;
1470   _special_runtime_exit_condition = _no_async_condition;
1471   _pending_async_exception = NULL;
1472   _thread_stat = NULL;
1473   _thread_stat = new ThreadStatistics();
1474   _blocked_on_compilation = false;
1475   _jni_active_critical = 0;
1476   _pending_jni_exception_check_fn = NULL;
1477   _do_not_unlock_if_synchronized = false;
1478   _cached_monitor_info = NULL;
1479   _parker = Parker::Allocate(this);
1480 
1481 #ifndef PRODUCT
1482   _jmp_ring_index = 0;
1483   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1484     record_jump(NULL, NULL, NULL, 0);
1485   }
1486 #endif // PRODUCT
1487 
1488   set_thread_profiler(NULL);
1489   if (FlatProfiler::is_active()) {
1490     // This is where we would decide to either give each thread it's own profiler
1491     // or use one global one from FlatProfiler,
1492     // or up to some count of the number of profiled threads, etc.
1493     ThreadProfiler* pp = new ThreadProfiler();
1494     pp-&gt;engage();
1495     set_thread_profiler(pp);
1496   }
1497 
1498   // Setup safepoint state info for this thread
1499   ThreadSafepointState::create(this);
1500 
1501   debug_only(_java_call_counter = 0);
1502 
1503   // JVMTI PopFrame support
1504   _popframe_condition = popframe_inactive;
1505   _popframe_preserved_args = NULL;
1506   _popframe_preserved_args_size = 0;
1507   _frames_to_pop_failed_realloc = 0;
1508 
1509   pd_initialize();
1510 }
1511 
1512 #if INCLUDE_ALL_GCS
1513 SATBMarkQueueSet JavaThread::_satb_mark_queue_set;
1514 DirtyCardQueueSet JavaThread::_dirty_card_queue_set;
1515 #endif // INCLUDE_ALL_GCS
1516 
1517 JavaThread::JavaThread(bool is_attaching_via_jni) :
1518                        Thread()
1519 #if INCLUDE_ALL_GCS
1520                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1521                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1522 #endif // INCLUDE_ALL_GCS
1523 {
1524   initialize();
1525   if (is_attaching_via_jni) {
1526     _jni_attach_state = _attaching_via_jni;
1527   } else {
1528     _jni_attach_state = _not_attaching_via_jni;
1529   }
1530   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1531 }
1532 
1533 bool JavaThread::reguard_stack(address cur_sp) {
1534   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1535       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1536     return true; // Stack already guarded or guard pages not needed.
1537   }
1538 
1539   if (register_stack_overflow()) {
1540     // For those architectures which have separate register and
1541     // memory stacks, we must check the register stack to see if
1542     // it has overflowed.
1543     return false;
1544   }
1545 
1546   // Java code never executes within the yellow zone: the latter is only
1547   // there to provoke an exception during stack banging.  If java code
1548   // is executing there, either StackShadowPages should be larger, or
1549   // some exception code in c1, c2 or the interpreter isn't unwinding
1550   // when it should.
1551   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1552             "not enough space to reguard - increase StackShadowPages");
1553   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1554     enable_stack_yellow_reserved_zone();
1555     if (reserved_stack_activation() != stack_base()) {
1556       set_reserved_stack_activation(stack_base());
1557     }
1558   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1559     set_reserved_stack_activation(stack_base());
1560     enable_stack_reserved_zone();
1561   }
1562   return true;
1563 }
1564 
1565 bool JavaThread::reguard_stack(void) {
1566   return reguard_stack(os::current_stack_pointer());
1567 }
1568 
1569 
1570 void JavaThread::block_if_vm_exited() {
1571   if (_terminated == _vm_exited) {
1572     // _vm_exited is set at safepoint, and Threads_lock is never released
1573     // we will block here forever
1574     Threads_lock-&gt;lock_without_safepoint_check();
1575     ShouldNotReachHere();
1576   }
1577 }
1578 
1579 
1580 // Remove this ifdef when C1 is ported to the compiler interface.
1581 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1582 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1583 
1584 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1585                        Thread()
1586 #if INCLUDE_ALL_GCS
1587                        , _satb_mark_queue(&amp;_satb_mark_queue_set),
1588                        _dirty_card_queue(&amp;_dirty_card_queue_set)
1589 #endif // INCLUDE_ALL_GCS
1590 {
1591   initialize();
1592   _jni_attach_state = _not_attaching_via_jni;
1593   set_entry_point(entry_point);
1594   // Create the native thread itself.
1595   // %note runtime_23
1596   os::ThreadType thr_type = os::java_thread;
1597   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1598                                                      os::java_thread;
1599   os::create_thread(this, thr_type, stack_sz);
1600   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1601   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1602   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1603   // the exception consists of creating the exception object &amp; initializing it, initialization
1604   // will leave the VM via a JavaCall and then all locks must be unlocked).
1605   //
1606   // The thread is still suspended when we reach here. Thread must be explicit started
1607   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1608   // by calling Threads:add. The reason why this is not done here, is because the thread
1609   // object must be fully initialized (take a look at JVM_Start)
1610 }
1611 
1612 JavaThread::~JavaThread() {
1613 
1614   // JSR166 -- return the parker to the free list
1615   Parker::Release(_parker);
1616   _parker = NULL;
1617 
1618   // Free any remaining  previous UnrollBlock
1619   vframeArray* old_array = vframe_array_last();
1620 
1621   if (old_array != NULL) {
1622     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1623     old_array-&gt;set_unroll_block(NULL);
1624     delete old_info;
1625     delete old_array;
1626   }
1627 
1628   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1629   if (deferred != NULL) {
1630     // This can only happen if thread is destroyed before deoptimization occurs.
1631     assert(deferred-&gt;length() != 0, "empty array!");
1632     do {
1633       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1634       deferred-&gt;remove_at(0);
1635       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1636       delete dlv;
1637     } while (deferred-&gt;length() != 0);
1638     delete deferred;
1639   }
1640 
1641   // All Java related clean up happens in exit
1642   ThreadSafepointState::destroy(this);
1643   if (_thread_profiler != NULL) delete _thread_profiler;
1644   if (_thread_stat != NULL) delete _thread_stat;
1645 
1646 #if INCLUDE_JVMCI
1647   if (JVMCICounterSize &gt; 0) {
1648     if (jvmci_counters_include(this)) {
1649       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1650         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1651       }
1652     }
1653     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1654   }
1655 #endif // INCLUDE_JVMCI
1656 }
1657 
1658 
1659 // The first routine called by a new Java thread
1660 void JavaThread::run() {
1661   // initialize thread-local alloc buffer related fields
1662   this-&gt;initialize_tlab();
1663 
1664   // used to test validity of stack trace backs
1665   this-&gt;record_base_of_stack_pointer();
1666 
1667   // Record real stack base and size.
1668   this-&gt;record_stack_base_and_size();
1669 
1670   this-&gt;create_stack_guard_pages();
1671 
1672   this-&gt;cache_global_variables();
1673 
1674   // Thread is now sufficient initialized to be handled by the safepoint code as being
1675   // in the VM. Change thread state from _thread_new to _thread_in_vm
1676   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1677 
1678   assert(JavaThread::current() == this, "sanity check");
1679   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1680 
1681   DTRACE_THREAD_PROBE(start, this);
1682 
1683   // This operation might block. We call that after all safepoint checks for a new thread has
1684   // been completed.
1685   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1686 
1687   if (JvmtiExport::should_post_thread_life()) {
1688     JvmtiExport::post_thread_start(this);
1689   }
1690 
1691   EventThreadStart event;
1692   if (event.should_commit()) {
1693     event.set_thread(THREAD_TRACE_ID(this));
1694     event.commit();
1695   }
1696 
1697   // We call another function to do the rest so we are sure that the stack addresses used
1698   // from there will be lower than the stack base just computed
1699   thread_main_inner();
1700 
1701   // Note, thread is no longer valid at this point!
1702 }
1703 
1704 
1705 void JavaThread::thread_main_inner() {
1706   assert(JavaThread::current() == this, "sanity check");
1707   assert(this-&gt;threadObj() != NULL, "just checking");
1708 
1709   // Execute thread entry point unless this thread has a pending exception
1710   // or has been stopped before starting.
1711   // Note: Due to JVM_StopThread we can have pending exceptions already!
1712   if (!this-&gt;has_pending_exception() &amp;&amp;
1713       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1714     {
1715       ResourceMark rm(this);
1716       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1717     }
1718     HandleMark hm(this);
1719     this-&gt;entry_point()(this, this);
1720   }
1721 
1722   DTRACE_THREAD_PROBE(stop, this);
1723 
1724   this-&gt;exit(false);
1725   delete this;
1726 }
1727 
1728 
1729 static void ensure_join(JavaThread* thread) {
1730   // We do not need to grap the Threads_lock, since we are operating on ourself.
1731   Handle threadObj(thread, thread-&gt;threadObj());
1732   assert(threadObj.not_null(), "java thread object must exist");
1733   ObjectLocker lock(threadObj, thread);
1734   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1735   thread-&gt;clear_pending_exception();
1736   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1737   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1738   // Clear the native thread instance - this makes isAlive return false and allows the join()
1739   // to complete once we've done the notify_all below
1740   java_lang_Thread::set_thread(threadObj(), NULL);
1741   lock.notify_all(thread);
1742   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1743   thread-&gt;clear_pending_exception();
1744 }
1745 
1746 
1747 // For any new cleanup additions, please check to see if they need to be applied to
1748 // cleanup_failed_attach_current_thread as well.
1749 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1750   assert(this == JavaThread::current(), "thread consistency check");
1751 
1752   HandleMark hm(this);
1753   Handle uncaught_exception(this, this-&gt;pending_exception());
1754   this-&gt;clear_pending_exception();
1755   Handle threadObj(this, this-&gt;threadObj());
1756   assert(threadObj.not_null(), "Java thread object should be created");
1757 
1758   if (get_thread_profiler() != NULL) {
1759     get_thread_profiler()-&gt;disengage();
1760     ResourceMark rm;
1761     get_thread_profiler()-&gt;print(get_thread_name());
1762   }
1763 
1764 
1765   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1766   {
1767     EXCEPTION_MARK;
1768 
1769     CLEAR_PENDING_EXCEPTION;
1770   }
1771   if (!destroy_vm) {
1772     if (uncaught_exception.not_null()) {
1773       EXCEPTION_MARK;
1774       // Call method Thread.dispatchUncaughtException().
1775       KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1776       JavaValue result(T_VOID);
1777       JavaCalls::call_virtual(&amp;result,
1778                               threadObj, thread_klass,
1779                               vmSymbols::dispatchUncaughtException_name(),
1780                               vmSymbols::throwable_void_signature(),
1781                               uncaught_exception,
1782                               THREAD);
1783       if (HAS_PENDING_EXCEPTION) {
1784         ResourceMark rm(this);
1785         jio_fprintf(defaultStream::error_stream(),
1786                     "\nException: %s thrown from the UncaughtExceptionHandler"
1787                     " in thread \"%s\"\n",
1788                     pending_exception()-&gt;klass()-&gt;external_name(),
1789                     get_thread_name());
1790         CLEAR_PENDING_EXCEPTION;
1791       }
1792     }
1793 
1794     // Called before the java thread exit since we want to read info
1795     // from java_lang_Thread object
1796     EventThreadEnd event;
1797     if (event.should_commit()) {
1798       event.set_thread(THREAD_TRACE_ID(this));
1799       event.commit();
1800     }
1801 
1802     // Call after last event on thread
1803     EVENT_THREAD_EXIT(this);
1804 
1805     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1806     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1807     // is deprecated anyhow.
1808     if (!is_Compiler_thread()) {
1809       int count = 3;
1810       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1811         EXCEPTION_MARK;
1812         JavaValue result(T_VOID);
1813         KlassHandle thread_klass(THREAD, SystemDictionary::Thread_klass());
1814         JavaCalls::call_virtual(&amp;result,
1815                                 threadObj, thread_klass,
1816                                 vmSymbols::exit_method_name(),
1817                                 vmSymbols::void_method_signature(),
1818                                 THREAD);
1819         CLEAR_PENDING_EXCEPTION;
1820       }
1821     }
1822     // notify JVMTI
1823     if (JvmtiExport::should_post_thread_life()) {
1824       JvmtiExport::post_thread_end(this);
1825     }
1826 
1827     // We have notified the agents that we are exiting, before we go on,
1828     // we must check for a pending external suspend request and honor it
1829     // in order to not surprise the thread that made the suspend request.
1830     while (true) {
1831       {
1832         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1833         if (!is_external_suspend()) {
1834           set_terminated(_thread_exiting);
1835           ThreadService::current_thread_exiting(this);
1836           break;
1837         }
1838         // Implied else:
1839         // Things get a little tricky here. We have a pending external
1840         // suspend request, but we are holding the SR_lock so we
1841         // can't just self-suspend. So we temporarily drop the lock
1842         // and then self-suspend.
1843       }
1844 
1845       ThreadBlockInVM tbivm(this);
1846       java_suspend_self();
1847 
1848       // We're done with this suspend request, but we have to loop around
1849       // and check again. Eventually we will get SR_lock without a pending
1850       // external suspend request and will be able to mark ourselves as
1851       // exiting.
1852     }
1853     // no more external suspends are allowed at this point
1854   } else {
1855     // before_exit() has already posted JVMTI THREAD_END events
1856   }
1857 
1858   // Notify waiters on thread object. This has to be done after exit() is called
1859   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1860   // group should have the destroyed bit set before waiters are notified).
1861   ensure_join(this);
1862   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1863 
1864   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1865   // held by this thread must be released. The spec does not distinguish
1866   // between JNI-acquired and regular Java monitors. We can only see
1867   // regular Java monitors here if monitor enter-exit matching is broken.
1868   //
1869   // Optionally release any monitors for regular JavaThread exits. This
1870   // is provided as a work around for any bugs in monitor enter-exit
1871   // matching. This can be expensive so it is not enabled by default.
1872   //
1873   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1874   // ObjectSynchronizer::release_monitors_owned_by_thread().
1875   if (exit_type == jni_detach || ObjectMonitor::Knob_ExitRelease) {
1876     // Sanity check even though JNI DetachCurrentThread() would have
1877     // returned JNI_ERR if there was a Java frame. JavaThread exit
1878     // should be done executing Java code by the time we get here.
1879     assert(!this-&gt;has_last_Java_frame(),
1880            "should not have a Java frame when detaching or exiting");
1881     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1882     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1883   }
1884 
1885   // These things needs to be done while we are still a Java Thread. Make sure that thread
1886   // is in a consistent state, in case GC happens
1887   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1888 
1889   if (active_handles() != NULL) {
1890     JNIHandleBlock* block = active_handles();
1891     set_active_handles(NULL);
1892     JNIHandleBlock::release_block(block);
1893   }
1894 
1895   if (free_handle_block() != NULL) {
1896     JNIHandleBlock* block = free_handle_block();
1897     set_free_handle_block(NULL);
1898     JNIHandleBlock::release_block(block);
1899   }
1900 
1901   // These have to be removed while this is still a valid thread.
1902   remove_stack_guard_pages();
1903 
1904   if (UseTLAB) {
1905     tlab().make_parsable(true);  // retire TLAB
1906   }
1907 
1908   if (JvmtiEnv::environments_might_exist()) {
1909     JvmtiExport::cleanup_thread(this);
1910   }
1911 
1912   // We must flush any deferred card marks before removing a thread from
1913   // the list of active threads.
1914   Universe::heap()-&gt;flush_deferred_store_barrier(this);
1915   assert(deferred_card_mark().is_empty(), "Should have been flushed");
1916 
1917 #if INCLUDE_ALL_GCS
1918   // We must flush the G1-related buffers before removing a thread
1919   // from the list of active threads. We must do this after any deferred
1920   // card marks have been flushed (above) so that any entries that are
1921   // added to the thread's dirty card queue as a result are not lost.
1922   if (UseG1GC) {
1923     flush_barrier_queues();
1924   }
1925 #endif // INCLUDE_ALL_GCS
1926 
1927   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
1928     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
1929     os::current_thread_id());
1930 
1931   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
1932   Threads::remove(this);
1933 }
1934 
1935 #if INCLUDE_ALL_GCS
1936 // Flush G1-related queues.
1937 void JavaThread::flush_barrier_queues() {
1938   satb_mark_queue().flush();
1939   dirty_card_queue().flush();
1940 }
1941 
1942 void JavaThread::initialize_queues() {
1943   assert(!SafepointSynchronize::is_at_safepoint(),
1944          "we should not be at a safepoint");
1945 
1946   SATBMarkQueue&amp; satb_queue = satb_mark_queue();
1947   SATBMarkQueueSet&amp; satb_queue_set = satb_mark_queue_set();
1948   // The SATB queue should have been constructed with its active
1949   // field set to false.
1950   assert(!satb_queue.is_active(), "SATB queue should not be active");
1951   assert(satb_queue.is_empty(), "SATB queue should be empty");
1952   // If we are creating the thread during a marking cycle, we should
1953   // set the active field of the SATB queue to true.
1954   if (satb_queue_set.is_active()) {
1955     satb_queue.set_active(true);
1956   }
1957 
1958   DirtyCardQueue&amp; dirty_queue = dirty_card_queue();
1959   // The dirty card queue should have been constructed with its
1960   // active field set to true.
1961   assert(dirty_queue.is_active(), "dirty card queue should be active");
1962 }
1963 #endif // INCLUDE_ALL_GCS
1964 
1965 void JavaThread::cleanup_failed_attach_current_thread() {
1966   if (get_thread_profiler() != NULL) {
1967     get_thread_profiler()-&gt;disengage();
1968     ResourceMark rm;
1969     get_thread_profiler()-&gt;print(get_thread_name());
1970   }
1971 
1972   if (active_handles() != NULL) {
1973     JNIHandleBlock* block = active_handles();
1974     set_active_handles(NULL);
1975     JNIHandleBlock::release_block(block);
1976   }
1977 
1978   if (free_handle_block() != NULL) {
1979     JNIHandleBlock* block = free_handle_block();
1980     set_free_handle_block(NULL);
1981     JNIHandleBlock::release_block(block);
1982   }
1983 
1984   // These have to be removed while this is still a valid thread.
1985   remove_stack_guard_pages();
1986 
1987   if (UseTLAB) {
1988     tlab().make_parsable(true);  // retire TLAB, if any
1989   }
1990 
1991 #if INCLUDE_ALL_GCS
1992   if (UseG1GC) {
1993     flush_barrier_queues();
1994   }
1995 #endif // INCLUDE_ALL_GCS
1996 
1997   Threads::remove(this);
1998   delete this;
1999 }
2000 
2001 
2002 
2003 
2004 JavaThread* JavaThread::active() {
2005   Thread* thread = Thread::current();
2006   if (thread-&gt;is_Java_thread()) {
2007     return (JavaThread*) thread;
2008   } else {
2009     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2010     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2011     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2012     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2013     return ret;
2014   }
2015 }
2016 
2017 bool JavaThread::is_lock_owned(address adr) const {
2018   if (Thread::is_lock_owned(adr)) return true;
2019 
2020   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2021     if (chunk-&gt;contains(adr)) return true;
2022   }
2023 
2024   return false;
2025 }
2026 
2027 
2028 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2029   chunk-&gt;set_next(monitor_chunks());
2030   set_monitor_chunks(chunk);
2031 }
2032 
2033 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2034   guarantee(monitor_chunks() != NULL, "must be non empty");
2035   if (monitor_chunks() == chunk) {
2036     set_monitor_chunks(chunk-&gt;next());
2037   } else {
2038     MonitorChunk* prev = monitor_chunks();
2039     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2040     prev-&gt;set_next(chunk-&gt;next());
2041   }
2042 }
2043 
2044 // JVM support.
2045 
2046 // Note: this function shouldn't block if it's called in
2047 // _thread_in_native_trans state (such as from
2048 // check_special_condition_for_native_trans()).
2049 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2050 
2051   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2052     // If we are at a polling page safepoint (not a poll return)
2053     // then we must defer async exception because live registers
2054     // will be clobbered by the exception path. Poll return is
2055     // ok because the call we a returning from already collides
2056     // with exception handling registers and so there is no issue.
2057     // (The exception handling path kills call result registers but
2058     //  this is ok since the exception kills the result anyway).
2059 
2060     if (is_at_poll_safepoint()) {
2061       // if the code we are returning to has deoptimized we must defer
2062       // the exception otherwise live registers get clobbered on the
2063       // exception path before deoptimization is able to retrieve them.
2064       //
2065       RegisterMap map(this, false);
2066       frame caller_fr = last_frame().sender(&amp;map);
2067       assert(caller_fr.is_compiled_frame(), "what?");
2068       if (caller_fr.is_deoptimized_frame()) {
2069         log_info(exceptions)("deferred async exception at compiled safepoint");
2070         return;
2071       }
2072     }
2073   }
2074 
2075   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2076   if (condition == _no_async_condition) {
2077     // Conditions have changed since has_special_runtime_exit_condition()
2078     // was called:
2079     // - if we were here only because of an external suspend request,
2080     //   then that was taken care of above (or cancelled) so we are done
2081     // - if we were here because of another async request, then it has
2082     //   been cleared between the has_special_runtime_exit_condition()
2083     //   and now so again we are done
2084     return;
2085   }
2086 
2087   // Check for pending async. exception
2088   if (_pending_async_exception != NULL) {
2089     // Only overwrite an already pending exception, if it is not a threadDeath.
2090     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2091 
2092       // We cannot call Exceptions::_throw(...) here because we cannot block
2093       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2094 
2095       if (log_is_enabled(Info, exceptions)) {
2096         ResourceMark rm;
2097         outputStream* logstream = Log(exceptions)::info_stream();
2098         logstream-&gt;print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2099           if (has_last_Java_frame()) {
2100             frame f = last_frame();
2101            logstream-&gt;print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2102           }
2103         logstream-&gt;print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2104       }
2105       _pending_async_exception = NULL;
2106       clear_has_async_exception();
2107     }
2108   }
2109 
2110   if (check_unsafe_error &amp;&amp;
2111       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2112     condition = _no_async_condition;  // done
2113     switch (thread_state()) {
2114     case _thread_in_vm: {
2115       JavaThread* THREAD = this;
2116       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2117     }
2118     case _thread_in_native: {
2119       ThreadInVMfromNative tiv(this);
2120       JavaThread* THREAD = this;
2121       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2122     }
2123     case _thread_in_Java: {
2124       ThreadInVMfromJava tiv(this);
2125       JavaThread* THREAD = this;
2126       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2127     }
2128     default:
2129       ShouldNotReachHere();
2130     }
2131   }
2132 
2133   assert(condition == _no_async_condition || has_pending_exception() ||
2134          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2135          "must have handled the async condition, if no exception");
2136 }
2137 
2138 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2139   //
2140   // Check for pending external suspend. Internal suspend requests do
2141   // not use handle_special_runtime_exit_condition().
2142   // If JNIEnv proxies are allowed, don't self-suspend if the target
2143   // thread is not the current thread. In older versions of jdbx, jdbx
2144   // threads could call into the VM with another thread's JNIEnv so we
2145   // can be here operating on behalf of a suspended thread (4432884).
2146   bool do_self_suspend = is_external_suspend_with_lock();
2147   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2148     //
2149     // Because thread is external suspended the safepoint code will count
2150     // thread as at a safepoint. This can be odd because we can be here
2151     // as _thread_in_Java which would normally transition to _thread_blocked
2152     // at a safepoint. We would like to mark the thread as _thread_blocked
2153     // before calling java_suspend_self like all other callers of it but
2154     // we must then observe proper safepoint protocol. (We can't leave
2155     // _thread_blocked with a safepoint in progress). However we can be
2156     // here as _thread_in_native_trans so we can't use a normal transition
2157     // constructor/destructor pair because they assert on that type of
2158     // transition. We could do something like:
2159     //
2160     // JavaThreadState state = thread_state();
2161     // set_thread_state(_thread_in_vm);
2162     // {
2163     //   ThreadBlockInVM tbivm(this);
2164     //   java_suspend_self()
2165     // }
2166     // set_thread_state(_thread_in_vm_trans);
2167     // if (safepoint) block;
2168     // set_thread_state(state);
2169     //
2170     // but that is pretty messy. Instead we just go with the way the
2171     // code has worked before and note that this is the only path to
2172     // java_suspend_self that doesn't put the thread in _thread_blocked
2173     // mode.
2174 
2175     frame_anchor()-&gt;make_walkable(this);
2176     java_suspend_self();
2177 
2178     // We might be here for reasons in addition to the self-suspend request
2179     // so check for other async requests.
2180   }
2181 
2182   if (check_asyncs) {
2183     check_and_handle_async_exceptions();
2184   }
2185 }
2186 
2187 void JavaThread::send_thread_stop(oop java_throwable)  {
2188   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2189   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2190   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2191 
2192   // Do not throw asynchronous exceptions against the compiler thread
2193   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2194   if (!can_call_java()) return;
2195 
2196   {
2197     // Actually throw the Throwable against the target Thread - however
2198     // only if there is no thread death exception installed already.
2199     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2200       // If the topmost frame is a runtime stub, then we are calling into
2201       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2202       // must deoptimize the caller before continuing, as the compiled  exception handler table
2203       // may not be valid
2204       if (has_last_Java_frame()) {
2205         frame f = last_frame();
2206         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2207           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2208           RegisterMap reg_map(this, UseBiasedLocking);
2209           frame compiled_frame = f.sender(&amp;reg_map);
2210           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2211             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2212           }
2213         }
2214       }
2215 
2216       // Set async. pending exception in thread.
2217       set_pending_async_exception(java_throwable);
2218 
2219       if (log_is_enabled(Info, exceptions)) {
2220          ResourceMark rm;
2221         log_info(exceptions)("Pending Async. exception installed of type: %s",
2222                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2223       }
2224       // for AbortVMOnException flag
2225       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2226     }
2227   }
2228 
2229 
2230   // Interrupt thread so it will wake up from a potential wait()
2231   Thread::interrupt(this);
2232 }
2233 
2234 // External suspension mechanism.
2235 //
2236 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2237 // to any VM_locks and it is at a transition
2238 // Self-suspension will happen on the transition out of the vm.
2239 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2240 //
2241 // Guarantees on return:
2242 //   + Target thread will not execute any new bytecode (that's why we need to
2243 //     force a safepoint)
2244 //   + Target thread will not enter any new monitors
2245 //
2246 void JavaThread::java_suspend() {
2247   { MutexLocker mu(Threads_lock);
2248     if (!Threads::includes(this) || is_exiting() || this-&gt;threadObj() == NULL) {
2249       return;
2250     }
2251   }
2252 
2253   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2254     if (!is_external_suspend()) {
2255       // a racing resume has cancelled us; bail out now
2256       return;
2257     }
2258 
2259     // suspend is done
2260     uint32_t debug_bits = 0;
2261     // Warning: is_ext_suspend_completed() may temporarily drop the
2262     // SR_lock to allow the thread to reach a stable thread state if
2263     // it is currently in a transient thread state.
2264     if (is_ext_suspend_completed(false /* !called_by_wait */,
2265                                  SuspendRetryDelay, &amp;debug_bits)) {
2266       return;
2267     }
2268   }
2269 
2270   VM_ForceSafepoint vm_suspend;
2271   VMThread::execute(&amp;vm_suspend);
2272 }
2273 
2274 // Part II of external suspension.
2275 // A JavaThread self suspends when it detects a pending external suspend
2276 // request. This is usually on transitions. It is also done in places
2277 // where continuing to the next transition would surprise the caller,
2278 // e.g., monitor entry.
2279 //
2280 // Returns the number of times that the thread self-suspended.
2281 //
2282 // Note: DO NOT call java_suspend_self() when you just want to block current
2283 //       thread. java_suspend_self() is the second stage of cooperative
2284 //       suspension for external suspend requests and should only be used
2285 //       to complete an external suspend request.
2286 //
2287 int JavaThread::java_suspend_self() {
2288   int ret = 0;
2289 
2290   // we are in the process of exiting so don't suspend
2291   if (is_exiting()) {
2292     clear_external_suspend();
2293     return ret;
2294   }
2295 
2296   assert(_anchor.walkable() ||
2297          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2298          "must have walkable stack");
2299 
2300   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2301 
2302   assert(!this-&gt;is_ext_suspended(),
2303          "a thread trying to self-suspend should not already be suspended");
2304 
2305   if (this-&gt;is_suspend_equivalent()) {
2306     // If we are self-suspending as a result of the lifting of a
2307     // suspend equivalent condition, then the suspend_equivalent
2308     // flag is not cleared until we set the ext_suspended flag so
2309     // that wait_for_ext_suspend_completion() returns consistent
2310     // results.
2311     this-&gt;clear_suspend_equivalent();
2312   }
2313 
2314   // A racing resume may have cancelled us before we grabbed SR_lock
2315   // above. Or another external suspend request could be waiting for us
2316   // by the time we return from SR_lock()-&gt;wait(). The thread
2317   // that requested the suspension may already be trying to walk our
2318   // stack and if we return now, we can change the stack out from under
2319   // it. This would be a "bad thing (TM)" and cause the stack walker
2320   // to crash. We stay self-suspended until there are no more pending
2321   // external suspend requests.
2322   while (is_external_suspend()) {
2323     ret++;
2324     this-&gt;set_ext_suspended();
2325 
2326     // _ext_suspended flag is cleared by java_resume()
2327     while (is_ext_suspended()) {
2328       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2329     }
2330   }
2331 
2332   return ret;
2333 }
2334 
2335 #ifdef ASSERT
2336 // verify the JavaThread has not yet been published in the Threads::list, and
2337 // hence doesn't need protection from concurrent access at this stage
2338 void JavaThread::verify_not_published() {
2339   if (!Threads_lock-&gt;owned_by_self()) {
2340     MutexLockerEx ml(Threads_lock,  Mutex::_no_safepoint_check_flag);
2341     assert(!Threads::includes(this),
2342            "java thread shouldn't have been published yet!");
2343   } else {
2344     assert(!Threads::includes(this),
2345            "java thread shouldn't have been published yet!");
2346   }
2347 }
2348 #endif
2349 
2350 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2351 // progress or when _suspend_flags is non-zero.
2352 // Current thread needs to self-suspend if there is a suspend request and/or
2353 // block if a safepoint is in progress.
2354 // Async exception ISN'T checked.
2355 // Note only the ThreadInVMfromNative transition can call this function
2356 // directly and when thread state is _thread_in_native_trans
2357 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2358   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2359 
2360   JavaThread *curJT = JavaThread::current();
2361   bool do_self_suspend = thread-&gt;is_external_suspend();
2362 
2363   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2364 
2365   // If JNIEnv proxies are allowed, don't self-suspend if the target
2366   // thread is not the current thread. In older versions of jdbx, jdbx
2367   // threads could call into the VM with another thread's JNIEnv so we
2368   // can be here operating on behalf of a suspended thread (4432884).
2369   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2370     JavaThreadState state = thread-&gt;thread_state();
2371 
2372     // We mark this thread_blocked state as a suspend-equivalent so
2373     // that a caller to is_ext_suspend_completed() won't be confused.
2374     // The suspend-equivalent state is cleared by java_suspend_self().
2375     thread-&gt;set_suspend_equivalent();
2376 
2377     // If the safepoint code sees the _thread_in_native_trans state, it will
2378     // wait until the thread changes to other thread state. There is no
2379     // guarantee on how soon we can obtain the SR_lock and complete the
2380     // self-suspend request. It would be a bad idea to let safepoint wait for
2381     // too long. Temporarily change the state to _thread_blocked to
2382     // let the VM thread know that this thread is ready for GC. The problem
2383     // of changing thread state is that safepoint could happen just after
2384     // java_suspend_self() returns after being resumed, and VM thread will
2385     // see the _thread_blocked state. We must check for safepoint
2386     // after restoring the state and make sure we won't leave while a safepoint
2387     // is in progress.
2388     thread-&gt;set_thread_state(_thread_blocked);
2389     thread-&gt;java_suspend_self();
2390     thread-&gt;set_thread_state(state);
2391     // Make sure new state is seen by VM thread
2392     if (os::is_MP()) {
2393       if (UseMembar) {
2394         // Force a fence between the write above and read below
2395         OrderAccess::fence();
2396       } else {
2397         // Must use this rather than serialization page in particular on Windows
2398         InterfaceSupport::serialize_memory(thread);
2399       }
2400     }
2401   }
2402 
2403   if (SafepointSynchronize::do_call_back()) {
2404     // If we are safepointing, then block the caller which may not be
2405     // the same as the target thread (see above).
2406     SafepointSynchronize::block(curJT);
2407   }
2408 
2409   if (thread-&gt;is_deopt_suspend()) {
2410     thread-&gt;clear_deopt_suspend();
2411     RegisterMap map(thread, false);
2412     frame f = thread-&gt;last_frame();
2413     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2414       f = f.sender(&amp;map);
2415     }
2416     if (f.id() == thread-&gt;must_deopt_id()) {
2417       thread-&gt;clear_must_deopt_id();
2418       f.deoptimize(thread);
2419     } else {
2420       fatal("missed deoptimization!");
2421     }
2422   }
2423 }
2424 
2425 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2426 // progress or when _suspend_flags is non-zero.
2427 // Current thread needs to self-suspend if there is a suspend request and/or
2428 // block if a safepoint is in progress.
2429 // Also check for pending async exception (not including unsafe access error).
2430 // Note only the native==&gt;VM/Java barriers can call this function and when
2431 // thread state is _thread_in_native_trans.
2432 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2433   check_safepoint_and_suspend_for_native_trans(thread);
2434 
2435   if (thread-&gt;has_async_exception()) {
2436     // We are in _thread_in_native_trans state, don't handle unsafe
2437     // access error since that may block.
2438     thread-&gt;check_and_handle_async_exceptions(false);
2439   }
2440 }
2441 
2442 // This is a variant of the normal
2443 // check_special_condition_for_native_trans with slightly different
2444 // semantics for use by critical native wrappers.  It does all the
2445 // normal checks but also performs the transition back into
2446 // thread_in_Java state.  This is required so that critical natives
2447 // can potentially block and perform a GC if they are the last thread
2448 // exiting the GCLocker.
2449 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2450   check_special_condition_for_native_trans(thread);
2451 
2452   // Finish the transition
2453   thread-&gt;set_thread_state(_thread_in_Java);
2454 
2455   if (thread-&gt;do_critical_native_unlock()) {
2456     ThreadInVMfromJavaNoAsyncException tiv(thread);
2457     GCLocker::unlock_critical(thread);
2458     thread-&gt;clear_critical_native_unlock();
2459   }
2460 }
2461 
2462 // We need to guarantee the Threads_lock here, since resumes are not
2463 // allowed during safepoint synchronization
2464 // Can only resume from an external suspension
2465 void JavaThread::java_resume() {
2466   assert_locked_or_safepoint(Threads_lock);
2467 
2468   // Sanity check: thread is gone, has started exiting or the thread
2469   // was not externally suspended.
2470   if (!Threads::includes(this) || is_exiting() || !is_external_suspend()) {
2471     return;
2472   }
2473 
2474   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2475 
2476   clear_external_suspend();
2477 
2478   if (is_ext_suspended()) {
2479     clear_ext_suspended();
2480     SR_lock()-&gt;notify_all();
2481   }
2482 }
2483 
2484 size_t JavaThread::_stack_red_zone_size = 0;
2485 size_t JavaThread::_stack_yellow_zone_size = 0;
2486 size_t JavaThread::_stack_reserved_zone_size = 0;
2487 size_t JavaThread::_stack_shadow_zone_size = 0;
2488 
2489 void JavaThread::create_stack_guard_pages() {
2490   if (!os::uses_stack_guard_pages() || _stack_guard_state != stack_guard_unused) { return; }
2491   address low_addr = stack_end();
2492   size_t len = stack_guard_zone_size();
2493 
2494   int allocate = os::allocate_stack_guard_pages();
2495   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2496 
2497   if (allocate &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2498     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2499     return;
2500   }
2501 
2502   if (os::guard_memory((char *) low_addr, len)) {
2503     _stack_guard_state = stack_guard_enabled;
2504   } else {
2505     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2506       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2507     if (os::uncommit_memory((char *) low_addr, len)) {
2508       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2509     }
2510     return;
2511   }
2512 
2513   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2514     PTR_FORMAT "-" PTR_FORMAT ".",
2515     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2516 
2517 }
2518 
2519 void JavaThread::remove_stack_guard_pages() {
2520   assert(Thread::current() == this, "from different thread");
2521   if (_stack_guard_state == stack_guard_unused) return;
2522   address low_addr = stack_end();
2523   size_t len = stack_guard_zone_size();
2524 
2525   if (os::allocate_stack_guard_pages()) {
2526     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2527       _stack_guard_state = stack_guard_unused;
2528     } else {
2529       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2530         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2531       return;
2532     }
2533   } else {
2534     if (_stack_guard_state == stack_guard_unused) return;
2535     if (os::unguard_memory((char *) low_addr, len)) {
2536       _stack_guard_state = stack_guard_unused;
2537     } else {
2538       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2539         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2540       return;
2541     }
2542   }
2543 
2544   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2545     PTR_FORMAT "-" PTR_FORMAT ".",
2546     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2547 
2548 }
2549 
2550 void JavaThread::enable_stack_reserved_zone() {
2551   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2552   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2553 
2554   // The base notation is from the stack's point of view, growing downward.
2555   // We need to adjust it to work correctly with guard_memory()
2556   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2557 
2558   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2559   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2560 
2561   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2562     _stack_guard_state = stack_guard_enabled;
2563   } else {
2564     warning("Attempt to guard stack reserved zone failed.");
2565   }
2566   enable_register_stack_guard();
2567 }
2568 
2569 void JavaThread::disable_stack_reserved_zone() {
2570   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2571   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2572 
2573   // Simply return if called for a thread that does not use guard pages.
2574   if (_stack_guard_state == stack_guard_unused) return;
2575 
2576   // The base notation is from the stack's point of view, growing downward.
2577   // We need to adjust it to work correctly with guard_memory()
2578   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2579 
2580   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2581     _stack_guard_state = stack_guard_reserved_disabled;
2582   } else {
2583     warning("Attempt to unguard stack reserved zone failed.");
2584   }
2585   disable_register_stack_guard();
2586 }
2587 
2588 void JavaThread::enable_stack_yellow_reserved_zone() {
2589   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2590   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2591 
2592   // The base notation is from the stacks point of view, growing downward.
2593   // We need to adjust it to work correctly with guard_memory()
2594   address base = stack_red_zone_base();
2595 
2596   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2597   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2598 
2599   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2600     _stack_guard_state = stack_guard_enabled;
2601   } else {
2602     warning("Attempt to guard stack yellow zone failed.");
2603   }
2604   enable_register_stack_guard();
2605 }
2606 
2607 void JavaThread::disable_stack_yellow_reserved_zone() {
2608   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2609   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2610 
2611   // Simply return if called for a thread that does not use guard pages.
2612   if (_stack_guard_state == stack_guard_unused) return;
2613 
2614   // The base notation is from the stacks point of view, growing downward.
2615   // We need to adjust it to work correctly with guard_memory()
2616   address base = stack_red_zone_base();
2617 
2618   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2619     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2620   } else {
2621     warning("Attempt to unguard stack yellow zone failed.");
2622   }
2623   disable_register_stack_guard();
2624 }
2625 
2626 void JavaThread::enable_stack_red_zone() {
2627   // The base notation is from the stacks point of view, growing downward.
2628   // We need to adjust it to work correctly with guard_memory()
2629   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2630   address base = stack_red_zone_base() - stack_red_zone_size();
2631 
2632   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2633   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2634 
2635   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2636     warning("Attempt to guard stack red zone failed.");
2637   }
2638 }
2639 
2640 void JavaThread::disable_stack_red_zone() {
2641   // The base notation is from the stacks point of view, growing downward.
2642   // We need to adjust it to work correctly with guard_memory()
2643   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2644   address base = stack_red_zone_base() - stack_red_zone_size();
2645   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2646     warning("Attempt to unguard stack red zone failed.");
2647   }
2648 }
2649 
2650 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2651   // ignore is there is no stack
2652   if (!has_last_Java_frame()) return;
2653   // traverse the stack frames. Starts from top frame.
2654   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2655     frame* fr = fst.current();
2656     f(fr, fst.register_map());
2657   }
2658 }
2659 
2660 
2661 #ifndef PRODUCT
2662 // Deoptimization
2663 // Function for testing deoptimization
2664 void JavaThread::deoptimize() {
2665   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2666   StackFrameStream fst(this, UseBiasedLocking);
2667   bool deopt = false;           // Dump stack only if a deopt actually happens.
2668   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2669   // Iterate over all frames in the thread and deoptimize
2670   for (; !fst.is_done(); fst.next()) {
2671     if (fst.current()-&gt;can_be_deoptimized()) {
2672 
2673       if (only_at) {
2674         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2675         // consists of comma or carriage return separated numbers so
2676         // search for the current bci in that string.
2677         address pc = fst.current()-&gt;pc();
2678         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2679         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2680         char buffer[8];
2681         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2682         size_t len = strlen(buffer);
2683         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2684         while (found != NULL) {
2685           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2686               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2687             // Check that the bci found is bracketed by terminators.
2688             break;
2689           }
2690           found = strstr(found + 1, buffer);
2691         }
2692         if (!found) {
2693           continue;
2694         }
2695       }
2696 
2697       if (DebugDeoptimization &amp;&amp; !deopt) {
2698         deopt = true; // One-time only print before deopt
2699         tty-&gt;print_cr("[BEFORE Deoptimization]");
2700         trace_frames();
2701         trace_stack();
2702       }
2703       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2704     }
2705   }
2706 
2707   if (DebugDeoptimization &amp;&amp; deopt) {
2708     tty-&gt;print_cr("[AFTER Deoptimization]");
2709     trace_frames();
2710   }
2711 }
2712 
2713 
2714 // Make zombies
2715 void JavaThread::make_zombies() {
2716   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2717     if (fst.current()-&gt;can_be_deoptimized()) {
2718       // it is a Java nmethod
2719       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2720       nm-&gt;make_not_entrant();
2721     }
2722   }
2723 }
2724 #endif // PRODUCT
2725 
2726 
2727 void JavaThread::deoptimized_wrt_marked_nmethods() {
2728   if (!has_last_Java_frame()) return;
2729   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2730   StackFrameStream fst(this, UseBiasedLocking);
2731   for (; !fst.is_done(); fst.next()) {
2732     if (fst.current()-&gt;should_be_deoptimized()) {
2733       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2734     }
2735   }
2736 }
2737 
2738 
2739 // If the caller is a NamedThread, then remember, in the current scope,
2740 // the given JavaThread in its _processed_thread field.
2741 class RememberProcessedThread: public StackObj {
2742   NamedThread* _cur_thr;
2743  public:
2744   RememberProcessedThread(JavaThread* jthr) {
2745     Thread* thread = Thread::current();
2746     if (thread-&gt;is_Named_thread()) {
2747       _cur_thr = (NamedThread *)thread;
2748       _cur_thr-&gt;set_processed_thread(jthr);
2749     } else {
2750       _cur_thr = NULL;
2751     }
2752   }
2753 
2754   ~RememberProcessedThread() {
2755     if (_cur_thr) {
2756       _cur_thr-&gt;set_processed_thread(NULL);
2757     }
2758   }
2759 };
2760 
2761 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2762   // Verify that the deferred card marks have been flushed.
2763   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2764 
2765   // The ThreadProfiler oops_do is done from FlatProfiler::oops_do
2766   // since there may be more than one thread using each ThreadProfiler.
2767 
2768   // Traverse the GCHandles
2769   Thread::oops_do(f, cf);
2770 
2771   JVMCI_ONLY(f-&gt;do_oop((oop*)&amp;_pending_failed_speculation);)
2772 
2773   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2774          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2775 
2776   if (has_last_Java_frame()) {
2777     // Record JavaThread to GC thread
2778     RememberProcessedThread rpt(this);
2779 
2780     // Traverse the privileged stack
2781     if (_privileged_stack_top != NULL) {
2782       _privileged_stack_top-&gt;oops_do(f);
2783     }
2784 
2785     // traverse the registered growable array
2786     if (_array_for_gc != NULL) {
2787       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2788         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2789       }
2790     }
2791 
2792     // Traverse the monitor chunks
2793     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2794       chunk-&gt;oops_do(f);
2795     }
2796 
2797     // Traverse the execution stack
2798     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2799       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2800     }
2801   }
2802 
2803   // callee_target is never live across a gc point so NULL it here should
2804   // it still contain a methdOop.
2805 
2806   set_callee_target(NULL);
2807 
2808   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2809   // If we have deferred set_locals there might be oops waiting to be
2810   // written
2811   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2812   if (list != NULL) {
2813     for (int i = 0; i &lt; list-&gt;length(); i++) {
2814       list-&gt;at(i)-&gt;oops_do(f);
2815     }
2816   }
2817 
2818   // Traverse instance variables at the end since the GC may be moving things
2819   // around using this function
2820   f-&gt;do_oop((oop*) &amp;_threadObj);
2821   f-&gt;do_oop((oop*) &amp;_vm_result);
2822   f-&gt;do_oop((oop*) &amp;_exception_oop);
2823   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2824 
2825   if (jvmti_thread_state() != NULL) {
2826     jvmti_thread_state()-&gt;oops_do(f);
2827   }
2828 }
2829 
2830 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2831   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2832          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2833 
2834   if (has_last_Java_frame()) {
2835     // Traverse the execution stack
2836     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2837       fst.current()-&gt;nmethods_do(cf);
2838     }
2839   }
2840 }
2841 
2842 void JavaThread::metadata_do(void f(Metadata*)) {
2843   if (has_last_Java_frame()) {
2844     // Traverse the execution stack to call f() on the methods in the stack
2845     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2846       fst.current()-&gt;metadata_do(f);
2847     }
2848   } else if (is_Compiler_thread()) {
2849     // need to walk ciMetadata in current compile tasks to keep alive.
2850     CompilerThread* ct = (CompilerThread*)this;
2851     if (ct-&gt;env() != NULL) {
2852       ct-&gt;env()-&gt;metadata_do(f);
2853     }
2854     if (ct-&gt;task() != NULL) {
2855       ct-&gt;task()-&gt;metadata_do(f);
2856     }
2857   }
2858 }
2859 
2860 // Printing
2861 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2862   switch (_thread_state) {
2863   case _thread_uninitialized:     return "_thread_uninitialized";
2864   case _thread_new:               return "_thread_new";
2865   case _thread_new_trans:         return "_thread_new_trans";
2866   case _thread_in_native:         return "_thread_in_native";
2867   case _thread_in_native_trans:   return "_thread_in_native_trans";
2868   case _thread_in_vm:             return "_thread_in_vm";
2869   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2870   case _thread_in_Java:           return "_thread_in_Java";
2871   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2872   case _thread_blocked:           return "_thread_blocked";
2873   case _thread_blocked_trans:     return "_thread_blocked_trans";
2874   default:                        return "unknown thread state";
2875   }
2876 }
2877 
2878 #ifndef PRODUCT
2879 void JavaThread::print_thread_state_on(outputStream *st) const {
2880   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2881 };
2882 void JavaThread::print_thread_state() const {
2883   print_thread_state_on(tty);
2884 }
2885 #endif // PRODUCT
2886 
2887 // Called by Threads::print() for VM_PrintThreads operation
2888 void JavaThread::print_on(outputStream *st) const {
2889   st-&gt;print_raw("\"");
2890   st-&gt;print_raw(get_thread_name());
2891   st-&gt;print_raw("\" ");
2892   oop thread_oop = threadObj();
2893   if (thread_oop != NULL) {
2894     st-&gt;print("#" INT64_FORMAT " ", java_lang_Thread::thread_id(thread_oop));
2895     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2896     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2897   }
2898   Thread::print_on(st);
2899   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2900   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2901   if (thread_oop != NULL) {
2902     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2903   }
2904 #ifndef PRODUCT
2905   print_thread_state_on(st);
2906   _safepoint_state-&gt;print_on(st);
2907 #endif // PRODUCT
2908   if (is_Compiler_thread()) {
2909     CompilerThread* ct = (CompilerThread*)this;
2910     if (ct-&gt;task() != NULL) {
2911       st-&gt;print("   Compiling: ");
2912       ct-&gt;task()-&gt;print(st, NULL, true, false);
2913     } else {
2914       st-&gt;print("   No compile task");
2915     }
2916     st-&gt;cr();
2917   }
2918 }
2919 
2920 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2921   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2922 }
2923 
2924 // Called by fatal error handler. The difference between this and
2925 // JavaThread::print() is that we can't grab lock or allocate memory.
2926 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2927   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2928   oop thread_obj = threadObj();
2929   if (thread_obj != NULL) {
2930     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2931   }
2932   st-&gt;print(" [");
2933   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2934   if (osthread()) {
2935     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2936   }
2937   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2938             p2i(stack_end()), p2i(stack_base()));
2939   st-&gt;print("]");
2940   return;
2941 }
2942 
2943 // Verification
2944 
2945 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2946 
2947 void JavaThread::verify() {
2948   // Verify oops in the thread.
2949   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2950 
2951   // Verify the stack frames.
2952   frames_do(frame_verify);
2953 }
2954 
2955 // CR 6300358 (sub-CR 2137150)
2956 // Most callers of this method assume that it can't return NULL but a
2957 // thread may not have a name whilst it is in the process of attaching to
2958 // the VM - see CR 6412693, and there are places where a JavaThread can be
2959 // seen prior to having it's threadObj set (eg JNI attaching threads and
2960 // if vm exit occurs during initialization). These cases can all be accounted
2961 // for such that this method never returns NULL.
2962 const char* JavaThread::get_thread_name() const {
2963 #ifdef ASSERT
2964   // early safepoints can hit while current thread does not yet have TLS
2965   if (!SafepointSynchronize::is_at_safepoint()) {
2966     Thread *cur = Thread::current();
2967     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
2968       // Current JavaThreads are allowed to get their own name without
2969       // the Threads_lock.
2970       assert_locked_or_safepoint(Threads_lock);
2971     }
2972   }
2973 #endif // ASSERT
2974   return get_thread_name_string();
2975 }
2976 
2977 // Returns a non-NULL representation of this thread's name, or a suitable
2978 // descriptive string if there is no set name
2979 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
2980   const char* name_str;
2981   oop thread_obj = threadObj();
2982   if (thread_obj != NULL) {
2983     oop name = java_lang_Thread::name(thread_obj);
2984     if (name != NULL) {
2985       if (buf == NULL) {
2986         name_str = java_lang_String::as_utf8_string(name);
2987       } else {
2988         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
2989       }
2990     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
2991       name_str = "&lt;no-name - thread is attaching&gt;";
2992     } else {
2993       name_str = Thread::name();
2994     }
2995   } else {
2996     name_str = Thread::name();
2997   }
2998   assert(name_str != NULL, "unexpected NULL thread name");
2999   return name_str;
3000 }
3001 
3002 
3003 const char* JavaThread::get_threadgroup_name() const {
3004   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3005   oop thread_obj = threadObj();
3006   if (thread_obj != NULL) {
3007     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3008     if (thread_group != NULL) {
3009       // ThreadGroup.name can be null
3010       return java_lang_ThreadGroup::name(thread_group);
3011     }
3012   }
3013   return NULL;
3014 }
3015 
3016 const char* JavaThread::get_parent_name() const {
3017   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3018   oop thread_obj = threadObj();
3019   if (thread_obj != NULL) {
3020     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3021     if (thread_group != NULL) {
3022       oop parent = java_lang_ThreadGroup::parent(thread_group);
3023       if (parent != NULL) {
3024         // ThreadGroup.name can be null
3025         return java_lang_ThreadGroup::name(parent);
3026       }
3027     }
3028   }
3029   return NULL;
3030 }
3031 
3032 ThreadPriority JavaThread::java_priority() const {
3033   oop thr_oop = threadObj();
3034   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3035   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3036   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3037   return priority;
3038 }
3039 
3040 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3041 
3042   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3043   // Link Java Thread object &lt;-&gt; C++ Thread
3044 
3045   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3046   // and put it into a new Handle.  The Handle "thread_oop" can then
3047   // be used to pass the C++ thread object to other methods.
3048 
3049   // Set the Java level thread object (jthread) field of the
3050   // new thread (a JavaThread *) to C++ thread object using the
3051   // "thread_oop" handle.
3052 
3053   // Set the thread field (a JavaThread *) of the
3054   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3055 
3056   Handle thread_oop(Thread::current(),
3057                     JNIHandles::resolve_non_null(jni_thread));
3058   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3059          "must be initialized");
3060   set_threadObj(thread_oop());
3061   java_lang_Thread::set_thread(thread_oop(), this);
3062 
3063   if (prio == NoPriority) {
3064     prio = java_lang_Thread::priority(thread_oop());
3065     assert(prio != NoPriority, "A valid priority should be present");
3066   }
3067 
3068   // Push the Java priority down to the native thread; needs Threads_lock
3069   Thread::set_priority(this, prio);
3070 
3071   prepare_ext();
3072 
3073   // Add the new thread to the Threads list and set it in motion.
3074   // We must have threads lock in order to call Threads::add.
3075   // It is crucial that we do not block before the thread is
3076   // added to the Threads list for if a GC happens, then the java_thread oop
3077   // will not be visited by GC.
3078   Threads::add(this);
3079 }
3080 
3081 oop JavaThread::current_park_blocker() {
3082   // Support for JSR-166 locks
3083   oop thread_oop = threadObj();
3084   if (thread_oop != NULL &amp;&amp;
3085       JDK_Version::current().supports_thread_park_blocker()) {
3086     return java_lang_Thread::park_blocker(thread_oop);
3087   }
3088   return NULL;
3089 }
3090 
3091 
3092 void JavaThread::print_stack_on(outputStream* st) {
3093   if (!has_last_Java_frame()) return;
3094   ResourceMark rm;
3095   HandleMark   hm;
3096 
3097   RegisterMap reg_map(this);
3098   vframe* start_vf = last_java_vframe(&amp;reg_map);
3099   int count = 0;
3100   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3101     if (f-&gt;is_java_frame()) {
3102       javaVFrame* jvf = javaVFrame::cast(f);
3103       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3104 
3105       // Print out lock information
3106       if (JavaMonitorsInStackTrace) {
3107         jvf-&gt;print_lock_info_on(st, count);
3108       }
3109     } else {
3110       // Ignore non-Java frames
3111     }
3112 
3113     // Bail-out case for too deep stacks
3114     count++;
3115     if (MaxJavaStackTraceDepth == count) return;
3116   }
3117 }
3118 
3119 
3120 // JVMTI PopFrame support
3121 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3122   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3123   if (in_bytes(size_in_bytes) != 0) {
3124     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3125     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3126     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3127   }
3128 }
3129 
3130 void* JavaThread::popframe_preserved_args() {
3131   return _popframe_preserved_args;
3132 }
3133 
3134 ByteSize JavaThread::popframe_preserved_args_size() {
3135   return in_ByteSize(_popframe_preserved_args_size);
3136 }
3137 
3138 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3139   int sz = in_bytes(popframe_preserved_args_size());
3140   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3141   return in_WordSize(sz / wordSize);
3142 }
3143 
3144 void JavaThread::popframe_free_preserved_args() {
3145   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3146   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3147   _popframe_preserved_args = NULL;
3148   _popframe_preserved_args_size = 0;
3149 }
3150 
3151 #ifndef PRODUCT
3152 
3153 void JavaThread::trace_frames() {
3154   tty-&gt;print_cr("[Describe stack]");
3155   int frame_no = 1;
3156   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3157     tty-&gt;print("  %d. ", frame_no++);
3158     fst.current()-&gt;print_value_on(tty, this);
3159     tty-&gt;cr();
3160   }
3161 }
3162 
3163 class PrintAndVerifyOopClosure: public OopClosure {
3164  protected:
3165   template &lt;class T&gt; inline void do_oop_work(T* p) {
3166     oop obj = oopDesc::load_decode_heap_oop(p);
3167     if (obj == NULL) return;
3168     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3169     if (obj-&gt;is_oop_or_null()) {
3170       if (obj-&gt;is_objArray()) {
3171         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3172       } else {
3173         obj-&gt;print();
3174       }
3175     } else {
3176       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3177     }
3178     tty-&gt;cr();
3179   }
3180  public:
3181   virtual void do_oop(oop* p) { do_oop_work(p); }
3182   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3183 };
3184 
3185 
3186 static void oops_print(frame* f, const RegisterMap *map) {
3187   PrintAndVerifyOopClosure print;
3188   f-&gt;print_value();
3189   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3190 }
3191 
3192 // Print our all the locations that contain oops and whether they are
3193 // valid or not.  This useful when trying to find the oldest frame
3194 // where an oop has gone bad since the frame walk is from youngest to
3195 // oldest.
3196 void JavaThread::trace_oops() {
3197   tty-&gt;print_cr("[Trace oops]");
3198   frames_do(oops_print);
3199 }
3200 
3201 
3202 #ifdef ASSERT
3203 // Print or validate the layout of stack frames
3204 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3205   ResourceMark rm;
3206   PRESERVE_EXCEPTION_MARK;
3207   FrameValues values;
3208   int frame_no = 0;
3209   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3210     fst.current()-&gt;describe(values, ++frame_no);
3211     if (depth == frame_no) break;
3212   }
3213   if (validate_only) {
3214     values.validate();
3215   } else {
3216     tty-&gt;print_cr("[Describe stack layout]");
3217     values.print(this);
3218   }
3219 }
3220 #endif
3221 
3222 void JavaThread::trace_stack_from(vframe* start_vf) {
3223   ResourceMark rm;
3224   int vframe_no = 1;
3225   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3226     if (f-&gt;is_java_frame()) {
3227       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3228     } else {
3229       f-&gt;print();
3230     }
3231     if (vframe_no &gt; StackPrintLimit) {
3232       tty-&gt;print_cr("...&lt;more frames&gt;...");
3233       return;
3234     }
3235   }
3236 }
3237 
3238 
3239 void JavaThread::trace_stack() {
3240   if (!has_last_Java_frame()) return;
3241   ResourceMark rm;
3242   HandleMark   hm;
3243   RegisterMap reg_map(this);
3244   trace_stack_from(last_java_vframe(&amp;reg_map));
3245 }
3246 
3247 
3248 #endif // PRODUCT
3249 
3250 
3251 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3252   assert(reg_map != NULL, "a map must be given");
3253   frame f = last_frame();
3254   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3255     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3256   }
3257   return NULL;
3258 }
3259 
3260 
3261 Klass* JavaThread::security_get_caller_class(int depth) {
3262   vframeStream vfst(this);
3263   vfst.security_get_caller_frame(depth);
3264   if (!vfst.at_end()) {
3265     return vfst.method()-&gt;method_holder();
3266   }
3267   return NULL;
3268 }
3269 
3270 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3271   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3272   CompileBroker::compiler_thread_loop();
3273 }
3274 
3275 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3276   NMethodSweeper::sweeper_loop();
3277 }
3278 
3279 // Create a CompilerThread
3280 CompilerThread::CompilerThread(CompileQueue* queue,
3281                                CompilerCounters* counters)
3282                                : JavaThread(&amp;compiler_thread_entry) {
3283   _env   = NULL;
3284   _log   = NULL;
3285   _task  = NULL;
3286   _queue = queue;
3287   _counters = counters;
3288   _buffer_blob = NULL;
3289   _compiler = NULL;
3290 
3291 #ifndef PRODUCT
3292   _ideal_graph_printer = NULL;
3293 #endif
3294 }
3295 
3296 bool CompilerThread::can_call_java() const {
3297   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3298 }
3299 
3300 // Create sweeper thread
3301 CodeCacheSweeperThread::CodeCacheSweeperThread()
3302 : JavaThread(&amp;sweeper_thread_entry) {
3303   _scanned_compiled_method = NULL;
3304 }
3305 
3306 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3307   JavaThread::oops_do(f, cf);
3308   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3309     // Safepoints can occur when the sweeper is scanning an nmethod so
3310     // process it here to make sure it isn't unloaded in the middle of
3311     // a scan.
3312     cf-&gt;do_code_blob(_scanned_compiled_method);
3313   }
3314 }
3315 
3316 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3317   JavaThread::nmethods_do(cf);
3318   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3319     // Safepoints can occur when the sweeper is scanning an nmethod so
3320     // process it here to make sure it isn't unloaded in the middle of
3321     // a scan.
3322     cf-&gt;do_code_blob(_scanned_compiled_method);
3323   }
3324 }
3325 
3326 
3327 // ======= Threads ========
3328 
3329 // The Threads class links together all active threads, and provides
3330 // operations over all threads.  It is protected by its own Mutex
3331 // lock, which is also used in other contexts to protect thread
3332 // operations from having the thread being operated on from exiting
3333 // and going away unexpectedly (e.g., safepoint synchronization)
3334 
3335 JavaThread* Threads::_thread_list = NULL;
3336 int         Threads::_number_of_threads = 0;
3337 int         Threads::_number_of_non_daemon_threads = 0;
3338 int         Threads::_return_code = 0;
3339 int         Threads::_thread_claim_parity = 0;
3340 size_t      JavaThread::_stack_size_at_create = 0;
3341 #ifdef ASSERT
3342 bool        Threads::_vm_complete = false;
3343 #endif
3344 
3345 // All JavaThreads
3346 #define ALL_JAVA_THREADS(X) for (JavaThread* X = _thread_list; X; X = X-&gt;next())
3347 
3348 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system)
3349 void Threads::threads_do(ThreadClosure* tc) {
3350   assert_locked_or_safepoint(Threads_lock);
3351   // ALL_JAVA_THREADS iterates through all JavaThreads
3352   ALL_JAVA_THREADS(p) {
3353     tc-&gt;do_thread(p);
3354   }
3355   // Someday we could have a table or list of all non-JavaThreads.
3356   // For now, just manually iterate through them.
3357   tc-&gt;do_thread(VMThread::vm_thread());
3358   Universe::heap()-&gt;gc_threads_do(tc);
3359   WatcherThread *wt = WatcherThread::watcher_thread();
3360   // Strictly speaking, the following NULL check isn't sufficient to make sure
3361   // the data for WatcherThread is still valid upon being examined. However,
3362   // considering that WatchThread terminates when the VM is on the way to
3363   // exit at safepoint, the chance of the above is extremely small. The right
3364   // way to prevent termination of WatcherThread would be to acquire
3365   // Terminator_lock, but we can't do that without violating the lock rank
3366   // checking in some cases.
3367   if (wt != NULL) {
3368     tc-&gt;do_thread(wt);
3369   }
3370 
3371   // If CompilerThreads ever become non-JavaThreads, add them here
3372 }
3373 
3374 // The system initialization in the library has three phases.
3375 //
3376 // Phase 1: java.lang.System class initialization
3377 //     java.lang.System is a primordial class loaded and initialized
3378 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3379 //     only does registerNatives and keeps the rest of the class
3380 //     initialization work later until thread initialization completes.
3381 //
3382 //     System.initPhase1 initializes the system properties, the static
3383 //     fields in, out, and err. Set up java signal handlers, OS-specific
3384 //     system settings, and thread group of the main thread.
3385 static void call_initPhase1(TRAPS) {
3386   Klass* k =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3387   instanceKlassHandle klass (THREAD, k);
3388 
3389   JavaValue result(T_VOID);
3390   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3391                                          vmSymbols::void_method_signature(), CHECK);
3392 }
3393 
3394 // Phase 2. Module system initialization
3395 //     This will initialize the module system.  Only java.base classes
3396 //     can be loaded until phase 2 completes.
3397 //
3398 //     Call System.initPhase2 after the compiler initialization and jsr292
3399 //     classes get initialized because module initialization runs a lot of java
3400 //     code, that for performance reasons, should be compiled.  Also, this will
3401 //     enable the startup code to use lambda and other language features in this
3402 //     phase and onward.
3403 //
3404 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3405 static void call_initPhase2(TRAPS) {
3406   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3407   instanceKlassHandle klass (THREAD, k);
3408 
3409   JavaValue result(T_VOID);
3410   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3411                                          vmSymbols::void_method_signature(), CHECK);
3412   universe_post_module_init();
3413 }
3414 
3415 // Phase 3. final setup - set security manager, system class loader and TCCL
3416 //
3417 //     This will instantiate and set the security manager, set the system class
3418 //     loader as well as the thread context class loader.  The security manager
3419 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3420 //     other modules or the application's classpath.
3421 static void call_initPhase3(TRAPS) {
3422   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3423   instanceKlassHandle klass (THREAD, k);
3424 
3425   JavaValue result(T_VOID);
3426   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3427                                          vmSymbols::void_method_signature(), CHECK);
3428 }
3429 
3430 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3431   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3432 
3433   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3434     create_vm_init_libraries();
3435   }
3436 
3437   initialize_class(vmSymbols::java_lang_String(), CHECK);
3438 
3439   // Inject CompactStrings value after the static initializers for String ran.
3440   java_lang_String::set_compact_strings(CompactStrings);
3441 
3442   // Initialize java_lang.System (needed before creating the thread)
3443   initialize_class(vmSymbols::java_lang_System(), CHECK);
3444   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3445   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3446   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3447   Handle thread_group = create_initial_thread_group(CHECK);
3448   Universe::set_main_thread_group(thread_group());
3449   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3450   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3451   main_thread-&gt;set_threadObj(thread_object);
3452   // Set thread status to running since main thread has
3453   // been started and running.
3454   java_lang_Thread::set_thread_status(thread_object,
3455                                       java_lang_Thread::RUNNABLE);
3456 
3457   // The VM creates objects of this class.
3458   initialize_class(vmSymbols::java_lang_reflect_Module(), CHECK);
3459 
3460   // The VM preresolves methods to these classes. Make sure that they get initialized
3461   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3462   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3463 
3464   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3465   call_initPhase1(CHECK);
3466 
3467   // get the Java runtime name after java.lang.System is initialized
3468   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3469   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3470 
3471   // an instance of OutOfMemory exception has been allocated earlier
3472   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3473   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3474   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3475   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3476   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3477   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3478   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3479   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3480 }
3481 
3482 void Threads::initialize_jsr292_core_classes(TRAPS) {
3483   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3484 
3485   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3486   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3487   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3488 }
3489 
3490 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3491   extern void JDK_Version_init();
3492 
3493   // Preinitialize version info.
3494   VM_Version::early_initialize();
3495 
3496   // Check version
3497   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3498 
3499   // Initialize library-based TLS
3500   ThreadLocalStorage::init();
3501 
3502   // Initialize the output stream module
3503   ostream_init();
3504 
3505   // Process java launcher properties.
3506   Arguments::process_sun_java_launcher_properties(args);
3507 
3508   // Initialize the os module
3509   os::init();
3510 
3511   // Record VM creation timing statistics
3512   TraceVmCreationTime create_vm_timer;
3513   create_vm_timer.start();
3514 
3515   // Initialize system properties.
3516   Arguments::init_system_properties();
3517 
3518   // So that JDK version can be used as a discriminator when parsing arguments
3519   JDK_Version_init();
3520 
3521   // Update/Initialize System properties after JDK version number is known
3522   Arguments::init_version_specific_system_properties();
3523 
3524   // Make sure to initialize log configuration *before* parsing arguments
3525   LogConfiguration::initialize(create_vm_timer.begin_time());
3526 
3527   // Parse arguments
3528   jint parse_result = Arguments::parse(args);
3529   if (parse_result != JNI_OK) return parse_result;
3530 
3531   os::init_before_ergo();
3532 
3533   jint ergo_result = Arguments::apply_ergo();
3534   if (ergo_result != JNI_OK) return ergo_result;
3535 
3536   // Final check of all ranges after ergonomics which may change values.
3537   if (!CommandLineFlagRangeList::check_ranges()) {
3538     return JNI_EINVAL;
3539   }
3540 
3541   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3542   bool constraint_result = CommandLineFlagConstraintList::check_constraints(CommandLineFlagConstraint::AfterErgo);
3543   if (!constraint_result) {
3544     return JNI_EINVAL;
3545   }
3546 
3547   if (PauseAtStartup) {
3548     os::pause();
3549   }
3550 
3551   HOTSPOT_VM_INIT_BEGIN();
3552 
3553   // Timing (must come after argument parsing)
3554   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3555 
3556   // Initialize the os module after parsing the args
3557   jint os_init_2_result = os::init_2();
3558   if (os_init_2_result != JNI_OK) return os_init_2_result;
3559 
3560   jint adjust_after_os_result = Arguments::adjust_after_os();
3561   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3562 
3563   // Initialize output stream logging
3564   ostream_init_log();
3565 
3566   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3567   // Must be before create_vm_init_agents()
3568   if (Arguments::init_libraries_at_startup()) {
3569     convert_vm_init_libraries_to_agents();
3570   }
3571 
3572   // Launch -agentlib/-agentpath and converted -Xrun agents
3573   if (Arguments::init_agents_at_startup()) {
3574     create_vm_init_agents();
3575   }
3576 
3577   // Initialize Threads state
3578   _thread_list = NULL;
3579   _number_of_threads = 0;
3580   _number_of_non_daemon_threads = 0;
3581 
3582   // Initialize global data structures and create system classes in heap
3583   vm_init_globals();
3584 
3585 #if INCLUDE_JVMCI
3586   if (JVMCICounterSize &gt; 0) {
3587     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3588     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3589   } else {
3590     JavaThread::_jvmci_old_thread_counters = NULL;
3591   }
3592 #endif // INCLUDE_JVMCI
3593 
3594   // Attach the main thread to this os thread
3595   JavaThread* main_thread = new JavaThread();
3596   main_thread-&gt;set_thread_state(_thread_in_vm);
3597   main_thread-&gt;initialize_thread_current();
3598   // must do this before set_active_handles
3599   main_thread-&gt;record_stack_base_and_size();
3600   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3601 
3602   if (!main_thread-&gt;set_as_starting_thread()) {
3603     vm_shutdown_during_initialization(
3604                                       "Failed necessary internal allocation. Out of swap space");
3605     delete main_thread;
3606     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3607     return JNI_ENOMEM;
3608   }
3609 
3610   // Enable guard page *after* os::create_main_thread(), otherwise it would
3611   // crash Linux VM, see notes in os_linux.cpp.
3612   main_thread-&gt;create_stack_guard_pages();
3613 
3614   // Initialize Java-Level synchronization subsystem
3615   ObjectMonitor::Initialize();
3616 
3617   // Initialize global modules
3618   jint status = init_globals();
3619   if (status != JNI_OK) {
3620     delete main_thread;
3621     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3622     return status;
3623   }
3624 
3625   if (TRACE_INITIALIZE() != JNI_OK) {
3626     vm_exit_during_initialization("Failed to initialize tracing backend");
3627   }
3628 
3629   // Should be done after the heap is fully created
3630   main_thread-&gt;cache_global_variables();
3631 
3632   HandleMark hm;
3633 
3634   { MutexLocker mu(Threads_lock);
3635     Threads::add(main_thread);
3636   }
3637 
3638   // Any JVMTI raw monitors entered in onload will transition into
3639   // real raw monitor. VM is setup enough here for raw monitor enter.
3640   JvmtiExport::transition_pending_onload_raw_monitors();
3641 
3642   // Create the VMThread
3643   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3644 
3645   VMThread::create();
3646     Thread* vmthread = VMThread::vm_thread();
3647 
3648     if (!os::create_thread(vmthread, os::vm_thread)) {
3649       vm_exit_during_initialization("Cannot create VM thread. "
3650                                     "Out of system resources.");
3651     }
3652 
3653     // Wait for the VM thread to become ready, and VMThread::run to initialize
3654     // Monitors can have spurious returns, must always check another state flag
3655     {
3656       MutexLocker ml(Notify_lock);
3657       os::start_thread(vmthread);
3658       while (vmthread-&gt;active_handles() == NULL) {
3659         Notify_lock-&gt;wait();
3660       }
3661     }
3662   }
3663 
3664   assert(Universe::is_fully_initialized(), "not initialized");
3665   if (VerifyDuringStartup) {
3666     // Make sure we're starting with a clean slate.
3667     VM_Verify verify_op;
3668     VMThread::execute(&amp;verify_op);
3669   }
3670 
3671   Thread* THREAD = Thread::current();
3672 
3673   // At this point, the Universe is initialized, but we have not executed
3674   // any byte code.  Now is a good time (the only time) to dump out the
3675   // internal state of the JVM for sharing.
3676   if (DumpSharedSpaces) {
3677     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3678     ShouldNotReachHere();
3679   }
3680 
3681   // Always call even when there are not JVMTI environments yet, since environments
3682   // may be attached late and JVMTI must track phases of VM execution
3683   JvmtiExport::enter_early_start_phase();
3684 
3685   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3686   JvmtiExport::post_early_vm_start();
3687 
3688   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3689 
3690   // We need this for ClassDataSharing - the initial vm.info property is set
3691   // with the default value of CDS "sharing" which may be reset through
3692   // command line options.
3693   reset_vm_info_property(CHECK_JNI_ERR);
3694 
3695   quicken_jni_functions();
3696 
3697   // No more stub generation allowed after that point.
3698   StubCodeDesc::freeze();
3699 
3700   // Set flag that basic initialization has completed. Used by exceptions and various
3701   // debug stuff, that does not work until all basic classes have been initialized.
3702   set_init_completed();
3703 
3704   LogConfiguration::post_initialize();
3705   Metaspace::post_initialize();
3706 
3707   HOTSPOT_VM_INIT_END();
3708 
3709   // record VM initialization completion time
3710 #if INCLUDE_MANAGEMENT
3711   Management::record_vm_init_completed();
3712 #endif // INCLUDE_MANAGEMENT
3713 
3714   // Note that we do not use CHECK_0 here since we are inside an EXCEPTION_MARK and
3715   // set_init_completed has just been called, causing exceptions not to be shortcut
3716   // anymore. We call vm_exit_during_initialization directly instead.
3717 
3718   // Initialize reference pending list locker
3719   bool needs_locker_thread = Universe::heap()-&gt;needs_reference_pending_list_locker_thread();
3720   ReferencePendingListLocker::initialize(needs_locker_thread, CHECK_JNI_ERR);
3721 
3722   // Signal Dispatcher needs to be started before VMInit event is posted
3723   os::signal_init();
3724 
3725   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3726   if (!DisableAttachMechanism) {
3727     AttachListener::vm_start();
3728     if (StartAttachListener || AttachListener::init_at_startup()) {
3729       AttachListener::init();
3730     }
3731   }
3732 
3733   // Launch -Xrun agents
3734   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3735   // back-end can launch with -Xdebug -Xrunjdwp.
3736   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3737     create_vm_init_libraries();
3738   }
3739 
3740   if (CleanChunkPoolAsync) {
3741     Chunk::start_chunk_pool_cleaner_task();
3742   }
3743 
3744   // initialize compiler(s)
3745 #if defined(COMPILER1) || defined(COMPILER2) || defined(SHARK) || INCLUDE_JVMCI
3746   CompileBroker::compilation_init(CHECK_JNI_ERR);
3747 #endif
3748 
3749   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3750   // It is done after compilers are initialized, because otherwise compilations of
3751   // signature polymorphic MH intrinsics can be missed
3752   // (see SystemDictionary::find_method_handle_intrinsic).
3753   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3754 
3755   // This will initialize the module system.  Only java.base classes can be
3756   // loaded until phase 2 completes
3757   call_initPhase2(CHECK_JNI_ERR);
3758 
3759   // Always call even when there are not JVMTI environments yet, since environments
3760   // may be attached late and JVMTI must track phases of VM execution
3761   JvmtiExport::enter_start_phase();
3762 
3763   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3764   JvmtiExport::post_vm_start();
3765 
3766   // Final system initialization including security manager and system class loader
3767   call_initPhase3(CHECK_JNI_ERR);
3768 
3769   // cache the system class loader
3770   SystemDictionary::compute_java_system_loader(CHECK_(JNI_ERR));
3771 
3772   // Always call even when there are not JVMTI environments yet, since environments
3773   // may be attached late and JVMTI must track phases of VM execution
3774   JvmtiExport::enter_live_phase();
3775 
3776   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3777   JvmtiExport::post_vm_initialized();
3778 
3779   if (TRACE_START() != JNI_OK) {
3780     vm_exit_during_initialization("Failed to start tracing backend.");
3781   }
3782 
3783 #if INCLUDE_MANAGEMENT
3784   Management::initialize(THREAD);
3785 
3786   if (HAS_PENDING_EXCEPTION) {
3787     // management agent fails to start possibly due to
3788     // configuration problem and is responsible for printing
3789     // stack trace if appropriate. Simply exit VM.
3790     vm_exit(1);
3791   }
3792 #endif // INCLUDE_MANAGEMENT
3793 
3794   if (Arguments::has_profile())       FlatProfiler::engage(main_thread, true);
3795   if (MemProfiling)                   MemProfiler::engage();
3796   StatSampler::engage();
3797   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3798 
3799   BiasedLocking::init();
3800 
3801 #if INCLUDE_RTM_OPT
3802   RTMLockingCounters::init();
3803 #endif
3804 
3805   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3806     call_postVMInitHook(THREAD);
3807     // The Java side of PostVMInitHook.run must deal with all
3808     // exceptions and provide means of diagnosis.
3809     if (HAS_PENDING_EXCEPTION) {
3810       CLEAR_PENDING_EXCEPTION;
3811     }
3812   }
3813 
3814   {
3815     MutexLocker ml(PeriodicTask_lock);
3816     // Make sure the WatcherThread can be started by WatcherThread::start()
3817     // or by dynamic enrollment.
3818     WatcherThread::make_startable();
3819     // Start up the WatcherThread if there are any periodic tasks
3820     // NOTE:  All PeriodicTasks should be registered by now. If they
3821     //   aren't, late joiners might appear to start slowly (we might
3822     //   take a while to process their first tick).
3823     if (PeriodicTask::num_tasks() &gt; 0) {
3824       WatcherThread::start();
3825     }
3826   }
3827 
3828   CodeCacheExtensions::complete_step(CodeCacheExtensionsSteps::CreateVM);
3829 
3830   create_vm_timer.end();
3831 #ifdef ASSERT
3832   _vm_complete = true;
3833 #endif
3834   return JNI_OK;
3835 }
3836 
3837 // type for the Agent_OnLoad and JVM_OnLoad entry points
3838 extern "C" {
3839   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3840 }
3841 // Find a command line agent library and return its entry point for
3842 //         -agentlib:  -agentpath:   -Xrun
3843 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3844 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3845                                     const char *on_load_symbols[],
3846                                     size_t num_symbol_entries) {
3847   OnLoadEntry_t on_load_entry = NULL;
3848   void *library = NULL;
3849 
3850   if (!agent-&gt;valid()) {
3851     char buffer[JVM_MAXPATHLEN];
3852     char ebuf[1024] = "";
3853     const char *name = agent-&gt;name();
3854     const char *msg = "Could not find agent library ";
3855 
3856     // First check to see if agent is statically linked into executable
3857     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3858       library = agent-&gt;os_lib();
3859     } else if (agent-&gt;is_absolute_path()) {
3860       library = os::dll_load(name, ebuf, sizeof ebuf);
3861       if (library == NULL) {
3862         const char *sub_msg = " in absolute path, with error: ";
3863         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3864         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3865         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3866         // If we can't find the agent, exit.
3867         vm_exit_during_initialization(buf, NULL);
3868         FREE_C_HEAP_ARRAY(char, buf);
3869       }
3870     } else {
3871       // Try to load the agent from the standard dll directory
3872       if (os::dll_build_name(buffer, sizeof(buffer), Arguments::get_dll_dir(),
3873                              name)) {
3874         library = os::dll_load(buffer, ebuf, sizeof ebuf);
3875       }
3876       if (library == NULL) { // Try the local directory
3877         char ns[1] = {0};
3878         if (os::dll_build_name(buffer, sizeof(buffer), ns, name)) {
3879           library = os::dll_load(buffer, ebuf, sizeof ebuf);
3880         }
3881         if (library == NULL) {
3882           const char *sub_msg = " on the library path, with error: ";
3883           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3884           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3885           jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3886           // If we can't find the agent, exit.
3887           vm_exit_during_initialization(buf, NULL);
3888           FREE_C_HEAP_ARRAY(char, buf);
3889         }
3890       }
3891     }
3892     agent-&gt;set_os_lib(library);
3893     agent-&gt;set_valid();
3894   }
3895 
3896   // Find the OnLoad function.
3897   on_load_entry =
3898     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
3899                                                           false,
3900                                                           on_load_symbols,
3901                                                           num_symbol_entries));
3902   return on_load_entry;
3903 }
3904 
3905 // Find the JVM_OnLoad entry point
3906 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
3907   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
3908   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3909 }
3910 
3911 // Find the Agent_OnLoad entry point
3912 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
3913   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
3914   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
3915 }
3916 
3917 // For backwards compatibility with -Xrun
3918 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
3919 // treated like -agentpath:
3920 // Must be called before agent libraries are created
3921 void Threads::convert_vm_init_libraries_to_agents() {
3922   AgentLibrary* agent;
3923   AgentLibrary* next;
3924 
3925   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
3926     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
3927     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
3928 
3929     // If there is an JVM_OnLoad function it will get called later,
3930     // otherwise see if there is an Agent_OnLoad
3931     if (on_load_entry == NULL) {
3932       on_load_entry = lookup_agent_on_load(agent);
3933       if (on_load_entry != NULL) {
3934         // switch it to the agent list -- so that Agent_OnLoad will be called,
3935         // JVM_OnLoad won't be attempted and Agent_OnUnload will
3936         Arguments::convert_library_to_agent(agent);
3937       } else {
3938         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
3939       }
3940     }
3941   }
3942 }
3943 
3944 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
3945 // Invokes Agent_OnLoad
3946 // Called very early -- before JavaThreads exist
3947 void Threads::create_vm_init_agents() {
3948   extern struct JavaVM_ main_vm;
3949   AgentLibrary* agent;
3950 
3951   JvmtiExport::enter_onload_phase();
3952 
3953   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3954     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
3955 
3956     if (on_load_entry != NULL) {
3957       // Invoke the Agent_OnLoad function
3958       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
3959       if (err != JNI_OK) {
3960         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
3961       }
3962     } else {
3963       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
3964     }
3965   }
3966   JvmtiExport::enter_primordial_phase();
3967 }
3968 
3969 extern "C" {
3970   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
3971 }
3972 
3973 void Threads::shutdown_vm_agents() {
3974   // Send any Agent_OnUnload notifications
3975   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
3976   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
3977   extern struct JavaVM_ main_vm;
3978   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
3979 
3980     // Find the Agent_OnUnload function.
3981     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
3982                                                    os::find_agent_function(agent,
3983                                                    false,
3984                                                    on_unload_symbols,
3985                                                    num_symbol_entries));
3986 
3987     // Invoke the Agent_OnUnload function
3988     if (unload_entry != NULL) {
3989       JavaThread* thread = JavaThread::current();
3990       ThreadToNativeFromVM ttn(thread);
3991       HandleMark hm(thread);
3992       (*unload_entry)(&amp;main_vm);
3993     }
3994   }
3995 }
3996 
3997 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
3998 // Invokes JVM_OnLoad
3999 void Threads::create_vm_init_libraries() {
4000   extern struct JavaVM_ main_vm;
4001   AgentLibrary* agent;
4002 
4003   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4004     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4005 
4006     if (on_load_entry != NULL) {
4007       // Invoke the JVM_OnLoad function
4008       JavaThread* thread = JavaThread::current();
4009       ThreadToNativeFromVM ttn(thread);
4010       HandleMark hm(thread);
4011       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4012       if (err != JNI_OK) {
4013         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4014       }
4015     } else {
4016       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4017     }
4018   }
4019 }
4020 
4021 JavaThread* Threads::find_java_thread_from_java_tid(jlong java_tid) {
4022   assert(Threads_lock-&gt;owned_by_self(), "Must hold Threads_lock");
4023 
4024   JavaThread* java_thread = NULL;
4025   // Sequential search for now.  Need to do better optimization later.
4026   for (JavaThread* thread = Threads::first(); thread != NULL; thread = thread-&gt;next()) {
4027     oop tobj = thread-&gt;threadObj();
4028     if (!thread-&gt;is_exiting() &amp;&amp;
4029         tobj != NULL &amp;&amp;
4030         java_tid == java_lang_Thread::thread_id(tobj)) {
4031       java_thread = thread;
4032       break;
4033     }
4034   }
4035   return java_thread;
4036 }
4037 
4038 
4039 // Last thread running calls java.lang.Shutdown.shutdown()
4040 void JavaThread::invoke_shutdown_hooks() {
4041   HandleMark hm(this);
4042 
4043   // We could get here with a pending exception, if so clear it now.
4044   if (this-&gt;has_pending_exception()) {
4045     this-&gt;clear_pending_exception();
4046   }
4047 
4048   EXCEPTION_MARK;
4049   Klass* k =
4050     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4051                                       THREAD);
4052   if (k != NULL) {
4053     // SystemDictionary::resolve_or_null will return null if there was
4054     // an exception.  If we cannot load the Shutdown class, just don't
4055     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4056     // and finalizers (if runFinalizersOnExit is set) won't be run.
4057     // Note that if a shutdown hook was registered or runFinalizersOnExit
4058     // was called, the Shutdown class would have already been loaded
4059     // (Runtime.addShutdownHook and runFinalizersOnExit will load it).
4060     instanceKlassHandle shutdown_klass (THREAD, k);
4061     JavaValue result(T_VOID);
4062     JavaCalls::call_static(&amp;result,
4063                            shutdown_klass,
4064                            vmSymbols::shutdown_method_name(),
4065                            vmSymbols::void_method_signature(),
4066                            THREAD);
4067   }
4068   CLEAR_PENDING_EXCEPTION;
4069 }
4070 
4071 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4072 // the program falls off the end of main(). Another VM exit path is through
4073 // vm_exit() when the program calls System.exit() to return a value or when
4074 // there is a serious error in VM. The two shutdown paths are not exactly
4075 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4076 // and VM_Exit op at VM level.
4077 //
4078 // Shutdown sequence:
4079 //   + Shutdown native memory tracking if it is on
4080 //   + Wait until we are the last non-daemon thread to execute
4081 //     &lt;-- every thing is still working at this moment --&gt;
4082 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4083 //        shutdown hooks, run finalizers if finalization-on-exit
4084 //   + Call before_exit(), prepare for VM exit
4085 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4086 //        currently the only user of this mechanism is File.deleteOnExit())
4087 //      &gt; stop flat profiler, StatSampler, watcher thread, CMS threads,
4088 //        post thread end and vm death events to JVMTI,
4089 //        stop signal thread
4090 //   + Call JavaThread::exit(), it will:
4091 //      &gt; release JNI handle blocks, remove stack guard pages
4092 //      &gt; remove this thread from Threads list
4093 //     &lt;-- no more Java code from this thread after this point --&gt;
4094 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4095 //     the compiler threads at safepoint
4096 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4097 //   + Disable tracing at JNI/JVM barriers
4098 //   + Set _vm_exited flag for threads that are still running native code
4099 //   + Delete this thread
4100 //   + Call exit_globals()
4101 //      &gt; deletes tty
4102 //      &gt; deletes PerfMemory resources
4103 //   + Return to caller
4104 
4105 bool Threads::destroy_vm() {
4106   JavaThread* thread = JavaThread::current();
4107 
4108 #ifdef ASSERT
4109   _vm_complete = false;
4110 #endif
4111   // Wait until we are the last non-daemon thread to execute
4112   { MutexLocker nu(Threads_lock);
4113     while (Threads::number_of_non_daemon_threads() &gt; 1)
4114       // This wait should make safepoint checks, wait without a timeout,
4115       // and wait as a suspend-equivalent condition.
4116       //
4117       // Note: If the FlatProfiler is running and this thread is waiting
4118       // for another non-daemon thread to finish, then the FlatProfiler
4119       // is waiting for the external suspend request on this thread to
4120       // complete. wait_for_ext_suspend_completion() will eventually
4121       // timeout, but that takes time. Making this wait a suspend-
4122       // equivalent condition solves that timeout problem.
4123       //
4124       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4125                          Mutex::_as_suspend_equivalent_flag);
4126   }
4127 
4128   // Hang forever on exit if we are reporting an error.
4129   if (ShowMessageBoxOnError &amp;&amp; is_error_reported()) {
4130     os::infinite_sleep();
4131   }
4132   os::wait_for_keypress_at_exit();
4133 
4134   // run Java level shutdown hooks
4135   thread-&gt;invoke_shutdown_hooks();
4136 
4137   before_exit(thread);
4138 
4139   thread-&gt;exit(true);
4140 
4141   // Stop VM thread.
4142   {
4143     // 4945125 The vm thread comes to a safepoint during exit.
4144     // GC vm_operations can get caught at the safepoint, and the
4145     // heap is unparseable if they are caught. Grab the Heap_lock
4146     // to prevent this. The GC vm_operations will not be able to
4147     // queue until after the vm thread is dead. After this point,
4148     // we'll never emerge out of the safepoint before the VM exits.
4149 
4150     MutexLocker ml(Heap_lock);
4151 
4152     VMThread::wait_for_vm_thread_exit();
4153     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4154     VMThread::destroy();
4155   }
4156 
4157   // clean up ideal graph printers
4158 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4159   IdealGraphPrinter::clean_up();
4160 #endif
4161 
4162   // Now, all Java threads are gone except daemon threads. Daemon threads
4163   // running Java code or in VM are stopped by the Safepoint. However,
4164   // daemon threads executing native code are still running.  But they
4165   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4166   // simply kill or suspend them, as it is inherently deadlock-prone.
4167 
4168   VM_Exit::set_vm_exited();
4169 
4170   notify_vm_shutdown();
4171 
4172   delete thread;
4173 
4174 #if INCLUDE_JVMCI
4175   if (JVMCICounterSize &gt; 0) {
4176     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4177   }
4178 #endif
4179 
4180   // exit_globals() will delete tty
4181   exit_globals();
4182 
4183   LogConfiguration::finalize();
4184 
4185   return true;
4186 }
4187 
4188 
4189 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4190   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4191   return is_supported_jni_version(version);
4192 }
4193 
4194 
4195 jboolean Threads::is_supported_jni_version(jint version) {
4196   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4197   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4198   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4199   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4200   if (version == JNI_VERSION_9) return JNI_TRUE;
4201   return JNI_FALSE;
4202 }
4203 
4204 
4205 void Threads::add(JavaThread* p, bool force_daemon) {
4206   // The threads lock must be owned at this point
4207   assert_locked_or_safepoint(Threads_lock);
4208 
4209   // See the comment for this method in thread.hpp for its purpose and
4210   // why it is called here.
4211   p-&gt;initialize_queues();
4212   p-&gt;set_next(_thread_list);
4213   _thread_list = p;
4214   _number_of_threads++;
4215   oop threadObj = p-&gt;threadObj();
4216   bool daemon = true;
4217   // Bootstrapping problem: threadObj can be null for initial
4218   // JavaThread (or for threads attached via JNI)
4219   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4220     _number_of_non_daemon_threads++;
4221     daemon = false;
4222   }
4223 
4224   ThreadService::add_thread(p, daemon);
4225 
4226   // Possible GC point.
4227   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4228 }
4229 
4230 void Threads::remove(JavaThread* p) {
4231   // Extra scope needed for Thread_lock, so we can check
4232   // that we do not remove thread without safepoint code notice
4233   { MutexLocker ml(Threads_lock);
4234 
4235     assert(includes(p), "p must be present");
4236 
4237     JavaThread* current = _thread_list;
4238     JavaThread* prev    = NULL;
4239 
4240     while (current != p) {
4241       prev    = current;
4242       current = current-&gt;next();
4243     }
4244 
4245     if (prev) {
4246       prev-&gt;set_next(current-&gt;next());
4247     } else {
4248       _thread_list = p-&gt;next();
4249     }
4250     _number_of_threads--;
4251     oop threadObj = p-&gt;threadObj();
4252     bool daemon = true;
4253     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4254       _number_of_non_daemon_threads--;
4255       daemon = false;
4256 
4257       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4258       // on destroy_vm will wake up.
4259       if (number_of_non_daemon_threads() == 1) {
4260         Threads_lock-&gt;notify_all();
4261       }
4262     }
4263     ThreadService::remove_thread(p, daemon);
4264 
4265     // Make sure that safepoint code disregard this thread. This is needed since
4266     // the thread might mess around with locks after this point. This can cause it
4267     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4268     // of this thread since it is removed from the queue.
4269     p-&gt;set_terminated_value();
4270   } // unlock Threads_lock
4271 
4272   // Since Events::log uses a lock, we grab it outside the Threads_lock
4273   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4274 }
4275 
4276 // Threads_lock must be held when this is called (or must be called during a safepoint)
4277 bool Threads::includes(JavaThread* p) {
4278   assert(Threads_lock-&gt;is_locked(), "sanity check");
4279   ALL_JAVA_THREADS(q) {
4280     if (q == p) {
4281       return true;
4282     }
4283   }
4284   return false;
4285 }
4286 
4287 // Operations on the Threads list for GC.  These are not explicitly locked,
4288 // but the garbage collector must provide a safe context for them to run.
4289 // In particular, these things should never be called when the Threads_lock
4290 // is held by some other thread. (Note: the Safepoint abstraction also
4291 // uses the Threads_lock to guarantee this property. It also makes sure that
4292 // all threads gets blocked when exiting or starting).
4293 
4294 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4295   ALL_JAVA_THREADS(p) {
4296     p-&gt;oops_do(f, cf);
4297   }
4298   VMThread::vm_thread()-&gt;oops_do(f, cf);
4299 }
4300 
4301 void Threads::change_thread_claim_parity() {
4302   // Set the new claim parity.
4303   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4304          "Not in range.");
4305   _thread_claim_parity++;
4306   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4307   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4308          "Not in range.");
4309 }
4310 
4311 #ifdef ASSERT
4312 void Threads::assert_all_threads_claimed() {
4313   ALL_JAVA_THREADS(p) {
4314     const int thread_parity = p-&gt;oops_do_parity();
4315     assert((thread_parity == _thread_claim_parity),
4316            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4317   }
4318 }
4319 #endif // ASSERT
4320 
4321 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4322   int cp = Threads::thread_claim_parity();
4323   ALL_JAVA_THREADS(p) {
4324     if (p-&gt;claim_oops_do(is_par, cp)) {
4325       p-&gt;oops_do(f, cf);
4326     }
4327   }
4328   VMThread* vmt = VMThread::vm_thread();
4329   if (vmt-&gt;claim_oops_do(is_par, cp)) {
4330     vmt-&gt;oops_do(f, cf);
4331   }
4332 }
4333 
4334 #if INCLUDE_ALL_GCS
4335 // Used by ParallelScavenge
4336 void Threads::create_thread_roots_tasks(GCTaskQueue* q) {
4337   ALL_JAVA_THREADS(p) {
4338     q-&gt;enqueue(new ThreadRootsTask(p));
4339   }
4340   q-&gt;enqueue(new ThreadRootsTask(VMThread::vm_thread()));
4341 }
4342 
4343 // Used by Parallel Old
4344 void Threads::create_thread_roots_marking_tasks(GCTaskQueue* q) {
4345   ALL_JAVA_THREADS(p) {
4346     q-&gt;enqueue(new ThreadRootsMarkingTask(p));
4347   }
4348   q-&gt;enqueue(new ThreadRootsMarkingTask(VMThread::vm_thread()));
4349 }
4350 #endif // INCLUDE_ALL_GCS
4351 
4352 void Threads::nmethods_do(CodeBlobClosure* cf) {
4353   ALL_JAVA_THREADS(p) {
4354     // This is used by the code cache sweeper to mark nmethods that are active
4355     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4356     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4357     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4358       p-&gt;nmethods_do(cf);
4359     }
4360   }
4361 }
4362 
4363 void Threads::metadata_do(void f(Metadata*)) {
4364   ALL_JAVA_THREADS(p) {
4365     p-&gt;metadata_do(f);
4366   }
4367 }
4368 
4369 class ThreadHandlesClosure : public ThreadClosure {
4370   void (*_f)(Metadata*);
4371  public:
4372   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4373   virtual void do_thread(Thread* thread) {
4374     thread-&gt;metadata_handles_do(_f);
4375   }
4376 };
4377 
4378 void Threads::metadata_handles_do(void f(Metadata*)) {
4379   // Only walk the Handles in Thread.
4380   ThreadHandlesClosure handles_closure(f);
4381   threads_do(&amp;handles_closure);
4382 }
4383 
4384 void Threads::deoptimized_wrt_marked_nmethods() {
4385   ALL_JAVA_THREADS(p) {
4386     p-&gt;deoptimized_wrt_marked_nmethods();
4387   }
4388 }
4389 
4390 
4391 // Get count Java threads that are waiting to enter the specified monitor.
4392 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(int count,
4393                                                          address monitor,
4394                                                          bool doLock) {
4395   assert(doLock || SafepointSynchronize::is_at_safepoint(),
4396          "must grab Threads_lock or be at safepoint");
4397   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4398 
4399   int i = 0;
4400   {
4401     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4402     ALL_JAVA_THREADS(p) {
4403       if (!p-&gt;can_call_java()) continue;
4404 
4405       address pending = (address)p-&gt;current_pending_monitor();
4406       if (pending == monitor) {             // found a match
4407         if (i &lt; count) result-&gt;append(p);   // save the first count matches
4408         i++;
4409       }
4410     }
4411   }
4412   return result;
4413 }
4414 
4415 
4416 JavaThread *Threads::owning_thread_from_monitor_owner(address owner,
4417                                                       bool doLock) {
4418   assert(doLock ||
4419          Threads_lock-&gt;owned_by_self() ||
4420          SafepointSynchronize::is_at_safepoint(),
4421          "must grab Threads_lock or be at safepoint");
4422 
4423   // NULL owner means not locked so we can skip the search
4424   if (owner == NULL) return NULL;
4425 
4426   {
4427     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4428     ALL_JAVA_THREADS(p) {
4429       // first, see if owner is the address of a Java thread
4430       if (owner == (address)p) return p;
4431     }
4432   }
4433   // Cannot assert on lack of success here since this function may be
4434   // used by code that is trying to report useful problem information
4435   // like deadlock detection.
4436   if (UseHeavyMonitors) return NULL;
4437 
4438   // If we didn't find a matching Java thread and we didn't force use of
4439   // heavyweight monitors, then the owner is the stack address of the
4440   // Lock Word in the owning Java thread's stack.
4441   //
4442   JavaThread* the_owner = NULL;
4443   {
4444     MutexLockerEx ml(doLock ? Threads_lock : NULL);
4445     ALL_JAVA_THREADS(q) {
4446       if (q-&gt;is_lock_owned(owner)) {
4447         the_owner = q;
4448         break;
4449       }
4450     }
4451   }
4452   // cannot assert on lack of success here; see above comment
4453   return the_owner;
4454 }
4455 
4456 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4457 void Threads::print_on(outputStream* st, bool print_stacks,
4458                        bool internal_format, bool print_concurrent_locks) {
4459   char buf[32];
4460   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4461 
4462   st-&gt;print_cr("Full thread dump %s (%s %s):",
4463                Abstract_VM_Version::vm_name(),
4464                Abstract_VM_Version::vm_release(),
4465                Abstract_VM_Version::vm_info_string());
4466   st-&gt;cr();
4467 
4468 #if INCLUDE_SERVICES
4469   // Dump concurrent locks
4470   ConcurrentLocksDump concurrent_locks;
4471   if (print_concurrent_locks) {
4472     concurrent_locks.dump_at_safepoint();
4473   }
4474 #endif // INCLUDE_SERVICES
4475 
4476   ALL_JAVA_THREADS(p) {
4477     ResourceMark rm;
4478     p-&gt;print_on(st);
4479     if (print_stacks) {
4480       if (internal_format) {
4481         p-&gt;trace_stack();
4482       } else {
4483         p-&gt;print_stack_on(st);
4484       }
4485     }
4486     st-&gt;cr();
4487 #if INCLUDE_SERVICES
4488     if (print_concurrent_locks) {
4489       concurrent_locks.print_locks_on(p, st);
4490     }
4491 #endif // INCLUDE_SERVICES
4492   }
4493 
4494   VMThread::vm_thread()-&gt;print_on(st);
4495   st-&gt;cr();
4496   Universe::heap()-&gt;print_gc_threads_on(st);
4497   WatcherThread* wt = WatcherThread::watcher_thread();
4498   if (wt != NULL) {
4499     wt-&gt;print_on(st);
4500     st-&gt;cr();
4501   }
4502   st-&gt;flush();
4503 }
4504 
4505 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4506                              int buflen, bool* found_current) {
4507   if (this_thread != NULL) {
4508     bool is_current = (current == this_thread);
4509     *found_current = *found_current || is_current;
4510     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4511 
4512     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4513     st-&gt;print(" ");
4514     this_thread-&gt;print_on_error(st, buf, buflen);
4515     st-&gt;cr();
4516   }
4517 }
4518 
4519 class PrintOnErrorClosure : public ThreadClosure {
4520   outputStream* _st;
4521   Thread* _current;
4522   char* _buf;
4523   int _buflen;
4524   bool* _found_current;
4525  public:
4526   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4527                       int buflen, bool* found_current) :
4528    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4529 
4530   virtual void do_thread(Thread* thread) {
4531     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4532   }
4533 };
4534 
4535 // Threads::print_on_error() is called by fatal error handler. It's possible
4536 // that VM is not at safepoint and/or current thread is inside signal handler.
4537 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4538 // memory (even in resource area), it might deadlock the error handler.
4539 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4540                              int buflen) {
4541   bool found_current = false;
4542   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4543   ALL_JAVA_THREADS(thread) {
4544     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4545   }
4546   st-&gt;cr();
4547 
4548   st-&gt;print_cr("Other Threads:");
4549   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4550   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4551 
4552   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4553   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4554 
4555   if (!found_current) {
4556     st-&gt;cr();
4557     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4558     current-&gt;print_on_error(st, buf, buflen);
4559     st-&gt;cr();
4560   }
4561   st-&gt;cr();
4562   st-&gt;print_cr("Threads with active compile tasks:");
4563   print_threads_compiling(st, buf, buflen);
4564 }
4565 
4566 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4567   ALL_JAVA_THREADS(thread) {
4568     if (thread-&gt;is_Compiler_thread()) {
4569       CompilerThread* ct = (CompilerThread*) thread;
4570       if (ct-&gt;task() != NULL) {
4571         thread-&gt;print_name_on_error(st, buf, buflen);
4572         ct-&gt;task()-&gt;print(st, NULL, true, true);
4573       }
4574     }
4575   }
4576 }
4577 
4578 
4579 // Internal SpinLock and Mutex
4580 // Based on ParkEvent
4581 
4582 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4583 //
4584 // We employ SpinLocks _only for low-contention, fixed-length
4585 // short-duration critical sections where we're concerned
4586 // about native mutex_t or HotSpot Mutex:: latency.
4587 // The mux construct provides a spin-then-block mutual exclusion
4588 // mechanism.
4589 //
4590 // Testing has shown that contention on the ListLock guarding gFreeList
4591 // is common.  If we implement ListLock as a simple SpinLock it's common
4592 // for the JVM to devolve to yielding with little progress.  This is true
4593 // despite the fact that the critical sections protected by ListLock are
4594 // extremely short.
4595 //
4596 // TODO-FIXME: ListLock should be of type SpinLock.
4597 // We should make this a 1st-class type, integrated into the lock
4598 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4599 // should have sufficient padding to avoid false-sharing and excessive
4600 // cache-coherency traffic.
4601 
4602 
4603 typedef volatile int SpinLockT;
4604 
4605 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4606   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4607     return;   // normal fast-path return
4608   }
4609 
4610   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4611   TEVENT(SpinAcquire - ctx);
4612   int ctr = 0;
4613   int Yields = 0;
4614   for (;;) {
4615     while (*adr != 0) {
4616       ++ctr;
4617       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4618         if (Yields &gt; 5) {
4619           os::naked_short_sleep(1);
4620         } else {
4621           os::naked_yield();
4622           ++Yields;
4623         }
4624       } else {
4625         SpinPause();
4626       }
4627     }
4628     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4629   }
4630 }
4631 
4632 void Thread::SpinRelease(volatile int * adr) {
4633   assert(*adr != 0, "invariant");
4634   OrderAccess::fence();      // guarantee at least release consistency.
4635   // Roach-motel semantics.
4636   // It's safe if subsequent LDs and STs float "up" into the critical section,
4637   // but prior LDs and STs within the critical section can't be allowed
4638   // to reorder or float past the ST that releases the lock.
4639   // Loads and stores in the critical section - which appear in program
4640   // order before the store that releases the lock - must also appear
4641   // before the store that releases the lock in memory visibility order.
4642   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4643   // the ST of 0 into the lock-word which releases the lock, so fence
4644   // more than covers this on all platforms.
4645   *adr = 0;
4646 }
4647 
4648 // muxAcquire and muxRelease:
4649 //
4650 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4651 //    The LSB of the word is set IFF the lock is held.
4652 //    The remainder of the word points to the head of a singly-linked list
4653 //    of threads blocked on the lock.
4654 //
4655 // *  The current implementation of muxAcquire-muxRelease uses its own
4656 //    dedicated Thread._MuxEvent instance.  If we're interested in
4657 //    minimizing the peak number of extant ParkEvent instances then
4658 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4659 //    as certain invariants were satisfied.  Specifically, care would need
4660 //    to be taken with regards to consuming unpark() "permits".
4661 //    A safe rule of thumb is that a thread would never call muxAcquire()
4662 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4663 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4664 //    consume an unpark() permit intended for monitorenter, for instance.
4665 //    One way around this would be to widen the restricted-range semaphore
4666 //    implemented in park().  Another alternative would be to provide
4667 //    multiple instances of the PlatformEvent() for each thread.  One
4668 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4669 //
4670 // *  Usage:
4671 //    -- Only as leaf locks
4672 //    -- for short-term locking only as muxAcquire does not perform
4673 //       thread state transitions.
4674 //
4675 // Alternatives:
4676 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4677 //    but with parking or spin-then-park instead of pure spinning.
4678 // *  Use Taura-Oyama-Yonenzawa locks.
4679 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4680 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4681 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4682 //    acquiring threads use timers (ParkTimed) to detect and recover from
4683 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4684 //    boundaries by using placement-new.
4685 // *  Augment MCS with advisory back-link fields maintained with CAS().
4686 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4687 //    The validity of the backlinks must be ratified before we trust the value.
4688 //    If the backlinks are invalid the exiting thread must back-track through the
4689 //    the forward links, which are always trustworthy.
4690 // *  Add a successor indication.  The LockWord is currently encoded as
4691 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4692 //    to provide the usual futile-wakeup optimization.
4693 //    See RTStt for details.
4694 // *  Consider schedctl.sc_nopreempt to cover the critical section.
4695 //
4696 
4697 
4698 typedef volatile intptr_t MutexT;      // Mux Lock-word
4699 enum MuxBits { LOCKBIT = 1 };
4700 
4701 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4702   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4703   if (w == 0) return;
4704   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4705     return;
4706   }
4707 
4708   TEVENT(muxAcquire - Contention);
4709   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4710   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4711   for (;;) {
4712     int its = (os::is_MP() ? 100 : 0) + 1;
4713 
4714     // Optional spin phase: spin-then-park strategy
4715     while (--its &gt;= 0) {
4716       w = *Lock;
4717       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4718         return;
4719       }
4720     }
4721 
4722     Self-&gt;reset();
4723     Self-&gt;OnList = intptr_t(Lock);
4724     // The following fence() isn't _strictly necessary as the subsequent
4725     // CAS() both serializes execution and ratifies the fetched *Lock value.
4726     OrderAccess::fence();
4727     for (;;) {
4728       w = *Lock;
4729       if ((w &amp; LOCKBIT) == 0) {
4730         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4731           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4732           return;
4733         }
4734         continue;      // Interference -- *Lock changed -- Just retry
4735       }
4736       assert(w &amp; LOCKBIT, "invariant");
4737       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4738       if (Atomic::cmpxchg_ptr(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4739     }
4740 
4741     while (Self-&gt;OnList != 0) {
4742       Self-&gt;park();
4743     }
4744   }
4745 }
4746 
4747 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4748   intptr_t w = Atomic::cmpxchg_ptr(LOCKBIT, Lock, 0);
4749   if (w == 0) return;
4750   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4751     return;
4752   }
4753 
4754   TEVENT(muxAcquire - Contention);
4755   ParkEvent * ReleaseAfter = NULL;
4756   if (ev == NULL) {
4757     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4758   }
4759   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4760   for (;;) {
4761     guarantee(ev-&gt;OnList == 0, "invariant");
4762     int its = (os::is_MP() ? 100 : 0) + 1;
4763 
4764     // Optional spin phase: spin-then-park strategy
4765     while (--its &gt;= 0) {
4766       w = *Lock;
4767       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4768         if (ReleaseAfter != NULL) {
4769           ParkEvent::Release(ReleaseAfter);
4770         }
4771         return;
4772       }
4773     }
4774 
4775     ev-&gt;reset();
4776     ev-&gt;OnList = intptr_t(Lock);
4777     // The following fence() isn't _strictly necessary as the subsequent
4778     // CAS() both serializes execution and ratifies the fetched *Lock value.
4779     OrderAccess::fence();
4780     for (;;) {
4781       w = *Lock;
4782       if ((w &amp; LOCKBIT) == 0) {
4783         if (Atomic::cmpxchg_ptr (w|LOCKBIT, Lock, w) == w) {
4784           ev-&gt;OnList = 0;
4785           // We call ::Release while holding the outer lock, thus
4786           // artificially lengthening the critical section.
4787           // Consider deferring the ::Release() until the subsequent unlock(),
4788           // after we've dropped the outer lock.
4789           if (ReleaseAfter != NULL) {
4790             ParkEvent::Release(ReleaseAfter);
4791           }
4792           return;
4793         }
4794         continue;      // Interference -- *Lock changed -- Just retry
4795       }
4796       assert(w &amp; LOCKBIT, "invariant");
4797       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4798       if (Atomic::cmpxchg_ptr(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4799     }
4800 
4801     while (ev-&gt;OnList != 0) {
4802       ev-&gt;park();
4803     }
4804   }
4805 }
4806 
4807 // Release() must extract a successor from the list and then wake that thread.
4808 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4809 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4810 // Release() would :
4811 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4812 // (B) Extract a successor from the private list "in-hand"
4813 // (C) attempt to CAS() the residual back into *Lock over null.
4814 //     If there were any newly arrived threads and the CAS() would fail.
4815 //     In that case Release() would detach the RATs, re-merge the list in-hand
4816 //     with the RATs and repeat as needed.  Alternately, Release() might
4817 //     detach and extract a successor, but then pass the residual list to the wakee.
4818 //     The wakee would be responsible for reattaching and remerging before it
4819 //     competed for the lock.
4820 //
4821 // Both "pop" and DMR are immune from ABA corruption -- there can be
4822 // multiple concurrent pushers, but only one popper or detacher.
4823 // This implementation pops from the head of the list.  This is unfair,
4824 // but tends to provide excellent throughput as hot threads remain hot.
4825 // (We wake recently run threads first).
4826 //
4827 // All paths through muxRelease() will execute a CAS.
4828 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4829 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4830 // executed within the critical section are complete and globally visible before the
4831 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4832 void Thread::muxRelease(volatile intptr_t * Lock)  {
4833   for (;;) {
4834     const intptr_t w = Atomic::cmpxchg_ptr(0, Lock, LOCKBIT);
4835     assert(w &amp; LOCKBIT, "invariant");
4836     if (w == LOCKBIT) return;
4837     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4838     assert(List != NULL, "invariant");
4839     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4840     ParkEvent * const nxt = List-&gt;ListNext;
4841     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4842 
4843     // The following CAS() releases the lock and pops the head element.
4844     // The CAS() also ratifies the previously fetched lock-word value.
4845     if (Atomic::cmpxchg_ptr (intptr_t(nxt), Lock, w) != w) {
4846       continue;
4847     }
4848     List-&gt;OnList = 0;
4849     OrderAccess::fence();
4850     List-&gt;unpark();
4851     return;
4852   }
4853 }
4854 
4855 
4856 void Threads::verify() {
4857   ALL_JAVA_THREADS(p) {
4858     p-&gt;verify();
4859   }
4860   VMThread* thread = VMThread::vm_thread();
4861   if (thread != NULL) thread-&gt;verify();
4862 }
</pre></body></html>
