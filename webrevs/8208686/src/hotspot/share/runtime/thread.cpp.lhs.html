<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

    <script type="text/javascript" src="../../../../ancnav.js"></script>
    </head>
    <body id="SUNWwebrev" onkeypress="keypress(event);">
    <a name="0"></a>
    <pre></pre><hr></hr>
<pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/javaClasses.hpp"
  29 #include "classfile/moduleEntry.hpp"
  30 #include "classfile/systemDictionary.hpp"
  31 #include "classfile/vmSymbols.hpp"
  32 #include "code/codeCache.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/barrierSet.hpp"
  37 #include "gc/shared/gcId.hpp"
  38 #include "gc/shared/gcLocker.inline.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jfr/jfrEvents.hpp"
  44 #include "jfr/support/jfrThreadId.hpp"
  45 #include "jvmtifiles/jvmtiEnv.hpp"
  46 #include "logging/log.hpp"
  47 #include "logging/logConfiguration.hpp"
  48 #include "logging/logStream.hpp"
  49 #include "memory/allocation.inline.hpp"
  50 #include "memory/metaspaceShared.hpp"
  51 #include "memory/oopFactory.hpp"
  52 #include "memory/resourceArea.hpp"
  53 #include "memory/universe.hpp"
  54 #include "oops/access.inline.hpp"
  55 #include "oops/instanceKlass.hpp"
  56 #include "oops/objArrayOop.hpp"
  57 #include "oops/oop.inline.hpp"
  58 #include "oops/symbol.hpp"
  59 #include "oops/typeArrayOop.inline.hpp"
  60 #include "oops/verifyOopClosure.hpp"
  61 #include "prims/jvm_misc.hpp"
  62 #include "prims/jvmtiExport.hpp"
  63 #include "prims/jvmtiThreadState.hpp"
  64 #include "prims/privilegedStack.hpp"
  65 #include "runtime/arguments.hpp"
  66 #include "runtime/atomic.hpp"
  67 #include "runtime/biasedLocking.hpp"
  68 #include "runtime/fieldDescriptor.inline.hpp"
  69 #include "runtime/flags/jvmFlagConstraintList.hpp"
  70 #include "runtime/flags/jvmFlagRangeList.hpp"
  71 #include "runtime/flags/jvmFlagWriteableList.hpp"
  72 #include "runtime/deoptimization.hpp"
  73 #include "runtime/frame.inline.hpp"
  74 #include "runtime/handshake.hpp"
  75 #include "runtime/init.hpp"
  76 #include "runtime/interfaceSupport.inline.hpp"
  77 #include "runtime/java.hpp"
  78 #include "runtime/javaCalls.hpp"
  79 #include "runtime/jniHandles.inline.hpp"
  80 #include "runtime/jniPeriodicChecker.hpp"
  81 #include "runtime/memprofiler.hpp"
  82 #include "runtime/mutexLocker.hpp"
  83 #include "runtime/objectMonitor.hpp"
  84 #include "runtime/orderAccess.hpp"
  85 #include "runtime/osThread.hpp"
  86 #include "runtime/prefetch.inline.hpp"
  87 #include "runtime/safepoint.hpp"
  88 #include "runtime/safepointMechanism.inline.hpp"
  89 #include "runtime/safepointVerifiers.hpp"
  90 #include "runtime/sharedRuntime.hpp"
  91 #include "runtime/statSampler.hpp"
  92 #include "runtime/stubRoutines.hpp"
  93 #include "runtime/sweeper.hpp"
  94 #include "runtime/task.hpp"
  95 #include "runtime/thread.inline.hpp"
  96 #include "runtime/threadCritical.hpp"
  97 #include "runtime/threadSMR.inline.hpp"
  98 #include "runtime/threadStatisticalInfo.hpp"
  99 #include "runtime/timer.hpp"
 100 #include "runtime/timerTrace.hpp"
 101 #include "runtime/vframe.inline.hpp"
 102 #include "runtime/vframeArray.hpp"
 103 #include "runtime/vframe_hp.hpp"
 104 #include "runtime/vmThread.hpp"
 105 #include "runtime/vm_operations.hpp"
 106 #include "runtime/vm_version.hpp"
 107 #include "services/attachListener.hpp"
 108 #include "services/management.hpp"
 109 #include "services/memTracker.hpp"
 110 #include "services/threadService.hpp"
 111 #include "utilities/align.hpp"
 112 #include "utilities/copy.hpp"
 113 #include "utilities/defaultStream.hpp"
 114 #include "utilities/dtrace.hpp"
 115 #include "utilities/events.hpp"
 116 #include "utilities/macros.hpp"
 117 #include "utilities/preserveException.hpp"
 118 #include "utilities/singleWriterSynchronizer.hpp"
 119 #include "utilities/vmError.hpp"
 120 #if INCLUDE_JVMCI
 121 #include "jvmci/jvmciCompiler.hpp"
 122 #include "jvmci/jvmciRuntime.hpp"
 123 #include "logging/logHandle.hpp"
 124 #endif
 125 #ifdef COMPILER1
 126 #include "c1/c1_Compiler.hpp"
 127 #endif
 128 #ifdef COMPILER2
 129 #include "opto/c2compiler.hpp"
 130 #include "opto/idealGraphPrinter.hpp"
 131 #endif
 132 #if INCLUDE_RTM_OPT
 133 #include "runtime/rtmLocking.hpp"
 134 #endif
 135 #if INCLUDE_JFR
 136 #include "jfr/jfr.hpp"
 137 #endif
 138 
 139 // Initialization after module runtime initialization
 140 void universe_post_module_init();  // must happen after call_initPhase2
 141 
 142 #ifdef DTRACE_ENABLED
 143 
 144 // Only bother with this argument setup if dtrace is available
 145 
 146   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 147   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 150     {                                                                      \
 151       ResourceMark rm(this);                                               \
 152       int len = 0;                                                         \
 153       const char* name = (javathread)-&gt;get_thread_name();                  \
 154       len = strlen(name);                                                  \
 155       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 156         (char *) name, len,                                                \
 157         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 158         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 159         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 160     }
 161 
 162 #else //  ndef DTRACE_ENABLED
 163 
 164   #define DTRACE_THREAD_PROBE(probe, javathread)
 165 
 166 #endif // ndef DTRACE_ENABLED
 167 
 168 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 169 // Current thread is maintained as a thread-local variable
 170 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 171 #endif
 172 
 173 // ======= Thread ========
 174 // Support for forcing alignment of thread objects for biased locking
 175 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 176   if (UseBiasedLocking) {
 177     const int alignment = markOopDesc::biased_lock_alignment;
 178     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 179     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 180                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 181                                                          AllocFailStrategy::RETURN_NULL);
 182     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 183     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 184            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 185            "JavaThread alignment code overflowed allocated storage");
 186     if (aligned_addr != real_malloc_addr) {
 187       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 188                               p2i(real_malloc_addr),
 189                               p2i(aligned_addr));
 190     }
 191     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 192     return aligned_addr;
 193   } else {
 194     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 195                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 196   }
 197 }
 198 
 199 void Thread::operator delete(void* p) {
 200   if (UseBiasedLocking) {
 201     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 202   } else {
 203     FreeHeap(p);
 204   }
 205 }
 206 
 207 void JavaThread::smr_delete() {
 208   if (_on_thread_list) {
 209     ThreadsSMRSupport::smr_delete(this);
 210   } else {
 211     delete this;
 212   }
 213 }
 214 
 215 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 216 // JavaThread
 217 
 218 
 219 Thread::Thread() {
 220   // stack and get_thread
 221   set_stack_base(NULL);
 222   set_stack_size(0);
 223   set_self_raw_id(0);
 224   set_lgrp_id(-1);
 225   DEBUG_ONLY(clear_suspendible_thread();)
 226 
 227   // allocated data structures
 228   set_osthread(NULL);
 229   set_resource_area(new (mtThread)ResourceArea());
 230   DEBUG_ONLY(_current_resource_mark = NULL;)
 231   set_handle_area(new (mtThread) HandleArea(NULL));
 232   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 233   set_active_handles(NULL);
 234   set_free_handle_block(NULL);
 235   set_last_handle_mark(NULL);
 236 
 237   // This initial value ==&gt; never claimed.
 238   _oops_do_parity = 0;
 239   _threads_hazard_ptr = NULL;
 240   _threads_list_ptr = NULL;
 241   _nested_threads_hazard_ptr_cnt = 0;
 242   _rcu_counter = 0;
 243 
 244   // the handle mark links itself to last_handle_mark
 245   new HandleMark(this);
 246 
 247   // plain initialization
 248   debug_only(_owned_locks = NULL;)
 249   debug_only(_allow_allocation_count = 0;)
 250   NOT_PRODUCT(_allow_safepoint_count = 0;)
 251   NOT_PRODUCT(_skip_gcalot = false;)
 252   _jvmti_env_iteration_count = 0;
 253   set_allocated_bytes(0);
 254   _vm_operation_started_count = 0;
 255   _vm_operation_completed_count = 0;
 256   _current_pending_monitor = NULL;
 257   _current_pending_monitor_is_from_java = true;
 258   _current_waiting_monitor = NULL;
 259   _num_nested_signal = 0;
 260   omFreeList = NULL;
 261   omFreeCount = 0;
 262   omFreeProvision = 32;
 263   omInUseList = NULL;
 264   omInUseCount = 0;
 265 
 266 #ifdef ASSERT
 267   _visited_for_critical_count = false;
 268 #endif
 269 
 270   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 271                          Monitor::_safepoint_check_sometimes);
 272   _suspend_flags = 0;
 273 
 274   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 275   _hashStateX = os::random();
 276   _hashStateY = 842502087;
 277   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 278   _hashStateW = 273326509;
 279 
 280   _OnTrap   = 0;
 281   _Stalled  = 0;
 282   _TypeTag  = 0x2BAD;
 283 
 284   // Many of the following fields are effectively final - immutable
 285   // Note that nascent threads can't use the Native Monitor-Mutex
 286   // construct until the _MutexEvent is initialized ...
 287   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 288   // we might instead use a stack of ParkEvents that we could provision on-demand.
 289   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 290   // and ::Release()
 291   _ParkEvent   = ParkEvent::Allocate(this);
 292   _SleepEvent  = ParkEvent::Allocate(this);
 293   _MutexEvent  = ParkEvent::Allocate(this);
 294   _MuxEvent    = ParkEvent::Allocate(this);
 295 
 296 #ifdef CHECK_UNHANDLED_OOPS
 297   if (CheckUnhandledOops) {
 298     _unhandled_oops = new UnhandledOops(this);
 299   }
 300 #endif // CHECK_UNHANDLED_OOPS
 301 #ifdef ASSERT
 302   if (UseBiasedLocking) {
 303     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 304     assert(this == _real_malloc_address ||
 305            this == align_up(_real_malloc_address, (int)markOopDesc::biased_lock_alignment),
 306            "bug in forced alignment of thread objects");
 307   }
 308 #endif // ASSERT
 309 
 310   // Notify the barrier set that a thread is being created. Note that some
 311   // threads are created before a barrier set is available. The call to
 312   // BarrierSet::on_thread_create() for these threads is therefore deferred
 313   // to BarrierSet::set_barrier_set().
 314   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 315   if (barrier_set != NULL) {
 316     barrier_set-&gt;on_thread_create(this);
 317   } else {
 318     DEBUG_ONLY(Threads::inc_threads_before_barrier_set();)
 319   }
 320 }
 321 
 322 void Thread::initialize_thread_current() {
 323 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 324   assert(_thr_current == NULL, "Thread::current already initialized");
 325   _thr_current = this;
 326 #endif
 327   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 328   ThreadLocalStorage::set_thread(this);
 329   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 330 }
 331 
 332 void Thread::clear_thread_current() {
 333   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 334 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 335   _thr_current = NULL;
 336 #endif
 337   ThreadLocalStorage::set_thread(NULL);
 338 }
 339 
 340 void Thread::record_stack_base_and_size() {
 341   set_stack_base(os::current_stack_base());
 342   set_stack_size(os::current_stack_size());
 343   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 344   // in initialize_thread(). Without the adjustment, stack size is
 345   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 346   // So far, only Solaris has real implementation of initialize_thread().
 347   //
 348   // set up any platform-specific state.
 349   os::initialize_thread(this);
 350 
 351   // Set stack limits after thread is initialized.
 352   if (is_Java_thread()) {
 353     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 354     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 355   }
 356 #if INCLUDE_NMT
 357   // record thread's native stack, stack grows downward
 358   MemTracker::record_thread_stack(stack_end(), stack_size());
 359 #endif // INCLUDE_NMT
 360   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 361     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 362     os::current_thread_id(), p2i(stack_base() - stack_size()),
 363     p2i(stack_base()), stack_size()/1024);
 364 }
 365 
 366 
 367 Thread::~Thread() {
 368   JFR_ONLY(Jfr::on_thread_destruct(this);)
 369 
 370   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 371   // set might not be available if we encountered errors during bootstrapping.
 372   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 373   if (barrier_set != NULL) {
 374     barrier_set-&gt;on_thread_destroy(this);
 375   }
 376 
 377 
 378   // stack_base can be NULL if the thread is never started or exited before
 379   // record_stack_base_and_size called. Although, we would like to ensure
 380   // that all started threads do call record_stack_base_and_size(), there is
 381   // not proper way to enforce that.
 382 #if INCLUDE_NMT
 383   if (_stack_base != NULL) {
 384     MemTracker::release_thread_stack(stack_end(), stack_size());
 385 #ifdef ASSERT
 386     set_stack_base(NULL);
 387 #endif
 388   }
 389 #endif // INCLUDE_NMT
 390 
 391   // deallocate data structures
 392   delete resource_area();
 393   // since the handle marks are using the handle area, we have to deallocated the root
 394   // handle mark before deallocating the thread's handle area,
 395   assert(last_handle_mark() != NULL, "check we have an element");
 396   delete last_handle_mark();
 397   assert(last_handle_mark() == NULL, "check we have reached the end");
 398 
 399   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 400   // We NULL out the fields for good hygiene.
 401   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 402   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 403   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 404   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 405 
 406   delete handle_area();
 407   delete metadata_handles();
 408 
 409   // SR_handler uses this as a termination indicator -
 410   // needs to happen before os::free_thread()
 411   delete _SR_lock;
 412   _SR_lock = NULL;
 413 
 414   // osthread() can be NULL, if creation of thread failed.
 415   if (osthread() != NULL) os::free_thread(osthread());
 416 
 417   // clear Thread::current if thread is deleting itself.
 418   // Needed to ensure JNI correctly detects non-attached threads.
 419   if (this == Thread::current()) {
 420     clear_thread_current();
 421   }
 422 
 423   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 424 }
 425 
 426 // NOTE: dummy function for assertion purpose.
 427 void Thread::run() {
 428   ShouldNotReachHere();
 429 }
 430 
 431 #ifdef ASSERT
 432 // A JavaThread is considered "dangling" if it is not the current
 433 // thread, has been added the Threads list, the system is not at a
 434 // safepoint and the Thread is not "protected".
 435 //
 436 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 437   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 438          !((JavaThread *) thread)-&gt;on_thread_list() ||
 439          SafepointSynchronize::is_at_safepoint() ||
 440          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 441          "possibility of dangling Thread pointer");
 442 }
 443 #endif
 444 
 445 ThreadPriority Thread::get_priority(const Thread* const thread) {
 446   ThreadPriority priority;
 447   // Can return an error!
 448   (void)os::get_priority(thread, priority);
 449   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 450   return priority;
 451 }
 452 
 453 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 454   debug_only(check_for_dangling_thread_pointer(thread);)
 455   // Can return an error!
 456   (void)os::set_priority(thread, priority);
 457 }
 458 
 459 
 460 void Thread::start(Thread* thread) {
 461   // Start is different from resume in that its safety is guaranteed by context or
 462   // being called from a Java method synchronized on the Thread object.
 463   if (!DisableStartThread) {
 464     if (thread-&gt;is_Java_thread()) {
 465       // Initialize the thread state to RUNNABLE before starting this thread.
 466       // Can not set it after the thread started because we do not know the
 467       // exact thread state at that time. It could be in MONITOR_WAIT or
 468       // in SLEEPING or some other state.
 469       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 470                                           java_lang_Thread::RUNNABLE);
 471     }
 472     os::start_thread(thread);
 473   }
 474 }
 475 
 476 // Enqueue a VM_Operation to do the job for us - sometime later
 477 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 478   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 479   VMThread::execute(vm_stop);
 480 }
 481 
 482 
 483 // Check if an external suspend request has completed (or has been
 484 // cancelled). Returns true if the thread is externally suspended and
 485 // false otherwise.
 486 //
 487 // The bits parameter returns information about the code path through
 488 // the routine. Useful for debugging:
 489 //
 490 // set in is_ext_suspend_completed():
 491 // 0x00000001 - routine was entered
 492 // 0x00000010 - routine return false at end
 493 // 0x00000100 - thread exited (return false)
 494 // 0x00000200 - suspend request cancelled (return false)
 495 // 0x00000400 - thread suspended (return true)
 496 // 0x00001000 - thread is in a suspend equivalent state (return true)
 497 // 0x00002000 - thread is native and walkable (return true)
 498 // 0x00004000 - thread is native_trans and walkable (needed retry)
 499 //
 500 // set in wait_for_ext_suspend_completion():
 501 // 0x00010000 - routine was entered
 502 // 0x00020000 - suspend request cancelled before loop (return false)
 503 // 0x00040000 - thread suspended before loop (return true)
 504 // 0x00080000 - suspend request cancelled in loop (return false)
 505 // 0x00100000 - thread suspended in loop (return true)
 506 // 0x00200000 - suspend not completed during retry loop (return false)
 507 
 508 // Helper class for tracing suspend wait debug bits.
 509 //
 510 // 0x00000100 indicates that the target thread exited before it could
 511 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 512 // 0x00080000 each indicate a cancelled suspend request so they don't
 513 // count as wait failures either.
 514 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 515 
 516 class TraceSuspendDebugBits : public StackObj {
 517  private:
 518   JavaThread * jt;
 519   bool         is_wait;
 520   bool         called_by_wait;  // meaningful when !is_wait
 521   uint32_t *   bits;
 522 
 523  public:
 524   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 525                         uint32_t *_bits) {
 526     jt             = _jt;
 527     is_wait        = _is_wait;
 528     called_by_wait = _called_by_wait;
 529     bits           = _bits;
 530   }
 531 
 532   ~TraceSuspendDebugBits() {
 533     if (!is_wait) {
 534 #if 1
 535       // By default, don't trace bits for is_ext_suspend_completed() calls.
 536       // That trace is very chatty.
 537       return;
 538 #else
 539       if (!called_by_wait) {
 540         // If tracing for is_ext_suspend_completed() is enabled, then only
 541         // trace calls to it from wait_for_ext_suspend_completion()
 542         return;
 543       }
 544 #endif
 545     }
 546 
 547     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 548       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 549         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 550         ResourceMark rm;
 551 
 552         tty-&gt;print_cr(
 553                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 554                       jt-&gt;get_thread_name(), *bits);
 555 
 556         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 557       }
 558     }
 559   }
 560 };
 561 #undef DEBUG_FALSE_BITS
 562 
 563 
 564 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 565                                           uint32_t *bits) {
 566   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 567 
 568   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 569   bool do_trans_retry;           // flag to force the retry
 570 
 571   *bits |= 0x00000001;
 572 
 573   do {
 574     do_trans_retry = false;
 575 
 576     if (is_exiting()) {
 577       // Thread is in the process of exiting. This is always checked
 578       // first to reduce the risk of dereferencing a freed JavaThread.
 579       *bits |= 0x00000100;
 580       return false;
 581     }
 582 
 583     if (!is_external_suspend()) {
 584       // Suspend request is cancelled. This is always checked before
 585       // is_ext_suspended() to reduce the risk of a rogue resume
 586       // confusing the thread that made the suspend request.
 587       *bits |= 0x00000200;
 588       return false;
 589     }
 590 
 591     if (is_ext_suspended()) {
 592       // thread is suspended
 593       *bits |= 0x00000400;
 594       return true;
 595     }
 596 
 597     // Now that we no longer do hard suspends of threads running
 598     // native code, the target thread can be changing thread state
 599     // while we are in this routine:
 600     //
 601     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 602     //
 603     // We save a copy of the thread state as observed at this moment
 604     // and make our decision about suspend completeness based on the
 605     // copy. This closes the race where the thread state is seen as
 606     // _thread_in_native_trans in the if-thread_blocked check, but is
 607     // seen as _thread_blocked in if-thread_in_native_trans check.
 608     JavaThreadState save_state = thread_state();
 609 
 610     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 611       // If the thread's state is _thread_blocked and this blocking
 612       // condition is known to be equivalent to a suspend, then we can
 613       // consider the thread to be externally suspended. This means that
 614       // the code that sets _thread_blocked has been modified to do
 615       // self-suspension if the blocking condition releases. We also
 616       // used to check for CONDVAR_WAIT here, but that is now covered by
 617       // the _thread_blocked with self-suspension check.
 618       //
 619       // Return true since we wouldn't be here unless there was still an
 620       // external suspend request.
 621       *bits |= 0x00001000;
 622       return true;
 623     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 624       // Threads running native code will self-suspend on native==&gt;VM/Java
 625       // transitions. If its stack is walkable (should always be the case
 626       // unless this function is called before the actual java_suspend()
 627       // call), then the wait is done.
 628       *bits |= 0x00002000;
 629       return true;
 630     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 631                save_state == _thread_in_native_trans &amp;&amp;
 632                frame_anchor()-&gt;walkable()) {
 633       // The thread is transitioning from thread_in_native to another
 634       // thread state. check_safepoint_and_suspend_for_native_trans()
 635       // will force the thread to self-suspend. If it hasn't gotten
 636       // there yet we may have caught the thread in-between the native
 637       // code check above and the self-suspend. Lucky us. If we were
 638       // called by wait_for_ext_suspend_completion(), then it
 639       // will be doing the retries so we don't have to.
 640       //
 641       // Since we use the saved thread state in the if-statement above,
 642       // there is a chance that the thread has already transitioned to
 643       // _thread_blocked by the time we get here. In that case, we will
 644       // make a single unnecessary pass through the logic below. This
 645       // doesn't hurt anything since we still do the trans retry.
 646 
 647       *bits |= 0x00004000;
 648 
 649       // Once the thread leaves thread_in_native_trans for another
 650       // thread state, we break out of this retry loop. We shouldn't
 651       // need this flag to prevent us from getting back here, but
 652       // sometimes paranoia is good.
 653       did_trans_retry = true;
 654 
 655       // We wait for the thread to transition to a more usable state.
 656       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 657         // We used to do an "os::yield_all(i)" call here with the intention
 658         // that yielding would increase on each retry. However, the parameter
 659         // is ignored on Linux which means the yield didn't scale up. Waiting
 660         // on the SR_lock below provides a much more predictable scale up for
 661         // the delay. It also provides a simple/direct point to check for any
 662         // safepoint requests from the VMThread
 663 
 664         // temporarily drops SR_lock while doing wait with safepoint check
 665         // (if we're a JavaThread - the WatcherThread can also call this)
 666         // and increase delay with each retry
 667         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 668 
 669         // check the actual thread state instead of what we saved above
 670         if (thread_state() != _thread_in_native_trans) {
 671           // the thread has transitioned to another thread state so
 672           // try all the checks (except this one) one more time.
 673           do_trans_retry = true;
 674           break;
 675         }
 676       } // end retry loop
 677 
 678 
 679     }
 680   } while (do_trans_retry);
 681 
 682   *bits |= 0x00000010;
 683   return false;
 684 }
 685 
 686 // Wait for an external suspend request to complete (or be cancelled).
 687 // Returns true if the thread is externally suspended and false otherwise.
 688 //
 689 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 690                                                  uint32_t *bits) {
 691   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 692                              false /* !called_by_wait */, bits);
 693 
 694   // local flag copies to minimize SR_lock hold time
 695   bool is_suspended;
 696   bool pending;
 697   uint32_t reset_bits;
 698 
 699   // set a marker so is_ext_suspend_completed() knows we are the caller
 700   *bits |= 0x00010000;
 701 
 702   // We use reset_bits to reinitialize the bits value at the top of
 703   // each retry loop. This allows the caller to make use of any
 704   // unused bits for their own marking purposes.
 705   reset_bits = *bits;
 706 
 707   {
 708     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 709     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 710                                             delay, bits);
 711     pending = is_external_suspend();
 712   }
 713   // must release SR_lock to allow suspension to complete
 714 
 715   if (!pending) {
 716     // A cancelled suspend request is the only false return from
 717     // is_ext_suspend_completed() that keeps us from entering the
 718     // retry loop.
 719     *bits |= 0x00020000;
 720     return false;
 721   }
 722 
 723   if (is_suspended) {
 724     *bits |= 0x00040000;
 725     return true;
 726   }
 727 
 728   for (int i = 1; i &lt;= retries; i++) {
 729     *bits = reset_bits;  // reinit to only track last retry
 730 
 731     // We used to do an "os::yield_all(i)" call here with the intention
 732     // that yielding would increase on each retry. However, the parameter
 733     // is ignored on Linux which means the yield didn't scale up. Waiting
 734     // on the SR_lock below provides a much more predictable scale up for
 735     // the delay. It also provides a simple/direct point to check for any
 736     // safepoint requests from the VMThread
 737 
 738     {
 739       MutexLocker ml(SR_lock());
 740       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 741       // can also call this)  and increase delay with each retry
 742       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 743 
 744       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 745                                               delay, bits);
 746 
 747       // It is possible for the external suspend request to be cancelled
 748       // (by a resume) before the actual suspend operation is completed.
 749       // Refresh our local copy to see if we still need to wait.
 750       pending = is_external_suspend();
 751     }
 752 
 753     if (!pending) {
 754       // A cancelled suspend request is the only false return from
 755       // is_ext_suspend_completed() that keeps us from staying in the
 756       // retry loop.
 757       *bits |= 0x00080000;
 758       return false;
 759     }
 760 
 761     if (is_suspended) {
 762       *bits |= 0x00100000;
 763       return true;
 764     }
 765   } // end retry loop
 766 
 767   // thread did not suspend after all our retries
 768   *bits |= 0x00200000;
 769   return false;
 770 }
 771 
 772 // Called from API entry points which perform stack walking. If the
 773 // associated JavaThread is the current thread, then wait_for_suspend
 774 // is not used. Otherwise, it determines if we should wait for the
 775 // "other" thread to complete external suspension. (NOTE: in future
 776 // releases the suspension mechanism should be reimplemented so this
 777 // is not necessary.)
 778 //
 779 bool
 780 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 781   if (this != JavaThread::current()) {
 782     // "other" threads require special handling.
 783     if (wait_for_suspend) {
 784       // We are allowed to wait for the external suspend to complete
 785       // so give the other thread a chance to get suspended.
 786       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 787                                            SuspendRetryDelay, bits)) {
 788         // Didn't make it so let the caller know.
 789         return false;
 790       }
 791     }
 792     // We aren't allowed to wait for the external suspend to complete
 793     // so if the other thread isn't externally suspended we need to
 794     // let the caller know.
 795     else if (!is_ext_suspend_completed_with_lock(bits)) {
 796       return false;
 797     }
 798   }
 799 
 800   return true;
 801 }
 802 
 803 #ifndef PRODUCT
 804 void JavaThread::record_jump(address target, address instr, const char* file,
 805                              int line) {
 806 
 807   // This should not need to be atomic as the only way for simultaneous
 808   // updates is via interrupts. Even then this should be rare or non-existent
 809   // and we don't care that much anyway.
 810 
 811   int index = _jmp_ring_index;
 812   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 813   _jmp_ring[index]._target = (intptr_t) target;
 814   _jmp_ring[index]._instruction = (intptr_t) instr;
 815   _jmp_ring[index]._file = file;
 816   _jmp_ring[index]._line = line;
 817 }
 818 #endif // PRODUCT
 819 
 820 void Thread::interrupt(Thread* thread) {
 821   debug_only(check_for_dangling_thread_pointer(thread);)
 822   os::interrupt(thread);
 823 }
 824 
 825 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 826   debug_only(check_for_dangling_thread_pointer(thread);)
 827   // Note:  If clear_interrupted==false, this simply fetches and
 828   // returns the value of the field osthread()-&gt;interrupted().
 829   return os::is_interrupted(thread, clear_interrupted);
 830 }
 831 
 832 
 833 // GC Support
 834 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 835   int thread_parity = _oops_do_parity;
 836   if (thread_parity != strong_roots_parity) {
 837     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 838     if (res == thread_parity) {
 839       return true;
 840     } else {
 841       guarantee(res == strong_roots_parity, "Or else what?");
 842       return false;
 843     }
 844   }
 845   return false;
 846 }
 847 
 848 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 849   active_handles()-&gt;oops_do(f);
 850   // Do oop for ThreadShadow
 851   f-&gt;do_oop((oop*)&amp;_pending_exception);
 852   handle_area()-&gt;oops_do(f);
 853 
 854   if (MonitorInUseLists) {
 855     // When using thread local monitor lists, we scan them here,
 856     // and the remaining global monitors in ObjectSynchronizer::oops_do().
 857     ObjectSynchronizer::thread_local_used_oops_do(this, f);
 858   }
 859 }
 860 
 861 void Thread::metadata_handles_do(void f(Metadata*)) {
 862   // Only walk the Handles in Thread.
 863   if (metadata_handles() != NULL) {
 864     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 865       f(metadata_handles()-&gt;at(i));
 866     }
 867   }
 868 }
 869 
 870 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 871   // get_priority assumes osthread initialized
 872   if (osthread() != NULL) {
 873     int os_prio;
 874     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 875       st-&gt;print("os_prio=%d ", os_prio);
 876     }
 877 
 878     st-&gt;print("cpu=%.2fms ",
 879               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 880               );
 881     st-&gt;print("elapsed=%.2fs ",
 882               _statistical_info.getElapsedTime() / 1000.0
 883               );
 884     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 885       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 886       st-&gt;print("allocated=" SIZE_FORMAT "%s ",
 887                 byte_size_in_proper_unit(allocated_bytes),
 888                 proper_unit_for_byte_size(allocated_bytes)
 889                 );
 890       st-&gt;print("defined_classes=" INT64_FORMAT " ", _statistical_info.getDefineClassCount());
 891     }
 892 
 893     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 894     osthread()-&gt;print_on(st);
 895   }
 896   ThreadsSMRSupport::print_info_on(this, st);
 897   st-&gt;print(" ");
 898   debug_only(if (WizardMode) print_owned_locks_on(st);)
 899 }
 900 
 901 // Thread::print_on_error() is called by fatal error handler. Don't use
 902 // any lock or allocate memory.
 903 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 904   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 905 
 906   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 907   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 908   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 909   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 910   else                                { st-&gt;print("Thread"); }
 911 
 912   if (is_Named_thread()) {
 913     st-&gt;print(" \"%s\"", name());
 914   }
 915 
 916   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 917             p2i(stack_end()), p2i(stack_base()));
 918 
 919   if (osthread()) {
 920     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 921   }
 922 
 923   ThreadsSMRSupport::print_info_on(this, st);
 924 }
 925 
 926 void Thread::print_value_on(outputStream* st) const {
 927   if (is_Named_thread()) {
 928     st-&gt;print(" \"%s\" ", name());
 929   }
 930   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 931 }
 932 
 933 #ifdef ASSERT
 934 void Thread::print_owned_locks_on(outputStream* st) const {
 935   Monitor *cur = _owned_locks;
 936   if (cur == NULL) {
 937     st-&gt;print(" (no locks) ");
 938   } else {
 939     st-&gt;print_cr(" Locks owned:");
 940     while (cur) {
 941       cur-&gt;print_on(st);
 942       cur = cur-&gt;next();
 943     }
 944   }
 945 }
 946 
 947 static int ref_use_count  = 0;
 948 
 949 bool Thread::owns_locks_but_compiled_lock() const {
 950   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 951     if (cur != Compile_lock) return true;
 952   }
 953   return false;
 954 }
 955 
 956 
 957 #endif
 958 
 959 #ifndef PRODUCT
 960 
 961 // The flag: potential_vm_operation notifies if this particular safepoint state could potentially
 962 // invoke the vm-thread (e.g., an oop allocation). In that case, we also have to make sure that
 963 // no locks which allow_vm_block's are held
 964 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 965   // Check if current thread is allowed to block at a safepoint
 966   if (!(_allow_safepoint_count == 0)) {
 967     fatal("Possible safepoint reached by thread that does not allow it");
 968   }
 969   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 970     fatal("LEAF method calling lock?");
 971   }
 972 
 973 #ifdef ASSERT
 974   if (potential_vm_operation &amp;&amp; is_Java_thread()
 975       &amp;&amp; !Universe::is_bootstrapping()) {
 976     // Make sure we do not hold any locks that the VM thread also uses.
 977     // This could potentially lead to deadlocks
 978     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 979       // Threads_lock is special, since the safepoint synchronization will not start before this is
 980       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 981       // since it is used to transfer control between JavaThreads and the VMThread
 982       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 983       if ((cur-&gt;allow_vm_block() &amp;&amp;
 984            cur != Threads_lock &amp;&amp;
 985            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 986            cur != VMOperationRequest_lock &amp;&amp;
 987            cur != VMOperationQueue_lock) ||
 988            cur-&gt;rank() == Mutex::special) {
 989         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 990       }
 991     }
 992   }
 993 
 994   if (GCALotAtAllSafepoints) {
 995     // We could enter a safepoint here and thus have a gc
 996     InterfaceSupport::check_gc_alot();
 997   }
 998 #endif
 999 }
1000 #endif
1001 
1002 bool Thread::is_in_stack(address adr) const {
1003   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
1004   address end = os::current_stack_pointer();
1005   // Allow non Java threads to call this without stack_base
1006   if (_stack_base == NULL) return true;
1007   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
1008 
1009   return false;
1010 }
1011 
1012 bool Thread::is_in_usable_stack(address adr) const {
1013   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
1014   size_t usable_stack_size = _stack_size - stack_guard_size;
1015 
1016   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
1017 }
1018 
1019 
1020 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1021 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1022 // used for compilation in the future. If that change is made, the need for these methods
1023 // should be revisited, and they should be removed if possible.
1024 
1025 bool Thread::is_lock_owned(address adr) const {
1026   return on_local_stack(adr);
1027 }
1028 
1029 bool Thread::set_as_starting_thread() {
1030   // NOTE: this must be called inside the main thread.
1031   return os::create_main_thread((JavaThread*)this);
1032 }
1033 
1034 static void initialize_class(Symbol* class_name, TRAPS) {
1035   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1036   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1037 }
1038 
1039 
1040 // Creates the initial ThreadGroup
1041 static Handle create_initial_thread_group(TRAPS) {
1042   Handle system_instance = JavaCalls::construct_new_instance(
1043                             SystemDictionary::ThreadGroup_klass(),
1044                             vmSymbols::void_method_signature(),
1045                             CHECK_NH);
1046   Universe::set_system_thread_group(system_instance());
1047 
1048   Handle string = java_lang_String::create_from_str("main", CHECK_NH);
1049   Handle main_instance = JavaCalls::construct_new_instance(
1050                             SystemDictionary::ThreadGroup_klass(),
1051                             vmSymbols::threadgroup_string_void_signature(),
1052                             system_instance,
1053                             string,
1054                             CHECK_NH);
1055   return main_instance;
1056 }
1057 
1058 // Creates the initial Thread
1059 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1060                                  TRAPS) {
1061   InstanceKlass* ik = SystemDictionary::Thread_klass();
1062   assert(ik-&gt;is_initialized(), "must be");
1063   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1064 
1065   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1066   // constructor calls Thread.current(), which must be set here for the
1067   // initial thread.
1068   java_lang_Thread::set_thread(thread_oop(), thread);
1069   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1070   thread-&gt;set_threadObj(thread_oop());
1071 
1072   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
1073 
1074   JavaValue result(T_VOID);
1075   JavaCalls::call_special(&amp;result, thread_oop,
1076                           ik,
1077                           vmSymbols::object_initializer_name(),
1078                           vmSymbols::threadgroup_string_void_signature(),
1079                           thread_group,
1080                           string,
1081                           CHECK_NULL);
1082   return thread_oop();
1083 }
1084 
1085 char java_runtime_name[128] = "";
1086 char java_runtime_version[128] = "";
1087 
1088 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1089 static const char* get_java_runtime_name(TRAPS) {
1090   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1091                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1092   fieldDescriptor fd;
1093   bool found = k != NULL &amp;&amp;
1094                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1095                                                         vmSymbols::string_signature(), &amp;fd);
1096   if (found) {
1097     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1098     if (name_oop == NULL) {
1099       return NULL;
1100     }
1101     const char* name = java_lang_String::as_utf8_string(name_oop,
1102                                                         java_runtime_name,
1103                                                         sizeof(java_runtime_name));
1104     return name;
1105   } else {
1106     return NULL;
1107   }
1108 }
1109 
1110 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1111 static const char* get_java_runtime_version(TRAPS) {
1112   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1113                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1114   fieldDescriptor fd;
1115   bool found = k != NULL &amp;&amp;
1116                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1117                                                         vmSymbols::string_signature(), &amp;fd);
1118   if (found) {
1119     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1120     if (name_oop == NULL) {
1121       return NULL;
1122     }
1123     const char* name = java_lang_String::as_utf8_string(name_oop,
1124                                                         java_runtime_version,
1125                                                         sizeof(java_runtime_version));
1126     return name;
1127   } else {
1128     return NULL;
1129   }
1130 }
1131 
1132 // General purpose hook into Java code, run once when the VM is initialized.
1133 // The Java library method itself may be changed independently from the VM.
1134 static void call_postVMInitHook(TRAPS) {
1135   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1136   if (klass != NULL) {
1137     JavaValue result(T_VOID);
1138     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1139                            vmSymbols::void_method_signature(),
1140                            CHECK);
1141   }
1142 }
1143 
1144 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1145                                     bool daemon, TRAPS) {
1146   assert(thread_group.not_null(), "thread group should be specified");
1147   assert(threadObj() == NULL, "should only create Java thread object once");
1148 
1149   InstanceKlass* ik = SystemDictionary::Thread_klass();
1150   assert(ik-&gt;is_initialized(), "must be");
1151   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1152 
1153   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1154   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1155   // constructor calls Thread.current(), which must be set here.
1156   java_lang_Thread::set_thread(thread_oop(), this);
1157   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1158   set_threadObj(thread_oop());
1159 
1160   JavaValue result(T_VOID);
1161   if (thread_name != NULL) {
1162     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1163     // Thread gets assigned specified name and null target
1164     JavaCalls::call_special(&amp;result,
1165                             thread_oop,
1166                             ik,
1167                             vmSymbols::object_initializer_name(),
1168                             vmSymbols::threadgroup_string_void_signature(),
1169                             thread_group,
1170                             name,
1171                             THREAD);
1172   } else {
1173     // Thread gets assigned name "Thread-nnn" and null target
1174     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1175     JavaCalls::call_special(&amp;result,
1176                             thread_oop,
1177                             ik,
1178                             vmSymbols::object_initializer_name(),
1179                             vmSymbols::threadgroup_runnable_void_signature(),
1180                             thread_group,
1181                             Handle(),
1182                             THREAD);
1183   }
1184 
1185 
1186   if (daemon) {
1187     java_lang_Thread::set_daemon(thread_oop());
1188   }
1189 
1190   if (HAS_PENDING_EXCEPTION) {
1191     return;
1192   }
1193 
1194   Klass* group =  SystemDictionary::ThreadGroup_klass();
1195   Handle threadObj(THREAD, this-&gt;threadObj());
1196 
1197   JavaCalls::call_special(&amp;result,
1198                           thread_group,
1199                           group,
1200                           vmSymbols::add_method_name(),
1201                           vmSymbols::thread_void_signature(),
1202                           threadObj,          // Arg 1
1203                           THREAD);
1204 }
1205 
1206 // List of all NonJavaThreads and safe iteration over that list.
1207 
1208 class NonJavaThread::List {
1209 public:
1210   NonJavaThread* volatile _head;
1211   SingleWriterSynchronizer _protect;
1212 
1213   List() : _head(NULL), _protect() {}
1214 };
1215 
1216 NonJavaThread::List NonJavaThread::_the_list;
1217 
1218 NonJavaThread::Iterator::Iterator() :
1219   _protect_enter(_the_list._protect.enter()),
1220   _current(OrderAccess::load_acquire(&amp;_the_list._head))
1221 {}
1222 
1223 NonJavaThread::Iterator::~Iterator() {
1224   _the_list._protect.exit(_protect_enter);
1225 }
1226 
1227 void NonJavaThread::Iterator::step() {
1228   assert(!end(), "precondition");
1229   _current = OrderAccess::load_acquire(&amp;_current-&gt;_next);
1230 }
1231 
1232 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1233   // Add this thread to _the_list.
1234   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1235   _next = _the_list._head;
1236   OrderAccess::release_store(&amp;_the_list._head, this);
1237 }
1238 
1239 NonJavaThread::~NonJavaThread() {
1240   // Remove this thread from _the_list.
1241   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1242   NonJavaThread* volatile* p = &amp;_the_list._head;
1243   for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1244     if (t == this) {
1245       *p = this-&gt;_next;
1246       // Wait for any in-progress iterators.
1247       _the_list._protect.synchronize();
1248       break;
1249     }
1250   }
1251 }
1252 
1253 // NamedThread --  non-JavaThread subclasses with multiple
1254 // uniquely named instances should derive from this.
1255 NamedThread::NamedThread() :
1256   NonJavaThread(),
1257   _name(NULL),
1258   _processed_thread(NULL),
1259   _gc_id(GCId::undefined())
1260 {}
1261 
1262 NamedThread::~NamedThread() {
1263   if (_name != NULL) {
1264     FREE_C_HEAP_ARRAY(char, _name);
1265     _name = NULL;
1266   }
1267 }
1268 
1269 void NamedThread::set_name(const char* format, ...) {
1270   guarantee(_name == NULL, "Only get to set name once.");
1271   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1272   guarantee(_name != NULL, "alloc failure");
1273   va_list ap;
1274   va_start(ap, format);
1275   jio_vsnprintf(_name, max_name_len, format, ap);
1276   va_end(ap);
1277 }
1278 
1279 void NamedThread::initialize_named_thread() {
1280   set_native_thread_name(name());
1281 }
1282 
1283 void NamedThread::print_on(outputStream* st) const {
1284   st-&gt;print("\"%s\" ", name());
1285   Thread::print_on(st);
1286   st-&gt;cr();
1287 }
1288 
1289 
1290 // ======= WatcherThread ========
1291 
1292 // The watcher thread exists to simulate timer interrupts.  It should
1293 // be replaced by an abstraction over whatever native support for
1294 // timer interrupts exists on the platform.
1295 
1296 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1297 bool WatcherThread::_startable = false;
1298 volatile bool  WatcherThread::_should_terminate = false;
1299 
1300 WatcherThread::WatcherThread() : NonJavaThread() {
1301   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1302   if (os::create_thread(this, os::watcher_thread)) {
1303     _watcher_thread = this;
1304 
1305     // Set the watcher thread to the highest OS priority which should not be
1306     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1307     // is created. The only normal thread using this priority is the reference
1308     // handler thread, which runs for very short intervals only.
1309     // If the VMThread's priority is not lower than the WatcherThread profiling
1310     // will be inaccurate.
1311     os::set_priority(this, MaxPriority);
1312     if (!DisableStartThread) {
1313       os::start_thread(this);
1314     }
1315   }
1316 }
1317 
1318 int WatcherThread::sleep() const {
1319   // The WatcherThread does not participate in the safepoint protocol
1320   // for the PeriodicTask_lock because it is not a JavaThread.
1321   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1322 
1323   if (_should_terminate) {
1324     // check for termination before we do any housekeeping or wait
1325     return 0;  // we did not sleep.
1326   }
1327 
1328   // remaining will be zero if there are no tasks,
1329   // causing the WatcherThread to sleep until a task is
1330   // enrolled
1331   int remaining = PeriodicTask::time_to_wait();
1332   int time_slept = 0;
1333 
1334   // we expect this to timeout - we only ever get unparked when
1335   // we should terminate or when a new task has been enrolled
1336   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1337 
1338   jlong time_before_loop = os::javaTimeNanos();
1339 
1340   while (true) {
1341     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1342                                             remaining);
1343     jlong now = os::javaTimeNanos();
1344 
1345     if (remaining == 0) {
1346       // if we didn't have any tasks we could have waited for a long time
1347       // consider the time_slept zero and reset time_before_loop
1348       time_slept = 0;
1349       time_before_loop = now;
1350     } else {
1351       // need to recalculate since we might have new tasks in _tasks
1352       time_slept = (int) ((now - time_before_loop) / 1000000);
1353     }
1354 
1355     // Change to task list or spurious wakeup of some kind
1356     if (timedout || _should_terminate) {
1357       break;
1358     }
1359 
1360     remaining = PeriodicTask::time_to_wait();
1361     if (remaining == 0) {
1362       // Last task was just disenrolled so loop around and wait until
1363       // another task gets enrolled
1364       continue;
1365     }
1366 
1367     remaining -= time_slept;
1368     if (remaining &lt;= 0) {
1369       break;
1370     }
1371   }
1372 
1373   return time_slept;
1374 }
1375 
1376 void WatcherThread::run() {
1377   assert(this == watcher_thread(), "just checking");
1378 
1379   this-&gt;record_stack_base_and_size();
1380   this-&gt;set_native_thread_name(this-&gt;name());
1381   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1382   while (true) {
1383     assert(watcher_thread() == Thread::current(), "thread consistency check");
1384     assert(watcher_thread() == this, "thread consistency check");
1385 
1386     // Calculate how long it'll be until the next PeriodicTask work
1387     // should be done, and sleep that amount of time.
1388     int time_waited = sleep();
1389 
1390     if (VMError::is_error_reported()) {
1391       // A fatal error has happened, the error handler(VMError::report_and_die)
1392       // should abort JVM after creating an error log file. However in some
1393       // rare cases, the error handler itself might deadlock. Here periodically
1394       // check for error reporting timeouts, and if it happens, just proceed to
1395       // abort the VM.
1396 
1397       // This code is in WatcherThread because WatcherThread wakes up
1398       // periodically so the fatal error handler doesn't need to do anything;
1399       // also because the WatcherThread is less likely to crash than other
1400       // threads.
1401 
1402       for (;;) {
1403         // Note: we use naked sleep in this loop because we want to avoid using
1404         // any kind of VM infrastructure which may be broken at this point.
1405         if (VMError::check_timeout()) {
1406           // We hit error reporting timeout. Error reporting was interrupted and
1407           // will be wrapping things up now (closing files etc). Give it some more
1408           // time, then quit the VM.
1409           os::naked_short_sleep(200);
1410           // Print a message to stderr.
1411           fdStream err(defaultStream::output_fd());
1412           err.print_raw_cr("# [ timer expired, abort... ]");
1413           // skip atexit/vm_exit/vm_abort hooks
1414           os::die();
1415         }
1416 
1417         // Wait a second, then recheck for timeout.
1418         os::naked_short_sleep(999);
1419       }
1420     }
1421 
1422     if (_should_terminate) {
1423       // check for termination before posting the next tick
1424       break;
1425     }
1426 
1427     PeriodicTask::real_time_tick(time_waited);
1428   }
1429 
1430   // Signal that it is terminated
1431   {
1432     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1433     _watcher_thread = NULL;
1434     Terminator_lock-&gt;notify();
1435   }
1436 }
1437 
1438 void WatcherThread::start() {
1439   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1440 
1441   if (watcher_thread() == NULL &amp;&amp; _startable) {
1442     _should_terminate = false;
1443     // Create the single instance of WatcherThread
1444     new WatcherThread();
1445   }
1446 }
1447 
1448 void WatcherThread::make_startable() {
1449   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1450   _startable = true;
1451 }
1452 
1453 void WatcherThread::stop() {
1454   {
1455     // Follow normal safepoint aware lock enter protocol since the
1456     // WatcherThread is stopped by another JavaThread.
1457     MutexLocker ml(PeriodicTask_lock);
1458     _should_terminate = true;
1459 
1460     WatcherThread* watcher = watcher_thread();
1461     if (watcher != NULL) {
1462       // unpark the WatcherThread so it can see that it should terminate
1463       watcher-&gt;unpark();
1464     }
1465   }
1466 
1467   MutexLocker mu(Terminator_lock);
1468 
1469   while (watcher_thread() != NULL) {
1470     // This wait should make safepoint checks, wait without a timeout,
1471     // and wait as a suspend-equivalent condition.
1472     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1473                           Mutex::_as_suspend_equivalent_flag);
1474   }
1475 }
1476 
1477 void WatcherThread::unpark() {
1478   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1479   PeriodicTask_lock-&gt;notify();
1480 }
1481 
1482 void WatcherThread::print_on(outputStream* st) const {
1483   st-&gt;print("\"%s\" ", name());
1484   Thread::print_on(st);
1485   st-&gt;cr();
1486 }
1487 
1488 // ======= JavaThread ========
1489 
1490 #if INCLUDE_JVMCI
1491 
1492 jlong* JavaThread::_jvmci_old_thread_counters;
1493 
1494 bool jvmci_counters_include(JavaThread* thread) {
1495   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1496 }
1497 
1498 void JavaThread::collect_counters(typeArrayOop array) {
1499   if (JVMCICounterSize &gt; 0) {
1500     JavaThreadIteratorWithHandle jtiwh;
1501     for (int i = 0; i &lt; array-&gt;length(); i++) {
1502       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1503     }
1504     for (; JavaThread *tp = jtiwh.next(); ) {
1505       if (jvmci_counters_include(tp)) {
1506         for (int i = 0; i &lt; array-&gt;length(); i++) {
1507           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1508         }
1509       }
1510     }
1511   }
1512 }
1513 
1514 #endif // INCLUDE_JVMCI
1515 
1516 // A JavaThread is a normal Java thread
1517 
1518 void JavaThread::initialize() {
1519   // Initialize fields
1520 
1521   set_saved_exception_pc(NULL);
1522   set_threadObj(NULL);
1523   _anchor.clear();
1524   set_entry_point(NULL);
1525   set_jni_functions(jni_functions());
1526   set_callee_target(NULL);
1527   set_vm_result(NULL);
1528   set_vm_result_2(NULL);
1529   set_vframe_array_head(NULL);
1530   set_vframe_array_last(NULL);
1531   set_deferred_locals(NULL);
1532   set_deopt_mark(NULL);
1533   set_deopt_compiled_method(NULL);
1534   clear_must_deopt_id();
1535   set_monitor_chunks(NULL);
1536   set_next(NULL);
1537   _on_thread_list = false;
1538   set_thread_state(_thread_new);
1539   _terminated = _not_terminated;
1540   _privileged_stack_top = NULL;
1541   _array_for_gc = NULL;
1542   _suspend_equivalent = false;
1543   _in_deopt_handler = 0;
1544   _doing_unsafe_access = false;
1545   _stack_guard_state = stack_guard_unused;
1546 #if INCLUDE_JVMCI
1547   _pending_monitorenter = false;
1548   _pending_deoptimization = -1;
1549   _pending_failed_speculation = 0;
1550   _pending_transfer_to_interpreter = false;
1551   _adjusting_comp_level = false;
<a name="1" id="anc1"></a>
1552   _jvmci._alternate_call_target = NULL;
1553   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1554   if (JVMCICounterSize &gt; 0) {
1555     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1556     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1557   } else {
1558     _jvmci_counters = NULL;
1559   }
1560 #endif // INCLUDE_JVMCI
1561   _reserved_stack_activation = NULL;  // stack base not known yet
1562   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1563   _exception_pc  = 0;
1564   _exception_handler_pc = 0;
1565   _is_method_handle_return = 0;
1566   _jvmti_thread_state= NULL;
1567   _should_post_on_exceptions_flag = JNI_FALSE;
1568   _interp_only_mode    = 0;
1569   _special_runtime_exit_condition = _no_async_condition;
1570   _pending_async_exception = NULL;
1571   _thread_stat = NULL;
1572   _thread_stat = new ThreadStatistics();
1573   _blocked_on_compilation = false;
1574   _jni_active_critical = 0;
1575   _pending_jni_exception_check_fn = NULL;
1576   _do_not_unlock_if_synchronized = false;
1577   _cached_monitor_info = NULL;
1578   _parker = Parker::Allocate(this);
1579 
1580 #ifndef PRODUCT
1581   _jmp_ring_index = 0;
1582   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1583     record_jump(NULL, NULL, NULL, 0);
1584   }
1585 #endif // PRODUCT
1586 
1587   // Setup safepoint state info for this thread
1588   ThreadSafepointState::create(this);
1589 
1590   debug_only(_java_call_counter = 0);
1591 
1592   // JVMTI PopFrame support
1593   _popframe_condition = popframe_inactive;
1594   _popframe_preserved_args = NULL;
1595   _popframe_preserved_args_size = 0;
1596   _frames_to_pop_failed_realloc = 0;
1597 
1598   if (SafepointMechanism::uses_thread_local_poll()) {
1599     SafepointMechanism::initialize_header(this);
1600   }
1601 
1602   pd_initialize();
1603 }
1604 
1605 JavaThread::JavaThread(bool is_attaching_via_jni) :
1606                        Thread() {
1607   initialize();
1608   if (is_attaching_via_jni) {
1609     _jni_attach_state = _attaching_via_jni;
1610   } else {
1611     _jni_attach_state = _not_attaching_via_jni;
1612   }
1613   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1614 }
1615 
1616 bool JavaThread::reguard_stack(address cur_sp) {
1617   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1618       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1619     return true; // Stack already guarded or guard pages not needed.
1620   }
1621 
1622   if (register_stack_overflow()) {
1623     // For those architectures which have separate register and
1624     // memory stacks, we must check the register stack to see if
1625     // it has overflowed.
1626     return false;
1627   }
1628 
1629   // Java code never executes within the yellow zone: the latter is only
1630   // there to provoke an exception during stack banging.  If java code
1631   // is executing there, either StackShadowPages should be larger, or
1632   // some exception code in c1, c2 or the interpreter isn't unwinding
1633   // when it should.
1634   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1635             "not enough space to reguard - increase StackShadowPages");
1636   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1637     enable_stack_yellow_reserved_zone();
1638     if (reserved_stack_activation() != stack_base()) {
1639       set_reserved_stack_activation(stack_base());
1640     }
1641   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1642     set_reserved_stack_activation(stack_base());
1643     enable_stack_reserved_zone();
1644   }
1645   return true;
1646 }
1647 
1648 bool JavaThread::reguard_stack(void) {
1649   return reguard_stack(os::current_stack_pointer());
1650 }
1651 
1652 
1653 void JavaThread::block_if_vm_exited() {
1654   if (_terminated == _vm_exited) {
1655     // _vm_exited is set at safepoint, and Threads_lock is never released
1656     // we will block here forever
1657     Threads_lock-&gt;lock_without_safepoint_check();
1658     ShouldNotReachHere();
1659   }
1660 }
1661 
1662 
1663 // Remove this ifdef when C1 is ported to the compiler interface.
1664 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1665 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1666 
1667 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1668                        Thread() {
1669   initialize();
1670   _jni_attach_state = _not_attaching_via_jni;
1671   set_entry_point(entry_point);
1672   // Create the native thread itself.
1673   // %note runtime_23
1674   os::ThreadType thr_type = os::java_thread;
1675   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1676                                                      os::java_thread;
1677   os::create_thread(this, thr_type, stack_sz);
1678   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1679   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1680   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1681   // the exception consists of creating the exception object &amp; initializing it, initialization
1682   // will leave the VM via a JavaCall and then all locks must be unlocked).
1683   //
1684   // The thread is still suspended when we reach here. Thread must be explicit started
1685   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1686   // by calling Threads:add. The reason why this is not done here, is because the thread
1687   // object must be fully initialized (take a look at JVM_Start)
1688 }
1689 
1690 JavaThread::~JavaThread() {
1691 
1692   // JSR166 -- return the parker to the free list
1693   Parker::Release(_parker);
1694   _parker = NULL;
1695 
1696   // Free any remaining  previous UnrollBlock
1697   vframeArray* old_array = vframe_array_last();
1698 
1699   if (old_array != NULL) {
1700     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1701     old_array-&gt;set_unroll_block(NULL);
1702     delete old_info;
1703     delete old_array;
1704   }
1705 
1706   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1707   if (deferred != NULL) {
1708     // This can only happen if thread is destroyed before deoptimization occurs.
1709     assert(deferred-&gt;length() != 0, "empty array!");
1710     do {
1711       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1712       deferred-&gt;remove_at(0);
1713       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1714       delete dlv;
1715     } while (deferred-&gt;length() != 0);
1716     delete deferred;
1717   }
1718 
1719   // All Java related clean up happens in exit
1720   ThreadSafepointState::destroy(this);
1721   if (_thread_stat != NULL) delete _thread_stat;
1722 
1723 #if INCLUDE_JVMCI
1724   if (JVMCICounterSize &gt; 0) {
1725     if (jvmci_counters_include(this)) {
1726       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1727         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1728       }
1729     }
1730     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1731   }
1732 #endif // INCLUDE_JVMCI
1733 }
1734 
1735 
1736 // The first routine called by a new Java thread
1737 void JavaThread::run() {
1738   // initialize thread-local alloc buffer related fields
1739   this-&gt;initialize_tlab();
1740 
1741   // used to test validity of stack trace backs
1742   this-&gt;record_base_of_stack_pointer();
1743 
1744   // Record real stack base and size.
1745   this-&gt;record_stack_base_and_size();
1746 
1747   this-&gt;create_stack_guard_pages();
1748 
1749   this-&gt;cache_global_variables();
1750 
1751   // Thread is now sufficient initialized to be handled by the safepoint code as being
1752   // in the VM. Change thread state from _thread_new to _thread_in_vm
1753   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1754 
1755   assert(JavaThread::current() == this, "sanity check");
1756   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1757 
1758   DTRACE_THREAD_PROBE(start, this);
1759 
1760   // This operation might block. We call that after all safepoint checks for a new thread has
1761   // been completed.
1762   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1763 
1764   if (JvmtiExport::should_post_thread_life()) {
1765     JvmtiExport::post_thread_start(this);
1766   }
1767 
1768   EventThreadStart event;
1769   if (event.should_commit()) {
1770     event.set_thread(JFR_THREAD_ID(this));
1771     event.commit();
1772   }
1773 
1774   // We call another function to do the rest so we are sure that the stack addresses used
1775   // from there will be lower than the stack base just computed
1776   thread_main_inner();
1777 
1778   // Note, thread is no longer valid at this point!
1779 }
1780 
1781 
1782 void JavaThread::thread_main_inner() {
1783   assert(JavaThread::current() == this, "sanity check");
1784   assert(this-&gt;threadObj() != NULL, "just checking");
1785 
1786   // Execute thread entry point unless this thread has a pending exception
1787   // or has been stopped before starting.
1788   // Note: Due to JVM_StopThread we can have pending exceptions already!
1789   if (!this-&gt;has_pending_exception() &amp;&amp;
1790       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1791     {
1792       ResourceMark rm(this);
1793       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1794     }
1795     HandleMark hm(this);
1796     this-&gt;entry_point()(this, this);
1797   }
1798 
1799   DTRACE_THREAD_PROBE(stop, this);
1800 
1801   this-&gt;exit(false);
1802   this-&gt;smr_delete();
1803 }
1804 
1805 
1806 static void ensure_join(JavaThread* thread) {
1807   // We do not need to grab the Threads_lock, since we are operating on ourself.
1808   Handle threadObj(thread, thread-&gt;threadObj());
1809   assert(threadObj.not_null(), "java thread object must exist");
1810   ObjectLocker lock(threadObj, thread);
1811   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1812   thread-&gt;clear_pending_exception();
1813   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1814   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1815   // Clear the native thread instance - this makes isAlive return false and allows the join()
1816   // to complete once we've done the notify_all below
1817   java_lang_Thread::set_thread(threadObj(), NULL);
1818   lock.notify_all(thread);
1819   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1820   thread-&gt;clear_pending_exception();
1821 }
1822 
1823 
1824 // For any new cleanup additions, please check to see if they need to be applied to
1825 // cleanup_failed_attach_current_thread as well.
1826 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1827   assert(this == JavaThread::current(), "thread consistency check");
1828 
1829   elapsedTimer _timer_exit_phase1;
1830   elapsedTimer _timer_exit_phase2;
1831   elapsedTimer _timer_exit_phase3;
1832   elapsedTimer _timer_exit_phase4;
1833 
1834   if (log_is_enabled(Debug, os, thread, timer)) {
1835     _timer_exit_phase1.start();
1836   }
1837 
1838   HandleMark hm(this);
1839   Handle uncaught_exception(this, this-&gt;pending_exception());
1840   this-&gt;clear_pending_exception();
1841   Handle threadObj(this, this-&gt;threadObj());
1842   assert(threadObj.not_null(), "Java thread object should be created");
1843 
1844   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1845   {
1846     EXCEPTION_MARK;
1847 
1848     CLEAR_PENDING_EXCEPTION;
1849   }
1850   if (!destroy_vm) {
1851     if (uncaught_exception.not_null()) {
1852       EXCEPTION_MARK;
1853       // Call method Thread.dispatchUncaughtException().
1854       Klass* thread_klass = SystemDictionary::Thread_klass();
1855       JavaValue result(T_VOID);
1856       JavaCalls::call_virtual(&amp;result,
1857                               threadObj, thread_klass,
1858                               vmSymbols::dispatchUncaughtException_name(),
1859                               vmSymbols::throwable_void_signature(),
1860                               uncaught_exception,
1861                               THREAD);
1862       if (HAS_PENDING_EXCEPTION) {
1863         ResourceMark rm(this);
1864         jio_fprintf(defaultStream::error_stream(),
1865                     "\nException: %s thrown from the UncaughtExceptionHandler"
1866                     " in thread \"%s\"\n",
1867                     pending_exception()-&gt;klass()-&gt;external_name(),
1868                     get_thread_name());
1869         CLEAR_PENDING_EXCEPTION;
1870       }
1871     }
1872 
1873     // Called before the java thread exit since we want to read info
1874     // from java_lang_Thread object
1875     EventThreadEnd event;
1876     if (event.should_commit()) {
1877       event.set_thread(JFR_THREAD_ID(this));
1878       event.commit();
1879     }
1880 
1881     // Call after last event on thread
1882     JFR_ONLY(Jfr::on_thread_exit(this);)
1883 
1884     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1885     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1886     // is deprecated anyhow.
1887     if (!is_Compiler_thread()) {
1888       int count = 3;
1889       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1890         EXCEPTION_MARK;
1891         JavaValue result(T_VOID);
1892         Klass* thread_klass = SystemDictionary::Thread_klass();
1893         JavaCalls::call_virtual(&amp;result,
1894                                 threadObj, thread_klass,
1895                                 vmSymbols::exit_method_name(),
1896                                 vmSymbols::void_method_signature(),
1897                                 THREAD);
1898         CLEAR_PENDING_EXCEPTION;
1899       }
1900     }
1901     // notify JVMTI
1902     if (JvmtiExport::should_post_thread_life()) {
1903       JvmtiExport::post_thread_end(this);
1904     }
1905 
1906     // We have notified the agents that we are exiting, before we go on,
1907     // we must check for a pending external suspend request and honor it
1908     // in order to not surprise the thread that made the suspend request.
1909     while (true) {
1910       {
1911         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1912         if (!is_external_suspend()) {
1913           set_terminated(_thread_exiting);
1914           ThreadService::current_thread_exiting(this);
1915           break;
1916         }
1917         // Implied else:
1918         // Things get a little tricky here. We have a pending external
1919         // suspend request, but we are holding the SR_lock so we
1920         // can't just self-suspend. So we temporarily drop the lock
1921         // and then self-suspend.
1922       }
1923 
1924       ThreadBlockInVM tbivm(this);
1925       java_suspend_self();
1926 
1927       // We're done with this suspend request, but we have to loop around
1928       // and check again. Eventually we will get SR_lock without a pending
1929       // external suspend request and will be able to mark ourselves as
1930       // exiting.
1931     }
1932     // no more external suspends are allowed at this point
1933   } else {
1934     // before_exit() has already posted JVMTI THREAD_END events
1935   }
1936 
1937   if (log_is_enabled(Debug, os, thread, timer)) {
1938     _timer_exit_phase1.stop();
1939     _timer_exit_phase2.start();
1940   }
1941   // Notify waiters on thread object. This has to be done after exit() is called
1942   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1943   // group should have the destroyed bit set before waiters are notified).
1944   ensure_join(this);
1945   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1946 
1947   if (log_is_enabled(Debug, os, thread, timer)) {
1948     _timer_exit_phase2.stop();
1949     _timer_exit_phase3.start();
1950   }
1951   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1952   // held by this thread must be released. The spec does not distinguish
1953   // between JNI-acquired and regular Java monitors. We can only see
1954   // regular Java monitors here if monitor enter-exit matching is broken.
1955   //
1956   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1957   // ObjectSynchronizer::release_monitors_owned_by_thread().
1958   if (exit_type == jni_detach) {
1959     // Sanity check even though JNI DetachCurrentThread() would have
1960     // returned JNI_ERR if there was a Java frame. JavaThread exit
1961     // should be done executing Java code by the time we get here.
1962     assert(!this-&gt;has_last_Java_frame(),
1963            "should not have a Java frame when detaching or exiting");
1964     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1965     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1966   }
1967 
1968   // These things needs to be done while we are still a Java Thread. Make sure that thread
1969   // is in a consistent state, in case GC happens
1970   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1971 
1972   if (active_handles() != NULL) {
1973     JNIHandleBlock* block = active_handles();
1974     set_active_handles(NULL);
1975     JNIHandleBlock::release_block(block);
1976   }
1977 
1978   if (free_handle_block() != NULL) {
1979     JNIHandleBlock* block = free_handle_block();
1980     set_free_handle_block(NULL);
1981     JNIHandleBlock::release_block(block);
1982   }
1983 
1984   // These have to be removed while this is still a valid thread.
1985   remove_stack_guard_pages();
1986 
1987   if (UseTLAB) {
1988     tlab().retire();
1989   }
1990 
1991   if (JvmtiEnv::environments_might_exist()) {
1992     JvmtiExport::cleanup_thread(this);
1993   }
1994 
1995   // We must flush any deferred card marks and other various GC barrier
1996   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
1997   // before removing a thread from the list of active threads.
1998   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
1999 
2000   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
2001     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
2002     os::current_thread_id());
2003 
2004   if (log_is_enabled(Debug, os, thread, timer)) {
2005     _timer_exit_phase3.stop();
2006     _timer_exit_phase4.start();
2007   }
2008   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2009   Threads::remove(this);
2010 
2011   if (log_is_enabled(Debug, os, thread, timer)) {
2012     _timer_exit_phase4.stop();
2013     ResourceMark rm(this);
2014     log_debug(os, thread, timer)("name='%s'"
2015                                  ", exit-phase1=" JLONG_FORMAT
2016                                  ", exit-phase2=" JLONG_FORMAT
2017                                  ", exit-phase3=" JLONG_FORMAT
2018                                  ", exit-phase4=" JLONG_FORMAT,
2019                                  get_thread_name(),
2020                                  _timer_exit_phase1.milliseconds(),
2021                                  _timer_exit_phase2.milliseconds(),
2022                                  _timer_exit_phase3.milliseconds(),
2023                                  _timer_exit_phase4.milliseconds());
2024   }
2025 }
2026 
2027 void JavaThread::cleanup_failed_attach_current_thread() {
2028   if (active_handles() != NULL) {
2029     JNIHandleBlock* block = active_handles();
2030     set_active_handles(NULL);
2031     JNIHandleBlock::release_block(block);
2032   }
2033 
2034   if (free_handle_block() != NULL) {
2035     JNIHandleBlock* block = free_handle_block();
2036     set_free_handle_block(NULL);
2037     JNIHandleBlock::release_block(block);
2038   }
2039 
2040   // These have to be removed while this is still a valid thread.
2041   remove_stack_guard_pages();
2042 
2043   if (UseTLAB) {
2044     tlab().retire();
2045   }
2046 
2047   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2048 
2049   Threads::remove(this);
2050   this-&gt;smr_delete();
2051 }
2052 
2053 JavaThread* JavaThread::active() {
2054   Thread* thread = Thread::current();
2055   if (thread-&gt;is_Java_thread()) {
2056     return (JavaThread*) thread;
2057   } else {
2058     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2059     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2060     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2061     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2062     return ret;
2063   }
2064 }
2065 
2066 bool JavaThread::is_lock_owned(address adr) const {
2067   if (Thread::is_lock_owned(adr)) return true;
2068 
2069   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2070     if (chunk-&gt;contains(adr)) return true;
2071   }
2072 
2073   return false;
2074 }
2075 
2076 
2077 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2078   chunk-&gt;set_next(monitor_chunks());
2079   set_monitor_chunks(chunk);
2080 }
2081 
2082 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2083   guarantee(monitor_chunks() != NULL, "must be non empty");
2084   if (monitor_chunks() == chunk) {
2085     set_monitor_chunks(chunk-&gt;next());
2086   } else {
2087     MonitorChunk* prev = monitor_chunks();
2088     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2089     prev-&gt;set_next(chunk-&gt;next());
2090   }
2091 }
2092 
2093 // JVM support.
2094 
2095 // Note: this function shouldn't block if it's called in
2096 // _thread_in_native_trans state (such as from
2097 // check_special_condition_for_native_trans()).
2098 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2099 
2100   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2101     // If we are at a polling page safepoint (not a poll return)
2102     // then we must defer async exception because live registers
2103     // will be clobbered by the exception path. Poll return is
2104     // ok because the call we a returning from already collides
2105     // with exception handling registers and so there is no issue.
2106     // (The exception handling path kills call result registers but
2107     //  this is ok since the exception kills the result anyway).
2108 
2109     if (is_at_poll_safepoint()) {
2110       // if the code we are returning to has deoptimized we must defer
2111       // the exception otherwise live registers get clobbered on the
2112       // exception path before deoptimization is able to retrieve them.
2113       //
2114       RegisterMap map(this, false);
2115       frame caller_fr = last_frame().sender(&amp;map);
2116       assert(caller_fr.is_compiled_frame(), "what?");
2117       if (caller_fr.is_deoptimized_frame()) {
2118         log_info(exceptions)("deferred async exception at compiled safepoint");
2119         return;
2120       }
2121     }
2122   }
2123 
2124   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2125   if (condition == _no_async_condition) {
2126     // Conditions have changed since has_special_runtime_exit_condition()
2127     // was called:
2128     // - if we were here only because of an external suspend request,
2129     //   then that was taken care of above (or cancelled) so we are done
2130     // - if we were here because of another async request, then it has
2131     //   been cleared between the has_special_runtime_exit_condition()
2132     //   and now so again we are done
2133     return;
2134   }
2135 
2136   // Check for pending async. exception
2137   if (_pending_async_exception != NULL) {
2138     // Only overwrite an already pending exception, if it is not a threadDeath.
2139     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2140 
2141       // We cannot call Exceptions::_throw(...) here because we cannot block
2142       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2143 
2144       LogTarget(Info, exceptions) lt;
2145       if (lt.is_enabled()) {
2146         ResourceMark rm;
2147         LogStream ls(lt);
2148         ls.print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2149           if (has_last_Java_frame()) {
2150             frame f = last_frame();
2151            ls.print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2152           }
2153         ls.print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2154       }
2155       _pending_async_exception = NULL;
2156       clear_has_async_exception();
2157     }
2158   }
2159 
2160   if (check_unsafe_error &amp;&amp;
2161       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2162     condition = _no_async_condition;  // done
2163     switch (thread_state()) {
2164     case _thread_in_vm: {
2165       JavaThread* THREAD = this;
2166       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2167     }
2168     case _thread_in_native: {
2169       ThreadInVMfromNative tiv(this);
2170       JavaThread* THREAD = this;
2171       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2172     }
2173     case _thread_in_Java: {
2174       ThreadInVMfromJava tiv(this);
2175       JavaThread* THREAD = this;
2176       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2177     }
2178     default:
2179       ShouldNotReachHere();
2180     }
2181   }
2182 
2183   assert(condition == _no_async_condition || has_pending_exception() ||
2184          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2185          "must have handled the async condition, if no exception");
2186 }
2187 
2188 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2189   //
2190   // Check for pending external suspend. Internal suspend requests do
2191   // not use handle_special_runtime_exit_condition().
2192   // If JNIEnv proxies are allowed, don't self-suspend if the target
2193   // thread is not the current thread. In older versions of jdbx, jdbx
2194   // threads could call into the VM with another thread's JNIEnv so we
2195   // can be here operating on behalf of a suspended thread (4432884).
2196   bool do_self_suspend = is_external_suspend_with_lock();
2197   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2198     //
2199     // Because thread is external suspended the safepoint code will count
2200     // thread as at a safepoint. This can be odd because we can be here
2201     // as _thread_in_Java which would normally transition to _thread_blocked
2202     // at a safepoint. We would like to mark the thread as _thread_blocked
2203     // before calling java_suspend_self like all other callers of it but
2204     // we must then observe proper safepoint protocol. (We can't leave
2205     // _thread_blocked with a safepoint in progress). However we can be
2206     // here as _thread_in_native_trans so we can't use a normal transition
2207     // constructor/destructor pair because they assert on that type of
2208     // transition. We could do something like:
2209     //
2210     // JavaThreadState state = thread_state();
2211     // set_thread_state(_thread_in_vm);
2212     // {
2213     //   ThreadBlockInVM tbivm(this);
2214     //   java_suspend_self()
2215     // }
2216     // set_thread_state(_thread_in_vm_trans);
2217     // if (safepoint) block;
2218     // set_thread_state(state);
2219     //
2220     // but that is pretty messy. Instead we just go with the way the
2221     // code has worked before and note that this is the only path to
2222     // java_suspend_self that doesn't put the thread in _thread_blocked
2223     // mode.
2224 
2225     frame_anchor()-&gt;make_walkable(this);
2226     java_suspend_self();
2227 
2228     // We might be here for reasons in addition to the self-suspend request
2229     // so check for other async requests.
2230   }
2231 
2232   if (check_asyncs) {
2233     check_and_handle_async_exceptions();
2234   }
2235 
2236   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2237 }
2238 
2239 void JavaThread::send_thread_stop(oop java_throwable)  {
2240   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2241   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2242   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2243 
2244   // Do not throw asynchronous exceptions against the compiler thread
2245   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2246   if (!can_call_java()) return;
2247 
2248   {
2249     // Actually throw the Throwable against the target Thread - however
2250     // only if there is no thread death exception installed already.
2251     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2252       // If the topmost frame is a runtime stub, then we are calling into
2253       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2254       // must deoptimize the caller before continuing, as the compiled  exception handler table
2255       // may not be valid
2256       if (has_last_Java_frame()) {
2257         frame f = last_frame();
2258         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2259           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2260           RegisterMap reg_map(this, UseBiasedLocking);
2261           frame compiled_frame = f.sender(&amp;reg_map);
2262           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2263             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2264           }
2265         }
2266       }
2267 
2268       // Set async. pending exception in thread.
2269       set_pending_async_exception(java_throwable);
2270 
2271       if (log_is_enabled(Info, exceptions)) {
2272          ResourceMark rm;
2273         log_info(exceptions)("Pending Async. exception installed of type: %s",
2274                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2275       }
2276       // for AbortVMOnException flag
2277       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2278     }
2279   }
2280 
2281 
2282   // Interrupt thread so it will wake up from a potential wait()
2283   Thread::interrupt(this);
2284 }
2285 
2286 // External suspension mechanism.
2287 //
2288 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2289 // to any VM_locks and it is at a transition
2290 // Self-suspension will happen on the transition out of the vm.
2291 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2292 //
2293 // Guarantees on return:
2294 //   + Target thread will not execute any new bytecode (that's why we need to
2295 //     force a safepoint)
2296 //   + Target thread will not enter any new monitors
2297 //
2298 void JavaThread::java_suspend() {
2299   ThreadsListHandle tlh;
2300   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2301     return;
2302   }
2303 
2304   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2305     if (!is_external_suspend()) {
2306       // a racing resume has cancelled us; bail out now
2307       return;
2308     }
2309 
2310     // suspend is done
2311     uint32_t debug_bits = 0;
2312     // Warning: is_ext_suspend_completed() may temporarily drop the
2313     // SR_lock to allow the thread to reach a stable thread state if
2314     // it is currently in a transient thread state.
2315     if (is_ext_suspend_completed(false /* !called_by_wait */,
2316                                  SuspendRetryDelay, &amp;debug_bits)) {
2317       return;
2318     }
2319   }
2320 
2321   VM_ThreadSuspend vm_suspend;
2322   VMThread::execute(&amp;vm_suspend);
2323 }
2324 
2325 // Part II of external suspension.
2326 // A JavaThread self suspends when it detects a pending external suspend
2327 // request. This is usually on transitions. It is also done in places
2328 // where continuing to the next transition would surprise the caller,
2329 // e.g., monitor entry.
2330 //
2331 // Returns the number of times that the thread self-suspended.
2332 //
2333 // Note: DO NOT call java_suspend_self() when you just want to block current
2334 //       thread. java_suspend_self() is the second stage of cooperative
2335 //       suspension for external suspend requests and should only be used
2336 //       to complete an external suspend request.
2337 //
2338 int JavaThread::java_suspend_self() {
2339   int ret = 0;
2340 
2341   // we are in the process of exiting so don't suspend
2342   if (is_exiting()) {
2343     clear_external_suspend();
2344     return ret;
2345   }
2346 
2347   assert(_anchor.walkable() ||
2348          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2349          "must have walkable stack");
2350 
2351   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2352 
2353   assert(!this-&gt;is_ext_suspended(),
2354          "a thread trying to self-suspend should not already be suspended");
2355 
2356   if (this-&gt;is_suspend_equivalent()) {
2357     // If we are self-suspending as a result of the lifting of a
2358     // suspend equivalent condition, then the suspend_equivalent
2359     // flag is not cleared until we set the ext_suspended flag so
2360     // that wait_for_ext_suspend_completion() returns consistent
2361     // results.
2362     this-&gt;clear_suspend_equivalent();
2363   }
2364 
2365   // A racing resume may have cancelled us before we grabbed SR_lock
2366   // above. Or another external suspend request could be waiting for us
2367   // by the time we return from SR_lock()-&gt;wait(). The thread
2368   // that requested the suspension may already be trying to walk our
2369   // stack and if we return now, we can change the stack out from under
2370   // it. This would be a "bad thing (TM)" and cause the stack walker
2371   // to crash. We stay self-suspended until there are no more pending
2372   // external suspend requests.
2373   while (is_external_suspend()) {
2374     ret++;
2375     this-&gt;set_ext_suspended();
2376 
2377     // _ext_suspended flag is cleared by java_resume()
2378     while (is_ext_suspended()) {
2379       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2380     }
2381   }
2382 
2383   return ret;
2384 }
2385 
2386 #ifdef ASSERT
2387 // Verify the JavaThread has not yet been published in the Threads::list, and
2388 // hence doesn't need protection from concurrent access at this stage.
2389 void JavaThread::verify_not_published() {
2390   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2391   // since an unpublished JavaThread doesn't participate in the
2392   // Thread-SMR protocol for keeping a ThreadsList alive.
2393   assert(!on_thread_list(), "JavaThread shouldn't have been published yet!");
2394 }
2395 #endif
2396 
2397 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2398 // progress or when _suspend_flags is non-zero.
2399 // Current thread needs to self-suspend if there is a suspend request and/or
2400 // block if a safepoint is in progress.
2401 // Async exception ISN'T checked.
2402 // Note only the ThreadInVMfromNative transition can call this function
2403 // directly and when thread state is _thread_in_native_trans
2404 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2405   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2406 
2407   JavaThread *curJT = JavaThread::current();
2408   bool do_self_suspend = thread-&gt;is_external_suspend();
2409 
2410   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2411 
2412   // If JNIEnv proxies are allowed, don't self-suspend if the target
2413   // thread is not the current thread. In older versions of jdbx, jdbx
2414   // threads could call into the VM with another thread's JNIEnv so we
2415   // can be here operating on behalf of a suspended thread (4432884).
2416   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2417     JavaThreadState state = thread-&gt;thread_state();
2418 
2419     // We mark this thread_blocked state as a suspend-equivalent so
2420     // that a caller to is_ext_suspend_completed() won't be confused.
2421     // The suspend-equivalent state is cleared by java_suspend_self().
2422     thread-&gt;set_suspend_equivalent();
2423 
2424     // If the safepoint code sees the _thread_in_native_trans state, it will
2425     // wait until the thread changes to other thread state. There is no
2426     // guarantee on how soon we can obtain the SR_lock and complete the
2427     // self-suspend request. It would be a bad idea to let safepoint wait for
2428     // too long. Temporarily change the state to _thread_blocked to
2429     // let the VM thread know that this thread is ready for GC. The problem
2430     // of changing thread state is that safepoint could happen just after
2431     // java_suspend_self() returns after being resumed, and VM thread will
2432     // see the _thread_blocked state. We must check for safepoint
2433     // after restoring the state and make sure we won't leave while a safepoint
2434     // is in progress.
2435     thread-&gt;set_thread_state(_thread_blocked);
2436     thread-&gt;java_suspend_self();
2437     thread-&gt;set_thread_state(state);
2438 
2439     InterfaceSupport::serialize_thread_state_with_handler(thread);
2440   }
2441 
2442   SafepointMechanism::block_if_requested(curJT);
2443 
2444   if (thread-&gt;is_deopt_suspend()) {
2445     thread-&gt;clear_deopt_suspend();
2446     RegisterMap map(thread, false);
2447     frame f = thread-&gt;last_frame();
2448     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2449       f = f.sender(&amp;map);
2450     }
2451     if (f.id() == thread-&gt;must_deopt_id()) {
2452       thread-&gt;clear_must_deopt_id();
2453       f.deoptimize(thread);
2454     } else {
2455       fatal("missed deoptimization!");
2456     }
2457   }
2458 
2459   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2460 }
2461 
2462 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2463 // progress or when _suspend_flags is non-zero.
2464 // Current thread needs to self-suspend if there is a suspend request and/or
2465 // block if a safepoint is in progress.
2466 // Also check for pending async exception (not including unsafe access error).
2467 // Note only the native==&gt;VM/Java barriers can call this function and when
2468 // thread state is _thread_in_native_trans.
2469 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2470   check_safepoint_and_suspend_for_native_trans(thread);
2471 
2472   if (thread-&gt;has_async_exception()) {
2473     // We are in _thread_in_native_trans state, don't handle unsafe
2474     // access error since that may block.
2475     thread-&gt;check_and_handle_async_exceptions(false);
2476   }
2477 }
2478 
2479 // This is a variant of the normal
2480 // check_special_condition_for_native_trans with slightly different
2481 // semantics for use by critical native wrappers.  It does all the
2482 // normal checks but also performs the transition back into
2483 // thread_in_Java state.  This is required so that critical natives
2484 // can potentially block and perform a GC if they are the last thread
2485 // exiting the GCLocker.
2486 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2487   check_special_condition_for_native_trans(thread);
2488 
2489   // Finish the transition
2490   thread-&gt;set_thread_state(_thread_in_Java);
2491 
2492   if (thread-&gt;do_critical_native_unlock()) {
2493     ThreadInVMfromJavaNoAsyncException tiv(thread);
2494     GCLocker::unlock_critical(thread);
2495     thread-&gt;clear_critical_native_unlock();
2496   }
2497 }
2498 
2499 // We need to guarantee the Threads_lock here, since resumes are not
2500 // allowed during safepoint synchronization
2501 // Can only resume from an external suspension
2502 void JavaThread::java_resume() {
2503   assert_locked_or_safepoint(Threads_lock);
2504 
2505   // Sanity check: thread is gone, has started exiting or the thread
2506   // was not externally suspended.
2507   ThreadsListHandle tlh;
2508   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2509     return;
2510   }
2511 
2512   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2513 
2514   clear_external_suspend();
2515 
2516   if (is_ext_suspended()) {
2517     clear_ext_suspended();
2518     SR_lock()-&gt;notify_all();
2519   }
2520 }
2521 
2522 size_t JavaThread::_stack_red_zone_size = 0;
2523 size_t JavaThread::_stack_yellow_zone_size = 0;
2524 size_t JavaThread::_stack_reserved_zone_size = 0;
2525 size_t JavaThread::_stack_shadow_zone_size = 0;
2526 
2527 void JavaThread::create_stack_guard_pages() {
2528   if (!os::uses_stack_guard_pages() ||
2529       _stack_guard_state != stack_guard_unused ||
2530       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2531       log_info(os, thread)("Stack guard page creation for thread "
2532                            UINTX_FORMAT " disabled", os::current_thread_id());
2533     return;
2534   }
2535   address low_addr = stack_end();
2536   size_t len = stack_guard_zone_size();
2537 
2538   assert(is_aligned(low_addr, os::vm_page_size()), "Stack base should be the start of a page");
2539   assert(is_aligned(len, os::vm_page_size()), "Stack size should be a multiple of page size");
2540 
2541   int must_commit = os::must_commit_stack_guard_pages();
2542   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2543 
2544   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2545     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2546     return;
2547   }
2548 
2549   if (os::guard_memory((char *) low_addr, len)) {
2550     _stack_guard_state = stack_guard_enabled;
2551   } else {
2552     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2553       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2554     if (os::uncommit_memory((char *) low_addr, len)) {
2555       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2556     }
2557     return;
2558   }
2559 
2560   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2561     PTR_FORMAT "-" PTR_FORMAT ".",
2562     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2563 }
2564 
2565 void JavaThread::remove_stack_guard_pages() {
2566   assert(Thread::current() == this, "from different thread");
2567   if (_stack_guard_state == stack_guard_unused) return;
2568   address low_addr = stack_end();
2569   size_t len = stack_guard_zone_size();
2570 
2571   if (os::must_commit_stack_guard_pages()) {
2572     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2573       _stack_guard_state = stack_guard_unused;
2574     } else {
2575       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2576         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2577       return;
2578     }
2579   } else {
2580     if (_stack_guard_state == stack_guard_unused) return;
2581     if (os::unguard_memory((char *) low_addr, len)) {
2582       _stack_guard_state = stack_guard_unused;
2583     } else {
2584       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2585         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2586       return;
2587     }
2588   }
2589 
2590   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2591     PTR_FORMAT "-" PTR_FORMAT ".",
2592     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2593 }
2594 
2595 void JavaThread::enable_stack_reserved_zone() {
2596   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2597   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2598 
2599   // The base notation is from the stack's point of view, growing downward.
2600   // We need to adjust it to work correctly with guard_memory()
2601   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2602 
2603   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2604   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2605 
2606   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2607     _stack_guard_state = stack_guard_enabled;
2608   } else {
2609     warning("Attempt to guard stack reserved zone failed.");
2610   }
2611   enable_register_stack_guard();
2612 }
2613 
2614 void JavaThread::disable_stack_reserved_zone() {
2615   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2616   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2617 
2618   // Simply return if called for a thread that does not use guard pages.
2619   if (_stack_guard_state == stack_guard_unused) return;
2620 
2621   // The base notation is from the stack's point of view, growing downward.
2622   // We need to adjust it to work correctly with guard_memory()
2623   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2624 
2625   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2626     _stack_guard_state = stack_guard_reserved_disabled;
2627   } else {
2628     warning("Attempt to unguard stack reserved zone failed.");
2629   }
2630   disable_register_stack_guard();
2631 }
2632 
2633 void JavaThread::enable_stack_yellow_reserved_zone() {
2634   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2635   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2636 
2637   // The base notation is from the stacks point of view, growing downward.
2638   // We need to adjust it to work correctly with guard_memory()
2639   address base = stack_red_zone_base();
2640 
2641   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2642   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2643 
2644   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2645     _stack_guard_state = stack_guard_enabled;
2646   } else {
2647     warning("Attempt to guard stack yellow zone failed.");
2648   }
2649   enable_register_stack_guard();
2650 }
2651 
2652 void JavaThread::disable_stack_yellow_reserved_zone() {
2653   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2654   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2655 
2656   // Simply return if called for a thread that does not use guard pages.
2657   if (_stack_guard_state == stack_guard_unused) return;
2658 
2659   // The base notation is from the stacks point of view, growing downward.
2660   // We need to adjust it to work correctly with guard_memory()
2661   address base = stack_red_zone_base();
2662 
2663   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2664     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2665   } else {
2666     warning("Attempt to unguard stack yellow zone failed.");
2667   }
2668   disable_register_stack_guard();
2669 }
2670 
2671 void JavaThread::enable_stack_red_zone() {
2672   // The base notation is from the stacks point of view, growing downward.
2673   // We need to adjust it to work correctly with guard_memory()
2674   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2675   address base = stack_red_zone_base() - stack_red_zone_size();
2676 
2677   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2678   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2679 
2680   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2681     warning("Attempt to guard stack red zone failed.");
2682   }
2683 }
2684 
2685 void JavaThread::disable_stack_red_zone() {
2686   // The base notation is from the stacks point of view, growing downward.
2687   // We need to adjust it to work correctly with guard_memory()
2688   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2689   address base = stack_red_zone_base() - stack_red_zone_size();
2690   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2691     warning("Attempt to unguard stack red zone failed.");
2692   }
2693 }
2694 
2695 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2696   // ignore is there is no stack
2697   if (!has_last_Java_frame()) return;
2698   // traverse the stack frames. Starts from top frame.
2699   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2700     frame* fr = fst.current();
2701     f(fr, fst.register_map());
2702   }
2703 }
2704 
2705 
2706 #ifndef PRODUCT
2707 // Deoptimization
2708 // Function for testing deoptimization
2709 void JavaThread::deoptimize() {
2710   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2711   StackFrameStream fst(this, UseBiasedLocking);
2712   bool deopt = false;           // Dump stack only if a deopt actually happens.
2713   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2714   // Iterate over all frames in the thread and deoptimize
2715   for (; !fst.is_done(); fst.next()) {
2716     if (fst.current()-&gt;can_be_deoptimized()) {
2717 
2718       if (only_at) {
2719         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2720         // consists of comma or carriage return separated numbers so
2721         // search for the current bci in that string.
2722         address pc = fst.current()-&gt;pc();
2723         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2724         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2725         char buffer[8];
2726         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2727         size_t len = strlen(buffer);
2728         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2729         while (found != NULL) {
2730           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2731               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2732             // Check that the bci found is bracketed by terminators.
2733             break;
2734           }
2735           found = strstr(found + 1, buffer);
2736         }
2737         if (!found) {
2738           continue;
2739         }
2740       }
2741 
2742       if (DebugDeoptimization &amp;&amp; !deopt) {
2743         deopt = true; // One-time only print before deopt
2744         tty-&gt;print_cr("[BEFORE Deoptimization]");
2745         trace_frames();
2746         trace_stack();
2747       }
2748       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2749     }
2750   }
2751 
2752   if (DebugDeoptimization &amp;&amp; deopt) {
2753     tty-&gt;print_cr("[AFTER Deoptimization]");
2754     trace_frames();
2755   }
2756 }
2757 
2758 
2759 // Make zombies
2760 void JavaThread::make_zombies() {
2761   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2762     if (fst.current()-&gt;can_be_deoptimized()) {
2763       // it is a Java nmethod
2764       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2765       nm-&gt;make_not_entrant();
2766     }
2767   }
2768 }
2769 #endif // PRODUCT
2770 
2771 
2772 void JavaThread::deoptimized_wrt_marked_nmethods() {
2773   if (!has_last_Java_frame()) return;
2774   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2775   StackFrameStream fst(this, UseBiasedLocking);
2776   for (; !fst.is_done(); fst.next()) {
2777     if (fst.current()-&gt;should_be_deoptimized()) {
2778       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2779     }
2780   }
2781 }
2782 
2783 
2784 // If the caller is a NamedThread, then remember, in the current scope,
2785 // the given JavaThread in its _processed_thread field.
2786 class RememberProcessedThread: public StackObj {
2787   NamedThread* _cur_thr;
2788  public:
2789   RememberProcessedThread(JavaThread* jthr) {
2790     Thread* thread = Thread::current();
2791     if (thread-&gt;is_Named_thread()) {
2792       _cur_thr = (NamedThread *)thread;
2793       _cur_thr-&gt;set_processed_thread(jthr);
2794     } else {
2795       _cur_thr = NULL;
2796     }
2797   }
2798 
2799   ~RememberProcessedThread() {
2800     if (_cur_thr) {
2801       _cur_thr-&gt;set_processed_thread(NULL);
2802     }
2803   }
2804 };
2805 
2806 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2807   // Verify that the deferred card marks have been flushed.
2808   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2809 
2810   // Traverse the GCHandles
2811   Thread::oops_do(f, cf);
2812 
2813   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2814          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2815 
2816   if (has_last_Java_frame()) {
2817     // Record JavaThread to GC thread
2818     RememberProcessedThread rpt(this);
2819 
2820     // Traverse the privileged stack
2821     if (_privileged_stack_top != NULL) {
2822       _privileged_stack_top-&gt;oops_do(f);
2823     }
2824 
2825     // traverse the registered growable array
2826     if (_array_for_gc != NULL) {
2827       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2828         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2829       }
2830     }
2831 
2832     // Traverse the monitor chunks
2833     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2834       chunk-&gt;oops_do(f);
2835     }
2836 
2837     // Traverse the execution stack
2838     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2839       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2840     }
2841   }
2842 
2843   // callee_target is never live across a gc point so NULL it here should
2844   // it still contain a methdOop.
2845 
2846   set_callee_target(NULL);
2847 
2848   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2849   // If we have deferred set_locals there might be oops waiting to be
2850   // written
2851   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2852   if (list != NULL) {
2853     for (int i = 0; i &lt; list-&gt;length(); i++) {
2854       list-&gt;at(i)-&gt;oops_do(f);
2855     }
2856   }
2857 
2858   // Traverse instance variables at the end since the GC may be moving things
2859   // around using this function
2860   f-&gt;do_oop((oop*) &amp;_threadObj);
2861   f-&gt;do_oop((oop*) &amp;_vm_result);
2862   f-&gt;do_oop((oop*) &amp;_exception_oop);
2863   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2864 
2865   if (jvmti_thread_state() != NULL) {
2866     jvmti_thread_state()-&gt;oops_do(f);
2867   }
2868 }
2869 
2870 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2871   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2872          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2873 
2874   if (has_last_Java_frame()) {
2875     // Traverse the execution stack
2876     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2877       fst.current()-&gt;nmethods_do(cf);
2878     }
2879   }
2880 }
2881 
2882 void JavaThread::metadata_do(void f(Metadata*)) {
2883   if (has_last_Java_frame()) {
2884     // Traverse the execution stack to call f() on the methods in the stack
2885     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2886       fst.current()-&gt;metadata_do(f);
2887     }
2888   } else if (is_Compiler_thread()) {
2889     // need to walk ciMetadata in current compile tasks to keep alive.
2890     CompilerThread* ct = (CompilerThread*)this;
2891     if (ct-&gt;env() != NULL) {
2892       ct-&gt;env()-&gt;metadata_do(f);
2893     }
2894     CompileTask* task = ct-&gt;task();
2895     if (task != NULL) {
2896       task-&gt;metadata_do(f);
2897     }
2898   }
2899 }
2900 
2901 // Printing
2902 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2903   switch (_thread_state) {
2904   case _thread_uninitialized:     return "_thread_uninitialized";
2905   case _thread_new:               return "_thread_new";
2906   case _thread_new_trans:         return "_thread_new_trans";
2907   case _thread_in_native:         return "_thread_in_native";
2908   case _thread_in_native_trans:   return "_thread_in_native_trans";
2909   case _thread_in_vm:             return "_thread_in_vm";
2910   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2911   case _thread_in_Java:           return "_thread_in_Java";
2912   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2913   case _thread_blocked:           return "_thread_blocked";
2914   case _thread_blocked_trans:     return "_thread_blocked_trans";
2915   default:                        return "unknown thread state";
2916   }
2917 }
2918 
2919 #ifndef PRODUCT
2920 void JavaThread::print_thread_state_on(outputStream *st) const {
2921   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2922 };
2923 void JavaThread::print_thread_state() const {
2924   print_thread_state_on(tty);
2925 }
2926 #endif // PRODUCT
2927 
2928 // Called by Threads::print() for VM_PrintThreads operation
2929 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
2930   st-&gt;print_raw("\"");
2931   st-&gt;print_raw(get_thread_name());
2932   st-&gt;print_raw("\" ");
2933   oop thread_oop = threadObj();
2934   if (thread_oop != NULL) {
2935     st-&gt;print("#" INT64_FORMAT " ", (int64_t)java_lang_Thread::thread_id(thread_oop));
2936     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2937     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2938   }
2939   Thread::print_on(st, print_extended_info);
2940   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2941   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2942   if (thread_oop != NULL) {
2943     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2944   }
2945 #ifndef PRODUCT
2946   print_thread_state_on(st);
2947   _safepoint_state-&gt;print_on(st);
2948 #endif // PRODUCT
2949   if (is_Compiler_thread()) {
2950     CompileTask *task = ((CompilerThread*)this)-&gt;task();
2951     if (task != NULL) {
2952       st-&gt;print("   Compiling: ");
2953       task-&gt;print(st, NULL, true, false);
2954     } else {
2955       st-&gt;print("   No compile task");
2956     }
2957     st-&gt;cr();
2958   }
2959 }
2960 
2961 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2962   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2963 }
2964 
2965 // Called by fatal error handler. The difference between this and
2966 // JavaThread::print() is that we can't grab lock or allocate memory.
2967 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2968   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2969   oop thread_obj = threadObj();
2970   if (thread_obj != NULL) {
2971     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2972   }
2973   st-&gt;print(" [");
2974   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2975   if (osthread()) {
2976     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2977   }
2978   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2979             p2i(stack_end()), p2i(stack_base()));
2980   st-&gt;print("]");
2981 
2982   ThreadsSMRSupport::print_info_on(this, st);
2983   return;
2984 }
2985 
2986 // Verification
2987 
2988 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2989 
2990 void JavaThread::verify() {
2991   // Verify oops in the thread.
2992   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2993 
2994   // Verify the stack frames.
2995   frames_do(frame_verify);
2996 }
2997 
2998 // CR 6300358 (sub-CR 2137150)
2999 // Most callers of this method assume that it can't return NULL but a
3000 // thread may not have a name whilst it is in the process of attaching to
3001 // the VM - see CR 6412693, and there are places where a JavaThread can be
3002 // seen prior to having it's threadObj set (eg JNI attaching threads and
3003 // if vm exit occurs during initialization). These cases can all be accounted
3004 // for such that this method never returns NULL.
3005 const char* JavaThread::get_thread_name() const {
3006 #ifdef ASSERT
3007   // early safepoints can hit while current thread does not yet have TLS
3008   if (!SafepointSynchronize::is_at_safepoint()) {
3009     Thread *cur = Thread::current();
3010     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3011       // Current JavaThreads are allowed to get their own name without
3012       // the Threads_lock.
3013       assert_locked_or_safepoint(Threads_lock);
3014     }
3015   }
3016 #endif // ASSERT
3017   return get_thread_name_string();
3018 }
3019 
3020 // Returns a non-NULL representation of this thread's name, or a suitable
3021 // descriptive string if there is no set name
3022 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3023   const char* name_str;
3024   oop thread_obj = threadObj();
3025   if (thread_obj != NULL) {
3026     oop name = java_lang_Thread::name(thread_obj);
3027     if (name != NULL) {
3028       if (buf == NULL) {
3029         name_str = java_lang_String::as_utf8_string(name);
3030       } else {
3031         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3032       }
3033     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3034       name_str = "&lt;no-name - thread is attaching&gt;";
3035     } else {
3036       name_str = Thread::name();
3037     }
3038   } else {
3039     name_str = Thread::name();
3040   }
3041   assert(name_str != NULL, "unexpected NULL thread name");
3042   return name_str;
3043 }
3044 
3045 
3046 const char* JavaThread::get_threadgroup_name() const {
3047   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3048   oop thread_obj = threadObj();
3049   if (thread_obj != NULL) {
3050     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3051     if (thread_group != NULL) {
3052       // ThreadGroup.name can be null
3053       return java_lang_ThreadGroup::name(thread_group);
3054     }
3055   }
3056   return NULL;
3057 }
3058 
3059 const char* JavaThread::get_parent_name() const {
3060   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3061   oop thread_obj = threadObj();
3062   if (thread_obj != NULL) {
3063     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3064     if (thread_group != NULL) {
3065       oop parent = java_lang_ThreadGroup::parent(thread_group);
3066       if (parent != NULL) {
3067         // ThreadGroup.name can be null
3068         return java_lang_ThreadGroup::name(parent);
3069       }
3070     }
3071   }
3072   return NULL;
3073 }
3074 
3075 ThreadPriority JavaThread::java_priority() const {
3076   oop thr_oop = threadObj();
3077   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3078   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3079   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3080   return priority;
3081 }
3082 
3083 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3084 
3085   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3086   // Link Java Thread object &lt;-&gt; C++ Thread
3087 
3088   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3089   // and put it into a new Handle.  The Handle "thread_oop" can then
3090   // be used to pass the C++ thread object to other methods.
3091 
3092   // Set the Java level thread object (jthread) field of the
3093   // new thread (a JavaThread *) to C++ thread object using the
3094   // "thread_oop" handle.
3095 
3096   // Set the thread field (a JavaThread *) of the
3097   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3098 
3099   Handle thread_oop(Thread::current(),
3100                     JNIHandles::resolve_non_null(jni_thread));
3101   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3102          "must be initialized");
3103   set_threadObj(thread_oop());
3104   java_lang_Thread::set_thread(thread_oop(), this);
3105 
3106   if (prio == NoPriority) {
3107     prio = java_lang_Thread::priority(thread_oop());
3108     assert(prio != NoPriority, "A valid priority should be present");
3109   }
3110 
3111   // Push the Java priority down to the native thread; needs Threads_lock
3112   Thread::set_priority(this, prio);
3113 
3114   // Add the new thread to the Threads list and set it in motion.
3115   // We must have threads lock in order to call Threads::add.
3116   // It is crucial that we do not block before the thread is
3117   // added to the Threads list for if a GC happens, then the java_thread oop
3118   // will not be visited by GC.
3119   Threads::add(this);
3120 }
3121 
3122 oop JavaThread::current_park_blocker() {
3123   // Support for JSR-166 locks
3124   oop thread_oop = threadObj();
3125   if (thread_oop != NULL &amp;&amp;
3126       JDK_Version::current().supports_thread_park_blocker()) {
3127     return java_lang_Thread::park_blocker(thread_oop);
3128   }
3129   return NULL;
3130 }
3131 
3132 
3133 void JavaThread::print_stack_on(outputStream* st) {
3134   if (!has_last_Java_frame()) return;
3135   ResourceMark rm;
3136   HandleMark   hm;
3137 
3138   RegisterMap reg_map(this);
3139   vframe* start_vf = last_java_vframe(&amp;reg_map);
3140   int count = 0;
3141   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3142     if (f-&gt;is_java_frame()) {
3143       javaVFrame* jvf = javaVFrame::cast(f);
3144       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3145 
3146       // Print out lock information
3147       if (JavaMonitorsInStackTrace) {
3148         jvf-&gt;print_lock_info_on(st, count);
3149       }
3150     } else {
3151       // Ignore non-Java frames
3152     }
3153 
3154     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3155     count++;
3156     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3157   }
3158 }
3159 
3160 
3161 // JVMTI PopFrame support
3162 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3163   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3164   if (in_bytes(size_in_bytes) != 0) {
3165     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3166     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3167     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3168   }
3169 }
3170 
3171 void* JavaThread::popframe_preserved_args() {
3172   return _popframe_preserved_args;
3173 }
3174 
3175 ByteSize JavaThread::popframe_preserved_args_size() {
3176   return in_ByteSize(_popframe_preserved_args_size);
3177 }
3178 
3179 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3180   int sz = in_bytes(popframe_preserved_args_size());
3181   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3182   return in_WordSize(sz / wordSize);
3183 }
3184 
3185 void JavaThread::popframe_free_preserved_args() {
3186   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3187   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3188   _popframe_preserved_args = NULL;
3189   _popframe_preserved_args_size = 0;
3190 }
3191 
3192 #ifndef PRODUCT
3193 
3194 void JavaThread::trace_frames() {
3195   tty-&gt;print_cr("[Describe stack]");
3196   int frame_no = 1;
3197   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3198     tty-&gt;print("  %d. ", frame_no++);
3199     fst.current()-&gt;print_value_on(tty, this);
3200     tty-&gt;cr();
3201   }
3202 }
3203 
3204 class PrintAndVerifyOopClosure: public OopClosure {
3205  protected:
3206   template &lt;class T&gt; inline void do_oop_work(T* p) {
3207     oop obj = RawAccess&lt;&gt;::oop_load(p);
3208     if (obj == NULL) return;
3209     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3210     if (oopDesc::is_oop_or_null(obj)) {
3211       if (obj-&gt;is_objArray()) {
3212         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3213       } else {
3214         obj-&gt;print();
3215       }
3216     } else {
3217       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3218     }
3219     tty-&gt;cr();
3220   }
3221  public:
3222   virtual void do_oop(oop* p) { do_oop_work(p); }
3223   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3224 };
3225 
3226 
3227 static void oops_print(frame* f, const RegisterMap *map) {
3228   PrintAndVerifyOopClosure print;
3229   f-&gt;print_value();
3230   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3231 }
3232 
3233 // Print our all the locations that contain oops and whether they are
3234 // valid or not.  This useful when trying to find the oldest frame
3235 // where an oop has gone bad since the frame walk is from youngest to
3236 // oldest.
3237 void JavaThread::trace_oops() {
3238   tty-&gt;print_cr("[Trace oops]");
3239   frames_do(oops_print);
3240 }
3241 
3242 
3243 #ifdef ASSERT
3244 // Print or validate the layout of stack frames
3245 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3246   ResourceMark rm;
3247   PRESERVE_EXCEPTION_MARK;
3248   FrameValues values;
3249   int frame_no = 0;
3250   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3251     fst.current()-&gt;describe(values, ++frame_no);
3252     if (depth == frame_no) break;
3253   }
3254   if (validate_only) {
3255     values.validate();
3256   } else {
3257     tty-&gt;print_cr("[Describe stack layout]");
3258     values.print(this);
3259   }
3260 }
3261 #endif
3262 
3263 void JavaThread::trace_stack_from(vframe* start_vf) {
3264   ResourceMark rm;
3265   int vframe_no = 1;
3266   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3267     if (f-&gt;is_java_frame()) {
3268       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3269     } else {
3270       f-&gt;print();
3271     }
3272     if (vframe_no &gt; StackPrintLimit) {
3273       tty-&gt;print_cr("...&lt;more frames&gt;...");
3274       return;
3275     }
3276   }
3277 }
3278 
3279 
3280 void JavaThread::trace_stack() {
3281   if (!has_last_Java_frame()) return;
3282   ResourceMark rm;
3283   HandleMark   hm;
3284   RegisterMap reg_map(this);
3285   trace_stack_from(last_java_vframe(&amp;reg_map));
3286 }
3287 
3288 
3289 #endif // PRODUCT
3290 
3291 
3292 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3293   assert(reg_map != NULL, "a map must be given");
3294   frame f = last_frame();
3295   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3296     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3297   }
3298   return NULL;
3299 }
3300 
3301 
3302 Klass* JavaThread::security_get_caller_class(int depth) {
3303   vframeStream vfst(this);
3304   vfst.security_get_caller_frame(depth);
3305   if (!vfst.at_end()) {
3306     return vfst.method()-&gt;method_holder();
3307   }
3308   return NULL;
3309 }
3310 
3311 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3312   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3313   CompileBroker::compiler_thread_loop();
3314 }
3315 
3316 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3317   NMethodSweeper::sweeper_loop();
3318 }
3319 
3320 // Create a CompilerThread
3321 CompilerThread::CompilerThread(CompileQueue* queue,
3322                                CompilerCounters* counters)
3323                                : JavaThread(&amp;compiler_thread_entry) {
3324   _env   = NULL;
3325   _log   = NULL;
3326   _task  = NULL;
3327   _queue = queue;
3328   _counters = counters;
3329   _buffer_blob = NULL;
3330   _compiler = NULL;
3331 
3332   // Compiler uses resource area for compilation, let's bias it to mtCompiler
3333   resource_area()-&gt;bias_to(mtCompiler);
3334 
3335 #ifndef PRODUCT
3336   _ideal_graph_printer = NULL;
3337 #endif
3338 }
3339 
3340 CompilerThread::~CompilerThread() {
3341   // Delete objects which were allocated on heap.
3342   delete _counters;
3343 }
3344 
3345 bool CompilerThread::can_call_java() const {
3346   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3347 }
3348 
3349 // Create sweeper thread
3350 CodeCacheSweeperThread::CodeCacheSweeperThread()
3351 : JavaThread(&amp;sweeper_thread_entry) {
3352   _scanned_compiled_method = NULL;
3353 }
3354 
3355 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3356   JavaThread::oops_do(f, cf);
3357   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3358     // Safepoints can occur when the sweeper is scanning an nmethod so
3359     // process it here to make sure it isn't unloaded in the middle of
3360     // a scan.
3361     cf-&gt;do_code_blob(_scanned_compiled_method);
3362   }
3363 }
3364 
3365 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3366   JavaThread::nmethods_do(cf);
3367   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3368     // Safepoints can occur when the sweeper is scanning an nmethod so
3369     // process it here to make sure it isn't unloaded in the middle of
3370     // a scan.
3371     cf-&gt;do_code_blob(_scanned_compiled_method);
3372   }
3373 }
3374 
3375 
3376 // ======= Threads ========
3377 
3378 // The Threads class links together all active threads, and provides
3379 // operations over all threads. It is protected by the Threads_lock,
3380 // which is also used in other global contexts like safepointing.
3381 // ThreadsListHandles are used to safely perform operations on one
3382 // or more threads without the risk of the thread exiting during the
3383 // operation.
3384 //
3385 // Note: The Threads_lock is currently more widely used than we
3386 // would like. We are actively migrating Threads_lock uses to other
3387 // mechanisms in order to reduce Threads_lock contention.
3388 
3389 JavaThread* Threads::_thread_list = NULL;
3390 int         Threads::_number_of_threads = 0;
3391 int         Threads::_number_of_non_daemon_threads = 0;
3392 int         Threads::_return_code = 0;
3393 int         Threads::_thread_claim_parity = 0;
3394 size_t      JavaThread::_stack_size_at_create = 0;
3395 
3396 #ifdef ASSERT
3397 bool        Threads::_vm_complete = false;
3398 size_t      Threads::_threads_before_barrier_set = 0;
3399 #endif
3400 
3401 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3402   Prefetch::read((void*)addr, prefetch_interval);
3403   return *addr;
3404 }
3405 
3406 // Possibly the ugliest for loop the world has seen. C++ does not allow
3407 // multiple types in the declaration section of the for loop. In this case
3408 // we are only dealing with pointers and hence can cast them. It looks ugly
3409 // but macros are ugly and therefore it's fine to make things absurdly ugly.
3410 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3411     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3412              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3413              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3414              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3415              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3416          MACRO_current_p != MACRO_end;                                                                                    \
3417          MACRO_current_p++,                                                                                               \
3418              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3419 
3420 // All JavaThreads
3421 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3422 
3423 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3424 void Threads::non_java_threads_do(ThreadClosure* tc) {
3425   NoSafepointVerifier nsv(!SafepointSynchronize::is_at_safepoint(), false);
3426   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3427     tc-&gt;do_thread(njti.current());
3428   }
3429 }
3430 
3431 // All JavaThreads
3432 void Threads::java_threads_do(ThreadClosure* tc) {
3433   assert_locked_or_safepoint(Threads_lock);
3434   // ALL_JAVA_THREADS iterates through all JavaThreads.
3435   ALL_JAVA_THREADS(p) {
3436     tc-&gt;do_thread(p);
3437   }
3438 }
3439 
3440 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3441   assert_locked_or_safepoint(Threads_lock);
3442   java_threads_do(tc);
3443   tc-&gt;do_thread(VMThread::vm_thread());
3444 }
3445 
3446 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3447 void Threads::threads_do(ThreadClosure* tc) {
3448   assert_locked_or_safepoint(Threads_lock);
3449   java_threads_do(tc);
3450   non_java_threads_do(tc);
3451 }
3452 
3453 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3454   int cp = Threads::thread_claim_parity();
3455   ALL_JAVA_THREADS(p) {
3456     if (p-&gt;claim_oops_do(is_par, cp)) {
3457       tc-&gt;do_thread(p);
3458     }
3459   }
3460   VMThread* vmt = VMThread::vm_thread();
3461   if (vmt-&gt;claim_oops_do(is_par, cp)) {
3462     tc-&gt;do_thread(vmt);
3463   }
3464 }
3465 
3466 // The system initialization in the library has three phases.
3467 //
3468 // Phase 1: java.lang.System class initialization
3469 //     java.lang.System is a primordial class loaded and initialized
3470 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3471 //     only does registerNatives and keeps the rest of the class
3472 //     initialization work later until thread initialization completes.
3473 //
3474 //     System.initPhase1 initializes the system properties, the static
3475 //     fields in, out, and err. Set up java signal handlers, OS-specific
3476 //     system settings, and thread group of the main thread.
3477 static void call_initPhase1(TRAPS) {
3478   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3479   JavaValue result(T_VOID);
3480   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3481                                          vmSymbols::void_method_signature(), CHECK);
3482 }
3483 
3484 // Phase 2. Module system initialization
3485 //     This will initialize the module system.  Only java.base classes
3486 //     can be loaded until phase 2 completes.
3487 //
3488 //     Call System.initPhase2 after the compiler initialization and jsr292
3489 //     classes get initialized because module initialization runs a lot of java
3490 //     code, that for performance reasons, should be compiled.  Also, this will
3491 //     enable the startup code to use lambda and other language features in this
3492 //     phase and onward.
3493 //
3494 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3495 static void call_initPhase2(TRAPS) {
3496   TraceTime timer("Initialize module system", TRACETIME_LOG(Info, startuptime));
3497 
3498   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3499 
3500   JavaValue result(T_INT);
3501   JavaCallArguments args;
3502   args.push_int(DisplayVMOutputToStderr);
3503   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3504   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3505                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3506   if (result.get_jint() != JNI_OK) {
3507     vm_exit_during_initialization(); // no message or exception
3508   }
3509 
3510   universe_post_module_init();
3511 }
3512 
3513 // Phase 3. final setup - set security manager, system class loader and TCCL
3514 //
3515 //     This will instantiate and set the security manager, set the system class
3516 //     loader as well as the thread context class loader.  The security manager
3517 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3518 //     other modules or the application's classpath.
3519 static void call_initPhase3(TRAPS) {
3520   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3521   JavaValue result(T_VOID);
3522   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3523                                          vmSymbols::void_method_signature(), CHECK);
3524 }
3525 
3526 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3527   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3528 
3529   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3530     create_vm_init_libraries();
3531   }
3532 
3533   initialize_class(vmSymbols::java_lang_String(), CHECK);
3534 
3535   // Inject CompactStrings value after the static initializers for String ran.
3536   java_lang_String::set_compact_strings(CompactStrings);
3537 
3538   // Initialize java_lang.System (needed before creating the thread)
3539   initialize_class(vmSymbols::java_lang_System(), CHECK);
3540   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3541   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3542   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3543   Handle thread_group = create_initial_thread_group(CHECK);
3544   Universe::set_main_thread_group(thread_group());
3545   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3546   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3547   main_thread-&gt;set_threadObj(thread_object);
3548   // Set thread status to running since main thread has
3549   // been started and running.
3550   java_lang_Thread::set_thread_status(thread_object,
3551                                       java_lang_Thread::RUNNABLE);
3552 
3553   // The VM creates objects of this class.
3554   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3555 
3556   // The VM preresolves methods to these classes. Make sure that they get initialized
3557   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3558   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3559 
3560   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3561   call_initPhase1(CHECK);
3562 
3563   // get the Java runtime name after java.lang.System is initialized
3564   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3565   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3566 
3567   // an instance of OutOfMemory exception has been allocated earlier
3568   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3569   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3570   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3571   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3572   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3573   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3574   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3575   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3576 }
3577 
3578 void Threads::initialize_jsr292_core_classes(TRAPS) {
3579   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3580 
3581   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3582   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3583   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3584   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3585 }
3586 
3587 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3588   extern void JDK_Version_init();
3589 
3590   // Preinitialize version info.
3591   VM_Version::early_initialize();
3592 
3593   // Check version
3594   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3595 
3596   // Initialize library-based TLS
3597   ThreadLocalStorage::init();
3598 
3599   // Initialize the output stream module
3600   ostream_init();
3601 
3602   // Process java launcher properties.
3603   Arguments::process_sun_java_launcher_properties(args);
3604 
3605   // Initialize the os module
3606   os::init();
3607 
3608   // Record VM creation timing statistics
3609   TraceVmCreationTime create_vm_timer;
3610   create_vm_timer.start();
3611 
3612   // Initialize system properties.
3613   Arguments::init_system_properties();
3614 
3615   // So that JDK version can be used as a discriminator when parsing arguments
3616   JDK_Version_init();
3617 
3618   // Update/Initialize System properties after JDK version number is known
3619   Arguments::init_version_specific_system_properties();
3620 
3621   // Make sure to initialize log configuration *before* parsing arguments
3622   LogConfiguration::initialize(create_vm_timer.begin_time());
3623 
3624   // Parse arguments
3625   // Note: this internally calls os::init_container_support()
3626   jint parse_result = Arguments::parse(args);
3627   if (parse_result != JNI_OK) return parse_result;
3628 
3629   os::init_before_ergo();
3630 
3631   jint ergo_result = Arguments::apply_ergo();
3632   if (ergo_result != JNI_OK) return ergo_result;
3633 
3634   // Final check of all ranges after ergonomics which may change values.
3635   if (!JVMFlagRangeList::check_ranges()) {
3636     return JNI_EINVAL;
3637   }
3638 
3639   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3640   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3641   if (!constraint_result) {
3642     return JNI_EINVAL;
3643   }
3644 
3645   JVMFlagWriteableList::mark_startup();
3646 
3647   if (PauseAtStartup) {
3648     os::pause();
3649   }
3650 
3651   HOTSPOT_VM_INIT_BEGIN();
3652 
3653   // Timing (must come after argument parsing)
3654   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3655 
3656 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3657   // Initialize assert poison page mechanism.
3658   if (ShowRegistersOnAssert) {
3659     initialize_assert_poison();
3660   }
3661 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3662 
3663   // Initialize the os module after parsing the args
3664   jint os_init_2_result = os::init_2();
3665   if (os_init_2_result != JNI_OK) return os_init_2_result;
3666 
3667   SafepointMechanism::initialize();
3668 
3669   jint adjust_after_os_result = Arguments::adjust_after_os();
3670   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3671 
3672   // Initialize output stream logging
3673   ostream_init_log();
3674 
3675   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3676   // Must be before create_vm_init_agents()
3677   if (Arguments::init_libraries_at_startup()) {
3678     convert_vm_init_libraries_to_agents();
3679   }
3680 
3681   // Launch -agentlib/-agentpath and converted -Xrun agents
3682   if (Arguments::init_agents_at_startup()) {
3683     create_vm_init_agents();
3684   }
3685 
3686   // Initialize Threads state
3687   _thread_list = NULL;
3688   _number_of_threads = 0;
3689   _number_of_non_daemon_threads = 0;
3690 
3691   // Initialize global data structures and create system classes in heap
3692   vm_init_globals();
3693 
3694 #if INCLUDE_JVMCI
3695   if (JVMCICounterSize &gt; 0) {
3696     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3697     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3698   } else {
3699     JavaThread::_jvmci_old_thread_counters = NULL;
3700   }
3701 #endif // INCLUDE_JVMCI
3702 
3703   // Attach the main thread to this os thread
3704   JavaThread* main_thread = new JavaThread();
3705   main_thread-&gt;set_thread_state(_thread_in_vm);
3706   main_thread-&gt;initialize_thread_current();
3707   // must do this before set_active_handles
3708   main_thread-&gt;record_stack_base_and_size();
3709   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3710 
3711   if (!main_thread-&gt;set_as_starting_thread()) {
3712     vm_shutdown_during_initialization(
3713                                       "Failed necessary internal allocation. Out of swap space");
3714     main_thread-&gt;smr_delete();
3715     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3716     return JNI_ENOMEM;
3717   }
3718 
3719   // Enable guard page *after* os::create_main_thread(), otherwise it would
3720   // crash Linux VM, see notes in os_linux.cpp.
3721   main_thread-&gt;create_stack_guard_pages();
3722 
3723   // Initialize Java-Level synchronization subsystem
3724   ObjectMonitor::Initialize();
3725 
3726   // Initialize global modules
3727   jint status = init_globals();
3728   if (status != JNI_OK) {
3729     main_thread-&gt;smr_delete();
3730     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3731     return status;
3732   }
3733 
3734   JFR_ONLY(Jfr::on_vm_init();)
3735 
3736   // Should be done after the heap is fully created
3737   main_thread-&gt;cache_global_variables();
3738 
3739   HandleMark hm;
3740 
3741   { MutexLocker mu(Threads_lock);
3742     Threads::add(main_thread);
3743   }
3744 
3745   // Any JVMTI raw monitors entered in onload will transition into
3746   // real raw monitor. VM is setup enough here for raw monitor enter.
3747   JvmtiExport::transition_pending_onload_raw_monitors();
3748 
3749   // Create the VMThread
3750   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3751 
3752   VMThread::create();
3753     Thread* vmthread = VMThread::vm_thread();
3754 
3755     if (!os::create_thread(vmthread, os::vm_thread)) {
3756       vm_exit_during_initialization("Cannot create VM thread. "
3757                                     "Out of system resources.");
3758     }
3759 
3760     // Wait for the VM thread to become ready, and VMThread::run to initialize
3761     // Monitors can have spurious returns, must always check another state flag
3762     {
3763       MutexLocker ml(Notify_lock);
3764       os::start_thread(vmthread);
3765       while (vmthread-&gt;active_handles() == NULL) {
3766         Notify_lock-&gt;wait();
3767       }
3768     }
3769   }
3770 
3771   assert(Universe::is_fully_initialized(), "not initialized");
3772   if (VerifyDuringStartup) {
3773     // Make sure we're starting with a clean slate.
3774     VM_Verify verify_op;
3775     VMThread::execute(&amp;verify_op);
3776   }
3777 
3778   // We need this to update the java.vm.info property in case any flags used
3779   // to initially define it have been changed. This is needed for both CDS and
3780   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3781   // is initially computed. See Abstract_VM_Version::vm_info_string().
3782   // This update must happen before we initialize the java classes, but
3783   // after any initialization logic that might modify the flags.
3784   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3785 
3786   Thread* THREAD = Thread::current();
3787 
3788   // Always call even when there are not JVMTI environments yet, since environments
3789   // may be attached late and JVMTI must track phases of VM execution
3790   JvmtiExport::enter_early_start_phase();
3791 
3792   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3793   JvmtiExport::post_early_vm_start();
3794 
3795   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3796 
3797   quicken_jni_functions();
3798 
3799   // No more stub generation allowed after that point.
3800   StubCodeDesc::freeze();
3801 
3802   // Set flag that basic initialization has completed. Used by exceptions and various
3803   // debug stuff, that does not work until all basic classes have been initialized.
3804   set_init_completed();
3805 
3806   LogConfiguration::post_initialize();
3807   Metaspace::post_initialize();
3808 
3809   HOTSPOT_VM_INIT_END();
3810 
3811   // record VM initialization completion time
3812 #if INCLUDE_MANAGEMENT
3813   Management::record_vm_init_completed();
3814 #endif // INCLUDE_MANAGEMENT
3815 
3816   // Signal Dispatcher needs to be started before VMInit event is posted
3817   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
3818 
3819   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3820   if (!DisableAttachMechanism) {
3821     AttachListener::vm_start();
3822     if (StartAttachListener || AttachListener::init_at_startup()) {
3823       AttachListener::init();
3824     }
3825   }
3826 
3827   // Launch -Xrun agents
3828   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3829   // back-end can launch with -Xdebug -Xrunjdwp.
3830   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3831     create_vm_init_libraries();
3832   }
3833 
3834   if (CleanChunkPoolAsync) {
3835     Chunk::start_chunk_pool_cleaner_task();
3836   }
3837 
3838   // initialize compiler(s)
3839 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
3840 #if INCLUDE_JVMCI
3841   bool force_JVMCI_intialization = false;
3842   if (EnableJVMCI) {
3843     // Initialize JVMCI eagerly when it is explicitly requested.
3844     // Or when JVMCIPrintProperties is enabled.
3845     // The JVMCI Java initialization code will read this flag and
3846     // do the printing if it's set.
3847     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;
3848 
3849     if (!force_JVMCI_intialization) {
3850       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3851       // compilations via JVMCI will not actually block until JVMCI is initialized.
3852       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
3853     }
3854   }
3855 #endif
3856   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
3857   // Postpone completion of compiler initialization to after JVMCI
3858   // is initialized to avoid timeouts of blocking compilations.
3859   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
3860     CompileBroker::compilation_init_phase2();
3861   }
3862 #endif
3863 
3864   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3865   // It is done after compilers are initialized, because otherwise compilations of
3866   // signature polymorphic MH intrinsics can be missed
3867   // (see SystemDictionary::find_method_handle_intrinsic).
3868   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3869 
3870   // This will initialize the module system.  Only java.base classes can be
3871   // loaded until phase 2 completes
3872   call_initPhase2(CHECK_JNI_ERR);
3873 
3874   // Always call even when there are not JVMTI environments yet, since environments
3875   // may be attached late and JVMTI must track phases of VM execution
3876   JvmtiExport::enter_start_phase();
3877 
3878   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3879   JvmtiExport::post_vm_start();
3880 
3881   // Final system initialization including security manager and system class loader
3882   call_initPhase3(CHECK_JNI_ERR);
3883 
3884   // cache the system and platform class loaders
3885   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
3886 
3887 #if INCLUDE_CDS
3888   if (DumpSharedSpaces) {
3889     // capture the module path info from the ModuleEntryTable
3890     ClassLoader::initialize_module_path(THREAD);
3891   }
3892 #endif
3893 
3894 #if INCLUDE_JVMCI
3895   if (force_JVMCI_intialization) {
3896     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3897     CompileBroker::compilation_init_phase2();
3898   }
3899 #endif
3900 
3901   // Always call even when there are not JVMTI environments yet, since environments
3902   // may be attached late and JVMTI must track phases of VM execution
3903   JvmtiExport::enter_live_phase();
3904 
3905   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3906   JvmtiExport::post_vm_initialized();
3907 
3908   JFR_ONLY(Jfr::on_vm_start();)
3909 
3910 #if INCLUDE_MANAGEMENT
3911   Management::initialize(THREAD);
3912 
3913   if (HAS_PENDING_EXCEPTION) {
3914     // management agent fails to start possibly due to
3915     // configuration problem and is responsible for printing
3916     // stack trace if appropriate. Simply exit VM.
3917     vm_exit(1);
3918   }
3919 #endif // INCLUDE_MANAGEMENT
3920 
3921   if (MemProfiling)                   MemProfiler::engage();
3922   StatSampler::engage();
3923   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3924 
3925   BiasedLocking::init();
3926 
3927 #if INCLUDE_RTM_OPT
3928   RTMLockingCounters::init();
3929 #endif
3930 
3931   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3932     call_postVMInitHook(THREAD);
3933     // The Java side of PostVMInitHook.run must deal with all
3934     // exceptions and provide means of diagnosis.
3935     if (HAS_PENDING_EXCEPTION) {
3936       CLEAR_PENDING_EXCEPTION;
3937     }
3938   }
3939 
3940   {
3941     MutexLocker ml(PeriodicTask_lock);
3942     // Make sure the WatcherThread can be started by WatcherThread::start()
3943     // or by dynamic enrollment.
3944     WatcherThread::make_startable();
3945     // Start up the WatcherThread if there are any periodic tasks
3946     // NOTE:  All PeriodicTasks should be registered by now. If they
3947     //   aren't, late joiners might appear to start slowly (we might
3948     //   take a while to process their first tick).
3949     if (PeriodicTask::num_tasks() &gt; 0) {
3950       WatcherThread::start();
3951     }
3952   }
3953 
3954   create_vm_timer.end();
3955 #ifdef ASSERT
3956   _vm_complete = true;
3957 #endif
3958 
3959   if (DumpSharedSpaces) {
3960     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3961     ShouldNotReachHere();
3962   }
3963 
3964   return JNI_OK;
3965 }
3966 
3967 // type for the Agent_OnLoad and JVM_OnLoad entry points
3968 extern "C" {
3969   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3970 }
3971 // Find a command line agent library and return its entry point for
3972 //         -agentlib:  -agentpath:   -Xrun
3973 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3974 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3975                                     const char *on_load_symbols[],
3976                                     size_t num_symbol_entries) {
3977   OnLoadEntry_t on_load_entry = NULL;
3978   void *library = NULL;
3979 
3980   if (!agent-&gt;valid()) {
3981     char buffer[JVM_MAXPATHLEN];
3982     char ebuf[1024] = "";
3983     const char *name = agent-&gt;name();
3984     const char *msg = "Could not find agent library ";
3985 
3986     // First check to see if agent is statically linked into executable
3987     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3988       library = agent-&gt;os_lib();
3989     } else if (agent-&gt;is_absolute_path()) {
3990       library = os::dll_load(name, ebuf, sizeof ebuf);
3991       if (library == NULL) {
3992         const char *sub_msg = " in absolute path, with error: ";
3993         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3994         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3995         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3996         // If we can't find the agent, exit.
3997         vm_exit_during_initialization(buf, NULL);
3998         FREE_C_HEAP_ARRAY(char, buf);
3999       }
4000     } else {
4001       // Try to load the agent from the standard dll directory
4002       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4003                              name)) {
4004         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4005       }
4006       if (library == NULL) { // Try the library path directory.
4007         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4008           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4009         }
4010         if (library == NULL) {
4011           const char *sub_msg = " on the library path, with error: ";
4012           const char *sub_msg2 = "\nModule java.instrument may be missing from runtime image.";
4013 
4014           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4015                        strlen(ebuf) + strlen(sub_msg2) + 1;
4016           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4017           if (!agent-&gt;is_instrument_lib()) {
4018             jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
4019           } else {
4020             jio_snprintf(buf, len, "%s%s%s%s%s", msg, name, sub_msg, ebuf, sub_msg2);
4021           }
4022           // If we can't find the agent, exit.
4023           vm_exit_during_initialization(buf, NULL);
4024           FREE_C_HEAP_ARRAY(char, buf);
4025         }
4026       }
4027     }
4028     agent-&gt;set_os_lib(library);
4029     agent-&gt;set_valid();
4030   }
4031 
4032   // Find the OnLoad function.
4033   on_load_entry =
4034     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4035                                                           false,
4036                                                           on_load_symbols,
4037                                                           num_symbol_entries));
4038   return on_load_entry;
4039 }
4040 
4041 // Find the JVM_OnLoad entry point
4042 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4043   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4044   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4045 }
4046 
4047 // Find the Agent_OnLoad entry point
4048 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4049   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4050   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4051 }
4052 
4053 // For backwards compatibility with -Xrun
4054 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4055 // treated like -agentpath:
4056 // Must be called before agent libraries are created
4057 void Threads::convert_vm_init_libraries_to_agents() {
4058   AgentLibrary* agent;
4059   AgentLibrary* next;
4060 
4061   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4062     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4063     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4064 
4065     // If there is an JVM_OnLoad function it will get called later,
4066     // otherwise see if there is an Agent_OnLoad
4067     if (on_load_entry == NULL) {
4068       on_load_entry = lookup_agent_on_load(agent);
4069       if (on_load_entry != NULL) {
4070         // switch it to the agent list -- so that Agent_OnLoad will be called,
4071         // JVM_OnLoad won't be attempted and Agent_OnUnload will
4072         Arguments::convert_library_to_agent(agent);
4073       } else {
4074         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
4075       }
4076     }
4077   }
4078 }
4079 
4080 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4081 // Invokes Agent_OnLoad
4082 // Called very early -- before JavaThreads exist
4083 void Threads::create_vm_init_agents() {
4084   extern struct JavaVM_ main_vm;
4085   AgentLibrary* agent;
4086 
4087   JvmtiExport::enter_onload_phase();
4088 
4089   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4090     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4091 
4092     if (on_load_entry != NULL) {
4093       // Invoke the Agent_OnLoad function
4094       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4095       if (err != JNI_OK) {
4096         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
4097       }
4098     } else {
4099       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
4100     }
4101   }
4102   JvmtiExport::enter_primordial_phase();
4103 }
4104 
4105 extern "C" {
4106   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4107 }
4108 
4109 void Threads::shutdown_vm_agents() {
4110   // Send any Agent_OnUnload notifications
4111   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4112   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4113   extern struct JavaVM_ main_vm;
4114   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4115 
4116     // Find the Agent_OnUnload function.
4117     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4118                                                    os::find_agent_function(agent,
4119                                                    false,
4120                                                    on_unload_symbols,
4121                                                    num_symbol_entries));
4122 
4123     // Invoke the Agent_OnUnload function
4124     if (unload_entry != NULL) {
4125       JavaThread* thread = JavaThread::current();
4126       ThreadToNativeFromVM ttn(thread);
4127       HandleMark hm(thread);
4128       (*unload_entry)(&amp;main_vm);
4129     }
4130   }
4131 }
4132 
4133 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4134 // Invokes JVM_OnLoad
4135 void Threads::create_vm_init_libraries() {
4136   extern struct JavaVM_ main_vm;
4137   AgentLibrary* agent;
4138 
4139   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4140     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4141 
4142     if (on_load_entry != NULL) {
4143       // Invoke the JVM_OnLoad function
4144       JavaThread* thread = JavaThread::current();
4145       ThreadToNativeFromVM ttn(thread);
4146       HandleMark hm(thread);
4147       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4148       if (err != JNI_OK) {
4149         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4150       }
4151     } else {
4152       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4153     }
4154   }
4155 }
4156 
4157 
4158 // Last thread running calls java.lang.Shutdown.shutdown()
4159 void JavaThread::invoke_shutdown_hooks() {
4160   HandleMark hm(this);
4161 
4162   // We could get here with a pending exception, if so clear it now.
4163   if (this-&gt;has_pending_exception()) {
4164     this-&gt;clear_pending_exception();
4165   }
4166 
4167   EXCEPTION_MARK;
4168   Klass* shutdown_klass =
4169     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4170                                       THREAD);
4171   if (shutdown_klass != NULL) {
4172     // SystemDictionary::resolve_or_null will return null if there was
4173     // an exception.  If we cannot load the Shutdown class, just don't
4174     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4175     // won't be run.  Note that if a shutdown hook was registered,
4176     // the Shutdown class would have already been loaded
4177     // (Runtime.addShutdownHook will load it).
4178     JavaValue result(T_VOID);
4179     JavaCalls::call_static(&amp;result,
4180                            shutdown_klass,
4181                            vmSymbols::shutdown_method_name(),
4182                            vmSymbols::void_method_signature(),
4183                            THREAD);
4184   }
4185   CLEAR_PENDING_EXCEPTION;
4186 }
4187 
4188 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4189 // the program falls off the end of main(). Another VM exit path is through
4190 // vm_exit() when the program calls System.exit() to return a value or when
4191 // there is a serious error in VM. The two shutdown paths are not exactly
4192 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4193 // and VM_Exit op at VM level.
4194 //
4195 // Shutdown sequence:
4196 //   + Shutdown native memory tracking if it is on
4197 //   + Wait until we are the last non-daemon thread to execute
4198 //     &lt;-- every thing is still working at this moment --&gt;
4199 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4200 //        shutdown hooks
4201 //   + Call before_exit(), prepare for VM exit
4202 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4203 //        currently the only user of this mechanism is File.deleteOnExit())
4204 //      &gt; stop StatSampler, watcher thread, CMS threads,
4205 //        post thread end and vm death events to JVMTI,
4206 //        stop signal thread
4207 //   + Call JavaThread::exit(), it will:
4208 //      &gt; release JNI handle blocks, remove stack guard pages
4209 //      &gt; remove this thread from Threads list
4210 //     &lt;-- no more Java code from this thread after this point --&gt;
4211 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4212 //     the compiler threads at safepoint
4213 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4214 //   + Disable tracing at JNI/JVM barriers
4215 //   + Set _vm_exited flag for threads that are still running native code
4216 //   + Delete this thread
4217 //   + Call exit_globals()
4218 //      &gt; deletes tty
4219 //      &gt; deletes PerfMemory resources
4220 //   + Return to caller
4221 
4222 bool Threads::destroy_vm() {
4223   JavaThread* thread = JavaThread::current();
4224 
4225 #ifdef ASSERT
4226   _vm_complete = false;
4227 #endif
4228   // Wait until we are the last non-daemon thread to execute
4229   { MutexLocker nu(Threads_lock);
4230     while (Threads::number_of_non_daemon_threads() &gt; 1)
4231       // This wait should make safepoint checks, wait without a timeout,
4232       // and wait as a suspend-equivalent condition.
4233       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4234                          Mutex::_as_suspend_equivalent_flag);
4235   }
4236 
4237   EventShutdown e;
4238   if (e.should_commit()) {
4239     e.set_reason("No remaining non-daemon Java threads");
4240     e.commit();
4241   }
4242 
4243   // Hang forever on exit if we are reporting an error.
4244   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4245     os::infinite_sleep();
4246   }
4247   os::wait_for_keypress_at_exit();
4248 
4249   // run Java level shutdown hooks
4250   thread-&gt;invoke_shutdown_hooks();
4251 
4252   before_exit(thread);
4253 
4254   thread-&gt;exit(true);
4255   // thread will never call smr_delete, instead of implicit cancel
4256   // in wait_for_vm_thread_exit we do it explicit.
4257   thread-&gt;cancel_handshake();
4258 
4259   // Stop VM thread.
4260   {
4261     // 4945125 The vm thread comes to a safepoint during exit.
4262     // GC vm_operations can get caught at the safepoint, and the
4263     // heap is unparseable if they are caught. Grab the Heap_lock
4264     // to prevent this. The GC vm_operations will not be able to
4265     // queue until after the vm thread is dead. After this point,
4266     // we'll never emerge out of the safepoint before the VM exits.
4267 
4268     MutexLocker ml(Heap_lock);
4269 
4270     VMThread::wait_for_vm_thread_exit();
4271     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4272     VMThread::destroy();
4273   }
4274 
4275   // Now, all Java threads are gone except daemon threads. Daemon threads
4276   // running Java code or in VM are stopped by the Safepoint. However,
4277   // daemon threads executing native code are still running.  But they
4278   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4279   // simply kill or suspend them, as it is inherently deadlock-prone.
4280 
4281   VM_Exit::set_vm_exited();
4282 
4283   // Clean up ideal graph printers after the VMThread has started
4284   // the final safepoint which will block all the Compiler threads.
4285   // Note that this Thread has already logically exited so the
4286   // clean_up() function's use of a JavaThreadIteratorWithHandle
4287   // would be a problem except set_vm_exited() has remembered the
4288   // shutdown thread which is granted a policy exception.
4289 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4290   IdealGraphPrinter::clean_up();
4291 #endif
4292 
4293   notify_vm_shutdown();
4294 
4295   // We are after VM_Exit::set_vm_exited() so we can't call
4296   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4297   // Deleting the shutdown thread here is safe because another
4298   // JavaThread cannot have an active ThreadsListHandle for
4299   // this JavaThread.
4300   delete thread;
4301 
4302 #if INCLUDE_JVMCI
4303   if (JVMCICounterSize &gt; 0) {
4304     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4305   }
4306 #endif
4307 
4308   // exit_globals() will delete tty
4309   exit_globals();
4310 
4311   LogConfiguration::finalize();
4312 
4313   return true;
4314 }
4315 
4316 
4317 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4318   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4319   return is_supported_jni_version(version);
4320 }
4321 
4322 
4323 jboolean Threads::is_supported_jni_version(jint version) {
4324   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4325   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4326   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4327   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4328   if (version == JNI_VERSION_9) return JNI_TRUE;
4329   if (version == JNI_VERSION_10) return JNI_TRUE;
4330   return JNI_FALSE;
4331 }
4332 
4333 
4334 void Threads::add(JavaThread* p, bool force_daemon) {
4335   // The threads lock must be owned at this point
4336   assert_locked_or_safepoint(Threads_lock);
4337 
4338   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4339 
4340   p-&gt;set_next(_thread_list);
4341   _thread_list = p;
4342 
4343   // Once a JavaThread is added to the Threads list, smr_delete() has
4344   // to be used to delete it. Otherwise we can just delete it directly.
4345   p-&gt;set_on_thread_list();
4346 
4347   _number_of_threads++;
4348   oop threadObj = p-&gt;threadObj();
4349   bool daemon = true;
4350   // Bootstrapping problem: threadObj can be null for initial
4351   // JavaThread (or for threads attached via JNI)
4352   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4353     _number_of_non_daemon_threads++;
4354     daemon = false;
4355   }
4356 
4357   ThreadService::add_thread(p, daemon);
4358 
4359   // Maintain fast thread list
4360   ThreadsSMRSupport::add_thread(p);
4361 
4362   // Possible GC point.
4363   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4364 }
4365 
4366 void Threads::remove(JavaThread* p) {
4367 
4368   // Reclaim the objectmonitors from the omInUseList and omFreeList of the moribund thread.
4369   ObjectSynchronizer::omFlush(p);
4370 
4371   // Extra scope needed for Thread_lock, so we can check
4372   // that we do not remove thread without safepoint code notice
4373   { MutexLocker ml(Threads_lock);
4374 
4375     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), "p must be present");
4376 
4377     // Maintain fast thread list
4378     ThreadsSMRSupport::remove_thread(p);
4379 
4380     JavaThread* current = _thread_list;
4381     JavaThread* prev    = NULL;
4382 
4383     while (current != p) {
4384       prev    = current;
4385       current = current-&gt;next();
4386     }
4387 
4388     if (prev) {
4389       prev-&gt;set_next(current-&gt;next());
4390     } else {
4391       _thread_list = p-&gt;next();
4392     }
4393 
4394     _number_of_threads--;
4395     oop threadObj = p-&gt;threadObj();
4396     bool daemon = true;
4397     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4398       _number_of_non_daemon_threads--;
4399       daemon = false;
4400 
4401       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4402       // on destroy_vm will wake up.
4403       if (number_of_non_daemon_threads() == 1) {
4404         Threads_lock-&gt;notify_all();
4405       }
4406     }
4407     ThreadService::remove_thread(p, daemon);
4408 
4409     // Make sure that safepoint code disregard this thread. This is needed since
4410     // the thread might mess around with locks after this point. This can cause it
4411     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4412     // of this thread since it is removed from the queue.
4413     p-&gt;set_terminated_value();
4414   } // unlock Threads_lock
4415 
4416   // Since Events::log uses a lock, we grab it outside the Threads_lock
4417   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4418 }
4419 
4420 // Operations on the Threads list for GC.  These are not explicitly locked,
4421 // but the garbage collector must provide a safe context for them to run.
4422 // In particular, these things should never be called when the Threads_lock
4423 // is held by some other thread. (Note: the Safepoint abstraction also
4424 // uses the Threads_lock to guarantee this property. It also makes sure that
4425 // all threads gets blocked when exiting or starting).
4426 
4427 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4428   ALL_JAVA_THREADS(p) {
4429     p-&gt;oops_do(f, cf);
4430   }
4431   VMThread::vm_thread()-&gt;oops_do(f, cf);
4432 }
4433 
4434 void Threads::change_thread_claim_parity() {
4435   // Set the new claim parity.
4436   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4437          "Not in range.");
4438   _thread_claim_parity++;
4439   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4440   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4441          "Not in range.");
4442 }
4443 
4444 #ifdef ASSERT
4445 void Threads::assert_all_threads_claimed() {
4446   ALL_JAVA_THREADS(p) {
4447     const int thread_parity = p-&gt;oops_do_parity();
4448     assert((thread_parity == _thread_claim_parity),
4449            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4450   }
4451   VMThread* vmt = VMThread::vm_thread();
4452   const int thread_parity = vmt-&gt;oops_do_parity();
4453   assert((thread_parity == _thread_claim_parity),
4454          "VMThread " PTR_FORMAT " has incorrect parity %d != %d", p2i(vmt), thread_parity, _thread_claim_parity);
4455 }
4456 #endif // ASSERT
4457 
4458 class ParallelOopsDoThreadClosure : public ThreadClosure {
4459 private:
4460   OopClosure* _f;
4461   CodeBlobClosure* _cf;
4462 public:
4463   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4464   void do_thread(Thread* t) {
4465     t-&gt;oops_do(_f, _cf);
4466   }
4467 };
4468 
4469 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4470   ParallelOopsDoThreadClosure tc(f, cf);
4471   possibly_parallel_threads_do(is_par, &amp;tc);
4472 }
4473 
4474 void Threads::nmethods_do(CodeBlobClosure* cf) {
4475   ALL_JAVA_THREADS(p) {
4476     // This is used by the code cache sweeper to mark nmethods that are active
4477     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4478     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4479     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4480       p-&gt;nmethods_do(cf);
4481     }
4482   }
4483 }
4484 
4485 void Threads::metadata_do(void f(Metadata*)) {
4486   ALL_JAVA_THREADS(p) {
4487     p-&gt;metadata_do(f);
4488   }
4489 }
4490 
4491 class ThreadHandlesClosure : public ThreadClosure {
4492   void (*_f)(Metadata*);
4493  public:
4494   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4495   virtual void do_thread(Thread* thread) {
4496     thread-&gt;metadata_handles_do(_f);
4497   }
4498 };
4499 
4500 void Threads::metadata_handles_do(void f(Metadata*)) {
4501   // Only walk the Handles in Thread.
4502   ThreadHandlesClosure handles_closure(f);
4503   threads_do(&amp;handles_closure);
4504 }
4505 
4506 void Threads::deoptimized_wrt_marked_nmethods() {
4507   ALL_JAVA_THREADS(p) {
4508     p-&gt;deoptimized_wrt_marked_nmethods();
4509   }
4510 }
4511 
4512 
4513 // Get count Java threads that are waiting to enter the specified monitor.
4514 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4515                                                          int count,
4516                                                          address monitor) {
4517   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4518 
4519   int i = 0;
4520   DO_JAVA_THREADS(t_list, p) {
4521     if (!p-&gt;can_call_java()) continue;
4522 
4523     address pending = (address)p-&gt;current_pending_monitor();
4524     if (pending == monitor) {             // found a match
4525       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4526       i++;
4527     }
4528   }
4529 
4530   return result;
4531 }
4532 
4533 
4534 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4535                                                       address owner) {
4536   // NULL owner means not locked so we can skip the search
4537   if (owner == NULL) return NULL;
4538 
4539   DO_JAVA_THREADS(t_list, p) {
4540     // first, see if owner is the address of a Java thread
4541     if (owner == (address)p) return p;
4542   }
4543 
4544   // Cannot assert on lack of success here since this function may be
4545   // used by code that is trying to report useful problem information
4546   // like deadlock detection.
4547   if (UseHeavyMonitors) return NULL;
4548 
4549   // If we didn't find a matching Java thread and we didn't force use of
4550   // heavyweight monitors, then the owner is the stack address of the
4551   // Lock Word in the owning Java thread's stack.
4552   //
4553   JavaThread* the_owner = NULL;
4554   DO_JAVA_THREADS(t_list, q) {
4555     if (q-&gt;is_lock_owned(owner)) {
4556       the_owner = q;
4557       break;
4558     }
4559   }
4560 
4561   // cannot assert on lack of success here; see above comment
4562   return the_owner;
4563 }
4564 
4565 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4566 void Threads::print_on(outputStream* st, bool print_stacks,
4567                        bool internal_format, bool print_concurrent_locks,
4568                        bool print_extended_info) {
4569   char buf[32];
4570   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4571 
4572   st-&gt;print_cr("Full thread dump %s (%s %s):",
4573                Abstract_VM_Version::vm_name(),
4574                Abstract_VM_Version::vm_release(),
4575                Abstract_VM_Version::vm_info_string());
4576   st-&gt;cr();
4577 
4578 #if INCLUDE_SERVICES
4579   // Dump concurrent locks
4580   ConcurrentLocksDump concurrent_locks;
4581   if (print_concurrent_locks) {
4582     concurrent_locks.dump_at_safepoint();
4583   }
4584 #endif // INCLUDE_SERVICES
4585 
4586   ThreadsSMRSupport::print_info_on(st);
4587   st-&gt;cr();
4588 
4589   ALL_JAVA_THREADS(p) {
4590     ResourceMark rm;
4591     p-&gt;print_on(st, print_extended_info);
4592     if (print_stacks) {
4593       if (internal_format) {
4594         p-&gt;trace_stack();
4595       } else {
4596         p-&gt;print_stack_on(st);
4597       }
4598     }
4599     st-&gt;cr();
4600 #if INCLUDE_SERVICES
4601     if (print_concurrent_locks) {
4602       concurrent_locks.print_locks_on(p, st);
4603     }
4604 #endif // INCLUDE_SERVICES
4605   }
4606 
4607   VMThread::vm_thread()-&gt;print_on(st);
4608   st-&gt;cr();
4609   Universe::heap()-&gt;print_gc_threads_on(st);
4610   WatcherThread* wt = WatcherThread::watcher_thread();
4611   if (wt != NULL) {
4612     wt-&gt;print_on(st);
4613     st-&gt;cr();
4614   }
4615 
4616   st-&gt;flush();
4617 }
4618 
4619 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4620                              int buflen, bool* found_current) {
4621   if (this_thread != NULL) {
4622     bool is_current = (current == this_thread);
4623     *found_current = *found_current || is_current;
4624     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4625 
4626     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4627     st-&gt;print(" ");
4628     this_thread-&gt;print_on_error(st, buf, buflen);
4629     st-&gt;cr();
4630   }
4631 }
4632 
4633 class PrintOnErrorClosure : public ThreadClosure {
4634   outputStream* _st;
4635   Thread* _current;
4636   char* _buf;
4637   int _buflen;
4638   bool* _found_current;
4639  public:
4640   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4641                       int buflen, bool* found_current) :
4642    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4643 
4644   virtual void do_thread(Thread* thread) {
4645     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4646   }
4647 };
4648 
4649 // Threads::print_on_error() is called by fatal error handler. It's possible
4650 // that VM is not at safepoint and/or current thread is inside signal handler.
4651 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4652 // memory (even in resource area), it might deadlock the error handler.
4653 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4654                              int buflen) {
4655   ThreadsSMRSupport::print_info_on(st);
4656   st-&gt;cr();
4657 
4658   bool found_current = false;
4659   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4660   ALL_JAVA_THREADS(thread) {
4661     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4662   }
4663   st-&gt;cr();
4664 
4665   st-&gt;print_cr("Other Threads:");
4666   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4667   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4668 
4669   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4670   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4671 
4672   if (!found_current) {
4673     st-&gt;cr();
4674     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4675     current-&gt;print_on_error(st, buf, buflen);
4676     st-&gt;cr();
4677   }
4678   st-&gt;cr();
4679 
4680   st-&gt;print_cr("Threads with active compile tasks:");
4681   print_threads_compiling(st, buf, buflen);
4682 }
4683 
4684 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4685   ALL_JAVA_THREADS(thread) {
4686     if (thread-&gt;is_Compiler_thread()) {
4687       CompilerThread* ct = (CompilerThread*) thread;
4688 
4689       // Keep task in local variable for NULL check.
4690       // ct-&gt;_task might be set to NULL by concurring compiler thread
4691       // because it completed the compilation. The task is never freed,
4692       // though, just returned to a free list.
4693       CompileTask* task = ct-&gt;task();
4694       if (task != NULL) {
4695         thread-&gt;print_name_on_error(st, buf, buflen);
4696         task-&gt;print(st, NULL, true, true);
4697       }
4698     }
4699   }
4700 }
4701 
4702 
4703 // Internal SpinLock and Mutex
4704 // Based on ParkEvent
4705 
4706 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4707 //
4708 // We employ SpinLocks _only for low-contention, fixed-length
4709 // short-duration critical sections where we're concerned
4710 // about native mutex_t or HotSpot Mutex:: latency.
4711 // The mux construct provides a spin-then-block mutual exclusion
4712 // mechanism.
4713 //
4714 // Testing has shown that contention on the ListLock guarding gFreeList
4715 // is common.  If we implement ListLock as a simple SpinLock it's common
4716 // for the JVM to devolve to yielding with little progress.  This is true
4717 // despite the fact that the critical sections protected by ListLock are
4718 // extremely short.
4719 //
4720 // TODO-FIXME: ListLock should be of type SpinLock.
4721 // We should make this a 1st-class type, integrated into the lock
4722 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4723 // should have sufficient padding to avoid false-sharing and excessive
4724 // cache-coherency traffic.
4725 
4726 
4727 typedef volatile int SpinLockT;
4728 
4729 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4730   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4731     return;   // normal fast-path return
4732   }
4733 
4734   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4735   int ctr = 0;
4736   int Yields = 0;
4737   for (;;) {
4738     while (*adr != 0) {
4739       ++ctr;
4740       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4741         if (Yields &gt; 5) {
4742           os::naked_short_sleep(1);
4743         } else {
4744           os::naked_yield();
4745           ++Yields;
4746         }
4747       } else {
4748         SpinPause();
4749       }
4750     }
4751     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4752   }
4753 }
4754 
4755 void Thread::SpinRelease(volatile int * adr) {
4756   assert(*adr != 0, "invariant");
4757   OrderAccess::fence();      // guarantee at least release consistency.
4758   // Roach-motel semantics.
4759   // It's safe if subsequent LDs and STs float "up" into the critical section,
4760   // but prior LDs and STs within the critical section can't be allowed
4761   // to reorder or float past the ST that releases the lock.
4762   // Loads and stores in the critical section - which appear in program
4763   // order before the store that releases the lock - must also appear
4764   // before the store that releases the lock in memory visibility order.
4765   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4766   // the ST of 0 into the lock-word which releases the lock, so fence
4767   // more than covers this on all platforms.
4768   *adr = 0;
4769 }
4770 
4771 // muxAcquire and muxRelease:
4772 //
4773 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4774 //    The LSB of the word is set IFF the lock is held.
4775 //    The remainder of the word points to the head of a singly-linked list
4776 //    of threads blocked on the lock.
4777 //
4778 // *  The current implementation of muxAcquire-muxRelease uses its own
4779 //    dedicated Thread._MuxEvent instance.  If we're interested in
4780 //    minimizing the peak number of extant ParkEvent instances then
4781 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4782 //    as certain invariants were satisfied.  Specifically, care would need
4783 //    to be taken with regards to consuming unpark() "permits".
4784 //    A safe rule of thumb is that a thread would never call muxAcquire()
4785 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4786 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4787 //    consume an unpark() permit intended for monitorenter, for instance.
4788 //    One way around this would be to widen the restricted-range semaphore
4789 //    implemented in park().  Another alternative would be to provide
4790 //    multiple instances of the PlatformEvent() for each thread.  One
4791 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4792 //
4793 // *  Usage:
4794 //    -- Only as leaf locks
4795 //    -- for short-term locking only as muxAcquire does not perform
4796 //       thread state transitions.
4797 //
4798 // Alternatives:
4799 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4800 //    but with parking or spin-then-park instead of pure spinning.
4801 // *  Use Taura-Oyama-Yonenzawa locks.
4802 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4803 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4804 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4805 //    acquiring threads use timers (ParkTimed) to detect and recover from
4806 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4807 //    boundaries by using placement-new.
4808 // *  Augment MCS with advisory back-link fields maintained with CAS().
4809 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4810 //    The validity of the backlinks must be ratified before we trust the value.
4811 //    If the backlinks are invalid the exiting thread must back-track through the
4812 //    the forward links, which are always trustworthy.
4813 // *  Add a successor indication.  The LockWord is currently encoded as
4814 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4815 //    to provide the usual futile-wakeup optimization.
4816 //    See RTStt for details.
4817 //
4818 
4819 
4820 const intptr_t LOCKBIT = 1;
4821 
4822 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4823   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4824   if (w == 0) return;
4825   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4826     return;
4827   }
4828 
4829   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4830   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4831   for (;;) {
4832     int its = (os::is_MP() ? 100 : 0) + 1;
4833 
4834     // Optional spin phase: spin-then-park strategy
4835     while (--its &gt;= 0) {
4836       w = *Lock;
4837       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4838         return;
4839       }
4840     }
4841 
4842     Self-&gt;reset();
4843     Self-&gt;OnList = intptr_t(Lock);
4844     // The following fence() isn't _strictly necessary as the subsequent
4845     // CAS() both serializes execution and ratifies the fetched *Lock value.
4846     OrderAccess::fence();
4847     for (;;) {
4848       w = *Lock;
4849       if ((w &amp; LOCKBIT) == 0) {
4850         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4851           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4852           return;
4853         }
4854         continue;      // Interference -- *Lock changed -- Just retry
4855       }
4856       assert(w &amp; LOCKBIT, "invariant");
4857       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4858       if (Atomic::cmpxchg(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4859     }
4860 
4861     while (Self-&gt;OnList != 0) {
4862       Self-&gt;park();
4863     }
4864   }
4865 }
4866 
4867 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4868   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4869   if (w == 0) return;
4870   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4871     return;
4872   }
4873 
4874   ParkEvent * ReleaseAfter = NULL;
4875   if (ev == NULL) {
4876     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4877   }
4878   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4879   for (;;) {
4880     guarantee(ev-&gt;OnList == 0, "invariant");
4881     int its = (os::is_MP() ? 100 : 0) + 1;
4882 
4883     // Optional spin phase: spin-then-park strategy
4884     while (--its &gt;= 0) {
4885       w = *Lock;
4886       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4887         if (ReleaseAfter != NULL) {
4888           ParkEvent::Release(ReleaseAfter);
4889         }
4890         return;
4891       }
4892     }
4893 
4894     ev-&gt;reset();
4895     ev-&gt;OnList = intptr_t(Lock);
4896     // The following fence() isn't _strictly necessary as the subsequent
4897     // CAS() both serializes execution and ratifies the fetched *Lock value.
4898     OrderAccess::fence();
4899     for (;;) {
4900       w = *Lock;
4901       if ((w &amp; LOCKBIT) == 0) {
4902         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4903           ev-&gt;OnList = 0;
4904           // We call ::Release while holding the outer lock, thus
4905           // artificially lengthening the critical section.
4906           // Consider deferring the ::Release() until the subsequent unlock(),
4907           // after we've dropped the outer lock.
4908           if (ReleaseAfter != NULL) {
4909             ParkEvent::Release(ReleaseAfter);
4910           }
4911           return;
4912         }
4913         continue;      // Interference -- *Lock changed -- Just retry
4914       }
4915       assert(w &amp; LOCKBIT, "invariant");
4916       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4917       if (Atomic::cmpxchg(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4918     }
4919 
4920     while (ev-&gt;OnList != 0) {
4921       ev-&gt;park();
4922     }
4923   }
4924 }
4925 
4926 // Release() must extract a successor from the list and then wake that thread.
4927 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4928 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4929 // Release() would :
4930 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4931 // (B) Extract a successor from the private list "in-hand"
4932 // (C) attempt to CAS() the residual back into *Lock over null.
4933 //     If there were any newly arrived threads and the CAS() would fail.
4934 //     In that case Release() would detach the RATs, re-merge the list in-hand
4935 //     with the RATs and repeat as needed.  Alternately, Release() might
4936 //     detach and extract a successor, but then pass the residual list to the wakee.
4937 //     The wakee would be responsible for reattaching and remerging before it
4938 //     competed for the lock.
4939 //
4940 // Both "pop" and DMR are immune from ABA corruption -- there can be
4941 // multiple concurrent pushers, but only one popper or detacher.
4942 // This implementation pops from the head of the list.  This is unfair,
4943 // but tends to provide excellent throughput as hot threads remain hot.
4944 // (We wake recently run threads first).
4945 //
4946 // All paths through muxRelease() will execute a CAS.
4947 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4948 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4949 // executed within the critical section are complete and globally visible before the
4950 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4951 void Thread::muxRelease(volatile intptr_t * Lock)  {
4952   for (;;) {
4953     const intptr_t w = Atomic::cmpxchg((intptr_t)0, Lock, LOCKBIT);
4954     assert(w &amp; LOCKBIT, "invariant");
4955     if (w == LOCKBIT) return;
4956     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4957     assert(List != NULL, "invariant");
4958     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4959     ParkEvent * const nxt = List-&gt;ListNext;
4960     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4961 
4962     // The following CAS() releases the lock and pops the head element.
4963     // The CAS() also ratifies the previously fetched lock-word value.
4964     if (Atomic::cmpxchg(intptr_t(nxt), Lock, w) != w) {
4965       continue;
4966     }
4967     List-&gt;OnList = 0;
4968     OrderAccess::fence();
4969     List-&gt;unpark();
4970     return;
4971   }
4972 }
4973 
4974 
4975 void Threads::verify() {
4976   ALL_JAVA_THREADS(p) {
4977     p-&gt;verify();
4978   }
4979   VMThread* thread = VMThread::vm_thread();
4980   if (thread != NULL) thread-&gt;verify();
4981 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>















































































</pre><form name="eof"><input name="value" value="2" type="hidden" /></form></body></html>
