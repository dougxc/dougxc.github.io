<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/hotspot/share/runtime/thread.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "jvm.h"
  27 #include "classfile/classLoader.hpp"
  28 #include "classfile/javaClasses.hpp"
  29 #include "classfile/moduleEntry.hpp"
  30 #include "classfile/systemDictionary.hpp"
  31 #include "classfile/vmSymbols.hpp"
  32 #include "code/codeCache.hpp"
  33 #include "code/scopeDesc.hpp"
  34 #include "compiler/compileBroker.hpp"
  35 #include "compiler/compileTask.hpp"
  36 #include "gc/shared/barrierSet.hpp"
  37 #include "gc/shared/gcId.hpp"
  38 #include "gc/shared/gcLocker.inline.hpp"
  39 #include "gc/shared/workgroup.hpp"
  40 #include "interpreter/interpreter.hpp"
  41 #include "interpreter/linkResolver.hpp"
  42 #include "interpreter/oopMapCache.hpp"
  43 #include "jfr/jfrEvents.hpp"
  44 #include "jfr/support/jfrThreadId.hpp"
  45 #include "jvmtifiles/jvmtiEnv.hpp"
  46 #include "logging/log.hpp"
  47 #include "logging/logConfiguration.hpp"
  48 #include "logging/logStream.hpp"
  49 #include "memory/allocation.inline.hpp"
  50 #include "memory/metaspaceShared.hpp"
  51 #include "memory/oopFactory.hpp"
  52 #include "memory/resourceArea.hpp"
  53 #include "memory/universe.hpp"
  54 #include "oops/access.inline.hpp"
  55 #include "oops/instanceKlass.hpp"
  56 #include "oops/objArrayOop.hpp"
  57 #include "oops/oop.inline.hpp"
  58 #include "oops/symbol.hpp"
  59 #include "oops/typeArrayOop.inline.hpp"
  60 #include "oops/verifyOopClosure.hpp"
  61 #include "prims/jvm_misc.hpp"
  62 #include "prims/jvmtiExport.hpp"
  63 #include "prims/jvmtiThreadState.hpp"
  64 #include "prims/privilegedStack.hpp"
  65 #include "runtime/arguments.hpp"
  66 #include "runtime/atomic.hpp"
  67 #include "runtime/biasedLocking.hpp"
  68 #include "runtime/fieldDescriptor.inline.hpp"
  69 #include "runtime/flags/jvmFlagConstraintList.hpp"
  70 #include "runtime/flags/jvmFlagRangeList.hpp"
  71 #include "runtime/flags/jvmFlagWriteableList.hpp"
  72 #include "runtime/deoptimization.hpp"
  73 #include "runtime/frame.inline.hpp"
  74 #include "runtime/handshake.hpp"
  75 #include "runtime/init.hpp"
  76 #include "runtime/interfaceSupport.inline.hpp"
  77 #include "runtime/java.hpp"
  78 #include "runtime/javaCalls.hpp"
  79 #include "runtime/jniHandles.inline.hpp"
  80 #include "runtime/jniPeriodicChecker.hpp"
  81 #include "runtime/memprofiler.hpp"
  82 #include "runtime/mutexLocker.hpp"
  83 #include "runtime/objectMonitor.hpp"
  84 #include "runtime/orderAccess.hpp"
  85 #include "runtime/osThread.hpp"
  86 #include "runtime/prefetch.inline.hpp"
  87 #include "runtime/safepoint.hpp"
  88 #include "runtime/safepointMechanism.inline.hpp"
  89 #include "runtime/safepointVerifiers.hpp"
  90 #include "runtime/sharedRuntime.hpp"
  91 #include "runtime/statSampler.hpp"
  92 #include "runtime/stubRoutines.hpp"
  93 #include "runtime/sweeper.hpp"
  94 #include "runtime/task.hpp"
  95 #include "runtime/thread.inline.hpp"
  96 #include "runtime/threadCritical.hpp"
  97 #include "runtime/threadSMR.inline.hpp"
  98 #include "runtime/threadStatisticalInfo.hpp"
  99 #include "runtime/timer.hpp"
 100 #include "runtime/timerTrace.hpp"
 101 #include "runtime/vframe.inline.hpp"
 102 #include "runtime/vframeArray.hpp"
 103 #include "runtime/vframe_hp.hpp"
 104 #include "runtime/vmThread.hpp"
 105 #include "runtime/vm_operations.hpp"
 106 #include "runtime/vm_version.hpp"
 107 #include "services/attachListener.hpp"
 108 #include "services/management.hpp"
 109 #include "services/memTracker.hpp"
 110 #include "services/threadService.hpp"
 111 #include "utilities/align.hpp"
 112 #include "utilities/copy.hpp"
 113 #include "utilities/defaultStream.hpp"
 114 #include "utilities/dtrace.hpp"
 115 #include "utilities/events.hpp"
 116 #include "utilities/macros.hpp"
 117 #include "utilities/preserveException.hpp"
 118 #include "utilities/singleWriterSynchronizer.hpp"
 119 #include "utilities/vmError.hpp"
 120 #if INCLUDE_JVMCI
 121 #include "jvmci/jvmciCompiler.hpp"
 122 #include "jvmci/jvmciRuntime.hpp"
 123 #include "logging/logHandle.hpp"
 124 #endif
 125 #ifdef COMPILER1
 126 #include "c1/c1_Compiler.hpp"
 127 #endif
 128 #ifdef COMPILER2
 129 #include "opto/c2compiler.hpp"
 130 #include "opto/idealGraphPrinter.hpp"
 131 #endif
 132 #if INCLUDE_RTM_OPT
 133 #include "runtime/rtmLocking.hpp"
 134 #endif
 135 #if INCLUDE_JFR
 136 #include "jfr/jfr.hpp"
 137 #endif
 138 
 139 // Initialization after module runtime initialization
 140 void universe_post_module_init();  // must happen after call_initPhase2
 141 
 142 #ifdef DTRACE_ENABLED
 143 
 144 // Only bother with this argument setup if dtrace is available
 145 
 146   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 147   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 150     {                                                                      \
 151       ResourceMark rm(this);                                               \
 152       int len = 0;                                                         \
 153       const char* name = (javathread)-&gt;get_thread_name();                  \
 154       len = strlen(name);                                                  \
 155       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 156         (char *) name, len,                                                \
 157         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 158         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 159         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 160     }
 161 
 162 #else //  ndef DTRACE_ENABLED
 163 
 164   #define DTRACE_THREAD_PROBE(probe, javathread)
 165 
 166 #endif // ndef DTRACE_ENABLED
 167 
 168 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 169 // Current thread is maintained as a thread-local variable
 170 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;
 171 #endif
 172 
 173 // ======= Thread ========
 174 // Support for forcing alignment of thread objects for biased locking
 175 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 176   if (UseBiasedLocking) {
 177     const int alignment = markOopDesc::biased_lock_alignment;
 178     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 179     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 180                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 181                                                          AllocFailStrategy::RETURN_NULL);
 182     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 183     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 184            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 185            "JavaThread alignment code overflowed allocated storage");
 186     if (aligned_addr != real_malloc_addr) {
 187       log_info(biasedlocking)("Aligned thread " INTPTR_FORMAT " to " INTPTR_FORMAT,
 188                               p2i(real_malloc_addr),
 189                               p2i(aligned_addr));
 190     }
 191     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 192     return aligned_addr;
 193   } else {
 194     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 195                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 196   }
 197 }
 198 
 199 void Thread::operator delete(void* p) {
 200   if (UseBiasedLocking) {
 201     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 202   } else {
 203     FreeHeap(p);
 204   }
 205 }
 206 
 207 void JavaThread::smr_delete() {
 208   if (_on_thread_list) {
 209     ThreadsSMRSupport::smr_delete(this);
 210   } else {
 211     delete this;
 212   }
 213 }
 214 
 215 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 216 // JavaThread
 217 
 218 
 219 Thread::Thread() {
 220   // stack and get_thread
 221   set_stack_base(NULL);
 222   set_stack_size(0);
 223   set_self_raw_id(0);
 224   set_lgrp_id(-1);
 225   DEBUG_ONLY(clear_suspendible_thread();)
 226 
 227   // allocated data structures
 228   set_osthread(NULL);
 229   set_resource_area(new (mtThread)ResourceArea());
 230   DEBUG_ONLY(_current_resource_mark = NULL;)
 231   set_handle_area(new (mtThread) HandleArea(NULL));
 232   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 233   set_active_handles(NULL);
 234   set_free_handle_block(NULL);
 235   set_last_handle_mark(NULL);
 236 
 237   // This initial value ==&gt; never claimed.
 238   _oops_do_parity = 0;
 239   _threads_hazard_ptr = NULL;
 240   _threads_list_ptr = NULL;
 241   _nested_threads_hazard_ptr_cnt = 0;
 242   _rcu_counter = 0;
 243 
 244   // the handle mark links itself to last_handle_mark
 245   new HandleMark(this);
 246 
 247   // plain initialization
 248   debug_only(_owned_locks = NULL;)
 249   debug_only(_allow_allocation_count = 0;)
 250   NOT_PRODUCT(_allow_safepoint_count = 0;)
 251   NOT_PRODUCT(_skip_gcalot = false;)
 252   _jvmti_env_iteration_count = 0;
 253   set_allocated_bytes(0);
 254   _vm_operation_started_count = 0;
 255   _vm_operation_completed_count = 0;
 256   _current_pending_monitor = NULL;
 257   _current_pending_monitor_is_from_java = true;
 258   _current_waiting_monitor = NULL;
 259   _num_nested_signal = 0;
 260   omFreeList = NULL;
 261   omFreeCount = 0;
 262   omFreeProvision = 32;
 263   omInUseList = NULL;
 264   omInUseCount = 0;
 265 
 266 #ifdef ASSERT
 267   _visited_for_critical_count = false;
 268 #endif
 269 
 270   _SR_lock = new Monitor(Mutex::suspend_resume, "SR_lock", true,
 271                          Monitor::_safepoint_check_sometimes);
 272   _suspend_flags = 0;
 273 
 274   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 275   _hashStateX = os::random();
 276   _hashStateY = 842502087;
 277   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 278   _hashStateW = 273326509;
 279 
 280   _OnTrap   = 0;
 281   _Stalled  = 0;
 282   _TypeTag  = 0x2BAD;
 283 
 284   // Many of the following fields are effectively final - immutable
 285   // Note that nascent threads can't use the Native Monitor-Mutex
 286   // construct until the _MutexEvent is initialized ...
 287   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 288   // we might instead use a stack of ParkEvents that we could provision on-demand.
 289   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 290   // and ::Release()
 291   _ParkEvent   = ParkEvent::Allocate(this);
 292   _SleepEvent  = ParkEvent::Allocate(this);
 293   _MutexEvent  = ParkEvent::Allocate(this);
 294   _MuxEvent    = ParkEvent::Allocate(this);
 295 
 296 #ifdef CHECK_UNHANDLED_OOPS
 297   if (CheckUnhandledOops) {
 298     _unhandled_oops = new UnhandledOops(this);
 299   }
 300 #endif // CHECK_UNHANDLED_OOPS
 301 #ifdef ASSERT
 302   if (UseBiasedLocking) {
 303     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, "forced alignment of thread object failed");
 304     assert(this == _real_malloc_address ||
 305            this == align_up(_real_malloc_address, (int)markOopDesc::biased_lock_alignment),
 306            "bug in forced alignment of thread objects");
 307   }
 308 #endif // ASSERT
 309 
 310   // Notify the barrier set that a thread is being created. Note that some
 311   // threads are created before a barrier set is available. The call to
 312   // BarrierSet::on_thread_create() for these threads is therefore deferred
 313   // to BarrierSet::set_barrier_set().
 314   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 315   if (barrier_set != NULL) {
 316     barrier_set-&gt;on_thread_create(this);
 317   } else {
 318     DEBUG_ONLY(Threads::inc_threads_before_barrier_set();)
 319   }
 320 }
 321 
 322 void Thread::initialize_thread_current() {
 323 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 324   assert(_thr_current == NULL, "Thread::current already initialized");
 325   _thr_current = this;
 326 #endif
 327   assert(ThreadLocalStorage::thread() == NULL, "ThreadLocalStorage::thread already initialized");
 328   ThreadLocalStorage::set_thread(this);
 329   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 330 }
 331 
 332 void Thread::clear_thread_current() {
 333   assert(Thread::current() == ThreadLocalStorage::thread(), "TLS mismatch!");
 334 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 335   _thr_current = NULL;
 336 #endif
 337   ThreadLocalStorage::set_thread(NULL);
 338 }
 339 
 340 void Thread::record_stack_base_and_size() {
 341   set_stack_base(os::current_stack_base());
 342   set_stack_size(os::current_stack_size());
 343   // CR 7190089: on Solaris, primordial thread's stack is adjusted
 344   // in initialize_thread(). Without the adjustment, stack size is
 345   // incorrect if stack is set to unlimited (ulimit -s unlimited).
 346   // So far, only Solaris has real implementation of initialize_thread().
 347   //
 348   // set up any platform-specific state.
 349   os::initialize_thread(this);
 350 
 351   // Set stack limits after thread is initialized.
 352   if (is_Java_thread()) {
 353     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 354     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 355   }
 356 #if INCLUDE_NMT
 357   // record thread's native stack, stack grows downward
 358   MemTracker::record_thread_stack(stack_end(), stack_size());
 359 #endif // INCLUDE_NMT
 360   log_debug(os, thread)("Thread " UINTX_FORMAT " stack dimensions: "
 361     PTR_FORMAT "-" PTR_FORMAT " (" SIZE_FORMAT "k).",
 362     os::current_thread_id(), p2i(stack_base() - stack_size()),
 363     p2i(stack_base()), stack_size()/1024);
 364 }
 365 
 366 
 367 Thread::~Thread() {
 368   JFR_ONLY(Jfr::on_thread_destruct(this);)
 369 
 370   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 371   // set might not be available if we encountered errors during bootstrapping.
 372   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 373   if (barrier_set != NULL) {
 374     barrier_set-&gt;on_thread_destroy(this);
 375   }
 376 
 377 
 378   // stack_base can be NULL if the thread is never started or exited before
 379   // record_stack_base_and_size called. Although, we would like to ensure
 380   // that all started threads do call record_stack_base_and_size(), there is
 381   // not proper way to enforce that.
 382 #if INCLUDE_NMT
 383   if (_stack_base != NULL) {
 384     MemTracker::release_thread_stack(stack_end(), stack_size());
 385 #ifdef ASSERT
 386     set_stack_base(NULL);
 387 #endif
 388   }
 389 #endif // INCLUDE_NMT
 390 
 391   // deallocate data structures
 392   delete resource_area();
 393   // since the handle marks are using the handle area, we have to deallocated the root
 394   // handle mark before deallocating the thread's handle area,
 395   assert(last_handle_mark() != NULL, "check we have an element");
 396   delete last_handle_mark();
 397   assert(last_handle_mark() == NULL, "check we have reached the end");
 398 
 399   // It's possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 400   // We NULL out the fields for good hygiene.
 401   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 402   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;
 403   ParkEvent::Release(_MutexEvent); _MutexEvent  = NULL;
 404   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 405 
 406   delete handle_area();
 407   delete metadata_handles();
 408 
 409   // SR_handler uses this as a termination indicator -
 410   // needs to happen before os::free_thread()
 411   delete _SR_lock;
 412   _SR_lock = NULL;
 413 
 414   // osthread() can be NULL, if creation of thread failed.
 415   if (osthread() != NULL) os::free_thread(osthread());
 416 
 417   // clear Thread::current if thread is deleting itself.
 418   // Needed to ensure JNI correctly detects non-attached threads.
 419   if (this == Thread::current()) {
 420     clear_thread_current();
 421   }
 422 
 423   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 424 }
 425 
 426 // NOTE: dummy function for assertion purpose.
 427 void Thread::run() {
 428   ShouldNotReachHere();
 429 }
 430 
 431 #ifdef ASSERT
 432 // A JavaThread is considered "dangling" if it is not the current
 433 // thread, has been added the Threads list, the system is not at a
 434 // safepoint and the Thread is not "protected".
 435 //
 436 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 437   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 438          !((JavaThread *) thread)-&gt;on_thread_list() ||
 439          SafepointSynchronize::is_at_safepoint() ||
 440          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 441          "possibility of dangling Thread pointer");
 442 }
 443 #endif
 444 
 445 ThreadPriority Thread::get_priority(const Thread* const thread) {
 446   ThreadPriority priority;
 447   // Can return an error!
 448   (void)os::get_priority(thread, priority);
 449   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "non-Java priority found");
 450   return priority;
 451 }
 452 
 453 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 454   debug_only(check_for_dangling_thread_pointer(thread);)
 455   // Can return an error!
 456   (void)os::set_priority(thread, priority);
 457 }
 458 
 459 
 460 void Thread::start(Thread* thread) {
 461   // Start is different from resume in that its safety is guaranteed by context or
 462   // being called from a Java method synchronized on the Thread object.
 463   if (!DisableStartThread) {
 464     if (thread-&gt;is_Java_thread()) {
 465       // Initialize the thread state to RUNNABLE before starting this thread.
 466       // Can not set it after the thread started because we do not know the
 467       // exact thread state at that time. It could be in MONITOR_WAIT or
 468       // in SLEEPING or some other state.
 469       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 470                                           java_lang_Thread::RUNNABLE);
 471     }
 472     os::start_thread(thread);
 473   }
 474 }
 475 
 476 // Enqueue a VM_Operation to do the job for us - sometime later
 477 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 478   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);
 479   VMThread::execute(vm_stop);
 480 }
 481 
 482 
 483 // Check if an external suspend request has completed (or has been
 484 // cancelled). Returns true if the thread is externally suspended and
 485 // false otherwise.
 486 //
 487 // The bits parameter returns information about the code path through
 488 // the routine. Useful for debugging:
 489 //
 490 // set in is_ext_suspend_completed():
 491 // 0x00000001 - routine was entered
 492 // 0x00000010 - routine return false at end
 493 // 0x00000100 - thread exited (return false)
 494 // 0x00000200 - suspend request cancelled (return false)
 495 // 0x00000400 - thread suspended (return true)
 496 // 0x00001000 - thread is in a suspend equivalent state (return true)
 497 // 0x00002000 - thread is native and walkable (return true)
 498 // 0x00004000 - thread is native_trans and walkable (needed retry)
 499 //
 500 // set in wait_for_ext_suspend_completion():
 501 // 0x00010000 - routine was entered
 502 // 0x00020000 - suspend request cancelled before loop (return false)
 503 // 0x00040000 - thread suspended before loop (return true)
 504 // 0x00080000 - suspend request cancelled in loop (return false)
 505 // 0x00100000 - thread suspended in loop (return true)
 506 // 0x00200000 - suspend not completed during retry loop (return false)
 507 
 508 // Helper class for tracing suspend wait debug bits.
 509 //
 510 // 0x00000100 indicates that the target thread exited before it could
 511 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 512 // 0x00080000 each indicate a cancelled suspend request so they don't
 513 // count as wait failures either.
 514 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 515 
 516 class TraceSuspendDebugBits : public StackObj {
 517  private:
 518   JavaThread * jt;
 519   bool         is_wait;
 520   bool         called_by_wait;  // meaningful when !is_wait
 521   uint32_t *   bits;
 522 
 523  public:
 524   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 525                         uint32_t *_bits) {
 526     jt             = _jt;
 527     is_wait        = _is_wait;
 528     called_by_wait = _called_by_wait;
 529     bits           = _bits;
 530   }
 531 
 532   ~TraceSuspendDebugBits() {
 533     if (!is_wait) {
 534 #if 1
 535       // By default, don't trace bits for is_ext_suspend_completed() calls.
 536       // That trace is very chatty.
 537       return;
 538 #else
 539       if (!called_by_wait) {
 540         // If tracing for is_ext_suspend_completed() is enabled, then only
 541         // trace calls to it from wait_for_ext_suspend_completion()
 542         return;
 543       }
 544 #endif
 545     }
 546 
 547     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 548       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 549         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 550         ResourceMark rm;
 551 
 552         tty-&gt;print_cr(
 553                       "Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)",
 554                       jt-&gt;get_thread_name(), *bits);
 555 
 556         guarantee(!AssertOnSuspendWaitFailure, "external suspend wait failed");
 557       }
 558     }
 559   }
 560 };
 561 #undef DEBUG_FALSE_BITS
 562 
 563 
 564 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 565                                           uint32_t *bits) {
 566   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 567 
 568   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 569   bool do_trans_retry;           // flag to force the retry
 570 
 571   *bits |= 0x00000001;
 572 
 573   do {
 574     do_trans_retry = false;
 575 
 576     if (is_exiting()) {
 577       // Thread is in the process of exiting. This is always checked
 578       // first to reduce the risk of dereferencing a freed JavaThread.
 579       *bits |= 0x00000100;
 580       return false;
 581     }
 582 
 583     if (!is_external_suspend()) {
 584       // Suspend request is cancelled. This is always checked before
 585       // is_ext_suspended() to reduce the risk of a rogue resume
 586       // confusing the thread that made the suspend request.
 587       *bits |= 0x00000200;
 588       return false;
 589     }
 590 
 591     if (is_ext_suspended()) {
 592       // thread is suspended
 593       *bits |= 0x00000400;
 594       return true;
 595     }
 596 
 597     // Now that we no longer do hard suspends of threads running
 598     // native code, the target thread can be changing thread state
 599     // while we are in this routine:
 600     //
 601     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 602     //
 603     // We save a copy of the thread state as observed at this moment
 604     // and make our decision about suspend completeness based on the
 605     // copy. This closes the race where the thread state is seen as
 606     // _thread_in_native_trans in the if-thread_blocked check, but is
 607     // seen as _thread_blocked in if-thread_in_native_trans check.
 608     JavaThreadState save_state = thread_state();
 609 
 610     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 611       // If the thread's state is _thread_blocked and this blocking
 612       // condition is known to be equivalent to a suspend, then we can
 613       // consider the thread to be externally suspended. This means that
 614       // the code that sets _thread_blocked has been modified to do
 615       // self-suspension if the blocking condition releases. We also
 616       // used to check for CONDVAR_WAIT here, but that is now covered by
 617       // the _thread_blocked with self-suspension check.
 618       //
 619       // Return true since we wouldn't be here unless there was still an
 620       // external suspend request.
 621       *bits |= 0x00001000;
 622       return true;
 623     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 624       // Threads running native code will self-suspend on native==&gt;VM/Java
 625       // transitions. If its stack is walkable (should always be the case
 626       // unless this function is called before the actual java_suspend()
 627       // call), then the wait is done.
 628       *bits |= 0x00002000;
 629       return true;
 630     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 631                save_state == _thread_in_native_trans &amp;&amp;
 632                frame_anchor()-&gt;walkable()) {
 633       // The thread is transitioning from thread_in_native to another
 634       // thread state. check_safepoint_and_suspend_for_native_trans()
 635       // will force the thread to self-suspend. If it hasn't gotten
 636       // there yet we may have caught the thread in-between the native
 637       // code check above and the self-suspend. Lucky us. If we were
 638       // called by wait_for_ext_suspend_completion(), then it
 639       // will be doing the retries so we don't have to.
 640       //
 641       // Since we use the saved thread state in the if-statement above,
 642       // there is a chance that the thread has already transitioned to
 643       // _thread_blocked by the time we get here. In that case, we will
 644       // make a single unnecessary pass through the logic below. This
 645       // doesn't hurt anything since we still do the trans retry.
 646 
 647       *bits |= 0x00004000;
 648 
 649       // Once the thread leaves thread_in_native_trans for another
 650       // thread state, we break out of this retry loop. We shouldn't
 651       // need this flag to prevent us from getting back here, but
 652       // sometimes paranoia is good.
 653       did_trans_retry = true;
 654 
 655       // We wait for the thread to transition to a more usable state.
 656       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 657         // We used to do an "os::yield_all(i)" call here with the intention
 658         // that yielding would increase on each retry. However, the parameter
 659         // is ignored on Linux which means the yield didn't scale up. Waiting
 660         // on the SR_lock below provides a much more predictable scale up for
 661         // the delay. It also provides a simple/direct point to check for any
 662         // safepoint requests from the VMThread
 663 
 664         // temporarily drops SR_lock while doing wait with safepoint check
 665         // (if we're a JavaThread - the WatcherThread can also call this)
 666         // and increase delay with each retry
 667         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 668 
 669         // check the actual thread state instead of what we saved above
 670         if (thread_state() != _thread_in_native_trans) {
 671           // the thread has transitioned to another thread state so
 672           // try all the checks (except this one) one more time.
 673           do_trans_retry = true;
 674           break;
 675         }
 676       } // end retry loop
 677 
 678 
 679     }
 680   } while (do_trans_retry);
 681 
 682   *bits |= 0x00000010;
 683   return false;
 684 }
 685 
 686 // Wait for an external suspend request to complete (or be cancelled).
 687 // Returns true if the thread is externally suspended and false otherwise.
 688 //
 689 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 690                                                  uint32_t *bits) {
 691   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 692                              false /* !called_by_wait */, bits);
 693 
 694   // local flag copies to minimize SR_lock hold time
 695   bool is_suspended;
 696   bool pending;
 697   uint32_t reset_bits;
 698 
 699   // set a marker so is_ext_suspend_completed() knows we are the caller
 700   *bits |= 0x00010000;
 701 
 702   // We use reset_bits to reinitialize the bits value at the top of
 703   // each retry loop. This allows the caller to make use of any
 704   // unused bits for their own marking purposes.
 705   reset_bits = *bits;
 706 
 707   {
 708     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 709     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 710                                             delay, bits);
 711     pending = is_external_suspend();
 712   }
 713   // must release SR_lock to allow suspension to complete
 714 
 715   if (!pending) {
 716     // A cancelled suspend request is the only false return from
 717     // is_ext_suspend_completed() that keeps us from entering the
 718     // retry loop.
 719     *bits |= 0x00020000;
 720     return false;
 721   }
 722 
 723   if (is_suspended) {
 724     *bits |= 0x00040000;
 725     return true;
 726   }
 727 
 728   for (int i = 1; i &lt;= retries; i++) {
 729     *bits = reset_bits;  // reinit to only track last retry
 730 
 731     // We used to do an "os::yield_all(i)" call here with the intention
 732     // that yielding would increase on each retry. However, the parameter
 733     // is ignored on Linux which means the yield didn't scale up. Waiting
 734     // on the SR_lock below provides a much more predictable scale up for
 735     // the delay. It also provides a simple/direct point to check for any
 736     // safepoint requests from the VMThread
 737 
 738     {
 739       MutexLocker ml(SR_lock());
 740       // wait with safepoint check (if we're a JavaThread - the WatcherThread
 741       // can also call this)  and increase delay with each retry
 742       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);
 743 
 744       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 745                                               delay, bits);
 746 
 747       // It is possible for the external suspend request to be cancelled
 748       // (by a resume) before the actual suspend operation is completed.
 749       // Refresh our local copy to see if we still need to wait.
 750       pending = is_external_suspend();
 751     }
 752 
 753     if (!pending) {
 754       // A cancelled suspend request is the only false return from
 755       // is_ext_suspend_completed() that keeps us from staying in the
 756       // retry loop.
 757       *bits |= 0x00080000;
 758       return false;
 759     }
 760 
 761     if (is_suspended) {
 762       *bits |= 0x00100000;
 763       return true;
 764     }
 765   } // end retry loop
 766 
 767   // thread did not suspend after all our retries
 768   *bits |= 0x00200000;
 769   return false;
 770 }
 771 
 772 // Called from API entry points which perform stack walking. If the
 773 // associated JavaThread is the current thread, then wait_for_suspend
 774 // is not used. Otherwise, it determines if we should wait for the
 775 // "other" thread to complete external suspension. (NOTE: in future
 776 // releases the suspension mechanism should be reimplemented so this
 777 // is not necessary.)
 778 //
 779 bool
 780 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 781   if (this != JavaThread::current()) {
 782     // "other" threads require special handling.
 783     if (wait_for_suspend) {
 784       // We are allowed to wait for the external suspend to complete
 785       // so give the other thread a chance to get suspended.
 786       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 787                                            SuspendRetryDelay, bits)) {
 788         // Didn't make it so let the caller know.
 789         return false;
 790       }
 791     }
 792     // We aren't allowed to wait for the external suspend to complete
 793     // so if the other thread isn't externally suspended we need to
 794     // let the caller know.
 795     else if (!is_ext_suspend_completed_with_lock(bits)) {
 796       return false;
 797     }
 798   }
 799 
 800   return true;
 801 }
 802 
 803 #ifndef PRODUCT
 804 void JavaThread::record_jump(address target, address instr, const char* file,
 805                              int line) {
 806 
 807   // This should not need to be atomic as the only way for simultaneous
 808   // updates is via interrupts. Even then this should be rare or non-existent
 809   // and we don't care that much anyway.
 810 
 811   int index = _jmp_ring_index;
 812   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);
 813   _jmp_ring[index]._target = (intptr_t) target;
 814   _jmp_ring[index]._instruction = (intptr_t) instr;
 815   _jmp_ring[index]._file = file;
 816   _jmp_ring[index]._line = line;
 817 }
 818 #endif // PRODUCT
 819 
 820 void Thread::interrupt(Thread* thread) {
 821   debug_only(check_for_dangling_thread_pointer(thread);)
 822   os::interrupt(thread);
 823 }
 824 
 825 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {
 826   debug_only(check_for_dangling_thread_pointer(thread);)
 827   // Note:  If clear_interrupted==false, this simply fetches and
 828   // returns the value of the field osthread()-&gt;interrupted().
 829   return os::is_interrupted(thread, clear_interrupted);
 830 }
 831 
 832 
 833 // GC Support
 834 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {
 835   int thread_parity = _oops_do_parity;
 836   if (thread_parity != strong_roots_parity) {
 837     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);
 838     if (res == thread_parity) {
 839       return true;
 840     } else {
 841       guarantee(res == strong_roots_parity, "Or else what?");
 842       return false;
 843     }
 844   }
 845   return false;
 846 }
 847 
 848 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 849   active_handles()-&gt;oops_do(f);
 850   // Do oop for ThreadShadow
 851   f-&gt;do_oop((oop*)&amp;_pending_exception);
 852   handle_area()-&gt;oops_do(f);
 853 
 854   if (MonitorInUseLists) {
 855     // When using thread local monitor lists, we scan them here,
 856     // and the remaining global monitors in ObjectSynchronizer::oops_do().
 857     ObjectSynchronizer::thread_local_used_oops_do(this, f);
 858   }
 859 }
 860 
 861 void Thread::metadata_handles_do(void f(Metadata*)) {
 862   // Only walk the Handles in Thread.
 863   if (metadata_handles() != NULL) {
 864     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 865       f(metadata_handles()-&gt;at(i));
 866     }
 867   }
 868 }
 869 
 870 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 871   // get_priority assumes osthread initialized
 872   if (osthread() != NULL) {
 873     int os_prio;
 874     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 875       st-&gt;print("os_prio=%d ", os_prio);
 876     }
 877 
 878     st-&gt;print("cpu=%.2fms ",
 879               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 880               );
 881     st-&gt;print("elapsed=%.2fs ",
 882               _statistical_info.getElapsedTime() / 1000.0
 883               );
 884     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 885       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 886       st-&gt;print("allocated=" SIZE_FORMAT "%s ",
 887                 byte_size_in_proper_unit(allocated_bytes),
 888                 proper_unit_for_byte_size(allocated_bytes)
 889                 );
 890       st-&gt;print("defined_classes=" INT64_FORMAT " ", _statistical_info.getDefineClassCount());
 891     }
 892 
 893     st-&gt;print("tid=" INTPTR_FORMAT " ", p2i(this));
 894     osthread()-&gt;print_on(st);
 895   }
 896   ThreadsSMRSupport::print_info_on(this, st);
 897   st-&gt;print(" ");
 898   debug_only(if (WizardMode) print_owned_locks_on(st);)
 899 }
 900 
 901 // Thread::print_on_error() is called by fatal error handler. Don't use
 902 // any lock or allocate memory.
 903 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 904   assert(!(is_Compiler_thread() || is_Java_thread()), "Can't call name() here if it allocates");
 905 
 906   if (is_VM_thread())                 { st-&gt;print("VMThread"); }
 907   else if (is_GC_task_thread())       { st-&gt;print("GCTaskThread"); }
 908   else if (is_Watcher_thread())       { st-&gt;print("WatcherThread"); }
 909   else if (is_ConcurrentGC_thread())  { st-&gt;print("ConcurrentGCThread"); }
 910   else                                { st-&gt;print("Thread"); }
 911 
 912   if (is_Named_thread()) {
 913     st-&gt;print(" \"%s\"", name());
 914   }
 915 
 916   st-&gt;print(" [stack: " PTR_FORMAT "," PTR_FORMAT "]",
 917             p2i(stack_end()), p2i(stack_base()));
 918 
 919   if (osthread()) {
 920     st-&gt;print(" [id=%d]", osthread()-&gt;thread_id());
 921   }
 922 
 923   ThreadsSMRSupport::print_info_on(this, st);
 924 }
 925 
 926 void Thread::print_value_on(outputStream* st) const {
 927   if (is_Named_thread()) {
 928     st-&gt;print(" \"%s\" ", name());
 929   }
 930   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 931 }
 932 
 933 #ifdef ASSERT
 934 void Thread::print_owned_locks_on(outputStream* st) const {
 935   Monitor *cur = _owned_locks;
 936   if (cur == NULL) {
 937     st-&gt;print(" (no locks) ");
 938   } else {
 939     st-&gt;print_cr(" Locks owned:");
 940     while (cur) {
 941       cur-&gt;print_on(st);
 942       cur = cur-&gt;next();
 943     }
 944   }
 945 }
 946 
 947 static int ref_use_count  = 0;
 948 
 949 bool Thread::owns_locks_but_compiled_lock() const {
 950   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 951     if (cur != Compile_lock) return true;
 952   }
 953   return false;
 954 }
 955 
 956 
 957 #endif
 958 
 959 #ifndef PRODUCT
 960 
 961 // The flag: potential_vm_operation notifies if this particular safepoint state could potentially
 962 // invoke the vm-thread (e.g., an oop allocation). In that case, we also have to make sure that
 963 // no locks which allow_vm_block's are held
 964 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {
 965   // Check if current thread is allowed to block at a safepoint
 966   if (!(_allow_safepoint_count == 0)) {
 967     fatal("Possible safepoint reached by thread that does not allow it");
 968   }
 969   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
 970     fatal("LEAF method calling lock?");
 971   }
 972 
 973 #ifdef ASSERT
 974   if (potential_vm_operation &amp;&amp; is_Java_thread()
 975       &amp;&amp; !Universe::is_bootstrapping()) {
 976     // Make sure we do not hold any locks that the VM thread also uses.
 977     // This could potentially lead to deadlocks
 978     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {
 979       // Threads_lock is special, since the safepoint synchronization will not start before this is
 980       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,
 981       // since it is used to transfer control between JavaThreads and the VMThread
 982       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!
 983       if ((cur-&gt;allow_vm_block() &amp;&amp;
 984            cur != Threads_lock &amp;&amp;
 985            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation
 986            cur != VMOperationRequest_lock &amp;&amp;
 987            cur != VMOperationQueue_lock) ||
 988            cur-&gt;rank() == Mutex::special) {
 989         fatal("Thread holding lock at safepoint that vm can block on: %s", cur-&gt;name());
 990       }
 991     }
 992   }
 993 
 994   if (GCALotAtAllSafepoints) {
 995     // We could enter a safepoint here and thus have a gc
 996     InterfaceSupport::check_gc_alot();
 997   }
 998 #endif
 999 }
1000 #endif
1001 
1002 bool Thread::is_in_stack(address adr) const {
1003   assert(Thread::current() == this, "is_in_stack can only be called from current thread");
1004   address end = os::current_stack_pointer();
1005   // Allow non Java threads to call this without stack_base
1006   if (_stack_base == NULL) return true;
1007   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;
1008 
1009   return false;
1010 }
1011 
1012 bool Thread::is_in_usable_stack(address adr) const {
1013   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
1014   size_t usable_stack_size = _stack_size - stack_guard_size;
1015 
1016   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
1017 }
1018 
1019 
1020 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1021 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1022 // used for compilation in the future. If that change is made, the need for these methods
1023 // should be revisited, and they should be removed if possible.
1024 
1025 bool Thread::is_lock_owned(address adr) const {
1026   return on_local_stack(adr);
1027 }
1028 
1029 bool Thread::set_as_starting_thread() {
1030   // NOTE: this must be called inside the main thread.
1031   return os::create_main_thread((JavaThread*)this);
1032 }
1033 
1034 static void initialize_class(Symbol* class_name, TRAPS) {
1035   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1036   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1037 }
1038 
1039 
1040 // Creates the initial ThreadGroup
1041 static Handle create_initial_thread_group(TRAPS) {
1042   Handle system_instance = JavaCalls::construct_new_instance(
1043                             SystemDictionary::ThreadGroup_klass(),
1044                             vmSymbols::void_method_signature(),
1045                             CHECK_NH);
1046   Universe::set_system_thread_group(system_instance());
1047 
1048   Handle string = java_lang_String::create_from_str("main", CHECK_NH);
1049   Handle main_instance = JavaCalls::construct_new_instance(
1050                             SystemDictionary::ThreadGroup_klass(),
1051                             vmSymbols::threadgroup_string_void_signature(),
1052                             system_instance,
1053                             string,
1054                             CHECK_NH);
1055   return main_instance;
1056 }
1057 
1058 // Creates the initial Thread
1059 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1060                                  TRAPS) {
1061   InstanceKlass* ik = SystemDictionary::Thread_klass();
1062   assert(ik-&gt;is_initialized(), "must be");
1063   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1064 
1065   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1066   // constructor calls Thread.current(), which must be set here for the
1067   // initial thread.
1068   java_lang_Thread::set_thread(thread_oop(), thread);
1069   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1070   thread-&gt;set_threadObj(thread_oop());
1071 
1072   Handle string = java_lang_String::create_from_str("main", CHECK_NULL);
1073 
1074   JavaValue result(T_VOID);
1075   JavaCalls::call_special(&amp;result, thread_oop,
1076                           ik,
1077                           vmSymbols::object_initializer_name(),
1078                           vmSymbols::threadgroup_string_void_signature(),
1079                           thread_group,
1080                           string,
1081                           CHECK_NULL);
1082   return thread_oop();
1083 }
1084 
1085 char java_runtime_name[128] = "";
1086 char java_runtime_version[128] = "";
1087 
1088 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1089 static const char* get_java_runtime_name(TRAPS) {
1090   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1091                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1092   fieldDescriptor fd;
1093   bool found = k != NULL &amp;&amp;
1094                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1095                                                         vmSymbols::string_signature(), &amp;fd);
1096   if (found) {
1097     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1098     if (name_oop == NULL) {
1099       return NULL;
1100     }
1101     const char* name = java_lang_String::as_utf8_string(name_oop,
1102                                                         java_runtime_name,
1103                                                         sizeof(java_runtime_name));
1104     return name;
1105   } else {
1106     return NULL;
1107   }
1108 }
1109 
1110 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1111 static const char* get_java_runtime_version(TRAPS) {
1112   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1113                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1114   fieldDescriptor fd;
1115   bool found = k != NULL &amp;&amp;
1116                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1117                                                         vmSymbols::string_signature(), &amp;fd);
1118   if (found) {
1119     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1120     if (name_oop == NULL) {
1121       return NULL;
1122     }
1123     const char* name = java_lang_String::as_utf8_string(name_oop,
1124                                                         java_runtime_version,
1125                                                         sizeof(java_runtime_version));
1126     return name;
1127   } else {
1128     return NULL;
1129   }
1130 }
1131 
1132 // General purpose hook into Java code, run once when the VM is initialized.
1133 // The Java library method itself may be changed independently from the VM.
1134 static void call_postVMInitHook(TRAPS) {
1135   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1136   if (klass != NULL) {
1137     JavaValue result(T_VOID);
1138     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1139                            vmSymbols::void_method_signature(),
1140                            CHECK);
1141   }
1142 }
1143 
1144 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1145                                     bool daemon, TRAPS) {
1146   assert(thread_group.not_null(), "thread group should be specified");
1147   assert(threadObj() == NULL, "should only create Java thread object once");
1148 
1149   InstanceKlass* ik = SystemDictionary::Thread_klass();
1150   assert(ik-&gt;is_initialized(), "must be");
1151   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1152 
1153   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1154   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1155   // constructor calls Thread.current(), which must be set here.
1156   java_lang_Thread::set_thread(thread_oop(), this);
1157   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1158   set_threadObj(thread_oop());
1159 
1160   JavaValue result(T_VOID);
1161   if (thread_name != NULL) {
1162     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1163     // Thread gets assigned specified name and null target
1164     JavaCalls::call_special(&amp;result,
1165                             thread_oop,
1166                             ik,
1167                             vmSymbols::object_initializer_name(),
1168                             vmSymbols::threadgroup_string_void_signature(),
1169                             thread_group,
1170                             name,
1171                             THREAD);
1172   } else {
1173     // Thread gets assigned name "Thread-nnn" and null target
1174     // (java.lang.Thread doesn't have a constructor taking only a ThreadGroup argument)
1175     JavaCalls::call_special(&amp;result,
1176                             thread_oop,
1177                             ik,
1178                             vmSymbols::object_initializer_name(),
1179                             vmSymbols::threadgroup_runnable_void_signature(),
1180                             thread_group,
1181                             Handle(),
1182                             THREAD);
1183   }
1184 
1185 
1186   if (daemon) {
1187     java_lang_Thread::set_daemon(thread_oop());
1188   }
1189 
1190   if (HAS_PENDING_EXCEPTION) {
1191     return;
1192   }
1193 
1194   Klass* group =  SystemDictionary::ThreadGroup_klass();
1195   Handle threadObj(THREAD, this-&gt;threadObj());
1196 
1197   JavaCalls::call_special(&amp;result,
1198                           thread_group,
1199                           group,
1200                           vmSymbols::add_method_name(),
1201                           vmSymbols::thread_void_signature(),
1202                           threadObj,          // Arg 1
1203                           THREAD);
1204 }
1205 
1206 // List of all NonJavaThreads and safe iteration over that list.
1207 
1208 class NonJavaThread::List {
1209 public:
1210   NonJavaThread* volatile _head;
1211   SingleWriterSynchronizer _protect;
1212 
1213   List() : _head(NULL), _protect() {}
1214 };
1215 
1216 NonJavaThread::List NonJavaThread::_the_list;
1217 
1218 NonJavaThread::Iterator::Iterator() :
1219   _protect_enter(_the_list._protect.enter()),
1220   _current(OrderAccess::load_acquire(&amp;_the_list._head))
1221 {}
1222 
1223 NonJavaThread::Iterator::~Iterator() {
1224   _the_list._protect.exit(_protect_enter);
1225 }
1226 
1227 void NonJavaThread::Iterator::step() {
1228   assert(!end(), "precondition");
1229   _current = OrderAccess::load_acquire(&amp;_current-&gt;_next);
1230 }
1231 
1232 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1233   // Add this thread to _the_list.
1234   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1235   _next = _the_list._head;
1236   OrderAccess::release_store(&amp;_the_list._head, this);
1237 }
1238 
1239 NonJavaThread::~NonJavaThread() {
1240   // Remove this thread from _the_list.
1241   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1242   NonJavaThread* volatile* p = &amp;_the_list._head;
1243   for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1244     if (t == this) {
1245       *p = this-&gt;_next;
1246       // Wait for any in-progress iterators.
1247       _the_list._protect.synchronize();
1248       break;
1249     }
1250   }
1251 }
1252 
1253 // NamedThread --  non-JavaThread subclasses with multiple
1254 // uniquely named instances should derive from this.
1255 NamedThread::NamedThread() :
1256   NonJavaThread(),
1257   _name(NULL),
1258   _processed_thread(NULL),
1259   _gc_id(GCId::undefined())
1260 {}
1261 
1262 NamedThread::~NamedThread() {
1263   if (_name != NULL) {
1264     FREE_C_HEAP_ARRAY(char, _name);
1265     _name = NULL;
1266   }
1267 }
1268 
1269 void NamedThread::set_name(const char* format, ...) {
1270   guarantee(_name == NULL, "Only get to set name once.");
1271   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1272   guarantee(_name != NULL, "alloc failure");
1273   va_list ap;
1274   va_start(ap, format);
1275   jio_vsnprintf(_name, max_name_len, format, ap);
1276   va_end(ap);
1277 }
1278 
1279 void NamedThread::initialize_named_thread() {
1280   set_native_thread_name(name());
1281 }
1282 
1283 void NamedThread::print_on(outputStream* st) const {
1284   st-&gt;print("\"%s\" ", name());
1285   Thread::print_on(st);
1286   st-&gt;cr();
1287 }
1288 
1289 
1290 // ======= WatcherThread ========
1291 
1292 // The watcher thread exists to simulate timer interrupts.  It should
1293 // be replaced by an abstraction over whatever native support for
1294 // timer interrupts exists on the platform.
1295 
1296 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1297 bool WatcherThread::_startable = false;
1298 volatile bool  WatcherThread::_should_terminate = false;
1299 
1300 WatcherThread::WatcherThread() : NonJavaThread() {
1301   assert(watcher_thread() == NULL, "we can only allocate one WatcherThread");
1302   if (os::create_thread(this, os::watcher_thread)) {
1303     _watcher_thread = this;
1304 
1305     // Set the watcher thread to the highest OS priority which should not be
1306     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1307     // is created. The only normal thread using this priority is the reference
1308     // handler thread, which runs for very short intervals only.
1309     // If the VMThread's priority is not lower than the WatcherThread profiling
1310     // will be inaccurate.
1311     os::set_priority(this, MaxPriority);
1312     if (!DisableStartThread) {
1313       os::start_thread(this);
1314     }
1315   }
1316 }
1317 
1318 int WatcherThread::sleep() const {
1319   // The WatcherThread does not participate in the safepoint protocol
1320   // for the PeriodicTask_lock because it is not a JavaThread.
1321   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1322 
1323   if (_should_terminate) {
1324     // check for termination before we do any housekeeping or wait
1325     return 0;  // we did not sleep.
1326   }
1327 
1328   // remaining will be zero if there are no tasks,
1329   // causing the WatcherThread to sleep until a task is
1330   // enrolled
1331   int remaining = PeriodicTask::time_to_wait();
1332   int time_slept = 0;
1333 
1334   // we expect this to timeout - we only ever get unparked when
1335   // we should terminate or when a new task has been enrolled
1336   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1337 
1338   jlong time_before_loop = os::javaTimeNanos();
1339 
1340   while (true) {
1341     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,
1342                                             remaining);
1343     jlong now = os::javaTimeNanos();
1344 
1345     if (remaining == 0) {
1346       // if we didn't have any tasks we could have waited for a long time
1347       // consider the time_slept zero and reset time_before_loop
1348       time_slept = 0;
1349       time_before_loop = now;
1350     } else {
1351       // need to recalculate since we might have new tasks in _tasks
1352       time_slept = (int) ((now - time_before_loop) / 1000000);
1353     }
1354 
1355     // Change to task list or spurious wakeup of some kind
1356     if (timedout || _should_terminate) {
1357       break;
1358     }
1359 
1360     remaining = PeriodicTask::time_to_wait();
1361     if (remaining == 0) {
1362       // Last task was just disenrolled so loop around and wait until
1363       // another task gets enrolled
1364       continue;
1365     }
1366 
1367     remaining -= time_slept;
1368     if (remaining &lt;= 0) {
1369       break;
1370     }
1371   }
1372 
1373   return time_slept;
1374 }
1375 
1376 void WatcherThread::run() {
1377   assert(this == watcher_thread(), "just checking");
1378 
1379   this-&gt;record_stack_base_and_size();
1380   this-&gt;set_native_thread_name(this-&gt;name());
1381   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1382   while (true) {
1383     assert(watcher_thread() == Thread::current(), "thread consistency check");
1384     assert(watcher_thread() == this, "thread consistency check");
1385 
1386     // Calculate how long it'll be until the next PeriodicTask work
1387     // should be done, and sleep that amount of time.
1388     int time_waited = sleep();
1389 
1390     if (VMError::is_error_reported()) {
1391       // A fatal error has happened, the error handler(VMError::report_and_die)
1392       // should abort JVM after creating an error log file. However in some
1393       // rare cases, the error handler itself might deadlock. Here periodically
1394       // check for error reporting timeouts, and if it happens, just proceed to
1395       // abort the VM.
1396 
1397       // This code is in WatcherThread because WatcherThread wakes up
1398       // periodically so the fatal error handler doesn't need to do anything;
1399       // also because the WatcherThread is less likely to crash than other
1400       // threads.
1401 
1402       for (;;) {
1403         // Note: we use naked sleep in this loop because we want to avoid using
1404         // any kind of VM infrastructure which may be broken at this point.
1405         if (VMError::check_timeout()) {
1406           // We hit error reporting timeout. Error reporting was interrupted and
1407           // will be wrapping things up now (closing files etc). Give it some more
1408           // time, then quit the VM.
1409           os::naked_short_sleep(200);
1410           // Print a message to stderr.
1411           fdStream err(defaultStream::output_fd());
1412           err.print_raw_cr("# [ timer expired, abort... ]");
1413           // skip atexit/vm_exit/vm_abort hooks
1414           os::die();
1415         }
1416 
1417         // Wait a second, then recheck for timeout.
1418         os::naked_short_sleep(999);
1419       }
1420     }
1421 
1422     if (_should_terminate) {
1423       // check for termination before posting the next tick
1424       break;
1425     }
1426 
1427     PeriodicTask::real_time_tick(time_waited);
1428   }
1429 
1430   // Signal that it is terminated
1431   {
1432     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1433     _watcher_thread = NULL;
1434     Terminator_lock-&gt;notify();
1435   }
1436 }
1437 
1438 void WatcherThread::start() {
1439   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1440 
1441   if (watcher_thread() == NULL &amp;&amp; _startable) {
1442     _should_terminate = false;
1443     // Create the single instance of WatcherThread
1444     new WatcherThread();
1445   }
1446 }
1447 
1448 void WatcherThread::make_startable() {
1449   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1450   _startable = true;
1451 }
1452 
1453 void WatcherThread::stop() {
1454   {
1455     // Follow normal safepoint aware lock enter protocol since the
1456     // WatcherThread is stopped by another JavaThread.
1457     MutexLocker ml(PeriodicTask_lock);
1458     _should_terminate = true;
1459 
1460     WatcherThread* watcher = watcher_thread();
1461     if (watcher != NULL) {
1462       // unpark the WatcherThread so it can see that it should terminate
1463       watcher-&gt;unpark();
1464     }
1465   }
1466 
1467   MutexLocker mu(Terminator_lock);
1468 
1469   while (watcher_thread() != NULL) {
1470     // This wait should make safepoint checks, wait without a timeout,
1471     // and wait as a suspend-equivalent condition.
1472     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
1473                           Mutex::_as_suspend_equivalent_flag);
1474   }
1475 }
1476 
1477 void WatcherThread::unpark() {
1478   assert(PeriodicTask_lock-&gt;owned_by_self(), "PeriodicTask_lock required");
1479   PeriodicTask_lock-&gt;notify();
1480 }
1481 
1482 void WatcherThread::print_on(outputStream* st) const {
1483   st-&gt;print("\"%s\" ", name());
1484   Thread::print_on(st);
1485   st-&gt;cr();
1486 }
1487 
1488 // ======= JavaThread ========
1489 
1490 #if INCLUDE_JVMCI
1491 
1492 jlong* JavaThread::_jvmci_old_thread_counters;
1493 
1494 bool jvmci_counters_include(JavaThread* thread) {
1495   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1496 }
1497 
1498 void JavaThread::collect_counters(typeArrayOop array) {
1499   if (JVMCICounterSize &gt; 0) {
1500     JavaThreadIteratorWithHandle jtiwh;
1501     for (int i = 0; i &lt; array-&gt;length(); i++) {
1502       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);
1503     }
1504     for (; JavaThread *tp = jtiwh.next(); ) {
1505       if (jvmci_counters_include(tp)) {
1506         for (int i = 0; i &lt; array-&gt;length(); i++) {
1507           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);
1508         }
1509       }
1510     }
1511   }
1512 }
1513 
1514 #endif // INCLUDE_JVMCI
1515 
1516 // A JavaThread is a normal Java thread
1517 
1518 void JavaThread::initialize() {
1519   // Initialize fields
1520 
1521   set_saved_exception_pc(NULL);
1522   set_threadObj(NULL);
1523   _anchor.clear();
1524   set_entry_point(NULL);
1525   set_jni_functions(jni_functions());
1526   set_callee_target(NULL);
1527   set_vm_result(NULL);
1528   set_vm_result_2(NULL);
1529   set_vframe_array_head(NULL);
1530   set_vframe_array_last(NULL);
1531   set_deferred_locals(NULL);
1532   set_deopt_mark(NULL);
1533   set_deopt_compiled_method(NULL);
1534   clear_must_deopt_id();
1535   set_monitor_chunks(NULL);
1536   set_next(NULL);
1537   _on_thread_list = false;
1538   set_thread_state(_thread_new);
1539   _terminated = _not_terminated;
1540   _privileged_stack_top = NULL;
1541   _array_for_gc = NULL;
1542   _suspend_equivalent = false;
1543   _in_deopt_handler = 0;
1544   _doing_unsafe_access = false;
1545   _stack_guard_state = stack_guard_unused;
1546 #if INCLUDE_JVMCI
1547   _pending_monitorenter = false;
1548   _pending_deoptimization = -1;
1549   _pending_failed_speculation = 0;
1550   _pending_transfer_to_interpreter = false;
1551   _adjusting_comp_level = false;
1552   _in_retryable_allocation = false;
1553   _jvmci._alternate_call_target = NULL;
1554   assert(_jvmci._implicit_exception_pc == NULL, "must be");
1555   if (JVMCICounterSize &gt; 0) {
1556     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
1557     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);
1558   } else {
1559     _jvmci_counters = NULL;
1560   }
1561 #endif // INCLUDE_JVMCI
1562   _reserved_stack_activation = NULL;  // stack base not known yet
1563   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1564   _exception_pc  = 0;
1565   _exception_handler_pc = 0;
1566   _is_method_handle_return = 0;
1567   _jvmti_thread_state= NULL;
1568   _should_post_on_exceptions_flag = JNI_FALSE;
1569   _interp_only_mode    = 0;
1570   _special_runtime_exit_condition = _no_async_condition;
1571   _pending_async_exception = NULL;
1572   _thread_stat = NULL;
1573   _thread_stat = new ThreadStatistics();
1574   _blocked_on_compilation = false;
1575   _jni_active_critical = 0;
1576   _pending_jni_exception_check_fn = NULL;
1577   _do_not_unlock_if_synchronized = false;
1578   _cached_monitor_info = NULL;
1579   _parker = Parker::Allocate(this);
1580 
1581 #ifndef PRODUCT
1582   _jmp_ring_index = 0;
1583   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {
1584     record_jump(NULL, NULL, NULL, 0);
1585   }
1586 #endif // PRODUCT
1587 
1588   // Setup safepoint state info for this thread
1589   ThreadSafepointState::create(this);
1590 
1591   debug_only(_java_call_counter = 0);
1592 
1593   // JVMTI PopFrame support
1594   _popframe_condition = popframe_inactive;
1595   _popframe_preserved_args = NULL;
1596   _popframe_preserved_args_size = 0;
1597   _frames_to_pop_failed_realloc = 0;
1598 
1599   if (SafepointMechanism::uses_thread_local_poll()) {
1600     SafepointMechanism::initialize_header(this);
1601   }
1602 
1603   pd_initialize();
1604 }
1605 
1606 JavaThread::JavaThread(bool is_attaching_via_jni) :
1607                        Thread() {
1608   initialize();
1609   if (is_attaching_via_jni) {
1610     _jni_attach_state = _attaching_via_jni;
1611   } else {
1612     _jni_attach_state = _not_attaching_via_jni;
1613   }
1614   assert(deferred_card_mark().is_empty(), "Default MemRegion ctor");
1615 }
1616 
1617 bool JavaThread::reguard_stack(address cur_sp) {
1618   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1619       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1620     return true; // Stack already guarded or guard pages not needed.
1621   }
1622 
1623   if (register_stack_overflow()) {
1624     // For those architectures which have separate register and
1625     // memory stacks, we must check the register stack to see if
1626     // it has overflowed.
1627     return false;
1628   }
1629 
1630   // Java code never executes within the yellow zone: the latter is only
1631   // there to provoke an exception during stack banging.  If java code
1632   // is executing there, either StackShadowPages should be larger, or
1633   // some exception code in c1, c2 or the interpreter isn't unwinding
1634   // when it should.
1635   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1636             "not enough space to reguard - increase StackShadowPages");
1637   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1638     enable_stack_yellow_reserved_zone();
1639     if (reserved_stack_activation() != stack_base()) {
1640       set_reserved_stack_activation(stack_base());
1641     }
1642   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1643     set_reserved_stack_activation(stack_base());
1644     enable_stack_reserved_zone();
1645   }
1646   return true;
1647 }
1648 
1649 bool JavaThread::reguard_stack(void) {
1650   return reguard_stack(os::current_stack_pointer());
1651 }
1652 
1653 
1654 void JavaThread::block_if_vm_exited() {
1655   if (_terminated == _vm_exited) {
1656     // _vm_exited is set at safepoint, and Threads_lock is never released
1657     // we will block here forever
1658     Threads_lock-&gt;lock_without_safepoint_check();
1659     ShouldNotReachHere();
1660   }
1661 }
1662 
1663 
1664 // Remove this ifdef when C1 is ported to the compiler interface.
1665 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1666 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1667 
1668 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1669                        Thread() {
1670   initialize();
1671   _jni_attach_state = _not_attaching_via_jni;
1672   set_entry_point(entry_point);
1673   // Create the native thread itself.
1674   // %note runtime_23
1675   os::ThreadType thr_type = os::java_thread;
1676   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1677                                                      os::java_thread;
1678   os::create_thread(this, thr_type, stack_sz);
1679   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1680   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1681   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1682   // the exception consists of creating the exception object &amp; initializing it, initialization
1683   // will leave the VM via a JavaCall and then all locks must be unlocked).
1684   //
1685   // The thread is still suspended when we reach here. Thread must be explicit started
1686   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1687   // by calling Threads:add. The reason why this is not done here, is because the thread
1688   // object must be fully initialized (take a look at JVM_Start)
1689 }
1690 
1691 JavaThread::~JavaThread() {
1692 
1693   // JSR166 -- return the parker to the free list
1694   Parker::Release(_parker);
1695   _parker = NULL;
1696 
1697   // Free any remaining  previous UnrollBlock
1698   vframeArray* old_array = vframe_array_last();
1699 
1700   if (old_array != NULL) {
1701     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1702     old_array-&gt;set_unroll_block(NULL);
1703     delete old_info;
1704     delete old_array;
1705   }
1706 
1707   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1708   if (deferred != NULL) {
1709     // This can only happen if thread is destroyed before deoptimization occurs.
1710     assert(deferred-&gt;length() != 0, "empty array!");
1711     do {
1712       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1713       deferred-&gt;remove_at(0);
1714       // individual jvmtiDeferredLocalVariableSet are CHeapObj's
1715       delete dlv;
1716     } while (deferred-&gt;length() != 0);
1717     delete deferred;
1718   }
1719 
1720   // All Java related clean up happens in exit
1721   ThreadSafepointState::destroy(this);
1722   if (_thread_stat != NULL) delete _thread_stat;
1723 
1724 #if INCLUDE_JVMCI
1725   if (JVMCICounterSize &gt; 0) {
1726     if (jvmci_counters_include(this)) {
1727       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1728         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1729       }
1730     }
1731     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1732   }
1733 #endif // INCLUDE_JVMCI
1734 }
1735 
1736 
1737 // The first routine called by a new Java thread
1738 void JavaThread::run() {
1739   // initialize thread-local alloc buffer related fields
1740   this-&gt;initialize_tlab();
1741 
1742   // used to test validity of stack trace backs
1743   this-&gt;record_base_of_stack_pointer();
1744 
1745   // Record real stack base and size.
1746   this-&gt;record_stack_base_and_size();
1747 
1748   this-&gt;create_stack_guard_pages();
1749 
1750   this-&gt;cache_global_variables();
1751 
1752   // Thread is now sufficient initialized to be handled by the safepoint code as being
1753   // in the VM. Change thread state from _thread_new to _thread_in_vm
1754   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);
1755 
1756   assert(JavaThread::current() == this, "sanity check");
1757   assert(!Thread::current()-&gt;owns_locks(), "sanity check");
1758 
1759   DTRACE_THREAD_PROBE(start, this);
1760 
1761   // This operation might block. We call that after all safepoint checks for a new thread has
1762   // been completed.
1763   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1764 
1765   if (JvmtiExport::should_post_thread_life()) {
1766     JvmtiExport::post_thread_start(this);
1767   }
1768 
1769   EventThreadStart event;
1770   if (event.should_commit()) {
1771     event.set_thread(JFR_THREAD_ID(this));
1772     event.commit();
1773   }
1774 
1775   // We call another function to do the rest so we are sure that the stack addresses used
1776   // from there will be lower than the stack base just computed
1777   thread_main_inner();
1778 
1779   // Note, thread is no longer valid at this point!
1780 }
1781 
1782 
1783 void JavaThread::thread_main_inner() {
1784   assert(JavaThread::current() == this, "sanity check");
1785   assert(this-&gt;threadObj() != NULL, "just checking");
1786 
1787   // Execute thread entry point unless this thread has a pending exception
1788   // or has been stopped before starting.
1789   // Note: Due to JVM_StopThread we can have pending exceptions already!
1790   if (!this-&gt;has_pending_exception() &amp;&amp;
1791       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1792     {
1793       ResourceMark rm(this);
1794       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1795     }
1796     HandleMark hm(this);
1797     this-&gt;entry_point()(this, this);
1798   }
1799 
1800   DTRACE_THREAD_PROBE(stop, this);
1801 
1802   this-&gt;exit(false);
1803   this-&gt;smr_delete();
1804 }
1805 
1806 
1807 static void ensure_join(JavaThread* thread) {
1808   // We do not need to grab the Threads_lock, since we are operating on ourself.
1809   Handle threadObj(thread, thread-&gt;threadObj());
1810   assert(threadObj.not_null(), "java thread object must exist");
1811   ObjectLocker lock(threadObj, thread);
1812   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1813   thread-&gt;clear_pending_exception();
1814   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1815   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1816   // Clear the native thread instance - this makes isAlive return false and allows the join()
1817   // to complete once we've done the notify_all below
1818   java_lang_Thread::set_thread(threadObj(), NULL);
1819   lock.notify_all(thread);
1820   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1821   thread-&gt;clear_pending_exception();
1822 }
1823 
1824 
1825 // For any new cleanup additions, please check to see if they need to be applied to
1826 // cleanup_failed_attach_current_thread as well.
1827 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1828   assert(this == JavaThread::current(), "thread consistency check");
1829 
1830   elapsedTimer _timer_exit_phase1;
1831   elapsedTimer _timer_exit_phase2;
1832   elapsedTimer _timer_exit_phase3;
1833   elapsedTimer _timer_exit_phase4;
1834 
1835   if (log_is_enabled(Debug, os, thread, timer)) {
1836     _timer_exit_phase1.start();
1837   }
1838 
1839   HandleMark hm(this);
1840   Handle uncaught_exception(this, this-&gt;pending_exception());
1841   this-&gt;clear_pending_exception();
1842   Handle threadObj(this, this-&gt;threadObj());
1843   assert(threadObj.not_null(), "Java thread object should be created");
1844 
1845   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1846   {
1847     EXCEPTION_MARK;
1848 
1849     CLEAR_PENDING_EXCEPTION;
1850   }
1851   if (!destroy_vm) {
1852     if (uncaught_exception.not_null()) {
1853       EXCEPTION_MARK;
1854       // Call method Thread.dispatchUncaughtException().
1855       Klass* thread_klass = SystemDictionary::Thread_klass();
1856       JavaValue result(T_VOID);
1857       JavaCalls::call_virtual(&amp;result,
1858                               threadObj, thread_klass,
1859                               vmSymbols::dispatchUncaughtException_name(),
1860                               vmSymbols::throwable_void_signature(),
1861                               uncaught_exception,
1862                               THREAD);
1863       if (HAS_PENDING_EXCEPTION) {
1864         ResourceMark rm(this);
1865         jio_fprintf(defaultStream::error_stream(),
1866                     "\nException: %s thrown from the UncaughtExceptionHandler"
1867                     " in thread \"%s\"\n",
1868                     pending_exception()-&gt;klass()-&gt;external_name(),
1869                     get_thread_name());
1870         CLEAR_PENDING_EXCEPTION;
1871       }
1872     }
1873 
1874     // Called before the java thread exit since we want to read info
1875     // from java_lang_Thread object
1876     EventThreadEnd event;
1877     if (event.should_commit()) {
1878       event.set_thread(JFR_THREAD_ID(this));
1879       event.commit();
1880     }
1881 
1882     // Call after last event on thread
1883     JFR_ONLY(Jfr::on_thread_exit(this);)
1884 
1885     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1886     // the execution of the method. If that is not enough, then we don't really care. Thread.stop
1887     // is deprecated anyhow.
1888     if (!is_Compiler_thread()) {
1889       int count = 3;
1890       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1891         EXCEPTION_MARK;
1892         JavaValue result(T_VOID);
1893         Klass* thread_klass = SystemDictionary::Thread_klass();
1894         JavaCalls::call_virtual(&amp;result,
1895                                 threadObj, thread_klass,
1896                                 vmSymbols::exit_method_name(),
1897                                 vmSymbols::void_method_signature(),
1898                                 THREAD);
1899         CLEAR_PENDING_EXCEPTION;
1900       }
1901     }
1902     // notify JVMTI
1903     if (JvmtiExport::should_post_thread_life()) {
1904       JvmtiExport::post_thread_end(this);
1905     }
1906 
1907     // We have notified the agents that we are exiting, before we go on,
1908     // we must check for a pending external suspend request and honor it
1909     // in order to not surprise the thread that made the suspend request.
1910     while (true) {
1911       {
1912         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1913         if (!is_external_suspend()) {
1914           set_terminated(_thread_exiting);
1915           ThreadService::current_thread_exiting(this);
1916           break;
1917         }
1918         // Implied else:
1919         // Things get a little tricky here. We have a pending external
1920         // suspend request, but we are holding the SR_lock so we
1921         // can't just self-suspend. So we temporarily drop the lock
1922         // and then self-suspend.
1923       }
1924 
1925       ThreadBlockInVM tbivm(this);
1926       java_suspend_self();
1927 
1928       // We're done with this suspend request, but we have to loop around
1929       // and check again. Eventually we will get SR_lock without a pending
1930       // external suspend request and will be able to mark ourselves as
1931       // exiting.
1932     }
1933     // no more external suspends are allowed at this point
1934   } else {
1935     // before_exit() has already posted JVMTI THREAD_END events
1936   }
1937 
1938   if (log_is_enabled(Debug, os, thread, timer)) {
1939     _timer_exit_phase1.stop();
1940     _timer_exit_phase2.start();
1941   }
1942   // Notify waiters on thread object. This has to be done after exit() is called
1943   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
1944   // group should have the destroyed bit set before waiters are notified).
1945   ensure_join(this);
1946   assert(!this-&gt;has_pending_exception(), "ensure_join should have cleared");
1947 
1948   if (log_is_enabled(Debug, os, thread, timer)) {
1949     _timer_exit_phase2.stop();
1950     _timer_exit_phase3.start();
1951   }
1952   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
1953   // held by this thread must be released. The spec does not distinguish
1954   // between JNI-acquired and regular Java monitors. We can only see
1955   // regular Java monitors here if monitor enter-exit matching is broken.
1956   //
1957   // ensure_join() ignores IllegalThreadStateExceptions, and so does
1958   // ObjectSynchronizer::release_monitors_owned_by_thread().
1959   if (exit_type == jni_detach) {
1960     // Sanity check even though JNI DetachCurrentThread() would have
1961     // returned JNI_ERR if there was a Java frame. JavaThread exit
1962     // should be done executing Java code by the time we get here.
1963     assert(!this-&gt;has_last_Java_frame(),
1964            "should not have a Java frame when detaching or exiting");
1965     ObjectSynchronizer::release_monitors_owned_by_thread(this);
1966     assert(!this-&gt;has_pending_exception(), "release_monitors should have cleared");
1967   }
1968 
1969   // These things needs to be done while we are still a Java Thread. Make sure that thread
1970   // is in a consistent state, in case GC happens
1971   assert(_privileged_stack_top == NULL, "must be NULL when we get here");
1972 
1973   if (active_handles() != NULL) {
1974     JNIHandleBlock* block = active_handles();
1975     set_active_handles(NULL);
1976     JNIHandleBlock::release_block(block);
1977   }
1978 
1979   if (free_handle_block() != NULL) {
1980     JNIHandleBlock* block = free_handle_block();
1981     set_free_handle_block(NULL);
1982     JNIHandleBlock::release_block(block);
1983   }
1984 
1985   // These have to be removed while this is still a valid thread.
1986   remove_stack_guard_pages();
1987 
1988   if (UseTLAB) {
1989     tlab().retire();
1990   }
1991 
1992   if (JvmtiEnv::environments_might_exist()) {
1993     JvmtiExport::cleanup_thread(this);
1994   }
1995 
1996   // We must flush any deferred card marks and other various GC barrier
1997   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
1998   // before removing a thread from the list of active threads.
1999   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2000 
2001   log_info(os, thread)("JavaThread %s (tid: " UINTX_FORMAT ").",
2002     exit_type == JavaThread::normal_exit ? "exiting" : "detaching",
2003     os::current_thread_id());
2004 
2005   if (log_is_enabled(Debug, os, thread, timer)) {
2006     _timer_exit_phase3.stop();
2007     _timer_exit_phase4.start();
2008   }
2009   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2010   Threads::remove(this);
2011 
2012   if (log_is_enabled(Debug, os, thread, timer)) {
2013     _timer_exit_phase4.stop();
2014     ResourceMark rm(this);
2015     log_debug(os, thread, timer)("name='%s'"
2016                                  ", exit-phase1=" JLONG_FORMAT
2017                                  ", exit-phase2=" JLONG_FORMAT
2018                                  ", exit-phase3=" JLONG_FORMAT
2019                                  ", exit-phase4=" JLONG_FORMAT,
2020                                  get_thread_name(),
2021                                  _timer_exit_phase1.milliseconds(),
2022                                  _timer_exit_phase2.milliseconds(),
2023                                  _timer_exit_phase3.milliseconds(),
2024                                  _timer_exit_phase4.milliseconds());
2025   }
2026 }
2027 
2028 void JavaThread::cleanup_failed_attach_current_thread() {
2029   if (active_handles() != NULL) {
2030     JNIHandleBlock* block = active_handles();
2031     set_active_handles(NULL);
2032     JNIHandleBlock::release_block(block);
2033   }
2034 
2035   if (free_handle_block() != NULL) {
2036     JNIHandleBlock* block = free_handle_block();
2037     set_free_handle_block(NULL);
2038     JNIHandleBlock::release_block(block);
2039   }
2040 
2041   // These have to be removed while this is still a valid thread.
2042   remove_stack_guard_pages();
2043 
2044   if (UseTLAB) {
2045     tlab().retire();
2046   }
2047 
2048   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2049 
2050   Threads::remove(this);
2051   this-&gt;smr_delete();
2052 }
2053 
2054 JavaThread* JavaThread::active() {
2055   Thread* thread = Thread::current();
2056   if (thread-&gt;is_Java_thread()) {
2057     return (JavaThread*) thread;
2058   } else {
2059     assert(thread-&gt;is_VM_thread(), "this must be a vm thread");
2060     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2061     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2062     assert(ret-&gt;is_Java_thread(), "must be a Java thread");
2063     return ret;
2064   }
2065 }
2066 
2067 bool JavaThread::is_lock_owned(address adr) const {
2068   if (Thread::is_lock_owned(adr)) return true;
2069 
2070   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2071     if (chunk-&gt;contains(adr)) return true;
2072   }
2073 
2074   return false;
2075 }
2076 
2077 
2078 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2079   chunk-&gt;set_next(monitor_chunks());
2080   set_monitor_chunks(chunk);
2081 }
2082 
2083 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2084   guarantee(monitor_chunks() != NULL, "must be non empty");
2085   if (monitor_chunks() == chunk) {
2086     set_monitor_chunks(chunk-&gt;next());
2087   } else {
2088     MonitorChunk* prev = monitor_chunks();
2089     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2090     prev-&gt;set_next(chunk-&gt;next());
2091   }
2092 }
2093 
2094 // JVM support.
2095 
2096 // Note: this function shouldn't block if it's called in
2097 // _thread_in_native_trans state (such as from
2098 // check_special_condition_for_native_trans()).
2099 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2100 
2101   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2102     // If we are at a polling page safepoint (not a poll return)
2103     // then we must defer async exception because live registers
2104     // will be clobbered by the exception path. Poll return is
2105     // ok because the call we a returning from already collides
2106     // with exception handling registers and so there is no issue.
2107     // (The exception handling path kills call result registers but
2108     //  this is ok since the exception kills the result anyway).
2109 
2110     if (is_at_poll_safepoint()) {
2111       // if the code we are returning to has deoptimized we must defer
2112       // the exception otherwise live registers get clobbered on the
2113       // exception path before deoptimization is able to retrieve them.
2114       //
2115       RegisterMap map(this, false);
2116       frame caller_fr = last_frame().sender(&amp;map);
2117       assert(caller_fr.is_compiled_frame(), "what?");
2118       if (caller_fr.is_deoptimized_frame()) {
2119         log_info(exceptions)("deferred async exception at compiled safepoint");
2120         return;
2121       }
2122     }
2123   }
2124 
2125   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2126   if (condition == _no_async_condition) {
2127     // Conditions have changed since has_special_runtime_exit_condition()
2128     // was called:
2129     // - if we were here only because of an external suspend request,
2130     //   then that was taken care of above (or cancelled) so we are done
2131     // - if we were here because of another async request, then it has
2132     //   been cleared between the has_special_runtime_exit_condition()
2133     //   and now so again we are done
2134     return;
2135   }
2136 
2137   // Check for pending async. exception
2138   if (_pending_async_exception != NULL) {
2139     // Only overwrite an already pending exception, if it is not a threadDeath.
2140     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2141 
2142       // We cannot call Exceptions::_throw(...) here because we cannot block
2143       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2144 
2145       LogTarget(Info, exceptions) lt;
2146       if (lt.is_enabled()) {
2147         ResourceMark rm;
2148         LogStream ls(lt);
2149         ls.print("Async. exception installed at runtime exit (" INTPTR_FORMAT ")", p2i(this));
2150           if (has_last_Java_frame()) {
2151             frame f = last_frame();
2152            ls.print(" (pc: " INTPTR_FORMAT " sp: " INTPTR_FORMAT " )", p2i(f.pc()), p2i(f.sp()));
2153           }
2154         ls.print_cr(" of type: %s", _pending_async_exception-&gt;klass()-&gt;external_name());
2155       }
2156       _pending_async_exception = NULL;
2157       clear_has_async_exception();
2158     }
2159   }
2160 
2161   if (check_unsafe_error &amp;&amp;
2162       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2163     condition = _no_async_condition;  // done
2164     switch (thread_state()) {
2165     case _thread_in_vm: {
2166       JavaThread* THREAD = this;
2167       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2168     }
2169     case _thread_in_native: {
2170       ThreadInVMfromNative tiv(this);
2171       JavaThread* THREAD = this;
2172       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in an unsafe memory access operation");
2173     }
2174     case _thread_in_Java: {
2175       ThreadInVMfromJava tiv(this);
2176       JavaThread* THREAD = this;
2177       THROW_MSG(vmSymbols::java_lang_InternalError(), "a fault occurred in a recent unsafe memory access operation in compiled Java code");
2178     }
2179     default:
2180       ShouldNotReachHere();
2181     }
2182   }
2183 
2184   assert(condition == _no_async_condition || has_pending_exception() ||
2185          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2186          "must have handled the async condition, if no exception");
2187 }
2188 
2189 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2190   //
2191   // Check for pending external suspend. Internal suspend requests do
2192   // not use handle_special_runtime_exit_condition().
2193   // If JNIEnv proxies are allowed, don't self-suspend if the target
2194   // thread is not the current thread. In older versions of jdbx, jdbx
2195   // threads could call into the VM with another thread's JNIEnv so we
2196   // can be here operating on behalf of a suspended thread (4432884).
2197   bool do_self_suspend = is_external_suspend_with_lock();
2198   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {
2199     //
2200     // Because thread is external suspended the safepoint code will count
2201     // thread as at a safepoint. This can be odd because we can be here
2202     // as _thread_in_Java which would normally transition to _thread_blocked
2203     // at a safepoint. We would like to mark the thread as _thread_blocked
2204     // before calling java_suspend_self like all other callers of it but
2205     // we must then observe proper safepoint protocol. (We can't leave
2206     // _thread_blocked with a safepoint in progress). However we can be
2207     // here as _thread_in_native_trans so we can't use a normal transition
2208     // constructor/destructor pair because they assert on that type of
2209     // transition. We could do something like:
2210     //
2211     // JavaThreadState state = thread_state();
2212     // set_thread_state(_thread_in_vm);
2213     // {
2214     //   ThreadBlockInVM tbivm(this);
2215     //   java_suspend_self()
2216     // }
2217     // set_thread_state(_thread_in_vm_trans);
2218     // if (safepoint) block;
2219     // set_thread_state(state);
2220     //
2221     // but that is pretty messy. Instead we just go with the way the
2222     // code has worked before and note that this is the only path to
2223     // java_suspend_self that doesn't put the thread in _thread_blocked
2224     // mode.
2225 
2226     frame_anchor()-&gt;make_walkable(this);
2227     java_suspend_self();
2228 
2229     // We might be here for reasons in addition to the self-suspend request
2230     // so check for other async requests.
2231   }
2232 
2233   if (check_asyncs) {
2234     check_and_handle_async_exceptions();
2235   }
2236 
2237   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2238 }
2239 
2240 void JavaThread::send_thread_stop(oop java_throwable)  {
2241   assert(Thread::current()-&gt;is_VM_thread(), "should be in the vm thread");
2242   assert(Threads_lock-&gt;is_locked(), "Threads_lock should be locked by safepoint code");
2243   assert(SafepointSynchronize::is_at_safepoint(), "all threads are stopped");
2244 
2245   // Do not throw asynchronous exceptions against the compiler thread
2246   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2247   if (!can_call_java()) return;
2248 
2249   {
2250     // Actually throw the Throwable against the target Thread - however
2251     // only if there is no thread death exception installed already.
2252     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2253       // If the topmost frame is a runtime stub, then we are calling into
2254       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2255       // must deoptimize the caller before continuing, as the compiled  exception handler table
2256       // may not be valid
2257       if (has_last_Java_frame()) {
2258         frame f = last_frame();
2259         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2260           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2261           RegisterMap reg_map(this, UseBiasedLocking);
2262           frame compiled_frame = f.sender(&amp;reg_map);
2263           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2264             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2265           }
2266         }
2267       }
2268 
2269       // Set async. pending exception in thread.
2270       set_pending_async_exception(java_throwable);
2271 
2272       if (log_is_enabled(Info, exceptions)) {
2273          ResourceMark rm;
2274         log_info(exceptions)("Pending Async. exception installed of type: %s",
2275                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2276       }
2277       // for AbortVMOnException flag
2278       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2279     }
2280   }
2281 
2282 
2283   // Interrupt thread so it will wake up from a potential wait()
2284   Thread::interrupt(this);
2285 }
2286 
2287 // External suspension mechanism.
2288 //
2289 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2290 // to any VM_locks and it is at a transition
2291 // Self-suspension will happen on the transition out of the vm.
2292 // Catch "this" coming in from JNIEnv pointers when the thread has been freed
2293 //
2294 // Guarantees on return:
2295 //   + Target thread will not execute any new bytecode (that's why we need to
2296 //     force a safepoint)
2297 //   + Target thread will not enter any new monitors
2298 //
2299 void JavaThread::java_suspend() {
2300   ThreadsListHandle tlh;
2301   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2302     return;
2303   }
2304 
2305   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2306     if (!is_external_suspend()) {
2307       // a racing resume has cancelled us; bail out now
2308       return;
2309     }
2310 
2311     // suspend is done
2312     uint32_t debug_bits = 0;
2313     // Warning: is_ext_suspend_completed() may temporarily drop the
2314     // SR_lock to allow the thread to reach a stable thread state if
2315     // it is currently in a transient thread state.
2316     if (is_ext_suspend_completed(false /* !called_by_wait */,
2317                                  SuspendRetryDelay, &amp;debug_bits)) {
2318       return;
2319     }
2320   }
2321 
2322   VM_ThreadSuspend vm_suspend;
2323   VMThread::execute(&amp;vm_suspend);
2324 }
2325 
2326 // Part II of external suspension.
2327 // A JavaThread self suspends when it detects a pending external suspend
2328 // request. This is usually on transitions. It is also done in places
2329 // where continuing to the next transition would surprise the caller,
2330 // e.g., monitor entry.
2331 //
2332 // Returns the number of times that the thread self-suspended.
2333 //
2334 // Note: DO NOT call java_suspend_self() when you just want to block current
2335 //       thread. java_suspend_self() is the second stage of cooperative
2336 //       suspension for external suspend requests and should only be used
2337 //       to complete an external suspend request.
2338 //
2339 int JavaThread::java_suspend_self() {
2340   int ret = 0;
2341 
2342   // we are in the process of exiting so don't suspend
2343   if (is_exiting()) {
2344     clear_external_suspend();
2345     return ret;
2346   }
2347 
2348   assert(_anchor.walkable() ||
2349          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2350          "must have walkable stack");
2351 
2352   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2353 
2354   assert(!this-&gt;is_ext_suspended(),
2355          "a thread trying to self-suspend should not already be suspended");
2356 
2357   if (this-&gt;is_suspend_equivalent()) {
2358     // If we are self-suspending as a result of the lifting of a
2359     // suspend equivalent condition, then the suspend_equivalent
2360     // flag is not cleared until we set the ext_suspended flag so
2361     // that wait_for_ext_suspend_completion() returns consistent
2362     // results.
2363     this-&gt;clear_suspend_equivalent();
2364   }
2365 
2366   // A racing resume may have cancelled us before we grabbed SR_lock
2367   // above. Or another external suspend request could be waiting for us
2368   // by the time we return from SR_lock()-&gt;wait(). The thread
2369   // that requested the suspension may already be trying to walk our
2370   // stack and if we return now, we can change the stack out from under
2371   // it. This would be a "bad thing (TM)" and cause the stack walker
2372   // to crash. We stay self-suspended until there are no more pending
2373   // external suspend requests.
2374   while (is_external_suspend()) {
2375     ret++;
2376     this-&gt;set_ext_suspended();
2377 
2378     // _ext_suspended flag is cleared by java_resume()
2379     while (is_ext_suspended()) {
2380       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);
2381     }
2382   }
2383 
2384   return ret;
2385 }
2386 
2387 #ifdef ASSERT
2388 // Verify the JavaThread has not yet been published in the Threads::list, and
2389 // hence doesn't need protection from concurrent access at this stage.
2390 void JavaThread::verify_not_published() {
2391   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2392   // since an unpublished JavaThread doesn't participate in the
2393   // Thread-SMR protocol for keeping a ThreadsList alive.
2394   assert(!on_thread_list(), "JavaThread shouldn't have been published yet!");
2395 }
2396 #endif
2397 
2398 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2399 // progress or when _suspend_flags is non-zero.
2400 // Current thread needs to self-suspend if there is a suspend request and/or
2401 // block if a safepoint is in progress.
2402 // Async exception ISN'T checked.
2403 // Note only the ThreadInVMfromNative transition can call this function
2404 // directly and when thread state is _thread_in_native_trans
2405 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2406   assert(thread-&gt;thread_state() == _thread_in_native_trans, "wrong state");
2407 
2408   JavaThread *curJT = JavaThread::current();
2409   bool do_self_suspend = thread-&gt;is_external_suspend();
2410 
2411   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), "Unwalkable stack in native-&gt;vm transition");
2412 
2413   // If JNIEnv proxies are allowed, don't self-suspend if the target
2414   // thread is not the current thread. In older versions of jdbx, jdbx
2415   // threads could call into the VM with another thread's JNIEnv so we
2416   // can be here operating on behalf of a suspended thread (4432884).
2417   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {
2418     JavaThreadState state = thread-&gt;thread_state();
2419 
2420     // We mark this thread_blocked state as a suspend-equivalent so
2421     // that a caller to is_ext_suspend_completed() won't be confused.
2422     // The suspend-equivalent state is cleared by java_suspend_self().
2423     thread-&gt;set_suspend_equivalent();
2424 
2425     // If the safepoint code sees the _thread_in_native_trans state, it will
2426     // wait until the thread changes to other thread state. There is no
2427     // guarantee on how soon we can obtain the SR_lock and complete the
2428     // self-suspend request. It would be a bad idea to let safepoint wait for
2429     // too long. Temporarily change the state to _thread_blocked to
2430     // let the VM thread know that this thread is ready for GC. The problem
2431     // of changing thread state is that safepoint could happen just after
2432     // java_suspend_self() returns after being resumed, and VM thread will
2433     // see the _thread_blocked state. We must check for safepoint
2434     // after restoring the state and make sure we won't leave while a safepoint
2435     // is in progress.
2436     thread-&gt;set_thread_state(_thread_blocked);
2437     thread-&gt;java_suspend_self();
2438     thread-&gt;set_thread_state(state);
2439 
2440     InterfaceSupport::serialize_thread_state_with_handler(thread);
2441   }
2442 
2443   SafepointMechanism::block_if_requested(curJT);
2444 
2445   if (thread-&gt;is_deopt_suspend()) {
2446     thread-&gt;clear_deopt_suspend();
2447     RegisterMap map(thread, false);
2448     frame f = thread-&gt;last_frame();
2449     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {
2450       f = f.sender(&amp;map);
2451     }
2452     if (f.id() == thread-&gt;must_deopt_id()) {
2453       thread-&gt;clear_must_deopt_id();
2454       f.deoptimize(thread);
2455     } else {
2456       fatal("missed deoptimization!");
2457     }
2458   }
2459 
2460   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2461 }
2462 
2463 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2464 // progress or when _suspend_flags is non-zero.
2465 // Current thread needs to self-suspend if there is a suspend request and/or
2466 // block if a safepoint is in progress.
2467 // Also check for pending async exception (not including unsafe access error).
2468 // Note only the native==&gt;VM/Java barriers can call this function and when
2469 // thread state is _thread_in_native_trans.
2470 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2471   check_safepoint_and_suspend_for_native_trans(thread);
2472 
2473   if (thread-&gt;has_async_exception()) {
2474     // We are in _thread_in_native_trans state, don't handle unsafe
2475     // access error since that may block.
2476     thread-&gt;check_and_handle_async_exceptions(false);
2477   }
2478 }
2479 
2480 // This is a variant of the normal
2481 // check_special_condition_for_native_trans with slightly different
2482 // semantics for use by critical native wrappers.  It does all the
2483 // normal checks but also performs the transition back into
2484 // thread_in_Java state.  This is required so that critical natives
2485 // can potentially block and perform a GC if they are the last thread
2486 // exiting the GCLocker.
2487 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2488   check_special_condition_for_native_trans(thread);
2489 
2490   // Finish the transition
2491   thread-&gt;set_thread_state(_thread_in_Java);
2492 
2493   if (thread-&gt;do_critical_native_unlock()) {
2494     ThreadInVMfromJavaNoAsyncException tiv(thread);
2495     GCLocker::unlock_critical(thread);
2496     thread-&gt;clear_critical_native_unlock();
2497   }
2498 }
2499 
2500 // We need to guarantee the Threads_lock here, since resumes are not
2501 // allowed during safepoint synchronization
2502 // Can only resume from an external suspension
2503 void JavaThread::java_resume() {
2504   assert_locked_or_safepoint(Threads_lock);
2505 
2506   // Sanity check: thread is gone, has started exiting or the thread
2507   // was not externally suspended.
2508   ThreadsListHandle tlh;
2509   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2510     return;
2511   }
2512 
2513   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2514 
2515   clear_external_suspend();
2516 
2517   if (is_ext_suspended()) {
2518     clear_ext_suspended();
2519     SR_lock()-&gt;notify_all();
2520   }
2521 }
2522 
2523 size_t JavaThread::_stack_red_zone_size = 0;
2524 size_t JavaThread::_stack_yellow_zone_size = 0;
2525 size_t JavaThread::_stack_reserved_zone_size = 0;
2526 size_t JavaThread::_stack_shadow_zone_size = 0;
2527 
2528 void JavaThread::create_stack_guard_pages() {
2529   if (!os::uses_stack_guard_pages() ||
2530       _stack_guard_state != stack_guard_unused ||
2531       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2532       log_info(os, thread)("Stack guard page creation for thread "
2533                            UINTX_FORMAT " disabled", os::current_thread_id());
2534     return;
2535   }
2536   address low_addr = stack_end();
2537   size_t len = stack_guard_zone_size();
2538 
2539   assert(is_aligned(low_addr, os::vm_page_size()), "Stack base should be the start of a page");
2540   assert(is_aligned(len, os::vm_page_size()), "Stack size should be a multiple of page size");
2541 
2542   int must_commit = os::must_commit_stack_guard_pages();
2543   // warning("Guarding at " PTR_FORMAT " for len " SIZE_FORMAT "\n", low_addr, len);
2544 
2545   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2546     log_warning(os, thread)("Attempt to allocate stack guard pages failed.");
2547     return;
2548   }
2549 
2550   if (os::guard_memory((char *) low_addr, len)) {
2551     _stack_guard_state = stack_guard_enabled;
2552   } else {
2553     log_warning(os, thread)("Attempt to protect stack guard pages failed ("
2554       PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2555     if (os::uncommit_memory((char *) low_addr, len)) {
2556       log_warning(os, thread)("Attempt to deallocate stack guard pages failed.");
2557     }
2558     return;
2559   }
2560 
2561   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages activated: "
2562     PTR_FORMAT "-" PTR_FORMAT ".",
2563     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2564 }
2565 
2566 void JavaThread::remove_stack_guard_pages() {
2567   assert(Thread::current() == this, "from different thread");
2568   if (_stack_guard_state == stack_guard_unused) return;
2569   address low_addr = stack_end();
2570   size_t len = stack_guard_zone_size();
2571 
2572   if (os::must_commit_stack_guard_pages()) {
2573     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2574       _stack_guard_state = stack_guard_unused;
2575     } else {
2576       log_warning(os, thread)("Attempt to deallocate stack guard pages failed ("
2577         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2578       return;
2579     }
2580   } else {
2581     if (_stack_guard_state == stack_guard_unused) return;
2582     if (os::unguard_memory((char *) low_addr, len)) {
2583       _stack_guard_state = stack_guard_unused;
2584     } else {
2585       log_warning(os, thread)("Attempt to unprotect stack guard pages failed ("
2586         PTR_FORMAT "-" PTR_FORMAT ").", p2i(low_addr), p2i(low_addr + len));
2587       return;
2588     }
2589   }
2590 
2591   log_debug(os, thread)("Thread " UINTX_FORMAT " stack guard pages removed: "
2592     PTR_FORMAT "-" PTR_FORMAT ".",
2593     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2594 }
2595 
2596 void JavaThread::enable_stack_reserved_zone() {
2597   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2598   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2599 
2600   // The base notation is from the stack's point of view, growing downward.
2601   // We need to adjust it to work correctly with guard_memory()
2602   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2603 
2604   guarantee(base &lt; stack_base(),"Error calculating stack reserved zone");
2605   guarantee(base &lt; os::current_stack_pointer(),"Error calculating stack reserved zone");
2606 
2607   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2608     _stack_guard_state = stack_guard_enabled;
2609   } else {
2610     warning("Attempt to guard stack reserved zone failed.");
2611   }
2612   enable_register_stack_guard();
2613 }
2614 
2615 void JavaThread::disable_stack_reserved_zone() {
2616   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2617   assert(_stack_guard_state != stack_guard_reserved_disabled, "already disabled");
2618 
2619   // Simply return if called for a thread that does not use guard pages.
2620   if (_stack_guard_state == stack_guard_unused) return;
2621 
2622   // The base notation is from the stack's point of view, growing downward.
2623   // We need to adjust it to work correctly with guard_memory()
2624   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2625 
2626   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2627     _stack_guard_state = stack_guard_reserved_disabled;
2628   } else {
2629     warning("Attempt to unguard stack reserved zone failed.");
2630   }
2631   disable_register_stack_guard();
2632 }
2633 
2634 void JavaThread::enable_stack_yellow_reserved_zone() {
2635   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2636   assert(_stack_guard_state != stack_guard_enabled, "already enabled");
2637 
2638   // The base notation is from the stacks point of view, growing downward.
2639   // We need to adjust it to work correctly with guard_memory()
2640   address base = stack_red_zone_base();
2641 
2642   guarantee(base &lt; stack_base(), "Error calculating stack yellow zone");
2643   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack yellow zone");
2644 
2645   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2646     _stack_guard_state = stack_guard_enabled;
2647   } else {
2648     warning("Attempt to guard stack yellow zone failed.");
2649   }
2650   enable_register_stack_guard();
2651 }
2652 
2653 void JavaThread::disable_stack_yellow_reserved_zone() {
2654   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2655   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, "already disabled");
2656 
2657   // Simply return if called for a thread that does not use guard pages.
2658   if (_stack_guard_state == stack_guard_unused) return;
2659 
2660   // The base notation is from the stacks point of view, growing downward.
2661   // We need to adjust it to work correctly with guard_memory()
2662   address base = stack_red_zone_base();
2663 
2664   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2665     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2666   } else {
2667     warning("Attempt to unguard stack yellow zone failed.");
2668   }
2669   disable_register_stack_guard();
2670 }
2671 
2672 void JavaThread::enable_stack_red_zone() {
2673   // The base notation is from the stacks point of view, growing downward.
2674   // We need to adjust it to work correctly with guard_memory()
2675   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2676   address base = stack_red_zone_base() - stack_red_zone_size();
2677 
2678   guarantee(base &lt; stack_base(), "Error calculating stack red zone");
2679   guarantee(base &lt; os::current_stack_pointer(), "Error calculating stack red zone");
2680 
2681   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2682     warning("Attempt to guard stack red zone failed.");
2683   }
2684 }
2685 
2686 void JavaThread::disable_stack_red_zone() {
2687   // The base notation is from the stacks point of view, growing downward.
2688   // We need to adjust it to work correctly with guard_memory()
2689   assert(_stack_guard_state != stack_guard_unused, "must be using guard pages.");
2690   address base = stack_red_zone_base() - stack_red_zone_size();
2691   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2692     warning("Attempt to unguard stack red zone failed.");
2693   }
2694 }
2695 
2696 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2697   // ignore is there is no stack
2698   if (!has_last_Java_frame()) return;
2699   // traverse the stack frames. Starts from top frame.
2700   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2701     frame* fr = fst.current();
2702     f(fr, fst.register_map());
2703   }
2704 }
2705 
2706 
2707 #ifndef PRODUCT
2708 // Deoptimization
2709 // Function for testing deoptimization
2710 void JavaThread::deoptimize() {
2711   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2712   StackFrameStream fst(this, UseBiasedLocking);
2713   bool deopt = false;           // Dump stack only if a deopt actually happens.
2714   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2715   // Iterate over all frames in the thread and deoptimize
2716   for (; !fst.is_done(); fst.next()) {
2717     if (fst.current()-&gt;can_be_deoptimized()) {
2718 
2719       if (only_at) {
2720         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2721         // consists of comma or carriage return separated numbers so
2722         // search for the current bci in that string.
2723         address pc = fst.current()-&gt;pc();
2724         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2725         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2726         char buffer[8];
2727         jio_snprintf(buffer, sizeof(buffer), "%d", sd-&gt;bci());
2728         size_t len = strlen(buffer);
2729         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2730         while (found != NULL) {
2731           if ((found[len] == ',' || found[len] == '\n' || found[len] == '\0') &amp;&amp;
2732               (found == DeoptimizeOnlyAt || found[-1] == ',' || found[-1] == '\n')) {
2733             // Check that the bci found is bracketed by terminators.
2734             break;
2735           }
2736           found = strstr(found + 1, buffer);
2737         }
2738         if (!found) {
2739           continue;
2740         }
2741       }
2742 
2743       if (DebugDeoptimization &amp;&amp; !deopt) {
2744         deopt = true; // One-time only print before deopt
2745         tty-&gt;print_cr("[BEFORE Deoptimization]");
2746         trace_frames();
2747         trace_stack();
2748       }
2749       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2750     }
2751   }
2752 
2753   if (DebugDeoptimization &amp;&amp; deopt) {
2754     tty-&gt;print_cr("[AFTER Deoptimization]");
2755     trace_frames();
2756   }
2757 }
2758 
2759 
2760 // Make zombies
2761 void JavaThread::make_zombies() {
2762   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2763     if (fst.current()-&gt;can_be_deoptimized()) {
2764       // it is a Java nmethod
2765       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2766       nm-&gt;make_not_entrant();
2767     }
2768   }
2769 }
2770 #endif // PRODUCT
2771 
2772 
2773 void JavaThread::deoptimized_wrt_marked_nmethods() {
2774   if (!has_last_Java_frame()) return;
2775   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2776   StackFrameStream fst(this, UseBiasedLocking);
2777   for (; !fst.is_done(); fst.next()) {
2778     if (fst.current()-&gt;should_be_deoptimized()) {
2779       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2780     }
2781   }
2782 }
2783 
2784 
2785 // If the caller is a NamedThread, then remember, in the current scope,
2786 // the given JavaThread in its _processed_thread field.
2787 class RememberProcessedThread: public StackObj {
2788   NamedThread* _cur_thr;
2789  public:
2790   RememberProcessedThread(JavaThread* jthr) {
2791     Thread* thread = Thread::current();
2792     if (thread-&gt;is_Named_thread()) {
2793       _cur_thr = (NamedThread *)thread;
2794       _cur_thr-&gt;set_processed_thread(jthr);
2795     } else {
2796       _cur_thr = NULL;
2797     }
2798   }
2799 
2800   ~RememberProcessedThread() {
2801     if (_cur_thr) {
2802       _cur_thr-&gt;set_processed_thread(NULL);
2803     }
2804   }
2805 };
2806 
2807 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2808   // Verify that the deferred card marks have been flushed.
2809   assert(deferred_card_mark().is_empty(), "Should be empty during GC");
2810 
2811   // Traverse the GCHandles
2812   Thread::oops_do(f, cf);
2813 
2814   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2815          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2816 
2817   if (has_last_Java_frame()) {
2818     // Record JavaThread to GC thread
2819     RememberProcessedThread rpt(this);
2820 
2821     // Traverse the privileged stack
2822     if (_privileged_stack_top != NULL) {
2823       _privileged_stack_top-&gt;oops_do(f);
2824     }
2825 
2826     // traverse the registered growable array
2827     if (_array_for_gc != NULL) {
2828       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2829         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2830       }
2831     }
2832 
2833     // Traverse the monitor chunks
2834     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2835       chunk-&gt;oops_do(f);
2836     }
2837 
2838     // Traverse the execution stack
2839     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2840       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2841     }
2842   }
2843 
2844   // callee_target is never live across a gc point so NULL it here should
2845   // it still contain a methdOop.
2846 
2847   set_callee_target(NULL);
2848 
2849   assert(vframe_array_head() == NULL, "deopt in progress at a safepoint!");
2850   // If we have deferred set_locals there might be oops waiting to be
2851   // written
2852   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2853   if (list != NULL) {
2854     for (int i = 0; i &lt; list-&gt;length(); i++) {
2855       list-&gt;at(i)-&gt;oops_do(f);
2856     }
2857   }
2858 
2859   // Traverse instance variables at the end since the GC may be moving things
2860   // around using this function
2861   f-&gt;do_oop((oop*) &amp;_threadObj);
2862   f-&gt;do_oop((oop*) &amp;_vm_result);
2863   f-&gt;do_oop((oop*) &amp;_exception_oop);
2864   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2865 
2866   if (jvmti_thread_state() != NULL) {
2867     jvmti_thread_state()-&gt;oops_do(f);
2868   }
2869 }
2870 
2871 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2872   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2873          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), "wrong java_sp info!");
2874 
2875   if (has_last_Java_frame()) {
2876     // Traverse the execution stack
2877     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2878       fst.current()-&gt;nmethods_do(cf);
2879     }
2880   }
2881 }
2882 
2883 void JavaThread::metadata_do(void f(Metadata*)) {
2884   if (has_last_Java_frame()) {
2885     // Traverse the execution stack to call f() on the methods in the stack
2886     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2887       fst.current()-&gt;metadata_do(f);
2888     }
2889   } else if (is_Compiler_thread()) {
2890     // need to walk ciMetadata in current compile tasks to keep alive.
2891     CompilerThread* ct = (CompilerThread*)this;
2892     if (ct-&gt;env() != NULL) {
2893       ct-&gt;env()-&gt;metadata_do(f);
2894     }
2895     CompileTask* task = ct-&gt;task();
2896     if (task != NULL) {
2897       task-&gt;metadata_do(f);
2898     }
2899   }
2900 }
2901 
2902 // Printing
2903 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2904   switch (_thread_state) {
2905   case _thread_uninitialized:     return "_thread_uninitialized";
2906   case _thread_new:               return "_thread_new";
2907   case _thread_new_trans:         return "_thread_new_trans";
2908   case _thread_in_native:         return "_thread_in_native";
2909   case _thread_in_native_trans:   return "_thread_in_native_trans";
2910   case _thread_in_vm:             return "_thread_in_vm";
2911   case _thread_in_vm_trans:       return "_thread_in_vm_trans";
2912   case _thread_in_Java:           return "_thread_in_Java";
2913   case _thread_in_Java_trans:     return "_thread_in_Java_trans";
2914   case _thread_blocked:           return "_thread_blocked";
2915   case _thread_blocked_trans:     return "_thread_blocked_trans";
2916   default:                        return "unknown thread state";
2917   }
2918 }
2919 
2920 #ifndef PRODUCT
2921 void JavaThread::print_thread_state_on(outputStream *st) const {
2922   st-&gt;print_cr("   JavaThread state: %s", _get_thread_state_name(_thread_state));
2923 };
2924 void JavaThread::print_thread_state() const {
2925   print_thread_state_on(tty);
2926 }
2927 #endif // PRODUCT
2928 
2929 // Called by Threads::print() for VM_PrintThreads operation
2930 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
2931   st-&gt;print_raw("\"");
2932   st-&gt;print_raw(get_thread_name());
2933   st-&gt;print_raw("\" ");
2934   oop thread_oop = threadObj();
2935   if (thread_oop != NULL) {
2936     st-&gt;print("#" INT64_FORMAT " ", (int64_t)java_lang_Thread::thread_id(thread_oop));
2937     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print("daemon ");
2938     st-&gt;print("prio=%d ", java_lang_Thread::priority(thread_oop));
2939   }
2940   Thread::print_on(st, print_extended_info);
2941   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
2942   st-&gt;print_cr("[" INTPTR_FORMAT "]", (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
2943   if (thread_oop != NULL) {
2944     st-&gt;print_cr("   java.lang.Thread.State: %s", java_lang_Thread::thread_status_name(thread_oop));
2945   }
2946 #ifndef PRODUCT
2947   print_thread_state_on(st);
2948   _safepoint_state-&gt;print_on(st);
2949 #endif // PRODUCT
2950   if (is_Compiler_thread()) {
2951     CompileTask *task = ((CompilerThread*)this)-&gt;task();
2952     if (task != NULL) {
2953       st-&gt;print("   Compiling: ");
2954       task-&gt;print(st, NULL, true, false);
2955     } else {
2956       st-&gt;print("   No compile task");
2957     }
2958     st-&gt;cr();
2959   }
2960 }
2961 
2962 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
2963   st-&gt;print("%s", get_thread_name_string(buf, buflen));
2964 }
2965 
2966 // Called by fatal error handler. The difference between this and
2967 // JavaThread::print() is that we can't grab lock or allocate memory.
2968 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
2969   st-&gt;print("JavaThread \"%s\"", get_thread_name_string(buf, buflen));
2970   oop thread_obj = threadObj();
2971   if (thread_obj != NULL) {
2972     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(" daemon");
2973   }
2974   st-&gt;print(" [");
2975   st-&gt;print("%s", _get_thread_state_name(_thread_state));
2976   if (osthread()) {
2977     st-&gt;print(", id=%d", osthread()-&gt;thread_id());
2978   }
2979   st-&gt;print(", stack(" PTR_FORMAT "," PTR_FORMAT ")",
2980             p2i(stack_end()), p2i(stack_base()));
2981   st-&gt;print("]");
2982 
2983   ThreadsSMRSupport::print_info_on(this, st);
2984   return;
2985 }
2986 
2987 // Verification
2988 
2989 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
2990 
2991 void JavaThread::verify() {
2992   // Verify oops in the thread.
2993   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
2994 
2995   // Verify the stack frames.
2996   frames_do(frame_verify);
2997 }
2998 
2999 // CR 6300358 (sub-CR 2137150)
3000 // Most callers of this method assume that it can't return NULL but a
3001 // thread may not have a name whilst it is in the process of attaching to
3002 // the VM - see CR 6412693, and there are places where a JavaThread can be
3003 // seen prior to having it's threadObj set (eg JNI attaching threads and
3004 // if vm exit occurs during initialization). These cases can all be accounted
3005 // for such that this method never returns NULL.
3006 const char* JavaThread::get_thread_name() const {
3007 #ifdef ASSERT
3008   // early safepoints can hit while current thread does not yet have TLS
3009   if (!SafepointSynchronize::is_at_safepoint()) {
3010     Thread *cur = Thread::current();
3011     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3012       // Current JavaThreads are allowed to get their own name without
3013       // the Threads_lock.
3014       assert_locked_or_safepoint(Threads_lock);
3015     }
3016   }
3017 #endif // ASSERT
3018   return get_thread_name_string();
3019 }
3020 
3021 // Returns a non-NULL representation of this thread's name, or a suitable
3022 // descriptive string if there is no set name
3023 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3024   const char* name_str;
3025   oop thread_obj = threadObj();
3026   if (thread_obj != NULL) {
3027     oop name = java_lang_Thread::name(thread_obj);
3028     if (name != NULL) {
3029       if (buf == NULL) {
3030         name_str = java_lang_String::as_utf8_string(name);
3031       } else {
3032         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3033       }
3034     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3035       name_str = "&lt;no-name - thread is attaching&gt;";
3036     } else {
3037       name_str = Thread::name();
3038     }
3039   } else {
3040     name_str = Thread::name();
3041   }
3042   assert(name_str != NULL, "unexpected NULL thread name");
3043   return name_str;
3044 }
3045 
3046 
3047 const char* JavaThread::get_threadgroup_name() const {
3048   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3049   oop thread_obj = threadObj();
3050   if (thread_obj != NULL) {
3051     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3052     if (thread_group != NULL) {
3053       // ThreadGroup.name can be null
3054       return java_lang_ThreadGroup::name(thread_group);
3055     }
3056   }
3057   return NULL;
3058 }
3059 
3060 const char* JavaThread::get_parent_name() const {
3061   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)
3062   oop thread_obj = threadObj();
3063   if (thread_obj != NULL) {
3064     oop thread_group = java_lang_Thread::threadGroup(thread_obj);
3065     if (thread_group != NULL) {
3066       oop parent = java_lang_ThreadGroup::parent(thread_group);
3067       if (parent != NULL) {
3068         // ThreadGroup.name can be null
3069         return java_lang_ThreadGroup::name(parent);
3070       }
3071     }
3072   }
3073   return NULL;
3074 }
3075 
3076 ThreadPriority JavaThread::java_priority() const {
3077   oop thr_oop = threadObj();
3078   if (thr_oop == NULL) return NormPriority; // Bootstrapping
3079   ThreadPriority priority = java_lang_Thread::priority(thr_oop);
3080   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, "sanity check");
3081   return priority;
3082 }
3083 
3084 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3085 
3086   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
3087   // Link Java Thread object &lt;-&gt; C++ Thread
3088 
3089   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3090   // and put it into a new Handle.  The Handle "thread_oop" can then
3091   // be used to pass the C++ thread object to other methods.
3092 
3093   // Set the Java level thread object (jthread) field of the
3094   // new thread (a JavaThread *) to C++ thread object using the
3095   // "thread_oop" handle.
3096 
3097   // Set the thread field (a JavaThread *) of the
3098   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3099 
3100   Handle thread_oop(Thread::current(),
3101                     JNIHandles::resolve_non_null(jni_thread));
3102   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3103          "must be initialized");
3104   set_threadObj(thread_oop());
3105   java_lang_Thread::set_thread(thread_oop(), this);
3106 
3107   if (prio == NoPriority) {
3108     prio = java_lang_Thread::priority(thread_oop());
3109     assert(prio != NoPriority, "A valid priority should be present");
3110   }
3111 
3112   // Push the Java priority down to the native thread; needs Threads_lock
3113   Thread::set_priority(this, prio);
3114 
3115   // Add the new thread to the Threads list and set it in motion.
3116   // We must have threads lock in order to call Threads::add.
3117   // It is crucial that we do not block before the thread is
3118   // added to the Threads list for if a GC happens, then the java_thread oop
3119   // will not be visited by GC.
3120   Threads::add(this);
3121 }
3122 
3123 oop JavaThread::current_park_blocker() {
3124   // Support for JSR-166 locks
3125   oop thread_oop = threadObj();
3126   if (thread_oop != NULL &amp;&amp;
3127       JDK_Version::current().supports_thread_park_blocker()) {
3128     return java_lang_Thread::park_blocker(thread_oop);
3129   }
3130   return NULL;
3131 }
3132 
3133 
3134 void JavaThread::print_stack_on(outputStream* st) {
3135   if (!has_last_Java_frame()) return;
3136   ResourceMark rm;
3137   HandleMark   hm;
3138 
3139   RegisterMap reg_map(this);
3140   vframe* start_vf = last_java_vframe(&amp;reg_map);
3141   int count = 0;
3142   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3143     if (f-&gt;is_java_frame()) {
3144       javaVFrame* jvf = javaVFrame::cast(f);
3145       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3146 
3147       // Print out lock information
3148       if (JavaMonitorsInStackTrace) {
3149         jvf-&gt;print_lock_info_on(st, count);
3150       }
3151     } else {
3152       // Ignore non-Java frames
3153     }
3154 
3155     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3156     count++;
3157     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3158   }
3159 }
3160 
3161 
3162 // JVMTI PopFrame support
3163 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3164   assert(_popframe_preserved_args == NULL, "should not wipe out old PopFrame preserved arguments");
3165   if (in_bytes(size_in_bytes) != 0) {
3166     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3167     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3168     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3169   }
3170 }
3171 
3172 void* JavaThread::popframe_preserved_args() {
3173   return _popframe_preserved_args;
3174 }
3175 
3176 ByteSize JavaThread::popframe_preserved_args_size() {
3177   return in_ByteSize(_popframe_preserved_args_size);
3178 }
3179 
3180 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3181   int sz = in_bytes(popframe_preserved_args_size());
3182   assert(sz % wordSize == 0, "argument size must be multiple of wordSize");
3183   return in_WordSize(sz / wordSize);
3184 }
3185 
3186 void JavaThread::popframe_free_preserved_args() {
3187   assert(_popframe_preserved_args != NULL, "should not free PopFrame preserved arguments twice");
3188   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);
3189   _popframe_preserved_args = NULL;
3190   _popframe_preserved_args_size = 0;
3191 }
3192 
3193 #ifndef PRODUCT
3194 
3195 void JavaThread::trace_frames() {
3196   tty-&gt;print_cr("[Describe stack]");
3197   int frame_no = 1;
3198   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3199     tty-&gt;print("  %d. ", frame_no++);
3200     fst.current()-&gt;print_value_on(tty, this);
3201     tty-&gt;cr();
3202   }
3203 }
3204 
3205 class PrintAndVerifyOopClosure: public OopClosure {
3206  protected:
3207   template &lt;class T&gt; inline void do_oop_work(T* p) {
3208     oop obj = RawAccess&lt;&gt;::oop_load(p);
3209     if (obj == NULL) return;
3210     tty-&gt;print(INTPTR_FORMAT ": ", p2i(p));
3211     if (oopDesc::is_oop_or_null(obj)) {
3212       if (obj-&gt;is_objArray()) {
3213         tty-&gt;print_cr("valid objArray: " INTPTR_FORMAT, p2i(obj));
3214       } else {
3215         obj-&gt;print();
3216       }
3217     } else {
3218       tty-&gt;print_cr("invalid oop: " INTPTR_FORMAT, p2i(obj));
3219     }
3220     tty-&gt;cr();
3221   }
3222  public:
3223   virtual void do_oop(oop* p) { do_oop_work(p); }
3224   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3225 };
3226 
3227 
3228 static void oops_print(frame* f, const RegisterMap *map) {
3229   PrintAndVerifyOopClosure print;
3230   f-&gt;print_value();
3231   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);
3232 }
3233 
3234 // Print our all the locations that contain oops and whether they are
3235 // valid or not.  This useful when trying to find the oldest frame
3236 // where an oop has gone bad since the frame walk is from youngest to
3237 // oldest.
3238 void JavaThread::trace_oops() {
3239   tty-&gt;print_cr("[Trace oops]");
3240   frames_do(oops_print);
3241 }
3242 
3243 
3244 #ifdef ASSERT
3245 // Print or validate the layout of stack frames
3246 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3247   ResourceMark rm;
3248   PRESERVE_EXCEPTION_MARK;
3249   FrameValues values;
3250   int frame_no = 0;
3251   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3252     fst.current()-&gt;describe(values, ++frame_no);
3253     if (depth == frame_no) break;
3254   }
3255   if (validate_only) {
3256     values.validate();
3257   } else {
3258     tty-&gt;print_cr("[Describe stack layout]");
3259     values.print(this);
3260   }
3261 }
3262 #endif
3263 
3264 void JavaThread::trace_stack_from(vframe* start_vf) {
3265   ResourceMark rm;
3266   int vframe_no = 1;
3267   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3268     if (f-&gt;is_java_frame()) {
3269       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3270     } else {
3271       f-&gt;print();
3272     }
3273     if (vframe_no &gt; StackPrintLimit) {
3274       tty-&gt;print_cr("...&lt;more frames&gt;...");
3275       return;
3276     }
3277   }
3278 }
3279 
3280 
3281 void JavaThread::trace_stack() {
3282   if (!has_last_Java_frame()) return;
3283   ResourceMark rm;
3284   HandleMark   hm;
3285   RegisterMap reg_map(this);
3286   trace_stack_from(last_java_vframe(&amp;reg_map));
3287 }
3288 
3289 
3290 #endif // PRODUCT
3291 
3292 
3293 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3294   assert(reg_map != NULL, "a map must be given");
3295   frame f = last_frame();
3296   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3297     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3298   }
3299   return NULL;
3300 }
3301 
3302 
3303 Klass* JavaThread::security_get_caller_class(int depth) {
3304   vframeStream vfst(this);
3305   vfst.security_get_caller_frame(depth);
3306   if (!vfst.at_end()) {
3307     return vfst.method()-&gt;method_holder();
3308   }
3309   return NULL;
3310 }
3311 
3312 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3313   assert(thread-&gt;is_Compiler_thread(), "must be compiler thread");
3314   CompileBroker::compiler_thread_loop();
3315 }
3316 
3317 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3318   NMethodSweeper::sweeper_loop();
3319 }
3320 
3321 // Create a CompilerThread
3322 CompilerThread::CompilerThread(CompileQueue* queue,
3323                                CompilerCounters* counters)
3324                                : JavaThread(&amp;compiler_thread_entry) {
3325   _env   = NULL;
3326   _log   = NULL;
3327   _task  = NULL;
3328   _queue = queue;
3329   _counters = counters;
3330   _buffer_blob = NULL;
3331   _compiler = NULL;
3332 
3333   // Compiler uses resource area for compilation, let's bias it to mtCompiler
3334   resource_area()-&gt;bias_to(mtCompiler);
3335 
3336 #ifndef PRODUCT
3337   _ideal_graph_printer = NULL;
3338 #endif
3339 }
3340 
3341 CompilerThread::~CompilerThread() {
3342   // Delete objects which were allocated on heap.
3343   delete _counters;
3344 }
3345 
3346 bool CompilerThread::can_call_java() const {
3347   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3348 }
3349 
3350 // Create sweeper thread
3351 CodeCacheSweeperThread::CodeCacheSweeperThread()
3352 : JavaThread(&amp;sweeper_thread_entry) {
3353   _scanned_compiled_method = NULL;
3354 }
3355 
3356 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3357   JavaThread::oops_do(f, cf);
3358   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3359     // Safepoints can occur when the sweeper is scanning an nmethod so
3360     // process it here to make sure it isn't unloaded in the middle of
3361     // a scan.
3362     cf-&gt;do_code_blob(_scanned_compiled_method);
3363   }
3364 }
3365 
3366 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3367   JavaThread::nmethods_do(cf);
3368   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3369     // Safepoints can occur when the sweeper is scanning an nmethod so
3370     // process it here to make sure it isn't unloaded in the middle of
3371     // a scan.
3372     cf-&gt;do_code_blob(_scanned_compiled_method);
3373   }
3374 }
3375 
3376 
3377 // ======= Threads ========
3378 
3379 // The Threads class links together all active threads, and provides
3380 // operations over all threads. It is protected by the Threads_lock,
3381 // which is also used in other global contexts like safepointing.
3382 // ThreadsListHandles are used to safely perform operations on one
3383 // or more threads without the risk of the thread exiting during the
3384 // operation.
3385 //
3386 // Note: The Threads_lock is currently more widely used than we
3387 // would like. We are actively migrating Threads_lock uses to other
3388 // mechanisms in order to reduce Threads_lock contention.
3389 
3390 JavaThread* Threads::_thread_list = NULL;
3391 int         Threads::_number_of_threads = 0;
3392 int         Threads::_number_of_non_daemon_threads = 0;
3393 int         Threads::_return_code = 0;
3394 int         Threads::_thread_claim_parity = 0;
3395 size_t      JavaThread::_stack_size_at_create = 0;
3396 
3397 #ifdef ASSERT
3398 bool        Threads::_vm_complete = false;
3399 size_t      Threads::_threads_before_barrier_set = 0;
3400 #endif
3401 
3402 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3403   Prefetch::read((void*)addr, prefetch_interval);
3404   return *addr;
3405 }
3406 
3407 // Possibly the ugliest for loop the world has seen. C++ does not allow
3408 // multiple types in the declaration section of the for loop. In this case
3409 // we are only dealing with pointers and hence can cast them. It looks ugly
3410 // but macros are ugly and therefore it's fine to make things absurdly ugly.
3411 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3412     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3413              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3414              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3415              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3416              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3417          MACRO_current_p != MACRO_end;                                                                                    \
3418          MACRO_current_p++,                                                                                               \
3419              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3420 
3421 // All JavaThreads
3422 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3423 
3424 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3425 void Threads::non_java_threads_do(ThreadClosure* tc) {
3426   NoSafepointVerifier nsv(!SafepointSynchronize::is_at_safepoint(), false);
3427   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3428     tc-&gt;do_thread(njti.current());
3429   }
3430 }
3431 
3432 // All JavaThreads
3433 void Threads::java_threads_do(ThreadClosure* tc) {
3434   assert_locked_or_safepoint(Threads_lock);
3435   // ALL_JAVA_THREADS iterates through all JavaThreads.
3436   ALL_JAVA_THREADS(p) {
3437     tc-&gt;do_thread(p);
3438   }
3439 }
3440 
3441 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3442   assert_locked_or_safepoint(Threads_lock);
3443   java_threads_do(tc);
3444   tc-&gt;do_thread(VMThread::vm_thread());
3445 }
3446 
3447 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3448 void Threads::threads_do(ThreadClosure* tc) {
3449   assert_locked_or_safepoint(Threads_lock);
3450   java_threads_do(tc);
3451   non_java_threads_do(tc);
3452 }
3453 
3454 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3455   int cp = Threads::thread_claim_parity();
3456   ALL_JAVA_THREADS(p) {
3457     if (p-&gt;claim_oops_do(is_par, cp)) {
3458       tc-&gt;do_thread(p);
3459     }
3460   }
3461   VMThread* vmt = VMThread::vm_thread();
3462   if (vmt-&gt;claim_oops_do(is_par, cp)) {
3463     tc-&gt;do_thread(vmt);
3464   }
3465 }
3466 
3467 // The system initialization in the library has three phases.
3468 //
3469 // Phase 1: java.lang.System class initialization
3470 //     java.lang.System is a primordial class loaded and initialized
3471 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3472 //     only does registerNatives and keeps the rest of the class
3473 //     initialization work later until thread initialization completes.
3474 //
3475 //     System.initPhase1 initializes the system properties, the static
3476 //     fields in, out, and err. Set up java signal handlers, OS-specific
3477 //     system settings, and thread group of the main thread.
3478 static void call_initPhase1(TRAPS) {
3479   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3480   JavaValue result(T_VOID);
3481   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3482                                          vmSymbols::void_method_signature(), CHECK);
3483 }
3484 
3485 // Phase 2. Module system initialization
3486 //     This will initialize the module system.  Only java.base classes
3487 //     can be loaded until phase 2 completes.
3488 //
3489 //     Call System.initPhase2 after the compiler initialization and jsr292
3490 //     classes get initialized because module initialization runs a lot of java
3491 //     code, that for performance reasons, should be compiled.  Also, this will
3492 //     enable the startup code to use lambda and other language features in this
3493 //     phase and onward.
3494 //
3495 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3496 static void call_initPhase2(TRAPS) {
3497   TraceTime timer("Initialize module system", TRACETIME_LOG(Info, startuptime));
3498 
3499   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3500 
3501   JavaValue result(T_INT);
3502   JavaCallArguments args;
3503   args.push_int(DisplayVMOutputToStderr);
3504   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3505   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3506                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3507   if (result.get_jint() != JNI_OK) {
3508     vm_exit_during_initialization(); // no message or exception
3509   }
3510 
3511   universe_post_module_init();
3512 }
3513 
3514 // Phase 3. final setup - set security manager, system class loader and TCCL
3515 //
3516 //     This will instantiate and set the security manager, set the system class
3517 //     loader as well as the thread context class loader.  The security manager
3518 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3519 //     other modules or the application's classpath.
3520 static void call_initPhase3(TRAPS) {
3521   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3522   JavaValue result(T_VOID);
3523   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3524                                          vmSymbols::void_method_signature(), CHECK);
3525 }
3526 
3527 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3528   TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
3529 
3530   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3531     create_vm_init_libraries();
3532   }
3533 
3534   initialize_class(vmSymbols::java_lang_String(), CHECK);
3535 
3536   // Inject CompactStrings value after the static initializers for String ran.
3537   java_lang_String::set_compact_strings(CompactStrings);
3538 
3539   // Initialize java_lang.System (needed before creating the thread)
3540   initialize_class(vmSymbols::java_lang_System(), CHECK);
3541   // The VM creates &amp; returns objects of this class. Make sure it's initialized.
3542   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3543   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3544   Handle thread_group = create_initial_thread_group(CHECK);
3545   Universe::set_main_thread_group(thread_group());
3546   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3547   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3548   main_thread-&gt;set_threadObj(thread_object);
3549   // Set thread status to running since main thread has
3550   // been started and running.
3551   java_lang_Thread::set_thread_status(thread_object,
3552                                       java_lang_Thread::RUNNABLE);
3553 
3554   // The VM creates objects of this class.
3555   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3556 
3557   // The VM preresolves methods to these classes. Make sure that they get initialized
3558   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3559   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3560 
3561   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3562   call_initPhase1(CHECK);
3563 
3564   // get the Java runtime name after java.lang.System is initialized
3565   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3566   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3567 
3568   // an instance of OutOfMemory exception has been allocated earlier
3569   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3570   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3571   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3572   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3573   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3574   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3575   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3576   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3577 }
3578 
3579 void Threads::initialize_jsr292_core_classes(TRAPS) {
3580   TraceTime timer("Initialize java.lang.invoke classes", TRACETIME_LOG(Info, startuptime));
3581 
3582   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3583   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3584   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3585   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3586 }
3587 
3588 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3589   extern void JDK_Version_init();
3590 
3591   // Preinitialize version info.
3592   VM_Version::early_initialize();
3593 
3594   // Check version
3595   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3596 
3597   // Initialize library-based TLS
3598   ThreadLocalStorage::init();
3599 
3600   // Initialize the output stream module
3601   ostream_init();
3602 
3603   // Process java launcher properties.
3604   Arguments::process_sun_java_launcher_properties(args);
3605 
3606   // Initialize the os module
3607   os::init();
3608 
3609   // Record VM creation timing statistics
3610   TraceVmCreationTime create_vm_timer;
3611   create_vm_timer.start();
3612 
3613   // Initialize system properties.
3614   Arguments::init_system_properties();
3615 
3616   // So that JDK version can be used as a discriminator when parsing arguments
3617   JDK_Version_init();
3618 
3619   // Update/Initialize System properties after JDK version number is known
3620   Arguments::init_version_specific_system_properties();
3621 
3622   // Make sure to initialize log configuration *before* parsing arguments
3623   LogConfiguration::initialize(create_vm_timer.begin_time());
3624 
3625   // Parse arguments
3626   // Note: this internally calls os::init_container_support()
3627   jint parse_result = Arguments::parse(args);
3628   if (parse_result != JNI_OK) return parse_result;
3629 
3630   os::init_before_ergo();
3631 
3632   jint ergo_result = Arguments::apply_ergo();
3633   if (ergo_result != JNI_OK) return ergo_result;
3634 
3635   // Final check of all ranges after ergonomics which may change values.
3636   if (!JVMFlagRangeList::check_ranges()) {
3637     return JNI_EINVAL;
3638   }
3639 
3640   // Final check of all 'AfterErgo' constraints after ergonomics which may change values.
3641   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3642   if (!constraint_result) {
3643     return JNI_EINVAL;
3644   }
3645 
3646   JVMFlagWriteableList::mark_startup();
3647 
3648   if (PauseAtStartup) {
3649     os::pause();
3650   }
3651 
3652   HOTSPOT_VM_INIT_BEGIN();
3653 
3654   // Timing (must come after argument parsing)
3655   TraceTime timer("Create VM", TRACETIME_LOG(Info, startuptime));
3656 
3657 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3658   // Initialize assert poison page mechanism.
3659   if (ShowRegistersOnAssert) {
3660     initialize_assert_poison();
3661   }
3662 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3663 
3664   // Initialize the os module after parsing the args
3665   jint os_init_2_result = os::init_2();
3666   if (os_init_2_result != JNI_OK) return os_init_2_result;
3667 
3668   SafepointMechanism::initialize();
3669 
3670   jint adjust_after_os_result = Arguments::adjust_after_os();
3671   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3672 
3673   // Initialize output stream logging
3674   ostream_init_log();
3675 
3676   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3677   // Must be before create_vm_init_agents()
3678   if (Arguments::init_libraries_at_startup()) {
3679     convert_vm_init_libraries_to_agents();
3680   }
3681 
3682   // Launch -agentlib/-agentpath and converted -Xrun agents
3683   if (Arguments::init_agents_at_startup()) {
3684     create_vm_init_agents();
3685   }
3686 
3687   // Initialize Threads state
3688   _thread_list = NULL;
3689   _number_of_threads = 0;
3690   _number_of_non_daemon_threads = 0;
3691 
3692   // Initialize global data structures and create system classes in heap
3693   vm_init_globals();
3694 
3695 #if INCLUDE_JVMCI
3696   if (JVMCICounterSize &gt; 0) {
3697     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);
3698     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3699   } else {
3700     JavaThread::_jvmci_old_thread_counters = NULL;
3701   }
3702 #endif // INCLUDE_JVMCI
3703 
3704   // Attach the main thread to this os thread
3705   JavaThread* main_thread = new JavaThread();
3706   main_thread-&gt;set_thread_state(_thread_in_vm);
3707   main_thread-&gt;initialize_thread_current();
3708   // must do this before set_active_handles
3709   main_thread-&gt;record_stack_base_and_size();
3710   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3711 
3712   if (!main_thread-&gt;set_as_starting_thread()) {
3713     vm_shutdown_during_initialization(
3714                                       "Failed necessary internal allocation. Out of swap space");
3715     main_thread-&gt;smr_delete();
3716     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3717     return JNI_ENOMEM;
3718   }
3719 
3720   // Enable guard page *after* os::create_main_thread(), otherwise it would
3721   // crash Linux VM, see notes in os_linux.cpp.
3722   main_thread-&gt;create_stack_guard_pages();
3723 
3724   // Initialize Java-Level synchronization subsystem
3725   ObjectMonitor::Initialize();
3726 
3727   // Initialize global modules
3728   jint status = init_globals();
3729   if (status != JNI_OK) {
3730     main_thread-&gt;smr_delete();
3731     *canTryAgain = false; // don't let caller call JNI_CreateJavaVM again
3732     return status;
3733   }
3734 
3735   JFR_ONLY(Jfr::on_vm_init();)
3736 
3737   // Should be done after the heap is fully created
3738   main_thread-&gt;cache_global_variables();
3739 
3740   HandleMark hm;
3741 
3742   { MutexLocker mu(Threads_lock);
3743     Threads::add(main_thread);
3744   }
3745 
3746   // Any JVMTI raw monitors entered in onload will transition into
3747   // real raw monitor. VM is setup enough here for raw monitor enter.
3748   JvmtiExport::transition_pending_onload_raw_monitors();
3749 
3750   // Create the VMThread
3751   { TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
3752 
3753   VMThread::create();
3754     Thread* vmthread = VMThread::vm_thread();
3755 
3756     if (!os::create_thread(vmthread, os::vm_thread)) {
3757       vm_exit_during_initialization("Cannot create VM thread. "
3758                                     "Out of system resources.");
3759     }
3760 
3761     // Wait for the VM thread to become ready, and VMThread::run to initialize
3762     // Monitors can have spurious returns, must always check another state flag
3763     {
3764       MutexLocker ml(Notify_lock);
3765       os::start_thread(vmthread);
3766       while (vmthread-&gt;active_handles() == NULL) {
3767         Notify_lock-&gt;wait();
3768       }
3769     }
3770   }
3771 
3772   assert(Universe::is_fully_initialized(), "not initialized");
3773   if (VerifyDuringStartup) {
3774     // Make sure we're starting with a clean slate.
3775     VM_Verify verify_op;
3776     VMThread::execute(&amp;verify_op);
3777   }
3778 
3779   // We need this to update the java.vm.info property in case any flags used
3780   // to initially define it have been changed. This is needed for both CDS and
3781   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3782   // is initially computed. See Abstract_VM_Version::vm_info_string().
3783   // This update must happen before we initialize the java classes, but
3784   // after any initialization logic that might modify the flags.
3785   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3786 
3787   Thread* THREAD = Thread::current();
3788 
3789   // Always call even when there are not JVMTI environments yet, since environments
3790   // may be attached late and JVMTI must track phases of VM execution
3791   JvmtiExport::enter_early_start_phase();
3792 
3793   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3794   JvmtiExport::post_early_vm_start();
3795 
3796   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3797 
3798   quicken_jni_functions();
3799 
3800   // No more stub generation allowed after that point.
3801   StubCodeDesc::freeze();
3802 
3803   // Set flag that basic initialization has completed. Used by exceptions and various
3804   // debug stuff, that does not work until all basic classes have been initialized.
3805   set_init_completed();
3806 
3807   LogConfiguration::post_initialize();
3808   Metaspace::post_initialize();
3809 
3810   HOTSPOT_VM_INIT_END();
3811 
3812   // record VM initialization completion time
3813 #if INCLUDE_MANAGEMENT
3814   Management::record_vm_init_completed();
3815 #endif // INCLUDE_MANAGEMENT
3816 
3817   // Signal Dispatcher needs to be started before VMInit event is posted
3818   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
3819 
3820   // Start Attach Listener if +StartAttachListener or it can't be started lazily
3821   if (!DisableAttachMechanism) {
3822     AttachListener::vm_start();
3823     if (StartAttachListener || AttachListener::init_at_startup()) {
3824       AttachListener::init();
3825     }
3826   }
3827 
3828   // Launch -Xrun agents
3829   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3830   // back-end can launch with -Xdebug -Xrunjdwp.
3831   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3832     create_vm_init_libraries();
3833   }
3834 
3835   if (CleanChunkPoolAsync) {
3836     Chunk::start_chunk_pool_cleaner_task();
3837   }
3838 
3839   // initialize compiler(s)
3840 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
3841 #if INCLUDE_JVMCI
3842   bool force_JVMCI_intialization = false;
3843   if (EnableJVMCI) {
3844     // Initialize JVMCI eagerly when it is explicitly requested.
3845     // Or when JVMCIPrintProperties is enabled.
3846     // The JVMCI Java initialization code will read this flag and
3847     // do the printing if it's set.
3848     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;
3849 
3850     if (!force_JVMCI_intialization) {
3851       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3852       // compilations via JVMCI will not actually block until JVMCI is initialized.
3853       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
3854     }
3855   }
3856 #endif
3857   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
3858   // Postpone completion of compiler initialization to after JVMCI
3859   // is initialized to avoid timeouts of blocking compilations.
3860   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
3861     CompileBroker::compilation_init_phase2();
3862   }
3863 #endif
3864 
3865   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3866   // It is done after compilers are initialized, because otherwise compilations of
3867   // signature polymorphic MH intrinsics can be missed
3868   // (see SystemDictionary::find_method_handle_intrinsic).
3869   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3870 
3871   // This will initialize the module system.  Only java.base classes can be
3872   // loaded until phase 2 completes
3873   call_initPhase2(CHECK_JNI_ERR);
3874 
3875   // Always call even when there are not JVMTI environments yet, since environments
3876   // may be attached late and JVMTI must track phases of VM execution
3877   JvmtiExport::enter_start_phase();
3878 
3879   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3880   JvmtiExport::post_vm_start();
3881 
3882   // Final system initialization including security manager and system class loader
3883   call_initPhase3(CHECK_JNI_ERR);
3884 
3885   // cache the system and platform class loaders
3886   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
3887 
3888 #if INCLUDE_CDS
3889   if (DumpSharedSpaces) {
3890     // capture the module path info from the ModuleEntryTable
3891     ClassLoader::initialize_module_path(THREAD);
3892   }
3893 #endif
3894 
3895 #if INCLUDE_JVMCI
3896   if (force_JVMCI_intialization) {
3897     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);
3898     CompileBroker::compilation_init_phase2();
3899   }
3900 #endif
3901 
3902   // Always call even when there are not JVMTI environments yet, since environments
3903   // may be attached late and JVMTI must track phases of VM execution
3904   JvmtiExport::enter_live_phase();
3905 
3906   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3907   JvmtiExport::post_vm_initialized();
3908 
3909   JFR_ONLY(Jfr::on_vm_start();)
3910 
3911 #if INCLUDE_MANAGEMENT
3912   Management::initialize(THREAD);
3913 
3914   if (HAS_PENDING_EXCEPTION) {
3915     // management agent fails to start possibly due to
3916     // configuration problem and is responsible for printing
3917     // stack trace if appropriate. Simply exit VM.
3918     vm_exit(1);
3919   }
3920 #endif // INCLUDE_MANAGEMENT
3921 
3922   if (MemProfiling)                   MemProfiler::engage();
3923   StatSampler::engage();
3924   if (CheckJNICalls)                  JniPeriodicChecker::engage();
3925 
3926   BiasedLocking::init();
3927 
3928 #if INCLUDE_RTM_OPT
3929   RTMLockingCounters::init();
3930 #endif
3931 
3932   if (JDK_Version::current().post_vm_init_hook_enabled()) {
3933     call_postVMInitHook(THREAD);
3934     // The Java side of PostVMInitHook.run must deal with all
3935     // exceptions and provide means of diagnosis.
3936     if (HAS_PENDING_EXCEPTION) {
3937       CLEAR_PENDING_EXCEPTION;
3938     }
3939   }
3940 
3941   {
3942     MutexLocker ml(PeriodicTask_lock);
3943     // Make sure the WatcherThread can be started by WatcherThread::start()
3944     // or by dynamic enrollment.
3945     WatcherThread::make_startable();
3946     // Start up the WatcherThread if there are any periodic tasks
3947     // NOTE:  All PeriodicTasks should be registered by now. If they
3948     //   aren't, late joiners might appear to start slowly (we might
3949     //   take a while to process their first tick).
3950     if (PeriodicTask::num_tasks() &gt; 0) {
3951       WatcherThread::start();
3952     }
3953   }
3954 
3955   create_vm_timer.end();
3956 #ifdef ASSERT
3957   _vm_complete = true;
3958 #endif
3959 
3960   if (DumpSharedSpaces) {
3961     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
3962     ShouldNotReachHere();
3963   }
3964 
3965   return JNI_OK;
3966 }
3967 
3968 // type for the Agent_OnLoad and JVM_OnLoad entry points
3969 extern "C" {
3970   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
3971 }
3972 // Find a command line agent library and return its entry point for
3973 //         -agentlib:  -agentpath:   -Xrun
3974 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
3975 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
3976                                     const char *on_load_symbols[],
3977                                     size_t num_symbol_entries) {
3978   OnLoadEntry_t on_load_entry = NULL;
3979   void *library = NULL;
3980 
3981   if (!agent-&gt;valid()) {
3982     char buffer[JVM_MAXPATHLEN];
3983     char ebuf[1024] = "";
3984     const char *name = agent-&gt;name();
3985     const char *msg = "Could not find agent library ";
3986 
3987     // First check to see if agent is statically linked into executable
3988     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
3989       library = agent-&gt;os_lib();
3990     } else if (agent-&gt;is_absolute_path()) {
3991       library = os::dll_load(name, ebuf, sizeof ebuf);
3992       if (library == NULL) {
3993         const char *sub_msg = " in absolute path, with error: ";
3994         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
3995         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
3996         jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
3997         // If we can't find the agent, exit.
3998         vm_exit_during_initialization(buf, NULL);
3999         FREE_C_HEAP_ARRAY(char, buf);
4000       }
4001     } else {
4002       // Try to load the agent from the standard dll directory
4003       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4004                              name)) {
4005         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4006       }
4007       if (library == NULL) { // Try the library path directory.
4008         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4009           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4010         }
4011         if (library == NULL) {
4012           const char *sub_msg = " on the library path, with error: ";
4013           const char *sub_msg2 = "\nModule java.instrument may be missing from runtime image.";
4014 
4015           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4016                        strlen(ebuf) + strlen(sub_msg2) + 1;
4017           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4018           if (!agent-&gt;is_instrument_lib()) {
4019             jio_snprintf(buf, len, "%s%s%s%s", msg, name, sub_msg, ebuf);
4020           } else {
4021             jio_snprintf(buf, len, "%s%s%s%s%s", msg, name, sub_msg, ebuf, sub_msg2);
4022           }
4023           // If we can't find the agent, exit.
4024           vm_exit_during_initialization(buf, NULL);
4025           FREE_C_HEAP_ARRAY(char, buf);
4026         }
4027       }
4028     }
4029     agent-&gt;set_os_lib(library);
4030     agent-&gt;set_valid();
4031   }
4032 
4033   // Find the OnLoad function.
4034   on_load_entry =
4035     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4036                                                           false,
4037                                                           on_load_symbols,
4038                                                           num_symbol_entries));
4039   return on_load_entry;
4040 }
4041 
4042 // Find the JVM_OnLoad entry point
4043 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4044   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4045   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4046 }
4047 
4048 // Find the Agent_OnLoad entry point
4049 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4050   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4051   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4052 }
4053 
4054 // For backwards compatibility with -Xrun
4055 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4056 // treated like -agentpath:
4057 // Must be called before agent libraries are created
4058 void Threads::convert_vm_init_libraries_to_agents() {
4059   AgentLibrary* agent;
4060   AgentLibrary* next;
4061 
4062   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4063     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4064     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4065 
4066     // If there is an JVM_OnLoad function it will get called later,
4067     // otherwise see if there is an Agent_OnLoad
4068     if (on_load_entry == NULL) {
4069       on_load_entry = lookup_agent_on_load(agent);
4070       if (on_load_entry != NULL) {
4071         // switch it to the agent list -- so that Agent_OnLoad will be called,
4072         // JVM_OnLoad won't be attempted and Agent_OnUnload will
4073         Arguments::convert_library_to_agent(agent);
4074       } else {
4075         vm_exit_during_initialization("Could not find JVM_OnLoad or Agent_OnLoad function in the library", agent-&gt;name());
4076       }
4077     }
4078   }
4079 }
4080 
4081 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4082 // Invokes Agent_OnLoad
4083 // Called very early -- before JavaThreads exist
4084 void Threads::create_vm_init_agents() {
4085   extern struct JavaVM_ main_vm;
4086   AgentLibrary* agent;
4087 
4088   JvmtiExport::enter_onload_phase();
4089 
4090   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4091     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4092 
4093     if (on_load_entry != NULL) {
4094       // Invoke the Agent_OnLoad function
4095       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4096       if (err != JNI_OK) {
4097         vm_exit_during_initialization("agent library failed to init", agent-&gt;name());
4098       }
4099     } else {
4100       vm_exit_during_initialization("Could not find Agent_OnLoad function in the agent library", agent-&gt;name());
4101     }
4102   }
4103   JvmtiExport::enter_primordial_phase();
4104 }
4105 
4106 extern "C" {
4107   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4108 }
4109 
4110 void Threads::shutdown_vm_agents() {
4111   // Send any Agent_OnUnload notifications
4112   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4113   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4114   extern struct JavaVM_ main_vm;
4115   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4116 
4117     // Find the Agent_OnUnload function.
4118     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4119                                                    os::find_agent_function(agent,
4120                                                    false,
4121                                                    on_unload_symbols,
4122                                                    num_symbol_entries));
4123 
4124     // Invoke the Agent_OnUnload function
4125     if (unload_entry != NULL) {
4126       JavaThread* thread = JavaThread::current();
4127       ThreadToNativeFromVM ttn(thread);
4128       HandleMark hm(thread);
4129       (*unload_entry)(&amp;main_vm);
4130     }
4131   }
4132 }
4133 
4134 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4135 // Invokes JVM_OnLoad
4136 void Threads::create_vm_init_libraries() {
4137   extern struct JavaVM_ main_vm;
4138   AgentLibrary* agent;
4139 
4140   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4141     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4142 
4143     if (on_load_entry != NULL) {
4144       // Invoke the JVM_OnLoad function
4145       JavaThread* thread = JavaThread::current();
4146       ThreadToNativeFromVM ttn(thread);
4147       HandleMark hm(thread);
4148       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4149       if (err != JNI_OK) {
4150         vm_exit_during_initialization("-Xrun library failed to init", agent-&gt;name());
4151       }
4152     } else {
4153       vm_exit_during_initialization("Could not find JVM_OnLoad function in -Xrun library", agent-&gt;name());
4154     }
4155   }
4156 }
4157 
4158 
4159 // Last thread running calls java.lang.Shutdown.shutdown()
4160 void JavaThread::invoke_shutdown_hooks() {
4161   HandleMark hm(this);
4162 
4163   // We could get here with a pending exception, if so clear it now.
4164   if (this-&gt;has_pending_exception()) {
4165     this-&gt;clear_pending_exception();
4166   }
4167 
4168   EXCEPTION_MARK;
4169   Klass* shutdown_klass =
4170     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4171                                       THREAD);
4172   if (shutdown_klass != NULL) {
4173     // SystemDictionary::resolve_or_null will return null if there was
4174     // an exception.  If we cannot load the Shutdown class, just don't
4175     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4176     // won't be run.  Note that if a shutdown hook was registered,
4177     // the Shutdown class would have already been loaded
4178     // (Runtime.addShutdownHook will load it).
4179     JavaValue result(T_VOID);
4180     JavaCalls::call_static(&amp;result,
4181                            shutdown_klass,
4182                            vmSymbols::shutdown_method_name(),
4183                            vmSymbols::void_method_signature(),
4184                            THREAD);
4185   }
4186   CLEAR_PENDING_EXCEPTION;
4187 }
4188 
4189 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4190 // the program falls off the end of main(). Another VM exit path is through
4191 // vm_exit() when the program calls System.exit() to return a value or when
4192 // there is a serious error in VM. The two shutdown paths are not exactly
4193 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4194 // and VM_Exit op at VM level.
4195 //
4196 // Shutdown sequence:
4197 //   + Shutdown native memory tracking if it is on
4198 //   + Wait until we are the last non-daemon thread to execute
4199 //     &lt;-- every thing is still working at this moment --&gt;
4200 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4201 //        shutdown hooks
4202 //   + Call before_exit(), prepare for VM exit
4203 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4204 //        currently the only user of this mechanism is File.deleteOnExit())
4205 //      &gt; stop StatSampler, watcher thread, CMS threads,
4206 //        post thread end and vm death events to JVMTI,
4207 //        stop signal thread
4208 //   + Call JavaThread::exit(), it will:
4209 //      &gt; release JNI handle blocks, remove stack guard pages
4210 //      &gt; remove this thread from Threads list
4211 //     &lt;-- no more Java code from this thread after this point --&gt;
4212 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4213 //     the compiler threads at safepoint
4214 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4215 //   + Disable tracing at JNI/JVM barriers
4216 //   + Set _vm_exited flag for threads that are still running native code
4217 //   + Delete this thread
4218 //   + Call exit_globals()
4219 //      &gt; deletes tty
4220 //      &gt; deletes PerfMemory resources
4221 //   + Return to caller
4222 
4223 bool Threads::destroy_vm() {
4224   JavaThread* thread = JavaThread::current();
4225 
4226 #ifdef ASSERT
4227   _vm_complete = false;
4228 #endif
4229   // Wait until we are the last non-daemon thread to execute
4230   { MutexLocker nu(Threads_lock);
4231     while (Threads::number_of_non_daemon_threads() &gt; 1)
4232       // This wait should make safepoint checks, wait without a timeout,
4233       // and wait as a suspend-equivalent condition.
4234       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,
4235                          Mutex::_as_suspend_equivalent_flag);
4236   }
4237 
4238   EventShutdown e;
4239   if (e.should_commit()) {
4240     e.set_reason("No remaining non-daemon Java threads");
4241     e.commit();
4242   }
4243 
4244   // Hang forever on exit if we are reporting an error.
4245   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4246     os::infinite_sleep();
4247   }
4248   os::wait_for_keypress_at_exit();
4249 
4250   // run Java level shutdown hooks
4251   thread-&gt;invoke_shutdown_hooks();
4252 
4253   before_exit(thread);
4254 
4255   thread-&gt;exit(true);
4256   // thread will never call smr_delete, instead of implicit cancel
4257   // in wait_for_vm_thread_exit we do it explicit.
4258   thread-&gt;cancel_handshake();
4259 
4260   // Stop VM thread.
4261   {
4262     // 4945125 The vm thread comes to a safepoint during exit.
4263     // GC vm_operations can get caught at the safepoint, and the
4264     // heap is unparseable if they are caught. Grab the Heap_lock
4265     // to prevent this. The GC vm_operations will not be able to
4266     // queue until after the vm thread is dead. After this point,
4267     // we'll never emerge out of the safepoint before the VM exits.
4268 
4269     MutexLocker ml(Heap_lock);
4270 
4271     VMThread::wait_for_vm_thread_exit();
4272     assert(SafepointSynchronize::is_at_safepoint(), "VM thread should exit at Safepoint");
4273     VMThread::destroy();
4274   }
4275 
4276   // Now, all Java threads are gone except daemon threads. Daemon threads
4277   // running Java code or in VM are stopped by the Safepoint. However,
4278   // daemon threads executing native code are still running.  But they
4279   // will be stopped at native=&gt;Java/VM barriers. Note that we can't
4280   // simply kill or suspend them, as it is inherently deadlock-prone.
4281 
4282   VM_Exit::set_vm_exited();
4283 
4284   // Clean up ideal graph printers after the VMThread has started
4285   // the final safepoint which will block all the Compiler threads.
4286   // Note that this Thread has already logically exited so the
4287   // clean_up() function's use of a JavaThreadIteratorWithHandle
4288   // would be a problem except set_vm_exited() has remembered the
4289   // shutdown thread which is granted a policy exception.
4290 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4291   IdealGraphPrinter::clean_up();
4292 #endif
4293 
4294   notify_vm_shutdown();
4295 
4296   // We are after VM_Exit::set_vm_exited() so we can't call
4297   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4298   // Deleting the shutdown thread here is safe because another
4299   // JavaThread cannot have an active ThreadsListHandle for
4300   // this JavaThread.
4301   delete thread;
4302 
4303 #if INCLUDE_JVMCI
4304   if (JVMCICounterSize &gt; 0) {
4305     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4306   }
4307 #endif
4308 
4309   // exit_globals() will delete tty
4310   exit_globals();
4311 
4312   LogConfiguration::finalize();
4313 
4314   return true;
4315 }
4316 
4317 
4318 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4319   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4320   return is_supported_jni_version(version);
4321 }
4322 
4323 
4324 jboolean Threads::is_supported_jni_version(jint version) {
4325   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4326   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4327   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4328   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4329   if (version == JNI_VERSION_9) return JNI_TRUE;
4330   if (version == JNI_VERSION_10) return JNI_TRUE;
4331   return JNI_FALSE;
4332 }
4333 
4334 
4335 void Threads::add(JavaThread* p, bool force_daemon) {
4336   // The threads lock must be owned at this point
4337   assert_locked_or_safepoint(Threads_lock);
4338 
4339   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4340 
4341   p-&gt;set_next(_thread_list);
4342   _thread_list = p;
4343 
4344   // Once a JavaThread is added to the Threads list, smr_delete() has
4345   // to be used to delete it. Otherwise we can just delete it directly.
4346   p-&gt;set_on_thread_list();
4347 
4348   _number_of_threads++;
4349   oop threadObj = p-&gt;threadObj();
4350   bool daemon = true;
4351   // Bootstrapping problem: threadObj can be null for initial
4352   // JavaThread (or for threads attached via JNI)
4353   if ((!force_daemon) &amp;&amp; (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj))) {
4354     _number_of_non_daemon_threads++;
4355     daemon = false;
4356   }
4357 
4358   ThreadService::add_thread(p, daemon);
4359 
4360   // Maintain fast thread list
4361   ThreadsSMRSupport::add_thread(p);
4362 
4363   // Possible GC point.
4364   Events::log(p, "Thread added: " INTPTR_FORMAT, p2i(p));
4365 }
4366 
4367 void Threads::remove(JavaThread* p) {
4368 
4369   // Reclaim the objectmonitors from the omInUseList and omFreeList of the moribund thread.
4370   ObjectSynchronizer::omFlush(p);
4371 
4372   // Extra scope needed for Thread_lock, so we can check
4373   // that we do not remove thread without safepoint code notice
4374   { MutexLocker ml(Threads_lock);
4375 
4376     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), "p must be present");
4377 
4378     // Maintain fast thread list
4379     ThreadsSMRSupport::remove_thread(p);
4380 
4381     JavaThread* current = _thread_list;
4382     JavaThread* prev    = NULL;
4383 
4384     while (current != p) {
4385       prev    = current;
4386       current = current-&gt;next();
4387     }
4388 
4389     if (prev) {
4390       prev-&gt;set_next(current-&gt;next());
4391     } else {
4392       _thread_list = p-&gt;next();
4393     }
4394 
4395     _number_of_threads--;
4396     oop threadObj = p-&gt;threadObj();
4397     bool daemon = true;
4398     if (threadObj == NULL || !java_lang_Thread::is_daemon(threadObj)) {
4399       _number_of_non_daemon_threads--;
4400       daemon = false;
4401 
4402       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4403       // on destroy_vm will wake up.
4404       if (number_of_non_daemon_threads() == 1) {
4405         Threads_lock-&gt;notify_all();
4406       }
4407     }
4408     ThreadService::remove_thread(p, daemon);
4409 
4410     // Make sure that safepoint code disregard this thread. This is needed since
4411     // the thread might mess around with locks after this point. This can cause it
4412     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4413     // of this thread since it is removed from the queue.
4414     p-&gt;set_terminated_value();
4415   } // unlock Threads_lock
4416 
4417   // Since Events::log uses a lock, we grab it outside the Threads_lock
4418   Events::log(p, "Thread exited: " INTPTR_FORMAT, p2i(p));
4419 }
4420 
4421 // Operations on the Threads list for GC.  These are not explicitly locked,
4422 // but the garbage collector must provide a safe context for them to run.
4423 // In particular, these things should never be called when the Threads_lock
4424 // is held by some other thread. (Note: the Safepoint abstraction also
4425 // uses the Threads_lock to guarantee this property. It also makes sure that
4426 // all threads gets blocked when exiting or starting).
4427 
4428 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4429   ALL_JAVA_THREADS(p) {
4430     p-&gt;oops_do(f, cf);
4431   }
4432   VMThread::vm_thread()-&gt;oops_do(f, cf);
4433 }
4434 
4435 void Threads::change_thread_claim_parity() {
4436   // Set the new claim parity.
4437   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,
4438          "Not in range.");
4439   _thread_claim_parity++;
4440   if (_thread_claim_parity == 3) _thread_claim_parity = 1;
4441   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,
4442          "Not in range.");
4443 }
4444 
4445 #ifdef ASSERT
4446 void Threads::assert_all_threads_claimed() {
4447   ALL_JAVA_THREADS(p) {
4448     const int thread_parity = p-&gt;oops_do_parity();
4449     assert((thread_parity == _thread_claim_parity),
4450            "Thread " PTR_FORMAT " has incorrect parity %d != %d", p2i(p), thread_parity, _thread_claim_parity);
4451   }
4452   VMThread* vmt = VMThread::vm_thread();
4453   const int thread_parity = vmt-&gt;oops_do_parity();
4454   assert((thread_parity == _thread_claim_parity),
4455          "VMThread " PTR_FORMAT " has incorrect parity %d != %d", p2i(vmt), thread_parity, _thread_claim_parity);
4456 }
4457 #endif // ASSERT
4458 
4459 class ParallelOopsDoThreadClosure : public ThreadClosure {
4460 private:
4461   OopClosure* _f;
4462   CodeBlobClosure* _cf;
4463 public:
4464   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4465   void do_thread(Thread* t) {
4466     t-&gt;oops_do(_f, _cf);
4467   }
4468 };
4469 
4470 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4471   ParallelOopsDoThreadClosure tc(f, cf);
4472   possibly_parallel_threads_do(is_par, &amp;tc);
4473 }
4474 
4475 void Threads::nmethods_do(CodeBlobClosure* cf) {
4476   ALL_JAVA_THREADS(p) {
4477     // This is used by the code cache sweeper to mark nmethods that are active
4478     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4479     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4480     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4481       p-&gt;nmethods_do(cf);
4482     }
4483   }
4484 }
4485 
4486 void Threads::metadata_do(void f(Metadata*)) {
4487   ALL_JAVA_THREADS(p) {
4488     p-&gt;metadata_do(f);
4489   }
4490 }
4491 
4492 class ThreadHandlesClosure : public ThreadClosure {
4493   void (*_f)(Metadata*);
4494  public:
4495   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4496   virtual void do_thread(Thread* thread) {
4497     thread-&gt;metadata_handles_do(_f);
4498   }
4499 };
4500 
4501 void Threads::metadata_handles_do(void f(Metadata*)) {
4502   // Only walk the Handles in Thread.
4503   ThreadHandlesClosure handles_closure(f);
4504   threads_do(&amp;handles_closure);
4505 }
4506 
4507 void Threads::deoptimized_wrt_marked_nmethods() {
4508   ALL_JAVA_THREADS(p) {
4509     p-&gt;deoptimized_wrt_marked_nmethods();
4510   }
4511 }
4512 
4513 
4514 // Get count Java threads that are waiting to enter the specified monitor.
4515 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4516                                                          int count,
4517                                                          address monitor) {
4518   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4519 
4520   int i = 0;
4521   DO_JAVA_THREADS(t_list, p) {
4522     if (!p-&gt;can_call_java()) continue;
4523 
4524     address pending = (address)p-&gt;current_pending_monitor();
4525     if (pending == monitor) {             // found a match
4526       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4527       i++;
4528     }
4529   }
4530 
4531   return result;
4532 }
4533 
4534 
4535 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4536                                                       address owner) {
4537   // NULL owner means not locked so we can skip the search
4538   if (owner == NULL) return NULL;
4539 
4540   DO_JAVA_THREADS(t_list, p) {
4541     // first, see if owner is the address of a Java thread
4542     if (owner == (address)p) return p;
4543   }
4544 
4545   // Cannot assert on lack of success here since this function may be
4546   // used by code that is trying to report useful problem information
4547   // like deadlock detection.
4548   if (UseHeavyMonitors) return NULL;
4549 
4550   // If we didn't find a matching Java thread and we didn't force use of
4551   // heavyweight monitors, then the owner is the stack address of the
4552   // Lock Word in the owning Java thread's stack.
4553   //
4554   JavaThread* the_owner = NULL;
4555   DO_JAVA_THREADS(t_list, q) {
4556     if (q-&gt;is_lock_owned(owner)) {
4557       the_owner = q;
4558       break;
4559     }
4560   }
4561 
4562   // cannot assert on lack of success here; see above comment
4563   return the_owner;
4564 }
4565 
4566 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4567 void Threads::print_on(outputStream* st, bool print_stacks,
4568                        bool internal_format, bool print_concurrent_locks,
4569                        bool print_extended_info) {
4570   char buf[32];
4571   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4572 
4573   st-&gt;print_cr("Full thread dump %s (%s %s):",
4574                Abstract_VM_Version::vm_name(),
4575                Abstract_VM_Version::vm_release(),
4576                Abstract_VM_Version::vm_info_string());
4577   st-&gt;cr();
4578 
4579 #if INCLUDE_SERVICES
4580   // Dump concurrent locks
4581   ConcurrentLocksDump concurrent_locks;
4582   if (print_concurrent_locks) {
4583     concurrent_locks.dump_at_safepoint();
4584   }
4585 #endif // INCLUDE_SERVICES
4586 
4587   ThreadsSMRSupport::print_info_on(st);
4588   st-&gt;cr();
4589 
4590   ALL_JAVA_THREADS(p) {
4591     ResourceMark rm;
4592     p-&gt;print_on(st, print_extended_info);
4593     if (print_stacks) {
4594       if (internal_format) {
4595         p-&gt;trace_stack();
4596       } else {
4597         p-&gt;print_stack_on(st);
4598       }
4599     }
4600     st-&gt;cr();
4601 #if INCLUDE_SERVICES
4602     if (print_concurrent_locks) {
4603       concurrent_locks.print_locks_on(p, st);
4604     }
4605 #endif // INCLUDE_SERVICES
4606   }
4607 
4608   VMThread::vm_thread()-&gt;print_on(st);
4609   st-&gt;cr();
4610   Universe::heap()-&gt;print_gc_threads_on(st);
4611   WatcherThread* wt = WatcherThread::watcher_thread();
4612   if (wt != NULL) {
4613     wt-&gt;print_on(st);
4614     st-&gt;cr();
4615   }
4616 
4617   st-&gt;flush();
4618 }
4619 
4620 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4621                              int buflen, bool* found_current) {
4622   if (this_thread != NULL) {
4623     bool is_current = (current == this_thread);
4624     *found_current = *found_current || is_current;
4625     st-&gt;print("%s", is_current ? "=&gt;" : "  ");
4626 
4627     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4628     st-&gt;print(" ");
4629     this_thread-&gt;print_on_error(st, buf, buflen);
4630     st-&gt;cr();
4631   }
4632 }
4633 
4634 class PrintOnErrorClosure : public ThreadClosure {
4635   outputStream* _st;
4636   Thread* _current;
4637   char* _buf;
4638   int _buflen;
4639   bool* _found_current;
4640  public:
4641   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4642                       int buflen, bool* found_current) :
4643    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4644 
4645   virtual void do_thread(Thread* thread) {
4646     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4647   }
4648 };
4649 
4650 // Threads::print_on_error() is called by fatal error handler. It's possible
4651 // that VM is not at safepoint and/or current thread is inside signal handler.
4652 // Don't print stack trace, as the stack may not be walkable. Don't allocate
4653 // memory (even in resource area), it might deadlock the error handler.
4654 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4655                              int buflen) {
4656   ThreadsSMRSupport::print_info_on(st);
4657   st-&gt;cr();
4658 
4659   bool found_current = false;
4660   st-&gt;print_cr("Java Threads: ( =&gt; current thread )");
4661   ALL_JAVA_THREADS(thread) {
4662     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4663   }
4664   st-&gt;cr();
4665 
4666   st-&gt;print_cr("Other Threads:");
4667   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4668   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4669 
4670   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4671   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4672 
4673   if (!found_current) {
4674     st-&gt;cr();
4675     st-&gt;print("=&gt;" PTR_FORMAT " (exited) ", p2i(current));
4676     current-&gt;print_on_error(st, buf, buflen);
4677     st-&gt;cr();
4678   }
4679   st-&gt;cr();
4680 
4681   st-&gt;print_cr("Threads with active compile tasks:");
4682   print_threads_compiling(st, buf, buflen);
4683 }
4684 
4685 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen) {
4686   ALL_JAVA_THREADS(thread) {
4687     if (thread-&gt;is_Compiler_thread()) {
4688       CompilerThread* ct = (CompilerThread*) thread;
4689 
4690       // Keep task in local variable for NULL check.
4691       // ct-&gt;_task might be set to NULL by concurring compiler thread
4692       // because it completed the compilation. The task is never freed,
4693       // though, just returned to a free list.
4694       CompileTask* task = ct-&gt;task();
4695       if (task != NULL) {
4696         thread-&gt;print_name_on_error(st, buf, buflen);
4697         task-&gt;print(st, NULL, true, true);
4698       }
4699     }
4700   }
4701 }
4702 
4703 
4704 // Internal SpinLock and Mutex
4705 // Based on ParkEvent
4706 
4707 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4708 //
4709 // We employ SpinLocks _only for low-contention, fixed-length
4710 // short-duration critical sections where we're concerned
4711 // about native mutex_t or HotSpot Mutex:: latency.
4712 // The mux construct provides a spin-then-block mutual exclusion
4713 // mechanism.
4714 //
4715 // Testing has shown that contention on the ListLock guarding gFreeList
4716 // is common.  If we implement ListLock as a simple SpinLock it's common
4717 // for the JVM to devolve to yielding with little progress.  This is true
4718 // despite the fact that the critical sections protected by ListLock are
4719 // extremely short.
4720 //
4721 // TODO-FIXME: ListLock should be of type SpinLock.
4722 // We should make this a 1st-class type, integrated into the lock
4723 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4724 // should have sufficient padding to avoid false-sharing and excessive
4725 // cache-coherency traffic.
4726 
4727 
4728 typedef volatile int SpinLockT;
4729 
4730 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4731   if (Atomic::cmpxchg (1, adr, 0) == 0) {
4732     return;   // normal fast-path return
4733   }
4734 
4735   // Slow-path : We've encountered contention -- Spin/Yield/Block strategy.
4736   int ctr = 0;
4737   int Yields = 0;
4738   for (;;) {
4739     while (*adr != 0) {
4740       ++ctr;
4741       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4742         if (Yields &gt; 5) {
4743           os::naked_short_sleep(1);
4744         } else {
4745           os::naked_yield();
4746           ++Yields;
4747         }
4748       } else {
4749         SpinPause();
4750       }
4751     }
4752     if (Atomic::cmpxchg(1, adr, 0) == 0) return;
4753   }
4754 }
4755 
4756 void Thread::SpinRelease(volatile int * adr) {
4757   assert(*adr != 0, "invariant");
4758   OrderAccess::fence();      // guarantee at least release consistency.
4759   // Roach-motel semantics.
4760   // It's safe if subsequent LDs and STs float "up" into the critical section,
4761   // but prior LDs and STs within the critical section can't be allowed
4762   // to reorder or float past the ST that releases the lock.
4763   // Loads and stores in the critical section - which appear in program
4764   // order before the store that releases the lock - must also appear
4765   // before the store that releases the lock in memory visibility order.
4766   // Conceptually we need a #loadstore|#storestore "release" MEMBAR before
4767   // the ST of 0 into the lock-word which releases the lock, so fence
4768   // more than covers this on all platforms.
4769   *adr = 0;
4770 }
4771 
4772 // muxAcquire and muxRelease:
4773 //
4774 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4775 //    The LSB of the word is set IFF the lock is held.
4776 //    The remainder of the word points to the head of a singly-linked list
4777 //    of threads blocked on the lock.
4778 //
4779 // *  The current implementation of muxAcquire-muxRelease uses its own
4780 //    dedicated Thread._MuxEvent instance.  If we're interested in
4781 //    minimizing the peak number of extant ParkEvent instances then
4782 //    we could eliminate _MuxEvent and "borrow" _ParkEvent as long
4783 //    as certain invariants were satisfied.  Specifically, care would need
4784 //    to be taken with regards to consuming unpark() "permits".
4785 //    A safe rule of thumb is that a thread would never call muxAcquire()
4786 //    if it's enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4787 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4788 //    consume an unpark() permit intended for monitorenter, for instance.
4789 //    One way around this would be to widen the restricted-range semaphore
4790 //    implemented in park().  Another alternative would be to provide
4791 //    multiple instances of the PlatformEvent() for each thread.  One
4792 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4793 //
4794 // *  Usage:
4795 //    -- Only as leaf locks
4796 //    -- for short-term locking only as muxAcquire does not perform
4797 //       thread state transitions.
4798 //
4799 // Alternatives:
4800 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4801 //    but with parking or spin-then-park instead of pure spinning.
4802 // *  Use Taura-Oyama-Yonenzawa locks.
4803 // *  It's possible to construct a 1-0 lock if we encode the lockword as
4804 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4805 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4806 //    acquiring threads use timers (ParkTimed) to detect and recover from
4807 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4808 //    boundaries by using placement-new.
4809 // *  Augment MCS with advisory back-link fields maintained with CAS().
4810 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4811 //    The validity of the backlinks must be ratified before we trust the value.
4812 //    If the backlinks are invalid the exiting thread must back-track through the
4813 //    the forward links, which are always trustworthy.
4814 // *  Add a successor indication.  The LockWord is currently encoded as
4815 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4816 //    to provide the usual futile-wakeup optimization.
4817 //    See RTStt for details.
4818 //
4819 
4820 
4821 const intptr_t LOCKBIT = 1;
4822 
4823 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
4824   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4825   if (w == 0) return;
4826   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4827     return;
4828   }
4829 
4830   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4831   assert((intptr_t(Self) &amp; LOCKBIT) == 0, "invariant");
4832   for (;;) {
4833     int its = (os::is_MP() ? 100 : 0) + 1;
4834 
4835     // Optional spin phase: spin-then-park strategy
4836     while (--its &gt;= 0) {
4837       w = *Lock;
4838       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4839         return;
4840       }
4841     }
4842 
4843     Self-&gt;reset();
4844     Self-&gt;OnList = intptr_t(Lock);
4845     // The following fence() isn't _strictly necessary as the subsequent
4846     // CAS() both serializes execution and ratifies the fetched *Lock value.
4847     OrderAccess::fence();
4848     for (;;) {
4849       w = *Lock;
4850       if ((w &amp; LOCKBIT) == 0) {
4851         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4852           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4853           return;
4854         }
4855         continue;      // Interference -- *Lock changed -- Just retry
4856       }
4857       assert(w &amp; LOCKBIT, "invariant");
4858       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4859       if (Atomic::cmpxchg(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;
4860     }
4861 
4862     while (Self-&gt;OnList != 0) {
4863       Self-&gt;park();
4864     }
4865   }
4866 }
4867 
4868 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {
4869   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);
4870   if (w == 0) return;
4871   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4872     return;
4873   }
4874 
4875   ParkEvent * ReleaseAfter = NULL;
4876   if (ev == NULL) {
4877     ev = ReleaseAfter = ParkEvent::Allocate(NULL);
4878   }
4879   assert((intptr_t(ev) &amp; LOCKBIT) == 0, "invariant");
4880   for (;;) {
4881     guarantee(ev-&gt;OnList == 0, "invariant");
4882     int its = (os::is_MP() ? 100 : 0) + 1;
4883 
4884     // Optional spin phase: spin-then-park strategy
4885     while (--its &gt;= 0) {
4886       w = *Lock;
4887       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4888         if (ReleaseAfter != NULL) {
4889           ParkEvent::Release(ReleaseAfter);
4890         }
4891         return;
4892       }
4893     }
4894 
4895     ev-&gt;reset();
4896     ev-&gt;OnList = intptr_t(Lock);
4897     // The following fence() isn't _strictly necessary as the subsequent
4898     // CAS() both serializes execution and ratifies the fetched *Lock value.
4899     OrderAccess::fence();
4900     for (;;) {
4901       w = *Lock;
4902       if ((w &amp; LOCKBIT) == 0) {
4903         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {
4904           ev-&gt;OnList = 0;
4905           // We call ::Release while holding the outer lock, thus
4906           // artificially lengthening the critical section.
4907           // Consider deferring the ::Release() until the subsequent unlock(),
4908           // after we've dropped the outer lock.
4909           if (ReleaseAfter != NULL) {
4910             ParkEvent::Release(ReleaseAfter);
4911           }
4912           return;
4913         }
4914         continue;      // Interference -- *Lock changed -- Just retry
4915       }
4916       assert(w &amp; LOCKBIT, "invariant");
4917       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
4918       if (Atomic::cmpxchg(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;
4919     }
4920 
4921     while (ev-&gt;OnList != 0) {
4922       ev-&gt;park();
4923     }
4924   }
4925 }
4926 
4927 // Release() must extract a successor from the list and then wake that thread.
4928 // It can "pop" the front of the list or use a detach-modify-reattach (DMR) scheme
4929 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
4930 // Release() would :
4931 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
4932 // (B) Extract a successor from the private list "in-hand"
4933 // (C) attempt to CAS() the residual back into *Lock over null.
4934 //     If there were any newly arrived threads and the CAS() would fail.
4935 //     In that case Release() would detach the RATs, re-merge the list in-hand
4936 //     with the RATs and repeat as needed.  Alternately, Release() might
4937 //     detach and extract a successor, but then pass the residual list to the wakee.
4938 //     The wakee would be responsible for reattaching and remerging before it
4939 //     competed for the lock.
4940 //
4941 // Both "pop" and DMR are immune from ABA corruption -- there can be
4942 // multiple concurrent pushers, but only one popper or detacher.
4943 // This implementation pops from the head of the list.  This is unfair,
4944 // but tends to provide excellent throughput as hot threads remain hot.
4945 // (We wake recently run threads first).
4946 //
4947 // All paths through muxRelease() will execute a CAS.
4948 // Release consistency -- We depend on the CAS in muxRelease() to provide full
4949 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
4950 // executed within the critical section are complete and globally visible before the
4951 // store (CAS) to the lock-word that releases the lock becomes globally visible.
4952 void Thread::muxRelease(volatile intptr_t * Lock)  {
4953   for (;;) {
4954     const intptr_t w = Atomic::cmpxchg((intptr_t)0, Lock, LOCKBIT);
4955     assert(w &amp; LOCKBIT, "invariant");
4956     if (w == LOCKBIT) return;
4957     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
4958     assert(List != NULL, "invariant");
4959     assert(List-&gt;OnList == intptr_t(Lock), "invariant");
4960     ParkEvent * const nxt = List-&gt;ListNext;
4961     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, "invariant");
4962 
4963     // The following CAS() releases the lock and pops the head element.
4964     // The CAS() also ratifies the previously fetched lock-word value.
4965     if (Atomic::cmpxchg(intptr_t(nxt), Lock, w) != w) {
4966       continue;
4967     }
4968     List-&gt;OnList = 0;
4969     OrderAccess::fence();
4970     List-&gt;unpark();
4971     return;
4972   }
4973 }
4974 
4975 
4976 void Threads::verify() {
4977   ALL_JAVA_THREADS(p) {
4978     p-&gt;verify();
4979   }
4980   VMThread* thread = VMThread::vm_thread();
4981   if (thread != NULL) thread-&gt;verify();
4982 }
</pre></body></html>
