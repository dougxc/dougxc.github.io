<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>New src/share/vm/compiler/compileBroker.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2015, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/systemDictionary.hpp"
  27 #include "classfile/vmSymbols.hpp"
  28 #include "code/codeCache.hpp"
  29 #include "compiler/compileBroker.hpp"
  30 #include "compiler/compileLog.hpp"
  31 #include "compiler/compilerOracle.hpp"
  32 #include "compiler/directivesParser.hpp"
  33 #include "interpreter/linkResolver.hpp"
  34 #include "memory/allocation.inline.hpp"
  35 #include "oops/methodData.hpp"
  36 #include "oops/method.hpp"
  37 #include "oops/oop.inline.hpp"
  38 #include "prims/nativeLookup.hpp"
  39 #include "prims/whitebox.hpp"
  40 #include "runtime/arguments.hpp"
  41 #include "runtime/atomic.inline.hpp"
  42 #include "runtime/compilationPolicy.hpp"
  43 #include "runtime/init.hpp"
  44 #include "runtime/interfaceSupport.hpp"
  45 #include "runtime/javaCalls.hpp"
  46 #include "runtime/os.hpp"
  47 #include "runtime/sharedRuntime.hpp"
  48 #include "runtime/sweeper.hpp"
  49 #include "trace/tracing.hpp"
  50 #include "utilities/dtrace.hpp"
  51 #include "utilities/events.hpp"
  52 #ifdef COMPILER1
  53 #include "c1/c1_Compiler.hpp"
  54 #endif
  55 #if INCLUDE_JVMCI
  56 #include "jvmci/jvmciCompiler.hpp"
  57 #include "jvmci/jvmciRuntime.hpp"
  58 #include "runtime/vframe.hpp"
  59 #endif
  60 #ifdef COMPILER2
  61 #include "opto/c2compiler.hpp"
  62 #endif
  63 #ifdef SHARK
  64 #include "shark/sharkCompiler.hpp"
  65 #endif
  66 
  67 #ifdef DTRACE_ENABLED
  68 
  69 // Only bother with this argument setup if dtrace is available
  70 
  71 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  72   {                                                                      \
  73     Symbol* klass_name = (method)-&gt;klass_name();                         \
  74     Symbol* name = (method)-&gt;name();                                     \
  75     Symbol* signature = (method)-&gt;signature();                           \
  76     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  77       (char *) comp_name, strlen(comp_name),                             \
  78       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  79       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  80       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  81   }
  82 
  83 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  84   {                                                                      \
  85     Symbol* klass_name = (method)-&gt;klass_name();                         \
  86     Symbol* name = (method)-&gt;name();                                     \
  87     Symbol* signature = (method)-&gt;signature();                           \
  88     HOTSPOT_METHOD_COMPILE_END(                                          \
  89       (char *) comp_name, strlen(comp_name),                             \
  90       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  91       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  92       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
  93   }
  94 
  95 #else //  ndef DTRACE_ENABLED
  96 
  97 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
  98 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
  99 
 100 #endif // ndef DTRACE_ENABLED
 101 
 102 bool CompileBroker::_initialized = false;
 103 volatile bool CompileBroker::_should_block = false;
 104 volatile jint CompileBroker::_print_compilation_warning = 0;
 105 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 106 
 107 // The installed compiler(s)
 108 AbstractCompiler* CompileBroker::_compilers[2];
 109 
 110 // These counters are used to assign an unique ID to each compilation.
 111 volatile jint CompileBroker::_compilation_id     = 0;
 112 volatile jint CompileBroker::_osr_compilation_id = 0;
 113 
 114 // Debugging information
 115 int  CompileBroker::_last_compile_type     = no_compile;
 116 int  CompileBroker::_last_compile_level    = CompLevel_none;
 117 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 118 
 119 // Performance counters
 120 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 121 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 122 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 123 
 124 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 125 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 126 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 127 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 128 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 129 
 130 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 131 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 132 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 133 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 134 
 135 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 136 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 137 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 138 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 139 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 140 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 141 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 142 
 143 // Timers and counters for generating statistics
 144 elapsedTimer CompileBroker::_t_total_compilation;
 145 elapsedTimer CompileBroker::_t_osr_compilation;
 146 elapsedTimer CompileBroker::_t_standard_compilation;
 147 elapsedTimer CompileBroker::_t_invalidated_compilation;
 148 elapsedTimer CompileBroker::_t_bailedout_compilation;
 149 
 150 int CompileBroker::_total_bailout_count          = 0;
 151 int CompileBroker::_total_invalidated_count      = 0;
 152 int CompileBroker::_total_compile_count          = 0;
 153 int CompileBroker::_total_osr_compile_count      = 0;
 154 int CompileBroker::_total_standard_compile_count = 0;
 155 
 156 int CompileBroker::_sum_osr_bytes_compiled       = 0;
 157 int CompileBroker::_sum_standard_bytes_compiled  = 0;
 158 int CompileBroker::_sum_nmethod_size             = 0;
 159 int CompileBroker::_sum_nmethod_code_size        = 0;
 160 
 161 long CompileBroker::_peak_compilation_time       = 0;
 162 
 163 CompileQueue* CompileBroker::_c2_compile_queue   = NULL;
 164 CompileQueue* CompileBroker::_c1_compile_queue   = NULL;
 165 
 166 class CompilationLog : public StringEventLog {
 167  public:
 168   CompilationLog() : StringEventLog("Compilation events") {
 169   }
 170 
 171   void log_compile(JavaThread* thread, CompileTask* task) {
 172     StringLogMessage lm;
 173     stringStream sstr = lm.stream();
 174     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 175     task-&gt;print(&amp;sstr, NULL, true, false);
 176     log(thread, "%s", (const char*)lm);
 177   }
 178 
 179   void log_nmethod(JavaThread* thread, nmethod* nm) {
 180     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 181         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 182         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 183   }
 184 
 185   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 186     StringLogMessage lm;
 187     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 188     if (retry_message != NULL) {
 189       lm.append(" (%s)", retry_message);
 190     }
 191     lm.print("\n");
 192     log(thread, "%s", (const char*)lm);
 193   }
 194 
 195   void log_metaspace_failure(const char* reason) {
 196     ResourceMark rm;
 197     StringLogMessage lm;
 198     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 199     lm.print("\n");
 200     log(JavaThread::current(), "%s", (const char*)lm);
 201   }
 202 };
 203 
 204 static CompilationLog* _compilation_log = NULL;
 205 
 206 bool compileBroker_init() {
 207   if (LogEvents) {
 208     _compilation_log = new CompilationLog();
 209   }
 210 
 211   // init directives stack, adding default directive
 212   DirectivesStack::init();
 213 
 214   if (DirectivesParser::has_file()) {
 215     return DirectivesParser::parse_from_flag();
 216   } else if (PrintCompilerDirectives) {
 217     // Print default directive even when no other was added
 218     DirectivesStack::print(tty);
 219   }
 220 
 221   return true;
 222 }
 223 
 224 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 225   CompilerThread* thread = CompilerThread::current();
 226   thread-&gt;set_task(task);
 227   CompileLog*     log  = thread-&gt;log();
 228   if (log != NULL)  task-&gt;log_task_start(log);
 229 }
 230 
 231 CompileTaskWrapper::~CompileTaskWrapper() {
 232   CompilerThread* thread = CompilerThread::current();
 233   CompileTask* task = thread-&gt;task();
 234   CompileLog*  log  = thread-&gt;log();
 235   if (log != NULL)  task-&gt;log_task_done(log);
 236   thread-&gt;set_task(NULL);
 237   task-&gt;set_code_handle(NULL);
 238   thread-&gt;set_env(NULL);
 239   if (task-&gt;is_blocking()) {
 240     bool free_task = false;
 241     {
 242       MutexLocker notifier(task-&gt;lock(), thread);
 243       task-&gt;mark_complete();
 244 #if INCLUDE_JVMCI
 245       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci() &amp;&amp;
 246         !task-&gt;has_waiter()) {
 247         // The waiting thread timed out and thus did not free the task.
 248         free_task = true;
 249       }
 250 #endif
 251       if (!free_task) {
 252         // Notify the waiting thread that the compilation has completed
 253         // so that it can free the task.
 254         task-&gt;lock()-&gt;notify_all();
 255       }
 256     }
 257     if (free_task) {
 258       // The task can only be freed once the task lock is released.
 259       CompileTask::free(task);
 260     }
 261   } else {
 262     task-&gt;mark_complete();
 263 
 264     // By convention, the compiling thread is responsible for
 265     // recycling a non-blocking CompileTask.
 266     CompileTask::free(task);
 267   }
 268 }
 269 
 270 /**
 271  * Add a CompileTask to a CompileQueue.
 272  */
 273 void CompileQueue::add(CompileTask* task) {
 274   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 275 
 276   task-&gt;set_next(NULL);
 277   task-&gt;set_prev(NULL);
 278 
 279   if (_last == NULL) {
 280     // The compile queue is empty.
 281     assert(_first == NULL, "queue is empty");
 282     _first = task;
 283     _last = task;
 284   } else {
 285     // Append the task to the queue.
 286     assert(_last-&gt;next() == NULL, "not last");
 287     _last-&gt;set_next(task);
 288     task-&gt;set_prev(_last);
 289     _last = task;
 290   }
 291   ++_size;
 292 
 293   // Mark the method as being in the compile queue.
 294   task-&gt;method()-&gt;set_queued_for_compilation();
 295 
 296   if (CIPrintCompileQueue) {
 297     print_tty();
 298   }
 299 
 300   if (LogCompilation &amp;&amp; xtty != NULL) {
 301     task-&gt;log_task_queued();
 302   }
 303 
 304   // Notify CompilerThreads that a task is available.
 305   MethodCompileQueue_lock-&gt;notify_all();
 306 }
 307 
 308 /**
 309  * Empties compilation queue by putting all compilation tasks onto
 310  * a freelist. Furthermore, the method wakes up all threads that are
 311  * waiting on a compilation task to finish. This can happen if background
 312  * compilation is disabled.
 313  */
 314 void CompileQueue::free_all() {
 315   MutexLocker mu(MethodCompileQueue_lock);
 316   CompileTask* next = _first;
 317 
 318   // Iterate over all tasks in the compile queue
 319   while (next != NULL) {
 320     CompileTask* current = next;
 321     next = current-&gt;next();
 322     {
 323       // Wake up thread that blocks on the compile task.
 324       MutexLocker ct_lock(current-&gt;lock());
 325       current-&gt;lock()-&gt;notify();
 326     }
 327     // Put the task back on the freelist.
 328     CompileTask::free(current);
 329   }
 330   _first = NULL;
 331 
 332   // Wake up all threads that block on the queue.
 333   MethodCompileQueue_lock-&gt;notify_all();
 334 }
 335 
 336 /**
 337  * Get the next CompileTask from a CompileQueue
 338  */
 339 CompileTask* CompileQueue::get() {
 340   // save methods from RedefineClasses across safepoint
 341   // across MethodCompileQueue_lock below.
 342   methodHandle save_method;
 343   methodHandle save_hot_method;
 344 
 345   MutexLocker locker(MethodCompileQueue_lock);
 346   // If _first is NULL we have no more compile jobs. There are two reasons for
 347   // having no compile jobs: First, we compiled everything we wanted. Second,
 348   // we ran out of code cache so compilation has been disabled. In the latter
 349   // case we perform code cache sweeps to free memory such that we can re-enable
 350   // compilation.
 351   while (_first == NULL) {
 352     // Exit loop if compilation is disabled forever
 353     if (CompileBroker::is_compilation_disabled_forever()) {
 354       return NULL;
 355     }
 356 
 357     // If there are no compilation tasks and we can compile new jobs
 358     // (i.e., there is enough free space in the code cache) there is
 359     // no need to invoke the sweeper. As a result, the hotness of methods
 360     // remains unchanged. This behavior is desired, since we want to keep
 361     // the stable state, i.e., we do not want to evict methods from the
 362     // code cache if it is unnecessary.
 363     // We need a timed wait here, since compiler threads can exit if compilation
 364     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 365     // is not critical and we do not want idle compiler threads to wake up too often.
 366     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 367   }
 368 
 369   if (CompileBroker::is_compilation_disabled_forever()) {
 370     return NULL;
 371   }
 372 
 373   CompileTask* task;
 374   {
 375     No_Safepoint_Verifier nsv;
 376     task = CompilationPolicy::policy()-&gt;select_task(this);
 377   }
 378 
 379   // Save method pointers across unlock safepoint.  The task is removed from
 380   // the compilation queue, which is walked during RedefineClasses.
 381   save_method = methodHandle(task-&gt;method());
 382   save_hot_method = methodHandle(task-&gt;hot_method());
 383 
 384   remove(task);
 385   purge_stale_tasks(); // may temporarily release MCQ lock
 386   return task;
 387 }
 388 
 389 // Clean &amp; deallocate stale compile tasks.
 390 // Temporarily releases MethodCompileQueue lock.
 391 void CompileQueue::purge_stale_tasks() {
 392   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 393   if (_first_stale != NULL) {
 394     // Stale tasks are purged when MCQ lock is released,
 395     // but _first_stale updates are protected by MCQ lock.
 396     // Once task processing starts and MCQ lock is released,
 397     // other compiler threads can reuse _first_stale.
 398     CompileTask* head = _first_stale;
 399     _first_stale = NULL;
 400     {
 401       MutexUnlocker ul(MethodCompileQueue_lock);
 402       for (CompileTask* task = head; task != NULL; ) {
 403         CompileTask* next_task = task-&gt;next();
 404         CompileTaskWrapper ctw(task); // Frees the task
 405         task-&gt;set_failure_reason("stale task");
 406         task = next_task;
 407       }
 408     }
 409   }
 410 }
 411 
 412 void CompileQueue::remove(CompileTask* task) {
 413    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 414   if (task-&gt;prev() != NULL) {
 415     task-&gt;prev()-&gt;set_next(task-&gt;next());
 416   } else {
 417     // max is the first element
 418     assert(task == _first, "Sanity");
 419     _first = task-&gt;next();
 420   }
 421 
 422   if (task-&gt;next() != NULL) {
 423     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 424   } else {
 425     // max is the last element
 426     assert(task == _last, "Sanity");
 427     _last = task-&gt;prev();
 428   }
 429   --_size;
 430 }
 431 
 432 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 433   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 434   remove(task);
 435 
 436   // Enqueue the task for reclamation (should be done outside MCQ lock)
 437   task-&gt;set_next(_first_stale);
 438   task-&gt;set_prev(NULL);
 439   _first_stale = task;
 440 }
 441 
 442 // methods in the compile queue need to be marked as used on the stack
 443 // so that they don't get reclaimed by Redefine Classes
 444 void CompileQueue::mark_on_stack() {
 445   CompileTask* task = _first;
 446   while (task != NULL) {
 447     task-&gt;mark_on_stack();
 448     task = task-&gt;next();
 449   }
 450 }
 451 
 452 
 453 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 454   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 455   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 456   return NULL;
 457 }
 458 
 459 
 460 void CompileBroker::print_compile_queues(outputStream* st) {
 461   MutexLocker locker(MethodCompileQueue_lock);
 462   if (_c1_compile_queue != NULL) {
 463     _c1_compile_queue-&gt;print(st);
 464   }
 465   if (_c2_compile_queue != NULL) {
 466     _c2_compile_queue-&gt;print(st);
 467   }
 468 }
 469 
 470 void CompileQueue::print(outputStream* st) {
 471   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 472   st-&gt;print_cr("Contents of %s", name());
 473   st-&gt;print_cr("----------------------------");
 474   CompileTask* task = _first;
 475   if (task == NULL) {
 476     st-&gt;print_cr("Empty");
 477   } else {
 478     while (task != NULL) {
 479       task-&gt;print(st, NULL, true, true);
 480       task = task-&gt;next();
 481     }
 482   }
 483   st-&gt;print_cr("----------------------------");
 484 }
 485 
 486 void CompileQueue::print_tty() {
 487   ttyLocker ttyl;
 488   print(tty);
 489 }
 490 
 491 CompilerCounters::CompilerCounters() {
 492   _current_method[0] = '\0';
 493   _compile_type = CompileBroker::no_compile;
 494 }
 495 
 496 // ------------------------------------------------------------------
 497 // CompileBroker::compilation_init
 498 //
 499 // Initialize the Compilation object
 500 void CompileBroker::compilation_init() {
 501   _last_method_compiled[0] = '\0';
 502 
 503   // No need to initialize compilation system if we do not use it.
 504   if (!UseCompiler) {
 505     return;
 506   }
 507 #ifndef SHARK
 508   // Set the interface to the current compiler(s).
 509   int c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 510   int c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 511 
 512 #if INCLUDE_JVMCI
 513   if (EnableJVMCI) {
 514     // This is creating a JVMCICompiler singleton.
 515     JVMCICompiler* jvmci = new JVMCICompiler();
 516 
 517     if (UseJVMCICompiler) {
 518       _compilers[1] = jvmci;
 519       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 520         if (BootstrapJVMCI) {
 521           // JVMCI will bootstrap so give it more threads
 522           c2_count = MIN2(32, os::active_processor_count());
 523         }
 524       } else {
 525         c2_count = JVMCIThreads;
 526       }
 527       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 528       } else {
 529         c1_count = JVMCIHostThreads;
 530       }
 531     }
 532   }
 533 #endif // INCLUDE_JVMCI
 534 
 535 #ifdef COMPILER1
 536   if (c1_count &gt; 0) {
 537     _compilers[0] = new Compiler();
 538   }
 539 #endif // COMPILER1
 540 
 541 #ifdef COMPILER2
 542   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 543     if (c2_count &gt; 0) {
 544       _compilers[1] = new C2Compiler();
 545     }
 546   }
 547 #endif // COMPILER2
 548 
 549 #else // SHARK
 550   int c1_count = 0;
 551   int c2_count = 1;
 552 
 553   _compilers[1] = new SharkCompiler();
 554 #endif // SHARK
 555 
 556   // Start the compiler thread(s) and the sweeper thread
 557   init_compiler_sweeper_threads(c1_count, c2_count);
 558   // totalTime performance counter is always created as it is required
 559   // by the implementation of java.lang.management.CompilationMBean.
 560   {
 561     EXCEPTION_MARK;
 562     _perf_total_compilation =
 563                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 564                                                  PerfData::U_Ticks, CHECK);
 565   }
 566 
 567 
 568   if (UsePerfData) {
 569 
 570     EXCEPTION_MARK;
 571 
 572     // create the jvmstat performance counters
 573     _perf_osr_compilation =
 574                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 575                                                  PerfData::U_Ticks, CHECK);
 576 
 577     _perf_standard_compilation =
 578                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 579                                                  PerfData::U_Ticks, CHECK);
 580 
 581     _perf_total_bailout_count =
 582                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 583                                                  PerfData::U_Events, CHECK);
 584 
 585     _perf_total_invalidated_count =
 586                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 587                                                  PerfData::U_Events, CHECK);
 588 
 589     _perf_total_compile_count =
 590                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 591                                                  PerfData::U_Events, CHECK);
 592     _perf_total_osr_compile_count =
 593                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 594                                                  PerfData::U_Events, CHECK);
 595 
 596     _perf_total_standard_compile_count =
 597                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 598                                                  PerfData::U_Events, CHECK);
 599 
 600     _perf_sum_osr_bytes_compiled =
 601                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 602                                                  PerfData::U_Bytes, CHECK);
 603 
 604     _perf_sum_standard_bytes_compiled =
 605                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 606                                                  PerfData::U_Bytes, CHECK);
 607 
 608     _perf_sum_nmethod_size =
 609                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 610                                                  PerfData::U_Bytes, CHECK);
 611 
 612     _perf_sum_nmethod_code_size =
 613                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 614                                                  PerfData::U_Bytes, CHECK);
 615 
 616     _perf_last_method =
 617                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 618                                        CompilerCounters::cmname_buffer_length,
 619                                        "", CHECK);
 620 
 621     _perf_last_failed_method =
 622             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 623                                        CompilerCounters::cmname_buffer_length,
 624                                        "", CHECK);
 625 
 626     _perf_last_invalidated_method =
 627         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 628                                      CompilerCounters::cmname_buffer_length,
 629                                      "", CHECK);
 630 
 631     _perf_last_compile_type =
 632              PerfDataManager::create_variable(SUN_CI, "lastType",
 633                                               PerfData::U_None,
 634                                               (jlong)CompileBroker::no_compile,
 635                                               CHECK);
 636 
 637     _perf_last_compile_size =
 638              PerfDataManager::create_variable(SUN_CI, "lastSize",
 639                                               PerfData::U_Bytes,
 640                                               (jlong)CompileBroker::no_compile,
 641                                               CHECK);
 642 
 643 
 644     _perf_last_failed_type =
 645              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 646                                               PerfData::U_None,
 647                                               (jlong)CompileBroker::no_compile,
 648                                               CHECK);
 649 
 650     _perf_last_invalidated_type =
 651          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 652                                           PerfData::U_None,
 653                                           (jlong)CompileBroker::no_compile,
 654                                           CHECK);
 655   }
 656 
 657   _initialized = true;
 658 }
 659 
 660 
 661 JavaThread* CompileBroker::make_thread(const char* name, CompileQueue* queue, CompilerCounters* counters,
 662                                        AbstractCompiler* comp, bool compiler_thread, TRAPS) {
 663   JavaThread* thread = NULL;
 664   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_0);
 665   instanceKlassHandle klass (THREAD, k);
 666   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_0);
 667   Handle string = java_lang_String::create_from_str(name, CHECK_0);
 668 
 669   // Initialize thread_oop to put it into the system threadGroup
 670   Handle thread_group (THREAD,  Universe::system_thread_group());
 671   JavaValue result(T_VOID);
 672   JavaCalls::call_special(&amp;result, thread_oop,
 673                        klass,
 674                        vmSymbols::object_initializer_name(),
 675                        vmSymbols::threadgroup_string_void_signature(),
 676                        thread_group,
 677                        string,
 678                        CHECK_0);
 679 
 680   {
 681     MutexLocker mu(Threads_lock, THREAD);
 682     if (compiler_thread) {
 683       thread = new CompilerThread(queue, counters);
 684     } else {
 685       thread = new CodeCacheSweeperThread();
 686     }
 687     // At this point the new CompilerThread data-races with this startup
 688     // thread (which I believe is the primoridal thread and NOT the VM
 689     // thread).  This means Java bytecodes being executed at startup can
 690     // queue compile jobs which will run at whatever default priority the
 691     // newly created CompilerThread runs at.
 692 
 693 
 694     // At this point it may be possible that no osthread was created for the
 695     // JavaThread due to lack of memory. We would have to throw an exception
 696     // in that case. However, since this must work and we do not allow
 697     // exceptions anyway, check and abort if this fails.
 698 
 699     if (thread == NULL || thread-&gt;osthread() == NULL) {
 700       vm_exit_during_initialization("java.lang.OutOfMemoryError",
 701                                     os::native_thread_creation_failed_msg());
 702     }
 703 
 704     java_lang_Thread::set_thread(thread_oop(), thread);
 705 
 706     // Note that this only sets the JavaThread _priority field, which by
 707     // definition is limited to Java priorities and not OS priorities.
 708     // The os-priority is set in the CompilerThread startup code itself
 709 
 710     java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 711 
 712     // Note that we cannot call os::set_priority because it expects Java
 713     // priorities and we are *explicitly* using OS priorities so that it's
 714     // possible to set the compiler thread priority higher than any Java
 715     // thread.
 716 
 717     int native_prio = CompilerThreadPriority;
 718     if (native_prio == -1) {
 719       if (UseCriticalCompilerThreadPriority) {
 720         native_prio = os::java_to_os_priority[CriticalPriority];
 721       } else {
 722         native_prio = os::java_to_os_priority[NearMaxPriority];
 723       }
 724     }
 725     os::set_native_priority(thread, native_prio);
 726 
 727     java_lang_Thread::set_daemon(thread_oop());
 728 
 729     thread-&gt;set_threadObj(thread_oop());
 730     if (compiler_thread) {
 731       thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 732     }
 733     Threads::add(thread);
 734     Thread::start(thread);
 735   }
 736 
 737   // Let go of Threads_lock before yielding
 738   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 739 
 740   return thread;
 741 }
 742 
 743 
 744 void CompileBroker::init_compiler_sweeper_threads(int c1_compiler_count, int c2_compiler_count) {
 745   EXCEPTION_MARK;
 746 #if !defined(ZERO) &amp;&amp; !defined(SHARK)
 747   assert(c2_compiler_count &gt; 0 || c1_compiler_count &gt; 0, "No compilers?");
 748 #endif // !ZERO &amp;&amp; !SHARK
 749   // Initialize the compilation queue
 750   if (c2_compiler_count &gt; 0) {
 751     _c2_compile_queue  = new CompileQueue("C2 compile queue");
 752     _compilers[1]-&gt;set_num_compiler_threads(c2_compiler_count);
 753   }
 754   if (c1_compiler_count &gt; 0) {
 755     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 756     _compilers[0]-&gt;set_num_compiler_threads(c1_compiler_count);
 757   }
 758 
 759   int compiler_count = c1_compiler_count + c2_compiler_count;
 760 
 761   char name_buffer[256];
 762   const bool compiler_thread = true;
 763   for (int i = 0; i &lt; c2_compiler_count; i++) {
 764     // Create a name for our thread.
 765     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 766     CompilerCounters* counters = new CompilerCounters();
 767     // Shark and C2
 768     make_thread(name_buffer, _c2_compile_queue, counters, _compilers[1], compiler_thread, CHECK);
 769   }
 770 
 771   for (int i = c2_compiler_count; i &lt; compiler_count; i++) {
 772     // Create a name for our thread.
 773     sprintf(name_buffer, "C1 CompilerThread%d", i);
 774     CompilerCounters* counters = new CompilerCounters();
 775     // C1
 776     make_thread(name_buffer, _c1_compile_queue, counters, _compilers[0], compiler_thread, CHECK);
 777   }
 778 
 779   if (UsePerfData) {
 780     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, compiler_count, CHECK);
 781   }
 782 
 783   if (MethodFlushing) {
 784     // Initialize the sweeper thread
 785     make_thread("Sweeper thread", NULL, NULL, NULL, false, CHECK);
 786   }
 787 }
 788 
 789 
 790 /**
 791  * Set the methods on the stack as on_stack so that redefine classes doesn't
 792  * reclaim them. This method is executed at a safepoint.
 793  */
 794 void CompileBroker::mark_on_stack() {
 795   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 796   // Since we are at a safepoint, we do not need a lock to access
 797   // the compile queues.
 798   if (_c2_compile_queue != NULL) {
 799     _c2_compile_queue-&gt;mark_on_stack();
 800   }
 801   if (_c1_compile_queue != NULL) {
 802     _c1_compile_queue-&gt;mark_on_stack();
 803   }
 804 }
 805 
 806 // ------------------------------------------------------------------
 807 // CompileBroker::compile_method
 808 //
 809 // Request compilation of a method.
 810 void CompileBroker::compile_method_base(methodHandle method,
 811                                         int osr_bci,
 812                                         int comp_level,
 813                                         methodHandle hot_method,
 814                                         int hot_count,
 815                                         const char* comment,
 816                                         Thread* thread) {
 817   // do nothing if compiler thread(s) is not available
 818   if (!_initialized) {
 819     return;
 820   }
 821 
 822   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 823   assert(method-&gt;method_holder()-&gt;oop_is_instance(),
 824          "sanity check");
 825   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 826          "method holder must be initialized");
 827   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 828 
 829   if (CIPrintRequests) {
 830     tty-&gt;print("request: ");
 831     method-&gt;print_short_name(tty);
 832     if (osr_bci != InvocationEntryBci) {
 833       tty-&gt;print(" osr_bci: %d", osr_bci);
 834     }
 835     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, comment, hot_count);
 836     if (!hot_method.is_null()) {
 837       tty-&gt;print(" hot: ");
 838       if (hot_method() != method()) {
 839           hot_method-&gt;print_short_name(tty);
 840       } else {
 841         tty-&gt;print("yes");
 842       }
 843     }
 844     tty-&gt;cr();
 845   }
 846 
 847   // A request has been made for compilation.  Before we do any
 848   // real work, check to see if the method has been compiled
 849   // in the meantime with a definitive result.
 850   if (compilation_is_complete(method, osr_bci, comp_level)) {
 851     return;
 852   }
 853 
 854 #ifndef PRODUCT
 855   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
 856     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
 857       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
 858       return;
 859     }
 860   }
 861 #endif
 862 
 863   // If this method is already in the compile queue, then
 864   // we do not block the current thread.
 865   if (compilation_is_in_queue(method)) {
 866     // We may want to decay our counter a bit here to prevent
 867     // multiple denied requests for compilation.  This is an
 868     // open compilation policy issue. Note: The other possibility,
 869     // in the case that this is a blocking compile request, is to have
 870     // all subsequent blocking requesters wait for completion of
 871     // ongoing compiles. Note that in this case we'll need a protocol
 872     // for freeing the associated compile tasks. [Or we could have
 873     // a single static monitor on which all these waiters sleep.]
 874     return;
 875   }
 876 
 877   // If the requesting thread is holding the pending list lock
 878   // then we just return. We can't risk blocking while holding
 879   // the pending list lock or a 3-way deadlock may occur
 880   // between the reference handler thread, a GC (instigated
 881   // by a compiler thread), and compiled method registration.
 882   if (InstanceRefKlass::owns_pending_list_lock(JavaThread::current())) {
 883     return;
 884   }
 885 
 886   if (TieredCompilation) {
 887     // Tiered policy requires MethodCounters to exist before adding a method to
 888     // the queue. Create if we don't have them yet.
 889     method-&gt;get_method_counters(thread);
 890   }
 891 
 892   // Outputs from the following MutexLocker block:
 893   CompileTask* task     = NULL;
 894   bool         blocking = false;
 895   CompileQueue* queue  = compile_queue(comp_level);
 896 
 897   // Acquire our lock.
 898   {
 899     MutexLocker locker(MethodCompileQueue_lock, thread);
 900 
 901     // Make sure the method has not slipped into the queues since
 902     // last we checked; note that those checks were "fast bail-outs".
 903     // Here we need to be more careful, see 14012000 below.
 904     if (compilation_is_in_queue(method)) {
 905       return;
 906     }
 907 
 908     // We need to check again to see if the compilation has
 909     // completed.  A previous compilation may have registered
 910     // some result.
 911     if (compilation_is_complete(method, osr_bci, comp_level)) {
 912       return;
 913     }
 914 
 915     // We now know that this compilation is not pending, complete,
 916     // or prohibited.  Assign a compile_id to this compilation
 917     // and check to see if it is in our [Start..Stop) range.
 918     int compile_id = assign_compile_id(method, osr_bci);
 919     if (compile_id == 0) {
 920       // The compilation falls outside the allowed range.
 921       return;
 922     }
 923 
 924     // Should this thread wait for completion of the compile?
 925     blocking = is_compile_blocking();
 926 
 927 #if INCLUDE_JVMCI
 928     if (UseJVMCICompiler) {
 929       if (blocking) {
 930         // Don't allow blocking compiles for requests triggered by JVMCI.
 931         if (thread-&gt;is_Compiler_thread()) {
 932           blocking = false;
 933         }
 934 
 935         // Don't allow blocking compiles if inside a class initializer or while performing class loading
 936         vframeStream vfst((JavaThread*) thread);
 937         for (; !vfst.at_end(); vfst.next()) {
 938           if (vfst.method()-&gt;is_static_initializer() ||
 939               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
 940                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
 941             blocking = false;
 942             break;
 943           }
 944         }
 945 
 946         // Don't allow blocking compilation requests to JVMCI
 947         // if JVMCI itself is not yet initialized
 948         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
 949           blocking = false;
 950         }
 951 
 952         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
 953         // to avoid deadlock between compiler thread(s) and threads run at shutdown
 954         // such as the DestroyJavaVM thread.
 955         if (JVMCIRuntime::shutdown_called()) {
 956           blocking = false;
 957         }
 958       }
 959     }
 960 #endif // INCLUDE_JVMCI
 961 
 962     // We will enter the compilation in the queue.
 963     // 14012000: Note that this sets the queued_for_compile bits in
 964     // the target method. We can now reason that a method cannot be
 965     // queued for compilation more than once, as follows:
 966     // Before a thread queues a task for compilation, it first acquires
 967     // the compile queue lock, then checks if the method's queued bits
 968     // are set or it has already been compiled. Thus there can not be two
 969     // instances of a compilation task for the same method on the
 970     // compilation queue. Consider now the case where the compilation
 971     // thread has already removed a task for that method from the queue
 972     // and is in the midst of compiling it. In this case, the
 973     // queued_for_compile bits must be set in the method (and these
 974     // will be visible to the current thread, since the bits were set
 975     // under protection of the compile queue lock, which we hold now.
 976     // When the compilation completes, the compiler thread first sets
 977     // the compilation result and then clears the queued_for_compile
 978     // bits. Neither of these actions are protected by a barrier (or done
 979     // under the protection of a lock), so the only guarantee we have
 980     // (on machines with TSO (Total Store Order)) is that these values
 981     // will update in that order. As a result, the only combinations of
 982     // these bits that the current thread will see are, in temporal order:
 983     // &lt;RESULT, QUEUE&gt; :
 984     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
 985     //     &lt;1, 1&gt; : compiled but queue bit not cleared
 986     //     &lt;1, 0&gt; : compiled and queue bit cleared
 987     // Because we first check the queue bits then check the result bits,
 988     // we are assured that we cannot introduce a duplicate task.
 989     // Note that if we did the tests in the reverse order (i.e. check
 990     // result then check queued bit), we could get the result bit before
 991     // the compilation completed, and the queue bit after the compilation
 992     // completed, and end up introducing a "duplicate" (redundant) task.
 993     // In that case, the compiler thread should first check if a method
 994     // has already been compiled before trying to compile it.
 995     // NOTE: in the event that there are multiple compiler threads and
 996     // there is de-optimization/recompilation, things will get hairy,
 997     // and in that case it's best to protect both the testing (here) of
 998     // these bits, and their updating (here and elsewhere) under a
 999     // common lock.
1000     task = create_compile_task(queue,
1001                                compile_id, method,
1002                                osr_bci, comp_level,
1003                                hot_method, hot_count, comment,
1004                                blocking);
1005   }
1006 
1007   if (blocking) {
1008     wait_for_completion(task);
1009   }
1010 }
1011 
1012 
1013 nmethod* CompileBroker::compile_method(methodHandle method, int osr_bci,
1014                                        int comp_level,
1015                                        methodHandle hot_method, int hot_count,
1016                                        const char* comment, Thread* THREAD) {
1017   // make sure arguments make sense
1018   assert(method-&gt;method_holder()-&gt;oop_is_instance(), "not an instance method");
1019   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1020   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1021   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1022   // allow any levels for WhiteBox
1023   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1024   // return quickly if possible
1025 
1026   // lock, make sure that the compilation
1027   // isn't prohibited in a straightforward way.
1028   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1029   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1030       compilation_is_prohibited(method, osr_bci, comp_level)) {
1031     return NULL;
1032   }
1033 
1034   if (osr_bci == InvocationEntryBci) {
1035     // standard compilation
1036     nmethod* method_code = method-&gt;code();
1037     if (method_code != NULL) {
1038       if (compilation_is_complete(method, osr_bci, comp_level)) {
1039         return method_code;
1040       }
1041     }
1042     if (method-&gt;is_not_compilable(comp_level)) {
1043       return NULL;
1044     }
1045   } else {
1046     // osr compilation
1047 #ifndef TIERED
1048     // seems like an assert of dubious value
1049     assert(comp_level == CompLevel_highest_tier,
1050            "all OSR compiles are assumed to be at a single compilation level");
1051 #endif // TIERED
1052     // We accept a higher level osr method
1053     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1054     if (nm != NULL) return nm;
1055     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1056   }
1057 
1058   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1059   // some prerequisites that are compiler specific
1060   if (comp-&gt;is_c2() || comp-&gt;is_shark()) {
1061     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1062     // Resolve all classes seen in the signature of the method
1063     // we are compiling.
1064     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1065   }
1066 
1067   // If the method is native, do the lookup in the thread requesting
1068   // the compilation. Native lookups can load code, which is not
1069   // permitted during compilation.
1070   //
1071   // Note: A native method implies non-osr compilation which is
1072   //       checked with an assertion at the entry of this method.
1073   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1074     bool in_base_library;
1075     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1076     if (HAS_PENDING_EXCEPTION) {
1077       // In case of an exception looking up the method, we just forget
1078       // about it. The interpreter will kick-in and throw the exception.
1079       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1080       CLEAR_PENDING_EXCEPTION;
1081       return NULL;
1082     }
1083     assert(method-&gt;has_native_function(), "must have native code by now");
1084   }
1085 
1086   // RedefineClasses() has replaced this method; just return
1087   if (method-&gt;is_old()) {
1088     return NULL;
1089   }
1090 
1091   // JVMTI -- post_compile_event requires jmethod_id() that may require
1092   // a lock the compiling thread can not acquire. Prefetch it here.
1093   if (JvmtiExport::should_post_compiled_method_load()) {
1094     method-&gt;jmethod_id();
1095   }
1096 
1097   // do the compilation
1098   if (method-&gt;is_native()) {
1099     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1100       // The following native methods:
1101       //
1102       // java.lang.Float.intBitsToFloat
1103       // java.lang.Float.floatToRawIntBits
1104       // java.lang.Double.longBitsToDouble
1105       // java.lang.Double.doubleToRawLongBits
1106       //
1107       // are called through the interpreter even if interpreter native stubs
1108       // are not preferred (i.e., calling through adapter handlers is preferred).
1109       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1110       // if the version of the methods from the native libraries is called.
1111       // As the interpreter and the C2-intrinsified version of the methods preserves
1112       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1113       if ((UseSSE &gt;= 1 &amp;&amp;
1114           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1115            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1116           (UseSSE &gt;= 2 &amp;&amp;
1117            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1118             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1119         return NULL;
1120       }
1121 
1122       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1123       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1124       //
1125       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1126       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1127       AdapterHandlerLibrary::create_native_wrapper(method);
1128     } else {
1129       return NULL;
1130     }
1131   } else {
1132     // If the compiler is shut off due to code cache getting full
1133     // fail out now so blocking compiles dont hang the java thread
1134     if (!should_compile_new_jobs()) {
1135       CompilationPolicy::policy()-&gt;delay_compilation(method());
1136       return NULL;
1137     }
1138     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, comment, THREAD);
1139   }
1140 
1141   // return requested nmethod
1142   // We accept a higher level osr method
1143   if (osr_bci == InvocationEntryBci) {
1144     return method-&gt;code();
1145   }
1146   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1147 }
1148 
1149 
1150 // ------------------------------------------------------------------
1151 // CompileBroker::compilation_is_complete
1152 //
1153 // See if compilation of this method is already complete.
1154 bool CompileBroker::compilation_is_complete(methodHandle method,
1155                                             int          osr_bci,
1156                                             int          comp_level) {
1157   bool is_osr = (osr_bci != standard_entry_bci);
1158   if (is_osr) {
1159     if (method-&gt;is_not_osr_compilable(comp_level)) {
1160       return true;
1161     } else {
1162       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1163       return (result != NULL);
1164     }
1165   } else {
1166     if (method-&gt;is_not_compilable(comp_level)) {
1167       return true;
1168     } else {
1169       nmethod* result = method-&gt;code();
1170       if (result == NULL) return false;
1171       return comp_level == result-&gt;comp_level();
1172     }
1173   }
1174 }
1175 
1176 
1177 /**
1178  * See if this compilation is already requested.
1179  *
1180  * Implementation note: there is only a single "is in queue" bit
1181  * for each method.  This means that the check below is overly
1182  * conservative in the sense that an osr compilation in the queue
1183  * will block a normal compilation from entering the queue (and vice
1184  * versa).  This can be remedied by a full queue search to disambiguate
1185  * cases.  If it is deemed profitable, this may be done.
1186  */
1187 bool CompileBroker::compilation_is_in_queue(methodHandle method) {
1188   return method-&gt;queued_for_compilation();
1189 }
1190 
1191 // ------------------------------------------------------------------
1192 // CompileBroker::compilation_is_prohibited
1193 //
1194 // See if this compilation is not allowed.
1195 bool CompileBroker::compilation_is_prohibited(methodHandle method, int osr_bci, int comp_level) {
1196   bool is_native = method-&gt;is_native();
1197   // Some compilers may not support the compilation of natives.
1198   AbstractCompiler *comp = compiler(comp_level);
1199   if (is_native &amp;&amp;
1200       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1201     method-&gt;set_not_compilable_quietly(comp_level);
1202     return true;
1203   }
1204 
1205   bool is_osr = (osr_bci != standard_entry_bci);
1206   // Some compilers may not support on stack replacement.
1207   if (is_osr &amp;&amp;
1208       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1209     method-&gt;set_not_osr_compilable(comp_level);
1210     return true;
1211   }
1212 
1213   // Breaking the abstraction - directives are only used inside a compilation otherwise.
1214   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1215   bool excluded = directive-&gt;ExcludeOption;
1216   DirectivesStack::release(directive);
1217 
1218   // The method may be explicitly excluded by the user.
1219   double scale;
1220   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1221     bool quietly = CompilerOracle::should_exclude_quietly();
1222     if (PrintCompilation &amp;&amp; !quietly) {
1223       // This does not happen quietly...
1224       ResourceMark rm;
1225       tty-&gt;print("### Excluding %s:%s",
1226                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1227                  (method-&gt;is_static() ? " static" : ""));
1228       method-&gt;print_short_name(tty);
1229       tty-&gt;cr();
1230     }
1231     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1232   }
1233 
1234   return false;
1235 }
1236 
1237 /**
1238  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1239  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1240  * The function also allows to generate separate compilation IDs for OSR compilations.
1241  */
1242 int CompileBroker::assign_compile_id(methodHandle method, int osr_bci) {
1243 #ifdef ASSERT
1244   bool is_osr = (osr_bci != standard_entry_bci);
1245   int id;
1246   if (method-&gt;is_native()) {
1247     assert(!is_osr, "can't be osr");
1248     // Adapters, native wrappers and method handle intrinsics
1249     // should be generated always.
1250     return Atomic::add(1, &amp;_compilation_id);
1251   } else if (CICountOSR &amp;&amp; is_osr) {
1252     id = Atomic::add(1, &amp;_osr_compilation_id);
1253     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1254       return id;
1255     }
1256   } else {
1257     id = Atomic::add(1, &amp;_compilation_id);
1258     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1259       return id;
1260     }
1261   }
1262 
1263   // Method was not in the appropriate compilation range.
1264   method-&gt;set_not_compilable_quietly();
1265   return 0;
1266 #else
1267   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1268   // only _compilation_id is incremented.
1269   return Atomic::add(1, &amp;_compilation_id);
1270 #endif
1271 }
1272 
1273 // ------------------------------------------------------------------
1274 // CompileBroker::assign_compile_id_unlocked
1275 //
1276 // Public wrapper for assign_compile_id that acquires the needed locks
1277 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, methodHandle method, int osr_bci) {
1278   MutexLocker locker(MethodCompileQueue_lock, thread);
1279   return assign_compile_id(method, osr_bci);
1280 }
1281 
1282 /**
1283  * Should the current thread block until this compilation request
1284  * has been fulfilled?
1285  */
1286 bool CompileBroker::is_compile_blocking() {
1287   assert(!InstanceRefKlass::owns_pending_list_lock(JavaThread::current()), "possible deadlock");
1288   return !BackgroundCompilation;
1289 }
1290 
1291 
1292 // ------------------------------------------------------------------
1293 // CompileBroker::preload_classes
1294 void CompileBroker::preload_classes(methodHandle method, TRAPS) {
1295   // Move this code over from c1_Compiler.cpp
1296   ShouldNotReachHere();
1297 }
1298 
1299 
1300 // ------------------------------------------------------------------
1301 // CompileBroker::create_compile_task
1302 //
1303 // Create a CompileTask object representing the current request for
1304 // compilation.  Add this task to the queue.
1305 CompileTask* CompileBroker::create_compile_task(CompileQueue* queue,
1306                                               int           compile_id,
1307                                               methodHandle  method,
1308                                               int           osr_bci,
1309                                               int           comp_level,
1310                                               methodHandle  hot_method,
1311                                               int           hot_count,
1312                                               const char*   comment,
1313                                               bool          blocking) {
1314   CompileTask* new_task = CompileTask::allocate();
1315   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1316                        hot_method, hot_count, comment,
1317                        blocking);
1318   queue-&gt;add(new_task);
1319   return new_task;
1320 }
1321 
1322 // 1 second should be long enough to complete most JVMCI compilations
1323 // and not too long to stall a blocking JVMCI compilation that
1324 // is trying to acquire a lock held by the app thread that submitted the
1325 // compilation.
1326 static const long BLOCKING_JVMCI_COMPILATION_TIMEOUT = 1000;
1327 
1328 /**
1329  *  Wait for the compilation task to complete.
1330  */
1331 void CompileBroker::wait_for_completion(CompileTask* task) {
1332   if (CIPrintCompileQueue) {
1333     ttyLocker ttyl;
1334     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1335   }
1336 
1337   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1338 
1339   JavaThread* thread = JavaThread::current();
1340   thread-&gt;set_blocked_on_compilation(true);
1341 
1342   methodHandle method(thread, task-&gt;method());
1343   bool free_task;
1344 #if INCLUDE_JVMCI
1345   if (compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
1346     MutexLocker waiter(task-&gt;lock(), thread);
1347     // No need to check if compilation has completed - just
1348     // rely on the time out. The JVMCI compiler thread will
1349     // recycle the CompileTask.
1350     task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, BLOCKING_JVMCI_COMPILATION_TIMEOUT);
1351     // If the compilation completes while has_waiter is true then
1352     // this thread is responsible for freeing the task.  Otherwise
1353     // the compiler thread will free the task.
1354     task-&gt;clear_waiter();
1355     free_task = task-&gt;is_complete();
1356   } else
1357 #endif
1358   {
1359     MutexLocker waiter(task-&gt;lock(), thread);
1360     free_task = true;
1361     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1362       task-&gt;lock()-&gt;wait();
1363     }
1364   }
1365 
1366   thread-&gt;set_blocked_on_compilation(false);
1367   if (free_task) {
1368     if (is_compilation_disabled_forever()) {
1369       CompileTask::free(task);
1370       return;
1371     }
1372 
1373     // It is harmless to check this status without the lock, because
1374     // completion is a stable property (until the task object is recycled).
1375     assert(task-&gt;is_complete(), "Compilation should have completed");
1376     assert(task-&gt;code_handle() == NULL, "must be reset");
1377 
1378     // By convention, the waiter is responsible for recycling a
1379     // blocking CompileTask. Since there is only one waiter ever
1380     // waiting on a CompileTask, we know that no one else will
1381     // be using this CompileTask; we can free it.
1382     CompileTask::free(task);
1383   }
1384 }
1385 
1386 /**
1387  * Initialize compiler thread(s) + compiler object(s). The postcondition
1388  * of this function is that the compiler runtimes are initialized and that
1389  * compiler threads can start compiling.
1390  */
1391 bool CompileBroker::init_compiler_runtime() {
1392   CompilerThread* thread = CompilerThread::current();
1393   AbstractCompiler* comp = thread-&gt;compiler();
1394   // Final sanity check - the compiler object must exist
1395   guarantee(comp != NULL, "Compiler object must exist");
1396 
1397   int system_dictionary_modification_counter;
1398   {
1399     MutexLocker locker(Compile_lock, thread);
1400     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1401   }
1402 
1403   {
1404     // Must switch to native to allocate ci_env
1405     ThreadToNativeFromVM ttn(thread);
1406     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1407     // Cache Jvmti state
1408     ci_env.cache_jvmti_state();
1409     // Cache DTrace flags
1410     ci_env.cache_dtrace_flags();
1411 
1412     // Switch back to VM state to do compiler initialization
1413     ThreadInVMfromNative tv(thread);
1414     ResetNoHandleMark rnhm;
1415 
1416     if (!comp-&gt;is_shark()) {
1417       // Perform per-thread and global initializations
1418       comp-&gt;initialize();
1419     }
1420   }
1421 
1422   if (comp-&gt;is_failed()) {
1423     disable_compilation_forever();
1424     // If compiler initialization failed, no compiler thread that is specific to a
1425     // particular compiler runtime will ever start to compile methods.
1426     shutdown_compiler_runtime(comp, thread);
1427     return false;
1428   }
1429 
1430   // C1 specific check
1431   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1432     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1433     return false;
1434   }
1435 
1436   return true;
1437 }
1438 
1439 /**
1440  * If C1 and/or C2 initialization failed, we shut down all compilation.
1441  * We do this to keep things simple. This can be changed if it ever turns
1442  * out to be a problem.
1443  */
1444 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1445   // Free buffer blob, if allocated
1446   if (thread-&gt;get_buffer_blob() != NULL) {
1447     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1448     CodeCache::free(thread-&gt;get_buffer_blob());
1449   }
1450 
1451   if (comp-&gt;should_perform_shutdown()) {
1452     // There are two reasons for shutting down the compiler
1453     // 1) compiler runtime initialization failed
1454     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1455     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1456 
1457     // Only one thread per compiler runtime object enters here
1458     // Set state to shut down
1459     comp-&gt;set_shut_down();
1460 
1461     // Delete all queued compilation tasks to make compiler threads exit faster.
1462     if (_c1_compile_queue != NULL) {
1463       _c1_compile_queue-&gt;free_all();
1464     }
1465 
1466     if (_c2_compile_queue != NULL) {
1467       _c2_compile_queue-&gt;free_all();
1468     }
1469 
1470     // Set flags so that we continue execution with using interpreter only.
1471     UseCompiler    = false;
1472     UseInterpreter = true;
1473 
1474     // We could delete compiler runtimes also. However, there are references to
1475     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1476     // fail. This can be done later if necessary.
1477   }
1478 }
1479 
1480 // ------------------------------------------------------------------
1481 // CompileBroker::compiler_thread_loop
1482 //
1483 // The main loop run by a CompilerThread.
1484 void CompileBroker::compiler_thread_loop() {
1485   CompilerThread* thread = CompilerThread::current();
1486   CompileQueue* queue = thread-&gt;queue();
1487   // For the thread that initializes the ciObjectFactory
1488   // this resource mark holds all the shared objects
1489   ResourceMark rm;
1490 
1491   // First thread to get here will initialize the compiler interface
1492 
1493   if (!ciObjectFactory::is_initialized()) {
1494     ASSERT_IN_VM;
1495     MutexLocker only_one (CompileThread_lock, thread);
1496     if (!ciObjectFactory::is_initialized()) {
1497       ciObjectFactory::initialize();
1498     }
1499   }
1500 
1501   // Open a log.
1502   if (LogCompilation) {
1503     init_compiler_thread_log();
1504   }
1505   CompileLog* log = thread-&gt;log();
1506   if (log != NULL) {
1507     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1508                     thread-&gt;name(),
1509                     os::current_thread_id(),
1510                     os::current_process_id());
1511     log-&gt;stamp();
1512     log-&gt;end_elem();
1513   }
1514 
1515   // If compiler thread/runtime initialization fails, exit the compiler thread
1516   if (!init_compiler_runtime()) {
1517     return;
1518   }
1519 
1520   // Poll for new compilation tasks as long as the JVM runs. Compilation
1521   // should only be disabled if something went wrong while initializing the
1522   // compiler runtimes. This, in turn, should not happen. The only known case
1523   // when compiler runtime initialization fails is if there is not enough free
1524   // space in the code cache to generate the necessary stubs, etc.
1525   while (!is_compilation_disabled_forever()) {
1526     // We need this HandleMark to avoid leaking VM handles.
1527     HandleMark hm(thread);
1528 
1529     CompileTask* task = queue-&gt;get();
1530     if (task == NULL) {
1531       continue;
1532     }
1533 
1534     // Give compiler threads an extra quanta.  They tend to be bursty and
1535     // this helps the compiler to finish up the job.
1536     if (CompilerThreadHintNoPreempt) {
1537       os::hint_no_preempt();
1538     }
1539 
1540     // Assign the task to the current thread.  Mark this compilation
1541     // thread as active for the profiler.
1542     CompileTaskWrapper ctw(task);
1543     nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1544     task-&gt;set_code_handle(&amp;result_handle);
1545     methodHandle method(thread, task-&gt;method());
1546 
1547     // Never compile a method if breakpoints are present in it
1548     if (method()-&gt;number_of_breakpoints() == 0) {
1549       // Compile the method.
1550       if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1551         invoke_compiler_on_method(task);
1552       } else {
1553         // After compilation is disabled, remove remaining methods from queue
1554         method-&gt;clear_queued_for_compilation();
1555         task-&gt;set_failure_reason("compilation is disabled");
1556       }
1557     }
1558   }
1559 
1560   // Shut down compiler runtime
1561   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1562 }
1563 
1564 // ------------------------------------------------------------------
1565 // CompileBroker::init_compiler_thread_log
1566 //
1567 // Set up state required by +LogCompilation.
1568 void CompileBroker::init_compiler_thread_log() {
1569     CompilerThread* thread = CompilerThread::current();
1570     char  file_name[4*K];
1571     FILE* fp = NULL;
1572     intx thread_id = os::current_thread_id();
1573     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1574       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1575       if (dir == NULL) {
1576         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1577                      thread_id, os::current_process_id());
1578       } else {
1579         jio_snprintf(file_name, sizeof(file_name),
1580                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1581                      os::file_separator(), thread_id, os::current_process_id());
1582       }
1583 
1584       fp = fopen(file_name, "wt");
1585       if (fp != NULL) {
1586         if (LogCompilation &amp;&amp; Verbose) {
1587           tty-&gt;print_cr("Opening compilation log %s", file_name);
1588         }
1589         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1590         thread-&gt;init_log(log);
1591 
1592         if (xtty != NULL) {
1593           ttyLocker ttyl;
1594           // Record any per thread log files
1595           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1596         }
1597         return;
1598       }
1599     }
1600     warning("Cannot open log file: %s", file_name);
1601 }
1602 
1603 void CompileBroker::log_metaspace_failure() {
1604   const char* message = "some methods may not be compiled because metaspace "
1605                         "is out of memory";
1606   if (_compilation_log != NULL) {
1607     _compilation_log-&gt;log_metaspace_failure(message);
1608   }
1609   if (PrintCompilation) {
1610     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1611   }
1612 }
1613 
1614 
1615 // ------------------------------------------------------------------
1616 // CompileBroker::set_should_block
1617 //
1618 // Set _should_block.
1619 // Call this from the VM, with Threads_lock held and a safepoint requested.
1620 void CompileBroker::set_should_block() {
1621   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1622   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1623 #ifndef PRODUCT
1624   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1625     tty-&gt;print_cr("notifying compiler thread pool to block");
1626 #endif
1627   _should_block = true;
1628 }
1629 
1630 // ------------------------------------------------------------------
1631 // CompileBroker::maybe_block
1632 //
1633 // Call this from the compiler at convenient points, to poll for _should_block.
1634 void CompileBroker::maybe_block() {
1635   if (_should_block) {
1636 #ifndef PRODUCT
1637     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1638       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1639 #endif
1640     ThreadInVMfromNative tivfn(JavaThread::current());
1641   }
1642 }
1643 
1644 // wrapper for CodeCache::print_summary()
1645 static void codecache_print(bool detailed)
1646 {
1647   ResourceMark rm;
1648   stringStream s;
1649   // Dump code cache  into a buffer before locking the tty,
1650   {
1651     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1652     CodeCache::print_summary(&amp;s, detailed);
1653   }
1654   ttyLocker ttyl;
1655   tty-&gt;print("%s", s.as_string());
1656 }
1657 
1658 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, EventCompilation&amp; event, bool success, ciEnv* ci_env) {
1659 
1660   if (success) {
1661     task-&gt;mark_success();
1662     if (ci_env != NULL) {
1663       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1664     }
1665     if (_compilation_log != NULL) {
1666       nmethod* code = task-&gt;code();
1667       if (code != NULL) {
1668         _compilation_log-&gt;log_nmethod(thread, code);
1669       }
1670     }
1671   }
1672 
1673   // simulate crash during compilation
1674   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1675   if (event.should_commit()) {
1676     event.set_method(task-&gt;method());
1677     event.set_compileID(task-&gt;compile_id());
1678     event.set_compileLevel(task-&gt;comp_level());
1679     event.set_succeded(task-&gt;is_success());
1680     event.set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1681     event.set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1682     event.set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1683     event.commit();
1684   }
1685 }
1686 
1687 int DirectivesStack::_depth = 0;
1688 CompilerDirectives* DirectivesStack::_top = NULL;
1689 CompilerDirectives* DirectivesStack::_bottom = NULL;
1690 
1691 // ------------------------------------------------------------------
1692 // CompileBroker::invoke_compiler_on_method
1693 //
1694 // Compile a method.
1695 //
1696 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1697   if (PrintCompilation) {
1698     ResourceMark rm;
1699     task-&gt;print_tty();
1700   }
1701   elapsedTimer time;
1702 
1703   CompilerThread* thread = CompilerThread::current();
1704   ResourceMark rm(thread);
1705 
1706   if (LogEvents) {
1707     _compilation_log-&gt;log_compile(thread, task);
1708   }
1709 
1710   // Common flags.
1711   uint compile_id = task-&gt;compile_id();
1712   int osr_bci = task-&gt;osr_bci();
1713   bool is_osr = (osr_bci != standard_entry_bci);
1714   bool should_log = (thread-&gt;log() != NULL);
1715   bool should_break = false;
1716   int task_level = task-&gt;comp_level();
1717 
1718   // Look up matching directives
1719   DirectiveSet* directive = DirectivesStack::getMatchingDirective(task-&gt;method(), compiler(task_level));
1720 
1721   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
1722   if (should_log &amp;&amp; !directive-&gt;LogOption) {
1723     should_log = false;
1724   }
1725   {
1726     // create the handle inside it's own block so it can't
1727     // accidentally be referenced once the thread transitions to
1728     // native.  The NoHandleMark before the transition should catch
1729     // any cases where this occurs in the future.
1730     methodHandle method(thread, task-&gt;method());
1731     assert(!method-&gt;is_native(), "no longer compile natives");
1732 
1733     // Save information about this method in case of failure.
1734     set_last_compile(thread, method, is_osr, task_level);
1735 
1736     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
1737   }
1738 
1739   // Allocate a new set of JNI handles.
1740   push_jni_handle_block();
1741   Method* target_handle = task-&gt;method();
1742   int compilable = ciEnv::MethodCompilable;
1743   AbstractCompiler *comp = compiler(task_level);
1744 
1745   int system_dictionary_modification_counter;
1746   {
1747     MutexLocker locker(Compile_lock, thread);
1748     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1749   }
1750 #if INCLUDE_JVMCI
1751   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
1752     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
1753 
1754     TraceTime t1("compilation", &amp;time);
1755     EventCompilation event;
1756 
1757     JVMCIEnv env(task, system_dictionary_modification_counter);
1758     jvmci-&gt;compile_method(target_handle, osr_bci, &amp;env);
1759 
1760     post_compile(thread, task, event, task-&gt;code() != NULL, NULL);
1761   } else
1762 #endif // INCLUDE_JVMCI
1763   {
1764 
1765     NoHandleMark  nhm;
1766     ThreadToNativeFromVM ttn(thread);
1767 
1768     ciEnv ci_env(task, system_dictionary_modification_counter);
1769     if (should_break) {
1770       ci_env.set_break_at_compile(true);
1771     }
1772     if (should_log) {
1773       ci_env.set_log(thread-&gt;log());
1774     }
1775     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
1776     // The thread-env() field is cleared in ~CompileTaskWrapper.
1777 
1778     // Cache Jvmti state
1779     ci_env.cache_jvmti_state();
1780 
1781     // Cache DTrace flags
1782     ci_env.cache_dtrace_flags();
1783 
1784     ciMethod* target = ci_env.get_method_from_handle(target_handle);
1785 
1786     TraceTime t1("compilation", &amp;time);
1787     EventCompilation event;
1788 
1789     if (comp == NULL) {
1790       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
1791     } else {
1792       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
1793         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
1794         while (WhiteBox::compilation_locked) {
1795           locker.wait(Mutex::_no_safepoint_check_flag);
1796         }
1797       }
1798       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
1799     }
1800 
1801     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
1802       //assert(false, "compiler should always document failure");
1803       // The compiler elected, without comment, not to register a result.
1804       // Do not attempt further compilations of this method.
1805       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
1806     }
1807 
1808     // Copy this bit to the enclosing block:
1809     compilable = ci_env.compilable();
1810 
1811     if (ci_env.failing()) {
1812       task-&gt;set_failure_reason(ci_env.failure_reason());
1813       ci_env.report_failure(ci_env.failure_reason());
1814       const char* retry_message = ci_env.retry_message();
1815       if (_compilation_log != NULL) {
1816         _compilation_log-&gt;log_failure(thread, task, ci_env.failure_reason(), retry_message);
1817       }
1818       if (PrintCompilation) {
1819         FormatBufferResource msg = retry_message != NULL ?
1820             FormatBufferResource("COMPILE SKIPPED: %s (%s)", ci_env.failure_reason(), retry_message) :
1821             FormatBufferResource("COMPILE SKIPPED: %s",      ci_env.failure_reason());
1822         task-&gt;print(tty, msg);
1823       }
1824     }
1825 
1826     post_compile(thread, task, event, !ci_env.failing(), &amp;ci_env);
1827   }
1828   DirectivesStack::release(directive);
1829   pop_jni_handle_block();
1830 
1831   methodHandle method(thread, task-&gt;method());
1832 
1833   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
1834 
1835   collect_statistics(thread, time, task);
1836 
1837   if (PrintCompilation &amp;&amp; PrintCompilation2) {
1838     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
1839     tty-&gt;print("%4d ", compile_id);    // print compilation number
1840     tty-&gt;print("%s ", (is_osr ? "%" : " "));
1841     if (task-&gt;code() != NULL) {
1842       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
1843     }
1844     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
1845   }
1846 
1847   if (PrintCodeCacheOnCompilation)
1848     codecache_print(/* detailed= */ false);
1849 
1850   // Disable compilation, if required.
1851   switch (compilable) {
1852   case ciEnv::MethodCompilable_never:
1853     if (is_osr)
1854       method-&gt;set_not_osr_compilable_quietly();
1855     else
1856       method-&gt;set_not_compilable_quietly();
1857     break;
1858   case ciEnv::MethodCompilable_not_at_tier:
1859     if (is_osr)
1860       method-&gt;set_not_osr_compilable_quietly(task_level);
1861     else
1862       method-&gt;set_not_compilable_quietly(task_level);
1863     break;
1864   }
1865 
1866   // Note that the queued_for_compilation bits are cleared without
1867   // protection of a mutex. [They were set by the requester thread,
1868   // when adding the task to the compile queue -- at which time the
1869   // compile queue lock was held. Subsequently, we acquired the compile
1870   // queue lock to get this task off the compile queue; thus (to belabour
1871   // the point somewhat) our clearing of the bits must be occurring
1872   // only after the setting of the bits. See also 14012000 above.
1873   method-&gt;clear_queued_for_compilation();
1874 
1875 #ifdef ASSERT
1876   if (CollectedHeap::fired_fake_oom()) {
1877     // The current compile received a fake OOM during compilation so
1878     // go ahead and exit the VM since the test apparently succeeded
1879     tty-&gt;print_cr("*** Shutting down VM after successful fake OOM");
1880     vm_exit(0);
1881   }
1882 #endif
1883 }
1884 
1885 /**
1886  * The CodeCache is full. Print warning and disable compilation.
1887  * Schedule code cache cleaning so compilation can continue later.
1888  * This function needs to be called only from CodeCache::allocate(),
1889  * since we currently handle a full code cache uniformly.
1890  */
1891 void CompileBroker::handle_full_code_cache(int code_blob_type) {
1892   UseInterpreter = true;
1893   if (UseCompiler || AlwaysCompileLoopMethods ) {
1894     if (xtty != NULL) {
1895       ResourceMark rm;
1896       stringStream s;
1897       // Dump code cache state into a buffer before locking the tty,
1898       // because log_state() will use locks causing lock conflicts.
1899       CodeCache::log_state(&amp;s);
1900       // Lock to prevent tearing
1901       ttyLocker ttyl;
1902       xtty-&gt;begin_elem("code_cache_full");
1903       xtty-&gt;print("%s", s.as_string());
1904       xtty-&gt;stamp();
1905       xtty-&gt;end_elem();
1906     }
1907 
1908 #ifndef PRODUCT
1909     if (CompileTheWorld || ExitOnFullCodeCache) {
1910       codecache_print(/* detailed= */ true);
1911       before_exit(JavaThread::current());
1912       exit_globals(); // will delete tty
1913       vm_direct_exit(CompileTheWorld ? 0 : 1);
1914     }
1915 #endif
1916     if (UseCodeCacheFlushing) {
1917       // Since code cache is full, immediately stop new compiles
1918       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
1919         NMethodSweeper::log_sweep("disable_compiler");
1920       }
1921     } else {
1922       disable_compilation_forever();
1923     }
1924 
1925     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
1926   }
1927 }
1928 
1929 // ------------------------------------------------------------------
1930 // CompileBroker::set_last_compile
1931 //
1932 // Record this compilation for debugging purposes.
1933 void CompileBroker::set_last_compile(CompilerThread* thread, methodHandle method, bool is_osr, int comp_level) {
1934   ResourceMark rm;
1935   char* method_name = method-&gt;name()-&gt;as_C_string();
1936   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
1937   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
1938   char current_method[CompilerCounters::cmname_buffer_length];
1939   size_t maxLen = CompilerCounters::cmname_buffer_length;
1940 
1941   if (UsePerfData) {
1942     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
1943 
1944     size_t s1len = strlen(class_name);
1945     size_t s2len = strlen(method_name);
1946 
1947     // check if we need to truncate the string
1948     if (s1len + s2len + 2 &gt; maxLen) {
1949 
1950       // the strategy is to lop off the leading characters of the
1951       // class name and the trailing characters of the method name.
1952 
1953       if (s2len + 2 &gt; maxLen) {
1954         // lop of the entire class name string, let snprintf handle
1955         // truncation of the method name.
1956         class_name += s1len; // null string
1957       }
1958       else {
1959         // lop off the extra characters from the front of the class name
1960         class_name += ((s1len + s2len + 2) - maxLen);
1961       }
1962     }
1963 
1964     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
1965   }
1966 
1967   if (CICountOSR &amp;&amp; is_osr) {
1968     _last_compile_type = osr_compile;
1969   } else {
1970     _last_compile_type = normal_compile;
1971   }
1972   _last_compile_level = comp_level;
1973 
1974   if (UsePerfData) {
1975     CompilerCounters* counters = thread-&gt;counters();
1976     counters-&gt;set_current_method(current_method);
1977     counters-&gt;set_compile_type((jlong)_last_compile_type);
1978   }
1979 }
1980 
1981 
1982 // ------------------------------------------------------------------
1983 // CompileBroker::push_jni_handle_block
1984 //
1985 // Push on a new block of JNI handles.
1986 void CompileBroker::push_jni_handle_block() {
1987   JavaThread* thread = JavaThread::current();
1988 
1989   // Allocate a new block for JNI handles.
1990   // Inlined code from jni_PushLocalFrame()
1991   JNIHandleBlock* java_handles = thread-&gt;active_handles();
1992   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
1993   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
1994   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
1995   thread-&gt;set_active_handles(compile_handles);
1996 }
1997 
1998 
1999 // ------------------------------------------------------------------
2000 // CompileBroker::pop_jni_handle_block
2001 //
2002 // Pop off the current block of JNI handles.
2003 void CompileBroker::pop_jni_handle_block() {
2004   JavaThread* thread = JavaThread::current();
2005 
2006   // Release our JNI handle block
2007   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2008   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2009   thread-&gt;set_active_handles(java_handles);
2010   compile_handles-&gt;set_pop_frame_link(NULL);
2011   JNIHandleBlock::release_block(compile_handles, thread); // may block
2012 }
2013 
2014 // ------------------------------------------------------------------
2015 // CompileBroker::collect_statistics
2016 //
2017 // Collect statistics about the compilation.
2018 
2019 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2020   bool success = task-&gt;is_success();
2021   methodHandle method (thread, task-&gt;method());
2022   uint compile_id = task-&gt;compile_id();
2023   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2024   nmethod* code = task-&gt;code();
2025   CompilerCounters* counters = thread-&gt;counters();
2026 
2027   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2028   MutexLocker locker(CompileStatistics_lock);
2029 
2030   // _perf variables are production performance counters which are
2031   // updated regardless of the setting of the CITime and CITimeEach flags
2032   //
2033 
2034   // account all time, including bailouts and failures in this counter;
2035   // C1 and C2 counters are counting both successful and unsuccessful compiles
2036   _t_total_compilation.add(time);
2037 
2038   if (!success) {
2039     _total_bailout_count++;
2040     if (UsePerfData) {
2041       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2042       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2043       _perf_total_bailout_count-&gt;inc();
2044     }
2045     _t_bailedout_compilation.add(time);
2046   } else if (code == NULL) {
2047     if (UsePerfData) {
2048       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2049       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2050       _perf_total_invalidated_count-&gt;inc();
2051     }
2052     _total_invalidated_count++;
2053     _t_invalidated_compilation.add(time);
2054   } else {
2055     // Compilation succeeded
2056 
2057     // update compilation ticks - used by the implementation of
2058     // java.lang.management.CompilationMBean
2059     _perf_total_compilation-&gt;inc(time.ticks());
2060     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2061 
2062     if (CITime) {
2063       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2064       JVMCI_ONLY(CompilerStatistics* stats = compiler(task-&gt;comp_level())-&gt;stats();)
2065       if (is_osr) {
2066         _t_osr_compilation.add(time);
2067         _sum_osr_bytes_compiled += bytes_compiled;
2068         JVMCI_ONLY(stats-&gt;_osr.update(time, bytes_compiled);)
2069       } else {
2070         _t_standard_compilation.add(time);
2071         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2072         JVMCI_ONLY(stats-&gt;_standard.update(time, bytes_compiled);)
2073       }
2074       JVMCI_ONLY(stats-&gt;_nmethods_size += code-&gt;total_size();)
2075       JVMCI_ONLY(stats-&gt;_nmethods_code_size += code-&gt;insts_size();)
2076     }
2077 
2078     if (UsePerfData) {
2079       // save the name of the last method compiled
2080       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2081       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2082       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2083                                          task-&gt;num_inlined_bytecodes());
2084       if (is_osr) {
2085         _perf_osr_compilation-&gt;inc(time.ticks());
2086         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2087       } else {
2088         _perf_standard_compilation-&gt;inc(time.ticks());
2089         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2090       }
2091     }
2092 
2093     if (CITimeEach) {
2094       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2095       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2096                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2097     }
2098 
2099     // Collect counts of successful compilations
2100     _sum_nmethod_size      += code-&gt;total_size();
2101     _sum_nmethod_code_size += code-&gt;insts_size();
2102     _total_compile_count++;
2103 
2104     if (UsePerfData) {
2105       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2106       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2107       _perf_total_compile_count-&gt;inc();
2108     }
2109 
2110     if (is_osr) {
2111       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2112       _total_osr_compile_count++;
2113     } else {
2114       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2115       _total_standard_compile_count++;
2116     }
2117   }
2118   // set the current method for the thread to null
2119   if (UsePerfData) counters-&gt;set_current_method("");
2120 }
2121 
2122 const char* CompileBroker::compiler_name(int comp_level) {
2123   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2124   if (comp == NULL) {
2125     return "no compiler";
2126   } else {
2127     return (comp-&gt;name());
2128   }
2129 }
2130 
2131 #if INCLUDE_JVMCI
2132 void CompileBroker::print_times(AbstractCompiler* comp) {
2133   CompilerStatistics* stats = comp-&gt;stats();
2134   tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2135                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2136                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2137                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2138                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2139   comp-&gt;print_timers();
2140 }
2141 #endif // INCLUDE_JVMCI
2142 
2143 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2144 #if INCLUDE_JVMCI
2145   elapsedTimer standard_compilation;
2146   elapsedTimer total_compilation;
2147   elapsedTimer osr_compilation;
2148 
2149   int standard_bytes_compiled = 0;
2150   int osr_bytes_compiled = 0;
2151 
2152   int standard_compile_count = 0;
2153   int osr_compile_count = 0;
2154   int total_compile_count = 0;
2155 
2156   int nmethods_size = 0;
2157   int nmethods_code_size = 0;
2158   bool printedHeader = false;
2159 
2160   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2161     AbstractCompiler* comp = _compilers[i];
2162     if (comp != NULL) {
2163       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2164         printedHeader = true;
2165         tty-&gt;cr();
2166         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2167         tty-&gt;print_cr("------------------------------------------------");
2168         tty-&gt;cr();
2169       }
2170       CompilerStatistics* stats = comp-&gt;stats();
2171 
2172       standard_compilation.add(stats-&gt;_standard._time);
2173       osr_compilation.add(stats-&gt;_osr._time);
2174 
2175       standard_bytes_compiled += stats-&gt;_standard._bytes;
2176       osr_bytes_compiled += stats-&gt;_osr._bytes;
2177 
2178       standard_compile_count += stats-&gt;_standard._count;
2179       osr_compile_count += stats-&gt;_osr._count;
2180 
2181       nmethods_size += stats-&gt;_nmethods_size;
2182       nmethods_code_size += stats-&gt;_nmethods_code_size;
2183 
2184       if (per_compiler) {
2185         print_times(comp);
2186       }
2187     }
2188   }
2189   total_compile_count = osr_compile_count + standard_compile_count;
2190   total_compilation.add(osr_compilation);
2191   total_compilation.add(standard_compilation);
2192 
2193   // In hosted mode, print the JVMCI compiler specific counters manually.
2194   if (!UseJVMCICompiler) {
2195     JVMCICompiler::print_compilation_timers();
2196   }
2197 #else // INCLUDE_JVMCI
2198   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2199   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2200   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2201 
2202   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2203   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2204 
2205   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2206   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2207   int total_compile_count = CompileBroker::_total_compile_count;
2208 
2209   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2210   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2211 #endif // INCLUDE_JVMCI
2212 
2213   if (!aggregate) {
2214     return;
2215   }
2216   tty-&gt;cr();
2217   tty-&gt;print_cr("Accumulated compiler times");
2218   tty-&gt;print_cr("----------------------------------------------------------");
2219                //0000000000111111111122222222223333333333444444444455555555556666666666
2220                //0123456789012345678901234567890123456789012345678901234567890123456789
2221   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2222   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2223                 standard_compilation.seconds(),
2224                 standard_compilation.seconds() / standard_compile_count);
2225   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2226                 CompileBroker::_t_bailedout_compilation.seconds(),
2227                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2228   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2229                 osr_compilation.seconds(),
2230                 osr_compilation.seconds() / osr_compile_count);
2231   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2232                 CompileBroker::_t_invalidated_compilation.seconds(),
2233                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2234 
2235   AbstractCompiler *comp = compiler(CompLevel_simple);
2236   if (comp != NULL) {
2237     tty-&gt;cr();
2238     comp-&gt;print_timers();
2239   }
2240   comp = compiler(CompLevel_full_optimization);
2241   if (comp != NULL) {
2242     tty-&gt;cr();
2243     comp-&gt;print_timers();
2244   }
2245   tty-&gt;cr();
2246   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2247   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2248   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2249   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2250   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2251   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2252   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2253   double tcs = total_compilation.seconds();
2254   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2255   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2256   tty-&gt;cr();
2257   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2258   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2259 }
2260 
2261 // Debugging output for failure
2262 void CompileBroker::print_last_compile() {
2263   if ( _last_compile_level != CompLevel_none &amp;&amp;
2264        compiler(_last_compile_level) != NULL &amp;&amp;
2265        _last_method_compiled != NULL &amp;&amp;
2266        _last_compile_type != no_compile) {
2267     if (_last_compile_type == osr_compile) {
2268       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2269                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2270     } else {
2271       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2272                     _compilation_id, _last_compile_level, _last_method_compiled);
2273     }
2274   }
2275 }
2276 
2277 
2278 void CompileBroker::print_compiler_threads_on(outputStream* st) {
2279 #ifndef PRODUCT
2280   st-&gt;print_cr("Compiler thread printing unimplemented.");
2281   st-&gt;cr();
2282 #endif
2283 }
2284 
</pre></body></html>
