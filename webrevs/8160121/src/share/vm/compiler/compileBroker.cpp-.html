<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>Old src/share/vm/compiler/compileBroker.cpp</title>
<body id="SUNWwebrev">
<pre>
   1 /*
   2  * Copyright (c) 1999, 2016, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include "precompiled.hpp"
  26 #include "classfile/symbolTable.hpp"
  27 #include "classfile/systemDictionary.hpp"
  28 #include "classfile/vmSymbols.hpp"
  29 #include "code/codeCache.hpp"
  30 #include "code/dependencyContext.hpp"
  31 #include "compiler/compileBroker.hpp"
  32 #include "compiler/compileLog.hpp"
  33 #include "compiler/compilerOracle.hpp"
  34 #include "compiler/directivesParser.hpp"
  35 #include "gc/shared/referencePendingListLocker.hpp"
  36 #include "interpreter/linkResolver.hpp"
  37 #include "memory/allocation.inline.hpp"
  38 #include "memory/resourceArea.hpp"
  39 #include "oops/methodData.hpp"
  40 #include "oops/method.hpp"
  41 #include "oops/oop.inline.hpp"
  42 #include "prims/nativeLookup.hpp"
  43 #include "prims/whitebox.hpp"
  44 #include "runtime/arguments.hpp"
  45 #include "runtime/atomic.inline.hpp"
  46 #include "runtime/compilationPolicy.hpp"
  47 #include "runtime/init.hpp"
  48 #include "runtime/interfaceSupport.hpp"
  49 #include "runtime/javaCalls.hpp"
  50 #include "runtime/os.hpp"
  51 #include "runtime/sharedRuntime.hpp"
  52 #include "runtime/sweeper.hpp"
  53 #include "runtime/timerTrace.hpp"
  54 #include "trace/tracing.hpp"
  55 #include "utilities/dtrace.hpp"
  56 #include "utilities/events.hpp"
  57 #ifdef COMPILER1
  58 #include "c1/c1_Compiler.hpp"
  59 #endif
  60 #if INCLUDE_JVMCI
  61 #include "jvmci/jvmciCompiler.hpp"
  62 #include "jvmci/jvmciRuntime.hpp"
  63 #include "jvmci/jvmciJavaClasses.hpp"
  64 #include "runtime/vframe.hpp"
  65 #endif
  66 #ifdef COMPILER2
  67 #include "opto/c2compiler.hpp"
  68 #endif
  69 #ifdef SHARK
  70 #include "shark/sharkCompiler.hpp"
  71 #endif
  72 
  73 #ifdef DTRACE_ENABLED
  74 
  75 // Only bother with this argument setup if dtrace is available
  76 
  77 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  78   {                                                                      \
  79     Symbol* klass_name = (method)-&gt;klass_name();                         \
  80     Symbol* name = (method)-&gt;name();                                     \
  81     Symbol* signature = (method)-&gt;signature();                           \
  82     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  83       (char *) comp_name, strlen(comp_name),                             \
  84       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  85       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  86       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  87   }
  88 
  89 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  90   {                                                                      \
  91     Symbol* klass_name = (method)-&gt;klass_name();                         \
  92     Symbol* name = (method)-&gt;name();                                     \
  93     Symbol* signature = (method)-&gt;signature();                           \
  94     HOTSPOT_METHOD_COMPILE_END(                                          \
  95       (char *) comp_name, strlen(comp_name),                             \
  96       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  97       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  98       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
  99   }
 100 
 101 #else //  ndef DTRACE_ENABLED
 102 
 103 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 104 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 105 
 106 #endif // ndef DTRACE_ENABLED
 107 
 108 bool CompileBroker::_initialized = false;
 109 volatile bool CompileBroker::_should_block = false;
 110 volatile jint CompileBroker::_print_compilation_warning = 0;
 111 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 112 
 113 // The installed compiler(s)
 114 AbstractCompiler* CompileBroker::_compilers[2];
 115 
 116 // These counters are used to assign an unique ID to each compilation.
 117 volatile jint CompileBroker::_compilation_id     = 0;
 118 volatile jint CompileBroker::_osr_compilation_id = 0;
 119 
 120 // Debugging information
 121 int  CompileBroker::_last_compile_type     = no_compile;
 122 int  CompileBroker::_last_compile_level    = CompLevel_none;
 123 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];
 124 
 125 // Performance counters
 126 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 127 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 128 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 129 
 130 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 131 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 132 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 133 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 134 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 135 
 136 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 137 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 138 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 139 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 140 
 141 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 142 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 143 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 144 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 145 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 146 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 147 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 148 
 149 // Timers and counters for generating statistics
 150 elapsedTimer CompileBroker::_t_total_compilation;
 151 elapsedTimer CompileBroker::_t_osr_compilation;
 152 elapsedTimer CompileBroker::_t_standard_compilation;
 153 elapsedTimer CompileBroker::_t_invalidated_compilation;
 154 elapsedTimer CompileBroker::_t_bailedout_compilation;
 155 
 156 int CompileBroker::_total_bailout_count          = 0;
 157 int CompileBroker::_total_invalidated_count      = 0;
 158 int CompileBroker::_total_compile_count          = 0;
 159 int CompileBroker::_total_osr_compile_count      = 0;
 160 int CompileBroker::_total_standard_compile_count = 0;
 161 
 162 int CompileBroker::_sum_osr_bytes_compiled       = 0;
 163 int CompileBroker::_sum_standard_bytes_compiled  = 0;
 164 int CompileBroker::_sum_nmethod_size             = 0;
 165 int CompileBroker::_sum_nmethod_code_size        = 0;
 166 
 167 long CompileBroker::_peak_compilation_time       = 0;
 168 
 169 CompileQueue* CompileBroker::_c2_compile_queue   = NULL;
 170 CompileQueue* CompileBroker::_c1_compile_queue   = NULL;
 171 
 172 
 173 
 174 class CompilationLog : public StringEventLog {
 175  public:
 176   CompilationLog() : StringEventLog("Compilation events") {
 177   }
 178 
 179   void log_compile(JavaThread* thread, CompileTask* task) {
 180     StringLogMessage lm;
 181     stringStream sstr = lm.stream();
 182     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 183     task-&gt;print(&amp;sstr, NULL, true, false);
 184     log(thread, "%s", (const char*)lm);
 185   }
 186 
 187   void log_nmethod(JavaThread* thread, nmethod* nm) {
 188     log(thread, "nmethod %d%s " INTPTR_FORMAT " code [" INTPTR_FORMAT ", " INTPTR_FORMAT "]",
 189         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? "%" : "",
 190         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 191   }
 192 
 193   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 194     StringLogMessage lm;
 195     lm.print("%4d   COMPILE SKIPPED: %s", task-&gt;compile_id(), reason);
 196     if (retry_message != NULL) {
 197       lm.append(" (%s)", retry_message);
 198     }
 199     lm.print("\n");
 200     log(thread, "%s", (const char*)lm);
 201   }
 202 
 203   void log_metaspace_failure(const char* reason) {
 204     ResourceMark rm;
 205     StringLogMessage lm;
 206     lm.print("%4d   COMPILE PROFILING SKIPPED: %s", -1, reason);
 207     lm.print("\n");
 208     log(JavaThread::current(), "%s", (const char*)lm);
 209   }
 210 };
 211 
 212 static CompilationLog* _compilation_log = NULL;
 213 
 214 bool compileBroker_init() {
 215   if (LogEvents) {
 216     _compilation_log = new CompilationLog();
 217   }
 218 
 219   // init directives stack, adding default directive
 220   DirectivesStack::init();
 221 
 222   if (DirectivesParser::has_file()) {
 223     return DirectivesParser::parse_from_flag();
 224   } else if (CompilerDirectivesPrint) {
 225     // Print default directive even when no other was added
 226     DirectivesStack::print(tty);
 227   }
 228 
 229   return true;
 230 }
 231 
 232 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 233   CompilerThread* thread = CompilerThread::current();
 234   thread-&gt;set_task(task);
 235 #if INCLUDE_JVMCI
 236   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 237     task-&gt;set_jvmci_compiler_thread(thread);
 238   }
 239 #endif
 240   CompileLog*     log  = thread-&gt;log();
 241   if (log != NULL)  task-&gt;log_task_start(log);
 242 }
 243 
 244 CompileTaskWrapper::~CompileTaskWrapper() {
 245   CompilerThread* thread = CompilerThread::current();
 246   CompileTask* task = thread-&gt;task();
 247   CompileLog*  log  = thread-&gt;log();
 248   if (log != NULL)  task-&gt;log_task_done(log);
 249   thread-&gt;set_task(NULL);
 250   task-&gt;set_code_handle(NULL);
 251   thread-&gt;set_env(NULL);
 252   if (task-&gt;is_blocking()) {
 253     bool free_task = false;
 254     {
 255       MutexLocker notifier(task-&gt;lock(), thread);
 256       task-&gt;mark_complete();
 257 #if INCLUDE_JVMCI
 258       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 259         if (!task-&gt;has_waiter()) {
 260           // The waiting thread timed out and thus did not free the task.
 261           free_task = true;
 262         }
 263         task-&gt;set_jvmci_compiler_thread(NULL);
 264       }
 265 #endif
 266       if (!free_task) {
 267         // Notify the waiting thread that the compilation has completed
 268         // so that it can free the task.
 269         task-&gt;lock()-&gt;notify_all();
 270       }
 271     }
 272     if (free_task) {
 273       // The task can only be freed once the task lock is released.
 274       CompileTask::free(task);
 275     }
 276   } else {
 277     task-&gt;mark_complete();
 278 
 279     // By convention, the compiling thread is responsible for
 280     // recycling a non-blocking CompileTask.
 281     CompileTask::free(task);
 282   }
 283 }
 284 
 285 /**
 286  * Add a CompileTask to a CompileQueue.
 287  */
 288 void CompileQueue::add(CompileTask* task) {
 289   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 290 
 291   task-&gt;set_next(NULL);
 292   task-&gt;set_prev(NULL);
 293 
 294   if (_last == NULL) {
 295     // The compile queue is empty.
 296     assert(_first == NULL, "queue is empty");
 297     _first = task;
 298     _last = task;
 299   } else {
 300     // Append the task to the queue.
 301     assert(_last-&gt;next() == NULL, "not last");
 302     _last-&gt;set_next(task);
 303     task-&gt;set_prev(_last);
 304     _last = task;
 305   }
 306   ++_size;
 307 
 308   // Mark the method as being in the compile queue.
 309   task-&gt;method()-&gt;set_queued_for_compilation();
 310 
 311   if (CIPrintCompileQueue) {
 312     print_tty();
 313   }
 314 
 315   if (LogCompilation &amp;&amp; xtty != NULL) {
 316     task-&gt;log_task_queued();
 317   }
 318 
 319   // Notify CompilerThreads that a task is available.
 320   MethodCompileQueue_lock-&gt;notify_all();
 321 }
 322 
 323 /**
 324  * Empties compilation queue by putting all compilation tasks onto
 325  * a freelist. Furthermore, the method wakes up all threads that are
 326  * waiting on a compilation task to finish. This can happen if background
 327  * compilation is disabled.
 328  */
 329 void CompileQueue::free_all() {
 330   MutexLocker mu(MethodCompileQueue_lock);
 331   CompileTask* next = _first;
 332 
 333   // Iterate over all tasks in the compile queue
 334   while (next != NULL) {
 335     CompileTask* current = next;
 336     next = current-&gt;next();
 337     {
 338       // Wake up thread that blocks on the compile task.
 339       MutexLocker ct_lock(current-&gt;lock());
 340       current-&gt;lock()-&gt;notify();
 341     }
 342     // Put the task back on the freelist.
 343     CompileTask::free(current);
 344   }
 345   _first = NULL;
 346 
 347   // Wake up all threads that block on the queue.
 348   MethodCompileQueue_lock-&gt;notify_all();
 349 }
 350 
 351 /**
 352  * Get the next CompileTask from a CompileQueue
 353  */
 354 CompileTask* CompileQueue::get() {
 355   // save methods from RedefineClasses across safepoint
 356   // across MethodCompileQueue_lock below.
 357   methodHandle save_method;
 358   methodHandle save_hot_method;
 359 
 360   MutexLocker locker(MethodCompileQueue_lock);
 361   // If _first is NULL we have no more compile jobs. There are two reasons for
 362   // having no compile jobs: First, we compiled everything we wanted. Second,
 363   // we ran out of code cache so compilation has been disabled. In the latter
 364   // case we perform code cache sweeps to free memory such that we can re-enable
 365   // compilation.
 366   while (_first == NULL) {
 367     // Exit loop if compilation is disabled forever
 368     if (CompileBroker::is_compilation_disabled_forever()) {
 369       return NULL;
 370     }
 371 
 372     // If there are no compilation tasks and we can compile new jobs
 373     // (i.e., there is enough free space in the code cache) there is
 374     // no need to invoke the sweeper. As a result, the hotness of methods
 375     // remains unchanged. This behavior is desired, since we want to keep
 376     // the stable state, i.e., we do not want to evict methods from the
 377     // code cache if it is unnecessary.
 378     // We need a timed wait here, since compiler threads can exit if compilation
 379     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 380     // is not critical and we do not want idle compiler threads to wake up too often.
 381     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);
 382   }
 383 
 384   if (CompileBroker::is_compilation_disabled_forever()) {
 385     return NULL;
 386   }
 387 
 388   CompileTask* task;
 389   {
 390     NoSafepointVerifier nsv;
 391     task = CompilationPolicy::policy()-&gt;select_task(this);
 392   }
 393 
 394   if (task != NULL) {
 395     // Save method pointers across unlock safepoint.  The task is removed from
 396     // the compilation queue, which is walked during RedefineClasses.
 397     save_method = methodHandle(task-&gt;method());
 398     save_hot_method = methodHandle(task-&gt;hot_method());
 399 
 400     remove(task);
 401     purge_stale_tasks(); // may temporarily release MCQ lock
 402   }
 403 
 404   return task;
 405 }
 406 
 407 // Clean &amp; deallocate stale compile tasks.
 408 // Temporarily releases MethodCompileQueue lock.
 409 void CompileQueue::purge_stale_tasks() {
 410   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 411   if (_first_stale != NULL) {
 412     // Stale tasks are purged when MCQ lock is released,
 413     // but _first_stale updates are protected by MCQ lock.
 414     // Once task processing starts and MCQ lock is released,
 415     // other compiler threads can reuse _first_stale.
 416     CompileTask* head = _first_stale;
 417     _first_stale = NULL;
 418     {
 419       MutexUnlocker ul(MethodCompileQueue_lock);
 420       for (CompileTask* task = head; task != NULL; ) {
 421         CompileTask* next_task = task-&gt;next();
 422         CompileTaskWrapper ctw(task); // Frees the task
 423         task-&gt;set_failure_reason("stale task");
 424         task = next_task;
 425       }
 426     }
 427   }
 428 }
 429 
 430 void CompileQueue::remove(CompileTask* task) {
 431    assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 432   if (task-&gt;prev() != NULL) {
 433     task-&gt;prev()-&gt;set_next(task-&gt;next());
 434   } else {
 435     // max is the first element
 436     assert(task == _first, "Sanity");
 437     _first = task-&gt;next();
 438   }
 439 
 440   if (task-&gt;next() != NULL) {
 441     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 442   } else {
 443     // max is the last element
 444     assert(task == _last, "Sanity");
 445     _last = task-&gt;prev();
 446   }
 447   --_size;
 448 }
 449 
 450 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 451   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 452   remove(task);
 453 
 454   // Enqueue the task for reclamation (should be done outside MCQ lock)
 455   task-&gt;set_next(_first_stale);
 456   task-&gt;set_prev(NULL);
 457   _first_stale = task;
 458 }
 459 
 460 // methods in the compile queue need to be marked as used on the stack
 461 // so that they don't get reclaimed by Redefine Classes
 462 void CompileQueue::mark_on_stack() {
 463   CompileTask* task = _first;
 464   while (task != NULL) {
 465     task-&gt;mark_on_stack();
 466     task = task-&gt;next();
 467   }
 468 }
 469 
 470 
 471 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 472   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 473   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 474   return NULL;
 475 }
 476 
 477 void CompileBroker::print_compile_queues(outputStream* st) {
 478   st-&gt;print_cr("Current compiles: ");
 479   MutexLocker locker(MethodCompileQueue_lock);
 480 
 481   char buf[2000];
 482   int buflen = sizeof(buf);
 483   Threads::print_threads_compiling(st, buf, buflen);
 484 
 485   st-&gt;cr();
 486   if (_c1_compile_queue != NULL) {
 487     _c1_compile_queue-&gt;print(st);
 488   }
 489   if (_c2_compile_queue != NULL) {
 490     _c2_compile_queue-&gt;print(st);
 491   }
 492 }
 493 
 494 void CompileQueue::print(outputStream* st) {
 495   assert(MethodCompileQueue_lock-&gt;owned_by_self(), "must own lock");
 496   st-&gt;print_cr("%s:", name());
 497   CompileTask* task = _first;
 498   if (task == NULL) {
 499     st-&gt;print_cr("Empty");
 500   } else {
 501     while (task != NULL) {
 502       task-&gt;print(st, NULL, true, true);
 503       task = task-&gt;next();
 504     }
 505   }
 506   st-&gt;cr();
 507 }
 508 
 509 void CompileQueue::print_tty() {
 510   ttyLocker ttyl;
 511   print(tty);
 512 }
 513 
 514 CompilerCounters::CompilerCounters() {
 515   _current_method[0] = '\0';
 516   _compile_type = CompileBroker::no_compile;
 517 }
 518 
 519 // ------------------------------------------------------------------
 520 // CompileBroker::compilation_init
 521 //
 522 // Initialize the Compilation object
 523 void CompileBroker::compilation_init(TRAPS) {
 524   _last_method_compiled[0] = '\0';
 525 
 526   // No need to initialize compilation system if we do not use it.
 527   if (!UseCompiler) {
 528     return;
 529   }
 530 #ifndef SHARK
 531   // Set the interface to the current compiler(s).
 532   int c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 533   int c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 534 
 535 #if INCLUDE_JVMCI
 536   if (EnableJVMCI) {
 537     // This is creating a JVMCICompiler singleton.
 538     JVMCICompiler* jvmci = new JVMCICompiler();
 539 
 540     if (UseJVMCICompiler) {
 541       _compilers[1] = jvmci;
 542       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 543         if (BootstrapJVMCI) {
 544           // JVMCI will bootstrap so give it more threads
 545           c2_count = MIN2(32, os::active_processor_count());
 546         }
 547       } else {
 548         c2_count = JVMCIThreads;
 549       }
 550       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 551       } else {
 552         c1_count = JVMCIHostThreads;
 553       }
 554 
 555       if (!UseInterpreter || !BackgroundCompilation) {
 556         // Force initialization of JVMCI compiler otherwise JVMCI
 557         // compilations will not block until JVMCI is initialized
 558         ResourceMark rm;
 559         TempNewSymbol getCompiler = SymbolTable::new_symbol("getCompiler", CHECK);
 560         TempNewSymbol sig = SymbolTable::new_symbol("()Ljdk/vm/ci/runtime/JVMCICompiler;", CHECK);
 561         Handle jvmciRuntime = JVMCIRuntime::get_HotSpotJVMCIRuntime(CHECK);
 562         JavaValue result(T_OBJECT);
 563         JavaCalls::call_virtual(&amp;result, jvmciRuntime, HotSpotJVMCIRuntime::klass(), getCompiler, sig, CHECK);
 564       }
 565     }
 566   }
 567 #endif // INCLUDE_JVMCI
 568 
 569 #ifdef COMPILER1
 570   if (c1_count &gt; 0) {
 571     _compilers[0] = new Compiler();
 572   }
 573 #endif // COMPILER1
 574 
 575 #ifdef COMPILER2
 576   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 577     if (c2_count &gt; 0) {
 578       _compilers[1] = new C2Compiler();
 579     }
 580   }
 581 #endif // COMPILER2
 582 
 583 #else // SHARK
 584   int c1_count = 0;
 585   int c2_count = 1;
 586 
 587   _compilers[1] = new SharkCompiler();
 588 #endif // SHARK
 589 
 590   // Start the compiler thread(s) and the sweeper thread
 591   init_compiler_sweeper_threads(c1_count, c2_count);
 592   // totalTime performance counter is always created as it is required
 593   // by the implementation of java.lang.management.CompilationMBean.
 594   {
 595     EXCEPTION_MARK;
 596     _perf_total_compilation =
 597                  PerfDataManager::create_counter(JAVA_CI, "totalTime",
 598                                                  PerfData::U_Ticks, CHECK);
 599   }
 600 
 601   if (UsePerfData) {
 602 
 603     EXCEPTION_MARK;
 604 
 605     // create the jvmstat performance counters
 606     _perf_osr_compilation =
 607                  PerfDataManager::create_counter(SUN_CI, "osrTime",
 608                                                  PerfData::U_Ticks, CHECK);
 609 
 610     _perf_standard_compilation =
 611                  PerfDataManager::create_counter(SUN_CI, "standardTime",
 612                                                  PerfData::U_Ticks, CHECK);
 613 
 614     _perf_total_bailout_count =
 615                  PerfDataManager::create_counter(SUN_CI, "totalBailouts",
 616                                                  PerfData::U_Events, CHECK);
 617 
 618     _perf_total_invalidated_count =
 619                  PerfDataManager::create_counter(SUN_CI, "totalInvalidates",
 620                                                  PerfData::U_Events, CHECK);
 621 
 622     _perf_total_compile_count =
 623                  PerfDataManager::create_counter(SUN_CI, "totalCompiles",
 624                                                  PerfData::U_Events, CHECK);
 625     _perf_total_osr_compile_count =
 626                  PerfDataManager::create_counter(SUN_CI, "osrCompiles",
 627                                                  PerfData::U_Events, CHECK);
 628 
 629     _perf_total_standard_compile_count =
 630                  PerfDataManager::create_counter(SUN_CI, "standardCompiles",
 631                                                  PerfData::U_Events, CHECK);
 632 
 633     _perf_sum_osr_bytes_compiled =
 634                  PerfDataManager::create_counter(SUN_CI, "osrBytes",
 635                                                  PerfData::U_Bytes, CHECK);
 636 
 637     _perf_sum_standard_bytes_compiled =
 638                  PerfDataManager::create_counter(SUN_CI, "standardBytes",
 639                                                  PerfData::U_Bytes, CHECK);
 640 
 641     _perf_sum_nmethod_size =
 642                  PerfDataManager::create_counter(SUN_CI, "nmethodSize",
 643                                                  PerfData::U_Bytes, CHECK);
 644 
 645     _perf_sum_nmethod_code_size =
 646                  PerfDataManager::create_counter(SUN_CI, "nmethodCodeSize",
 647                                                  PerfData::U_Bytes, CHECK);
 648 
 649     _perf_last_method =
 650                  PerfDataManager::create_string_variable(SUN_CI, "lastMethod",
 651                                        CompilerCounters::cmname_buffer_length,
 652                                        "", CHECK);
 653 
 654     _perf_last_failed_method =
 655             PerfDataManager::create_string_variable(SUN_CI, "lastFailedMethod",
 656                                        CompilerCounters::cmname_buffer_length,
 657                                        "", CHECK);
 658 
 659     _perf_last_invalidated_method =
 660         PerfDataManager::create_string_variable(SUN_CI, "lastInvalidatedMethod",
 661                                      CompilerCounters::cmname_buffer_length,
 662                                      "", CHECK);
 663 
 664     _perf_last_compile_type =
 665              PerfDataManager::create_variable(SUN_CI, "lastType",
 666                                               PerfData::U_None,
 667                                               (jlong)CompileBroker::no_compile,
 668                                               CHECK);
 669 
 670     _perf_last_compile_size =
 671              PerfDataManager::create_variable(SUN_CI, "lastSize",
 672                                               PerfData::U_Bytes,
 673                                               (jlong)CompileBroker::no_compile,
 674                                               CHECK);
 675 
 676 
 677     _perf_last_failed_type =
 678              PerfDataManager::create_variable(SUN_CI, "lastFailedType",
 679                                               PerfData::U_None,
 680                                               (jlong)CompileBroker::no_compile,
 681                                               CHECK);
 682 
 683     _perf_last_invalidated_type =
 684          PerfDataManager::create_variable(SUN_CI, "lastInvalidatedType",
 685                                           PerfData::U_None,
 686                                           (jlong)CompileBroker::no_compile,
 687                                           CHECK);
 688   }
 689 
 690   _initialized = true;
 691 }
 692 
 693 
 694 JavaThread* CompileBroker::make_thread(const char* name, CompileQueue* queue, CompilerCounters* counters,
 695                                        AbstractCompiler* comp, bool compiler_thread, TRAPS) {
 696   JavaThread* thread = NULL;
 697   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), true, CHECK_0);
 698   instanceKlassHandle klass (THREAD, k);
 699   instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK_0);
 700   Handle string = java_lang_String::create_from_str(name, CHECK_0);
 701 
 702   // Initialize thread_oop to put it into the system threadGroup
 703   Handle thread_group (THREAD,  Universe::system_thread_group());
 704   JavaValue result(T_VOID);
 705   JavaCalls::call_special(&amp;result, thread_oop,
 706                        klass,
 707                        vmSymbols::object_initializer_name(),
 708                        vmSymbols::threadgroup_string_void_signature(),
 709                        thread_group,
 710                        string,
 711                        CHECK_0);
 712 
 713   {
 714     MutexLocker mu(Threads_lock, THREAD);
 715     if (compiler_thread) {
 716       thread = new CompilerThread(queue, counters);
 717     } else {
 718       thread = new CodeCacheSweeperThread();
 719     }
 720     // At this point the new CompilerThread data-races with this startup
 721     // thread (which I believe is the primoridal thread and NOT the VM
 722     // thread).  This means Java bytecodes being executed at startup can
 723     // queue compile jobs which will run at whatever default priority the
 724     // newly created CompilerThread runs at.
 725 
 726 
 727     // At this point it may be possible that no osthread was created for the
 728     // JavaThread due to lack of memory. We would have to throw an exception
 729     // in that case. However, since this must work and we do not allow
 730     // exceptions anyway, check and abort if this fails.
 731 
 732     if (thread == NULL || thread-&gt;osthread() == NULL) {
 733       vm_exit_during_initialization("java.lang.OutOfMemoryError",
 734                                     os::native_thread_creation_failed_msg());
 735     }
 736 
 737     java_lang_Thread::set_thread(thread_oop(), thread);
 738 
 739     // Note that this only sets the JavaThread _priority field, which by
 740     // definition is limited to Java priorities and not OS priorities.
 741     // The os-priority is set in the CompilerThread startup code itself
 742 
 743     java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 744 
 745     // Note that we cannot call os::set_priority because it expects Java
 746     // priorities and we are *explicitly* using OS priorities so that it's
 747     // possible to set the compiler thread priority higher than any Java
 748     // thread.
 749 
 750     int native_prio = CompilerThreadPriority;
 751     if (native_prio == -1) {
 752       if (UseCriticalCompilerThreadPriority) {
 753         native_prio = os::java_to_os_priority[CriticalPriority];
 754       } else {
 755         native_prio = os::java_to_os_priority[NearMaxPriority];
 756       }
 757     }
 758     os::set_native_priority(thread, native_prio);
 759 
 760     java_lang_Thread::set_daemon(thread_oop());
 761 
 762     thread-&gt;set_threadObj(thread_oop());
 763     if (compiler_thread) {
 764       thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 765     }
 766     Threads::add(thread);
 767     Thread::start(thread);
 768   }
 769 
 770   // Let go of Threads_lock before yielding
 771   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 772 
 773   return thread;
 774 }
 775 
 776 
 777 void CompileBroker::init_compiler_sweeper_threads(int c1_compiler_count, int c2_compiler_count) {
 778   EXCEPTION_MARK;
 779 #if !defined(ZERO) &amp;&amp; !defined(SHARK)
 780   assert(c2_compiler_count &gt; 0 || c1_compiler_count &gt; 0, "No compilers?");
 781 #endif // !ZERO &amp;&amp; !SHARK
 782   // Initialize the compilation queue
 783   if (c2_compiler_count &gt; 0) {
 784     const char* name = JVMCI_ONLY(UseJVMCICompiler ? "JVMCI compile queue" :) "C2 compile queue";
 785     _c2_compile_queue  = new CompileQueue(name);
 786     _compilers[1]-&gt;set_num_compiler_threads(c2_compiler_count);
 787   }
 788   if (c1_compiler_count &gt; 0) {
 789     _c1_compile_queue  = new CompileQueue("C1 compile queue");
 790     _compilers[0]-&gt;set_num_compiler_threads(c1_compiler_count);
 791   }
 792 
 793   int compiler_count = c1_compiler_count + c2_compiler_count;
 794 
 795   char name_buffer[256];
 796   const bool compiler_thread = true;
 797   for (int i = 0; i &lt; c2_compiler_count; i++) {
 798     // Create a name for our thread.
 799     sprintf(name_buffer, "%s CompilerThread%d", _compilers[1]-&gt;name(), i);
 800     CompilerCounters* counters = new CompilerCounters();
 801     // Shark and C2
 802     make_thread(name_buffer, _c2_compile_queue, counters, _compilers[1], compiler_thread, CHECK);
 803   }
 804 
 805   for (int i = c2_compiler_count; i &lt; compiler_count; i++) {
 806     // Create a name for our thread.
 807     sprintf(name_buffer, "C1 CompilerThread%d", i);
 808     CompilerCounters* counters = new CompilerCounters();
 809     // C1
 810     make_thread(name_buffer, _c1_compile_queue, counters, _compilers[0], compiler_thread, CHECK);
 811   }
 812 
 813   if (UsePerfData) {
 814     PerfDataManager::create_constant(SUN_CI, "threads", PerfData::U_Bytes, compiler_count, CHECK);
 815   }
 816 
 817   if (MethodFlushing) {
 818     // Initialize the sweeper thread
 819     make_thread("Sweeper thread", NULL, NULL, NULL, false, CHECK);
 820   }
 821 }
 822 
 823 
 824 /**
 825  * Set the methods on the stack as on_stack so that redefine classes doesn't
 826  * reclaim them. This method is executed at a safepoint.
 827  */
 828 void CompileBroker::mark_on_stack() {
 829   assert(SafepointSynchronize::is_at_safepoint(), "sanity check");
 830   // Since we are at a safepoint, we do not need a lock to access
 831   // the compile queues.
 832   if (_c2_compile_queue != NULL) {
 833     _c2_compile_queue-&gt;mark_on_stack();
 834   }
 835   if (_c1_compile_queue != NULL) {
 836     _c1_compile_queue-&gt;mark_on_stack();
 837   }
 838 }
 839 
 840 // ------------------------------------------------------------------
 841 // CompileBroker::compile_method
 842 //
 843 // Request compilation of a method.
 844 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 845                                         int osr_bci,
 846                                         int comp_level,
 847                                         const methodHandle&amp; hot_method,
 848                                         int hot_count,
 849                                         CompileTask::CompileReason compile_reason,
 850                                         bool blocking,
 851                                         Thread* thread) {
 852   guarantee(!method-&gt;is_abstract(), "cannot compile abstract methods");
 853   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 854          "sanity check");
 855   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 856          "method holder must be initialized");
 857   assert(!method-&gt;is_method_handle_intrinsic(), "do not enqueue these guys");
 858 
 859   if (CIPrintRequests) {
 860     tty-&gt;print("request: ");
 861     method-&gt;print_short_name(tty);
 862     if (osr_bci != InvocationEntryBci) {
 863       tty-&gt;print(" osr_bci: %d", osr_bci);
 864     }
 865     tty-&gt;print(" level: %d comment: %s count: %d", comp_level, CompileTask::reason_name(compile_reason), hot_count);
 866     if (!hot_method.is_null()) {
 867       tty-&gt;print(" hot: ");
 868       if (hot_method() != method()) {
 869           hot_method-&gt;print_short_name(tty);
 870       } else {
 871         tty-&gt;print("yes");
 872       }
 873     }
 874     tty-&gt;cr();
 875   }
 876 
 877   // A request has been made for compilation.  Before we do any
 878   // real work, check to see if the method has been compiled
 879   // in the meantime with a definitive result.
 880   if (compilation_is_complete(method, osr_bci, comp_level)) {
 881     return;
 882   }
 883 
 884 #ifndef PRODUCT
 885   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
 886     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
 887       // Positive OSROnlyBCI means only compile that bci.  Negative means don't compile that BCI.
 888       return;
 889     }
 890   }
 891 #endif
 892 
 893   // If this method is already in the compile queue, then
 894   // we do not block the current thread.
 895   if (compilation_is_in_queue(method)) {
 896     // We may want to decay our counter a bit here to prevent
 897     // multiple denied requests for compilation.  This is an
 898     // open compilation policy issue. Note: The other possibility,
 899     // in the case that this is a blocking compile request, is to have
 900     // all subsequent blocking requesters wait for completion of
 901     // ongoing compiles. Note that in this case we'll need a protocol
 902     // for freeing the associated compile tasks. [Or we could have
 903     // a single static monitor on which all these waiters sleep.]
 904     return;
 905   }
 906 
 907   // If the requesting thread is holding the pending list lock
 908   // then we just return. We can't risk blocking while holding
 909   // the pending list lock or a 3-way deadlock may occur
 910   // between the reference handler thread, a GC (instigated
 911   // by a compiler thread), and compiled method registration.
 912   if (ReferencePendingListLocker::is_locked_by_self()) {
 913     return;
 914   }
 915 
 916   if (TieredCompilation) {
 917     // Tiered policy requires MethodCounters to exist before adding a method to
 918     // the queue. Create if we don't have them yet.
 919     method-&gt;get_method_counters(thread);
 920   }
 921 
 922   // Outputs from the following MutexLocker block:
 923   CompileTask* task     = NULL;
 924   CompileQueue* queue  = compile_queue(comp_level);
 925 
 926   // Acquire our lock.
 927   {
 928     MutexLocker locker(MethodCompileQueue_lock, thread);
 929 
 930     // Make sure the method has not slipped into the queues since
 931     // last we checked; note that those checks were "fast bail-outs".
 932     // Here we need to be more careful, see 14012000 below.
 933     if (compilation_is_in_queue(method)) {
 934       return;
 935     }
 936 
 937     // We need to check again to see if the compilation has
 938     // completed.  A previous compilation may have registered
 939     // some result.
 940     if (compilation_is_complete(method, osr_bci, comp_level)) {
 941       return;
 942     }
 943 
 944     // We now know that this compilation is not pending, complete,
 945     // or prohibited.  Assign a compile_id to this compilation
 946     // and check to see if it is in our [Start..Stop) range.
 947     int compile_id = assign_compile_id(method, osr_bci);
 948     if (compile_id == 0) {
 949       // The compilation falls outside the allowed range.
 950       return;
 951     }
 952 
 953 #if INCLUDE_JVMCI
 954     if (UseJVMCICompiler) {
 955       if (blocking) {
 956         // Don't allow blocking compiles for requests triggered by JVMCI.
 957         if (thread-&gt;is_Compiler_thread()) {
 958           blocking = false;
 959         }
 960 
 961         // Don't allow blocking compiles if inside a class initializer or while performing class loading
 962         vframeStream vfst((JavaThread*) thread);
 963         for (; !vfst.at_end(); vfst.next()) {
 964           if (vfst.method()-&gt;is_static_initializer() ||
 965               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
 966                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
 967             blocking = false;
 968             break;
 969           }
 970         }
 971 
 972         // Don't allow blocking compilation requests to JVMCI
 973         // if JVMCI itself is not yet initialized
 974         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
 975           blocking = false;
 976         }
 977 
 978         // Don't allow blocking compilation requests if we are in JVMCIRuntime::shutdown
 979         // to avoid deadlock between compiler thread(s) and threads run at shutdown
 980         // such as the DestroyJavaVM thread.
 981         if (JVMCIRuntime::shutdown_called()) {
 982           blocking = false;
 983         }
 984       }
 985     }
 986 #endif // INCLUDE_JVMCI
 987 
 988     // We will enter the compilation in the queue.
 989     // 14012000: Note that this sets the queued_for_compile bits in
 990     // the target method. We can now reason that a method cannot be
 991     // queued for compilation more than once, as follows:
 992     // Before a thread queues a task for compilation, it first acquires
 993     // the compile queue lock, then checks if the method's queued bits
 994     // are set or it has already been compiled. Thus there can not be two
 995     // instances of a compilation task for the same method on the
 996     // compilation queue. Consider now the case where the compilation
 997     // thread has already removed a task for that method from the queue
 998     // and is in the midst of compiling it. In this case, the
 999     // queued_for_compile bits must be set in the method (and these
1000     // will be visible to the current thread, since the bits were set
1001     // under protection of the compile queue lock, which we hold now.
1002     // When the compilation completes, the compiler thread first sets
1003     // the compilation result and then clears the queued_for_compile
1004     // bits. Neither of these actions are protected by a barrier (or done
1005     // under the protection of a lock), so the only guarantee we have
1006     // (on machines with TSO (Total Store Order)) is that these values
1007     // will update in that order. As a result, the only combinations of
1008     // these bits that the current thread will see are, in temporal order:
1009     // &lt;RESULT, QUEUE&gt; :
1010     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1011     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1012     //     &lt;1, 0&gt; : compiled and queue bit cleared
1013     // Because we first check the queue bits then check the result bits,
1014     // we are assured that we cannot introduce a duplicate task.
1015     // Note that if we did the tests in the reverse order (i.e. check
1016     // result then check queued bit), we could get the result bit before
1017     // the compilation completed, and the queue bit after the compilation
1018     // completed, and end up introducing a "duplicate" (redundant) task.
1019     // In that case, the compiler thread should first check if a method
1020     // has already been compiled before trying to compile it.
1021     // NOTE: in the event that there are multiple compiler threads and
1022     // there is de-optimization/recompilation, things will get hairy,
1023     // and in that case it's best to protect both the testing (here) of
1024     // these bits, and their updating (here and elsewhere) under a
1025     // common lock.
1026     task = create_compile_task(queue,
1027                                compile_id, method,
1028                                osr_bci, comp_level,
1029                                hot_method, hot_count, compile_reason,
1030                                blocking);
1031   }
1032 
1033   if (blocking) {
1034     wait_for_completion(task);
1035   }
1036 }
1037 
1038 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1039                                        int comp_level,
1040                                        const methodHandle&amp; hot_method, int hot_count,
1041                                        CompileTask::CompileReason compile_reason,
1042                                        Thread* THREAD) {
1043   // Do nothing if compilebroker is not initalized or compiles are submitted on level none
1044   if (!_initialized || comp_level == CompLevel_none) {
1045     return NULL;
1046   }
1047 
1048   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1049   assert(comp != NULL, "Ensure we have a compiler");
1050 
1051   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1052   nmethod* nm = CompileBroker::compile_method(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, directive, THREAD);
1053   DirectivesStack::release(directive);
1054   return nm;
1055 }
1056 
1057 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1058                                          int comp_level,
1059                                          const methodHandle&amp; hot_method, int hot_count,
1060                                          CompileTask::CompileReason compile_reason,
1061                                          DirectiveSet* directive,
1062                                          Thread* THREAD) {
1063 
1064   // make sure arguments make sense
1065   assert(method-&gt;method_holder()-&gt;is_instance_klass(), "not an instance method");
1066   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), "bci out of range");
1067   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), "cannot compile abstract/native methods");
1068   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), "method holder must be initialized");
1069   assert(!TieredCompilation || comp_level &lt;= TieredStopAtLevel, "Invalid compilation level");
1070   // allow any levels for WhiteBox
1071   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, "only CompLevel_highest_tier must be used in non-tiered");
1072   // return quickly if possible
1073 
1074   // lock, make sure that the compilation
1075   // isn't prohibited in a straightforward way.
1076   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1077   if (!comp-&gt;can_compile_method(method) ||
1078       compilation_is_prohibited(method, osr_bci, comp_level, directive-&gt;ExcludeOption)) {
1079     return NULL;
1080   }
1081 
1082   if (osr_bci == InvocationEntryBci) {
1083     // standard compilation
1084     CompiledMethod* method_code = method-&gt;code();
1085     if (method_code != NULL &amp;&amp; method_code-&gt;is_nmethod()) {
1086       if (compilation_is_complete(method, osr_bci, comp_level)) {
1087         return (nmethod*) method_code;
1088       }
1089     }
1090     if (method-&gt;is_not_compilable(comp_level)) {
1091       return NULL;
1092     }
1093   } else {
1094     // osr compilation
1095 #ifndef TIERED
1096     // seems like an assert of dubious value
1097     assert(comp_level == CompLevel_highest_tier,
1098            "all OSR compiles are assumed to be at a single compilation level");
1099 #endif // TIERED
1100     // We accept a higher level osr method
1101     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1102     if (nm != NULL) return nm;
1103     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1104   }
1105 
1106   assert(!HAS_PENDING_EXCEPTION, "No exception should be present");
1107   // some prerequisites that are compiler specific
1108   if (comp-&gt;is_c2() || comp-&gt;is_shark()) {
1109     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1110     // Resolve all classes seen in the signature of the method
1111     // we are compiling.
1112     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1113   }
1114 
1115   // If the method is native, do the lookup in the thread requesting
1116   // the compilation. Native lookups can load code, which is not
1117   // permitted during compilation.
1118   //
1119   // Note: A native method implies non-osr compilation which is
1120   //       checked with an assertion at the entry of this method.
1121   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1122     bool in_base_library;
1123     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1124     if (HAS_PENDING_EXCEPTION) {
1125       // In case of an exception looking up the method, we just forget
1126       // about it. The interpreter will kick-in and throw the exception.
1127       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()
1128       CLEAR_PENDING_EXCEPTION;
1129       return NULL;
1130     }
1131     assert(method-&gt;has_native_function(), "must have native code by now");
1132   }
1133 
1134   // RedefineClasses() has replaced this method; just return
1135   if (method-&gt;is_old()) {
1136     return NULL;
1137   }
1138 
1139   // JVMTI -- post_compile_event requires jmethod_id() that may require
1140   // a lock the compiling thread can not acquire. Prefetch it here.
1141   if (JvmtiExport::should_post_compiled_method_load()) {
1142     method-&gt;jmethod_id();
1143   }
1144 
1145   // do the compilation
1146   if (method-&gt;is_native()) {
1147     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1148       // The following native methods:
1149       //
1150       // java.lang.Float.intBitsToFloat
1151       // java.lang.Float.floatToRawIntBits
1152       // java.lang.Double.longBitsToDouble
1153       // java.lang.Double.doubleToRawLongBits
1154       //
1155       // are called through the interpreter even if interpreter native stubs
1156       // are not preferred (i.e., calling through adapter handlers is preferred).
1157       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1158       // if the version of the methods from the native libraries is called.
1159       // As the interpreter and the C2-intrinsified version of the methods preserves
1160       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1161       if ((UseSSE &gt;= 1 &amp;&amp;
1162           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1163            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1164           (UseSSE &gt;= 2 &amp;&amp;
1165            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1166             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1167         return NULL;
1168       }
1169 
1170       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1171       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1172       //
1173       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1174       // in this case.  If we can't generate one and use it we can not execute the out-of-line method handle calls.
1175       AdapterHandlerLibrary::create_native_wrapper(method);
1176     } else {
1177       return NULL;
1178     }
1179   } else {
1180     // If the compiler is shut off due to code cache getting full
1181     // fail out now so blocking compiles dont hang the java thread
1182     if (!should_compile_new_jobs()) {
1183       CompilationPolicy::policy()-&gt;delay_compilation(method());
1184       return NULL;
1185     }
1186     bool is_blocking = !directive-&gt;BackgroundCompilationOption || CompileTheWorld || ReplayCompiles;
1187     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, is_blocking, THREAD);
1188   }
1189 
1190   // return requested nmethod
1191   // We accept a higher level osr method
1192   if (osr_bci == InvocationEntryBci) {
1193     CompiledMethod* code = method-&gt;code();
1194     if (code == NULL) {
1195       return (nmethod*) code;
1196     } else {
1197       return code-&gt;as_nmethod_or_null();
1198     }
1199   }
1200   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1201 }
1202 
1203 
1204 // ------------------------------------------------------------------
1205 // CompileBroker::compilation_is_complete
1206 //
1207 // See if compilation of this method is already complete.
1208 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1209                                             int                 osr_bci,
1210                                             int                 comp_level) {
1211   bool is_osr = (osr_bci != standard_entry_bci);
1212   if (is_osr) {
1213     if (method-&gt;is_not_osr_compilable(comp_level)) {
1214       return true;
1215     } else {
1216       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1217       return (result != NULL);
1218     }
1219   } else {
1220     if (method-&gt;is_not_compilable(comp_level)) {
1221       return true;
1222     } else {
1223       CompiledMethod* result = method-&gt;code();
1224       if (result == NULL) return false;
1225       return comp_level == result-&gt;comp_level();
1226     }
1227   }
1228 }
1229 
1230 
1231 /**
1232  * See if this compilation is already requested.
1233  *
1234  * Implementation note: there is only a single "is in queue" bit
1235  * for each method.  This means that the check below is overly
1236  * conservative in the sense that an osr compilation in the queue
1237  * will block a normal compilation from entering the queue (and vice
1238  * versa).  This can be remedied by a full queue search to disambiguate
1239  * cases.  If it is deemed profitable, this may be done.
1240  */
1241 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1242   return method-&gt;queued_for_compilation();
1243 }
1244 
1245 // ------------------------------------------------------------------
1246 // CompileBroker::compilation_is_prohibited
1247 //
1248 // See if this compilation is not allowed.
1249 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded) {
1250   bool is_native = method-&gt;is_native();
1251   // Some compilers may not support the compilation of natives.
1252   AbstractCompiler *comp = compiler(comp_level);
1253   if (is_native &amp;&amp;
1254       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1255     method-&gt;set_not_compilable_quietly(comp_level);
1256     return true;
1257   }
1258 
1259   bool is_osr = (osr_bci != standard_entry_bci);
1260   // Some compilers may not support on stack replacement.
1261   if (is_osr &amp;&amp;
1262       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1263     method-&gt;set_not_osr_compilable(comp_level);
1264     return true;
1265   }
1266 
1267   // The method may be explicitly excluded by the user.
1268   double scale;
1269   if (excluded || (CompilerOracle::has_option_value(method, "CompileThresholdScaling", scale) &amp;&amp; scale == 0)) {
1270     bool quietly = CompilerOracle::should_exclude_quietly();
1271     if (PrintCompilation &amp;&amp; !quietly) {
1272       // This does not happen quietly...
1273       ResourceMark rm;
1274       tty-&gt;print("### Excluding %s:%s",
1275                  method-&gt;is_native() ? "generation of native wrapper" : "compile",
1276                  (method-&gt;is_static() ? " static" : ""));
1277       method-&gt;print_short_name(tty);
1278       tty-&gt;cr();
1279     }
1280     method-&gt;set_not_compilable(comp_level, !quietly, "excluded by CompileCommand");
1281   }
1282 
1283   return false;
1284 }
1285 
1286 /**
1287  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1288  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1289  * The function also allows to generate separate compilation IDs for OSR compilations.
1290  */
1291 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1292 #ifdef ASSERT
1293   bool is_osr = (osr_bci != standard_entry_bci);
1294   int id;
1295   if (method-&gt;is_native()) {
1296     assert(!is_osr, "can't be osr");
1297     // Adapters, native wrappers and method handle intrinsics
1298     // should be generated always.
1299     return Atomic::add(1, &amp;_compilation_id);
1300   } else if (CICountOSR &amp;&amp; is_osr) {
1301     id = Atomic::add(1, &amp;_osr_compilation_id);
1302     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1303       return id;
1304     }
1305   } else {
1306     id = Atomic::add(1, &amp;_compilation_id);
1307     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1308       return id;
1309     }
1310   }
1311 
1312   // Method was not in the appropriate compilation range.
1313   method-&gt;set_not_compilable_quietly();
1314   return 0;
1315 #else
1316   // CICountOSR is a develop flag and set to 'false' by default. In a product built,
1317   // only _compilation_id is incremented.
1318   return Atomic::add(1, &amp;_compilation_id);
1319 #endif
1320 }
1321 
1322 // ------------------------------------------------------------------
1323 // CompileBroker::assign_compile_id_unlocked
1324 //
1325 // Public wrapper for assign_compile_id that acquires the needed locks
1326 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1327   MutexLocker locker(MethodCompileQueue_lock, thread);
1328   return assign_compile_id(method, osr_bci);
1329 }
1330 
1331 // ------------------------------------------------------------------
1332 // CompileBroker::preload_classes
1333 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {
1334   // Move this code over from c1_Compiler.cpp
1335   ShouldNotReachHere();
1336 }
1337 
1338 
1339 // ------------------------------------------------------------------
1340 // CompileBroker::create_compile_task
1341 //
1342 // Create a CompileTask object representing the current request for
1343 // compilation.  Add this task to the queue.
1344 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1345                                                 int                 compile_id,
1346                                                 const methodHandle&amp; method,
1347                                                 int                 osr_bci,
1348                                                 int                 comp_level,
1349                                                 const methodHandle&amp; hot_method,
1350                                                 int                 hot_count,
1351                                                 CompileTask::CompileReason compile_reason,
1352                                                 bool                blocking) {
1353   CompileTask* new_task = CompileTask::allocate();
1354   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1355                        hot_method, hot_count, compile_reason,
1356                        blocking);
1357   queue-&gt;add(new_task);
1358   return new_task;
1359 }
1360 
1361 #if INCLUDE_JVMCI
1362 // The number of milliseconds to wait before checking if
1363 // JVMCI compilation has made progress.
1364 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 500;
1365 
1366 // The number of JVMCI compilation progress checks that must fail
1367 // before unblocking a thread waiting for a blocking compilation.
1368 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 5;
1369 
1370 /**
1371  * Waits for a JVMCI compiler to complete a given task. This thread
1372  * waits until either the task completes or it sees no JVMCI compilation
1373  * progress for N consecutive milliseconds where N is
1374  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1375  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1376  *
1377  * @return true if this thread needs to free/recycle the task
1378  */
1379 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1380   MutexLocker waiter(task-&gt;lock(), thread);
1381   int progress_wait_attempts = 0;
1382   int methods_compiled = jvmci-&gt;methods_compiled();
1383   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1384          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1385     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1386 
1387     bool progress;
1388     if (jvmci_compiler_thread != NULL) {
1389       // If the JVMCI compiler thread is not blocked, we deem it to be making progress.
1390       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked;
1391     } else {
1392       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1393       // that all JVMCI compiler threads are blocked on. We use the counter for
1394       // successful JVMCI compilations to determine whether JVMCI compilation
1395       // is still making progress through the JVMCI compiler queue.
1396       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1397     }
1398 
1399     if (!progress) {
1400       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1401         if (PrintCompilation) {
1402           task-&gt;print(tty, "wait for blocking compilation timed out");
1403         }
1404         break;
1405       }
1406     } else {
1407       progress_wait_attempts = 0;
1408       if (jvmci_compiler_thread == NULL) {
1409         methods_compiled = jvmci-&gt;methods_compiled();
1410       }
1411     }
1412   }
1413   task-&gt;clear_waiter();
1414   return task-&gt;is_complete();
1415 }
1416 #endif
1417 
1418 /**
1419  *  Wait for the compilation task to complete.
1420  */
1421 void CompileBroker::wait_for_completion(CompileTask* task) {
1422   if (CIPrintCompileQueue) {
1423     ttyLocker ttyl;
1424     tty-&gt;print_cr("BLOCKING FOR COMPILE");
1425   }
1426 
1427   assert(task-&gt;is_blocking(), "can only wait on blocking task");
1428 
1429   JavaThread* thread = JavaThread::current();
1430   thread-&gt;set_blocked_on_compilation(true);
1431 
1432   methodHandle method(thread, task-&gt;method());
1433   bool free_task;
1434 #if INCLUDE_JVMCI
1435   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1436   if (comp-&gt;is_jvmci()) {
1437     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1438   } else
1439 #endif
1440   {
1441     MutexLocker waiter(task-&gt;lock(), thread);
1442     free_task = true;
1443     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1444       task-&gt;lock()-&gt;wait();
1445     }
1446   }
1447 
1448   thread-&gt;set_blocked_on_compilation(false);
1449   if (free_task) {
1450     if (is_compilation_disabled_forever()) {
1451       CompileTask::free(task);
1452       return;
1453     }
1454 
1455     // It is harmless to check this status without the lock, because
1456     // completion is a stable property (until the task object is recycled).
1457     assert(task-&gt;is_complete(), "Compilation should have completed");
1458     assert(task-&gt;code_handle() == NULL, "must be reset");
1459 
1460     // By convention, the waiter is responsible for recycling a
1461     // blocking CompileTask. Since there is only one waiter ever
1462     // waiting on a CompileTask, we know that no one else will
1463     // be using this CompileTask; we can free it.
1464     CompileTask::free(task);
1465   }
1466 }
1467 
1468 /**
1469  * Initialize compiler thread(s) + compiler object(s). The postcondition
1470  * of this function is that the compiler runtimes are initialized and that
1471  * compiler threads can start compiling.
1472  */
1473 bool CompileBroker::init_compiler_runtime() {
1474   CompilerThread* thread = CompilerThread::current();
1475   AbstractCompiler* comp = thread-&gt;compiler();
1476   // Final sanity check - the compiler object must exist
1477   guarantee(comp != NULL, "Compiler object must exist");
1478 
1479   int system_dictionary_modification_counter;
1480   {
1481     MutexLocker locker(Compile_lock, thread);
1482     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1483   }
1484 
1485   {
1486     // Must switch to native to allocate ci_env
1487     ThreadToNativeFromVM ttn(thread);
1488     ciEnv ci_env(NULL, system_dictionary_modification_counter);
1489     // Cache Jvmti state
1490     ci_env.cache_jvmti_state();
1491     // Cache DTrace flags
1492     ci_env.cache_dtrace_flags();
1493 
1494     // Switch back to VM state to do compiler initialization
1495     ThreadInVMfromNative tv(thread);
1496     ResetNoHandleMark rnhm;
1497 
1498     if (!comp-&gt;is_shark()) {
1499       // Perform per-thread and global initializations
1500       comp-&gt;initialize();
1501     }
1502   }
1503 
1504   if (comp-&gt;is_failed()) {
1505     disable_compilation_forever();
1506     // If compiler initialization failed, no compiler thread that is specific to a
1507     // particular compiler runtime will ever start to compile methods.
1508     shutdown_compiler_runtime(comp, thread);
1509     return false;
1510   }
1511 
1512   // C1 specific check
1513   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1514     warning("Initialization of %s thread failed (no space to run compilers)", thread-&gt;name());
1515     return false;
1516   }
1517 
1518   return true;
1519 }
1520 
1521 /**
1522  * If C1 and/or C2 initialization failed, we shut down all compilation.
1523  * We do this to keep things simple. This can be changed if it ever turns
1524  * out to be a problem.
1525  */
1526 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1527   // Free buffer blob, if allocated
1528   if (thread-&gt;get_buffer_blob() != NULL) {
1529     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1530     CodeCache::free(thread-&gt;get_buffer_blob());
1531   }
1532 
1533   if (comp-&gt;should_perform_shutdown()) {
1534     // There are two reasons for shutting down the compiler
1535     // 1) compiler runtime initialization failed
1536     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1537     warning("%s initialization failed. Shutting down all compilers", comp-&gt;name());
1538 
1539     // Only one thread per compiler runtime object enters here
1540     // Set state to shut down
1541     comp-&gt;set_shut_down();
1542 
1543     // Delete all queued compilation tasks to make compiler threads exit faster.
1544     if (_c1_compile_queue != NULL) {
1545       _c1_compile_queue-&gt;free_all();
1546     }
1547 
1548     if (_c2_compile_queue != NULL) {
1549       _c2_compile_queue-&gt;free_all();
1550     }
1551 
1552     // Set flags so that we continue execution with using interpreter only.
1553     UseCompiler    = false;
1554     UseInterpreter = true;
1555 
1556     // We could delete compiler runtimes also. However, there are references to
1557     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1558     // fail. This can be done later if necessary.
1559   }
1560 }
1561 
1562 // ------------------------------------------------------------------
1563 // CompileBroker::compiler_thread_loop
1564 //
1565 // The main loop run by a CompilerThread.
1566 void CompileBroker::compiler_thread_loop() {
1567   CompilerThread* thread = CompilerThread::current();
1568   CompileQueue* queue = thread-&gt;queue();
1569   // For the thread that initializes the ciObjectFactory
1570   // this resource mark holds all the shared objects
1571   ResourceMark rm;
1572 
1573   // First thread to get here will initialize the compiler interface
1574 
1575   if (!ciObjectFactory::is_initialized()) {
1576     ASSERT_IN_VM;
1577     MutexLocker only_one (CompileThread_lock, thread);
1578     if (!ciObjectFactory::is_initialized()) {
1579       ciObjectFactory::initialize();
1580     }
1581   }
1582 
1583   // Open a log.
1584   if (LogCompilation) {
1585     init_compiler_thread_log();
1586   }
1587   CompileLog* log = thread-&gt;log();
1588   if (log != NULL) {
1589     log-&gt;begin_elem("start_compile_thread name='%s' thread='" UINTX_FORMAT "' process='%d'",
1590                     thread-&gt;name(),
1591                     os::current_thread_id(),
1592                     os::current_process_id());
1593     log-&gt;stamp();
1594     log-&gt;end_elem();
1595   }
1596 
1597   // If compiler thread/runtime initialization fails, exit the compiler thread
1598   if (!init_compiler_runtime()) {
1599     return;
1600   }
1601 
1602   // Poll for new compilation tasks as long as the JVM runs. Compilation
1603   // should only be disabled if something went wrong while initializing the
1604   // compiler runtimes. This, in turn, should not happen. The only known case
1605   // when compiler runtime initialization fails is if there is not enough free
1606   // space in the code cache to generate the necessary stubs, etc.
1607   while (!is_compilation_disabled_forever()) {
1608     // We need this HandleMark to avoid leaking VM handles.
1609     HandleMark hm(thread);
1610 
1611     CompileTask* task = queue-&gt;get();
1612     if (task == NULL) {
1613       continue;
1614     }
1615 
1616     // Give compiler threads an extra quanta.  They tend to be bursty and
1617     // this helps the compiler to finish up the job.
1618     if (CompilerThreadHintNoPreempt) {
1619       os::hint_no_preempt();
1620     }
1621 
1622     // Assign the task to the current thread.  Mark this compilation
1623     // thread as active for the profiler.
1624     CompileTaskWrapper ctw(task);
1625     nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1626     task-&gt;set_code_handle(&amp;result_handle);
1627     methodHandle method(thread, task-&gt;method());
1628 
1629     // Never compile a method if breakpoints are present in it
1630     if (method()-&gt;number_of_breakpoints() == 0) {
1631       // Compile the method.
1632       if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1633         invoke_compiler_on_method(task);
1634       } else {
1635         // After compilation is disabled, remove remaining methods from queue
1636         method-&gt;clear_queued_for_compilation();
1637         task-&gt;set_failure_reason("compilation is disabled");
1638       }
1639     }
1640   }
1641 
1642   // Shut down compiler runtime
1643   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1644 }
1645 
1646 // ------------------------------------------------------------------
1647 // CompileBroker::init_compiler_thread_log
1648 //
1649 // Set up state required by +LogCompilation.
1650 void CompileBroker::init_compiler_thread_log() {
1651     CompilerThread* thread = CompilerThread::current();
1652     char  file_name[4*K];
1653     FILE* fp = NULL;
1654     intx thread_id = os::current_thread_id();
1655     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1656       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1657       if (dir == NULL) {
1658         jio_snprintf(file_name, sizeof(file_name), "hs_c" UINTX_FORMAT "_pid%u.log",
1659                      thread_id, os::current_process_id());
1660       } else {
1661         jio_snprintf(file_name, sizeof(file_name),
1662                      "%s%shs_c" UINTX_FORMAT "_pid%u.log", dir,
1663                      os::file_separator(), thread_id, os::current_process_id());
1664       }
1665 
1666       fp = fopen(file_name, "wt");
1667       if (fp != NULL) {
1668         if (LogCompilation &amp;&amp; Verbose) {
1669           tty-&gt;print_cr("Opening compilation log %s", file_name);
1670         }
1671         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1672         if (log == NULL) {
1673           fclose(fp);
1674           return;
1675         }
1676         thread-&gt;init_log(log);
1677 
1678         if (xtty != NULL) {
1679           ttyLocker ttyl;
1680           // Record any per thread log files
1681           xtty-&gt;elem("thread_logfile thread='" INTX_FORMAT "' filename='%s'", thread_id, file_name);
1682         }
1683         return;
1684       }
1685     }
1686     warning("Cannot open log file: %s", file_name);
1687 }
1688 
1689 void CompileBroker::log_metaspace_failure() {
1690   const char* message = "some methods may not be compiled because metaspace "
1691                         "is out of memory";
1692   if (_compilation_log != NULL) {
1693     _compilation_log-&gt;log_metaspace_failure(message);
1694   }
1695   if (PrintCompilation) {
1696     tty-&gt;print_cr("COMPILE PROFILING SKIPPED: %s", message);
1697   }
1698 }
1699 
1700 
1701 // ------------------------------------------------------------------
1702 // CompileBroker::set_should_block
1703 //
1704 // Set _should_block.
1705 // Call this from the VM, with Threads_lock held and a safepoint requested.
1706 void CompileBroker::set_should_block() {
1707   assert(Threads_lock-&gt;owner() == Thread::current(), "must have threads lock");
1708   assert(SafepointSynchronize::is_at_safepoint(), "must be at a safepoint already");
1709 #ifndef PRODUCT
1710   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1711     tty-&gt;print_cr("notifying compiler thread pool to block");
1712 #endif
1713   _should_block = true;
1714 }
1715 
1716 // ------------------------------------------------------------------
1717 // CompileBroker::maybe_block
1718 //
1719 // Call this from the compiler at convenient points, to poll for _should_block.
1720 void CompileBroker::maybe_block() {
1721   if (_should_block) {
1722 #ifndef PRODUCT
1723     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1724       tty-&gt;print_cr("compiler thread " INTPTR_FORMAT " poll detects block request", p2i(Thread::current()));
1725 #endif
1726     ThreadInVMfromNative tivfn(JavaThread::current());
1727   }
1728 }
1729 
1730 // wrapper for CodeCache::print_summary()
1731 static void codecache_print(bool detailed)
1732 {
1733   ResourceMark rm;
1734   stringStream s;
1735   // Dump code cache  into a buffer before locking the tty,
1736   {
1737     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1738     CodeCache::print_summary(&amp;s, detailed);
1739   }
1740   ttyLocker ttyl;
1741   tty-&gt;print("%s", s.as_string());
1742 }
1743 
1744 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, EventCompilation&amp; event, bool success, ciEnv* ci_env) {
1745 
1746   if (success) {
1747     task-&gt;mark_success();
1748     if (ci_env != NULL) {
1749       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1750     }
1751     if (_compilation_log != NULL) {
1752       nmethod* code = task-&gt;code();
1753       if (code != NULL) {
1754         _compilation_log-&gt;log_nmethod(thread, code);
1755       }
1756     }
1757   }
1758 
1759   // simulate crash during compilation
1760   assert(task-&gt;compile_id() != CICrashAt, "just as planned");
1761   if (event.should_commit()) {
1762     event.set_method(task-&gt;method());
1763     event.set_compileID(task-&gt;compile_id());
1764     event.set_compileLevel(task-&gt;comp_level());
1765     event.set_succeded(task-&gt;is_success());
1766     event.set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1767     event.set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1768     event.set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1769     event.commit();
1770   }
1771 }
1772 
1773 int DirectivesStack::_depth = 0;
1774 CompilerDirectives* DirectivesStack::_top = NULL;
1775 CompilerDirectives* DirectivesStack::_bottom = NULL;
1776 
1777 // ------------------------------------------------------------------
1778 // CompileBroker::invoke_compiler_on_method
1779 //
1780 // Compile a method.
1781 //
1782 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
1783   if (PrintCompilation) {
1784     ResourceMark rm;
1785     task-&gt;print_tty();
1786   }
1787   elapsedTimer time;
1788 
1789   CompilerThread* thread = CompilerThread::current();
1790   ResourceMark rm(thread);
1791 
1792   if (LogEvents) {
1793     _compilation_log-&gt;log_compile(thread, task);
1794   }
1795 
1796   // Common flags.
1797   uint compile_id = task-&gt;compile_id();
1798   int osr_bci = task-&gt;osr_bci();
1799   bool is_osr = (osr_bci != standard_entry_bci);
1800   bool should_log = (thread-&gt;log() != NULL);
1801   bool should_break = false;
1802   const int task_level = task-&gt;comp_level();
1803   AbstractCompiler* comp = task-&gt;compiler();
1804 
1805   DirectiveSet* directive;
1806   {
1807     // create the handle inside it's own block so it can't
1808     // accidentally be referenced once the thread transitions to
1809     // native.  The NoHandleMark before the transition should catch
1810     // any cases where this occurs in the future.
1811     methodHandle method(thread, task-&gt;method());
1812     assert(!method-&gt;is_native(), "no longer compile natives");
1813 
1814     // Look up matching directives
1815     directive = DirectivesStack::getMatchingDirective(method, comp);
1816 
1817     // Save information about this method in case of failure.
1818     set_last_compile(thread, method, is_osr, task_level);
1819 
1820     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
1821   }
1822 
1823   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
1824   if (should_log &amp;&amp; !directive-&gt;LogOption) {
1825     should_log = false;
1826   }
1827 
1828   // Allocate a new set of JNI handles.
1829   push_jni_handle_block();
1830   Method* target_handle = task-&gt;method();
1831   int compilable = ciEnv::MethodCompilable;
1832   const char* failure_reason = NULL;
1833   const char* retry_message = NULL;
1834 
1835   int system_dictionary_modification_counter;
1836   {
1837     MutexLocker locker(Compile_lock, thread);
1838     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();
1839   }
1840 
1841 #if INCLUDE_JVMCI
1842   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
1843     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
1844 
1845     TraceTime t1("compilation", &amp;time);
1846     EventCompilation event;
1847 
1848     JVMCIEnv env(task, system_dictionary_modification_counter);
1849     methodHandle method(thread, target_handle);
1850     jvmci-&gt;compile_method(method, osr_bci, &amp;env);
1851 
1852     post_compile(thread, task, event, task-&gt;code() != NULL, NULL);
1853 
1854     failure_reason = env.failure_reason();
1855     if (!env.retryable()) {
1856       retry_message = "not retryable";
1857       compilable = ciEnv::MethodCompilable_not_at_tier;
1858     }
1859 
1860   } else
1861 #endif // INCLUDE_JVMCI
1862   {
1863     NoHandleMark  nhm;
1864     ThreadToNativeFromVM ttn(thread);
1865 
1866     ciEnv ci_env(task, system_dictionary_modification_counter);
1867     if (should_break) {
1868       ci_env.set_break_at_compile(true);
1869     }
1870     if (should_log) {
1871       ci_env.set_log(thread-&gt;log());
1872     }
1873     assert(thread-&gt;env() == &amp;ci_env, "set by ci_env");
1874     // The thread-env() field is cleared in ~CompileTaskWrapper.
1875 
1876     // Cache Jvmti state
1877     ci_env.cache_jvmti_state();
1878 
1879     // Cache DTrace flags
1880     ci_env.cache_dtrace_flags();
1881 
1882     ciMethod* target = ci_env.get_method_from_handle(target_handle);
1883 
1884     TraceTime t1("compilation", &amp;time);
1885     EventCompilation event;
1886 
1887     if (comp == NULL) {
1888       ci_env.record_method_not_compilable("no compiler", !TieredCompilation);
1889     } else {
1890       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
1891         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
1892         while (WhiteBox::compilation_locked) {
1893           locker.wait(Mutex::_no_safepoint_check_flag);
1894         }
1895       }
1896       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
1897     }
1898 
1899     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
1900       //assert(false, "compiler should always document failure");
1901       // The compiler elected, without comment, not to register a result.
1902       // Do not attempt further compilations of this method.
1903       ci_env.record_method_not_compilable("compile failed", !TieredCompilation);
1904     }
1905 
1906     // Copy this bit to the enclosing block:
1907     compilable = ci_env.compilable();
1908 
1909     if (ci_env.failing()) {
1910       failure_reason = ci_env.failure_reason();
1911       retry_message = ci_env.retry_message();
1912       ci_env.report_failure(failure_reason);
1913     }
1914 
1915     post_compile(thread, task, event, !ci_env.failing(), &amp;ci_env);
1916   }
1917   // Remove the JNI handle block after the ciEnv destructor has run in
1918   // the previous block.
1919   pop_jni_handle_block();
1920 
1921   if (failure_reason != NULL) {
1922     task-&gt;set_failure_reason(failure_reason);
1923     if (_compilation_log != NULL) {
1924       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
1925     }
1926     if (PrintCompilation) {
1927       FormatBufferResource msg = retry_message != NULL ?
1928         FormatBufferResource("COMPILE SKIPPED: %s (%s)", failure_reason, retry_message) :
1929         FormatBufferResource("COMPILE SKIPPED: %s",      failure_reason);
1930       task-&gt;print(tty, msg);
1931     }
1932   }
1933 
1934   methodHandle method(thread, task-&gt;method());
1935 
1936   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
1937 
1938   collect_statistics(thread, time, task);
1939 
1940   nmethod* nm = task-&gt;code();
1941   if (nm != NULL) {
1942     nm-&gt;maybe_print_nmethod(directive);
1943   }
1944   DirectivesStack::release(directive);
1945 
1946   if (PrintCompilation &amp;&amp; PrintCompilation2) {
1947     tty-&gt;print("%7d ", (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
1948     tty-&gt;print("%4d ", compile_id);    // print compilation number
1949     tty-&gt;print("%s ", (is_osr ? "%" : " "));
1950     if (task-&gt;code() != NULL) {
1951       tty-&gt;print("size: %d(%d) ", task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
1952     }
1953     tty-&gt;print_cr("time: %d inlined: %d bytes", (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
1954   }
1955 
1956   if (PrintCodeCacheOnCompilation)
1957     codecache_print(/* detailed= */ false);
1958 
1959   // Disable compilation, if required.
1960   switch (compilable) {
1961   case ciEnv::MethodCompilable_never:
1962     if (is_osr)
1963       method-&gt;set_not_osr_compilable_quietly();
1964     else
1965       method-&gt;set_not_compilable_quietly();
1966     break;
1967   case ciEnv::MethodCompilable_not_at_tier:
1968     if (is_osr)
1969       method-&gt;set_not_osr_compilable_quietly(task_level);
1970     else
1971       method-&gt;set_not_compilable_quietly(task_level);
1972     break;
1973   }
1974 
1975   // Note that the queued_for_compilation bits are cleared without
1976   // protection of a mutex. [They were set by the requester thread,
1977   // when adding the task to the compile queue -- at which time the
1978   // compile queue lock was held. Subsequently, we acquired the compile
1979   // queue lock to get this task off the compile queue; thus (to belabour
1980   // the point somewhat) our clearing of the bits must be occurring
1981   // only after the setting of the bits. See also 14012000 above.
1982   method-&gt;clear_queued_for_compilation();
1983 
1984 #ifdef ASSERT
1985   if (CollectedHeap::fired_fake_oom()) {
1986     // The current compile received a fake OOM during compilation so
1987     // go ahead and exit the VM since the test apparently succeeded
1988     tty-&gt;print_cr("*** Shutting down VM after successful fake OOM");
1989     vm_exit(0);
1990   }
1991 #endif
1992 }
1993 
1994 /**
1995  * The CodeCache is full. Print warning and disable compilation.
1996  * Schedule code cache cleaning so compilation can continue later.
1997  * This function needs to be called only from CodeCache::allocate(),
1998  * since we currently handle a full code cache uniformly.
1999  */
2000 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2001   UseInterpreter = true;
2002   if (UseCompiler || AlwaysCompileLoopMethods ) {
2003     if (xtty != NULL) {
2004       ResourceMark rm;
2005       stringStream s;
2006       // Dump code cache state into a buffer before locking the tty,
2007       // because log_state() will use locks causing lock conflicts.
2008       CodeCache::log_state(&amp;s);
2009       // Lock to prevent tearing
2010       ttyLocker ttyl;
2011       xtty-&gt;begin_elem("code_cache_full");
2012       xtty-&gt;print("%s", s.as_string());
2013       xtty-&gt;stamp();
2014       xtty-&gt;end_elem();
2015     }
2016 
2017 #ifndef PRODUCT
2018     if (CompileTheWorld || ExitOnFullCodeCache) {
2019       codecache_print(/* detailed= */ true);
2020       before_exit(JavaThread::current());
2021       exit_globals(); // will delete tty
2022       vm_direct_exit(CompileTheWorld ? 0 : 1);
2023     }
2024 #endif
2025     if (UseCodeCacheFlushing) {
2026       // Since code cache is full, immediately stop new compiles
2027       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2028         NMethodSweeper::log_sweep("disable_compiler");
2029       }
2030     } else {
2031       disable_compilation_forever();
2032     }
2033 
2034     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2035   }
2036 }
2037 
2038 // ------------------------------------------------------------------
2039 // CompileBroker::set_last_compile
2040 //
2041 // Record this compilation for debugging purposes.
2042 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {
2043   ResourceMark rm;
2044   char* method_name = method-&gt;name()-&gt;as_C_string();
2045   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);
2046   _last_method_compiled[CompileBroker::name_buffer_length - 1] = '\0'; // ensure null terminated
2047   char current_method[CompilerCounters::cmname_buffer_length];
2048   size_t maxLen = CompilerCounters::cmname_buffer_length;
2049 
2050   if (UsePerfData) {
2051     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2052 
2053     size_t s1len = strlen(class_name);
2054     size_t s2len = strlen(method_name);
2055 
2056     // check if we need to truncate the string
2057     if (s1len + s2len + 2 &gt; maxLen) {
2058 
2059       // the strategy is to lop off the leading characters of the
2060       // class name and the trailing characters of the method name.
2061 
2062       if (s2len + 2 &gt; maxLen) {
2063         // lop of the entire class name string, let snprintf handle
2064         // truncation of the method name.
2065         class_name += s1len; // null string
2066       }
2067       else {
2068         // lop off the extra characters from the front of the class name
2069         class_name += ((s1len + s2len + 2) - maxLen);
2070       }
2071     }
2072 
2073     jio_snprintf(current_method, maxLen, "%s %s", class_name, method_name);
2074   }
2075 
2076   if (CICountOSR &amp;&amp; is_osr) {
2077     _last_compile_type = osr_compile;
2078   } else {
2079     _last_compile_type = normal_compile;
2080   }
2081   _last_compile_level = comp_level;
2082 
2083   if (UsePerfData) {
2084     CompilerCounters* counters = thread-&gt;counters();
2085     counters-&gt;set_current_method(current_method);
2086     counters-&gt;set_compile_type((jlong)_last_compile_type);
2087   }
2088 }
2089 
2090 
2091 // ------------------------------------------------------------------
2092 // CompileBroker::push_jni_handle_block
2093 //
2094 // Push on a new block of JNI handles.
2095 void CompileBroker::push_jni_handle_block() {
2096   JavaThread* thread = JavaThread::current();
2097 
2098   // Allocate a new block for JNI handles.
2099   // Inlined code from jni_PushLocalFrame()
2100   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2101   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2102   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, "should not be NULL");
2103   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc'd.
2104   thread-&gt;set_active_handles(compile_handles);
2105 }
2106 
2107 
2108 // ------------------------------------------------------------------
2109 // CompileBroker::pop_jni_handle_block
2110 //
2111 // Pop off the current block of JNI handles.
2112 void CompileBroker::pop_jni_handle_block() {
2113   JavaThread* thread = JavaThread::current();
2114 
2115   // Release our JNI handle block
2116   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2117   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2118   thread-&gt;set_active_handles(java_handles);
2119   compile_handles-&gt;set_pop_frame_link(NULL);
2120   JNIHandleBlock::release_block(compile_handles, thread); // may block
2121 }
2122 
2123 // ------------------------------------------------------------------
2124 // CompileBroker::collect_statistics
2125 //
2126 // Collect statistics about the compilation.
2127 
2128 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2129   bool success = task-&gt;is_success();
2130   methodHandle method (thread, task-&gt;method());
2131   uint compile_id = task-&gt;compile_id();
2132   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2133   nmethod* code = task-&gt;code();
2134   CompilerCounters* counters = thread-&gt;counters();
2135 
2136   assert(code == NULL || code-&gt;is_locked_by_vm(), "will survive the MutexLocker");
2137   MutexLocker locker(CompileStatistics_lock);
2138 
2139   // _perf variables are production performance counters which are
2140   // updated regardless of the setting of the CITime and CITimeEach flags
2141   //
2142 
2143   // account all time, including bailouts and failures in this counter;
2144   // C1 and C2 counters are counting both successful and unsuccessful compiles
2145   _t_total_compilation.add(time);
2146 
2147   if (!success) {
2148     _total_bailout_count++;
2149     if (UsePerfData) {
2150       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2151       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2152       _perf_total_bailout_count-&gt;inc();
2153     }
2154     _t_bailedout_compilation.add(time);
2155   } else if (code == NULL) {
2156     if (UsePerfData) {
2157       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2158       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2159       _perf_total_invalidated_count-&gt;inc();
2160     }
2161     _total_invalidated_count++;
2162     _t_invalidated_compilation.add(time);
2163   } else {
2164     // Compilation succeeded
2165 
2166     // update compilation ticks - used by the implementation of
2167     // java.lang.management.CompilationMBean
2168     _perf_total_compilation-&gt;inc(time.ticks());
2169     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2170 
2171     if (CITime) {
2172       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2173       if (is_osr) {
2174         _t_osr_compilation.add(time);
2175         _sum_osr_bytes_compiled += bytes_compiled;
2176       } else {
2177         _t_standard_compilation.add(time);
2178         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2179       }
2180 
2181 #if INCLUDE_JVMCI
2182       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2183       if (comp) {
2184         CompilerStatistics* stats = comp-&gt;stats();
2185         if (stats) {
2186           if (is_osr) {
2187             stats-&gt;_osr.update(time, bytes_compiled);
2188           } else {
2189             stats-&gt;_standard.update(time, bytes_compiled);
2190           }
2191           stats-&gt;_nmethods_size += code-&gt;total_size();
2192           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2193         } else { // if (!stats)
2194           assert(false, "Compiler statistics object must exist");
2195         }
2196       } else { // if (!comp)
2197         assert(false, "Compiler object must exist");
2198       }
2199 #endif // INCLUDE_JVMCI
2200     }
2201 
2202     if (UsePerfData) {
2203       // save the name of the last method compiled
2204       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2205       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2206       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2207                                          task-&gt;num_inlined_bytecodes());
2208       if (is_osr) {
2209         _perf_osr_compilation-&gt;inc(time.ticks());
2210         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2211       } else {
2212         _perf_standard_compilation-&gt;inc(time.ticks());
2213         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2214       }
2215     }
2216 
2217     if (CITimeEach) {
2218       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2219       tty-&gt;print_cr("%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)",
2220                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2221     }
2222 
2223     // Collect counts of successful compilations
2224     _sum_nmethod_size      += code-&gt;total_size();
2225     _sum_nmethod_code_size += code-&gt;insts_size();
2226     _total_compile_count++;
2227 
2228     if (UsePerfData) {
2229       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2230       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2231       _perf_total_compile_count-&gt;inc();
2232     }
2233 
2234     if (is_osr) {
2235       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2236       _total_osr_compile_count++;
2237     } else {
2238       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2239       _total_standard_compile_count++;
2240     }
2241   }
2242   // set the current method for the thread to null
2243   if (UsePerfData) counters-&gt;set_current_method("");
2244 }
2245 
2246 const char* CompileBroker::compiler_name(int comp_level) {
2247   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2248   if (comp == NULL) {
2249     return "no compiler";
2250   } else {
2251     return (comp-&gt;name());
2252   }
2253 }
2254 
2255 #if INCLUDE_JVMCI
2256 void CompileBroker::print_times(AbstractCompiler* comp) {
2257   CompilerStatistics* stats = comp-&gt;stats();
2258   if (stats) {
2259     tty-&gt;print_cr("  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}",
2260                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2261                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2262                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2263                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2264   } else { // if (!stats)
2265     assert(false, "Compiler statistics object must exist");
2266   }
2267   comp-&gt;print_timers();
2268 }
2269 #endif // INCLUDE_JVMCI
2270 
2271 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2272 #if INCLUDE_JVMCI
2273   elapsedTimer standard_compilation;
2274   elapsedTimer total_compilation;
2275   elapsedTimer osr_compilation;
2276 
2277   int standard_bytes_compiled = 0;
2278   int osr_bytes_compiled = 0;
2279 
2280   int standard_compile_count = 0;
2281   int osr_compile_count = 0;
2282   int total_compile_count = 0;
2283 
2284   int nmethods_size = 0;
2285   int nmethods_code_size = 0;
2286   bool printedHeader = false;
2287 
2288   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2289     AbstractCompiler* comp = _compilers[i];
2290     if (comp != NULL) {
2291       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2292         printedHeader = true;
2293         tty-&gt;cr();
2294         tty-&gt;print_cr("Individual compiler times (for compiled methods only)");
2295         tty-&gt;print_cr("------------------------------------------------");
2296         tty-&gt;cr();
2297       }
2298       CompilerStatistics* stats = comp-&gt;stats();
2299 
2300       if (stats) {
2301         standard_compilation.add(stats-&gt;_standard._time);
2302         osr_compilation.add(stats-&gt;_osr._time);
2303 
2304         standard_bytes_compiled += stats-&gt;_standard._bytes;
2305         osr_bytes_compiled += stats-&gt;_osr._bytes;
2306 
2307         standard_compile_count += stats-&gt;_standard._count;
2308         osr_compile_count += stats-&gt;_osr._count;
2309 
2310         nmethods_size += stats-&gt;_nmethods_size;
2311         nmethods_code_size += stats-&gt;_nmethods_code_size;
2312       } else { // if (!stats)
2313         assert(false, "Compiler statistics object must exist");
2314       }
2315 
2316       if (per_compiler) {
2317         print_times(comp);
2318       }
2319     }
2320   }
2321   total_compile_count = osr_compile_count + standard_compile_count;
2322   total_compilation.add(osr_compilation);
2323   total_compilation.add(standard_compilation);
2324 
2325   // In hosted mode, print the JVMCI compiler specific counters manually.
2326   if (!UseJVMCICompiler) {
2327     JVMCICompiler::print_compilation_timers();
2328   }
2329 #else // INCLUDE_JVMCI
2330   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2331   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2332   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2333 
2334   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2335   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2336 
2337   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2338   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2339   int total_compile_count = CompileBroker::_total_compile_count;
2340 
2341   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2342   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2343 #endif // INCLUDE_JVMCI
2344 
2345   if (!aggregate) {
2346     return;
2347   }
2348   tty-&gt;cr();
2349   tty-&gt;print_cr("Accumulated compiler times");
2350   tty-&gt;print_cr("----------------------------------------------------------");
2351                //0000000000111111111122222222223333333333444444444455555555556666666666
2352                //0123456789012345678901234567890123456789012345678901234567890123456789
2353   tty-&gt;print_cr("  Total compilation time   : %7.3f s", total_compilation.seconds());
2354   tty-&gt;print_cr("    Standard compilation   : %7.3f s, Average : %2.3f s",
2355                 standard_compilation.seconds(),
2356                 standard_compilation.seconds() / standard_compile_count);
2357   tty-&gt;print_cr("    Bailed out compilation : %7.3f s, Average : %2.3f s",
2358                 CompileBroker::_t_bailedout_compilation.seconds(),
2359                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2360   tty-&gt;print_cr("    On stack replacement   : %7.3f s, Average : %2.3f s",
2361                 osr_compilation.seconds(),
2362                 osr_compilation.seconds() / osr_compile_count);
2363   tty-&gt;print_cr("    Invalidated            : %7.3f s, Average : %2.3f s",
2364                 CompileBroker::_t_invalidated_compilation.seconds(),
2365                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2366 
2367   AbstractCompiler *comp = compiler(CompLevel_simple);
2368   if (comp != NULL) {
2369     tty-&gt;cr();
2370     comp-&gt;print_timers();
2371   }
2372   comp = compiler(CompLevel_full_optimization);
2373   if (comp != NULL) {
2374     tty-&gt;cr();
2375     comp-&gt;print_timers();
2376   }
2377   tty-&gt;cr();
2378   tty-&gt;print_cr("  Total compiled methods    : %8d methods", total_compile_count);
2379   tty-&gt;print_cr("    Standard compilation    : %8d methods", standard_compile_count);
2380   tty-&gt;print_cr("    On stack replacement    : %8d methods", osr_compile_count);
2381   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2382   tty-&gt;print_cr("  Total compiled bytecodes  : %8d bytes", tcb);
2383   tty-&gt;print_cr("    Standard compilation    : %8d bytes", standard_bytes_compiled);
2384   tty-&gt;print_cr("    On stack replacement    : %8d bytes", osr_bytes_compiled);
2385   double tcs = total_compilation.seconds();
2386   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2387   tty-&gt;print_cr("  Average compilation speed : %8d bytes/s", bps);
2388   tty-&gt;cr();
2389   tty-&gt;print_cr("  nmethod code size         : %8d bytes", nmethods_code_size);
2390   tty-&gt;print_cr("  nmethod total size        : %8d bytes", nmethods_size);
2391 }
2392 
2393 // Debugging output for failure
2394 void CompileBroker::print_last_compile() {
2395   if (_last_compile_level != CompLevel_none &amp;&amp;
2396       compiler(_last_compile_level) != NULL &amp;&amp;
2397       _last_compile_type != no_compile) {
2398     if (_last_compile_type == osr_compile) {
2399       tty-&gt;print_cr("Last parse:  [osr]%d+++(%d) %s",
2400                     _osr_compilation_id, _last_compile_level, _last_method_compiled);
2401     } else {
2402       tty-&gt;print_cr("Last parse:  %d+++(%d) %s",
2403                     _compilation_id, _last_compile_level, _last_method_compiled);
2404     }
2405   }
2406 }
2407 
</pre></body></html>
